<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Testbench - Follow-up Context Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #333; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .test-area { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #007bff; }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .version { float: right; color: #ccc; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
        th { background: #f0f0f0; position: sticky; top: 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Local Testbench - Follow-up Context Test</h1>
            <div class="version">Version 1.0 - Local Test</div>
        </div>
        
        <div class="test-area">
            <h3>Test Follow-up Context</h3>
            <p>This tests the follow-up context handling we implemented:</p>
            
            <button class="button" onclick="testStep1()">Step 1: "when is the next bluebell workshop"</button>
            <button class="button" onclick="testStep2()">Step 2: "how many people can attend"</button>
            <button class="button" onclick="clearResults()">Clear Results</button>
            
            <div id="results"></div>
        </div>
        
        <div class="test-area">
            <h3>Context Test Results</h3>
            <div id="contextResults">
                <p>Click the buttons above to test the follow-up context functionality.</p>
            </div>
        </div>

        <div class="test-area">
            <h3>Comprehensive Test Runner (Rule-based)</h3>
            <p>Upload a CSV of questions (first column). The runner will call the live API for each question and show intent, confidence, key URLs, and rule checks for free-course, terms, and about pages.</p>
            <div>
                <label>API URL: <input id="apiUrl" style="width:420px" value="https://alan-chat-proxy.vercel.app/api/chat"></label>
                <input type="file" id="csvFile" accept=".csv" />
                <button class="button" onclick="runCsvTests()">Run CSV Tests</button>
                <button class="button" onclick="clearTable()">Clear Table</button>
            </div>
            <div style="max-height:420px; overflow:auto; margin-top:10px;">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Query</th>
                            <th>Intent</th>
                            <th>Confidence</th>
                            <th>Landing/Services/Events/Products</th>
                            <th>Found URLs</th>
                            <th>Checks</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let previousQuery = null;
        let testResults = [];

        function getRulesForQuery(q) {
            const s = String(q || '').toLowerCase();
            const rules = [];
            if (s.includes('free') && s.includes('online') && s.includes('course')) {
                rules.push({ req: ['free-online-photography-course'], forbidKinds: ['event','product'], cap: 3 });
            }
            if (/(terms|refund|cancellation|policy)/.test(s)) {
                rules.push({ req: ['terms-and-conditions'], forbidKinds: [], cap: 0 });
            }
            if (/(who is alan ranger|about alan)/.test(s)) {
                rules.push({ req: ['about-alan-ranger'], forbidKinds: ['event','product'], cap: 0 });
            }
            return rules;
        }

        async function runCsvTests() {
            const file = document.getElementById('csvFile').files[0];
            if (!file) { alert('Select a CSV first'); return; }
            const api = document.getElementById('apiUrl').value.trim();
            const text = await file.text();
            const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
            let idx = 0;
            for (const line of lines) {
                idx++;
                const query = line.split(',')[0].replace(/^"|"$/g,'');
                try {
                    const res = await fetch(api, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ query, pageContext: null }) });
                    const data = await res.json();
                    addRow(idx, query, data);
                } catch (e) {
                    addRow(idx, query, { error: e.message });
                }
            }
        }

        function clearTable() {
            document.querySelector('#resultsTable tbody').innerHTML='';
        }

        function pickUrls(structured) {
            const out = [];
            const pushArr = arr => (arr||[]).forEach(e => out.push(e.page_url || e.url || e.href || ''));
            pushArr(structured?.landing);
            pushArr(structured?.services);
            pushArr(structured?.products);
            pushArr(structured?.events);
            pushArr(structured?.articles);
            return out.filter(Boolean);
        }

        function addRow(i, query, data) {
            const tb = document.querySelector('#resultsTable tbody');
            const tr = document.createElement('tr');
            const intent = data?.structured?.intent || '-';
            const conf = data?.confidence ?? '-';
            const l = (data?.structured?.landing||[]).length;
            const s = (data?.structured?.services||[]).length;
            const e = (data?.structured?.events||[]).length;
            const p = (data?.structured?.products||[]).length;
            const urls = pickUrls(data?.structured || {});

            const checks = [];
            const rules = getRulesForQuery(query);
            for (const r of rules) {
                const hasReq = r.req.some(substr => urls.some(u => (u||'').includes(substr)) || String(data?.answer_markdown||'').includes(substr));
                if (!hasReq) checks.push(`missing ${r.req.join(' OR ')}`);
                for (const k of (r.forbidKinds||[])) {
                    const arr = data?.structured?.[k+'s'] || data?.structured?.[k] || [];
                    if (Array.isArray(arr) && arr.length>0) checks.push(`forbidden ${k}`);
                }
                if (r.cap===0) {
                    if (e) checks.push('events>0');
                    if (p) checks.push('products>0');
                } else if (typeof r.cap==='number') {
                    if (e>r.cap) checks.push(`events>${r.cap}`);
                    if (p>r.cap) checks.push(`products>${r.cap}`);
                }
            }

            tr.innerHTML = `
                <td>${i}</td>
                <td>${escapeHtml(query)}</td>
                <td>${intent}</td>
                <td>${conf}</td>
                <td>landing:${l} • services:${s} • events:${e} • products:${p}</td>
                <td style="max-width:360px; word-break:break-all;">${urls.slice(0,6).map(u=>`<div>${escapeHtml(u)}</div>`).join('')}</td>
                <td>${checks.length? `<span style='color:#dc3545'>${checks.join('; ')}</span>`: '<span style="color:#28a745">ok</span>'}</td>
            `;
            tb.appendChild(tr);
        }

        function escapeHtml(s){
            return String(s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
        }

        function testStep1() {
            const query = "when is the next bluebell workshop";
            previousQuery = query;
            
            addResult("Step 1", `Query: "${query}"`, "success");
            addResult("Step 1", "Previous query stored for context", "success");
            
            // Simulate the contextual query building
            const contextualQuery = buildContextualQuery(query, null);
            addResult("Step 1", `Contextual query: "${contextualQuery}"`, "success");
        }

        function testStep2() {
            if (!previousQuery) {
                addResult("Step 2", "ERROR: No previous query. Run Step 1 first.", "error");
                return;
            }
            
            const followUp = "how many people can attend";
            const contextualQuery = buildContextualQuery(followUp, previousQuery);
            
            addResult("Step 2", `Follow-up: "${followUp}"`, "success");
            addResult("Step 2", `Previous query: "${previousQuery}"`, "success");
            addResult("Step 2", `Contextual query: "${contextualQuery}"`, "success");
            addResult("Step 2", "✅ Follow-up context working correctly!", "success");
        }

        function buildContextualQuery(currentQuery, previousQuery) {
            if (!previousQuery) return currentQuery;

            const q = (currentQuery || '').trim().toLowerCase();
            const prev = (previousQuery || '').trim();

            const followUpStarts = [
                'how many', 'how much', 'when', 'where', 'how long', 'what price', 'price',
                'cost', 'how to book', 'how do i book', 'fitness level', 'how fit'
            ];

            const isShort = q.split(/\s+/).length <= 6;
            const isFollowUp = followUpStarts.some(p => q.startsWith(p));

            if (isFollowUp || isShort) {
                return `${prev} ${currentQuery}`.trim();
            }
            return currentQuery;
        }

        function addResult(step, message, type) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<strong>${step}:</strong> ${message}`;
            resultsDiv.appendChild(resultDiv);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            previousQuery = null;
        }
    </script>
</body>
</html>
