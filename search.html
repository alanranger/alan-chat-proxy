<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AI Search Tester</title>
  <link rel="stylesheet" href="/_next/static/css/081a0fca5a9bd20.css"/>
  <style>
    body { background:#0b1220; color:#dbe4ff; font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; padding:24px; }
    .container { max-width:900px; margin:0 auto; }
    .card { background:#0f172a; border:1px solid #1b2540; border-radius:8px; padding:16px; margin-bottom:16px; }
    input, textarea { width:100%; background:#0b1426; border:1px solid #1b2540; color:#dbe4ff; padding:10px 12px; border-radius:6px; }
    button { background:#2563eb; color:#fff; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; }
    small.mono { font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; }
    table { width:100%; border-collapse:collapse; }
    th,td { padding:8px 10px; border-bottom:1px solid #1b2540; vertical-align:top; }
    a { color:#dbe4ff; text-decoration:underline; }
    .row { display:flex; gap:12px; }
    .row > * { flex:1; }
    @media (max-width:800px){ .row{ flex-direction:column; } }
    .score { color:#22c55e; }
    .muted { opacity:.8; }
    .mono { font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; }
  </style>
</head>
<body>
<div class="container">
  <h2>AI Search Tester</h2>

  <div class="card">
    <div><small>INGEST TOKEN (BEARER)</small></div>
    <input id="token" placeholder="your token"/>
    <small class="muted">Saved locally; sent as <span class="mono">Authorization: Bearer …</span></small>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <div><small>Query</small></div>
        <input id="query" placeholder="e.g. photography workshops in Coventry"/>
      </div>
      <div style="max-width:140px">
        <div><small>topK</small></div>
        <input id="topk" value="8"/>
      </div>
    </div>
    <div style="margin-top:12px">
      <button id="run">Run Search</button>
    </div>
  </div>

  <div class="card">
    <div><small>Results</small></div>
    <table>
      <thead><tr><th style="width:70px">Score</th><th>URL</th><th>Snippet</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <div class="card">
    <div><small>Raw Response</small></div>
    <pre id="raw" class="mono" style="white-space:pre-wrap;word-break:break-word"></pre>
  </div>
</div>

<script>
const $ = (id) => document.getElementById(id);
const saveToken = () => localStorage.setItem('ingest_token', $('token').value || '');
$('token').value = localStorage.getItem('ingest_token') || '';
$('token').addEventListener('change', saveToken);
$('token').addEventListener('input', saveToken);

function row(url, score, content) {
  const tr = document.createElement('tr');
  const snip = (content||'').slice(0,280).replace(/\s+/g,' ');
  tr.innerHTML = `
    <td class="mono score">${(score ?? 0).toFixed(3)}</td>
    <td class="mono"><a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a></td>
    <td class="mono">${snip}${content && content.length>280 ? '…' : ''}</td>
  `;
  return tr;
}

$('run').onclick = async () => {
  const token = $('token').value.trim();
  const query = $('query').value.trim();
  const topK = Math.max(1, Math.min(32, parseInt($('topk').value || '8', 10)));
  $('rows').innerHTML = '';
  $('raw').textContent = '';

  if (!token || !query) return;

  const r = await fetch('/api/tools?action=search', {
    method: 'POST',
    headers: { 'Authorization':'Bearer '+token, 'Content-Type':'application/json' },
    body: JSON.stringify({ query, topK })
  });

  let body;
  try { body = await r.json(); } catch { body = { error:'non_json', status:r.status }; }
  $('raw').textContent = JSON.stringify(body, null, 2);

  const matches = (body && body.matches) || [];
  for (const m of matches) $('rows').appendChild(row(m.url, m.score, m.content));
};
</script>
</body>
</html>
