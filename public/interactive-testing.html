<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🤖 Enhanced Interactive Chat Bot Testing</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .test-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .question-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .question-card.current {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        .question-card.completed {
            border-color: #28a745;
            background: #e8f5e8;
        }
        
        .question-card.failed {
            border-color: #dc3545;
            background: #ffeaea;
        }
        
        .response-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .scoring-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .score-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .score-input label {
            font-weight: 600;
            color: #495057;
        }
        
        .score-input input, .score-input select, .score-input textarea {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .score-input textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pass {
            background: #d4edda;
            color: #155724;
        }
        
        .status-fail {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        /* Chat Response Styling */
        .chat-response {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .chat-bubble {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        
        .chat-bubble h4 {
            margin: 0 0 10px 0;
            color: #007bff;
            font-size: 16px;
        }
        
        .chat-bubble p {
            margin: 8px 0;
            line-height: 1.5;
        }
        
        .chat-bubble strong {
            color: #495057;
        }
        
        .events-block {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .events-block h4 {
            color: #1976d2;
            margin: 0 0 10px 0;
        }
        
        .event-item {
            background: white;
            border: 1px solid #e1f5fe;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .event-title {
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 5px;
        }
        
        .event-details {
            font-size: 14px;
            color: #666;
        }
        
        .articles-block {
            background: #f3e5f5;
            border: 1px solid #e1bee7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .articles-block h4 {
            color: #7b1fa2;
            margin: 0 0 10px 0;
        }
        
        .article-item {
            background: white;
            border: 1px solid #f3e5f5;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .article-title {
            font-weight: 600;
            color: #7b1fa2;
            margin-bottom: 5px;
        }
        
        .article-details {
            font-size: 14px;
            color: #666;
        }
        
        .confidence-pill {
            background: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin: 5px 0;
        }
        
        .pills-block {
            margin: 15px 0;
        }
        
        .pill {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            text-decoration: none;
            margin: 4px;
            font-size: 14px;
        }
        
        .pill:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🤖 Enhanced Interactive Chat Bot Testing</h1>
        <p>Test your 28-question baseline with your business knowledge scoring</p>
    </div>

    <div class="test-section">
        <h2>📊 Test Progress</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="currentQuestion">1</div>
                <div class="stat-label">Current Question</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalQuestions">28</div>
                <div class="stat-label">Total Questions</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedCount">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="averageScore">0</div>
                <div class="stat-label">Avg Score</div>
            </div>
        </div>
        </div>

    <div class="test-section">
        <h2>📝 Current Question</h2>
        <div id="currentQuestionCard" class="question-card current">
            <h3 id="questionText">Loading question...</h3>
            <p id="questionFocus">Loading focus...</p>
        </div>

        <div id="responseSection" class="hidden">
            <h3>🤖 Chat Bot Response</h3>
            <div id="responseDisplay" class="response-display">
                <div id="chatResponse" class="chat-response"></div>
        </div>

            <div class="scoring-section">
                <div class="score-input">
                    <label for="confidenceScore">Your Assessment: How confident should the bot be? (0-100):</label>
                    <input type="number" id="confidenceScore" min="0" max="100" placeholder="e.g., 85">
                    <small style="color: #666;">Compare this to the bot's actual confidence shown above</small>
                </div>
                <div class="score-input">
                    <label for="qualityScore">Your Assessment: How good is the response? (0-100):</label>
                    <input type="number" id="qualityScore" min="0" max="100" placeholder="e.g., 100">
                    <small style="color: #666;">Rate the overall quality of the bot's response</small>
                </div>
                <div class="score-input">
                    <label for="verdict">Your Verdict:</label>
                    <select id="verdict">
                        <option value="">Select verdict...</option>
                        <option value="perfect">Perfect</option>
                        <option value="nearly perfect">Nearly Perfect</option>
                        <option value="very good">Very Good</option>
                        <option value="good">Good</option>
                        <option value="poor">Poor</option>
                        <option value="very poor">Very Poor</option>
                    </select>
                </div>
                <div class="score-input">
                    <label for="notes">Your Notes/Issues:</label>
                    <textarea id="notes" placeholder="What issues did you find? What should be improved?"></textarea>
                </div>
                </div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="saveScore()">Save Score & Next Question</button>
                <button class="btn btn-secondary" onclick="skipQuestion()">Skip Question</button>
            </div>
        </div>

        <div id="loadingSection">
            <div class="loading">
                <p>🔄 Loading question and getting chat bot response...</p>
            </div>
            </div>
        </div>

    <div class="test-section">
        <h2>📋 All Questions</h2>
        <div id="questionsList">
            <!-- Questions will be populated here -->
        </div>
    </div>

    <div class="test-section">
        <h2>📊 Results Summary</h2>
        <button class="btn" onclick="exportResults()">📥 Export Results</button>
        <button class="btn btn-secondary" onclick="clearResults()">🗑️ Clear All Results</button>
        
        <table class="results-table" id="resultsTable">
            <thead>
                <tr>
                    <th>Question</th>
                    <th>Verdict</th>
                    <th>Quality Score</th>
                    <th>Confidence Score</th>
                    <th>Status</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
                <!-- Results will be populated here -->
            </tbody>
        </table>
    </div>

    <script>
        // Test questions from Alan's baseline
        const testQuestions = [
            {
                category: "Technical Photography Concepts",
                question: "what is exposure triangle",
                focus: "Should explain the relationship between aperture, shutter speed, and ISO",
                expectedType: "advice"
            },
            {
                category: "Technical Photography Concepts", 
                question: "what is iso",
                focus: "Should explain ISO sensitivity and its role in exposure",
                expectedType: "advice"
            },
            {
                category: "Technical Photography Concepts",
                question: "what is aperture", 
                focus: "Should explain aperture, f-stops, and depth of field",
                expectedType: "advice"
            },
            {
                category: "Technical Photography Concepts",
                question: "what is shutter speed",
                focus: "Should explain shutter speed and motion control", 
                expectedType: "advice"
            },
            {
                category: "Equipment Recommendations",
                question: "what tripod do you recommend",
                focus: "Should provide specific tripod recommendations with reasoning",
                expectedType: "advice"
            },
            {
                category: "Equipment Recommendations",
                question: "what camera should I buy",
                focus: "Should provide camera recommendations based on needs",
                expectedType: "advice"
            },
            {
                category: "Equipment Recommendations", 
                question: "what camera do you recommend for a beginner",
                focus: "Should provide beginner camera recommendations",
                expectedType: "advice"
            },
            {
                category: "Person Queries",
                question: "peter orton",
                focus: "Should find Peter Orton article and connect to related RPS content",
                expectedType: "advice"
            },
            {
                category: "Person Queries",
                question: "who is alan ranger", 
                focus: "Should provide biographical information about Alan",
                expectedType: "advice"
            },
            {
                category: "Event Queries",
                question: "when is your next devon workshop",
                focus: "Should list Devon workshops with dates and details",
                expectedType: "events"
            },
            {
                category: "Event Queries",
                question: "when is your next photography course",
                focus: "Should list photography courses with dates", 
                expectedType: "events"
            },
            {
                category: "Event Queries",
                question: "when are your next bluebell workshops",
                focus: "Should list bluebell workshop dates",
                expectedType: "events"
            },
            {
                category: "Event Queries",
                question: "do you have autumn workshops",
                focus: "Should list autumn workshop options",
                expectedType: "events"
            },
            {
                category: "Technical Advice",
                question: "how to take sharp photos",
                focus: "Should provide practical tips for sharp photography",
                expectedType: "advice"
            },
            {
                category: "Technical Advice",
                question: "what is long exposure photography",
                focus: "Should explain long exposure techniques and applications",
                expectedType: "advice"
            },
            {
                category: "Technical Advice",
                question: "why are my images always grainy and noisy",
                focus: "Should provide solutions for grainy/noisy images",
                expectedType: "advice"
            },
            {
                category: "Technical Advice",
                question: "why arent my images sharp",
                focus: "Should provide tips for sharper images",
                expectedType: "advice"
            },
            {
                category: "Course/Workshop Logistics",
                question: "do I need a laptop for lightroom course",
                focus: "Should answer equipment requirements for the course",
                expectedType: "advice"
            },
            {
                category: "Course/Workshop Logistics",
                question: "do you provide photography courses",
                focus: "Should list available photography courses",
                expectedType: "advice"
            },
            {
                category: "Course/Workshop Logistics",
                question: "do you have online lessons",
                focus: "Should mention online lesson options",
                expectedType: "advice"
            },
            {
                category: "Course/Workshop Logistics",
                question: "do you have a lightroom course",
                focus: "Should list Lightroom course options",
                expectedType: "advice"
            },
            {
                category: "Course/Workshop Logistics",
                question: "whats your online photography course",
                focus: "Should describe online course offerings",
                expectedType: "advice"
            },
            {
                category: "Business Information",
                question: "where i can see your terms and conditions",
                focus: "Should provide terms and conditions information",
                expectedType: "advice"
            },
            {
                category: "Business Information",
                question: "tell me about rps mentoring",
                focus: "Should explain RPS mentoring services",
                expectedType: "advice"
            },
            {
                category: "Business Information",
                question: "do you do commercial photography",
                focus: "Should explain commercial photography services",
                expectedType: "advice"
            },
            {
                category: "Business Information",
                question: "do you do portrait photography",
                focus: "Should explain portrait photography services",
                expectedType: "advice"
            },
            {
                category: "Business Information",
                question: "is your photography academy really free",
                focus: "Should clarify free vs paid academy content",
                expectedType: "advice"
            },
            {
                category: "Equipment Requirements",
                question: "what camera do i need for your courses and workshops",
                focus: "Should specify camera requirements for courses",
                expectedType: "advice"
            }
        ];

        let currentQuestionIndex = 0;
        let testResults = [];
        let isTestRunning = false;
        let savedScores = {};

        // Initialize the test
        function initTest() {
            loadSavedScores();
            loadBaselineScores();
            populateQuestionsList();
            loadQuestion(0);
        }

        // Load baseline scores from Alan's manual testing
        function loadBaselineScores() {
            const baselineScores = {
                "what is exposure triangle": {
                    "confidenceScore": 85,
                    "qualityScore": 100,
                    "verdict": "perfect",
                    "notes": "should have higher confidence - gave a good right answer and show perfectly matched article tiles",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "what is iso": {
                    "confidenceScore": 70,
                    "qualityScore": 75,
                    "verdict": "very good",
                    "notes": "didn't answer the question it referenced the article but did show relevant articles in article block",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "what is aperture": {
                    "confidenceScore": 70,
                    "qualityScore": 10,
                    "verdict": "very poor",
                    "notes": "didn't even attempt to answer question and no related articles section",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "what is shutter speed": {
                    "confidenceScore": 70,
                    "qualityScore": 50,
                    "verdict": "good",
                    "notes": "didn't answer the question showed one correct article but the pdf field checklist was from wrong blog and topic",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "what tripod do you recommend": {
                    "confidenceScore": 85,
                    "qualityScore": 95,
                    "verdict": "nearly perfect",
                    "notes": "should have higher confidence - gave a good right answer and show perfectly matched article tiles",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "what camera should I buy": {
                    "confidenceScore": 70,
                    "qualityScore": 50,
                    "verdict": "good",
                    "notes": "initial response good but related article tiles not great and there were better ones available not showing",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "what camera do you recommend for a beginner": {
                    "confidenceScore": 70,
                    "qualityScore": 50,
                    "verdict": "good",
                    "notes": "initial response good but related article tiles not great and there were better ones available not showing",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "peter orton": {
                    "confidenceScore": 70,
                    "qualityScore": 75,
                    "verdict": "very good",
                    "notes": "good but could have shown more related articles for other case studies too",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "who is alan ranger": {
                    "confidenceScore": 70,
                    "qualityScore": 75,
                    "verdict": "very good",
                    "notes": "good initial response but shouldn't have shown related articles, should shown orange pill linked to about-alan page",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "when is your next devon workshop": {
                    "confidenceScore": 95,
                    "qualityScore": 95,
                    "verdict": "nearly perfect",
                    "notes": "no changes required",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "when is your next photography course": {
                    "confidenceScore": 95,
                    "qualityScore": 30,
                    "verdict": "poor",
                    "notes": "it lists workshops not courses in the events block",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "when are your next bluebell workshops": {
                    "confidenceScore": 95,
                    "qualityScore": 100,
                    "verdict": "perfect",
                    "notes": "no changes required",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "do you have autumn workshops": {
                    "confidenceScore": 95,
                    "qualityScore": 50,
                    "verdict": "good",
                    "notes": "missing some events for autumn like peak district but need to check if they contain enough clues to be classified as autumn",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "how to take sharp photos": {
                    "confidenceScore": 70,
                    "qualityScore": 50,
                    "verdict": "good",
                    "notes": "initial response good but related article tiles not great and there were better ones available not showing",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "what is long exposure photography": {
                    "confidenceScore": 70,
                    "qualityScore": 75,
                    "verdict": "very good",
                    "notes": "didn't answer the question it referenced the article but did show relevant articles in article block",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "why are my images always grainy and noisy": {
                    "confidenceScore": 70,
                    "qualityScore": 10,
                    "verdict": "very poor",
                    "notes": "wrong initial response that isn't related and two related articles not related at all - should have found answers on ISO",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "why arent my images sharp": {
                    "confidenceScore": 70,
                    "qualityScore": 50,
                    "verdict": "good",
                    "notes": "initial response good but related article tiles showing two unrelated articles rather than better ones",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "do I need a laptop for lightroom course": {
                    "confidenceScore": 95,
                    "qualityScore": 75,
                    "verdict": "very good",
                    "notes": "initial response not good as didn't answer question but course tiles correct and they answer the question",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "do you provide photography courses": {
                    "confidenceScore": 0.2,
                    "qualityScore": 10,
                    "verdict": "very poor",
                    "notes": "confidence pill says 0.2% then classification options > go to wrong events these are not the classification options we agreed and had working before",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "do you have online lessons": {
                    "confidenceScore": 70,
                    "qualityScore": 30,
                    "verdict": "poor",
                    "notes": "initial response weak and links/pills to the landing pages or article tiles",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "do you have a lightroom course": {
                    "confidenceScore": 95,
                    "qualityScore": 75,
                    "verdict": "very good",
                    "notes": "listed right events but could also have responded initially with a better answer",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "whats your online photography course": {
                    "confidenceScore": 0.2,
                    "qualityScore": 10,
                    "verdict": "very poor",
                    "notes": "confidence pill says 0.2% then classification options > go to wrong events these are not the classification options we agreed and had working before",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "where i can see your terms and conditions": {
                    "confidenceScore": 70,
                    "qualityScore": 95,
                    "verdict": "nearly perfect",
                    "notes": "no changes required",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "tell me about rps mentoring": {
                    "confidenceScore": 70,
                    "qualityScore": 75,
                    "verdict": "very good",
                    "notes": "perfect initial response and did show one relevant article and one not relevant and could have easily found articles with rps",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "do you do commercial photography": {
                    "confidenceScore": 70,
                    "qualityScore": 10,
                    "verdict": "very poor",
                    "notes": "Initial response had nothing to do with question, related articles were not about the question",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "do you do portrait photography": {
                    "confidenceScore": 70,
                    "qualityScore": 10,
                    "verdict": "very poor",
                    "notes": "Initial response had nothing to do with question, related articles were not about the question",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "is your photography academy really free": {
                    "confidenceScore": 70,
                    "qualityScore": 10,
                    "verdict": "very poor",
                    "notes": "Initial response had nothing to do with question, related articles were not about the question",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "what camera do i need for your courses and workshops": {
                    "confidenceScore": 95,
                    "qualityScore": 10,
                    "verdict": "very poor",
                    "notes": "Initial response had nothing to do with question, related articles were not about the question",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                }
            };

            // Merge baseline scores (only if not already saved)
            Object.keys(baselineScores).forEach(question => {
                if (!savedScores[question]) {
                    savedScores[question] = baselineScores[question];
                }
            });
            
            // Save updated scores
            saveScoresToStorage();
        }

        // Load saved scores from localStorage
        function loadSavedScores() {
            const saved = localStorage.getItem('interactiveTestScores');
            if (saved) {
                savedScores = JSON.parse(saved);
            }
        }

        // Save scores to localStorage
        function saveScoresToStorage() {
            localStorage.setItem('interactiveTestScores', JSON.stringify(savedScores));
        }

        // Render chat response in proper format
        function renderChatResponse(data) {
            const chatResponse = document.getElementById('chatResponse');
            chatResponse.innerHTML = '';
            
            // Main answer bubble
            if (data.answer_markdown || data.answer) {
                const answerDiv = document.createElement('div');
                answerDiv.className = 'chat-bubble';
                
                let answerText = data.answer_markdown || data.answer;
                if (typeof answerText === 'string') {
                    // Convert markdown to HTML
                    answerText = answerText
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/\n/g, '<br>');
                }
                
                answerDiv.innerHTML = `<p>${answerText}</p>`;
                chatResponse.appendChild(answerDiv);
            }
            
            // Bot's confidence score - make it prominent
            if (data.confidence) {
                const confidencePill = document.createElement('div');
                confidencePill.className = 'confidence-pill';
                confidencePill.style.cssText = 'background: #ff9800; color: white; padding: 8px 16px; border-radius: 20px; font-size: 16px; font-weight: bold; margin: 10px 0; display: inline-block;';
                confidencePill.textContent = `🤖 Bot's Confidence: ${Math.round(data.confidence * 100)}%`;
                chatResponse.appendChild(confidencePill);
            }
            
            // Events block
            if (data.structured && data.structured.events && data.structured.events.length > 0) {
                const eventsBlock = document.createElement('div');
                eventsBlock.className = 'events-block';
                eventsBlock.innerHTML = '<h4>📅 Events</h4>';
                
                data.structured.events.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'event-item';
                    eventDiv.innerHTML = `
                        <div class="event-title">${event.title || event.event_title || 'Event'}</div>
                        <div class="event-details">
                            ${event.date_start ? `Date: ${event.date_start}` : ''}
                            ${event.location ? ` | Location: ${event.location}` : ''}
                            ${event.price ? ` | Price: ${event.price}` : ''}
                        </div>
                    `;
                    eventsBlock.appendChild(eventDiv);
                });
                
                chatResponse.appendChild(eventsBlock);
            }
            
            // Articles block
            if (data.structured && data.structured.articles && data.structured.articles.length > 0) {
                const articlesBlock = document.createElement('div');
                articlesBlock.className = 'articles-block';
                articlesBlock.innerHTML = '<h4>📚 Related Articles</h4>';
                
                data.structured.articles.forEach(article => {
                    const articleDiv = document.createElement('div');
                    articleDiv.className = 'article-item';
                    articleDiv.innerHTML = `
                        <div class="article-title">${article.title || 'Article'}</div>
                        <div class="article-details">
                            ${article.display_date ? `Published: ${article.display_date}` : ''}
                            ${article.page_url ? ` | <a href="${article.page_url}" target="_blank">Read Article</a>` : ''}
                </div>
            `;
                    articlesBlock.appendChild(articleDiv);
                });
                
                chatResponse.appendChild(articlesBlock);
            }
            
            // Pills/action buttons
            if (data.structured && data.structured.pills && data.structured.pills.length > 0) {
                const pillsBlock = document.createElement('div');
                pillsBlock.className = 'pills-block';
                
                data.structured.pills.forEach(pill => {
                    const pillLink = document.createElement('a');
                    pillLink.className = 'pill';
                    pillLink.href = pill.url || pill.href || '#';
                    pillLink.textContent = pill.label || pill.text || 'Action';
                    pillLink.target = '_blank';
                    pillsBlock.appendChild(pillLink);
                });
                
                chatResponse.appendChild(pillsBlock);
            }
            
            // Debug info (collapsible)
            if (data.debug) {
                const debugDiv = document.createElement('details');
                debugDiv.innerHTML = `
                    <summary>🔍 Debug Info</summary>
                    <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 12px; overflow-x: auto;">${JSON.stringify(data.debug, null, 2)}</pre>
                `;
                chatResponse.appendChild(debugDiv);
            }
        }

        // Populate the questions list
        function populateQuestionsList() {
            const questionsList = document.getElementById('questionsList');
            questionsList.innerHTML = '';
            
            testQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-card';
                questionDiv.id = `question-${index}`;
                
                // Check if we have previous scores for this question
                const previousScore = savedScores[q.question];
                let statusHtml = '<span class="status-badge status-pending">Pending</span>';
                let previousScoresHtml = '';
                
                if (previousScore) {
                    const statusClass = previousScore.qualityScore >= 70 ? 'status-pass' : 'status-fail';
                    statusHtml = `<span class="status-badge ${statusClass}">${previousScore.verdict}</span>`;
                    
                    previousScoresHtml = `
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 14px;">
                            <strong>Previous Score:</strong> ${previousScore.qualityScore}/100 | 
                            <strong>Confidence:</strong> ${previousScore.confidenceScore}% | 
                            <strong>Verdict:</strong> ${previousScore.verdict}
                            ${previousScore.notes ? `<br><strong>Notes:</strong> ${previousScore.notes}` : ''}
                            <br><small>Last tested: ${new Date(previousScore.timestamp).toLocaleString()}</small>
                        </div>
                    `;
                }
                
                questionDiv.innerHTML = `
                    <h4>${q.question}</h4>
                    <p><strong>Category:</strong> ${q.category}</p>
                    <p><strong>Focus:</strong> ${q.focus}</p>
                    <p><strong>Status:</strong> ${statusHtml}</p>
                    ${previousScoresHtml}
                `;
                questionsList.appendChild(questionDiv);
            });
        }

        // Load a specific question
        async function loadQuestion(index) {
            if (index >= testQuestions.length) {
                alert('All questions completed!');
                return;
            }

            currentQuestionIndex = index;
            const question = testQuestions[index];
            
            // Update UI
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('questionFocus').textContent = question.focus;
            document.getElementById('currentQuestion').textContent = index + 1;
            
            // Update progress
            const progress = ((index + 1) / testQuestions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // Update current question card
            document.querySelectorAll('.question-card').forEach(card => card.classList.remove('current'));
            const currentCard = document.getElementById(`question-${index}`);
            if (currentCard) {
                currentCard.classList.add('current');
            }
            
            // Show loading
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('responseSection').classList.add('hidden');
            
            // Load previous scores if available
            const questionKey = question.question;
            const previousScore = savedScores[questionKey];
            
            if (previousScore) {
                document.getElementById('confidenceScore').value = previousScore.confidenceScore || '';
                document.getElementById('qualityScore').value = previousScore.qualityScore || '';
                document.getElementById('verdict').value = previousScore.verdict || '';
                document.getElementById('notes').value = previousScore.notes || '';
            } else {
                document.getElementById('confidenceScore').value = '';
                document.getElementById('qualityScore').value = '';
                document.getElementById('verdict').value = '';
                document.getElementById('notes').value = '';
            }
            
            try {
                // Get response from chat bot
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: question.question,
                        sessionId: 'interactive-test-session'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Display response in chat format
                renderChatResponse(data);
                
                // Hide loading, show response section
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('responseSection').classList.remove('hidden');
                
            } catch (error) {
                document.getElementById('responseDisplay').textContent = `Error: ${error.message}`;
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('responseSection').classList.remove('hidden');
            }
        }

        // Save score and move to next question
        function saveScore() {
            const confidenceScore = parseInt(document.getElementById('confidenceScore').value);
            const qualityScore = parseInt(document.getElementById('qualityScore').value);
            const verdict = document.getElementById('verdict').value;
            const notes = document.getElementById('notes').value;
            
            if (!confidenceScore || !qualityScore || !verdict) {
                alert('Please fill in all required fields');
                return;
            }

            const result = {
                questionIndex: currentQuestionIndex,
                question: testQuestions[currentQuestionIndex].question,
                category: testQuestions[currentQuestionIndex].category,
                focus: testQuestions[currentQuestionIndex].focus,
                confidenceScore: confidenceScore,
                qualityScore: qualityScore,
                verdict: verdict,
                notes: notes,
                timestamp: new Date().toISOString()
            };

            testResults.push(result);
            
            // Save to localStorage
            savedScores[testQuestions[currentQuestionIndex].question] = {
                confidenceScore: confidenceScore,
                qualityScore: qualityScore,
                verdict: verdict,
                notes: notes,
                timestamp: new Date().toISOString()
            };
            saveScoresToStorage();
            
            // Update question card
            const questionCard = document.getElementById(`question-${currentQuestionIndex}`);
            questionCard.classList.remove('current');
            questionCard.classList.add('completed');
            
            const statusBadge = questionCard.querySelector('.status-badge');
            statusBadge.textContent = verdict;
            statusBadge.className = `status-badge ${qualityScore >= 70 ? 'status-pass' : 'status-fail'}`;
            
            // Update stats
            updateStats();
            updateResultsTable();
            
            // Move to next question
            loadQuestion(currentQuestionIndex + 1);
        }

        // Skip current question
        function skipQuestion() {
            loadQuestion(currentQuestionIndex + 1);
        }

        // Update statistics
        function updateStats() {
            const completed = testResults.length;
            const total = testQuestions.length;
            
            document.getElementById('completedCount').textContent = completed;
            
            if (completed > 0) {
                const avgScore = testResults.reduce((sum, r) => sum + r.qualityScore, 0) / completed;
                document.getElementById('averageScore').textContent = Math.round(avgScore);
            }
        }

        // Update results table
        function updateResultsTable() {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            testResults.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.question}</td>
                    <td>${result.verdict}</td>
                    <td>${result.qualityScore}</td>
                    <td>${result.confidenceScore}</td>
                    <td><span class="status-badge ${result.qualityScore >= 70 ? 'status-pass' : 'status-fail'}">${result.qualityScore >= 70 ? 'Pass' : 'Fail'}</span></td>
                    <td>${result.notes}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Export results
        function exportResults() {
            const data = {
                timestamp: new Date().toISOString(),
                totalQuestions: testQuestions.length,
                completedQuestions: testResults.length,
                results: testResults
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `interactive-test-results-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Clear all results
        function clearResults() {
            if (confirm('Are you sure you want to clear all results? This will delete all saved scores and notes.')) {
                testResults = [];
                currentQuestionIndex = 0;
                savedScores = {};
                
                // Clear localStorage
                localStorage.removeItem('interactiveTestScores');
                
                // Reset all question cards
                for (let i = 0; i < testQuestions.length; i++) {
                    const questionCard = document.getElementById(`question-${i}`);
                    questionCard.classList.remove('current', 'completed', 'failed');
                    questionCard.classList.add('pending');
                    
                    const statusBadge = questionCard.querySelector('.status-badge');
                    statusBadge.textContent = 'Pending';
                    statusBadge.className = 'status-badge status-pending';
                }
                
                // Reset stats
                document.getElementById('completedCount').textContent = '0';
                document.getElementById('averageScore').textContent = '0';
                document.getElementById('progressFill').style.width = '0%';
                
                // Clear results table
                document.getElementById('resultsBody').innerHTML = '';
                
                // Reset to first question
                loadQuestion(0);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initTest);
    </script>
</body>
</html>