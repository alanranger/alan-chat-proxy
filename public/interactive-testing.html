<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Enhanced Interactive Chat Bot Testing</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .test-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .question-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .question-card.current {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        .question-card.completed {
            border-color: #28a745;
            background: #e8f5e8;
        }
        
        .question-card.failed {
            border-color: #dc3545;
            background: #ffeaea;
        }
        
        .response-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .scoring-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .score-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .score-input label {
            font-weight: 600;
            color: #495057;
        }
        
        .score-input input, .score-input select, .score-input textarea {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .score-input textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            max-height: 800px;
            overflow-y: auto;
            display: block;
        }
        
        .results-table thead {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        
        .results-table tbody {
            display: block;
            max-height: 700px;
            overflow-y: auto;
        }
        
        .results-table thead tr {
            display: table-row;
        }
        
        .results-table tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        
        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .sortable:hover {
            background: #e9ecef;
        }
        
        .sort-asc::after {
            content: " ‚Üë";
            color: #007bff;
        }
        
        .sort-desc::after {
            content: " ‚Üì";
            color: #007bff;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pass {
            background: #d4edda;
            color: #155724;
        }
        
        .status-fail {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        /* Chat Response Styling */
        .chat-response {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .chat-bubble {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        
        .chat-bubble h4 {
            margin: 0 0 10px 0;
            color: #007bff;
            font-size: 16px;
        }
        
        .chat-bubble p {
            margin: 8px 0;
            line-height: 1.5;
        }
        
        .chat-bubble strong {
            color: #495057;
        }
        
        .events-block {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .events-block h4 {
            color: #1976d2;
            margin: 0 0 10px 0;
        }
        
        .event-item {
            background: white;
            border: 1px solid #e1f5fe;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .event-title {
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 5px;
        }
        
        .event-details {
            font-size: 14px;
            color: #666;
        }
        
        .articles-block {
            background: #f3e5f5;
            border: 1px solid #e1bee7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .articles-block h4 {
            color: #7b1fa2;
            margin: 0 0 10px 0;
        }
        
        .article-item {
            background: white;
            border: 1px solid #f3e5f5;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .article-title {
            font-weight: 600;
            color: #7b1fa2;
            margin-bottom: 5px;
        }
        
        .article-details {
            font-size: 14px;
            color: #666;
        }
        
        .confidence-pill {
            background: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin: 5px 0;
        }
        
        .pills-block {
            margin: 15px 0;
        }
        
        .pill {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            text-decoration: none;
            margin: 4px;
            font-size: 14px;
        }
        
        .pill:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ Comprehensive Interactive Chat Bot Testing</h1>
        <p>Testing 40 questions across 8 business logic categories</p>
        <p><strong>Categories:</strong> Event Queries ‚Ä¢ General Queries ‚Ä¢ Equipment Recommendations ‚Ä¢ Course/Workshop Logistics ‚Ä¢ Business Information ‚Ä¢ Technical Photography Concepts ‚Ä¢ Person Queries ‚Ä¢ Technical Advice</p>
    </div>

    <div class="test-section">
        <h2>üìä Test Progress</h2>
        
        <!-- Category Filter Section -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin-top: 0; color: #495057;">üéØ Test by Category</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <button class="btn btn-success" onclick="filterByCategory('all')" id="filterAll">All Categories</button>
                <button class="btn btn-secondary" onclick="filterByCategory('Event Queries')" id="filterEvents">Event Queries</button>
                <button class="btn btn-secondary" onclick="filterByCategory('General Queries')" id="filterGeneral">General Queries</button>
                <button class="btn btn-secondary" onclick="filterByCategory('Equipment Recommendations')" id="filterEquipment">Equipment</button>
                <button class="btn btn-secondary" onclick="filterByCategory('Course/Workshop Logistics')" id="filterCourse">Course Logistics</button>
                <button class="btn btn-secondary" onclick="filterByCategory('Business Information')" id="filterBusiness">Business Info</button>
                <button class="btn btn-secondary" onclick="filterByCategory('Technical Photography Concepts')" id="filterTech">Technical Concepts</button>
                <button class="btn btn-secondary" onclick="filterByCategory('Person Queries')" id="filterPerson">Person Queries</button>
                <button class="btn btn-secondary" onclick="filterByCategory('Technical Advice')" id="filterAdvice">Technical Advice</button>
            </div>
            <div style="margin-top: 10px; font-size: 14px; color: #666;">
                <span id="filterStatus">Showing all 40 questions</span>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="currentQuestion">1</div>
                <div class="stat-label">Current Question</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalQuestions">28</div>
                <div class="stat-label">Total Questions</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedCount">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="averageScore">0</div>
                <div class="stat-label">Avg Score</div>
            </div>
        </div>
        </div>

    <div class="test-section">
        <h2>üìù Current Question</h2>
        <div id="currentQuestionCard" class="question-card current">
            <h3 id="questionText">Loading question...</h3>
            <p id="questionFocus">Loading focus...</p>
        </div>

        <div id="responseSection" class="hidden">
            <h3>ü§ñ Chat Bot Response</h3>
            <div id="responseDisplay" class="response-display">
                <div id="chatResponse" class="chat-response"></div>
        </div>

            <div class="scoring-section">
                <div class="score-input">
                    <label for="qualityScore">How good is the bot's initial answer? (0-100):</label>
                    <input type="number" id="qualityScore" min="0" max="100" placeholder="e.g., 100">
                    <small style="color: #666;">100=Perfect direct answer, 50=Partial answer, 0=Wrong/no answer</small>
                    <textarea id="qualityNotes" placeholder="Why did you score the initial answer this way?" style="margin-top: 5px; min-height: 60px;"></textarea>
                </div>
                <div class="score-input">
                    <label for="relevanceScore">How relevant are the articles/events shown? (0-100):</label>
                    <input type="number" id="relevanceScore" min="0" max="100" placeholder="e.g., 100">
                    <small style="color: #666;">100=All relevant, 50=Some relevant, 0=All irrelevant</small>
                    <textarea id="relevanceNotes" placeholder="Why did you score the related information this way?" style="margin-top: 5px; min-height: 60px;"></textarea>
                </div>
                <div class="score-input">
                    <label for="notes">Overall Notes/Issues:</label>
                    <textarea id="notes" placeholder="What issues did you find? What should be improved?"></textarea>
                </div>
                </div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="saveScore()">Save Score & Next Question</button>
                <button class="btn btn-secondary" onclick="skipQuestion()">Skip Question</button>
            </div>
        </div>

        <div id="loadingSection">
            <div class="loading">
                <p>üîÑ Loading question and getting chat bot response...</p>
            </div>
            </div>
        </div>

    <div class="test-section">
        <h2>üìä Results Summary</h2>
        <button class="btn btn-info" onclick="exportResults()">üì• Export Results</button>
        <button class="btn btn-success" onclick="copyResults()">üìã Copy Results</button>
        <button class="btn btn-warning" onclick="importResults()">üì§ Import Results</button>
        <button class="btn btn-secondary" onclick="clearResults()">üóëÔ∏è Clear All Results</button>
        <button class="btn btn-danger" onclick="clearOldData()">üîÑ Clear Old Data & Restart</button>
        
        <div id="summaryStats" style="margin-bottom: 20px;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="avgBotResponseScore">0</div>
                    <div class="stat-label">Avg Bot Response Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgRelatedScore">0</div>
                    <div class="stat-label">Avg Related Score</div>
                </div>
            </div>
            <div id="categoryBreakdown" style="margin-top: 15px;">
                <!-- Category breakdown will be populated here -->
            </div>
        </div>
        
        <div style="margin: 20px 0; text-align: right;">
            <button class="btn btn-success" onclick="copyTableResults()" style="margin-right: 10px;">
                üìã Copy Table Results
            </button>
        </div>
        
        <table class="results-table" id="resultsTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)" class="sortable">Question ‚ÜïÔ∏è</th>
                    <th onclick="sortTable(1)" class="sortable">Status ‚ÜïÔ∏è</th>
                    <th onclick="sortTable(2)" class="sortable">Bot Response Score ‚ÜïÔ∏è</th>
                    <th onclick="sortTable(3)" class="sortable">Bot Response Notes ‚ÜïÔ∏è</th>
                    <th onclick="sortTable(4)" class="sortable">Related Score ‚ÜïÔ∏è</th>
                    <th onclick="sortTable(5)" class="sortable">Related Notes ‚ÜïÔ∏è</th>
                    <th onclick="sortTable(6)" class="sortable">Other Notes ‚ÜïÔ∏è</th>
                    <th onclick="sortTable(7)" class="sortable">Category ‚ÜïÔ∏è</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
                <!-- Results will be populated here -->
            </tbody>
        </table>
        
        <!-- DEBUG PANEL - MOVED TO BOTTOM -->
        <div style="background: #f8f9fa; border: 2px solid #dc3545; border-radius: 8px; padding: 15px; margin: 20px 0;">
            <h3 style="color: #dc3545; margin-top: 0;">üîç DEBUG PANEL</h3>
            <div id="debugLog" style="background: white; border: 1px solid #ccc; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap;"></div>
            <div style="margin-top: 10px;">
                <button onclick="clearDebugLog()" style="margin-right: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px;">Clear Debug Log</button>
                <button onclick="copyDebugLog()" style="padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px;">Copy Log</button>
            </div>
        </div>
    </div>

    <script>
        // Test questions from Alan's baseline
        const testQuestions = [
            {
                category: "Event Queries",
                question: "whens the next bluebell workshops and whats the cost",
                focus: "Workshop, course, and event scheduling questions",
                expectedType: "advice"
            },
            {
                category: "Event Queries",
                question: "when is the next devon workshop",
                focus: "Workshop, course, and event scheduling questions",
                expectedType: "advice"
            },
            {
                category: "Event Queries",
                question: "what is your next workshop date and where is it",
                focus: "Workshop, course, and event scheduling questions",
                expectedType: "advice"
            },
            {
                category: "Event Queries",
                question: "when are your next Autumn workshops and where are they?",
                focus: "Workshop, course, and event scheduling questions",
                expectedType: "advice"
            },
            {
                category: "Event Queries",
                question: "How long are your workshops?",
                focus: "Workshop, course, and event scheduling questions",
                expectedType: "advice"
            },
            {
                category: "General Queries",
                question: "How much is a residential photography course and does it include B&B",
                focus: "Miscellaneous questions",
                expectedType: "advice"
            },
            {
                category: "General Queries",
                question: "Do you do astrophotography workshops",
                focus: "Miscellaneous questions",
                expectedType: "advice"
            },
            {
                category: "General Queries",
                question: "Can my 14yr old attend your workshop",
                focus: "Miscellaneous questions",
                expectedType: "advice"
            },
            {
                category: "General Queries",
                question: "My pictures never seem sharp.  Can you advise on what I am doing wrong",
                focus: "Miscellaneous questions",
                expectedType: "advice"
            },
            {
                category: "General Queries",
                question: "What types of photography services do you offer?",
                focus: "Miscellaneous questions",
                expectedType: "advice"
            },
            {
                category: "Equipment Recommendations",
                question: "What tripod do you recommend",
                focus: "Equipment advice and recommendations",
                expectedType: "advice"
            },
            {
                category: "Equipment Recommendations",
                question: "What sort of camera do I need for your camera course",
                focus: "Equipment advice and recommendations",
                expectedType: "advice"
            },
            {
                category: "Equipment Recommendations",
                question: "What gear or equipment do I need to bring to a workshop?",
                focus: "Equipment advice and recommendations",
                expectedType: "advice"
            },
            {
                category: "Equipment Recommendations",
                question: "What is the difference between prime and zoom lenses?",
                focus: "Equipment advice and recommendations",
                expectedType: "advice"
            },
            {
                category: "Equipment Recommendations",
                question: "What memory card should I buy?",
                focus: "Equipment advice and recommendations",
                expectedType: "advice"
            },
            {
                category: "Course/Workshop Logistics",
                question: "Do you I get a certificate with the photography course",
                focus: "Course details, requirements, and logistics",
                expectedType: "advice"
            },
            {
                category: "Course/Workshop Logistics",
                question: "Do I need a laptop for the lightroom course",
                focus: "Course details, requirements, and logistics",
                expectedType: "advice"
            },
            {
                category: "Course/Workshop Logistics",
                question: "Is the online photography course really free",
                focus: "Course details, requirements, and logistics",
                expectedType: "advice"
            },
            {
                category: "Course/Workshop Logistics",
                question: "What courses do you offer for complete beginners?",
                focus: "Course details, requirements, and logistics",
                expectedType: "advice"
            },
            {
                category: "Course/Workshop Logistics",
                question: "How many weeks is the beginners' photography course?",
                focus: "Course details, requirements, and logistics",
                expectedType: "advice"
            },
            {
                category: "Business Information",
                question: "How do I get personalised feedback on my images",
                focus: "Services, policies, contact, and business details",
                expectedType: "advice"
            },
            {
                category: "Business Information",
                question: "How can I contact you or book a discovery call?",
                focus: "Services, policies, contact, and business details",
                expectedType: "advice"
            },
            {
                category: "Business Information",
                question: "Do you offer gift vouchers?",
                focus: "Services, policies, contact, and business details",
                expectedType: "advice"
            },
            {
                category: "Business Information",
                question: "What is your cancellation or refund policy for courses/workshops?",
                focus: "Services, policies, contact, and business details",
                expectedType: "advice"
            },
            {
                category: "Business Information",
                question: "Where is your gallery and can I submit my images for feedback?",
                focus: "Services, policies, contact, and business details",
                expectedType: "advice"
            },
            {
                category: "Technical Photography Concepts",
                question: "What is long exposure and how can I find out more about it",
                focus: "Fundamental photography concepts and definitions",
                expectedType: "advice"
            },
            {
                category: "Technical Photography Concepts",
                question: "\"What is the exposure triangle (aperture, shutter, ISO)?\"",
                focus: "Fundamental photography concepts and definitions",
                expectedType: "advice"
            },
            {
                category: "Technical Photography Concepts",
                question: "\"What is depth of field, and how do I control it?\"",
                focus: "Fundamental photography concepts and definitions",
                expectedType: "advice"
            },
            {
                category: "Technical Photography Concepts",
                question: "What is white balance and how do I use it?",
                focus: "Fundamental photography concepts and definitions",
                expectedType: "advice"
            },
            {
                category: "Technical Photography Concepts",
                question: "What is HDR photography?",
                focus: "Fundamental photography concepts and definitions",
                expectedType: "advice"
            },
            {
                category: "Person Queries",
                question: "Who is Alan Ranger and what is his photographic background?",
                focus: "Questions about specific people",
                expectedType: "advice"
            },
            {
                category: "Person Queries",
                question: "Where is Alan Ranger based?",
                focus: "Questions about specific people",
                expectedType: "advice"
            },
            {
                category: "Person Queries",
                question: "Can I hire you as a professional photographer in Coventry?",
                focus: "Questions about specific people",
                expectedType: "advice"
            },
            {
                category: "Person Queries",
                question: "peter orton",
                focus: "Questions about specific people",
                expectedType: "advice"
            },
            {
                category: "Person Queries",
                question: "who is alan ranger",
                focus: "Questions about specific people",
                expectedType: "advice"
            },
            {
                category: "Technical Advice",
                question: "How do I subscribe to the free online photography course?",
                focus: "How-to and troubleshooting photography advice",
                expectedType: "advice"
            },
            {
                category: "Technical Advice",
                question: "How do I improve my composition and storytelling in photos?",
                focus: "How-to and troubleshooting photography advice",
                expectedType: "advice"
            },
            {
                category: "Technical Advice",
                question: "How do I use flash photography?",
                focus: "How-to and troubleshooting photography advice",
                expectedType: "advice"
            },
            {
                category: "Technical Advice",
                question: "How do I edit RAW files?",
                focus: "How-to and troubleshooting photography advice",
                expectedType: "advice"
            },
            {
                category: "Technical Advice",
                question: "How do I improve my photography skills?",
                focus: "How-to and troubleshooting photography advice",
                expectedType: "advice"
            }
        ];

        let currentQuestionIndex = 0;
        let testResults = [];
        let isTestRunning = false;
        let savedScores = {};
        let currentFilter = 'all';
        let filteredQuestions = [];
        // Control whether historical baseline scores are auto-merged on load
        const INCLUDE_BASELINE_SCORES = false;

        // Debug logging functions
        function addDebugLog(message) {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            debugLog.textContent += `[${timestamp}] ${message}\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        function clearDebugLog() {
            document.getElementById('debugLog').textContent = '';
        }
        
        function copyDebugLog() {
            const debugLog = document.getElementById('debugLog');
            const logText = debugLog.textContent;
            
            if (navigator.clipboard && window.isSecureContext) {
                // Use modern clipboard API
                navigator.clipboard.writeText(logText).then(() => {
                    addDebugLog('‚úÖ Debug log copied to clipboard');
                }).catch(err => {
                    addDebugLog('‚ùå Failed to copy to clipboard: ' + err);
                    fallbackCopyTextToClipboard(logText);
                });
            } else {
                // Fallback for older browsers
                fallbackCopyTextToClipboard(logText);
            }
        }
        
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    addDebugLog('‚úÖ Debug log copied to clipboard (fallback method)');
                } else {
                    addDebugLog('‚ùå Failed to copy debug log');
                }
            } catch (err) {
                addDebugLog('‚ùå Failed to copy debug log: ' + err);
            }
            
            document.body.removeChild(textArea);
        }

        // Initialize the test
        function initTest() {
            addDebugLog('üîç DEBUG: initTest() called');
            loadSavedScores();
            if (INCLUDE_BASELINE_SCORES) {
                addDebugLog('üîç DEBUG: Merging baseline scores (flag enabled)');
                loadBaselineScores();
            } else {
                addDebugLog('üîç DEBUG: Skipping baseline score merge (flag disabled)');
            }
            applyFilter('all'); // Start with all questions
            loadQuestion(0);
        }

        // Filter questions by category
        function filterByCategory(category) {
            applyFilter(category);
            updateFilterButtons(category);
            loadQuestion(0); // Reset to first question in filtered set
        }

        // Apply category filter
        function applyFilter(category) {
            currentFilter = category;
            
            if (category === 'all') {
                filteredQuestions = testQuestions;
            } else {
                filteredQuestions = testQuestions.filter(q => q.category === category);
            }
            
            // Update UI
            document.getElementById('totalQuestions').textContent = filteredQuestions.length;
            document.getElementById('filterStatus').textContent = 
                category === 'all' ? `Showing all ${filteredQuestions.length} questions` : 
                `Showing ${filteredQuestions.length} questions in "${category}"`;
            
            // Update progress
            updateProgress();
            
            // Update questions list display
            
            // CRITICAL: Update all UI components after filtering
            updateStats();
            updateResultsTable();
            updateSummaryStats();
        }

        // Update filter button states
        function updateFilterButtons(activeCategory) {
            // Reset all buttons to secondary
            document.querySelectorAll('[id^="filter"]').forEach(btn => {
                btn.className = 'btn btn-secondary';
            });
            
            // Set active button to success
            const activeButton = document.getElementById(`filter${activeCategory === 'all' ? 'All' : 
                activeCategory === 'Technical Photography Concepts' ? 'Tech' :
                activeCategory === 'Equipment Recommendations' ? 'Equipment' :
                activeCategory === 'Person Queries' ? 'Person' :
                activeCategory === 'Event Queries' ? 'Events' :
                activeCategory === 'Technical Advice' ? 'Advice' :
                activeCategory === 'Course/Workshop Logistics' ? 'Course' :
                activeCategory === 'Business Information' ? 'Business' : 'All'}`);
            
            if (activeButton) {
                activeButton.className = 'btn btn-success';
            }
        }

        // Update progress bar based on filtered questions
        function updateProgress() {
            const completed = testResults.filter(r => 
                filteredQuestions.some(q => q.question === r.question)
            ).length;
            const progress = filteredQuestions.length > 0 ? (completed / filteredQuestions.length) * 100 : 0;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // Load baseline scores from Alan's manual testing
        function loadBaselineScores() {
            const baselineScores = {
                "what is exposure triangle": {
                    "confidenceScore": 85,
                    "qualityScore": 100,
                    "verdict": "perfect",
                    "notes": "should have higher confidence - gave a good right answer and show perfectly matched article tiles",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "what is iso": {
                    "confidenceScore": 70,
                    "qualityScore": 75,
                    "verdict": "very good",
                    "notes": "didn't answer the question it referenced the article but did show relevant articles in article block",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "what is aperture": {
                    "confidenceScore": 70,
                    "qualityScore": 10,
                    "verdict": "very poor",
                    "notes": "didn't even attempt to answer question and no related articles section",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "what is shutter speed": {
                    "confidenceScore": 70,
                    "qualityScore": 50,
                    "verdict": "good",
                    "notes": "didn't answer the question showed one correct article but the pdf field checklist was from wrong blog and topic",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "what tripod do you recommend": {
                    "confidenceScore": 85,
                    "qualityScore": 95,
                    "verdict": "nearly perfect",
                    "notes": "should have higher confidence - gave a good right answer and show perfectly matched article tiles",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "what camera should I buy": {
                    "confidenceScore": 70,
                    "qualityScore": 50,
                    "verdict": "good",
                    "notes": "initial response good but related article tiles not great and there were better ones available not showing",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "what camera do you recommend for a beginner": {
                    "confidenceScore": 70,
                    "qualityScore": 50,
                    "verdict": "good",
                    "notes": "initial response good but related article tiles not great and there were better ones available not showing",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "peter orton": {
                    "confidenceScore": 70,
                    "qualityScore": 75,
                    "verdict": "very good",
                    "notes": "good but could have shown more related articles for other case studies too",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "who is alan ranger": {
                    "confidenceScore": 70,
                    "qualityScore": 75,
                    "verdict": "very good",
                    "notes": "good initial response but shouldn't have shown related articles, should shown orange pill linked to about-alan page",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "when is your next devon workshop": {
                    "confidenceScore": 95,
                    "qualityScore": 95,
                    "verdict": "nearly perfect",
                    "notes": "no changes required",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "when is your next photography course": {
                    "confidenceScore": 95,
                    "qualityScore": 30,
                    "verdict": "poor",
                    "notes": "it lists workshops not courses in the events block",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "when are your next bluebell workshops": {
                    "confidenceScore": 95,
                    "qualityScore": 100,
                    "verdict": "perfect",
                    "notes": "no changes required",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "do you have autumn workshops": {
                    "confidenceScore": 95,
                    "qualityScore": 50,
                    "verdict": "good",
                    "notes": "missing some events for autumn like peak district but need to check if they contain enough clues to be classified as autumn",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "how to take sharp photos": {
                    "confidenceScore": 70,
                    "qualityScore": 50,
                    "verdict": "good",
                    "notes": "initial response good but related article tiles not great and there were better ones available not showing",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "what is long exposure photography": {
                    "confidenceScore": 70,
                    "qualityScore": 75,
                    "verdict": "very good",
                    "notes": "didn't answer the question it referenced the article but did show relevant articles in article block",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "why are my images always grainy and noisy": {
                    "confidenceScore": 70,
                    "qualityScore": 10,
                    "verdict": "very poor",
                    "notes": "wrong initial response that isn't related and two related articles not related at all - should have found answers on ISO",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "why arent my images sharp": {
                    "confidenceScore": 70,
                    "qualityScore": 50,
                    "verdict": "good",
                    "notes": "initial response good but related article tiles showing two unrelated articles rather than better ones",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "do I need a laptop for lightroom course": {
                    "confidenceScore": 95,
                    "qualityScore": 75,
                    "verdict": "very good",
                    "notes": "initial response not good as didn't answer question but course tiles correct and they answer the question",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "do you provide photography courses": {
                    "confidenceScore": 0.2,
                    "qualityScore": 10,
                    "verdict": "very poor",
                    "notes": "confidence pill says 0.2% then classification options > go to wrong events these are not the classification options we agreed and had working before",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "do you have online lessons": {
                    "confidenceScore": 70,
                    "qualityScore": 30,
                    "verdict": "poor",
                    "notes": "initial response weak and links/pills to the landing pages or article tiles",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "do you have a lightroom course": {
                    "confidenceScore": 95,
                    "qualityScore": 75,
                    "verdict": "very good",
                    "notes": "listed right events but could also have responded initially with a better answer",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "whats your online photography course": {
                    "confidenceScore": 0.2,
                    "qualityScore": 10,
                    "verdict": "very poor",
                    "notes": "confidence pill says 0.2% then classification options > go to wrong events these are not the classification options we agreed and had working before",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "where i can see your terms and conditions": {
                    "confidenceScore": 70,
                    "qualityScore": 95,
                    "verdict": "nearly perfect",
                    "notes": "no changes required",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "tell me about rps mentoring": {
                    "confidenceScore": 70,
                    "qualityScore": 75,
                    "verdict": "very good",
                    "notes": "perfect initial response and did show one relevant article and one not relevant and could have easily found articles with rps",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "do you do commercial photography": {
                    "confidenceScore": 70,
                    "qualityScore": 10,
                    "verdict": "very poor",
                    "notes": "Initial response had nothing to do with question, related articles were not about the question",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "do you do portrait photography": {
                    "confidenceScore": 70,
                    "qualityScore": 10,
                    "verdict": "very poor",
                    "notes": "Initial response had nothing to do with question, related articles were not about the question",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "is your photography academy really free": {
                    "confidenceScore": 70,
                    "qualityScore": 10,
                    "verdict": "very poor",
                    "notes": "Initial response had nothing to do with question, related articles were not about the question",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                },
                "what camera do i need for your courses and workshops": {
                    "confidenceScore": 95,
                    "qualityScore": 10,
                    "verdict": "very poor",
                    "notes": "Initial response had nothing to do with question, related articles were not about the question",
                    "timestamp": "2025-10-23T00:00:00.000Z"
                }
            };

            // Merge baseline scores (only if not already saved)
            Object.keys(baselineScores).forEach(question => {
                if (!savedScores[question]) {
                    savedScores[question] = baselineScores[question];
                }
            });
            
            // Save updated scores
            saveScoresToStorage();
        }

        // Load saved scores from localStorage
        function loadSavedScores() {
            const saved = localStorage.getItem('interactiveTestScores');
            if (saved) {
                savedScores = JSON.parse(saved);
            }
        }

        // Save scores to localStorage
        function saveScoresToStorage() {
            localStorage.setItem('interactiveTestScores', JSON.stringify(savedScores));
        }

        // Render chat response in proper format
        function renderChatResponse(data) {
            const chatResponse = document.getElementById('chatResponse');
            chatResponse.innerHTML = '';
            
            // Main answer bubble
            if (data.answer_markdown || data.answer) {
                const answerDiv = document.createElement('div');
                answerDiv.className = 'chat-bubble';
                
                let answerText = data.answer_markdown || data.answer;
                // Fix common UTF-8 misinterpretations seen as Windows-1252 artifacts
                if (typeof answerText === 'string') {
                    answerText = answerText
                        .replace(/√¢‚Ç¨¬¢/g, '‚Ä¢')
                        .replace(/√¢‚Ç¨‚Äú/g, '‚Äì')
                        .replace(/√¢‚Ç¨‚Äù/g, '‚Äî')
                        .replace(/√¢‚Ç¨‚Ñ¢/g, '‚Äô')
                        .replace(/√¢‚Ç¨≈ì/g, '‚Äú')
                        .replace(/√¢‚Ç¨¬ù/g, '‚Äù');
                }
                if (typeof answerText === 'string') {
                    // Convert markdown to HTML
                    answerText = answerText
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/\n/g, '<br>');
                }
                
                answerDiv.innerHTML = `<p>${answerText}</p>`;
                chatResponse.appendChild(answerDiv);
            }
            
            // Bot's confidence score - make it prominent
            if (data.confidence) {
                const confidencePill = document.createElement('div');
                confidencePill.className = 'confidence-pill';
                confidencePill.style.cssText = 'background: #ff9800; color: white; padding: 8px 16px; border-radius: 20px; font-size: 16px; font-weight: bold; margin: 10px 0; display: inline-block;';
                confidencePill.textContent = `ü§ñ Bot's Confidence: ${Math.round(data.confidence * 100)}%`;
                chatResponse.appendChild(confidencePill);
            }
            
            // Events block
            if (data.structured && data.structured.events && data.structured.events.length > 0) {
                const eventsBlock = document.createElement('div');
                eventsBlock.className = 'events-block';
                eventsBlock.innerHTML = '<h4>üìÖ Events</h4>';
                
                data.structured.events.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'event-item';
                    eventDiv.innerHTML = `
                        <div class="event-title">${event.title || event.event_title || 'Event'}</div>
                        <div class="event-details">
                            ${event.date_start ? `Date: ${event.date_start}` : ''}
                            ${event.location ? ` | Location: ${event.location}` : ''}
                            ${event.price ? ` | Price: ${event.price}` : ''}
                </div>
            `;
                    eventsBlock.appendChild(eventDiv);
                });
                
                chatResponse.appendChild(eventsBlock);
            }
            
            // Articles block
            if (data.structured && data.structured.articles && data.structured.articles.length > 0) {
                const articlesBlock = document.createElement('div');
                articlesBlock.className = 'articles-block';
                articlesBlock.innerHTML = '<h4>üìö Related Articles</h4>';
                
                data.structured.articles.forEach(article => {
                    const articleDiv = document.createElement('div');
                    articleDiv.className = 'article-item';
                    articleDiv.innerHTML = `
                        <div class="article-title">${article.title || 'Article'}</div>
                        <div class="article-details">
                            ${article.display_date ? `Published: ${article.display_date}` : ''}
                            ${article.page_url ? ` | <a href="${article.page_url}" target="_blank">Read Article</a>` : ''}
                </div>
            `;
                    articlesBlock.appendChild(articleDiv);
                });
                
                chatResponse.appendChild(articlesBlock);
            }
            
            // Pills/action buttons
            if (data.structured && data.structured.pills && data.structured.pills.length > 0) {
                const pillsBlock = document.createElement('div');
                pillsBlock.className = 'pills-block';
                
                data.structured.pills.forEach(pill => {
                    const pillLink = document.createElement('a');
                    pillLink.className = 'pill';
                    pillLink.href = pill.url || pill.href || '#';
                    pillLink.textContent = pill.label || pill.text || 'Action';
                    pillLink.target = '_blank';
                    pillsBlock.appendChild(pillLink);
                });
                
                chatResponse.appendChild(pillsBlock);
            }
            
            // Debug info (collapsible)
            if (data.debug) {
                const debugDiv = document.createElement('details');
                debugDiv.innerHTML = `
                    <summary>üîç Debug Info</summary>
                    <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 12px; overflow-x: auto;">${JSON.stringify(data.debug, null, 2)}</pre>
                `;
                chatResponse.appendChild(debugDiv);
            }
        }

        // Load a specific question
        async function loadQuestion(index) {
            if (index >= filteredQuestions.length) {
                alert(`All ${currentFilter === 'all' ? '' : currentFilter + ' '}questions completed!`);
                return;
            }

            currentQuestionIndex = index;
            const question = filteredQuestions[index];
            
            // Update UI
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('questionFocus').textContent = question.focus;
            document.getElementById('currentQuestion').textContent = index + 1;
            
            // Update progress
            const progress = ((index + 1) / filteredQuestions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // Update current question card
            document.querySelectorAll('.question-card').forEach(card => card.classList.remove('current'));
            const currentCard = document.getElementById(`question-${index}`);
            if (currentCard) {
                currentCard.classList.add('current');
            }
            
            // Show loading with better user feedback
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('responseSection').classList.add('hidden');
            
            // Update loading text to show progress
            const loadingText = document.querySelector('#loadingSection p');
            if (loadingText) {
                loadingText.textContent = `üîÑ Loading question ${index + 1} of ${filteredQuestions.length} and getting chat bot response...`;
            }
            
            // Load previous scores if available
            const questionKey = question.question;
            const previousScore = savedScores[questionKey];
            
            if (previousScore) {
                document.getElementById('qualityScore').value = previousScore.qualityScore || '';
                document.getElementById('relevanceScore').value = previousScore.relevanceScore || '';
                document.getElementById('notes').value = previousScore.notes || '';
                document.getElementById('qualityNotes').value = previousScore.qualityNotes || '';
                document.getElementById('relevanceNotes').value = previousScore.relevanceNotes || '';
            } else {
                document.getElementById('qualityScore').value = '';
                document.getElementById('relevanceScore').value = '';
                document.getElementById('notes').value = '';
                document.getElementById('qualityNotes').value = '';
                document.getElementById('relevanceNotes').value = '';
            }
            
            try {
                // Get response from chat bot
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: question.question,
                        sessionId: 'interactive-test-session'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Display response in chat format
                renderChatResponse(data);
                
                // Hide loading, show response section
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('responseSection').classList.remove('hidden');
                
            } catch (error) {
                document.getElementById('responseDisplay').textContent = `Error: ${error.message}`;
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('responseSection').classList.remove('hidden');
            }
        }

        // Save score and move to next question
        function saveScore() {
            addDebugLog('üîç DEBUG: saveScore() called');
            addDebugLog(`üîç DEBUG: currentQuestionIndex = ${currentQuestionIndex}`);
            addDebugLog(`üîç DEBUG: filteredQuestions.length = ${filteredQuestions.length}`);
            
            const qualityScore = parseInt(document.getElementById('qualityScore').value);
            const relevanceScore = parseInt(document.getElementById('relevanceScore').value);
            const notes = document.getElementById('notes').value;
            const qualityNotes = document.getElementById('qualityNotes').value;
            const relevanceNotes = document.getElementById('relevanceNotes').value;
            
            addDebugLog(`üîç DEBUG: Scores - Quality: ${qualityScore}, Relevance: ${relevanceScore}`);
            
            // Check if scores are valid numbers between 0-100
            if (isNaN(qualityScore) || qualityScore < 0 || qualityScore > 100) {
                alert('Please enter a valid quality score (0-100)');
                return;
            }
            
            if (isNaN(relevanceScore) || relevanceScore < 0 || relevanceScore > 100) {
                alert('Please enter a valid relevance score (0-100)');
                return;
            }

            const result = {
                questionIndex: currentQuestionIndex,
                question: filteredQuestions[currentQuestionIndex].question,
                category: filteredQuestions[currentQuestionIndex].category,
                focus: filteredQuestions[currentQuestionIndex].focus,
                qualityScore: qualityScore,
                relevanceScore: relevanceScore,
                notes: notes,
                qualityNotes: qualityNotes,
                relevanceNotes: relevanceNotes,
                timestamp: new Date().toISOString()
            };

            addDebugLog(`üîç DEBUG: Created result object: ${JSON.stringify(result, null, 2)}`);
            addDebugLog(`üîç DEBUG: testResults before push: ${testResults.length}`);
            
            testResults.push(result);
            
            addDebugLog(`üîç DEBUG: testResults after push: ${testResults.length}`);
            addDebugLog(`üîç DEBUG: testResults contents: ${JSON.stringify(testResults, null, 2)}`);
            
            // Save to localStorage
            savedScores[filteredQuestions[currentQuestionIndex].question] = {
                qualityScore: qualityScore,
                relevanceScore: relevanceScore,
                notes: notes,
                qualityNotes: qualityNotes,
                relevanceNotes: relevanceNotes,
                timestamp: new Date().toISOString()
            };
            saveScoresToStorage();
            
            // Update question card
            const questionCard = document.getElementById(`question-${currentQuestionIndex}`);
            if (questionCard) {
                questionCard.classList.remove('current');
                questionCard.classList.add('completed');
                
                const statusBadge = questionCard.querySelector('.status-badge');
                if (statusBadge) {
                    const isPass = qualityScore >= 70 && relevanceScore >= 70;
                    statusBadge.textContent = isPass ? 'Pass' : 'Fail';
                    statusBadge.className = `status-badge ${isPass ? 'status-pass' : 'status-fail'}`;
                }
            }
            
            // Update stats immediately (lightweight)
            addDebugLog('üîç DEBUG: About to call updateStats()');
            updateStats();
            
            // Defer heavy operations to prevent UI blocking
            setTimeout(() => {
                addDebugLog('üîç DEBUG: About to call updateResultsTable()');
                updateResultsTable();
            }, 0);
            
            setTimeout(() => {
                addDebugLog('üîç DEBUG: About to call updateSummaryStats()');
                updateSummaryStats(); // Force update of ALL masonry blocks
                addDebugLog('üîç DEBUG: All update functions called');
            }, 0);
            
            // Move to next question (or show completion message)
            if (currentQuestionIndex + 1 >= filteredQuestions.length) {
                // All questions in current filter completed
                addDebugLog('üîç DEBUG: All questions completed in current filter');
                alert(`All ${currentFilter === 'all' ? '' : currentFilter + ' '}questions completed!`);
                // Stay on current question to show the completed state
            } else {
                addDebugLog(`üîç DEBUG: Moving to next question: ${currentQuestionIndex + 1}`);
                // Defer loading next question to prevent blocking
                setTimeout(() => {
                    loadQuestion(currentQuestionIndex + 1);
                }, 100);
            }
        }

        // Skip current question
        function skipQuestion() {
            loadQuestion(currentQuestionIndex + 1);
        }

        // Update statistics
        function updateStats() {
            // Count completed questions from both testResults and savedScores
            const completedFromTestResults = testResults.filter(r => 
                filteredQuestions.some(q => q.question === r.question)
            ).length;
            
            const completedFromSavedScores = filteredQuestions.filter(q => 
                savedScores[q.question] !== undefined
            ).length;
            
            // Use the higher count (in case there's overlap)
            const completed = Math.max(completedFromTestResults, completedFromSavedScores);
            const total = filteredQuestions.length;
            
            document.getElementById('completedCount').textContent = completed;
            
            if (completed > 0) {
                // Calculate average from both sources
                const filteredResults = testResults.filter(r => 
                    filteredQuestions.some(q => q.question === r.question)
                );
                
                const filteredSavedScores = filteredQuestions
                    .filter(q => savedScores[q.question] !== undefined)
                    .map(q => {
                        const savedScore = savedScores[q.question];
                        return {
                            qualityScore: savedScore.qualityScore !== undefined ? savedScore.qualityScore : 
                                       (savedScore.confidenceScore !== undefined ? savedScore.confidenceScore : 0)
                        };
                    });
                
                const allFilteredResults = [...filteredResults, ...filteredSavedScores];
                const avgScore = allFilteredResults.reduce((sum, r) => sum + r.qualityScore, 0) / allFilteredResults.length;
                document.getElementById('averageScore').textContent = Math.round(avgScore);
            } else {
                document.getElementById('averageScore').textContent = '0';
            }
            
            // Update progress
            updateProgress();
        }

        // Update summary statistics and category breakdown
        function updateSummaryStats() {
            addDebugLog('üîç DEBUG: updateSummaryStats() called');
            addDebugLog(`üîç DEBUG: testResults.length = ${testResults.length}`);
            addDebugLog(`üîç DEBUG: savedScores keys = ${Object.keys(savedScores).join(', ')}`);
            addDebugLog(`üîç DEBUG: currentFilter = ${currentFilter}`);
            
            // Build allResults with deduplication - each question should only appear once with the most recent result
            const allResults = [];
            const questionMap = new Map(); // Use Map to track most recent result per question
            
            // First, add all testResults (current session)
            testResults.forEach(result => {
                questionMap.set(result.question, result);
            });
            
            // Then, add savedScores only if not already in testResults (or if older)
            Object.keys(savedScores).forEach(question => {
                const savedScore = savedScores[question];
                const existingResult = questionMap.get(question);
                
                if (!existingResult) {
                    // No current result, add saved score
                    const questionData = testQuestions.find(q => q.question === question);
                    
                    // Handle both old format (confidenceScore, verdict) and new format (qualityScore, relevanceScore)
                    const qualityScore = savedScore.qualityScore !== undefined ? savedScore.qualityScore : 
                                       (savedScore.confidenceScore !== undefined ? savedScore.confidenceScore : 0);
                    const relevanceScore = savedScore.relevanceScore !== undefined ? savedScore.relevanceScore : 0;
                    const notes = savedScore.notes || '';
                    const qualityNotes = savedScore.qualityNotes || '';
                    const relevanceNotes = savedScore.relevanceNotes || '';
                    
                    questionMap.set(question, {
                        question: question,
                        qualityScore: qualityScore,
                        relevanceScore: relevanceScore,
                        notes: notes,
                        qualityNotes: qualityNotes,
                        relevanceNotes: relevanceNotes,
                        timestamp: savedScore.timestamp,
                        category: questionData?.category || 'Unknown',
                        focus: questionData?.focus || ''
                    });
                } else {
                    // Always keep the existing result from testResults (current session)
                    // This ensures imported CSV data takes priority over cached localStorage data
                    addDebugLog(`üîç DEBUG: Keeping existing result from testResults for question: ${question}`);
                }
            });
            
            // Convert Map to array
            allResults.push(...questionMap.values());
            
            addDebugLog(`üîç DEBUG: allResults final length = ${allResults.length}`);
            
            if (allResults.length === 0) {
                addDebugLog('üîç DEBUG: No results found, creating empty masonry tiles');
                // Still create masonry tiles even with no data - they'll show zeros
            }
            
            // Always show ALL categories in masonry, but calculate averages based on current filter
            const relevantResults = currentFilter === 'all' ? allResults : 
                allResults.filter(r => r.category === currentFilter);
            
            // Calculate averages for current filter
            if (relevantResults.length > 0) {
                const avgBotResponseScore = relevantResults.reduce((sum, r) => sum + r.qualityScore, 0) / relevantResults.length;
                const avgRelatedScore = relevantResults.reduce((sum, r) => sum + (r.relevanceScore !== undefined ? r.relevanceScore : 0), 0) / relevantResults.length;
                
                document.getElementById('avgBotResponseScore').textContent = Math.round(avgBotResponseScore);
                document.getElementById('avgRelatedScore').textContent = Math.round(avgRelatedScore);
            }
            
            // Calculate category breakdown for ALL categories (not just filtered)
            const categoryStats = {};
            
            // Initialize all categories with empty stats
            const allCategories = [...new Set(testQuestions.map(q => q.category))];
            allCategories.forEach(category => {
                categoryStats[category] = {
                    count: 0,
                    botResponseSum: 0,
                    relatedSum: 0,
                    passCount: 0,
                    failCount: 0
                };
            });
            
            // Populate stats from actual results
            allResults.forEach(result => {
                const category = result.category;
                if (categoryStats[category]) {
                    categoryStats[category].count++;
                    categoryStats[category].botResponseSum += result.qualityScore;
                    categoryStats[category].relatedSum += (result.relevanceScore !== undefined ? result.relevanceScore : 0);
                    
                // Count pass/fail for this category - BOTH scores must be >= 70 to pass
                const isPass = result.qualityScore >= 70 && result.relevanceScore >= 70;
                if (isPass) {
                    categoryStats[category].passCount++;
                } else {
                    categoryStats[category].failCount++;
                }
                }
            });
            
            addDebugLog(`üîç DEBUG: Category stats calculated: ${JSON.stringify(categoryStats, null, 2)}`);
            
            // Display category breakdown with masonry tiles
            const breakdownDiv = document.getElementById('categoryBreakdown');
            breakdownDiv.innerHTML = '<h4>üìä Performance by Category</h4>';
            
            // Create masonry container
            const masonryContainer = document.createElement('div');
            masonryContainer.className = 'masonry-container';
            masonryContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 15px;';
            
            Object.keys(categoryStats).forEach(category => {
                const stats = categoryStats[category];
                const avgBotResponse = Math.round(stats.botResponseSum / stats.count);
                const avgRelated = Math.round(stats.relatedSum / stats.count);
                
                // Use the pre-calculated pass/fail counts
                const passCount = stats.passCount;
                const failCount = stats.failCount;
                
                // Reduced debug logging for performance
                
                // Determine overall status color
                let statusColor, statusText, statusIcon;
                if (avgBotResponse >= 70 && avgRelated >= 50) {
                    statusColor = '#28a745'; // Green
                    statusText = 'Good';
                    statusIcon = '‚úÖ';
                } else if (avgBotResponse >= 40 || avgRelated >= 30) {
                    statusColor = '#ffc107'; // Amber
                    statusText = 'Needs Work';
                    statusIcon = '‚ö†Ô∏è';
                } else {
                    statusColor = '#dc3545'; // Red
                    statusText = 'Critical';
                    statusIcon = '‚ùå';
                }
                
                const categoryTile = document.createElement('div');
                categoryTile.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 20px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    border-left: 4px solid ${statusColor};
                    transition: transform 0.2s ease, box-shadow 0.2s ease;
                `;
                
                categoryTile.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; font-size: 16px; color: #333;">${category}</h3>
                        <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                            ${statusIcon} ${statusText}
                        </span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #007bff;">${avgBotResponse}</div>
                            <div style="font-size: 12px; color: #666; text-transform: uppercase;">Bot Response Avg</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #28a745;">${avgRelated}</div>
                            <div style="font-size: 12px; color: #666; text-transform: uppercase;">Related Avg</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding-top: 10px; border-top: 1px solid #eee;">
                        <div style="font-size: 14px; color: #333; margin-bottom: 5px;">
                            <span style="color: #28a745; font-weight: 600;">${passCount}</span> / 
                            <span style="color: #dc3545; font-weight: 600;">${failCount}</span>
                        </div>
                        <div style="font-size: 12px; color: #666;">Pass / Fail</div>
                    </div>
                `;
                
                // Add hover effect
                categoryTile.addEventListener('mouseenter', () => {
                    categoryTile.style.transform = 'translateY(-2px)';
                    categoryTile.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                });
                
                categoryTile.addEventListener('mouseleave', () => {
                    categoryTile.style.transform = 'translateY(0)';
                    categoryTile.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                });
                
                masonryContainer.appendChild(categoryTile);
            });
            
            breakdownDiv.appendChild(masonryContainer);
            
            // Add overall summary masonry tile
            const totalQuestions = allResults.length;
            const totalPass = allResults.filter(r => r.qualityScore >= 70 && r.relevanceScore >= 70).length;
            const totalFail = totalQuestions - totalPass;
            const overallAvgBotResponse = allResults.length > 0 ? Math.round(allResults.reduce((sum, r) => sum + r.qualityScore, 0) / allResults.length) : 0;
            const overallAvgRelated = allResults.length > 0 ? Math.round(allResults.reduce((sum, r) => sum + (r.relevanceScore !== undefined ? r.relevanceScore : 0), 0) / allResults.length) : 0;
            
            addDebugLog(`üîç DEBUG: Overall totals - questions: ${totalQuestions}, pass: ${totalPass}, fail: ${totalFail}`);
            
            // Create overall summary tile (same format as other tiles)
            const overallTile = document.createElement('div');
            overallTile.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                border-left: 4px solid #4c63d2;
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            `;
            
            overallTile.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 16px; color: #333;">üìä Overall Summary</h3>
                    <span style="background: #4c63d2; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                        ${totalQuestions} Total
                    </span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #007bff;">${overallAvgBotResponse}</div>
                        <div style="font-size: 12px; color: #666; text-transform: uppercase;">Overall Bot Response Avg</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;">${overallAvgRelated}</div>
                        <div style="font-size: 12px; color: #666; text-transform: uppercase;">Overall Related Avg</div>
                    </div>
                </div>
                
                <div style="text-align: center; padding-top: 10px; border-top: 1px solid #eee;">
                    <div style="font-size: 14px; color: #333; margin-bottom: 5px;">
                        <span style="color: #28a745; font-weight: 600;">${totalPass}</span> / 
                        <span style="color: #dc3545; font-weight: 600;">${totalFail}</span>
                    </div>
                    <div style="font-size: 12px; color: #666;">Overall Pass / Fail</div>
                </div>
            `;
            
            // Add hover effect (same as other tiles)
            overallTile.addEventListener('mouseenter', () => {
                overallTile.style.transform = 'translateY(-2px)';
                overallTile.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
            });
            
            overallTile.addEventListener('mouseleave', () => {
                overallTile.style.transform = 'translateY(0)';
                overallTile.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
            });
            
            masonryContainer.appendChild(overallTile);
        }

        // Update results table
        function updateResultsTable() {
            addDebugLog('üîç DEBUG: updateResultsTable() called');
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            // Build allResults with deduplication - same logic as updateSummaryStats
            const allResults = [];
            const questionMap = new Map();
            
            // First, add all testResults (current session)
            testResults.forEach(result => {
                questionMap.set(result.question, result);
            });
            
            // Then, add savedScores only if not already in testResults (or if older)
            Object.keys(savedScores).forEach(question => {
                const savedScore = savedScores[question];
                const existingResult = questionMap.get(question);
                
                if (!existingResult) {
                    // No current result, add saved score
                    const questionData = testQuestions.find(q => q.question === question);
                    
                    const qualityScore = savedScore.qualityScore !== undefined ? savedScore.qualityScore : 
                                       (savedScore.confidenceScore !== undefined ? savedScore.confidenceScore : 0);
                    const relevanceScore = savedScore.relevanceScore !== undefined ? savedScore.relevanceScore : 0;
                    
                    questionMap.set(question, {
                        question: question,
                        qualityScore: qualityScore,
                        relevanceScore: relevanceScore,
                        notes: savedScore.notes || '',
                        qualityNotes: savedScore.qualityNotes || '',
                        relevanceNotes: savedScore.relevanceNotes || '',
                        timestamp: savedScore.timestamp,
                        category: questionData?.category || 'Unknown',
                        focus: questionData?.focus || ''
                    });
                } else {
                    // Always keep the existing result from testResults (current session)
                    // This ensures imported CSV data takes priority over cached localStorage data
                    addDebugLog(`üîç DEBUG: Keeping existing result from testResults for question: ${question}`);
                }
            });
            
            // Convert Map to array
            allResults.push(...questionMap.values());
            
            // Always show ALL questions with their results
            testQuestions.forEach(question => {
                addDebugLog(`üîç DEBUG: Processing question in table: ${question.question}`);
                
                // Find the result for this question
                const displayResult = allResults.find(r => r.question === question.question);
                
                addDebugLog(`üîç DEBUG: Question "${question.question}" - displayResult: ${JSON.stringify(displayResult)}`);
                
                const row = document.createElement('tr');
                
                if (displayResult) {
                    // Handle both old format (confidenceScore, verdict) and new format (qualityScore, relevanceScore)
                    const qualityScore = displayResult.qualityScore !== undefined ? displayResult.qualityScore : 
                                       (displayResult.confidenceScore !== undefined ? displayResult.confidenceScore : 0);
                    const relevanceScore = displayResult.relevanceScore !== undefined ? displayResult.relevanceScore : 0;
                    const verdict = displayResult.verdict || (qualityScore >= 70 && relevanceScore >= 70 ? 'Pass' : 'Fail');
                    
                    // Question has been scored
                    row.innerHTML = `
                        <td>${question.question}</td>
                        <td><span class="status-badge ${qualityScore >= 70 && relevanceScore >= 70 ? 'status-pass' : 'status-fail'}">${verdict}</span></td>
                        <td>${qualityScore}</td>
                        <td>${displayResult.qualityNotes || ''}</td>
                        <td>${relevanceScore}</td>
                        <td>${displayResult.relevanceNotes || ''}</td>
                        <td>${displayResult.notes || ''}</td>
                        <td>${question.category}</td>
                    `;
                } else {
                    // Question not yet scored
                    row.innerHTML = `
                        <td>${question.question}</td>
                        <td><span class="status-badge status-pending">Pending</span></td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>${question.category}</td>
                    `;
                }
                tbody.appendChild(row);
            });
        }

        // Sort table by column
        let sortDirection = {};
        
        function sortTable(columnIndex) {
            const table = document.getElementById('resultsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determine sort direction
            const currentDirection = sortDirection[columnIndex] || 'asc';
            const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
            sortDirection[columnIndex] = newDirection;
            
            // Clear previous sort indicators
            table.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Add sort indicator to current column
            const header = table.querySelectorAll('th')[columnIndex];
            header.classList.add(newDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // Sort rows
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent.trim();
                const bValue = b.cells[columnIndex].textContent.trim();
                
                // Handle numeric columns (Bot Response Score, Related Score)
                if (columnIndex === 2 || columnIndex === 4) {
                    const aNum = parseInt(aValue) || 0;
                    const bNum = parseInt(bValue) || 0;
                    return newDirection === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // Handle text columns
                if (newDirection === 'asc') {
                    return aValue.localeCompare(bValue);
                } else {
                    return bValue.localeCompare(aValue);
                }
            });
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }

        // Export results to CSV file
        function exportResults() {
            const csvContent = generateCSV();
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `interactive-test-results-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function copyResults() {
            const csvContent = generateCSV();
            navigator.clipboard.writeText(csvContent).then(() => {
                // Show success feedback
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '‚úÖ Copied!';
                button.style.backgroundColor = '#28a745';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.backgroundColor = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy to clipboard. Please try exporting instead.');
            });
        }

        function copyTableResults() {
            const csvContent = generateCSV();
            navigator.clipboard.writeText(csvContent).then(() => {
                // Show success feedback
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '‚úÖ Copied!';
                button.style.backgroundColor = '#28a745';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.backgroundColor = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy to clipboard. Please try exporting instead.');
            });
        }

        // Clear all results
        function clearResults() {
            if (confirm('Are you sure you want to clear all results? This will delete all saved scores and notes.')) {
                testResults = [];
                currentQuestionIndex = 0;
                savedScores = {};
                
                // Clear localStorage
                localStorage.removeItem('interactiveTestScores');
                
                // Reset all question cards
                for (let i = 0; i < filteredQuestions.length; i++) {
                    const questionCard = document.getElementById(`question-${i}`);
                    if (questionCard) {
                        questionCard.classList.remove('current', 'completed', 'failed');
                        questionCard.classList.add('pending');
                        
                        const statusBadge = questionCard.querySelector('.status-badge');
                        if (statusBadge) {
                            statusBadge.textContent = 'Pending';
                            statusBadge.className = 'status-badge status-pending';
                        }
                    }
                }
                
                // Reset stats
                document.getElementById('completedCount').textContent = '0';
                document.getElementById('averageScore').textContent = '0';
                document.getElementById('progressFill').style.width = '0%';
                
                // Clear results table
                document.getElementById('resultsBody').innerHTML = '';
                
                // Reset to first question
                loadQuestion(0);
            }
        }

        // Clear old data and restart with new format
        function clearOldData() {
            if (confirm('This will clear all old data and restart with the new format. Are you sure?')) {
                testResults = [];
                currentQuestionIndex = 0;
                savedScores = {};
                
                // Clear localStorage
                localStorage.removeItem('interactiveTestScores');
                
                // Reset all question cards
                for (let i = 0; i < filteredQuestions.length; i++) {
                    const questionCard = document.getElementById(`question-${i}`);
                    if (questionCard) {
                        questionCard.classList.remove('current', 'completed', 'failed');
                        questionCard.classList.add('pending');
                        
                        const statusBadge = questionCard.querySelector('.status-badge');
                        if (statusBadge) {
                            statusBadge.textContent = 'Pending';
                            statusBadge.className = 'status-badge status-pending';
                        }
                    }
                }
                
                // Reset stats
                document.getElementById('completedCount').textContent = '0';
                document.getElementById('averageScore').textContent = '0';
                document.getElementById('avgBotResponseScore').textContent = '0';
                document.getElementById('avgRelatedScore').textContent = '0';
                document.getElementById('progressFill').style.width = '0%';
                
                // Clear results table and summary
                document.getElementById('resultsBody').innerHTML = '';
                document.getElementById('categoryBreakdown').innerHTML = '';
                
                // Reset to first question
                loadQuestion(0);
                
                // Update summary stats to recreate masonry tiles
                updateSummaryStats();
                
                alert('Old data cleared! You can now start fresh with the new format.');
            }
        }

        // Import results from CSV file
        function importResults() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const csv = e.target.result;
                        parseAndImportCSV(csv);
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Generate CSV content
        function generateCSV() {
            addDebugLog('üîç DEBUG: generateCSV() called');
            const headers = ['Question', 'Status', 'Bot Response Score', 'Bot Response Notes', 'Related Score', 'Related Notes', 'Other Notes', 'Category', 'Focus', 'Timestamp'];
            
            // Build allResults with deduplication - same logic as updateSummaryStats
            const allResults = [];
            const questionMap = new Map();
            
            // First, add all testResults (current session)
            testResults.forEach(result => {
                questionMap.set(result.question, result);
            });
            
            // Then, add savedScores only if not already in testResults (or if older)
            Object.keys(savedScores).forEach(question => {
                const savedScore = savedScores[question];
                const existingResult = questionMap.get(question);
                
                if (!existingResult) {
                    // No current result, add saved score
                    const questionData = testQuestions.find(q => q.question === question);
                    
                    const qualityScore = savedScore.qualityScore !== undefined ? savedScore.qualityScore : 
                                       (savedScore.confidenceScore !== undefined ? savedScore.confidenceScore : 0);
                    const relevanceScore = savedScore.relevanceScore !== undefined ? savedScore.relevanceScore : 0;
                    const verdict = savedScore.verdict || (qualityScore >= 70 && relevanceScore >= 70 ? 'Pass' : 'Fail');
                    
                    questionMap.set(question, {
                        question: question,
                        qualityScore: qualityScore,
                        relevanceScore: relevanceScore,
                        notes: savedScore.notes || '',
                        qualityNotes: savedScore.qualityNotes || '',
                        relevanceNotes: savedScore.relevanceNotes || '',
                        timestamp: savedScore.timestamp,
                        category: questionData?.category || 'Unknown',
                        focus: questionData?.focus || '',
                        verdict: verdict
                    });
                } else {
                    // Always keep the existing result from testResults (current session)
                    // This ensures imported CSV data takes priority over cached localStorage data
                    addDebugLog(`üîç DEBUG: Keeping existing result from testResults for question: ${question}`);
                }
            });
            
            // Convert Map to array
            allResults.push(...questionMap.values());
            
            addDebugLog(`üîç DEBUG: allResults final length = ${allResults.length}`);
            
            // Always export ALL results
            const rows = allResults.map(result => [
                `"${result.question}"`,
                result.verdict || (result.qualityScore >= 70 && result.relevanceScore >= 70 ? 'Pass' : 'Fail'),
                result.qualityScore,
                `"${result.qualityNotes || ''}"`,
                result.relevanceScore !== undefined ? result.relevanceScore : 0,
                `"${result.relevanceNotes || ''}"`,
                `"${result.notes || ''}"`,
                `"${result.category}"`,
                `"${result.focus}"`,
                `"${result.timestamp}"`
            ]);
            
            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }

        // Parse CSV line properly handling quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // Parse and import CSV
        function parseAndImportCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            
            // Clear existing results
            testResults = [];
            savedScores = {};
            
            // Detect CSV format based on headers
            const isNewFormat = headers.includes('Bot Response Score') && headers.includes('Related Score');
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = parseCSVLine(lines[i]);
                    let result;
                    
                    if (isNewFormat) {
                        // New format: Question, Status, Bot Response Score, Bot Response Notes, Related Score, Related Notes, Other Notes, Category, Focus, Timestamp
                        result = {
                            questionIndex: i - 1,
                            question: values[0] ? values[0].replace(/"/g, '') : '',
                            category: values[7] ? values[7].replace(/"/g, '') : '',
                            focus: values[8] ? values[8].replace(/"/g, '') : '',
                            qualityScore: parseInt(values[2]) || 0,
                            relevanceScore: parseInt(values[4]) || 0,
                            notes: values[6] ? values[6].replace(/"/g, '') : '',
                            qualityNotes: values[3] ? values[3].replace(/"/g, '') : '',
                            relevanceNotes: values[5] ? values[5].replace(/"/g, '') : '',
                            timestamp: values[9] ? values[9].replace(/"/g, '') : new Date().toISOString()
                        };
                    } else {
                        // Old format: Question, Category, Focus, Quality Score, Relevance Score, Overall Notes, Quality Notes, Relevance Notes, Timestamp
                        result = {
                            questionIndex: i - 1,
                            question: values[0] ? values[0].replace(/"/g, '') : '',
                            category: values[1] ? values[1].replace(/"/g, '') : '',
                            focus: values[2] ? values[2].replace(/"/g, '') : '',
                            qualityScore: parseInt(values[3]) || 0,
                            relevanceScore: parseInt(values[4]) || 0,
                            notes: values[5] ? values[5].replace(/"/g, '') : '',
                            qualityNotes: values[6] ? values[6].replace(/"/g, '') : '',
                            relevanceNotes: values[7] ? values[7].replace(/"/g, '') : '',
                            timestamp: values[8] ? values[8].replace(/"/g, '') : ''
                        };
                    }
                    
                    testResults.push(result);
                    savedScores[result.question] = {
                        qualityScore: result.qualityScore,
                        relevanceScore: result.relevanceScore,
                        notes: result.notes,
                        qualityNotes: result.qualityNotes,
                        relevanceNotes: result.relevanceNotes,
                        timestamp: result.timestamp
                    };
                }
            }
            
            saveScoresToStorage();
            updateStats();
            updateResultsTable();
            updateSummaryStats();
            
            alert(`Imported ${testResults.length} results successfully!`);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initTest);
    </script>
</body>
</html>