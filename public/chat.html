<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Alan Ranger Assistant</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0e1726; --panel:#121C2D; --text:#DDE7F6; --muted:#93A4C1; --bubble:#1B2A44;
  --brand:#E57200; --wa:#25D366; --ring:rgba(229,114,0,.35);
  --chip-bg:#13203e; --chip-br:#1b2540; --link:#9cd3ff; --link-hover:#cfe7ff;
  --user-bg:#e6edf7; --user-text:#0b0f16;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;line-height:1.45}
.wrap{max-width:980px;margin:28px auto;padding:0 16px}
.card{background:var(--panel);border-radius:14px;box-shadow:0 6px 22px rgba(0,0,0,.35);border-top:6px solid var(--brand);padding:28px}
.header{display:flex;flex-direction:column;align-items:center;gap:14px;margin-bottom:12px}
.logo{display:block;height:72px;width:auto;object-fit:contain;object-position:center;filter:drop-shadow(0 2px 6px rgba(0,0,0,.45))}
.title{margin:0;font-size:34px;font-weight:300;letter-spacing:.2px}
.sub{margin:0;text-align:center;color:var(--muted);max-width:720px;font-size:16px}
.pills{display:flex;gap:10px;margin:12px 0 4px}
.pill{appearance:none;border:0;border-radius:28px;padding:8px 12px;font-weight:600;font-size:14px;color:#0b0f16;cursor:pointer;line-height:1;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
.pill--brand{background:var(--brand)} .pill--wa{background:var(--wa)}

.chat{margin-top:12px;border-radius:14px;background:#0f1828;padding:18px}
.thread{display:flex;flex-direction:column;gap:12px}
.bubble{background:var(--bubble);padding:14px 16px;border-radius:12px;max-width:780px}
.bubble.user{align-self:flex-end;background:var(--user-bg);color:var(--user-text);border:1px solid #d3deee}
.fallback .pills{margin-top:10px}
.answer h1,.answer h2,.answer h3{margin:.2em 0}
.answer p{margin:.5em 0}
.answer ul{margin:.4em 0 .6em 1.25em}
.answer li{margin:.15em 0}
.answer a{color:var(--link);text-decoration:underline}
.answer a:hover{color:var(--link-hover)}

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.chips a{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--chip-br);background:var(--chip-bg);color:#cfe3ff;text-decoration:none}
.chips a:hover{opacity:.9}

/* Composer */
.composer{display:flex;gap:10px;margin-top:14px;padding:12px;background:var(--panel);border-radius:12px}
.composer input{flex:1;background:#E9EEF5;color:#0b0f16;border:1px solid #CBD5E1;border-radius:10px;padding:12px 14px;outline:0}
.composer input::placeholder{color:#6b7280}
.composer input:focus{border-color:var(--ring);box-shadow:0 0 0 4px var(--ring)}
.send{background:var(--brand);color:#0b0f16;font-weight:700;border:0;border-radius:10px;padding:0 18px;cursor:pointer}

/* Debug panel */
details.debug{margin-top:14px;background:#0f1828;border:1px solid #15223a;border-radius:10px;padding:10px 12px}
details.debug summary{cursor:pointer;color:#9eb2d3;font-weight:600;outline:none}
.kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin-top:10px}
.kv label{color:#93A4C1}
pre.json{white-space:pre-wrap;word-break:break-word;margin:0;padding:8px;background:#0b1422;border:1px solid #15223a;border-radius:8px;color:#cfe3ff;font-size:12px;line-height:1.4}

/* Typing dots */
.typing{position:relative;display:inline-block}
.typing .dot{display:inline-block;width:6px;height:6px;margin:0 2px;border-radius:50%;background:#9eb2d3;opacity:.6;animation:bounce 1.2s infinite}
.typing .dot:nth-child(2){animation-delay:.15s}
.typing .dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-4px)}}

@media (max-width:540px){.title{font-size:26px}.logo{height:60px}.kv{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap"><div class="card">
  <div class="header">
    <img class="logo" src="./chat%20white.png" alt="AR logo">
    <h2 class="title">Alan Ranger Assistant</h2>
    <p class="sub">Iâ€™m Alanâ€™s AI assistant, trained on content from this website to help with workshops, tuition, and photography questions. I wonâ€™t always get everything right â€” if I canâ€™t help, please contact Alan directly:</p>
    <div class="pills">
      <a class="pill pill--brand" target="_blank" rel="noopener" href="https://www.alanranger.com/contact-us-alan-ranger-photography">Contact form</a>
      <a class="pill pill--wa" target="_blank" rel="noopener" href="https://wa.me/447817017994">WhatsApp</a>
    </div>
  </div>

  <div class="chat">
    <div id="thread" class="thread">
      <div class="bubble">Hi! I can help with workshops, tuition, and photography advice.</div>
    </div>

    <details id="debugPanel" class="debug">
      <summary>ðŸ”Ž Show debug</summary>
      <div class="kv"><label>Endpoint</label><div>/api/chat</div></div>
      <div class="kv"><label>Status</label><div id="dbg-status">â€“</div></div>
      <div class="kv"><label>Headers</label><pre id="dbg-headers" class="json">â€“</pre></div>
      <div class="kv"><label>Request</label><pre id="dbg-req" class="json">â€“</pre></div>
      <div class="kv"><label>Response</label><pre id="dbg-res" class="json">â€“</pre></div>
    </details>

    <div class="composer">
      <input id="q" placeholder="Ask a questionâ€¦ (Shift+Enter for newline)" />
      <button id="send" class="send">Send</button>
    </div>
  </div>
</div></div>

<script>
/* ===== Config ===== */
const CHAT_ENDPOINT = '/api/chat';
const EXTRACT_ENDPOINT = '/api/extract';
const HARDCODED = 'b6c3f0c9e6f44cce9e1a4f3f2d3a5c76'; // optional bearer (same as bulk tool)

const urlParams = new URLSearchParams(location.search);
if (urlParams.get('debug') === '1') requestAnimationFrame(()=>{ document.getElementById('debugPanel').open = true; });

function getToken(){
  const qp = (urlParams.get('token')||'').trim();
  if (HARDCODED) return HARDCODED;
  if (qp) return qp;
  try { return (localStorage.getItem('ingest_token')||'').trim(); } catch { return ''; }
}

/* ===== DOM ===== */
const thread = document.getElementById('thread');
const input  = document.getElementById('q');
const sendBtn= document.getElementById('send');
const dbgStatus   = document.getElementById('dbg-status');
const dbgReq      = document.getElementById('dbg-req');
const dbgRes      = document.getElementById('dbg-res');
const dbgHeaders  = document.getElementById('dbg-headers');

/* ===== Helpers ===== */
function safeJSONString(v){ try { return JSON.stringify(v, null, 2); } catch { return String(v); } }
function maskToken(t){ if(!t) return ''; return t.length<=8 ? 'â€¢â€¢â€¢â€¢' : t.slice(0,4)+'â€¢â€¢â€¢'+t.slice(-4); }
function setDebug({status, req, res, headers}){
  if (status !== undefined) dbgStatus.textContent = String(status);
  if (req !== undefined) dbgReq.textContent = safeJSONString(req);
  if (res !== undefined) dbgRes.textContent = safeJSONString(res);
  if (headers !== undefined) {
    const h = {...headers}; if (h.Authorization) h.Authorization = 'Bearer ' + maskToken((h.Authorization.split(' ')[1]||'')); 
    dbgHeaders.textContent = safeJSONString(h);
  }
}
function addBubble(html, opts={}) {
  const div = document.createElement('div');
  div.className = 'bubble' + (opts.user ? ' user' : '');
  div.innerHTML = html;
  thread.appendChild(div);
  div.scrollIntoView({behavior:'smooth', block:'end'});
  return div;
}
function addTyping() {
  const el = addBubble(`<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`);
  return () => el && el.remove();
}
function stripTags(s){ return (s||'').replace(/<[^>]+>/g,''); }

/* ===== Mini Markdown â†’ HTML (capture list items) ===== */
function mdToHtml(md){
  if (!md) return { html:'', liIds:[], items:[] };
  let s = md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
  s = s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  s = s.replace(/(^|[^*])\*([^*\n]+)\*(?!\*)/g,'$1<em>$2</em>').replace(/(^|[^_])_([^_\n]+)_(?!_)/g,'$1<em>$2</em>');
  const lines = s.split(/\r?\n/);
  let out = '', inList = false, liIds = [], items=[], idx=0;
  const flush = ()=>{ if(inList){ out += '</ul>'; inList=false; } };
  for (const line of lines){
    const m = line.match(/^\s*-\s+(.*)$/);
    if (m){
      if(!inList){ out += '<ul>'; inList=true; }
      const plain = stripTags(m[1].trim());
      const id = `li_${++idx}`; liIds.push(id); items.push(plain);
      out += `<li id="${id}">${m[1].trim()}</li>`;
    }else{
      flush();
      out += line.trim() ? `<p>${line}</p>` : '';
    }
  }
  flush();
  return { html:`<div class="answer">${out}</div>`, liIds, items };
}

/* ===== Chips ===== */
function unique(arr){ return Array.from(new Set(arr.filter(Boolean))); }
function inferChips(question, answer, citations){
  const q=(question||'').toLowerCase(), a=(answer||'').toLowerCase();
  const chips=[];
  const push=(label,href)=>chips.push({label,href});
  unique(citations).slice(0,4).forEach(u=>{
    const label=(u.replace(/^https?:\/\//,'').replace(/www\./,'').split('/').slice(1).join(' / ')||'Open');
    chips.push({label:label.length>32?label.slice(0,29)+'â€¦':label,href:u});
  });
  if(/price|cost|how much|Â£|\bgbp\b|\bfee/.test(q+a)) push('Prices','https://www.alanranger.com/photography-workshops-near-me');
  if(/date|when|next|schedule|start|time/.test(q+a)) push('Upcoming dates','https://www.alanranger.com/photography-workshops-near-me');
  if(/workshop|course|class|tuition|lesson/.test(q+a)){ push('Workshops overview','https://www.alanranger.com/photography-workshops-near-me'); push('Tuition & coaching','https://www.alanranger.com/photography-lessons-online-121'); }
  return unique(chips.map(c=>JSON.stringify(c))).slice(0,6).map(s=>JSON.parse(s));
}
function addChips(container, chips){
  if(!chips.length || container.dataset.chipsAdded==='1') return;
  const wrap=document.createElement('div'); wrap.className='chips';
  chips.forEach(({label,href})=>{ const a=document.createElement('a'); a.href=href; a.target='_blank'; a.rel='noopener'; a.textContent=label; wrap.appendChild(a); });
  container.appendChild(wrap); container.dataset.chipsAdded='1';
}

/* ===== Dates & prices ===== */
const MONTHS={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12};
function toISODate(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function parseDateFromText(s){
  s = stripTags(s||'');
  const a = s.match(/\b(\d{1,2})\s+([A-Za-z]{3,})\.?,?\s+(\d{4})\b/);
  if (a){ const d=+a[1], m=MONTHS[a[2].toLowerCase().slice(0,3)], y=+a[3]; if(m) return toISODate(y,m,d); }
  const b = s.match(/\b([A-Za-z]{3,})\.?\s+(\d{1,2}),?\s+(\d{4})\b/);
  if (b){ const m=MONTHS[b[1].toLowerCase().slice(0,3)], d=+b[2], y=+b[3]; if(m) return toISODate(y,m,d); }
  return null;
}
function currencySymbol(ccy){ if(!ccy) return ''; const c=ccy.toUpperCase(); if(c==='GBP') return 'Â£'; if(c==='USD') return '$'; if(c==='EUR') return 'â‚¬'; return c+' '; }
function fmtAnyPrice(price,ccy){
  if(price==null || price==='') return ccy?(`${currencySymbol(ccy)}TBD`):'TBD';
  const sym = ccy ? currencySymbol(ccy) : '';
  return `${sym}${String(price)}`;
}
function isListingUrl(u){
  const p=(u||'').toLowerCase();
  return p.includes('near-me') || p.endsWith('/blog') || p.includes('/blog-on-photography') || p.endsWith('/photography-workshops-near-me');
}

/* ===== Structured extraction ===== */
/* Try DB first: /api/extract?action=entities-db&url=..., then fallback to extract-all */
async function fetchEntitiesFrom(url, token){
  async function call(action){
    const r = await fetch(`${EXTRACT_ENDPOINT}?action=${encodeURIComponent(action)}&url=${encodeURIComponent(url)}`, {
      headers: token ? {Authorization:`Bearer ${token}`} : {}
    });
    const text = await r.text().catch(()=> '');
    try { return JSON.parse(text); } catch { return null; }
  }

  const tryDb = await call('entities-db');    // expects {entities:[...]} or [...]
  let dbArr = null;
  if (Array.isArray(tryDb)) dbArr = tryDb;
  else if (tryDb && Array.isArray(tryDb.entities)) dbArr = tryDb.entities;

  if (dbArr && dbArr.length) return dbArr;

  const tryAll = await call('extract-all');
  if (Array.isArray(tryAll)) return tryAll;
  if (tryAll && Array.isArray(tryAll.entities)) return tryAll.entities;
  if (tryAll && Array.isArray(tryAll.data)) return tryAll.data;
  return [];
}

/* Normalise an entity into a stable shape, pulling offers from either .offers or .raw.offers */
function normaliseEntity(e, pageUrl){
  const offersSrc = Array.isArray(e.offers) ? e.offers :
                    Array.isArray(e.raw?.offers) ? e.raw.offers : [];
  const offers = offersSrc.map(o=>({
    url: o?.url ?? null,
    name: o?.name ?? o?.category ?? o?.description ?? null,
    price: (o?.price ?? null),
    priceCurrency: (o?.priceCurrency ?? e?.priceCurrency ?? e?.price_currency ?? null),
    availability: o?.availability ?? null
  }));

  return {
    kind: (e.kind || e['@type'] || '').toString().toLowerCase(),
    title: e.title || e.name || '',
    date_start: e.date_start || e.startDate || '',
    date_end: e.date_end || e.endDate || '',
    location: e.location?.name || e.location || '',
    price: (e.price ?? null),
    price_currency: (e.price_currency ?? e.priceCurrency ?? null),
    url: e.url || e.source_url || e['@id'] || pageUrl,
    source_url: e.source_url || e.url || pageUrl,
    offers
  };
}

/* ===== Linker & pricing enrichment ===== */
function pickBestUrlForEntity(entity, fallbackList=[]){
  const candidates = [];
  (entity.offers||[]).forEach(o=>{ if(o.url) candidates.push(o.url); });
  if (entity.source_url) candidates.push(entity.source_url);
  if (entity.url && entity.url !== entity.source_url) candidates.push(entity.url);
  candidates.push(...fallbackList);
  for (const c of candidates){ if (c && !isListingUrl(c)) return c; }
  return candidates.find(Boolean) || null;
}

function addLinksToBulletsUsingEntities(container, liIds, items, entities, citations){
  const byISO = new Map();
  entities.forEach(e=>{
    const iso=(e.date_start||'').slice(0,10);
    if(!iso) return;
    if(!byISO.has(iso)) byISO.set(iso, []);
    byISO.get(iso).push(e);
  });

  liIds.forEach((id,i)=>{
    const li = container.querySelector('#'+CSS.escape(id));
    if(!li) return;
    const iso = parseDateFromText(items[i]||'');
    let url=null;

    if(iso && byISO.has(iso)) {
      const match = byISO.get(iso)[0];
      url = pickBestUrlForEntity(match, citations);
    }

    if(!url) { // fallback scan
      for(const e of entities){
        url = pickBestUrlForEntity(e, citations);
        if(url && !isListingUrl(url)) break;
      }
    }
    if(!url && citations && citations.length){
      url = citations.find(u=>!isListingUrl(u)) || citations[0];
    }
    if(!url) return;

    const a=document.createElement('a'); a.href=url; a.target='_blank'; a.rel='noopener'; a.textContent=' Link'; a.style.marginLeft='6px';
    li.appendChild(a);
  });
}

function buildOfferLines(entities){
  const lines=[];
  entities.forEach(e=>{
    if (e.offers?.length){
      e.offers.forEach(o=>{
        const priceLine = fmtAnyPrice(o.price, o.priceCurrency || e.price_currency);
        const label = o.name ? o.name.replace(/\s*\|\s*/g,' â€“ ') : '';
        lines.push(label ? `${label}: ${priceLine}` : priceLine);
      });
    }else{
      const priceLine = fmtAnyPrice(e.price, e.price_currency);
      if (priceLine && priceLine !== 'TBD') lines.push(priceLine);
    }
  });
  return unique(lines);
}

function appendPriceIfMissing(container, entities){
  const alreadyShowsMoney = /Â£|\$|â‚¬/.test(container.innerHTML||'');
  const lines = buildOfferLines(entities);
  if (!lines.length) return;

  // If the LLM printed a price that might be wrong, we still append a canonical "Price" section from DB.
  const wrap = document.createElement('div');
  wrap.innerHTML = `<p><strong>Price:</strong></p><ul>` + lines.map(s=>`<li>${s}</li>`).join('') + `</ul>`;
  container.appendChild(wrap);
}

/* Main enrichment: prefer DB; fallback to JSON-LD */
async function enrich(question, container, liIds, items, citations){
  const token = getToken();

  // Collect and normalise entities from all citation pages
  const pageEntities = (await Promise.all(unique(citations).map(async (u)=>{
    const raw = await fetchEntitiesFrom(u, token);
    return raw.map(e=>normaliseEntity(e, u));
  }))).flat();

  // Link each bullet to the most date-specific page we can find
  addLinksToBulletsUsingEntities(container, liIds, items, pageEntities, citations);

  // Append canonical prices from DB/json-ld offers
  appendPriceIfMissing(container, pageEntities);

  // Context pills
  addChips(container, inferChips(question, container.textContent, citations));
}

/* ===== API ===== */
async function callChat(question, topK=8){
  const token = getToken();
  const headers = { 'Content-Type':'application/json' };
  if (token) headers['Authorization'] = 'Bearer ' + token;
  const body = { query: question, topK };
  setDebug({status:'â€¦', req: body, headers});
  const res = await fetch(CHAT_ENDPOINT, { method:'POST', headers, body: JSON.stringify(body) });
  const status = res.status;
  let json; try { json = await res.json(); } catch { json = { error:'non_json', status }; }
  setDebug({status, res: json});
  if(!res.ok) throw new Error('API error');
  return json;
}

/* ===== Render ===== */
function fallbackBlock(){
  return `
    <div class="fallback">
      <p>I donâ€™t have a confident answer to that yet. Iâ€™m trained on Alanâ€™s site, so I may miss things.</p>
      <p>If youâ€™d like to follow up, please reach out:</p>
      <div class="pills">
        <a class="pill pill--brand" target="_blank" rel="noopener" href="https://www.alanranger.com/contact-us-alan-ranger-photography">Contact form</a>
        <a class="pill pill--wa" target="_blank" rel="noopener" href="https://wa.me/447817017994">WhatsApp</a>
      </div>
    </div>`;
}
function renderAnswer(payload, question){
  if (!payload || payload.ok === false){ addBubble(fallbackBlock()); return; }
  const raw = payload.answer || payload.reply || payload.text || '';
  const cites = unique(payload.citations || payload.sources || []);
  const { html, liIds, items } = mdToHtml(raw);
  const holder = addBubble(html);
  enrich(question, holder, liIds, items, cites).catch(()=>{
    addChips(holder, inferChips(question, holder.textContent, cites));
  });
  if (!liIds.length) addChips(holder, inferChips(question, raw, cites));
}

/* ===== Events ===== */
async function handleSend(){
  const q = input.value.trim();
  if(!q) return;
  addBubble(q.replace(/</g,'&lt;'), {user:true});
  input.value = '';
  const stopTyping = addTyping();
  try{
    const data = await callChat(q, 8);
    stopTyping();
    renderAnswer(data, q);
  }catch{
    stopTyping();
    addBubble(fallbackBlock());
  }
}
sendBtn.addEventListener('click', handleSend);
input.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); }
});
</script>
</body>
</html>
