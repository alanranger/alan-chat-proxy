<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Alan Ranger Assistant</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0e1726; --panel:#121C2D; --text:#DDE7F6; --muted:#93A4C1; --bubble:#1B2A44;
  --brand:#E57200; --wa:#25D366; --ring:rgba(229,114,0,.35);
  --input-bg:#E9EEF5; --input-text:#0b0f16; --input-border:#CBD5E1; --input-ph:#6b7280;
  --chip-bg:#13203e; --chip-br:#1b2540; --link:#9cd3ff; --link-hover:#cfe7ff;
  --user-bg:#e6edf7; --user-text:#0b0f16;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;line-height:1.45}
.wrap{max-width:980px;margin:28px auto;padding:0 16px;position:relative}
.version{position:absolute;top:-8px;right:0;background:#0b1422;border:1px solid #1b2540;border-radius:999px;padding:2px 8px;font-size:11px;color:#9eb2d3}
.card{background:var(--panel);border-radius:14px;box-shadow:0 6px 22px rgba(0,0,0,.35);border-top:6px solid var(--brand);padding:28px}
.header{display:flex;flex-direction:column;align-items:center;gap:14px;margin-bottom:12px}
.logo{display:block;height:72px;width:auto;object-fit:contain;object-position:center;filter:drop-shadow(0 2px 6px rgba(0,0,0,.45))}
.title{margin:0;font-size:34px;font-weight:300;letter-spacing:.2px}
.sub{margin:0;text-align:center;color:var(--muted);max-width:720px;font-size:16px}
.pills{display:flex;gap:10px;margin:12px 0 4px;flex-wrap:wrap}
.pill{appearance:none;border:0;border-radius:28px;padding:8px 12px;font-weight:600;font-size:14px;color:#0b0f16;cursor:pointer;line-height:1;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
.pill--brand{background:var(--brand)} .pill--wa{background:var(--wa)}

.chat{margin-top:12px;border-radius:14px;background:#0f1828;padding:18px}
.thread{display:flex;flex-direction:column;gap:12px}
.bubble{background:var(--bubble);padding:14px 16px;border-radius:12px;max-width:780px}
.bubble.user{align-self:flex-end;background:var(--user-bg);color:var(--user-text);border:1px solid #d3deee}
.answer h1,.answer h2,.answer h3{margin:.2em 0}
.answer p{margin:.5em 0}
.answer ul{margin:.4em 0 .6em 1.25em}
.answer li{margin:.15em 0}
.answer a{color:var(--link);text-decoration:underline}
.answer a:hover{color:var(--link-hover)}

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.chips a{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--chip-br);background:var(--chip-bg);color:#cfe3ff;text-decoration:none;font-weight:600}
.chips a.brand{background:var(--brand);color:#0b0f16;border-color:transparent}
.chips a:hover{opacity:.9}

/* Composer */
.composer{display:flex;gap:10px;margin-top:14px;padding:12px;background:var(--panel);border-radius:12px}
.composer input{flex:1;background:var(--input-bg);color:var(--input-text);border:1px solid var(--input-border);border-radius:10px;padding:12px 14px;outline:0}
.composer input::placeholder{color:var(--input-ph)}
.composer input:focus{border-color:var(--ring);box-shadow:0 0 0 4px var(--ring)}
.send{background:var(--brand);color:#0b0f16;font-weight:700;border:0;border-radius:10px;padding:0 18px;cursor:pointer}

/* Debug panel */
details.debug{margin-top:14px;background:#0f1828;border:1px solid #15223a;border-radius:10px;padding:10px 12px}
details.debug summary{cursor:pointer;color:#9eb2d3;font-weight:600;outline:none}
.kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin-top:10px}
.kv label{color:#93A4C1}
pre.json{white-space:pre-wrap;word-break:break-word;margin:0;padding:8px;background:#0b1422;border:1px solid #15223a;border-radius:8px;color:#cfe3ff;font-size:12px;line-height:1.4}

/* Typing dots */
.typing{position:relative;display:inline-block}
.typing .dot{display:inline-block;width:6px;height:6px;margin:0 2px;border-radius:50%;background:#9eb2d3;opacity:.6;animation:bounce 1.2s infinite}
.typing .dot:nth-child(2){animation-delay:.15s}
.typing .dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-4px)}}

@media (max-width:540px){.title{font-size:26px}.logo{height:60px}.kv{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <span class="version">v0.9.15</span>
  <div class="card">
    <div class="header">
      <img class="logo" src="./chat%20white.png" alt="AR logo">
      <h2 class="title">Alan Ranger Assistant</h2>
      <p class="sub">I’m Alan’s AI assistant, trained on content from this website to help with workshops, tuition, and photography questions. I won’t always get everything right — if I can’t help, please contact Alan directly:</p>
      <div class="pills">
        <a class="pill pill--brand" target="_blank" rel="noopener" href="https://www.alanranger.com/contact-us-alan-ranger-photography">Contact form</a>
        <a class="pill pill--wa" target="_blank" rel="noopener" href="https://wa.me/447817017994">WhatsApp</a>
      </div>
    </div>

    <div class="chat">
      <div id="thread" class="thread">
        <div class="bubble">Hi! I can help with workshops, tuition, and photography advice.</div>
      </div>

      <details id="debugPanel" class="debug">
        <summary>🔎 Show debug</summary>
        <button id="dbg-copy" style="margin:8px 0 12px;padding:6px 10px;border-radius:6px;border:1px solid #334;color:#cfe3ff;background:#13203e;cursor:pointer">Copy all</button>
        <div class="kv"><label>Endpoint</label><div>/api/chat</div></div>
        <div class="kv"><label>Status</label><div id="dbg-status">–</div></div>
        <div class="kv"><label>Headers</label><pre id="dbg-headers" class="json">–</pre></div>
        <div class="kv"><label>Request</label><pre id="dbg-req" class="json">–</pre></div>
        <div class="kv"><label>Response</label><pre id="dbg-res" class="json">–</pre></div>
        <div class="kv"><label>Structured</label><pre id="dbg-struct" class="json">–</pre></div>
        <div class="kv"><label>Provenance</label><pre id="dbg-prov" class="json">–</pre></div>
        <div class="kv"><label>Note</label><pre id="dbg-note" class="json">–</pre></div>
      </details>

      <div class="composer">
        <input id="q" placeholder="Ask a question… (Shift+Enter for newline)" />
        <button id="send" class="send">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
const CHAT_ENDPOINT = '/api/chat';
const urlParams = new URLSearchParams(location.search);
if (urlParams.get('debug') === '1') requestAnimationFrame(()=>{ document.getElementById('debugPanel').open = true; });

const thread = document.getElementById('thread');
const input  = document.getElementById('q');
const sendBtn= document.getElementById('send');

const dbgStatus = document.getElementById('dbg-status');
const dbgReq    = document.getElementById('dbg-req');
const dbgRes    = document.getElementById('dbg-res');
const dbgHeaders= document.getElementById('dbg-headers');
const dbgStruct = document.getElementById('dbg-struct');
const dbgProv   = document.getElementById('dbg-prov');
const dbgCopy   = document.getElementById('dbg-copy');
const dbgNote   = document.getElementById('dbg-note');

function safeJSONString(v){ try{ return JSON.stringify(v,null,2); }catch{ return String(v); } }

dbgCopy?.addEventListener('click', ()=>{
  const all = [
    'Status: '+dbgStatus.textContent,
    'Headers:\n'+dbgHeaders.textContent,
    'Request:\n'+dbgReq.textContent,
    'Response:\n'+dbgRes.textContent,
    'Structured:\n'+dbgStruct.textContent,
    'Provenance:\n'+dbgProv.textContent,
    'Note:\n'+dbgNote.textContent,
  ].join('\n\n');
  navigator.clipboard.writeText(all).then(()=>{ dbgCopy.textContent='Copied!'; setTimeout(()=>dbgCopy.textContent='Copy all',1500); });
});

/* ---------- UI helpers ---------- */
function addBubble(html, opts={}) {
  const div = document.createElement('div');
  div.className = 'bubble' + (opts.user ? ' user' : '');
  div.innerHTML = html;
  thread.appendChild(div);
  div.scrollIntoView({behavior:'smooth', block:'end'});
  return div;
}
function addTyping() {
  const el = addBubble(`<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`);
  return ()=> el && el.remove();
}
function mdToHtml(md){
  if (!md) return { html:'', liIds:[], items:[] };
  let s = md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  s = s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  const lines = s.split(/\r?\n/);
  let out='', inList=false;
  const flush = ()=>{ if(inList){ out+='</ul>'; inList=false; } };
  for (const line of lines){
    const m = line.match(/^\s*-\s+(.*)$/);
    if (m){
      if(!inList){ out+='<ul>'; inList=true; }
      out += `<li>${m[1].trim()}</li>`;
    } else {
      flush();
      out += line.trim()? `<p>${line}</p>` : '';
    }
  }
  flush();
  return { html:`<div class="answer">${out}</div>` };
}
function fmtDate(iso){
  try{ return new Date(iso).toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short',year:'numeric'});}catch{ return iso; }
}

/* ----------------- A. Product merge & dedupe ----------------- */
const canon = s => (s||'').trim().toLowerCase()
  .replace(/^https?:\/\//,'').replace(/[#?].*$/,'').replace(/\/$/,'');
const titleKey = s => canon(String(s||'').replace(/\s+/g,' '));

function mergeProducts(products=[]){
  const buckets = new Map();
  for(const p of products){
    const key = canon(p.url||p.page_url) || titleKey(p.title);
    if(!key) continue;
    if(!buckets.has(key)) buckets.set(key, []);
    buckets.get(key).push(p);
  }

  const merged = [];
  for(const [key, items] of buckets){
    const out = { kind:'product', url: items.find(i=>i.url)?.url || items.find(i=>i.page_url)?.page_url, title: items.find(i=>i.title)?.title };
    // Prefer richer description
    out.description = (items.map(i=>i.description||i?.raw?.description||'').sort((a,b)=>b.length-a.length)[0]) || '';

    // Offers: base (Offer) + range (AggregateOffer)
    const offers = items.map(i=>i.raw?.offers||{}); // may mix
    const base = offers.find(o=>o && (o.price!=null));
    const agg  = offers.find(o=>o && (o.lowPrice!=null || o.highPrice!=null || o.lowprice!=null || o.highprice!=null));

    if(base){
      out.price = Number(base.price);
      out.price_currency = base.priceCurrency || 'GBP';
    }
    if(agg){
      out.range = {
        low: Number(agg.lowPrice ?? agg.lowprice ?? ''),
        high: Number(agg.highPrice ?? agg.highprice ?? ''),
        ccy:  agg.priceCurrency || 'GBP'
      };
    }

    // Availability (union; prefer explicit schema)
    out.availability = items.map(i=>i.availability || i?.raw?.offers?.availability)
      .filter(Boolean).sort((a,b)=>String(a).length<String(b).length?1:-1)[0] || '';

    // Keep a canonical raw (first)
    out.raw = items.find(i=>i.raw)?.raw || {};
    merged.push(out);
  }
  return merged;
}

/* ----------------- B. Facts extraction ----------------- */
function extractFacts(desc=''){
  const out = {};
  const lines = String(desc).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  // Normalise: accept "Label" or "Label: value"
  const get = (labels)=> {
    for(const label of labels){
      const re = new RegExp(`^${label}\\s*:??\\s*(.+)$`,'i');
      const m = lines.find(l=>re.test(l));
      if(m){ return m.replace(re,'$1').trim(); }
    }
    return null;
  };
  out.location     = get(['Location']);
  out.participants = get(['Participants']);
  out.fitness      = get(['Fitness']);
  out.availability = get(['Availability']);
  return out;
}

/* ----------------- C. Option pricing & times ----------------- */
function parseOptions(desc=''){
  const out=[];
  const text = desc.replace(/\r/g,'');
  // bullets or lines like: "4hrs — 5:45 am to 9:45 am or 10:30 am to 2:30 pm — £125"
  const re = /(?:^|\n)\s*(?:[-•]\s*)?((?:\d+\s*(?:hr|hrs|hour|hours)|half\s*day|1\s*day|full\s*day|day))\s*(?:[-–—]\s*)?([^£\n]*?)\s*(?:[-–—]\s*)?(?:£\s?(\d+(?:\.\d{1,2})?))?/gim;
  let m; while((m=re.exec(text))!==null){
    let label = m[1].replace(/\s+/g,' ').trim();
    if(/^4\s*hr/.test(label)) label='4 hours';
    if(/^half\s*day/i.test(label)) label='Half day';
    if(/^full\s*day/i.test(label) || /^day$/i.test(label)) label='Full day';
    if(/^1\s*day/i.test(label)) label='1 day';
    const time = (m[2]||'').replace(/\s+/g,' ').replace(/^—/,'').trim();
    const price = m[3] ? `£${Number(m[3]).toLocaleString('en-GB',{maximumFractionDigits:0})}` : null;
    out.push({label, time, price});
  }
  return out;
}

/* ----------------- D. Strip dates from product text ----------------- */
function stripDateNoise(desc=''){
  if(!desc) return desc;
  const lines = desc.split(/\r?\n/);
  const filtered = [];
  const dateToken = /(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\b/i;
  const shortDate = /\b\d{2}[-/](?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[-/]\d{2}\b/i;
  const longParaStart = /^Dates\s*\(.*\)/i;
  let skipping=false;
  for(const ln of lines){
    if(longParaStart.test(ln)){ skipping=true; continue; }
    if(skipping){
      // stop skipping if blank line
      if(!ln.trim()) { skipping=false; }
      continue;
    }
    if(dateToken.test(ln) || shortDate.test(ln)) continue;
    filtered.push(ln);
  }
  return filtered.join('\n').trim();
}

/* ----------------- E. Single action pills ----------------- */
function buildChips(structured, product){
  const chips = [];
  const prodUrl = product?.url || product?.raw?.url || null;
  const evUrl = (structured?.events||[]).find(e=>e.page_url||e.source_url)?.page_url || (structured?.events||[]).find(e=>e.source_url)?.source_url || null;

  if(prodUrl) chips.push({label:'Book Now', href:prodUrl, brand:true});
  if(evUrl)   chips.push({label:'Upcoming dates', href:evUrl, brand:false});
  return chips;
}

/* ----------------- F. Router / query upgrader ----------------- */
function upgradeQuery(q){
  const base = q.trim();

  const isNextWorkshop = /\b(next|upcoming)\b.*\bworkshop/i.test(base);
  const isDevon = /\b(devon|dartmoor|exmoor|sidmouth|south\s*west)\b/i.test(base);
  const isCourses = /\b(course|courses|class|classes|tuition)\b/i.test(base);

  let resolver = 'default';
  let query = base;

  if(isNextWorkshop && !/date|bluebell/i.test(base)){
    resolver = 'soonest-workshop';
    query += ' site:alanranger.com "Event" "workshop" date';
  }
  if(isDevon){
    resolver = 'region-filter';
    query += ' devon dartmoor exmoor sidmouth "workshop"';
  }
  if(isCourses){
    resolver = 'courses';
    query += ' site:alanranger.com course courses photography pricing';
  }
  return {query, resolver};
}

/* ----------------- G. Guardrails note ----------------- */
function setDebugNote({resolver, mergedCount, eventsCount, pillsCount}){
  const note = { resolver, merged_products: mergedCount, events_found: eventsCount, pills_rendered: pillsCount };
  dbgNote.textContent = safeJSONString(note);
}

/* -------------- Currency helper -------------- */
function fmtMoney(v, ccy='GBP'){
  if(v==null || v==='' || Number.isNaN(Number(v))) return null;
  try{
    return new Intl.NumberFormat('en-GB',{style:'currency',currency:ccy,maximumFractionDigits:0}).format(Number(v));
  }catch{
    return `£${String(v)}`;
  }
}

/* -------- Renderers -------- */
function renderProductCard(prod, structured){
  // Clean description of date spam
  const cleanDesc = stripDateNoise(prod.description||'');
  const facts = extractFacts(cleanDesc);
  const options = parseOptions(cleanDesc);

  // Pricing summary line (base + range if useful)
  const pieces = [];
  if(prod.price!=null) pieces.push(fmtMoney(prod.price, prod.price_currency||'GBP'));
  if(prod.range && (Number.isFinite(prod.range.low)||Number.isFinite(prod.range.high))){
    const lo = Number.isFinite(prod.range.low) ? fmtMoney(prod.range.low, prod.range.ccy||'GBP') : '';
    const hi = Number.isFinite(prod.range.high)? fmtMoney(prod.range.high, prod.range.ccy||'GBP') : '';
    if(lo||hi) pieces.push([lo,hi].filter(Boolean).join('–'));
  }
  const priceTrail = pieces.length? ` — ${pieces.join(' • ')}` : '';

  // Build facts/option list
  const list = [];
  // Option lines first (if we captured explicit times/prices)
  options.forEach(op=>{
    const bits = [ `<strong>${op.label}</strong>` ];
    if(op.time)  bits.push(`— ${op.time}`);
    if(op.price) bits.push(`— ${op.price}`);
    list.push(`<li>${bits.join(' ')}</li>`);
  });
  // Fallback: if no explicit option prices but we do have base/range, show succinct
  if(!options.length && (prod.price!=null || (prod.range && (prod.range.low||prod.range.high)))){
    list.push(`<li><strong>Pricing:</strong> ${pieces.join(' • ')}</li>`);
  }

  if(facts.location)     list.push(`<li><strong>Location:</strong> ${facts.location}</li>`);
  if(facts.participants) list.push(`<li><strong>Participants:</strong> ${facts.participants}</li>`);
  if(facts.fitness)      list.push(`<li><strong>Fitness:</strong> ${facts.fitness}</li>`);
  if(facts.availability){
    const norm = facts.availability;
    list.push(`<li><strong>Availability:</strong> ${norm}</li>`);
  }else if (prod.availability){
    const norm = /instock/i.test(prod.availability) ? 'In Stock' : /outofstock/i.test(prod.availability) ? 'Out of Stock' : null;
    if(norm) list.push(`<li><strong>Availability:</strong> ${norm}</li>`);
  }

  // Summary line: first non-empty sentence from description
  const firstLine = cleanDesc.split(/\r?\n/).map(s=>s.trim()).filter(Boolean)[0] || '';

  const card = `
    <div class="answer">
      <h3>${(prod.title||'Workshop')}${priceTrail}</h3>
      ${ firstLine ? `<p>${firstLine}</p>` : '' }
      ${ list.length ? `<ul>${list.join('')}</ul>` : '' }
    </div>
  `;
  const bubble = addBubble(card);

  // Single set of pills
  const chips = buildChips(structured, prod);
  const pillsWrap = document.createElement('div');
  pillsWrap.className='chips';
  chips.forEach(c=>{
    const a=document.createElement('a');
    a.href=c.href; a.target='_blank'; a.rel='noopener'; a.textContent=c.label;
    if(c.brand) a.classList.add('brand');
    pillsWrap.appendChild(a);
  });
  if(chips.length) bubble.appendChild(pillsWrap);

  return {chipsCount: chips.length};
}

function renderEventsBlock(structured){
  const now = new Date();
  const future = (structured?.events||[])
    .filter(e=> e?.date_start && !isNaN(Date.parse(e.date_start)) && new Date(e.date_start)>=now)
    .sort((a,b)=> new Date(a.date_start)-new Date(b.date_start))
    .slice(0,12);

  if(!future.length) return 0;

  const hTitle = structured?.topic ? `Upcoming ${String(structured.topic).trim()} Workshops` : 'Upcoming Workshops';
  const li = future.map(e=>{
    const when = fmtDate(e.date_start);
    const href = e.page_url||e.source_url||'#';
    const loc  = e.location || e?.raw?.location?.name || '';
    return `<li>${when} — <a href="${href}" target="_blank" rel="noopener">Link</a>${loc?` — ${loc}`:''}</li>`;
  }).join('');

  const html = `
    <div class="answer">
      <h3>${hTitle}</h3>
      <ul>${li}</ul>
    </div>`;
  addBubble(html);
  return future.length;
}

function renderMarkdownFallback(payload){
  const md = payload.answer_markdown || payload.answer || '';
  if(md){ const {html}=mdToHtml(md); addBubble(html); }
  else{
    addBubble(`<div class="answer"><p>I don’t have a specific answer for that yet. Try asking about workshops, tuition, kit, or locations — for example, <em>“When are the next Bluebell dates?”</em></p></div>`);
  }
}

/* ---------- Networking / Orchestration ---------- */
async function sendQuery(userQuery){
  const {query, resolver} = upgradeQuery(userQuery);
  const req = { query, topK: 8 };
  dbgReq.textContent = safeJSONString({resolver, ...req});

  const closeTyping = addTyping();
  try{
    const res = await fetch(CHAT_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(req)
    });
    dbgStatus.textContent = res.status;
    const headers = {}; res.headers.forEach((v,k)=>headers[k]=v);
    dbgHeaders.textContent = safeJSONString(headers);

    const dataText = await res.text();
    let data; try{ data = JSON.parse(dataText); }catch{ data={ answer_markdown:dataText }; }
    dbgRes.textContent = safeJSONString(data);
    dbgStruct.textContent = safeJSONString(data.structured||{});
    dbgProv.textContent = safeJSONString({ citations: data.citations || [] });

    closeTyping();

    const s = data.structured || {};
    let mergedCount=0, eventsCount=0, pillsCount=0;

    if(s.products?.length || s.events?.length){
      // Merge & dedupe products
      const merged = mergeProducts(s.products||[]);
      mergedCount = merged.length;

      // Render first merged product (single card)
      if(merged.length){
        const {chipsCount} = renderProductCard(merged[0], {...s, products: merged});
        pillsCount = chipsCount;
      }

      // Events block
      eventsCount = renderEventsBlock(s);

      // If nothing visible, fallback to markdown
      if(!merged.length && !eventsCount){
        renderMarkdownFallback(data);
      }
    }else{
      renderMarkdownFallback(data);
    }

    setDebugNote({resolver, mergedCount, eventsCount, pillsCount});
  } catch (err){
    closeTyping();
    dbgStatus.textContent = 'error';
    addBubble(`<div class="answer"><p>Something went wrong: ${String(err)}</p></div>`);
  }
}

/* ---------- Wire up composer ---------- */
function submit(){
  const val = input.value.trim();
  if(!val) return;
  addBubble(val, {user:true});
  input.value='';
  sendQuery(val);
}
sendBtn.addEventListener('click', submit);
input.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); submit(); }
});

// Optional: seed for testing
// sendQuery("give me the next bluebell workshop dates and prices");
</script>
</body>
</html>
