<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Alan Ranger Assistant</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<!--
  chat.html â€” Alan Ranger Assistant
  Version: v0.9.25  (full-drop-in build)
-->

<style>
/* ====== THEME ====== */
:root{
  --bg:#0e1726; --panel:#121C2D; --text:#DDE7F6; --muted:#93A4C1; --bubble:#1B2A44;
  --brand:#E57200; --wa:#25D366; --ring:rgba(229,114,0,.35);
  --input-bg:#E9EEF5; --input-text:#0b0f16; --input-border:#CBD5E1; --input-ph:#6b7280;
  --chip-bg:#13203e; --chip-br:#1b2540; --link:#9cd3ff; --link-hover:#cfe7ff;
  --user-bg:#e6edf7; --user-text:#0b0f16; --good:#00b894; --bad:#ef476f;
  --border:#15223a; --shadow:0 6px 22px rgba(0,0,0,.35);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;line-height:1.45}
a{color:var(--link)} a:hover{color:var(--link-hover)}

.wrap{max-width:980px;margin:28px auto;padding:0 16px;position:relative}
.badge-wrap{position:relative;height:0}
.version{position:absolute;top:8px;right:0;background:#0b1422;border:1px solid #1b2540;border-radius:999px;padding:2px 8px;font-size:11px;color:#9eb2d3}

/* ====== CARD ====== */
.card{background:var(--panel);border-radius:14px;box-shadow:var(--shadow);border-top:6px solid var(--brand);padding:28px}

/* ====== HEADER ====== */
.header-sticky{position:sticky;top:10px;z-index:50;background:linear-gradient(180deg, rgba(18,28,45,.98), rgba(18,28,45,.98));border-radius:12px;padding:0 0 10px 0;margin:-8px -8px 12px -8px}
.header{display:flex;flex-direction:column;align-items:center;gap:14px;margin-bottom:12px}
.logo{display:block;height:72px;width:auto;object-fit:contain;object-position:center;filter:drop-shadow(0 2px 6px rgba(0,0,0,.45))}
.title{margin:0;font-size:34px;font-weight:300;letter-spacing:.2px}
.sub{margin:0;text-align:center;color:var(--muted);max-width:720px;font-size:16px}
.pills{display:flex;gap:10px;margin:12px 0 4px;flex-wrap:wrap}
.pill{appearance:none;border:0;border-radius:28px;padding:8px 12px;font-weight:600;font-size:14px;color:#0b0f16;cursor:pointer;line-height:1;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
.pill--brand{background:var(--brand)} .pill--wa{background:var(--wa)}

/* ====== CHAT SURFACE ====== */
.chat{margin-top:12px;border-radius:14px;background:#0f1828;padding:18px}
.thread{display:flex;flex-direction:column;gap:12px}
.bubble{background:var(--bubble);padding:14px 16px;border-radius:12px;max-width:780px}
.bubble.user{align-self:flex-end;background:var(--user-bg);color:var(--user-text);border:1px solid #d3deee}
.answer h1,.answer h2,.answer h3{margin:.2em 0}
.answer p{margin:.5em 0}
.answer ul{margin:.4em 0 .6em 1.25em}
.answer li{margin:.15em 0}
.answer a{text-decoration:underline}
.kvline{margin:0}
.kvline strong{font-weight:600}
.meta{color:var(--muted);font-size:14px}
.conf{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:700;background:#0f244d;color:#cfe3ff;border:1px solid #274a8a;border-radius:999px;padding:4px 10px;margin-top:8px}
.conf::before{content:"â€¢";display:inline-block}

/* ====== ACTIONS ====== */
.actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
.actions .pill{background:var(--brand);color:#0b0f16;border:none}

/* ====== UTILITIES / CONTROLS ====== */
.tools{display:flex;flex-wrap:wrap;justify-content:flex-end;gap:10px;margin:8px 0 6px}
.tools button{background:#13203e;color:#cfe3ff;border:1px solid #2a3b61;border-radius:8px;padding:6px 10px;font-size:13px;cursor:pointer}
.tools button:hover{border-color:#3c548b}
.hint{font-size:12px;color:#8aa0c9;margin-top:6px}

/* ====== COMPOSER ====== */
.composer{display:flex;gap:10px;margin-top:8px;padding:12px;background:var(--panel);border-radius:12px}
.composer input{flex:1;background:var(--input-bg);color:var(--input-text);border:1px solid #d3deee;border-radius:10px;padding:12px 14px;outline:0}
.composer input::placeholder{color:var(--input-ph)}
.composer input:focus{border-color:var(--ring);box-shadow:0 0 0 4px var(--ring)}
.send{background:var(--brand);color:#0b0f16;font-weight:700;border:0;border-radius:10px;padding:0 18px;cursor:pointer}

/* ====== DEBUG ====== */
details.debug{margin-top:14px;background:#0f1828;border:1px solid var(--border);border-radius:10px;padding:10px 12px}
details.debug summary{cursor:pointer;color:#9eb2d3;font-weight:600;outline:none}
.kv{display:grid;grid-template-columns:160px 1fr;gap:8px;margin-top:10px}
.kv label{color:#93A4C1}
pre.json{white-space:pre-wrap;word-break:break-word;margin:0;padding:8px;background:#0b1422;border:1px solid var(--border);border-radius:8px;color:#cfe3ff;font-size:12px;line-height:1.4}

/* ====== TYPING ====== */
.typing{position:relative;display:inline-block}
.typing .dot{display:inline-block;width:6px;height:6px;margin:0 2px;border-radius:50%;background:#9eb2d3;opacity:.6;animation:bounce 1.2s infinite}
.typing .dot:nth-child(2){animation-delay:.15s}
.typing .dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-4px)}}

/* ====== MEDIA ====== */
@media (max-width:540px){
  .title{font-size:26px}.logo{height:60px}.kv{grid-template-columns:1fr}
  .header-sticky{top:6px;margin:-6px -6px 10px -6px}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="badge-wrap"><span class="version" aria-label="Build version">v0.9.25</span></div>

  <div class="card" role="application" aria-label="Alan Ranger Assistant">
    <!-- Sticky header -->
    <div class="header-sticky">
      <div class="header" role="banner">
        <img class="logo" src="./chat%20white.png" alt="Alan Ranger icon">
        <h2 class="title">Alan Ranger Assistant</h2>
        <p class="sub">Iâ€™m Alanâ€™s AI assistant, trained on content from this website to help with workshops, tuition, and
          photography questions. I wonâ€™t always get everything right â€” if I canâ€™t help, please contact
          Alan directly:</p>
        <div class="pills" role="navigation" aria-label="Contact options">
          <a class="pill pill--brand" target="_blank" rel="noopener" href="https://www.alanranger.com/contact-us-alan-ranger-photography" aria-label="Open contact form">Contact form</a>
          <a class="pill pill--wa" target="_blank" rel="noopener" href="https://wa.me/447817017994" aria-label="WhatsApp chat">WhatsApp</a>
        </div>
      </div>
    </div>

    <div class="chat" role="region" aria-live="polite">
      <div id="thread" class="thread" role="log" aria-label="Chat transcript">
        <div class="bubble" aria-label="assistant message">Hi! I can help with workshops, tuition, and photography advice.</div>
      </div>

      <!-- Utility buttons -->
      <div class="tools" role="toolbar" aria-label="Utilities">
        <button id="btn-email" title="Email transcript (Ctrl/Cmd+E)">Email transcript</button>
        <button id="btn-download" title="Download transcript (.txt)">Download</button>
        <button id="btn-reset" title="Reset chat (Ctrl/Cmd+R)">Reset chat</button>
        <button id="btn-focus" title="Focus input (Ctrl/Cmd+K)">Focus input</button>
      </div>
      <div class="hint">Shortcuts: Enter = send, Shift+Enter = newline, <kbd>Ctrl/Cmd+K</kbd> focus, <kbd>Ctrl/Cmd+R</kbd> reset, <kbd>Ctrl/Cmd+E</kbd> email, <kbd>Ctrl/Cmd+D</kbd> toggle debug.</div>

      <details id="debugPanel" class="debug">
        <summary>ðŸ”Ž Show debug</summary>
        <button id="dbg-copy" style="margin:8px 0 12px;padding:6px 10px;border-radius:6px;border:1px solid #334;color:#cfe3ff;background:#13203e;cursor:pointer">Copy all</button>
        <div class="kv"><label>Endpoint</label><div id="dbg-endpoint">/api/chat</div></div>
        <div class="kv"><label>Status</label><div id="dbg-status">â€“</div></div>
        <div class="kv"><label>Headers</label><pre id="dbg-headers" class="json">â€“</pre></div>
        <div class="kv"><label>Request</label><pre id="dbg-req" class="json">â€“</pre></div>
        <div class="kv"><label>Response</label><pre id="dbg-res" class="json">â€“</pre></div>
        <div class="kv"><label>Structured</label><pre id="dbg-struct" class="json">â€“</pre></div>
        <div class="kv"><label>Provenance</label><pre id="dbg-prov" class="json">â€“</pre></div>
        <div class="kv"><label>Note</label><pre id="dbg-note" class="json">â€“</pre></div>
      </details>

      <div class="composer" role="search">
        <input id="q" aria-label="Ask a question" placeholder="Ask a questionâ€¦ (Shift+Enter for newline)" />
        <button id="send" class="send" aria-label="Send message">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ==========================================================
   Alan Ranger Assistant â€” client script
   Build v0.9.25
   ========================================================== */

const CHAT_ENDPOINT='/api/chat';
const STORAGE_KEY='ar-assistant-thread-v1';
const urlParams=new URLSearchParams(location.search);
if(urlParams.get('debug')==='1') requestAnimationFrame(()=>{document.getElementById('debugPanel').open=true;});

// ===== DOM =====
const thread=document.getElementById('thread');
const input=document.getElementById('q');
const sendBtn=document.getElementById('send');
const btnEmail=document.getElementById('btn-email');
const btnDownload=document.getElementById('btn-download');
const btnReset=document.getElementById('btn-reset');
const btnFocus=document.getElementById('btn-focus');

const dbgStatus=document.getElementById('dbg-status');
const dbgReq=document.getElementById('dbg-req');
const dbgRes=document.getElementById('dbg-res');
const dbgHeaders=document.getElementById('dbg-headers');
const dbgStruct=document.getElementById('dbg-struct');
const dbgProv=document.getElementById('dbg-prov');
const dbgCopy=document.getElementById('dbg-copy');
const dbgNote=document.getElementById('dbg-note');

// ===== Utils =====
function j(v){try{return JSON.stringify(v,null,2);}catch{return String(v);}}
function esc(s){return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
function mdToHtml(md){
  if(!md) return {html:''};
  let s=md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  s=s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  const lines=s.split(/\r?\n/);
  let out='',inList=false;
  const flush=()=>{if(inList){out+='</ul>';inList=false;}};
  for(const line of lines){
    const m=line.match(/^\s*-\s+(.*)$/);
    if(m){ if(!inList){out+='<ul>';inList=true;} out+=`<li>${m[1].trim()}</li>`; }
    else { flush(); out += line.trim()?`<p>${line}</p>`:''; }
  }
  flush();
  return {html:`<div class="answer">${out}</div>`};
}
function fmtDate(iso){try{return new Date(iso).toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short',year:'numeric'});}catch{return iso;}}
function currency(n,ccy){
  if(n==null||n==='')return null;
  const v=Number(n); if(!isFinite(v)) return null;
  try{return new Intl.NumberFormat(undefined,{style:'currency',currency:ccy||'GBP',maximumFractionDigits:0}).format(v);}
  catch{return `Â£${String(n).replace(/\.00$/,'')}`;}
}

// ===== UI helpers =====
function addBubble(html,opts={}){const d=document.createElement('div');d.className='bubble'+(opts.user?' user':'');d.innerHTML=html;thread.appendChild(d);persistThread();d.scrollIntoView({behavior:'smooth',block:'end'});return d;}
function addTyping(){const el=addBubble(`<span class="typing" aria-live="polite"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`);return()=>el&&el.remove();}
function nodeToPlain(div){return div.textContent.replace(/\s+\n/g,'\n').replace(/\n{3,}/g,'\n\n').trim();}
function buildTranscript(){
  const rows=[];
  rows.push(`Alan Ranger Assistant â€” transcript`);
  rows.push(new Date().toISOString());
  rows.push('');
  for(const el of thread.children){
    if(el.classList.contains('actions')) continue;
    const role=el.classList.contains('user')?'User':'Assistant';
    rows.push(`${role}:\n${nodeToPlain(el)}`); rows.push('');
  }
  return rows.join('\n');
}
function downloadTranscript(){
  const body=buildTranscript();
  const blob=new Blob([body],{type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='alan-ranger-assistant-transcript.txt';
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),1000);
}
function emailTranscript(){
  const body=buildTranscript();
  const subject='Alan Ranger Assistant chat transcript';
  const link=`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body.slice(0,2000))}`;
  if(body.length>2000){
    const blob=new Blob([body],{type:'text/plain'});
    const url=URL.createObjectURL(blob);
    addBubble(`<div class="answer"><p>Transcript is long. You can <a href="${url}" download="alan-ranger-assistant-transcript.txt">download the full transcript</a>, and a shortened email draft was opened.</p>${confBadge()}</div>`);
  }
  location.href=link;
}

// ===== Persistence =====
function persistThread(){
  try{
    const html=thread.innerHTML;
    sessionStorage.setItem(STORAGE_KEY, html);
  }catch{}
}
function loadPersisted(){
  try{
    const html=sessionStorage.getItem(STORAGE_KEY);
    if(html){ thread.innerHTML=html; }
  }catch{}
}
loadPersisted();

// ===== Confidence =====
let __lastConfidencePct=null;
function confBadge(){
  const p=__lastConfidencePct;
  if(p==null||isNaN(p)) return '';
  return `<div class="conf" aria-label="confidence">Confidence: ${p}%</div>`;
}
function heuristicConfidence(s){
  let score=0;
  if(s?.products?.length) score+=40;
  if(s?.events?.length) score+=40;
  if(s?.articles?.length) score+=20;
  return Math.min(95,Math.max(20,score||25));
}

// ===== Product helpers =====
function firstSentenceOnly(text){
  const raw=String(text||'').replace(/\s+/g,' ').trim();
  const cut=raw.split(/summary\b/i)[0].trim();
  const m=cut.match(/^(.*?\.)\s/);
  const sent=(m?m[1]:cut).slice(0,220).trim();
  return sent.endsWith('.')?sent:sent;
}
function parseDiscount(desc){
  const t=String(desc||'');
  let m=t.match(/\b(?:was|rrp)\s*Â£?\s*(\d{2,4})\b.*?\b(?:now|today|sale)\s*Â£?\s*(\d{2,4})/i);
  if(m) return {was:+m[1],now:+m[2]};
  m=t.match(/\bÂ£\s?(\d{2,4})\b\s*(?:â†’|->|to)\s*Â£\s?(\d{2,4})/i);
  if(m) return {was:+m[1],now:+m[2]};
  return null;
}
function offersArray(raw){const o=raw?.offers; if(Array.isArray(o)) return o; return o?[o]:[];}
function extractFacts(desc){
  const lines=String(desc||'').split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const get=(lab)=>{
    const idx=lines.findIndex(l=>new RegExp(`^${lab}\\s*:?$`,'i').test(l));
    if(idx>=0 && idx+1<lines.length) return lines[idx+1];
    const flat=lines.find(l=>new RegExp(`^${lab}\\s*:?\\s+(.+)$`,'i').test(l));
    return flat?flat.replace(new RegExp(`^${lab}\\s*:?\\s+`,'i'),''):null;
  };
  const optionLines=lines.filter(l=>/^(?:4\s*hrs?|4\s*hours?|half\s*day|1\s*day|full\s*day|day)\b/i.test(l));
  return {location:get('Location'),participants:get('Participants'),fitness:get('Fitness'),availability:get('Availability'),optionLines,lines};
}
function parsePriceTokens(text){
  // find Â£xxx tokens but ignore 0, postal codes, times, percentages
  const vals=new Set();
  String(text||'').replace(/Â£\s?(\d{2,4})(?:\.\d{2})?/g,(m,grp,off)=>{
    const n=+grp;
    if(!isFinite(n)||n===0) return;
    // guard: if "B95 5BG" or similar nearby (letters digits space letters)
    const around=text.slice(Math.max(0,off-8),off+8);
    if(/[A-Z]\d{1,2}\s?\d[A-Z]{2}/i.test(around)) return;
    vals.add(n);
  });
  return Array.from(vals).sort((a,b)=>a-b);
}
function parseExtraPriceFromText(desc){
  const m=String(desc||'').match(/\b(?:1\s*day|full\s*day)\b[^Â£\d]{0,12}(Â£?\s?\d{2,4})/i);
  if(!m) return null;
  const n=Number(m[1].replace(/[^\d.]/g,''));
  return isFinite(n)?n:null;
}
function deriveOptions(prod,facts){
  const ccy=prod.price_currency||prod?.raw?.offers?.priceCurrency||'GBP';
  const base=prod.price??prod?.raw?.offers?.price;
  const arr=offersArray(prod.raw);
  const opts=[];
  if(arr.length>1){
    arr.forEach((o,i)=>{ // multiple offers
      const label=o.name||o.description||`Option ${i+1}`;
      const price=currency(o.price,o.priceCurrency||ccy);
      if(price||label) opts.push({label,price});
    });
  }
  const text=(facts.optionLines||[]).join('\n').toLowerCase();
  const has4h=/(^|\n)\s*(?:4\s*hrs?|4\s*hours?|half\s*day)\b/.test(text);
  const has1d=/(^|\n)\s*(?:1\s*day|full\s*day|day)\b/.test(text);
  const extra=parseExtraPriceFromText(prod.description||prod.raw?.description||'');
  if(has4h && has1d && base!=null && extra!=null && extra!==base){
    const low=Math.min(base,extra), high=Math.max(base,extra);
    opts.push({label:'4 hours',price:currency(low,ccy)});
    opts.push({label:'1 day',price:currency(high,ccy)});
  }else{
    if(base!=null) opts.push({label:'Standard',price:currency(base,ccy)});
  }
  // Add times if present
  const timePat=/(\d{1,2}:\d{2}\s*(?:am|pm))\s*[â€“-]\s*(\d{1,2}:\d{2}\s*(?:am|pm))(?:\s*or\s*(\d{1,2}:\d{2}\s*(?:am|pm))\s*[â€“-]\s*(\d{1,2}:\d{2}\s*(?:am|pm)))?/i;
  for(const ln of facts.optionLines||[]){
    const label=ln.replace(/\s*â€”.*$/,'').replace(/^OR\s*/i,'').trim();
    const tm=ln.match(timePat);
    const window=tm?`${tm[1]} â€“ ${tm[2]}${tm[3]?` or ${tm[3]} â€“ ${tm[4]}`:''}`:null;
    if(label){
      const existing=opts.find(o=>o.label.toLowerCase()===label.toLowerCase());
      if(existing){ if(window && !existing.time) existing.time=window; }
      else opts.push({label,time:window});
    }
  }
  return opts;
}
function derivePriceRange(prod){
  const ccy=prod.price_currency||prod?.raw?.offers?.priceCurrency||'GBP';
  let low=prod?.raw?.offers?.lowPrice, high=prod?.raw?.offers?.highPrice;

  // From multiple offers[]
  const arr=offersArray(prod.raw).map(o=>Number(o.price)).filter(n=>isFinite(n)&&n>0);
  if(arr.length>=2){ low=Math.min(...arr); high=Math.max(...arr); }

  // From description tokens
  const tokens=parsePriceTokens(prod.raw?.description||prod.description||'');
  if(tokens.length>=2){
    const tLow=Math.min(...tokens), tHigh=Math.max(...tokens);
    if((low==null||tLow<low) && tLow>0) low=tLow;
    if((high==null||tHigh>high) && tHigh>0) high=tHigh;
  }

  // From 4hr vs 1day
  const base=prod.price??prod?.raw?.offers?.price;
  const extra=parseExtraPriceFromText(prod.raw?.description||prod.description||'');
  if(base!=null && extra!=null && base!==extra){
    const bLow=Math.min(base,extra), bHigh=Math.max(base,extra);
    if(low==null||bLow<low) low=bLow;
    if(high==null||bHigh>high) high=bHigh;
  }

  if(low!=null && high!=null && high>low) return {low,high,ccy};
  return {ccy,base:base??low??high};
}
function renderProductCard(prod,payload){
  const facts=extractFacts(prod.description||prod.raw?.description||'');
  const opts=deriveOptions(prod,facts);
  const discount=parseDiscount(prod.raw?.description||prod.description||'');
  const range=derivePriceRange(prod);
  const ccy=range.ccy||'GBP';

  const meta=firstSentenceOnly(prod.raw?.description||prod.description||payload?.answer_markdown||'');
  const bits=[];
  if(meta) bits.push(`<p class="meta">${esc(meta)}</p>`);
  if(facts.location) bits.push(`<p class="kvline"><strong>Location:</strong> ${esc(facts.location)}</p>`);
  if(facts.participants) bits.push(`<p class="kvline"><strong>Participants:</strong> ${esc(facts.participants)}</p>`);
  if(facts.fitness) bits.push(`<p class="kvline"><strong>Fitness:</strong> ${esc(facts.fitness)}</p>`);
  if(prod.availability||facts.availability){
    const a=(prod.availability||facts.availability||'').toString().replace(/^https?:\/\/schema\.org\//i,'').replace(/([a-z])([A-Z])/g,'$1 $2');
    bits.push(`<p class="kvline"><strong>Availability:</strong> ${esc(a)}</p>`);
  }

  const lines=[];
  if(discount){
    lines.push(`<li><strong>Normal price</strong> â€” ${currency(discount.was,ccy)}</li>`);
    lines.push(`<li><strong>Discounted</strong> â€” ${currency(discount.now,ccy)}</li>`);
  }else if(range.low!=null && range.high!=null){
    lines.push(`<li><strong>Price range</strong> â€” ${currency(range.low,ccy)} â€“ ${currency(range.high,ccy)}</li>`);
  }else if(range.base!=null){
    lines.push(`<li><strong>Price</strong> â€” ${currency(range.base,ccy)}</li>`);
  }
  for(const o of opts){
    const tail=[o.time?` â€” ${esc(o.time)}`:'',o.price?` â€” ${o.price}`:''].join('');
    lines.push(`<li>${esc(o.label||'Option')}${tail}</li>`);
  }

  return `
    <div class="answer" aria-label="product">
      <h3>${esc(prod.title||'Workshop')}</h3>
      ${bits.join('')}
      ${lines.length?`<ul>${lines.join('')}</ul>`:''}
      ${confBadge()}
    </div>`;
}

// ===== Events =====
const STOP=new Set(['the','and','or','what','whats','when','whens','next','cost','workshop','workshops','photography','photo','near','me','uk','warks','warwickshire','devonshire']);
let __lastQuery='';
function extractKeywords(topic,q){
  const src=[topic||'',q||''].join(' ').toLowerCase();
  const words=Array.from(new Set(src.match(/[a-z]+/g)||[]));
  const geos=['devon','warwickshire','warks','coventry','peak','district','lake','lakes','yorkshire','moor','moors','exmoor','dartmoor'];
  return words.filter(w=>!STOP.has(w) || geos.includes(w));
}
function eventMatches(e,kws){
  if(!kws.length) return true;
  const hay=((e.title||'')+' '+(e.location||'')).toLowerCase();
  return kws.some(k=>hay.includes(k));
}
function renderEvents(structured,productHasLocation){
  const now=new Date();
  const all=(structured?.events||[]).filter(e=>e?.date_start&&!isNaN(Date.parse(e.date_start))&&new Date(e.date_start)>=now);
  const kws=extractKeywords(structured?.topic||'',__lastQuery);
  const list=(all.filter(e=>eventMatches(e,kws))||[]);
  if(!list.length) return '';
  const kw=kws.find(k=>k&&!STOP.has(k));
  const title=kw?`Upcoming ${kw[0].toUpperCase()+kw.slice(1)} Workshops`:'Upcoming Workshops';
  const lis=list.sort((a,b)=>new Date(a.date_start)-new Date(b.date_start)).map(e=>{
    const when=fmtDate(e.date_start);
    const href=e.page_url||e.source_url||e.url||'#';
    const loc=e.location||'';
    const locPart=(!productHasLocation&&loc)?` â€” ${esc(loc)}`:'';
    return `<li>${when} â€” <a href="${href}" target="_blank" rel="noopener">Link</a>${locPart}</li>`;
  }).join('');
  return `<div class="answer" aria-label="events"><h3>${title}</h3><ul>${lis}</ul>${confBadge()}</div>`;
}

// ===== Articles (from structured.articles OR from citations â€” generic, no wildcard) =====
const GUIDE_HINT=/\/(blog|blogs?|guide|guides|article|articles|learn|tips|resources|tuition)\b/i;
function titleFromUrl(u){
  try{
    const p=new URL(u); const seg=p.pathname.split('/').filter(Boolean).pop()||p.hostname;
    return seg.replace(/[-_]+/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
  }catch{return u;}
}
function deriveArticles(payload){
  const fromStructured=(payload?.structured?.articles||[]).filter(a=>a?.page_url||a?.source_url||a?.url);
  if(fromStructured.length) return fromStructured.slice(0,5).map(a=>({title:a.title||a.raw?.name||titleFromUrl(a.page_url||a.source_url||a.url), url:a.page_url||a.source_url||a.url}));
  const cites=(payload?.citations||[]).filter(u=>GUIDE_HINT.test(String(u)));
  const uniq=[]; const used=new Set();
  for(const u of cites){
    const url=String(u);
    if(used.has(url)) continue;
    used.add(url);
    uniq.push({title:titleFromUrl(url), url});
    if(uniq.length>=5) break;
  }
  return uniq;
}
function renderArticlesFromPayload(payload){
  const arts=deriveArticles(payload);
  if(!arts.length) return '';
  const lis=arts.map(a=>`<li><a href="${a.url}" target="_blank" rel="noopener">${esc(a.title)}</a></li>`).join('');
  return `<div class="answer" aria-label="guides"><h3>Guides that match your question</h3><ul>${lis}</ul>${confBadge()}</div>`;
}

// ===== Action pills (safe only; include first article if present) =====
function buildPills(payload){
  const structured=payload.structured||{};
  const safe=[]; const used=new Set();
  const add=(label,href)=>{
    if(!label||!href) return;
    const u=String(href);
    if(/\/search\?query=/.test(u)) return;   // banned wildcard
    const key=`${label}::${u}`; if(used.has(key)) return;
    used.add(key); safe.push({label,href});
  };
  for(const p of (structured?.pills||[])) add(p.label||p.text,p.url||p.href);

  const art=deriveArticles(payload)[0];
  if(art) add('Related articles', art.url);

  return safe.slice(0,5);
}

// ===== Rendering from payload =====
function renderAnswer(payload){
  const s=payload.structured||{};
  let pct=(typeof payload.confidence_pct==='number')?payload.confidence_pct:null;
  const floor=heuristicConfidence(s); if(pct==null || pct<50) pct=floor;
  __lastConfidencePct=Math.round(pct);

  const prods=(s.products||[]); const prod=prods[0]||null;
  if(prod) addBubble(renderProductCard(prod,payload));

  const productFacts=prod?extractFacts(prod.description||prod.raw?.description||''):null;
  const evHTML=renderEvents(s,!!(productFacts&&productFacts.location));
  if(evHTML) addBubble(evHTML);

  const artHTML=renderArticlesFromPayload(payload);
  if(artHTML) addBubble(artHTML);

  const pills=buildPills(payload);
  if(pills.length){
    const wrap=document.createElement('div'); wrap.className='actions';
    pills.forEach(p=>{const a=document.createElement('a'); a.className='pill'; a.textContent=p.label; a.href=p.href; a.target='_blank'; a.rel='noopener'; wrap.appendChild(a);});
    thread.appendChild(wrap); persistThread();
  }

  if(!prod && !(s.events||[]).length && !deriveArticles(payload).length){
    const {html}=mdToHtml(payload.answer_markdown||payload.answer||"I donâ€™t have a specific answer for that yet.");
    addBubble(html.replace('</div>', `${confBadge()}</div>`));
  }

  dbgStruct.textContent=j(payload.structured||{});
  dbgNote.textContent=j({confidence_pct:__lastConfidencePct});
}

// ===== Networking =====
async function sendQuery(q){
  __lastQuery=String(q||'');
  const req={query:q,topK:8};
  dbgReq.textContent=j(req);
  const close=addTyping();
  try{
    const res=await fetch(CHAT_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(req)});
    dbgStatus.textContent=res.status;
    const headers={}; res.headers.forEach((v,k)=>headers[k]=v); dbgHeaders.textContent=j(headers);
    const data=await res.json(); dbgRes.textContent=j(data); dbgProv.textContent=j({citations:data.citations||[]});
    close();
    if(data && (data.answer_markdown||data.answer||(data.structured&&(data.structured.products?.length||data.structured.events?.length||data.structured.articles?.length)) || (data.citations||[]).length)){
      renderAnswer(data);
    }else{
      const {html}=mdToHtml("I donâ€™t have a specific answer for that yet.");
      addBubble(html.replace('</div>', `${confBadge()}</div>`));
    }
  }catch(err){
    close();
    dbgStatus.textContent='error';
    addBubble(`<div class="answer"><p>Something went wrong: ${esc(String(err))}</p>${confBadge()}</div>`);
  }
}

// ===== Controls/shortcuts =====
function resetChat(){
  thread.innerHTML='';
  addBubble('Hi! I can help with workshops, tuition, and photography advice.');
  [dbgStatus,dbgHeaders,dbgReq,dbgRes,dbgStruct,dbgProv,dbgNote].forEach(el=>{if(!el)return;el.textContent=el.id==='dbg-status'?'â€“':'â€“';});
  sessionStorage.removeItem(STORAGE_KEY);
}
function submit(){
  const v=input.value.trim();
  if(!v) return;
  addBubble(esc(v),{user:true});
  input.value='';
  sendQuery(v);
}
sendBtn.addEventListener('click',submit);
input.addEventListener('keydown',e=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); submit(); }
});
btnEmail.addEventListener('click',emailTranscript);
btnDownload.addEventListener('click',downloadTranscript);
btnReset.addEventListener('click',resetChat);
btnFocus.addEventListener('click',()=>input.focus());

document.addEventListener('keydown',e=>{
  const mod=e.metaKey||e.ctrlKey;
  if(mod && e.key.toLowerCase()==='k'){ e.preventDefault(); input.focus(); }
  if(mod && e.key.toLowerCase()==='r'){ e.preventDefault(); resetChat(); }
  if(mod && e.key.toLowerCase()==='e'){ e.preventDefault(); emailTranscript(); }
  if(mod && e.key.toLowerCase()==='d'){ e.preventDefault(); document.getElementById('debugPanel').open = !document.getElementById('debugPanel').open; }
});

// ===== Debug copy =====
dbgCopy?.addEventListener('click',()=>{
  const all=[
    'Endpoint: '+document.getElementById('dbg-endpoint').textContent,
    'Status: '+dbgStatus.textContent,
    'Headers:\n'+dbgHeaders.textContent,
    'Request:\n'+dbgReq.textContent,
    'Response:\n'+dbgRes.textContent,
    'Structured:\n'+dbgStruct.textContent,
    'Provenance:\n'+dbgProv.textContent,
    'Note:\n'+dbgNote.textContent
  ].join('\n\n');
  navigator.clipboard.writeText(all).then(()=>{
    dbgCopy.textContent='Copied!'; setTimeout(()=>dbgCopy.textContent='Copy all',1500);
  });
});

// ===== Initial focus =====
if(!sessionStorage.getItem(STORAGE_KEY)) setTimeout(()=>input.focus(), 350);

</script>
</body>
</html>
