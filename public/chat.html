<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Alan Ranger Assistant</title>
<style>
  :root {
    --bg:#0b1220; --panel:#0f172a; --line:#1b2540; --text:#dbe4ff;
    --muted:#9fb3ff; --brand:#E57200;
  }
  * { box-sizing:border-box }
  body { margin:0; font:15px/1.55 system-ui,-apple-system,Segoe UI,Inter,Roboto,sans-serif; background:var(--bg); color:var(--text); }
  .wrap { max-width:920px; margin:0 auto; padding:24px; }
  .card { background:var(--panel); border:1px solid var(--line); border-radius:14px; overflow:hidden; }
  .brandbar { background:var(--brand); height:6px; }
  .header { display:flex; align-items:center; gap:12px; padding:16px; }
  .logo { width:40px; height:40px; border-radius:50%; overflow:hidden; background:#000; display:flex; align-items:center; justify-content:center; }
  .logo img { width:40px; height:40px; display:block; }
  .title { font-size:18px; font-weight:700; }
  .status { margin-left:auto; font-size:12px; color:var(--muted); }
  .hint { font-size:14px; color:var(--muted); padding:0 16px 12px; }
  .chat { padding:16px; max-height:68vh; overflow-y:auto; }
  .msg { display:flex; margin:12px 0; }
  .msg.user { justify-content:flex-end; }
  .bubble { max-width:76%; padding:12px 14px; border-radius:12px; white-space:pre-wrap; animation:fadeInUp .25s ease; }
  .bubble.user { background:#13203e; }
  .bubble.bot { background:#0b1328; }
  @keyframes fadeInUp { from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }
  .sources { margin-top:10px; display:flex; flex-wrap:wrap; gap:6px; }
  .chip { background:#0b1426; border:1px solid var(--line); border-radius:999px; padding:4px 10px; font-size:12px; }
  .chip a { color:#9ccaff; text-decoration:none; }
  .typing { color:var(--muted); font-size:13px; margin:2px 16px 10px; display:flex; gap:4px; }
  .dot { width:6px; height:6px; background:var(--muted); border-radius:50%; animation:bounce 1s infinite; }
  .dot:nth-child(2){animation-delay:0.2s} .dot:nth-child(3){animation-delay:0.4s}
  @keyframes bounce { 0%,80%,100%{transform:scale(0.6)} 40%{transform:scale(1)} }
  .composer { display:flex; gap:8px; padding:12px 16px; border-top:1px solid var(--line); }
  .composer input { flex:1; background:#0b1426; border:1px solid var(--line); border-radius:8px; padding:12px; color:var(--text); }
  .composer button { background:var(--brand); border:0; color:#fff; border-radius:8px; padding:0 16px; cursor:pointer; }
  .bubble.bot b { font-weight:700; }
  .bubble.bot ul { margin:6px 0 0 16px; padding:0; }
  .bubble.bot li { margin:4px 0; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="brandbar"></div>
    <div class="header">
      <div class="logo">
        <img src="/alanranger_bot_avatar_v2.png" alt="Alan Ranger" onerror="this.src='/ALAN%20RANGER%20ICON%20WHITE%20on%20Black%20Circle1.png'">
      </div>
      <div class="title">Alan Ranger Assistant</div>
      <div class="status" id="status">ready</div>
    </div>
    <p class="hint">Ask me about workshops, courses, tips, or photography gear — I’ll give concise, cited answers.</p>

    <div id="chat" class="chat"></div>
    <div id="typing" class="typing" style="display:none">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>

    <div class="composer">
      <input id="q" placeholder="Ask a question… (Shift+Enter for newline)"/>
      <button id="send">Send</button>
    </div>
  </div>
</div>

<script>
const chat = document.getElementById('chat');
const q = document.getElementById('q');
const sendBtn = document.getElementById('send');
const typing = document.getElementById('typing');
const statusEl = document.getElementById('status');

/* Read token saved by bulk.html */
const TOKEN = localStorage.getItem('ingest_token') || '';

function addBubble(html, who='bot', cites=[]) {
  const m = document.createElement('div'); m.className = 'msg ' + who;
  const b = document.createElement('div'); b.className = 'bubble ' + who;
  b.innerHTML = html;
  if (who === 'bot' && cites.length) {
    const src = document.createElement('div'); src.className = 'sources';
    cites.slice(0,6).forEach(u => {
      const chip = document.createElement('span'); chip.className='chip';
      chip.innerHTML = `<a href="${u}" target="_blank" rel="noopener">${u}</a>`;
      src.appendChild(chip);
    });
    b.appendChild(src);
  }
  m.appendChild(b);
  chat.appendChild(m);
  chat.scrollTop = chat.scrollHeight;
}

function mdLight(s='') {
  s = s.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
  s = s.replace(/(^|\n)-\s+/g, '$1• ');
  return s;
}

function setTyping(v){ typing.style.display = v ? 'flex' : 'none'; }
function setReady(v){ statusEl.textContent = v ? 'ready' : '…'; }

async function ask() {
  const text = q.value.trim();
  if (!text) return;
  addBubble(text, 'user');
  q.value = '';
  setTyping(true); setReady(false);

  try {
    const r = await fetch('/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type':'application/json',
        'Authorization': 'Bearer ' + TOKEN   /* <-- forward Bearer token */
      },
      body: JSON.stringify({ query: text, topK: 8 })
    });
    const j = await r.json();
    const ans = j && j.answer ? j.answer : 'I do not know.';
    addBubble(mdLight(ans), 'bot', Array.from(new Set(j?.citations || [])));
  } catch (e) {
    addBubble('Sorry — I had trouble contacting the server.');
  } finally {
    setTyping(false); setReady(true);
  }
}

sendBtn.onclick = ask;
q.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); ask(); }
});

addBubble('Hi! I can help with workshops, tuition, and photography advice.', 'bot');
</script>
</body>
</html>
