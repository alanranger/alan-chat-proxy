<script>
/* ================= Config ================= */
const CHAT_ENDPOINT = '/api/chat';
const urlParams = new URLSearchParams(location.search);
if (urlParams.get('debug') === '1') requestAnimationFrame(()=>{ const p=document.getElementById('debugPanel'); if(p) p.open = true; });

/* Optional tag-page fallback for articles (safe, non-search) */
const ARTICLE_TAG_GUESS = {
  bluebell: 'https://www.alanranger.com/blog?tag=bluebell',
  bluebells: 'https://www.alanranger.com/blog?tag=bluebell',
  devon: 'https://www.alanranger.com/blog?tag=devon',
  woodland: 'https://www.alanranger.com/blog?tag=woodland'
};

/* ================= DOM refs ================= */
const thread = document.getElementById('thread');
const input  = document.getElementById('q');
const sendBtn= document.getElementById('send');
const btnEmail = document.getElementById('btn-email');
const btnReset = document.getElementById('btn-reset');

const dbgStatus = document.getElementById('dbg-status');
const dbgReq    = document.getElementById('dbg-req');
const dbgRes    = document.getElementById('dbg-res');
const dbgHeaders= document.getElementById('dbg-headers');
const dbgStruct = document.getElementById('dbg-struct');
const dbgProv   = document.getElementById('dbg-prov');
const dbgCopy   = document.getElementById('dbg-copy');
const dbgNote   = document.getElementById('dbg-note');

function safeJSONString(v){ try{ return JSON.stringify(v,null,2); }catch{ return String(v); } }

/* Clipboard in debug panel */
dbgCopy?.addEventListener('click', ()=>{
  const all = [
    'Status: '+(dbgStatus?.textContent ?? ''),
    'Headers:\n'+(dbgHeaders?.textContent ?? ''),
    'Request:\n'+(dbgReq?.textContent ?? ''),
    'Response:\n'+(dbgRes?.textContent ?? ''),
    'Structured:\n'+(dbgStruct?.textContent ?? ''),
    'Provenance:\n'+(dbgProv?.textContent ?? ''),
    'Note:\n'+(dbgNote?.textContent ?? '')
  ].join('\n\n');
  navigator.clipboard.writeText(all).then(()=>{ dbgCopy.textContent='Copied!'; setTimeout(()=>dbgCopy.textContent='Copy all',1500); });
});

/* ================= UI helpers ================= */
let __lastConfidencePct = null;
let __lastQuery = '';
let __lastAnsweredAt = '';

function addBubble(html, opts={}) {
  const div = document.createElement('div');
  div.className = 'bubble' + (opts.user ? ' user' : '');
  div.innerHTML = html;
  thread.appendChild(div);
  div.scrollIntoView({behavior:'smooth', block:'end'});
  return div;
}
function addTyping() {
  // Always show typing immediately
  const el = addBubble('<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>');
  let removed = false;
  return ()=>{ if (!removed) { removed = true; el.remove(); } };
}
function mdToHtml(md){
  if (!md) return { html:'', liIds:[], items:[] };
  let s = md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  s = s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  const lines = s.split(/\r?\n/);
  let out='', inList=false;
  const flush = ()=>{ if(inList){ out+='</ul>'; inList=false; } };
  for (const line of lines){
    const m = line.match(/^\s*-\s+(.*)$/);
    if (m){ if(!inList){ out+='<ul>'; inList=true; } out += `<li>${m[1].trim()}</li>`; }
    else { flush(); out += line.trim()? `<p>${line}</p>` : ''; }
  }
  flush();
  return { html:`<div class="answer">${out}</div>` };
}
function fmtDate(iso){
  try{ return new Date(iso).toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short',year:'numeric'});}catch{ return iso; }
}
function currency(amount, ccy){
  if(amount==null || amount==='') return null;
  const n = Number(amount); if(!isFinite(n)) return null;
  try{ return new Intl.NumberFormat(undefined,{style:'currency',currency:ccy||'GBP',maximumFractionDigits:0}).format(n); }
  catch{ return `£${String(amount).replace(/\.00$/,'')}`; }
}
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]) ) }

/* Timestamp + confidence badge */
function renderConfidenceBadge(){
  const pct = __lastConfidencePct;
  if(pct==null || isNaN(pct)) return '';
  const ts = __lastAnsweredAt || new Date().toLocaleString();
  return `<div class="conf">Confidence: ${pct}%</div><span class="meta" style="margin-left:8px">Answered: ${ts}</span>`;
}

/* ================= Product helpers ================= */
function firstSentence(t){
  const s = String(t||'').trim();
  if(!s) return '';
  const m = s.match(/^(.*?\.)\s|^(.+)$/);
  return m ? (m[1] ? m[1].trim() : m[2].trim()) : s;
}
function mergeProducts(list){
  if(!Array.isArray(list) || !list.length) return [];
  const map = new Map();
  for(const p of list){
    const key = (p.url || p.page_url || p.source_url || p.title || '').toLowerCase();
    if(!map.has(key)) { map.set(key, JSON.parse(JSON.stringify(p))); continue; }
    const m = map.get(key);
    for(const k of ['price','price_currency','availability','provider','description','title']) if(m[k]==null && p[k]!=null) m[k]=p[k];
    const mAgg = m?.raw?.offers?.lowPrice!=null || m?.raw?.offers?.highPrice!=null;
    const pAgg = p?.raw?.offers?.lowPrice!=null || p?.raw?.offers?.highPrice!=null;
    if(pAgg && !mAgg){ m.raw = m.raw || {}; m.raw.offers = Object.assign({}, m.raw.offers, {lowPrice:p.raw.offers.lowPrice, highPrice:p.raw.offers.highPrice, priceCurrency:p.raw.offers.priceCurrency}); }
    if(p?.raw?.offers?.price!=null && m?.raw?.offers?.price==null){ m.raw = m.raw || {}; m.raw.offers = Object.assign({}, m.raw.offers, {price:p.raw.offers.price, priceCurrency:p.raw.offers.priceCurrency}); }
  }
  return [...map.values()];
}
function extractFacts(desc){
  const txt = String(desc||'')
    .split(/\r?\n/)
    .map(l=>l.trim())
    .filter(Boolean);

  const findAfter = (label)=>{
    const re1 = new RegExp('^' + label.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + '\\s*:?$', 'i');
    const re2 = new RegExp('^' + label.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + '\\s*:?\\s+(.+)$','i');
    const i = txt.findIndex(l=>re1.test(l));
    if(i>=0 && i+1<txt.length) return txt[i+1];
    const flat = txt.find(l=>re2.test(l));
    if(flat) return flat.replace(re2,'$1');
    return null;
  };
  const location     = findAfter('Location');
  const participants = findAfter('Participants');
  const fitness      = findAfter('Fitness');
  const availability = findAfter('Availability');

  const optionLines = txt.filter(l =>
    /^\s*(?:4\s*hrs?|4\s*hours?|half\s*day|1\s*day|full\s*day|day)\b/i.test(l) ||
    /^\s*OR\s*1\s*day\b/i.test(l)
  );

  return {location, participants, fitness, availability, optionLines};
}
function parseExtraPriceFromText(desc){
  const m = String(desc||'').match(/\b(?:1\s*day|full\s*day)\b[^£\d]{0,12}(£?\s?\d{2,4})/i);
  if(!m) return null;
  const s = m[1].replace(/[^\d.]/g,'');
  const n = Number(s);
  return isFinite(n) ? n : null;
}
function deriveOptions(prod, facts){
  const ccy = prod.price_currency || prod?.raw?.offers?.priceCurrency || 'GBP';
  const base = prod.price ?? prod?.raw?.offers?.price;
  let low  = prod?.raw?.offers?.lowPrice;
  let high = prod?.raw?.offers?.highPrice;

  if((low==null || high==null) && base!=null){
    const extra = parseExtraPriceFromText(prod.description||'');
    if(extra!=null && extra!==base){
      low = Math.min(base, extra);
      high= Math.max(base, extra);
    }
  }

  const text = (facts.optionLines||[]).join('\n').toLowerCase();
  const has4h  = /(?:^|\n)\s*(?:4\s*hrs?|4\s*hours?|half\s*day)\b/.test(text);
  const has1d  = /(?:^|\n)\s*(?:1\s*day|full\s*day|day)\b/.test(text);

  const opts = [];

  if(low!=null && high!=null && has4h && has1d){
    opts.push({label:'4 hours', price:currency(low,ccy)});
    opts.push({label:'1 day',   price:currency(high,ccy)});
  } else {
    if(base!=null) opts.push({label:'Standard', price:currency(base,ccy)});
    if(low!=null || high!=null){
      const range = [low,high].filter(v=>v!=null).map(v=>currency(v,ccy)).join(' – ');
      if(range) opts.push({label:'Pricing', price:range});
    }
  }

  const timePat = /(\d{1,2}:\d{2}\s*(?:am|pm))\s*[–-]\s*(\d{1,2}:\d{2}\s*(?:am|pm))(?:\s*or\s*(\d{1,2}:\d{2}\s*(?:am|pm))\s*[–-]\s*(\d{1,2}:\d{2}\s*(?:am|pm)))?/i;
  for(const ln of facts.optionLines||[]){
    const label = ln.replace(/\s*—.*$/,'').replace(/^OR\s*/i,'').trim();
    const tm = ln.match(timePat);
    const window = tm ? `${tm[1]} – ${tm[2]}${tm[3]?` or ${tm[3]} – ${tm[4]}`:''}` : null;
    if(label && !opts.some(o=>o.label.toLowerCase()===label.toLowerCase())){
      opts.push({label, time:window});
    } else if(window){
      const o = opts.find(o=>o.label.toLowerCase()===label.toLowerCase());
      if(o && !o.time) o.time = window;
    }
  }
  return opts;
}

/* ================= Event helpers ================= */
const STOP = new Set(['the','and','or','what','whats','when','whens','next','cost','workshop','workshops','photography','photo','near','me','uk','warks','warwickshire','devonshire']);
function extractKeywords(topic, query){
  const src = [topic||'', query||''].join(' ').toLowerCase();
  const words = Array.from(new Set(src.match(/[a-z]+/g)||[]));
  const geos = ['devon','warwickshire','warks','coventry','peak','district','lake','lakes','yorkshire','moor','moors','snowdonia'];
  const keep = words.filter(w => !STOP.has(w) || geos.includes(w));
  return keep;
}
function eventMatches(e, kws){
  if(!kws.length) return true;
  const hay = ((e.title||'')+' '+(e.location||'')).toLowerCase();
  return kws.some(k=>hay.includes(k));
}

/* ================= Article ranking (≥60%) ================= */
function tokenScore(query, title, desc=''){
  const toks = (s)=> (s||'').toLowerCase().match(/[a-z]{3,}/g)||[];
  const a = new Set(toks(query));
  const b = new Set([ ...toks(title), ...toks(desc) ]);
  if(!a.size || !b.size) return 0;
  let inter=0; a.forEach(t=>{ if(b.has(t)) inter++; });
  const jacc = inter / (a.size + b.size - inter);
  return Math.round(jacc * 100);
}
function rankArticles(query, list){
  return (list||[]).map(a=>{
    const provided = Number(a.match_pct ?? a.match ?? a.score);
    const t = a.title || a.raw?.name || '';
    const d = a.description || a.snippet || '';
    const s = isFinite(provided) ? provided : tokenScore(query, t, d);
    const url = a.page_url || a.source_url || a.url;
    return { ...a, __score: s, __url: url, __title: t };
  }).filter(a=>a.__url).sort((x,y)=>y.__score - x.__score);
}

/* ================= Renderers ================= */
function renderConfidenceBadge(){
  const pct = __lastConfidencePct;
  if(pct==null || isNaN(pct)) return '';
  const ts = __lastAnsweredAt || new Date().toLocaleString();
  return `<div class="conf">Confidence: ${pct}%</div><span class="meta" style="margin-left:8px">Answered: ${ts}</span>`;
}
function renderProductCard(prod){
  const facts = extractFacts(prod.description||'');
  const options = deriveOptions(prod, facts);

  const lines = [];
  const md = firstSentence(prod.description||'');
  if(md) lines.push(`<p class="meta">${escapeHTML(md)}</p>`);

  if(facts.location)     lines.push(`<p class="kvline"><strong>Location:</strong> ${escapeHTML(facts.location)}</p>`);
  if(facts.participants) lines.push(`<p class="kvline"><strong>Participants:</strong> ${escapeHTML(facts.participants)}</p>`);
  if(facts.fitness)      lines.push(`<p class="kvline"><strong>Fitness:</strong> ${escapeHTML(facts.fitness)}</p>`);
  if(prod.availability || facts.availability){
    const avail = (prod.availability||facts.availability||'').toString().replace(/^https?:\/\/schema\.org\//i,'').replace(/([a-z])([A-Z])/g,'$1 $2');
    lines.push(`<p class="kvline"><strong>Availability:</strong> ${escapeHTML(avail)}</p>`);
  }

  const li = options.map(o=>{
    const bits = [escapeHTML(o.label||''), o.time ? `— ${escapeHTML(o.time)}` : null, o.price ? `— ${o.price}` : null].filter(Boolean).join(' ');
    return `<li>${bits}</li>`;
  }).join('');

  return `
    <div class="answer">
      <h3>${escapeHTML(prod.title || 'Workshop')}</h3>
      ${lines.join('')}
      ${li? `<ul>${li}</ul>`:''}
      ${renderConfidenceBadge()}
    </div>
  `;
}
function renderEventsBlock(structured, productHasLocation){
  const now=new Date();
  const all=(structured?.events||[])
    .filter(e=>e?.date_start && !isNaN(Date.parse(e.date_start)) && new Date(e.date_start)>=now);

  const kws = extractKeywords(structured?.topic||'', __lastQuery);
  const filtered = all.filter(e=>eventMatches(e, kws));
  const list = filtered.length ? filtered : all;
  if(!list.length) return '';

  const topic = (structured?.topic||'').toString().trim();
  const titleKW = kws.find(k=>k && !STOP.has(k));
  const friendlyTitle = titleKW ? `Upcoming ${titleKW[0].toUpperCase()+titleKW.slice(1)} Workshops` :
    (topic ? `Upcoming ${escapeHTML(topic.replace(/,?\s*(whats?|whens?|next|cost)/gi,'').trim())} Workshops` : 'Upcoming Workshops');

  const lis = list
    .sort((a,b)=>new Date(a.date_start)-new Date(b.date_start))
    .map(e=>{
      const when=fmtDate(e.date_start);
      const href=e.page_url||e.source_url||e.url||'#';
      const loc=e.location||'';
      const locPart = (!productHasLocation && loc) ? ` — ${escapeHTML(loc)}` : '';
      return `<li>${when} — <a href="${href}" target="_blank" rel="noopener">Link</a>${locPart}</li>`;
    }).join('');

  return `<div class="answer"><h3>${friendlyTitle}</h3><ul>${lis}</ul>${renderConfidenceBadge()}</div>`;
}
function renderArticlesBlock(structured){
  let ranked = rankArticles(__lastQuery, structured?.articles||[]).filter(a=>a.__score>=60).slice(0,5);
  if(!ranked.length){
    const topic = (structured?.topic||'').toLowerCase();
    let url = null;
    for(const [kw,u] of Object.entries(ARTICLE_TAG_GUESS)){ if(topic.includes(kw)){ url=u; break; } }
    if(url) ranked = [{ __title:'Related articles', __url:url, __score:100 }];
  }
  if(!ranked.length) return '';
  const lis = ranked.map(a=>`<li><a href="${a.__url}" target="_blank" rel="noopener">${escapeHTML(a.__title)}</a></li>`).join('');
  return `<div class="answer"><h3>Guides that match your question</h3><ul>${lis}</ul>${renderConfidenceBadge()}</div>`;
}
function buildActionPillsFromStructured(structured){
  const safe = [];
  const used = new Set();
  const add = (label, href) => {
    if(!label || !href) return;
    const u = String(href);
    if (/\/search\?query=/.test(u)) return;
    const key = `${label}::${u}`;
    if(used.has(key)) return;
    used.add(key);
    safe.push({label,href});
  };

  for (const p of (structured?.pills || structured?.chips || [])){
    add(p.label || p.text || 'Open', p.url || p.href);
  }

  const ranked = rankArticles(__lastQuery, structured?.articles||[]).filter(a=>a.__score>=60);
  if(ranked.length){
    ranked.slice(0,2).forEach(a=> add(a.__title || 'Related article', a.__url));
  } else {
    const topic = (structured?.topic||'').toLowerCase();
    for(const [kw,url] of Object.entries(ARTICLE_TAG_GUESS)){
      if(topic.includes(kw)){ add('Related articles', url); break; }
    }
  }
  return safe.slice(0,5);
}

/* Confidence heuristic (client-side floor) */
function heuristicConfidence(structured){
  let score = 0;
  if (structured?.products?.length) score += 40;
  if (structured?.events?.length)   score += 40;
  if (structured?.articles?.length) score += 20;
  return Math.min(95, Math.max(20, score || 25));
}

/* Full render */
function renderAnswer(payload){
  __lastAnsweredAt = new Date().toLocaleString();
  const s = payload.structured||{};
  let confidencePct = (typeof payload.confidence_pct === 'number') ? payload.confidence_pct : null;
  const heuristic = heuristicConfidence(s);
  if (confidencePct == null || confidencePct < 50) confidencePct = heuristic;
  __lastConfidencePct = Math.round(confidencePct);

  const merged = mergeProducts(s.products||[]);
  const prod = merged[0] || null;

  if(prod) addBubble(renderProductCard(prod));

  const productFacts = prod ? extractFacts(prod.description||'') : null;
  const productHasLocation = !!(productFacts && productFacts.location);
  const evHTML = renderEventsBlock(s, productHasLocation);
  if(evHTML) addBubble(evHTML);

  const artHTML = renderArticlesBlock(s);
  if(artHTML) addBubble(artHTML);

  const pills = buildActionPillsFromStructured(s);
  if(pills.length){
    const wrap = document.createElement('div');
    wrap.className='actions';
    pills.forEach(p=>{
      const a=document.createElement('a'); a.className='pill'; a.textContent=p.label;
      a.href=p.href; a.target='_blank'; a.rel='noopener';
      wrap.appendChild(a);
    });
    thread.appendChild(wrap);
  }

  if(!prod && !(s.events||[]).length && !(s.articles||[]).length){
    const md = payload.answer_markdown || payload.answer || '';
    const extra = `<p>If this doesn’t answer your question, please use the Contact or WhatsApp buttons in the header to reach Alan directly.</p>`;
    const {html}=mdToHtml(md || "I don’t have a specific answer for that yet.");
    addBubble(html.replace('</div>', `${extra}${renderConfidenceBadge()}</div>`));
  }

  dbgStruct && (dbgStruct.textContent = safeJSONString(payload.structured||{}));
  dbgNote   && (dbgNote.textContent   = safeJSONString({ confidence_pct: __lastConfidencePct, answered_at: __lastAnsweredAt }));
}

/* ================= Networking ================= */
async function sendQuery(query){
  __lastQuery = String(query||'');
  const req = { query, topK: 8 };
  dbgReq && (dbgReq.textContent = safeJSONString(req));

  const closeTyping = addTyping(); // show dots immediately
  try{
    const res = await fetch(CHAT_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(req)
    });
    dbgStatus && (dbgStatus.textContent = res.status);
    const headers = {}; res.headers.forEach((v,k)=>headers[k]=v);
    dbgHeaders && (dbgHeaders.textContent = safeJSONString(headers));

    const data = await res.json();
    dbgRes && (dbgRes.textContent = safeJSONString(data));
    dbgProv && (dbgProv.textContent = safeJSONString({ citations: data.citations || [] }));

    closeTyping();
    if (data && (data.answer_markdown || data.answer || (data.structured && (data.structured.products?.length || data.structured.events?.length || data.structured.articles?.length)))) {
      renderAnswer(data);
    } else {
      const fallback = "I don’t have a specific answer for that yet.";
      const {html}=mdToHtml(fallback);
      const extra = `<p>If this doesn’t answer your question, please use the Contact or WhatsApp buttons in the header to reach Alan directly.</p>`;
      addBubble(html.replace('</div>', `${extra}${renderConfidenceBadge()}</div>`));
    }
  } catch (err){
    closeTyping();
    dbgStatus && (dbgStatus.textContent = 'error');
    addBubble(`<div class="answer"><p>Something went wrong: ${escapeHTML(String(err))}</p><p>If it continues, please use the Contact form or WhatsApp buttons above.</p>${renderConfidenceBadge()}</div>`);
  }
}

/* ================= Transcript helpers ================= */
function nodeToPlain(div){
  return div.textContent.replace(/\s+\n/g,'\n').replace(/\n{3,}/g,'\n\n').trim();
}
function buildTranscript(){
  const rows = [];
  rows.push('Alan Ranger Assistant — transcript');
  rows.push(new Date().toISOString());
  rows.push('');
  for (const el of thread.children){
    if (el.classList.contains('actions')) continue;
    const role = el.classList.contains('user') ? 'User' : 'Assistant';
    rows.push(`${role}:\n${nodeToPlain(el)}`);
    rows.push('');
  }
  return rows.join('\n');
}
function emailTranscript(){
  const body = buildTranscript();
  const subject = 'Alan Ranger Assistant chat transcript';
  const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body.slice(0,2000))}`;
  if (body.length > 2000){
    const blob = new Blob([body], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    addBubble(`<div class="answer"><p>Transcript is quite long. You can <a href="${url}" download="alan-ranger-assistant-transcript.txt">download the full transcript</a> or use the shortened email draft that just opened.</p>${renderConfidenceBadge()}</div>`);
  }
  location.href = mailto;
}
function resetChat(){
  thread.innerHTML = '';
  addBubble('Hi! I can help with workshops, tuition, and photography advice.');
  [dbgStatus, dbgHeaders, dbgReq, dbgRes, dbgStruct, dbgProv, dbgNote].forEach(el=>{ if(!el) return; el.textContent = el.id==='dbg-status' ? '–' : '–'; });
}

/* ================= Wire up composer & tools ================= */
function submit(){
  const val = (input?.value || '').trim();
  if(!val) return;
  addBubble(val, {user:true});
  input.value='';
  sendQuery(val);
}
/* Ensure listeners bind even if earlier parts fail */
try{
  sendBtn?.addEventListener('click', submit);
  input?.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); submit(); } });
  btnEmail?.addEventListener('click', emailTranscript);
  btnReset?.addEventListener('click', resetChat);
}catch(err){ console.error(err); }
</script>
