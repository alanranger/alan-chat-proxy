<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Alan Ranger Assistant</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0e1726; --panel:#121C2D; --text:#DDE7F6; --muted:#93A4C1; --bubble:#1B2A44;
  --brand:#E57200; --wa:#25D366; --ring:rgba(229,114,0,.35);
  --input-bg:#E9EEF5; --input-text:#0b0f16; --input-border:#CBD5E1; --input-ph:#6b7280;
  --link:#9cd3ff; --link-hover:#cfe7ff;
  --user-bg:#e6edf7; --user-text:#0b0f16;

  --status-green-bg:#12381e; --status-green-br:#245f3a; --status-green-tx:#b8f3c7;
  --status-amber-bg:#3a2d0c; --status-amber-br:#6f5616; --status-amber-tx:#ffeab0;
  --status-red-bg:#3c161b; --status-red-br:#6f2831; --status-red-tx:#ffc3cc;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;line-height:1.45}
.wrap{max-width:980px;margin:28px auto;padding:0 16px;position:relative}
.badge-wrap{position:relative;height:0}
.version{position:absolute;top:8px;right:0;background:#0b1422;border:1px solid #1b2540;border-radius:999px;padding:2px 8px;font-size:11px;color:#9eb2d3}
.card{background:var(--panel);border-radius:14px;box-shadow:0 6px 22px rgba(0,0,0,.35);border-top:6px solid var(--brand);padding:28px}

/* =========================
   HERO / HEADER (EDITABLE)
   ========================= */
.header-sticky{position:sticky; top:10px; z-index:50; background:linear-gradient(180deg, rgba(18,28,45,.98), rgba(18,28,45,.98)); border-radius:12px; padding:10px 10px 14px; margin:-8px -8px 12px -8px;}
.header{display:flex;flex-direction:column;gap:10px;margin-bottom:12px}

/* Center logo + title together on one line */
.head-row{display:flex;justify-content:center;align-items:center;gap:14px}
.logo{display:block;height:46px;width:auto;object-fit:contain;object-position:center;filter:drop-shadow(0 2px 6px rgba(0,0,0,.45))}
.title{margin:0;font-size:44px;font-weight:300;letter-spacing:.2px;line-height:1.1;text-align:center}

/* Intro paragraph: 70% width, centered, comfy line-height, buttons inline */
.sub{
  margin:0 auto;                 /* center it */
  color:var(--muted);
  max-width:70%;                 /* 70% of card width */
  font-size:16px;
  line-height:1.7;               /* airier */
  text-align:center;
}
/* Make the inline buttons feel natural inside the paragraph */
.sub .pill{
  display:inline-flex; align-items:center;
  font-size:14px; font-weight:600;
  padding:8px 12px; border-radius:28px; border:0;
  margin-left:12px;               /* gap from preceding text */
  vertical-align:baseline;
}
.pill--brand{background:var(--brand); color:#0b0f16}
.pill--wa{background:var(--wa); color:#0b0f16}

/* Smaller screens: widen the intro a touch and scale down sizes */
@media (max-width:720px){
  .logo{height:40px}
  .title{font-size:34px}
  .sub{max-width:88%; font-size:15px; line-height:1.6}
  .sub .pill{font-size:13px;padding:7px 10px;margin-left:10px}
}

/* Chat surface */
.chat{margin-top:12px;border-radius:14px;background:#0f1828;padding:18px}
.thread{display:flex;flex-direction:column;gap:12px}
.bubble{background:var(--bubble);padding:14px 16px;border-radius:12px;max-width:780px}
.bubble.user{align-self:flex-end;background:var(--user-bg);color:var(--user-text);border:1px solid #d3deee}
.answer h1,.answer h2,.answer h3{margin:.2em 0}
.answer p{margin:.5em 0}
.answer ul{margin:.4em 0 .6em 1.25em}
.answer li{margin:.2em 0}
.answer a{color:var(--link);text-decoration:underline}
.answer a:hover{color:var(--link-hover)}
.meta{color:var(--muted);font-size:14px}
.kvline{margin:0}
.kvline strong{font-weight:600}

/* Status footer row */
.footer-status{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:12px}
.badge{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:8px 14px;font-weight:800;letter-spacing:.2px;border:1px solid #1c2a46;background:#0f1b31;color:#cfe3ff}
.badge.small{padding:6px 10px;font-size:12px}
.badge.ts{font-size:12px;font-weight:500;opacity:.9;}
.badge.conf{background:#13233f;border-color:#263d68}
.badge.conf.green{background:var(--status-green-bg);border-color:var(--status-green-br);color:var(--status-green-tx)}
.badge.conf.amber{background:var(--status-amber-bg);border-color:var(--status-amber-br);color:var(--status-amber-tx)}
.badge.conf.red{background:var(--status-red-bg);border-color:var(--status-red-br);color:var(--status-red-tx)}

/* Global pill row */
.actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
.actions .pill{background:var(--brand);color:#0b0f16;border:none}

/* Composer + utilities */
.tools{display:flex;justify-content:flex-end;gap:10px;margin:8px 0 6px}
.tools button{background:#13203e;color:#cfe3ff;border:1px solid #2a3b61;border-radius:8px;padding:6px 10px;font-size:13px;cursor:pointer}
.tools button:hover{border-color:#3c548b}
.composer{display:flex;gap:10px;margin-top:8px;padding:12px;background:var(--panel);border-radius:12px}
.composer input{flex:1;background:var(--input-bg);color:var(--input-text);border:1px solid #CBD5E1;border-radius:10px;padding:12px 14px;outline:0}
.composer input::placeholder{color:var(--input-ph)}
.composer input:focus{border-color:var(--ring);box-shadow:0 0 0 4px var(--ring)}
.send{background:var(--brand);color:var(--user-text);font-weight:700;border:0;border-radius:10px;padding:0 18px;cursor:pointer}

/* Debug panel */
details.debug{margin-top:14px;background:#0f1828;border:1px solid #15223a;border-radius:10px;padding:10px 12px}
details.debug summary{cursor:pointer;color:#9eb2d3;font-weight:600;outline:none}
.kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin-top:10px}
.kv label{color:#93A4C1}
pre.json{white-space:pre-wrap;word-break:break-word;margin:0;padding:8px;background:#0b1422;border:1px solid #15223a;border-radius:8px;color:#cfe3ff;font-size:12px;line-height:1.4}

/* Typing dots */
.typing{position:relative;display:inline-block}
.typing .dot{display:inline-block;width:6px;height:6px;margin:0 2px;border-radius:50%;background:#9eb2d3;opacity:.6;animation:bounce 1.2s infinite}
.typing .dot:nth-child(2){animation-delay:.15s}
.typing .dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-4px)}}
</style>
</head>
<body>
<div class="wrap">
  <div class="badge-wrap"><span class="version">v1.1.4</span></div>

  <div class="card">
    <!-- =========================
         HERO / HEADER (EDITABLE)
         ========================= -->
    <div class="header-sticky">
      <div class="header">
        <div class="head-row">
          <img class="logo" src="./chat%20white.png" alt="AR logo">
          <h2 class="title">Alan Ranger Assistant</h2>
        </div>

        <p class="sub">
          Iâ€™m Alanâ€™s AI assistant, trained on content from this website to help with workshops, tuition, and
          photography questions. I wonâ€™t always get everything right â€” if I canâ€™t help, please contact Alan directly:
          <a class="pill pill--brand" target="_blank" rel="noopener" href="https://www.alanranger.com/contact-us-alan-ranger-photography">Contact form</a>
          <a class="pill pill--wa" target="_blank" rel="noopener" href="https://wa.me/447817017994">WhatsApp</a>
        </p>
      </div>
    </div>

    <div class="chat">
      <div id="thread" class="thread">
        <div class="bubble">Hi! I can help with workshops, tuition, and photography advice.</div>
      </div>

      <!-- Utility buttons -->
      <div class="tools">
        <button id="btn-email">Email transcript</button>
        <button id="btn-reset">Reset chat</button>
      </div>

      <details id="debugPanel" class="debug">
        <summary>ðŸ”Ž Show debug</summary>
        <button id="dbg-copy" style="margin:8px 0 12px;padding:6px 10px;border-radius:6px;border:1px solid #334;color:#cfe3ff;background:#13203e;cursor:pointer">Copy all</button>
        <div class="kv"><label>Endpoint</label><div>/api/chat</div></div>
        <div class="kv"><label>Status</label><div id="dbg-status">â€“</div></div>
        <div class="kv"><label>Server ver</label><div id="dbg-srvver">â€“</div></div>
        <div class="kv"><label>Headers</label><pre id="dbg-headers" class="json">â€“</pre></div>
        <div class="kv"><label>Request</label><pre id="dbg-req" class="json">â€“</pre></div>
        <div class="kv"><label>Response</label><pre id="dbg-res" class="json">â€“</pre></div>
        <div class="kv"><label>Structured</label><pre id="dbg-struct" class="json">â€“</pre></div>
        <div class="kv"><label>Provenance</label><pre id="dbg-prov" class="json">â€“</pre></div>
        <div class="kv"><label>Note</label><pre id="dbg-note" class="json">â€“</pre></div>
      </details>

      <div class="composer">
        <input id="q" placeholder="Ask a questionâ€¦ (Shift+Enter for newline)" />
        <button id="send" class="send">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= Config ================= */
const CHAT_ENDPOINT = '/api/chat';
const urlParams = new URLSearchParams(location.search);
if (urlParams.get('debug') === '1') requestAnimationFrame(()=>{ document.getElementById('debugPanel').open = true; });

/* ================= DOM refs ================= */
const thread = document.getElementById('thread');
const input  = document.getElementById('q');
const sendBtn= document.getElementById('send');
const btnEmail = document.getElementById('btn-email');
const btnReset = document.getElementById('btn-reset');

const dbgStatus = document.getElementById('dbg-status');
const dbgReq    = document.getElementById('dbg-req');
const dbgRes    = document.getElementById('dbg-res');
const dbgHeaders= document.getElementById('dbg-headers');
const dbgStruct = document.getElementById('dbg-struct');
const dbgProv   = document.getElementById('dbg-prov');
const dbgCopy   = document.getElementById('dbg-copy');
const dbgNote   = document.getElementById('dbg-note');
const dbgSrvVer = document.getElementById('dbg-srvver');

function setDebugJSON(el, data, opts={maxLen: 1200, maxItems: 20}) {
  function replacer(key, value){
    if (typeof value === 'string') {
      return value.length > opts.maxLen ? value.slice(0, opts.maxLen) + 'â€¦(truncated)' : value;
    }
    if (Array.isArray(value)) {
      if (value.length > opts.maxItems) {
        return [...value.slice(0, opts.maxItems), `â€¦(${value.length - opts.maxItems} more items truncated)`];
      }
    }
    return value;
  }
  try { el.textContent = JSON.stringify(data, replacer, 2); }
  catch { el.textContent = String(data); }
}

/* ================= UI helpers ================= */
function addBubble(html, opts={}) {
  const div = document.createElement('div');
  div.className = 'bubble' + (opts.user ? ' user' : '');
  div.innerHTML = html;
  thread.appendChild(div);
  div.scrollIntoView({behavior:'smooth', block:'end'});
  return div;
}
function addTyping() {
  const el = addBubble(`<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`);
  return ()=> el && el.remove();
}
function mdToHtml(md){
  if (!md) return { html:'', liIds:[], items:[] };
  let s = md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  s = s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  const lines = s.split(/\r?\n/);
  let out='', inList=false;
  const flush = ()=>{ if(inList){ out+='</ul>'; inList=false; } };
  for (const line of lines){
    const m = line.match(/^\s*-\s+(.*)$/);
    if (m){ if(!inList){ out+='<ul>'; inList=true; } out += `<li>${m[1].trim()}</li>`; }
    else { flush(); out += line.trim()? `<p>${line}</p>` : ''; }
  }
  flush();
  return { html:`<div class="answer">${out}</div>` };
}
function fmtDateTime(d){
  try{ return new Date(d||Date.now()).toLocaleString(undefined,{hour12:false}); }catch{ return String(d||''); }
}
function fmtDate(iso){
  try{ return new Date(iso).toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short',year:'numeric'});}catch{ return iso; }
}
function currency(amount, ccy){
  if(amount==null || amount==='') return null;
  const n = Number(amount); if(!isFinite(n)) return null;
  try{ return new Intl.NumberFormat(undefined,{style:'currency',currency:ccy||'GBP',maximumFractionDigits:0}).format(n); }
  catch{ return `Â£${String(amount).replace(/\.00$/,'')}`; }
}
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]) )}

/* ================= Product helpers (condensed) ================= */
function mergeProducts(list){
  if(!Array.isArray(list) || !list.length) return [];
  const map = new Map();
  for(const p of list){
    const key = (p.url || p.page_url || p.source_url || p.title || '').toLowerCase();
    if(!map.has(key)) { map.set(key, JSON.parse(JSON.stringify(p))); continue; }
    const m = map.get(key);
    for(const k of ['price','price_currency','availability','provider','description','title']) if(m[k]==null && p[k]!=null) m[k]=p[k];
    for (const k of ['display_price_gbp','display_price','availability_status','availability_raw','price_gbp','product_kind_resolved','price_source']) {
      if (m[k]==null && p[k]!=null) m[k]=p[k];
    }
  }
  return [...map.values()];
}
const STOP = new Set(['the','and','or','what','whats','when','whens','next','cost','workshop','workshops','photography','photo','near','me','uk','warks','warwickshire','devonshire','district','class','classes','course','courses','long','exposure','sunset','sunrise','landscape','seascape','evening','morning','walk','walks']);
function tokenizeWords(s){ return (s||'').toLowerCase().match(/[a-z]+/g) || []; }
function tokenize2(s){ return (s||'').toLowerCase().match(/[a-z0-9]+/g)||[]; }
function jaccard(aTokens, bTokens){ const A=new Set(aTokens), B=new Set(bTokens); let inter=0; for(const x of A) if(B.has(x)) inter++; const union=A.size+B.size-inter; return union? inter/union : 0; }
function futureEvents(structured){
  const now = new Date();
  return (structured?.events||[]).filter(e=>e?.date_start && !isNaN(Date.parse(e.date_start)) && new Date(e.date_start)>=now);
}
function strongProductEventMatch(prod, ev){
  if(!prod || !ev) return false;
  const titleP=(prod.title||'').toLowerCase(), titleE=(ev.title||'').toLowerCase();
  const locP=(prod.location_parsed||prod.location||'').toLowerCase(), locE=(ev.location||'').toLowerCase();
  const toksP=tokenize2(titleP+' '+locP).filter(t=>t.length>2 && !STOP.has(t));
  const toksE=tokenize2(titleE+' '+locE).filter(t=>t.length>2 && !STOP.has(t));
  const overlap=jaccard(toksP,toksE); if(overlap>=0.40) return true;
  const locTokP=tokenize2(locP).filter(t=>t.length>3), locTokE=tokenize2(locE).filter(t=>t.length>3);
  if (locTokP.some(t=>locTokE.includes(t))) return true;
  const shared=new Set(toksP.filter(t=>toksE.includes(t)));
  return shared.size>=2;
}

/* ===== Renderers ===== */
let __lastQuery = '';
function productHeadlinePrice(prod){
  if (prod.display_price) return String(prod.display_price);
  if (typeof prod.display_price_number === 'number') return currency(prod.display_price_number, 'GBP');
  if (typeof prod.price_gbp === 'number') return currency(prod.price_gbp, 'GBP');
  if (typeof prod.price === 'number') return currency(prod.price, prod.price_currency||'GBP');
  return null;
}
function renderProductCard(prod){
  const priceHead = productHeadlinePrice(prod);
  const lines = [];
  if (priceHead) lines.push(`<p class="kvline"><strong>Price:</strong> ${escapeHTML(priceHead)}</p>`);
  const href = prod.page_url || prod.source_url || prod.url || '#';
  const book = href && href!=='#' ? `<p style="margin-top:8px"><a href="${href}" target="_blank" rel="noopener">Book now â†’</a></p>` : '';
  return `<div class="answer"><h3>${escapeHTML(prod.title || 'Workshop')}</h3>${lines.join('')}${book}</div>`;
}
function extractKeyPhrases(topic, query){
  const words = tokenizeWords([topic||'', query||''].join(' '));
  const kept = words.filter(w => !STOP.has(w) && w.length >= 3);
  const phrases = []; for (let i=0;i<kept.length-1;i++) phrases.push(`${kept[i]} ${kept[i+1]}`);
  return { words:new Set(kept), phrases:new Set(phrases) };
}
function scoreEventMatch(ev, kp){
  const hay = ((ev.title||'') + ' ' + (ev.location||'')).toLowerCase();
  let score = 0; for(const ph of kp.phrases) if (hay.includes(ph)) score+=2;
  for(const w of kp.words) if (new RegExp(`\\b${w}\\b`).test(hay)) score+=1;
  return score;
}
function eventHeaderLabel(structured){
  const q = (__lastQuery||'').toLowerCase();
  if (/\b(course|courses|class|classes|tuition|lesson|lessons)\b/.test(q) || structured?.event_subtype==='course') return 'Upcoming Courses';
  if (/\b(workshop|workshops)\b/.test(q) || structured?.event_subtype==='workshop') return 'Upcoming Workshops';
  return 'Upcoming Events';
}
function renderEventsBlock(structured){
  const all = futureEvents(structured);
  if(!all.length) return '';
  const kp = extractKeyPhrases(structured?.topic||'', __lastQuery);
  const list = all.map(e=>({e,s:scoreEventMatch(e,kp)})).sort((a,b)=> (b.s-a.s)||(new Date(a.e.date_start)-new Date(b.e.date_start))).map(x=>x.e);
  const lis = list.map(e=>{
    const when=fmtDate(e.date_start), href=e.page_url||e.source_url||e.url||'#', where=e.location?`${escapeHTML(e.location)}`:'', title=e.title?`${escapeHTML(e.title)}`:'';
    return `<li><div><strong>${when}${where?' â€” '+where:''}</strong> â€” <a href="${href}" target="_blank" rel="noopener">Link</a></div><div>${title}</div></li>`;
  }).join('');
  const header = eventHeaderLabel(structured);
  return `<div class="answer"><h3>${header}</h3><ul>${lis}</ul></div>`;
}
function jaccard2(a,b){ const A=new Set(a), B=new Set(b); let inter=0; for(const x of A) if(B.has(x)) inter++; const union=A.size+B.size-inter; return union? inter/union : 0; }
function articleUrl(a){ return a?.page_url || a?.source_url || a?.url || ''; }
function articleTitle(a){ return a?.title || a?.raw?.name || ''; }
function scoreArticle(a, query, topic, contextTokens){
  const title=articleTitle(a), url=articleUrl(a); if(!title||!url) return 0;
  const qTokens=tokenize2([query,topic].join(' ')).concat(contextTokens||[]), hayTokens=tokenize2(title+' '+url);
  if(!qTokens.length||!hayTokens.length) return 0; let score=jaccard2(qTokens,hayTokens);
  if(qTokens.some(t=>t.length>=3 && title.toLowerCase().includes(t))) score+=0.25;
  const q=(__lastQuery||'').toLowerCase(), isWorkshopQ=/\b(workshop|workshops)\b/.test(q), isCourseQ=/\b(course|courses|class|classes|tuition|lesson|lessons)\b/.test(q);
  const t=(title+' '+url).toLowerCase(); if(isWorkshopQ && /workshop/.test(t) && !/course|tuition|lesson/.test(t)) score+=0.25;
  if(isCourseQ && /course|tuition|lesson|class/.test(t)) score+=0.25; return Math.min(1,score);
}
function pickArticles(structured, query, topic){
  const all = Array.isArray(structured?.articles)?structured.articles:[];
  const ev=(structured?.events||[])[0]||{}; const ctxTokens=tokenize2([(ev.title||''),(ev.location||'')].join(' '));
  let scored=all.map(a=>({a,s:scoreArticle(a,query,topic,ctxTokens)})).filter(x=>x.s>0);
  const isEventIntent = structured?.event_subtype || /\b(workshop|workshops|course|courses|class|classes|tuition|lesson|lessons)\b/i.test(__lastQuery||'');
  if(isEventIntent){ const eventish=scored.filter(x=>/workshop|course|tuition|lesson|class/i.test((articleTitle(x.a)+' '+articleUrl(x.a))));
    if(eventish.length>=2) scored=eventish.concat(scored.filter(x=>!eventish.includes(x))); }
  return scored.sort((x,y)=> (y.s-x.s) || ((Date.parse(y.a?.last_seen||'')||0)-(Date.parse(x.a?.last_seen||'')||0)))
               .slice(0,5).map(x=>x.a).filter(a=>!!articleUrl(a));
}
function renderArticlesBlock(structured, query){
  const list=pickArticles(structured, query, structured?.topic||''); if(!list.length) return '';
  const lis=list.map(a=>`<li><a href="${articleUrl(a)}" target="_blank" rel="noopener">${escapeHTML(articleTitle(a))}</a></li>`).join('');
  return `<div class="answer"><h3>Guides that match your question</h3><ul>${lis}</ul></div>`;
}
function buildActionPillsFromStructured(structured, query){
  const safe=[]; const used=new Set(); const add=(label,href)=>{ if(!label||!href) return; const u=String(href); if(/\/blog\?tag=|\/search\?query=/.test(u)) return;
    const key=`${label}::${u}`; if(used.has(key)) return; used.add(key); safe.push({label,href}); };
  for(const p of (structured?.pills||structured?.chips||[])) add(p.label||p.text||'Open', p.url||p.href);
  for (const a of pickArticles(structured, query, structured?.topic||'').slice(0,2)) add(articleTitle(a)||'Read Guide', articleUrl(a));
  return safe.slice(0,5);
}
function heuristicConfidence(s){ let score=0; if(s?.products?.length) score+=40; if(s?.events?.length) score+=40; if(s?.articles?.length) score+=20; return Math.min(95, Math.max(20, score||25)); }
function detectIntent(payload, query){
  const s = payload?.structured || {};
  const q = String(query||'').toLowerCase();
  const server = s.intent || payload?.intent || payload?.meta?.intent || payload?.debug?.intent || '';
  if (/course|courses|class|classes|tuition|lesson|lessons/.test(q)) return 'events';
  if (/workshop|workshops|event|events|when|whens|next/.test(q)) return 'events';
  if (/price|cost|fee|fees|how much|book|booking|buy/i.test(q)) return 'products';
  if (server) return server.toLowerCase();
  return 'unknown';
}
function isPriceyQuery(q){ return /\b(price|cost|fee|fees|how much|book|booking|buy)\b/i.test(String(q||'')); }

/* ===== Product gating ===== */
function decideProductRendering(payload, mergedProducts, query){
  const s=payload?.structured||{}; const intent=detectIntent(payload,query); const evs=futureEvents(s); const hasEvs=evs.length>0; const topEv=hasEvs?evs[0]:null;
  if(!mergedProducts.length) return {show:false, reason:'no-products'};
  if(intent==='products') return {show:true, reason:'intent-products'};
  if(isPriceyQuery(query)) return {show:true, reason:'pricey-query'};
  if(intent==='events'){ if(!hasEvs) return {show:true, reason:'events-intent-no-events'}; const prod=mergedProducts[0]; if(strongProductEventMatch(prod,topEv)) return {show:true, reason:'strong-match'}; return {show:false, reason:'events-intent-hide-products'}; }
  if(!hasEvs) return {show:true, reason:'no-events-fallback'};
  return {show:false, reason:'prefer-events'};
}

/* ===== Chime: WebAudio + fallback WAV ===== */
let __audioCtx = null;
let __audioUnlocked = false;
const FALLBACK_WAV = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQwAAAABAQH9/f38/Pz8+fn59/f3+vr6+/v7";
function unlockAudio(){
  try{
    __audioCtx = __audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    if (__audioCtx.state === 'suspended') __audioCtx.resume();
    __audioUnlocked = true;
  }catch{}
}
function playChime(){
  try{
    if(!__audioUnlocked) return;
    const ctx = __audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const now = ctx.currentTime + 0.01;
    const g = ctx.createGain();
    const o = ctx.createOscillator();
    const o2 = ctx.createOscillator();
    o.type = 'sine';     o.frequency.setValueAtTime(1046.5, now);
    o2.type= 'triangle'; o2.frequency.setValueAtTime(1568.0, now);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.12, now+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.35);
    o.connect(g); o2.connect(g); g.connect(ctx.destination);
    o.start(now); o2.start(now+0.02); o.stop(now+0.3); o2.stop(now+0.33);
    return;
  }catch{}
  try{ const a = new Audio(FALLBACK_WAV); a.volume = 0.9; a.play().catch(()=>{}); }catch{}
}

/* ===== Full render ===== */
function renderAnswer(payload){
  const s = payload.structured||{};
  try { if (dbgSrvVer) dbgSrvVer.textContent = payload?.debug?.version || 'â€“'; } catch {}

  let confidencePct = (typeof payload.confidence_pct === 'number') ? payload.confidence_pct : null;
  const heuristic = heuristicConfidence(s);
  if (confidencePct == null || confidencePct < 50) confidencePct = heuristic;
  const rounded = Math.round(confidencePct);

  const merged = mergeProducts(s.products||[]);
  const gate = decideProductRendering(payload, merged, __lastQuery);

  if (gate.show) { const prod = merged[0] || null; if (prod) addBubble(renderProductCard(prod)); }

  const evHTML = renderEventsBlock(s); if(evHTML) addBubble(evHTML);
  const artHTML = renderArticlesBlock(s, __lastQuery); if(artHTML) addBubble(artHTML);

  const pills = buildActionPillsFromStructured(s, __lastQuery);
  if(pills.length){
    const wrap = document.createElement('div'); wrap.className='actions';
    pills.forEach(p=>{ const a=document.createElement('a'); a.className='pill'; a.textContent=p.label; a.href=p.href; a.target='_blank'; a.rel='noopener'; wrap.appendChild(a); });
    thread.appendChild(wrap);
  }

  const footer = document.createElement('div');
  footer.className = 'footer-status';
  footer.innerHTML = `<span class="badge conf ${rounded>=70?'green':rounded>=35?'amber':'red'}">Confidence: ${rounded}%</span> <span class="badge ts">Answered: ${fmtDateTime(Date.now())}</span>`;
  thread.appendChild(footer);

  if(!gate.show && !(s.events||[]).length && !(s.articles||[]).length){
    const md = payload.answer_markdown || payload.answer || '';
    const extra = `<p>If this doesnâ€™t answer your question, please use the Contact or WhatsApp buttons in the header to reach Alan directly.</p>`;
    const {html}=mdToHtml(md || "I donâ€™t have a specific answer for that yet.");
    addBubble(html.replace('</div>', `${extra}</div>`));
  }

  setDebugJSON(dbgStruct, payload.structured||{});
  const note = payload.debug ? {...payload.debug, product_gate: gate} : { product_gate: gate };
  setDebugJSON(dbgNote, note);

  // ðŸ”” chime
  playChime();
}

/* ================= Networking ================= */
async function sendQuery(query){
  __lastQuery = String(query||'');
  const req = { query, topK: 8 };
  setDebugJSON(dbgReq, req);
  const closeTyping = addTyping();

  // Unlock audio based on this user gesture
  unlockAudio();

  try{
    const res = await fetch(CHAT_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(req)
    });
    dbgStatus.textContent = res.status;
    const headers = {}; res.headers.forEach((v,k)=>headers[k]=v);
    setDebugJSON(dbgHeaders, headers);

    let data = null; const ct=(res.headers.get('content-type')||'').toLowerCase();
    if (ct.includes('application/json')) data = await res.json();
    else { const raw = await res.text(); data = { ok:false, error: raw || `HTTP ${res.status}` }; }
    setDebugJSON(dbgRes, data);
    setDebugJSON(dbgProv, { citations: data.citations || [] });

    closeTyping();
    if (data && data.ok && (data.answer_markdown || data.answer || (data.structured && (data.structured.products?.length || data.structured.events?.length || data.structured.articles?.length)))) {
      renderAnswer(data);
    } else if (data && !data.ok) {
      const footer = document.createElement('div');
      footer.className = 'footer-status';
      footer.innerHTML = `<span class="badge conf red">Confidence: 25%</span> <span class="badge ts">Answered: ${fmtDateTime(Date.now())}</span>`;
      thread.appendChild(footer);
      addBubble(`<div class="answer"><p>Server error: ${escapeHTML(String(data.error||'Unknown'))}</p><p>If it continues, please use the Contact form or WhatsApp buttons above.</p></div>`);
      playChime();
    } else {
      const footer = document.createElement('div');
      footer.className = 'footer-status';
      footer.innerHTML = `<span class="badge conf amber">Confidence: 50%</span> <span class="badge ts">Answered: ${fmtDateTime(Date.now())}</span>`;
      thread.appendChild(footer);
      const {html}=mdToHtml("I donâ€™t have a specific answer for that yet.");
      const extra = `<p>If this doesnâ€™t answer your question, please use the Contact form or WhatsApp buttons above to reach Alan directly.</p>`;
      addBubble(html.replace('</div>', `${extra}</div>`));
      playChime();
    }
  } catch (err){
    closeTyping();
    dbgStatus.textContent = 'error';
    const footer = document.createElement('div');
    footer.className = 'footer-status';
    footer.innerHTML = `<span class="badge conf red">Confidence: 25%</span> <span class="badge ts">Answered: ${fmtDateTime(Date.now())}</span>`;
    thread.appendChild(footer);
    addBubble(`<div class="answer"><p>Something went wrong: ${escapeHTML(String(err))}</p><p>If it continues, please use the Contact form or WhatsApp buttons above.</p></div>`);
    playChime();
  }
}

/* ================= Transcript & wiring ================= */
function nodeToPlain(div){ return div.textContent.replace(/\s+\n/g,'\n').replace(/\n{3,}/g,'\n\n').trim(); }
function buildTranscript(){
  const rows = []; rows.push(`Alan Ranger Assistant â€” transcript`); rows.push(new Date().toISOString()); rows.push('');
  for (const el of thread.children){ if (el.classList.contains('actions')) continue; const role = el.classList.contains('user') ? 'User' : 'Assistant'; rows.push(`${role}:\n${nodeToPlain(el)}`); rows.push(''); }
  return rows.join('\n');
}
function emailTranscript(){
  const body = buildTranscript();
  const subject = 'Alan Ranger Assistant chat transcript';
  const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body.slice(0,2000))}`;
  if (body.length > 2000){
    const blob = new Blob([body], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    addBubble(`<div class="answer"><p>Transcript is quite long. You can <a href="${url}" download="alan-ranger-assistant-transcript.txt">download the full transcript</a> or use the shortened email draft that just opened.</p></div>`);
  }
  location.href = mailto;
}
function resetChat(){
  thread.innerHTML = '';
  addBubble('Hi! I can help with workshops, tuition, and photography advice.');
  [dbgStatus, dbgHeaders, dbgReq, dbgRes, dbgStruct, dbgProv, dbgNote, dbgSrvVer].forEach(el=>{ if(!el) return; el.textContent = el.id==='dbg-status' ? 'â€“' : 'â€“'; });
}
function submit(){
  const val = input.value.trim();
  if(!val) return;
  addBubble(val, {user:true});
  input.value='';
  sendQuery(val);
}
sendBtn.addEventListener('click', submit);
input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); submit(); }});
btnEmail.addEventListener('click', emailTranscript);
btnReset.addEventListener('click', resetChat);
dbgCopy && dbgCopy.addEventListener('click', async ()=>{
  const get = (el) => (el && el.textContent) ? el.textContent : 'â€“';
  const blocks = [
    ['Endpoint','/api/chat'],
    ['Status', get(dbgStatus)],
    ['Server ver', get(dbgSrvVer)],
    ['Headers', get(dbgHeaders)],
    ['Request', get(dbgReq)],
    ['Response', get(dbgRes)],
    ['Structured', get(dbgStruct)],
    ['Provenance', get(dbgProv)],
    ['Note', get(dbgNote)],
  ];
  const text = blocks.map(([k,v]) => `${k}:\n${v}`).join('\n\n').trim();
  try{ await navigator.clipboard.writeText(text); const old = dbgCopy.textContent; dbgCopy.textContent='Copied âœ“'; setTimeout(()=>dbgCopy.textContent=old,1200); }catch{ alert('Copy failed. Select the debug text and press Ctrl/Cmd+C.'); }
});
</script>
</body>
</html>
