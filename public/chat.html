<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Alan Ranger Assistant</title>
<style>
  :root {
    --bg:#0b1220; --panel:#0f172a; --line:#1b2540; --text:#dbe4ff;
    --muted:#9fb3ff; --brand:#E57200; --pill:#0b1426; --whatsapp:#25D366;
  }
  * { box-sizing:border-box }
  body { margin:0; font:15px/1.55 system-ui,-apple-system,Segoe UI,Inter,Roboto,sans-serif; background:var(--bg); color:var(--text); }
  .wrap { max-width:980px; margin:0 auto; padding:28px 20px; }
  .card { background:var(--panel); border:1px solid var(--line); border-radius:16px; overflow:hidden; box-shadow:0 8px 22px rgba(0,0,0,.35); }
  .brandbar { background:var(--brand); height:6px; }
  .header { text-align:center; padding:22px 18px 10px; }
  .logo {
    width:86px; height:86px; margin:0 auto 10px;
    border-radius:50%; background:#000; display:flex; align-items:center; justify-content:center;
    border:2px solid #2a344f; box-shadow:0 2px 10px rgba(0,0,0,.35);
  }
  .logo img { width:78px; height:78px; object-fit:contain; display:block; }
  h1 { font-size:34px; line-height:1.15; margin:10px 0 6px; letter-spacing:.3px; }
  .sub {
    max-width:760px; margin:0 auto; color:var(--muted);
    font-size:16px; line-height:1.6;
  }
  .pills { display:flex; gap:10px; justify-content:center; margin:14px 0 6px; flex-wrap:wrap; }
  .pill {
    display:inline-flex; align-items:center; gap:8px; padding:8px 14px; border-radius:999px;
    background:var(--pill); border:1px solid var(--line); color:var(--text); text-decoration:none; font-weight:600;
  }
  .pill:hover{ filter:brightness(1.05) }
  .pill.contact { background:var(--brand); border-color:var(--brand); color:#fff; }
  .pill.whatsapp { background:var(--whatsapp); border-color:var(--whatsapp); color:#0b1218; }

  .chat { padding:16px; max-height:66vh; overflow-y:auto; }
  .msg { display:flex; margin:12px 0; }
  .msg.user { justify-content:flex-end; }
  .bubble {
    max-width:76%; padding:12px 14px; border-radius:12px; white-space:pre-wrap; animation:fadeInUp .25s ease;
  }
  .bubble.user { background:#13203e; }
  .bubble.bot { background:#0b1328; }
  @keyframes fadeInUp { from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }

  .sources { margin-top:10px; display:flex; flex-wrap:wrap; gap:6px; }
  .chip { background:#0b1426; border:1px solid var(--line); border-radius:999px; padding:4px 10px; font-size:12px; }
  .chip a { color:#9ccaff; text-decoration:none; }

  .composer { display:flex; gap:8px; padding:12px 16px; border-top:1px solid var(--line); background:rgba(0,0,0,.12)}
  .composer input { flex:1; background:#0b1426; border:1px solid var(--line); border-radius:8px; padding:12px; color:var(--text); }
  .composer button { background:var(--brand); border:0; color:#fff; border-radius:8px; padding:0 16px; cursor:pointer; font-weight:700; min-width:78px; }
  .composer button:hover{ filter:brightness(1.05) }

  .typing { color:var(--muted); font-size:13px; margin:2px 16px 6px; display:none; gap:4px; }
  .dot { width:6px; height:6px; background:var(--muted); border-radius:50%; animation:bounce 1s infinite; }
  .dot:nth-child(2){animation-delay:0.2s} .dot:nth-child(3){animation-delay:0.4s}
  @keyframes bounce { 0%,80%,100%{transform:scale(0.6)} 40%{transform:scale(1)} }

  /* simple markdown-ish */
  .bubble.bot b { font-weight:700; }
  .bubble.bot ul { margin:6px 0 0 16px; padding:0; }
  .bubble.bot li { margin:4px 0; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="brandbar"></div>

    <!-- Header -->
    <div class="header">
      <div class="logo">
        <!-- Use the exact path you uploaded: /chat%20white.png -->
        <img src="/chat%20white.png" alt="Alan Ranger">
      </div>
      <h1>Alan Ranger Assistant</h1>
      <p class="sub">
        I’m Alan’s AI assistant, trained on content from this website to help with workshops, tuition, and photography questions.
        I won’t always get everything right — if I can’t help, please reach out to Alan directly using the contact options below.
      </p>
      <div class="pills">
        <a class="pill contact" href="https://www.alanranger.com/contact-us-alan-ranger-photography" target="_blank" rel="noopener">Contact form</a>
        <a class="pill whatsapp" href="https://wa.me/447000000000" target="_blank" rel="noopener">WhatsApp</a>
      </div>
    </div>

    <!-- Chat area -->
    <div id="chat" class="chat"></div>
    <div id="typing" class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

    <!-- Composer -->
    <div class="composer">
      <input id="q" placeholder="Ask a question… (Shift+Enter for newline)"/>
      <button id="send">Send</button>
    </div>
  </div>
</div>

<script>
const chat = document.getElementById('chat');
const q = document.getElementById('q');
const sendBtn = document.getElementById('send');
const typing = document.getElementById('typing');

function addBubble(html, who='bot', cites=[]) {
  const m = document.createElement('div'); m.className = 'msg ' + who;
  const b = document.createElement('div'); b.className = 'bubble ' + who;
  b.innerHTML = html;
  if (who === 'bot' && cites.length) {
    const src = document.createElement('div'); src.className = 'sources';
    Array.from(new Set(cites)).slice(0,6).forEach(u => {
      const chip = document.createElement('span'); chip.className='chip';
      chip.innerHTML = `<a href="${u}" target="_blank" rel="noopener">${u}</a>`;
      src.appendChild(chip);
    });
    b.appendChild(src);
  }
  m.appendChild(b);
  chat.appendChild(m);
  chat.scrollTop = chat.scrollHeight;
}

function mdLight(s='') {
  s = s.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
  s = s.replace(/(^|\n)-\s+/g, '$1• ');
  return s;
}

function contactPillsHTML() {
  return `
    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      <a class="pill contact" href="https://www.alanranger.com/contact-us-alan-ranger-photography" target="_blank" rel="noopener">Contact form</a>
      <a class="pill whatsapp" href="https://wa.me/447817017994" target="_blank" rel="noopener">WhatsApp</a>
    </div>`;
}

function showFallback() {
  const msg = `I don’t have a confident answer to that one yet. I’m trained on Alan’s site, so I may miss things.<br/>
  If you’d like to follow up, please reach out:`;
  addBubble(msg + contactPillsHTML(), 'bot');
}

function setTyping(v){ typing.style.display = v ? 'flex' : 'none'; }

async function ask() {
  const text = q.value.trim();
  if (!text) return;
  addBubble(text, 'user');
  q.value = '';
  setTyping(true);

  try {
    const r = await fetch('/api/chat', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ query: text, topK: 8 })
    });
    const j = await r.json();

    const bad =
      !j || !j.ok || !j.answer ||
      /^(i do not know|sorry|not sure)/i.test(j.answer.trim());

    if (bad) {
      showFallback();
      return;
    }

    const html = mdLight(j.answer || '');
    addBubble(html, 'bot', j.citations || []);
  } catch (e) {
    showFallback();
  } finally {
    setTyping(false);
  }
}

sendBtn.onclick = ask;
q.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); ask(); } });

// Friendly first message
addBubble('Hi! I can help with workshops, tuition, and photography advice.', 'bot');
</script>
</body>
</html>
