<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Alan Ranger Assistant</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    /* ===============================
       Theme  — v0.9.27 (logic-only rev)
       =============================== */
    :root{
      --bg:#0b1220;
      --panel:#172036;
      --panel-2:#121a2d;
      --panel-3:#0e162b;
      --ink:#ecf1ff;
      --ink-2:#c7d3ff;
      --muted:#a5b2d6;
      --stroke:#223154;
      --brand:#ffd166; /* warm yellow */
      --accent:#4cc9f0; /* cyan */
      --ok:#2bd97d;
      --warn:#ffb703;
      --bad:#ef476f;
      --radius:16px;
      --shadow:0 10px 24px rgba(0,0,0,.35);
      --code:#0b1328;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      text-rendering:optimizeLegibility;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    a{color:#b7d7ff;text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1050px;margin:0 auto;padding:18px}
    .head{display:flex;gap:14px;align-items:center;margin-bottom:12px}
    .logo{width:46px;height:46px;border-radius:50%;display:grid;place-items:center;background:var(--panel);font-weight:800;box-shadow:var(--shadow)}
    .head h1{margin:0;font-size:26px;letter-spacing:.2px}
    .head p{margin:4px 0 0;color:var(--muted)}

    /* Pills */
    .pillbar{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 10px}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 14px;border-radius:999px;border:1px solid var(--stroke);
      background:#0f1730;color:#fff;font-weight:700;letter-spacing:.2px
    }
    .pill.brand{background:linear-gradient(180deg,var(--brand),#f8c74d);color:#171717;border:none}
    .pill svg{width:16px;height:16px;opacity:.9}

    /* Cards / bubbles */
    .bubble{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
    }
    .card{
      background:var(--panel-2);
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:14px;
    }
    .card + .card{margin-top:10px}
    .section h3{margin:0 0 8px}
    .section h4{margin:0 0 6px;font-size:15px;color:var(--ink-2)}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:14px;margin-top:8px}
    .badge{
      display:inline-block;padding:4px 8px;border-radius:8px;
      background:#0e1a35;color:#b8c4e6;border:1px solid var(--stroke);font-size:12px
    }
    .badge.good{background:#092217;color:#bdf3d0;border-color:#1d6b4a}
    .badge.warn{background:#261b03;color:#ffe2a7;border-color:#6a4b00}

    .bar{height:1px;background:#243153;margin:16px 0}
    ul{margin:0 0 0 18px}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{background:#0f1730;border:1px solid var(--stroke);color:#cbd7ff;padding:4px 8px;border-radius:999px;font-size:12px;white-space:nowrap}
    .price{font-weight:800;margin:6px 0}

    /* Conversation list */
    .thread{display:flex;flex-direction:column;gap:10px}
    .msg{display:flex;gap:12px}
    .msg .role{
      width:28px;height:28px;border-radius:999px;display:grid;place-items:center;
      background:#0f1730;border:1px solid #223154;color:#d1ddff;font-weight:700;font-size:12px
    }
    .msg .text{flex:1}
    .msg .text .time{font-size:12px;color:var(--muted);margin-top:4px}

    /* Input / actions */
    .input{display:flex;gap:10px;align-items:center;margin-top:10px}
    .input input{
      flex:1;border-radius:12px;border:1px solid var(--stroke);
      background:#0f1730;color:#fff;padding:12px 12px 12px 14px;outline:none
    }
    .input button{
      border:0;border-radius:12px;padding:12px 16px;font-weight:700;background:var(--accent);color:#07101a;cursor:pointer
    }
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:10px;border:1px solid #29406a;background:#0d152b;color:#cfe1ff;cursor:pointer
    }
    .btn svg{width:16px;height:16px}

    /* Debug panel */
    details.debug{
      margin-top:16px;background:#0d152b;border:1px dashed #29406a;border-radius:12px;padding:8px 10px
    }
    details.debug > summary{cursor:pointer;color:#a9b6d9;font-weight:600}
    .debuggrid{display:grid;gap:10px;grid-template-columns:1fr 1fr;margin-top:10px}
    .debuggrid .full{grid-column:1/-1}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:4px 8px;border:1px solid #284272;border-radius:8px;background:#0f1831;color:#cfe1ff;cursor:pointer}
    .tab.active{background:#172346}
    pre{
      white-space:pre-wrap;background:var(--code);
      border:1px solid #22345a;border-radius:10px;padding:10px;margin:0;max-height:380px;overflow:auto
    }
    code.small{font-size:12px;color:#9bb1e6}

    /* Helpers */
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .hidden{display:none !important}
    .mt8{margin-top:8px}
    .mt12{margin-top:12px}
    .mt16{margin-top:16px}
    .mb0{margin-bottom:0}

    @media print{
      .input,.actions,details.debug,.pillbar{display:none}
      .wrap{max-width:900px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="head">
      <div class="logo">AR</div>
      <div>
        <h1 class="mb0">Alan Ranger Assistant</h1>
        <p>I’m Alan’s AI assistant, trained on site content. Ask about workshops, dates, pricing, tuition, or related articles. Everything here is generic—no query-specific wiring.</p>
      </div>
    </div>

    <!-- Pills -->
    <div class="pillbar" id="pillbar"></div>

    <!-- Answer bubble -->
    <div class="bubble">
      <div id="answerHtml" class="answer">Ask me about workshops or prices…</div>
      <div class="meta">
        <span class="badge" id="confidenceBadge">Confidence: —</span>
        <span class="badge warn hidden" id="warnBadge">Low detail in response</span>
        <span class="badge" id="timeBadge" title="Rendered time">—</span>
      </div>
    </div>

    <!-- Information grid (Product, Events, Guides) -->
    <div class="grid mt12" id="infoGrid"></div>

    <!-- Conversation thread -->
    <div class="bubble mt12">
      <div class="row"><h3 class="mb0">Conversation</h3><span class="badge" id="turnCount">0 turns</span></div>
      <div class="thread mt8" id="thread"></div>
    </div>

    <!-- Input -->
    <div class="input">
      <input id="q" placeholder="Ask a question… (Shift+Enter for newline)" />
      <button id="send">Send</button>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button class="btn" id="btnEmail" title="Email transcript (Ctrl/Cmd+E)">
        <svg viewBox="0 0 24 24" fill="none"><path d="M4 6h16v12H4z" stroke="currentColor" stroke-width="1.5"/><path d="m4 7 8 6 8-6" stroke="currentColor" stroke-width="1.5"/></svg>
        Email transcript
      </button>
      <button class="btn" id="btnDownload" title="Download transcript (Ctrl/Cmd+D)">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v12" stroke="currentColor" stroke-width="1.5"/><path d="m7 10 5 5 5-5" stroke="currentColor" stroke-width="1.5"/><path d="M5 20h14" stroke="currentColor" stroke-width="1.5"/></svg>
        Download
      </button>
      <button class="btn" id="btnReset" title="Reset chat (Ctrl/Cmd+R)">
        <svg viewBox="0 0 24 24" fill="none"><path d="M3 12a9 9 0 1 0 3-6.708" stroke="currentColor" stroke-width="1.5"/><path d="M3 4v5h5" stroke="currentColor" stroke-width="1.5"/></svg>
        Reset chat
      </button>
      <button class="btn" id="btnFocus" title="Focus input (Ctrl/Cmd+K)">
        <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M7 12h10" stroke="currentColor" stroke-width="1.5"/></svg>
        Focus input
      </button>
      <button class="btn" id="btnToggleDebug" title="Toggle debug (Ctrl/Cmd+I)">
        <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.5"/><path d="M12 8v.01M12 12v4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        Toggle debug
      </button>
    </div>

    <div class="bar"></div>

    <!-- Debug -->
    <details class="debug" id="debugWrap">
      <summary>Show debug</summary>
      <div class="tabs mt8" id="dbgTabs"></div>
      <div class="debuggrid mt8">
        <div>
          <strong>Request</strong>
          <pre id="dbgReq"></pre>
        </div>
        <div>
          <strong>Response</strong>
          <pre id="dbgRes"></pre>
        </div>
        <div class="full">
          <strong>Structured</strong>
          <pre id="dbgStruct"></pre>
        </div>
        <div>
          <strong>Citations (unique)</strong>
          <pre id="dbgCites"></pre>
        </div>
        <div>
          <strong>Notes</strong>
          <pre id="dbgNotes"></pre>
        </div>
      </div>
      <div class="mt8">
        <div><strong>Shortcuts</strong></div>
        <code class="small">Enter = send, Shift+Enter = newline, Ctrl/Cmd+K = focus, Ctrl/Cmd+R = reset, Ctrl/Cmd+E = email, Ctrl/Cmd+D = download, Ctrl/Cmd+I = toggle debug.</code>
      </div>
    </details>
  </div>

  <script>
    /* ============================================================
       Helpers (generic, no site-specific wiring)
       ============================================================ */

    const VERSION = '0.9.27'; // logic-only revision

    /** Selectors */
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    /** Local storage keys */
    const LS = {
      THREAD:'ar.thread.v1',
      HISTORY:'ar.history.v1'
    };

    /** Date/time helpers */
    const fmtDate = (iso) => {
      if(!iso) return '';
      try{
        const d = new Date(iso);
        return d.toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short',year:'numeric'});
      }catch{ return iso; }
    };
    const stampNow = ()=> new Date().toLocaleString();

    /** Basic markdown-to-HTML (safe subset) */
    const md = (text='')=>{
      let out = text
        .replace(/^###### (.*)$/gm,'<h6>$1</h6>')
        .replace(/^##### (.*)$/gm,'<h5>$1</h5>')
        .replace(/^#### (.*)$/gm,'<h4>$1</h4>')
        .replace(/^### (.*)$/gm,'<h3>$1</h3>')
        .replace(/^## (.*)$/gm,'<h2>$1</h2>')
        .replace(/^# (.*)$/gm,'<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
      out = out.replace(/(?:^|\n)- (.*?)(?=\n(?!- )|$)/gs, m=>`<ul>${m.trim().split('\n').map(x=>x.replace(/^- /,'<li>')+'</li>').join('')}</ul>`);
      out = out.replace(/\n{2,}/g,'</p><p>').replace(/\n/g,'<br/>');
      return `<p>${out}</p>`;
    };

    /** Build element */
    function h(tag, attrs={}, children=[]){
      const el = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs||{})){
        if (k === 'class') el.className = v;
        else if (k==='text') el.textContent = v;
        else if (k==='html') el.innerHTML = v;
        else el.setAttribute(k,v);
      }
      for (const c of (Array.isArray(children)?children:[children])) if (c) el.appendChild(c);
      return el;
    }

    /** Unique by key */
    const uniqBy = (arr, keyFn) => {
      const map = new Map();
      for (const item of arr||[]){
        const k = keyFn(item);
        if(!map.has(k)) map.set(k,item);
      }
      return [...map.values()];
    };

    /** Money parsing */
    const parseMoneyFromText = (text) => {
      if(!text) return [];
      const hits = [];
      const re = /(?:£|GBP\s?)(\d+(?:[.,]\d{2})?)/gi;
      let m;
      while((m = re.exec(text))){ hits.push(Number((m[1]||'').replace(/,/g,'').replace(/\.00$/,''))); }
      return hits;
    };

    /** Extract low/high price from product + description (supports 2nd price like "1 day — £175") */
    function extractPriceRange(products=[], answer=''){
      const prices = [];
      let currency = '£';
      const add = (val)=>{
        const n = typeof val==='string' ? Number(val) : val;
        if (typeof n==='number' && isFinite(n) && n>0) prices.push(n);
      };

      for (const p of products||[]){
        if (p.price_currency && p.price_currency !== 'GBP') currency = p.price_currency;
        if (p.price!=null) add(p.price);

        const offers = p?.raw?.offers;
        if (offers){
          if (Array.isArray(offers)){
            for (const ofr of offers){ if (ofr?.price!=null) add(ofr.price); }
          } else if (offers.price!=null){ add(offers.price); }
        }

        // scan description for another explicit price (e.g., "1 day — £175")
        const more = parseMoneyFromText(p?.description||'');
        for (const n of more) add(n);
      }

      if (prices.length === 0) prices.push(...parseMoneyFromText(answer));
      if (prices.length === 0) return null;

      const lo = Math.min(...prices), hi = Math.max(...prices);
      return {low: lo, high: hi, currency: currency === 'GBP' ? '£' : currency};
    }

    /** Confidence → percent, with smarter floor */
    function smartConfidence(conf, structured){
      let pct;
      if (typeof conf==='number') pct = conf<=1 ? conf*100 : conf;
      else if (typeof conf==='string') pct = conf.endsWith('%') ? Number(conf.replace('%','')) : Number(conf);
      if (!isFinite(pct)) pct = 35;

      const hasProducts = Array.isArray(structured?.products) && structured.products.length>0;
      const hasEvents = Array.isArray(structured?.events) && structured.events.length>0;

      // If backend sends an obviously low value but both product and events are present, floor to ~80%
      if (pct < 60 && hasProducts && hasEvents) pct = 80;

      pct = Math.max(0, Math.min(100, Math.round(pct)));
      return Math.max(35, pct);
    }

    /** Truncate for debug */
    const trunc = (s, n=12000) => {
      if (!s) return '';
      const str = typeof s==='string' ? s : JSON.stringify(s,null,2);
      return str.length>n ? str.slice(0,n)+'\n…(truncated)…' : str;
    };

    /** Group-by */
    function groupBy(arr, key){
      return (arr||[]).reduce((acc,x)=>{
        const k = (typeof key==='function' ? key(x) : x[key]) || 'Dates';
        (acc[k] = acc[k] || []).push(x);
        return acc;
      },{});
    }

    /* ============================================================
       Topic → tag mapping for safe related link/pill fallback
       ============================================================ */
    function topicToTag(topic=''){
      const t = (topic||'').toLowerCase();
      const map = [
        {rx:/bluebell|bluebells/, tag:'bluebell'},
        {rx:/woodland|woodlands|forest|trees/, tag:'woodland'},
        {rx:/landscape|peak|lake|snowdonia|devon|yorkshire|dales|district/, tag:'landscape'},
        {rx:/tuition|1[-\s]?to[-\s]?1|one[-\s]?to[-\s]?one/, tag:'tuition'},
        {rx:/composition|exposure|filters|long\s?exposure/, tag:'technique'},
      ];
      for (const m of map){ if (m.rx.test(t)) return m.tag; }
      return 'photography'; // safe default
    }

    /* ============================================================
       Rendering
       ============================================================ */

    /** Pills (can be appended with an extra tag pill) */
    function renderPills(pills, extraPill){
      const bar = $('#pillbar'); bar.innerHTML='';
      let list = Array.isArray(pills) && pills.length ? pills : [
        {label:'Event Listing', url:'/photography-workshops', brand:true},
        {label:'Photos', url:'/gallery-image-portfolios', brand:true}
      ];

      if (extraPill && extraPill.url && extraPill.label){
        list = [...list, {...extraPill, brand:true}];
      }

      for (const p of list){
        if (!p?.label || !p?.url) continue;
        const a = h('a',{href:p.url,target:'_blank',rel:'noreferrer',class:'pill'+(p.brand?' brand':'')});
        a.textContent = p.label;
        bar.appendChild(a);
      }
    }

    /** Product card with meta description + price range + availability prettified */
    function productCard(p, priceRange){
      const url = p?.page_url || p?.url || p?.source_url;
      const title = p?.title || 'Workshop';
      const rawDesc = (p?.description||'').trim();
      const firstSentence = rawDesc.split(/(?<=\.)\s+/)[0] || rawDesc.split('\n')[0] || '';
      const availRaw = (p?.availability||'').toString();
      const avail = /instock/i.test(availRaw) ? 'In stock' :
                    /soldout|outofstock/i.test(availRaw) ? 'Sold out' :
                    availRaw.replace(/^.*\//,'').replace(/([A-Z])/g,' $1').trim() || '';

      const wrap = h('div',{class:'card'});
      wrap.appendChild(h('div',{class:'section'},[
        h('h3',{text:title}),
        url ? h('div',{}, h('a',{class:'link',href:url,target:'_blank',rel:'noreferrer',text:url})) : null,
        firstSentence ? h('p',{text:firstSentence}) : null
      ]));

      if (priceRange){
        const same = priceRange.low === priceRange.high;
        const unit = priceRange.currency || '£';
        const txt = same ? `Price — ${unit}${priceRange.low}` : `Price — ${unit}${priceRange.low} to ${unit}${priceRange.high}`;
        wrap.appendChild(h('div',{class:'price',text:txt}));
      }

      const chips = h('div',{class:'chips'});
      const rx = (lab)=> (p?.description?.match(new RegExp(`${lab}:[^\\n]+`,'i'))||[])[0];
      const addChip = (t)=> t && chips.appendChild(h('span',{class:'chip',text:t}));

      const loc = rx('Location') || (p?.location ? `Location: ${p.location}` : null);
      const fit = rx('Fitness');
      const par = rx('Participants');

      addChip(loc);
      addChip(par);
      addChip(fit);
      if (avail) addChip(`Availability: ${avail}`);

      wrap.appendChild(chips);
      return wrap;
    }

    /** Keyword-based event filtering; future fallback */
    function filterEvents(events, topic, query){
      if (!Array.isArray(events) || !events.length) return [];

      // Build keyword set from topic + user query
      const tokens = (str='')=> str.toLowerCase().split(/\W+/).filter(w=>w && w.length>=4);
      const keys = new Set([...tokens(topic||''), ...tokens(query||'')]);
      const hasKeys = keys.size>0;

      const now = Date.now();
      const isFuture = (e)=>{
        const d = new Date(e.date_start||e.when||0).getTime();
        return isFinite(d) ? d >= (now - 24*3600*1000) : true; // allow today
      };

      const matches = (e)=>{
        const hay = ((e.title||'') + ' ' + (e.location||'')).toLowerCase();
        for (const k of keys){ if (hay.includes(k)) return true; }
        return false;
      };

      let list = events;
      // If we have keywords, filter by them
      if (hasKeys){
        const subset = events.filter(matches);
        if (subset.length) list = subset;
      }
      // Always prefer future items if available
      const future = list.filter(isFuture);
      list = future.length ? future : list;

      // Sort ascending by date
      return [...list].sort((a,b)=>{
        const da = new Date(a.date_start||a.when||0).getTime();
        const db = new Date(b.date_start||b.when||0).getTime();
        return (isFinite(da)?da:0) - (isFinite(db)?db:0);
      });
    }

    /** Events card (grouped by location) */
    function eventsCard(events){
      const div = h('div',{class:'card'});
      div.appendChild(h('div',{class:'section'}, h('h3',{text:'Upcoming Workshops'})));
      if (!events || !events.length){ div.appendChild(h('p',{text:'No upcoming events found.'})); return div; }

      const groups = groupBy(events, e => (e.location || '').trim() || 'Dates');
      for (const [loc, list] of Object.entries(groups)){
        if (loc && loc !== 'Dates') div.appendChild(h('h4',{text:loc}));
        const ul = h('ul');
        for (const e of list){
          const when = e.when || fmtDate(e.date_start);
          const href = e.href || e.page_url || e.source_url;
          const li = h('li',{},[
            document.createTextNode(`${when} — `),
            h('a',{class:'link',href:href,target:'_blank',rel:'noreferrer',text:'Link'})
          ]);
          ul.appendChild(li);
        }
        div.appendChild(ul);
      }
      return div;
    }

    /** Guides (Related articles) card
        - If structured.articles missing/empty, add safe fallback link via topic tag mapping.
        - Also returns an optional extra pill derived from the same link.
    */
    function guidesBlock(articles, topic){
      const div = h('div',{class:'card'});
      div.appendChild(h('div',{class:'section'}, h('h3',{text:'Guides that match your question'})));

      let list = Array.isArray(articles) ? articles.filter(a=>a?.url) : [];

      let extraPill = null;
      if (!list.length){
        const tag = topicToTag(topic);
        const url = `/blog?tag=${encodeURIComponent(tag)}`;
        list = [{title:'Related articles', url}];
        extraPill = {label:'Related articles', url};
      }

      const ul = h('ul');
      for (const it of list.slice(0,5)){
        const a = h('a',{href:it.url,target:'_blank',rel:'noreferrer',class:'link',text: it.title || it.url});
        ul.appendChild(h('li',{},a));
      }
      div.appendChild(ul);

      return {node: div, extraPill};
    }

    /** Confidence + time + badges */
    function renderConfidenceAndTime(res){
      const badge = $('#confidenceBadge');
      const val = smartConfidence(res.confidence ?? res.confidence_pct, res.structured);
      badge.textContent = `Confidence: ${val}%`;
      badge.className = 'badge' + (val>=75 ? ' good' : '');
      $('#timeBadge').textContent = `Answered: ${stampNow()}`;
    }

    /** Render the main answer bubble */
    function renderAnswer(markdown, payload){
      $('#answerHtml').innerHTML = md(markdown || '');
      const hasEvents = Array.isArray(payload?.structured?.events) && payload.structured.events.length>0;
      const hasProducts = Array.isArray(payload?.structured?.products) && payload.structured.products.length>0;
      const warn = (markdown||'').trim().length < 30 && (hasEvents || hasProducts);
      $('#warnBadge').classList.toggle('hidden', !warn);
    }

    /* ============================================================
       Conversation / transcript
       ============================================================ */
    const thread = [];
    function addTurn(role, content){
      const time = new Date().toLocaleTimeString();
      thread.push({role, content, time});
      localStorage.setItem(LS.THREAD, JSON.stringify(thread));
      renderThread();
    }
    function renderThread(){
      const tgt = $('#thread'); tgt.innerHTML='';
      for (const t of thread){
        const item = h('div',{class:'msg'},[
          h('div',{class:'role',text: t.role==='user' ? 'U' : 'A'}),
          h('div',{class:'text'},[
            h('div',{html: t.role==='assistant' ? md(t.content) : `<p>${t.content}</p>`}),
            h('div',{class:'time',text: t.time})
          ])
        ]);
        tgt.appendChild(item);
      }
      $('#turnCount').textContent = `${thread.length} ${thread.length===1?'turn':'turns'}`;
    }
    function resetThread(){
      thread.length = 0;
      localStorage.removeItem(LS.THREAD);
      renderThread();
    }

    /* ============================================================
       Debug panes
       ============================================================ */
    const dbg = {
      tabs: [],
      push(req,res){
        this.tabs.push({req,res,ts:new Date().toISOString()});
        this.tabs = this.tabs.slice(-6);
        renderDebugTabs();
      }
    };

    function renderDebugTabs(){
      const tabs = $('#dbgTabs'); tabs.innerHTML='';
      dbg.tabs.forEach((t,i)=>{
        const b = h('button',{class:'tab'+(i===dbg.tabs.length-1?' active':''),text:`Turn ${i+1}`});
        b.addEventListener('click',()=>{
          $$('.tab').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          mountDebug(t.req, t.res);
        });
        tabs.appendChild(b);
      });
      const last = dbg.tabs[dbg.tabs.length-1];
      if (last) mountDebug(last.req, last.res);
    }

    function mountDebug(req,res){
      $('#dbgReq').textContent = trunc(JSON.stringify(req,null,2));
      $('#dbgRes').textContent = trunc(JSON.stringify(res,null,2));
      $('#dbgStruct').textContent = trunc(JSON.stringify(res?.structured || {},null,2));
      const cites = Array.isArray(res?.citations) ? uniqBy(res.citations, x=>x) : [];
      $('#dbgCites').textContent = trunc(JSON.stringify(cites,null,2));
      const notes = [];
      const s = res?.structured||{};
      if (!s.products?.length) notes.push('No products in structured.');
      if (!s.events?.length) notes.push('No events in structured.');
      if (!s.pills?.length) notes.push('No pills in structured.');
      $('#dbgNotes').textContent = (notes.join('\n')||'—');
    }

    /* ============================================================
       Query / fetch
       ============================================================ */
    async function ask(query){
      const topK = 8;
      const req = {query, topK};
      addTurn('user', query);

      $('#dbgReq').textContent = trunc(JSON.stringify(req,null,2));

      const res = await fetch('/api/chat',{
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify(req)
      }).then(r=>r.json()).catch(err=>({ok:false,error:String(err)}));

      dbg.push(req,res);

      // Render main text + meta
      renderAnswer(res.answer_markdown || '', res);
      renderConfidenceAndTime(res);

      // Build info grid
      const grid = $('#infoGrid'); grid.innerHTML='';

      // Products
      const products = Array.isArray(res?.structured?.products) ? res.structured.products : [];
      if (products.length){
        const range = extractPriceRange(products, res.answer_markdown || '');
        grid.appendChild(productCard(products[0], range));
      }

      // Events with keyword filtering + future fallback
      const topic = res?.structured?.topic || '';
      const allEvents = Array.isArray(res?.structured?.events) ? res.structured.events : [];
      const filtEvents = filterEvents(allEvents, topic, query);
      if (filtEvents.length) grid.appendChild(eventsCard(filtEvents));

      // Guides / Articles + extra pill fallback from topic tag
      const articles = Array.isArray(res?.structured?.articles) ? res.structured.articles : [];
      const guides = guidesBlock(articles, topic);
      if (guides?.node) grid.appendChild(guides.node);

      // Pills: API pills plus optional extra pill from guides fallback
      const apiPills = res?.structured?.pills;
      renderPills(apiPills, guides?.extraPill);

      // Append to conversation
      addTurn('assistant', res.answer_markdown || '—');
    }

    /* ============================================================
       UI wiring
       ============================================================ */
    const input = $('#q');
    const send = $('#send');
    const debugWrap = $('#debugWrap');

    function doSend(){
      const q = input.value.trim();
      if (!q) return;
      ask(q);
      input.value = '';
    }
    send.addEventListener('click', doSend);
    input.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); doSend(); }
    });

    $('#btnEmail').addEventListener('click', ()=>{
      const plain = thread.map(t=>`${t.role.toUpperCase()} @ ${t.time}\n${t.content}\n`).join('\n');
      const subject = encodeURIComponent('Alan Ranger Assistant Transcript');
      const body = encodeURIComponent(plain);
      location.href = `mailto:?subject=${subject}&body=${body}`;
    });

    $('#btnDownload').addEventListener('click', ()=>{
      const plain = thread.map(t=>`${t.role.toUpperCase()} @ ${t.time}\n${t.content}\n`).join('\n');
      const blob = new Blob([plain],{type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download='assistant-transcript.txt';
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url),1000);
    });

    $('#btnReset').addEventListener('click', ()=>{
      resetThread();
      $('#infoGrid').innerHTML='';
      $('#answerHtml').innerHTML = 'Ask me about workshops or prices…';
      renderPills(null, null);
      $('#warnBadge').classList.add('hidden');
      $('#timeBadge').textContent = '—';
      $('#confidenceBadge').textContent = 'Confidence: —';
      $('#confidenceBadge').className = 'badge';
    });

    $('#btnFocus').addEventListener('click', ()=> input.focus());

    $('#btnToggleDebug').addEventListener('click', ()=>{
      debugWrap.open = !debugWrap.open;
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      const mod = e.ctrlKey || e.metaKey;
      if (!mod) return;
      if (e.key.toLowerCase()==='k'){ e.preventDefault(); input.focus(); }
      if (e.key.toLowerCase()==='r'){ e.preventDefault(); $('#btnReset').click(); }
      if (e.key.toLowerCase()==='e'){ e.preventDefault(); $('#btnEmail').click(); }
      if (e.key.toLowerCase()==='d'){ e.preventDefault(); $('#btnDownload').click(); }
      if (e.key.toLowerCase()==='i'){ e.preventDefault(); $('#btnToggleDebug').click(); }
    });

    /* ============================================================
       Bootstrap
       ============================================================ */
    (function boot(){
      try{
        const saved = JSON.parse(localStorage.getItem(LS.THREAD)||'[]');
        for (const t of saved) thread.push(t);
        renderThread();
      }catch{}
      renderPills(null, null);
      ask('when are the next workshops and what do they cost?');
    })();
  </script>
</body>
</html>
