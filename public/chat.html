<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Alan Ranger Assistant</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0e1726; --panel:#121C2D; --text:#DDE7F6; --muted:#93A4C1; --bubble:#1B2A44;
  --brand:#E57200; --wa:#25D366; --ring:rgba(229,114,0,.35);
  --input-bg:#E9EEF5; --input-text:#0b0f16; --input-border:#CBD5E1; --input-ph:#6b7280;
  --chip-bg:#13203e; --chip-br:#1b2540; --link:#9cd3ff; --link-hover:#cfe7ff;
  --user-bg:#e6edf7; --user-text:#0b0f16;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;line-height:1.45}
.wrap{max-width:980px;margin:28px auto;padding:0 16px;position:relative}
.card{background:var(--panel);border-radius:14px;box-shadow:0 6px 22px rgba(0,0,0,.35);border-top:6px solid var(--brand);padding:28px;position:relative}
.version{position:absolute;top:6px;right:10px;background:#0b1422;border:1px solid #1b2540;border-radius:999px;padding:2px 8px;font-size:11px;color:#9eb2d3}
.header{display:flex;flex-direction:column;align-items:center;gap:14px;margin-bottom:12px}
.logo{display:block;height:72px;width:auto;object-fit:contain;object-position:center;filter:drop-shadow(0 2px 6px rgba(0,0,0,.45))}
.title{margin:0;font-size:34px;font-weight:300;letter-spacing:.2px}
.sub{margin:0;text-align:center;color:var(--muted);max-width:720px;font-size:16px}
.pills{display:flex;gap:10px;margin:12px 0 4px;flex-wrap:wrap}
.pill{appearance:none;border:0;border-radius:28px;padding:8px 12px;font-weight:600;font-size:14px;color:#0b0f16;cursor:pointer;line-height:1;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
.pill--brand{background:var(--brand)} .pill--wa{background:var(--wa)}

.chat{margin-top:12px;border-radius:14px;background:#0f1828;padding:18px}
.thread{display:flex;flex-direction:column;gap:12px}
.bubble{background:var(--bubble);padding:14px 16px;border-radius:12px;max-width:780px}
.bubble.user{align-self:flex-end;background:var(--user-bg);color:var(--user-text);border:1px solid #d3deee}
.answer h1,.answer h2,.answer h3{margin:.2em 0}
.answer p{margin:.5em 0}
.answer ul{margin:.4em 0 .6em 1.25em}
.answer li{margin:.15em 0}
.answer a{color:var(--link);text-decoration:underline}
.answer a:hover{color:var(--link-hover)}
.answer .kv{display:grid;grid-template-columns:132px 1fr;gap:0 .75rem;margin:.5rem 0}
.answer .kv strong{color:#cfe3ff}

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.chips a{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--chip-br);background:var(--chip-bg);color:#cfe3ff;text-decoration:none;font-weight:600}
.chips a.brand{background:var(--brand);color:#0b0f16;border-color:transparent}
.chips a:hover{opacity:.9}

/* Composer */
.composer{display:flex;gap:10px;margin-top:14px;padding:12px;background:var(--panel);border-radius:12px}
.composer input{flex:1;background:var(--input-bg);color:var(--input-text);border:1px solid var(--input-border);border-radius:10px;padding:12px 14px;outline:0}
.composer input::placeholder{color:var(--input-ph)}
.composer input:focus{border-color:var(--ring);box-shadow:0 0 0 4px var(--ring)}
.send{background:var(--brand);color:#0b0f16;font-weight:700;border:0;border-radius:10px;padding:0 18px;cursor:pointer}

/* Debug panel */
details.debug{margin-top:14px;background:#0f1828;border:1px solid #15223a;border-radius:10px;padding:10px 12px}
details.debug summary{cursor:pointer;color:#9eb2d3;font-weight:600;outline:none}
.kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin-top:10px}
.kv label{color:#93A4C1}
pre.json{white-space:pre-wrap;word-break:break-word;margin:0;padding:8px;background:#0b1422;border:1px solid #15223a;border-radius:8px;color:#cfe3ff;font-size:12px;line-height:1.4}
.debug-actions{display:flex;justify-content:flex-end}
.debug-actions button{margin-bottom:8px;padding:6px 10px;border-radius:6px;border:1px solid #334;color:#cfe3ff;background:#13203e;cursor:pointer}

/* Typing dots */
.typing{position:relative;display:inline-block}
.typing .dot{display:inline-block;width:6px;height:6px;margin:0 2px;border-radius:50%;background:#9eb2d3;opacity:.6;animation:bounce 1.2s infinite}
.typing .dot:nth-child(2){animation-delay:.15s}
.typing .dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-4px)}}

@media (max-width:540px){
  .title{font-size:26px}.logo{height:60px}.kv{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <span class="version">v0.9.14</span>
    <div class="header">
      <img class="logo" src="./chat%20white.png" alt="AR logo">
      <h2 class="title">Alan Ranger Assistant</h2>
      <p class="sub">Iâ€™m Alanâ€™s AI assistant, trained on content from this website to help with workshops, tuition, and photography questions. I wonâ€™t always get everything right â€” if I canâ€™t help, please contact Alan directly:</p>
      <div class="pills">
        <a class="pill pill--brand" target="_blank" rel="noopener" href="https://www.alanranger.com/contact-us-alan-ranger-photography">Contact form</a>
        <a class="pill pill--wa" target="_blank" rel="noopener" href="https://wa.me/447817017994">WhatsApp</a>
      </div>
    </div>

    <div class="chat">
      <div id="thread" class="thread">
        <div class="bubble">Hi! I can help with workshops, tuition, and photography advice.</div>
      </div>

      <details id="debugPanel" class="debug">
        <summary>ðŸ”Ž Show debug</summary>
        <div class="debug-actions">
          <button id="dbg-copy">Copy all</button>
        </div>
        <div class="kv"><label>Endpoint</label><div>/api/chat</div></div>
        <div class="kv"><label>Status</label><div id="dbg-status">â€“</div></div>
        <div class="kv"><label>Headers</label><pre id="dbg-headers" class="json">â€“</pre></div>
        <div class="kv"><label>Request</label><pre id="dbg-req" class="json">â€“</pre></div>
        <div class="kv"><label>Response</label><pre id="dbg-res" class="json">â€“</pre></div>
        <div class="kv"><label>Structured</label><pre id="dbg-struct" class="json">â€“</pre></div>
        <div class="kv"><label>Provenance</label><pre id="dbg-prov" class="json">â€“</pre></div>
      </details>

      <div class="composer">
        <input id="q" placeholder="Ask a questionâ€¦ (Shift+Enter for newline)" />
        <button id="send" class="send">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
const CHAT_ENDPOINT = '/api/chat';
const urlParams = new URLSearchParams(location.search);
if (urlParams.get('debug') === '1') requestAnimationFrame(()=>{ document.getElementById('debugPanel').open = true; });

const thread = document.getElementById('thread');
const input  = document.getElementById('q');
const sendBtn= document.getElementById('send');

const dbgStatus = document.getElementById('dbg-status');
const dbgReq    = document.getElementById('dbg-req');
const dbgRes    = document.getElementById('dbg-res');
const dbgHeaders= document.getElementById('dbg-headers');
const dbgStruct = document.getElementById('dbg-struct');
const dbgProv   = document.getElementById('dbg-prov');
const dbgCopy   = document.getElementById('dbg-copy');

function safeJSONString(v){ try{ return JSON.stringify(v,null,2); }catch{ return String(v); } }

dbgCopy?.addEventListener('click', ()=>{
  const all = [
    'Status: '+dbgStatus.textContent,
    'Headers:\n'+dbgHeaders.textContent,
    'Request:\n'+dbgReq.textContent,
    'Response:\n'+dbgRes.textContent,
    'Structured:\n'+dbgStruct.textContent,
    'Provenance:\n'+dbgProv.textContent,
  ].join('\n\n');
  navigator.clipboard.writeText(all).then(()=>{ dbgCopy.textContent='Copied!'; setTimeout(()=>dbgCopy.textContent='Copy all',1500); });
});

/* ---------- UI helpers ---------- */
function addBubble(html, opts={}) {
  const div = document.createElement('div');
  div.className = 'bubble' + (opts.user ? ' user' : '');
  div.innerHTML = html;
  thread.appendChild(div);
  div.scrollIntoView({behavior:'smooth', block:'end'});
  return div;
}
function addTyping() {
  const el = addBubble(`<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`);
  return ()=> el && el.remove();
}

function mdToHtml(md){
  if (!md) return { html:'', liIds:[], items:[] };
  let s = md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  s = s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  const lines = s.split(/\r?\n/);
  let out='', inList=false, liIds=[], items=[], idx=0;
  const flush = ()=>{ if(inList){ out+='</ul>'; inList=false; } };
  for (const line of lines){
    const m = line.match(/^\s*-\s+(.*)$/);
    if (m){
      if(!inList){ out+='<ul>'; inList=true; }
      const text = m[1].trim();
      const id = `li_${++idx}`; liIds.push(id); items.push(text);
      out += `<li id="${id}">${text}</li>`;
    } else {
      flush();
      out += line.trim()? `<p>${line}</p>` : '';
    }
  }
  flush();
  return { html:`<div class="answer">${out}</div>`, liIds, items };
}

function fmtDate(iso){
  try{ return new Date(iso).toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short',year:'numeric'});}catch{ return iso; }
}

/* ---------- Product helpers (generic) ---------- */
function money(v){
  if(v==null || v==='') return '';
  const n = Number(v); if(!isFinite(n)) return String(v);
  return 'Â£'+n.toString();
}
function priceFromProduct(prod){
  if(!prod) return {headline:'', low:null, high:null, single:null};
  if (prod.price!=null) return {headline:money(prod.price), low:null, high:null, single:prod.price};
  const low = prod?.raw?.offers?.lowPrice ?? prod?.raw?.offers?.lowprice ?? null;
  const high= prod?.raw?.offers?.highPrice ?? prod?.raw?.offers?.highprice ?? null;
  if(low!=null && high!=null) return {headline:`${money(low)}â€“${money(high)}`, low, high, single:null};
  return {headline:'', low:null, high:null, single:null};
}
function extractDetails(desc){
  // Keep concise, drop â€œdate wallsâ€
  const lines = (desc||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const keep = [];
  let location=null, participants=null, fitness=null, availability=null;
  const dateLike = /^(Mon|Tue|Wed|Thu|Fri|Sat|Sun)[^A-Za-z]*\d{1,2}/i;

  for(const ln of lines){
    if(dateLike.test(ln)) continue; // drop calendar rows in product block
    if(/^Summary:?$/i.test(ln)) continue;

    let m;
    if((m=ln.match(/^Location:\s*(.+)$/i))) { location=m[1].trim(); continue; }
    if((m=ln.match(/^Participants:\s*(.+)$/i))) { participants=m[1].trim(); continue; }
    if((m=ln.match(/^Fitness:\s*(.+)$/i))) { fitness=m[1].trim(); continue; }
    if((m=ln.match(/^Availability:\s*(.+)$/i))) { availability=m[1].trim(); continue; }
    keep.push(ln);
  }
  return {clean:keep, location, participants, fitness, availability};
}
function extractOptionTimes(desc){
  // Try to pull the two time options without prices
  if(!desc) return [];
  const lines = desc.split(/\r?\n/).map(s=>s.trim());
  const hits=[];
  const timeLine = /(4\s*hrs?|4\s*hours?|half[-\s]*day).*?(\d{1,2}[:.]\d{2}\s*am).*?(\d{1,2}[:.]\d{2}\s*pm)/i;
  const dayLine  = /(1\s*day|full[-\s]*day).*?(\d{1,2}[:.]\d{2}\s*am).*?(\d{1,2}[:.]\d{2}\s*pm)/i;
  for(const ln of lines){
    let m;
    if((m=ln.match(timeLine))) hits.push({label:'4hrs', text:ln});
    else if((m=ln.match(dayLine))) hits.push({label:'1 day', text:ln});
  }
  // Fallback to known patterns in your copy
  if(hits.length===0){
    const four = lines.find(s=>/4hrs?\s*-\s*5:45\s*am/i); if(four) hits.push({label:'4hrs', text:four});
    const one  = lines.find(s=>/1\s*day\s*-\s*5:45\s*am/i); if(one)  hits.push({label:'1 day', text:one});
  }
  return hits;
}
function extractPerOptionPrices(desc){
  // Look for lines that start with option label and have a Â£
  const out=[];
  if(!desc) return out;
  const lines = desc.split(/\r?\n/).map(s=>s.trim());
  const pairs = [
    [/^(?:4\s*hrs?|4\s*hours?|half[-\s]*day)\b/i,'4hrs'],
    [/^(?:1\s*day|full[-\s]*day)\b/i,'1 day']
  ];
  for(const ln of lines){
    for(const [rx,label] of pairs){
      if(rx.test(ln) && /Â£\s*\d+/.test(ln)) {
        const price = (ln.match(/Â£\s*\d+/)||[''])[0].replace(/\s+/g,'');
        out.push({label, price});
      }
    }
  }
  // Deduplicate by label
  const uniq=new Map();
  for(const p of out) if(!uniq.has(p.label)) uniq.set(p.label,p);
  return [...uniq.values()];
}

/* Build chips safely */
function createChips(structured){
  const events=structured?.events||[];
  const products=structured?.products||[];

  const firstEventUrl = events.find(e=>e?.page_url||e?.source_url)?.page_url || events.find(e=>e?.source_url)?.source_url || null;
  const productUrl    = products.find(p=>p?.url||p?.page_url)?.url || products.find(p=>p?.page_url)?.page_url || null;
  const infoUrl = productUrl || firstEventUrl || 'https://www.alanranger.com/photographic-workshops-uk';

  const rawChips = [
    {label:'Book Now', href:productUrl, brand:true},
    {label:'Prices',   href:productUrl, brand:true},
    {label:'Upcoming dates', href:firstEventUrl || productUrl, brand:true},
    {label:'Info', href:infoUrl, brand:false}
  ].filter(c=>!!c.href);

  const out=[], seen=new Set();
  for(const c of rawChips){ if(!seen.has(c.href)){ out.push(c); seen.add(c.href);} }
  return out;
}

/* Render a single merged product block */
function renderProductBlock(structured){
  const products = structured?.products||[];
  if(!products.length) return null;

  // Choose the richer row, then merge pricing/span info from the other.
  let primary = products.find(p=>p.price!=null) || products[0];
  const alt   = products.find(p=>p!==primary) || null;

  // Pricing headline & per-option
  const pMain = priceFromProduct(primary);
  const pAlt  = alt ? priceFromProduct(alt) : {headline:'', low:null, high:null, single:null};
  const headline = [money(primary.price)||'', pAlt.headline].filter(Boolean).join(' â€¢ ') || pMain.headline || pAlt.headline;

  const title = primary.title || primary.raw?.name || 'Workshop Options';
  const desc  = primary.description || primary.raw?.description || '';
  const details = extractDetails(desc);
  const options = extractOptionTimes(desc);
  const perOpt  = extractPerOptionPrices(desc);

  // Build DOM
  const wrap = document.createElement('div');
  wrap.className='answer';

  const h = document.createElement('h3');
  h.textContent = `${title} â€” ${headline}`.replace(/\s+â€”\s+$/, '');
  wrap.appendChild(h);

  // Short intro line (first kept line if helpful)
  const intro = details.clean.find(s=>s.length>20) || '';
  if(intro){
    const p = document.createElement('p'); p.textContent = intro; wrap.appendChild(p);
  }

  // Key/Value rows
  const kv = document.createElement('div'); kv.className='kv';
  const addKV=(k,v)=>{ if(!v) return; const s=document.createElement('div'); s.innerHTML=`<strong>${k}</strong>`; kv.appendChild(s); const d=document.createElement('div'); d.textContent=v; kv.appendChild(d);};
  addKV('Location:', details.location);
  addKV('Participants:', details.participants);
  addKV('Fitness:', details.fitness);
  addKV('Availability:', details.availability);
  if(kv.children.length) wrap.appendChild(kv);

  // Option list with de-dup logic
  if(options.length){
    const ul=document.createElement('ul');
    options.forEach(op=>{
      const li=document.createElement('li');
      // If we have per-option price (e.g., 4hrs Â£99 / 1 day Â£150), use that;
      // otherwise, do NOT echo the headline price again.
      const match = perOpt.find(x=>x.label.toLowerCase()===op.label.toLowerCase());
      const priceTx = match ? ` â€” ${match.price}` : '';
      li.innerHTML = `<strong>${op.label}</strong> â€” ${op.text.replace(/^.*?-\s*/,'')}${priceTx}`;
      ul.appendChild(li);
    });
    wrap.appendChild(ul);
  }

  return wrap;
}

/* Render upcoming events */
function renderEvents(structured, fallbackHeading='Upcoming Workshops'){
  const now=new Date();
  const future=(structured?.events||[])
    .filter(e=>e?.date_start && !isNaN(Date.parse(e.date_start)) && new Date(e.date_start)>=now)
    .sort((a,b)=>new Date(a.date_start)-new Date(b.date_start))
    .slice(0,12);

  if(!future.length) return null;

  const container=document.createElement('div'); container.className='answer';
  const heading = structured?.topic ? `Upcoming ${structured.topic.toString().trim()} Workshops` : fallbackHeading;
  const h2=document.createElement('h3'); h2.textContent=heading; container.appendChild(h2);
  const ul=document.createElement('ul');
  future.forEach(e=>{
    const li=document.createElement('li');
    const when=fmtDate(e.date_start);
    const href=e.page_url||e.source_url||'#';
    const a=document.createElement('a'); a.href=href; a.target='_blank'; a.rel='noopener'; a.textContent='Link';
    li.innerHTML=`${when} â€” `; li.appendChild(a);
    li.insertAdjacentText('beforeend',` â€” ${e.location||''}`);
    ul.appendChild(li);
  });
  container.appendChild(ul);
  return container;
}

/* Graceful fallback when we have nothing useful */
function renderFallback(){
  const div=document.createElement('div'); div.className='answer';
  div.innerHTML = `
    <p>Sorry â€” I couldnâ€™t find exact dates for that just now.</p>
    <ul>
      <li><a target="_blank" rel="noopener" href="https://www.alanranger.com/photographic-workshops-uk">Browse all workshops</a></li>
      <li><a target="_blank" rel="noopener" href="https://www.alanranger.com/contact-us-alan-ranger-photography">Ask Alan via the contact form</a> or <a target="_blank" rel="noopener" href="https://wa.me/447817017994">WhatsApp</a></li>
    </ul>`;
  return div;
}

/* ---------- Render end-to-end ---------- */
function renderAnswer(payload){
  let bubbleToChip = null;

  // 1) Primary markdown (if any)
  const md=payload.answer_markdown||payload.answer||'';
  if(md){ const {html}=mdToHtml(md); addBubble(html); }

  // 2) Structured: Product (merged)
  if(payload.structured){
    const prodNode=renderProductBlock(payload.structured);
    if(prodNode){ bubbleToChip = addBubble(prodNode.outerHTML); }

    // 3) Events
    const evNode=renderEvents(payload.structured);
    if(evNode){ bubbleToChip = addBubble(evNode.outerHTML); }

    // 4) Chips
    const chips=createChips(payload.structured);
    if(chips.length && bubbleToChip){
      const wrap=document.createElement('div'); wrap.className='chips';
      chips.forEach(c=>{
        const a=document.createElement('a'); a.href=c.href; a.target='_blank'; a.rel='noopener'; a.textContent=c.label;
        if(c.brand) a.classList.add('brand');
        wrap.appendChild(a);
      });
      bubbleToChip.appendChild(wrap);
    }
  }

  // 5) Fallback when nothing structured/markdown
  if(!md && (!payload.structured || ((!payload.structured.events||!payload.structured.events.length) && (!payload.structured.products||!payload.structured.products.length)))){
    addBubble(renderFallback().outerHTML);
  }

  // Debug dump
  dbgStruct.textContent=safeJSONString(payload.structured||{});
}

/* ---------- Networking ---------- */
async function sendQuery(query){
  const req = { query, topK: 8 };
  dbgReq.textContent = safeJSONString(req);
  const closeTyping = addTyping();
  try{
    const res = await fetch(CHAT_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(req)
    });
    dbgStatus.textContent = res.status;
    const headers = {}; res.headers.forEach((v,k)=>headers[k]=v);
    dbgHeaders.textContent = safeJSONString(headers);

    const data = await res.json();
    dbgRes.textContent = safeJSONString(data);
    dbgProv.textContent = safeJSONString({ citations: data.citations || [] });

    closeTyping();
    if (data && (data.answer_markdown || data.structured)) {
      renderAnswer(data);
    } else {
      addBubble(renderFallback().outerHTML);
    }
  } catch (err){
    closeTyping();
    dbgStatus.textContent = 'error';
    addBubble(`<div class="answer"><p>Something went wrong: ${String(err)}</p></div>`);
  }
}

/* ---------- Wire up composer ---------- */
function submit(){
  const val = input.value.trim();
  if(!val) return;
  addBubble(val, {user:true});
  input.value='';
  sendQuery(val);
}
sendBtn.addEventListener('click', submit);
input.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); submit(); }
});

// optional starter
// sendQuery("give me the next workshop dates and prices");
</script>
</body>
</html>
