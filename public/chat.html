<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Alan Ranger — AI Bot</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#9aa7c7; --text:#dbe4ff; --line:#1b2540;
      --btn:#2563eb; --btnText:#fff; --chip:#13203e;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--text); font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    .wrap{max-width:900px; margin:0 auto; padding:24px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:16px;}
    .row{display:flex; gap:10px; align-items:center;}
    .stack{display:flex; flex-direction:column; gap:12px;}
    input, textarea{background:#0b1426; color:var(--text); border:1px solid var(--line); border-radius:8px; padding:10px 12px; width:100%;}
    button{background:var(--btn); color:var(--btnText); border:none; border-radius:10px; padding:10px 16px; cursor:pointer}
    button:disabled{opacity:.6; cursor:not-allowed}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .chat{display:flex; flex-direction:column; gap:14px; max-height:62vh; overflow:auto; padding-right:4px;}
    .msg{display:flex; gap:10px}
    .msg .bubble{background:#0b1426; border:1px solid var(--line); padding:12px 14px; border-radius:12px; max-width:80%}
    .msg.user{justify-content:flex-end}
    .msg.user .bubble{background:#1a2341}
    .msg.assistant .bubble{background:#101a34}
    .answer{white-space:pre-wrap}
    .chips{display:flex; flex-wrap:wrap; gap:6px; margin-top:8px}
    .chips a{display:inline-block; padding:6px 8px; border-radius:999px; border:1px solid var(--line); background:var(--chip); color:var(--text); text-decoration:none; font-size:12px}
    .topbar{display:flex; justify-content:space-between; align-items:center; margin-bottom:12px}
    .brand{font-weight:600; letter-spacing:.2px}
    .footer{margin-top:12px; font-size:12px}
    @media (max-width:720px){ .wrap{padding:16px} .msg .bubble{max-width:100%} }
  </style>
</head>
<body>
  <div class="wrap stack">

    <div class="topbar">
      <div class="brand">Alan Ranger — AI Bot</div>
      <div class="muted mono" id="connStatus">ready</div>
    </div>

    <div id="tokenCard" class="card stack" style="display:none">
      <div class="stack">
        <label class="muted">Bearer token</label>
        <input id="token" placeholder="Enter INGEST_TOKEN to enable chat"/>
        <div class="muted" style="font-size:12px">Saved locally; sent as <span class="mono">Authorization: Bearer …</span></div>
      </div>
      <div><button id="saveToken">Save token</button></div>
    </div>

    <div class="card stack">
      <div class="chat" id="chat"></div>

      <div class="row">
        <textarea id="q" rows="2" placeholder="Ask a question… (Shift+Enter for newline)"></textarea>
        <button id="send">Send</button>
      </div>

      <div class="row muted" style="justify-content:space-between">
        <div>
          <label>topK</label>
          <input id="topk" class="mono" style="width:64px" value="8"/>
        </div>
        <div class="footer">Answers cite sources; the assistant only uses your indexed pages.</div>
      </div>
    </div>

  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const chat = $('chat');
  const conn = $('connStatus');

  const urlToken = new URLSearchParams(location.search).get('token') || '';
  if (urlToken) localStorage.setItem('ingest_token', urlToken);
  const getToken = ()=> localStorage.getItem('ingest_token') || '';
  function ensureTokenUI(){
    const has = !!getToken();
    $('tokenCard').style.display = has ? 'none' : 'block';
  }
  $('saveToken').onclick = ()=>{
    const v = $('token').value.trim();
    if (v) localStorage.setItem('ingest_token', v);
    ensureTokenUI();
  };
  ensureTokenUI();

  const el = (html)=>{ const d=document.createElement('div'); d.innerHTML = html.trim(); return d.firstChild; };
  function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }
  function truncate(s,n){ if(!s) return ''; return s.length>n ? s.slice(0,n-1)+'…' : s; }

  function addUser(text){
    chat.appendChild(el(`
      <div class="msg user">
        <div class="bubble mono">${escapeHtml(text)}</div>
      </div>
    `));
    chat.scrollTop = chat.scrollHeight;
  }

  function addAssistant(answer, citations){
    const chips = (citations||[]).map(u=>`<a href="${u}" target="_blank" rel="noopener">${truncate(u,72)}</a>`).join('');
    const block = el(`
      <div class="msg assistant">
        <div class="bubble">
          <div class="answer mono">${escapeHtml(answer||'(no answer)')}</div>
          ${chips ? `<div class="chips">${chips}</div>` : ''}
        </div>
      </div>
    `);
    chat.appendChild(block);
    chat.scrollTop = chat.scrollHeight;
  }

  function addSystem(text){
    chat.appendChild(el(`
      <div class="msg assistant">
        <div class="bubble muted mono">${escapeHtml(text)}</div>
      </div>
    `));
    chat.scrollTop = chat.scrollHeight;
  }

  async function ask(q){
    const token = getToken();
    if (!token){ ensureTokenUI(); addSystem('Missing token. Enter token to enable chat.'); return; }

    conn.textContent = 'thinking…';
    $('send').disabled = true;

    try{
      const k = Math.max(1, Math.min(16, parseInt(($('topk').value||'8'),10)));
      const r = await fetch('/api/chat', {
        method:'POST',
        headers:{ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' },
        body: JSON.stringify({ query:q, topK:k })
      });
      let body; try { body = await r.json(); } catch { body = { error:'non_json', status:r.status }; }

      if (!r.ok || !body.ok){
        addAssistant(`Sorry, I couldn't answer that. (${(body && (body.detail||body.error)) || r.status})`, []);
      } else {
        addAssistant(body.answer, Array.from(new Set(body.citations||[])));
      }
    } catch(err){
      addAssistant(`Error: ${err?.message||String(err)}`, []);
    } finally{
      $('send').disabled = false;
      conn.textContent = 'ready';
    }
  }

  const welcome = new URLSearchParams(location.search).get('welcome') ||
    'Hi! Ask me anything about workshops, courses, and tuition.';
  addSystem(welcome);

  $('send').onclick = ()=>{
    const txt = $('q').value.trim();
    if (!txt) return;
    $('q').value = '';
    addUser(txt);
    ask(txt);
  };
  $('q').addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      $('send').click();
    }
  });

})();
</script>
</body>
</html>
