<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alan Ranger Assistant</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Tiny markdown renderer for product/article text -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{
      --bg:#0f172a; --panel:#1f2937; --muted:#9aa4b2; --fg:#e5e7eb; --brand:#f59e0b; --accent:#0ea5e9;
      --pill:#0ea5e9; --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:960px;margin:0 auto;padding:28px 16px 120px}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(15,23,42,.98),rgba(15,23,42,.8) 70%,rgba(15,23,42,0));backdrop-filter:blur(6px)}
    .hero{text-align:center;padding:10px 0 18px}
    .logo{width:56px;height:56px;border:2px solid var(--fg);border-radius:50%;display:inline-grid;place-items:center;margin:4px auto 10px}
    .hero h1{margin:0;font-size:28px;font-weight:700}
    .hero p{margin:6px auto 12px;color:var(--muted);max-width:680px;font-size:14px;line-height:1.45}
    .top-actions{display:flex;gap:10px;justify-content:center}
    .btn{background:#334155;color:#fff;border:none;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:700}
    .btn.brand{background:var(--brand);color:#241a00}
    .panel{background:var(--panel);border-radius:var(--radius);padding:14px 16px;box-shadow:0 2px 0 rgba(0,0,0,.35)}
    .panel + .panel{margin-top:14px}
    .query-row{display:flex;gap:10px;align-items:center}
    .query{flex:1;background:#0b1220;color:#e6e6e6;border:1px solid #293347;border-radius:10px;padding:12px 12px;outline:none}
    .send{min-width:80px}
    .hint{color:#9aa3b2;font-size:12px;margin-top:6px}
    .section-title{font-weight:800;margin:0 0 8px;font-size:16px}
    /* Markdown */
    .md{line-height:1.55}
    .md p{margin:8px 0}
    .md ul{margin:6px 0 6px 18px}
    /* Events */
    .events ul{margin:4px 0 0 18px}
    .events li{margin:4px 0}
    .events a{color:var(--fg);text-decoration:none;border-bottom:1px dotted #6b7280}
    /* Articles */
    .articles ul{margin:4px 0 0 18px}
    .articles li{margin:4px 0}
    /* Pills */
    .pills{display:flex;flex-wrap:wrap;gap:10px}
    .pill{border-radius:999px;padding:7px 12px;font-weight:800;background:#475569;color:#fff;text-decoration:none;display:inline-flex;align-items:center}
    .pill.brand{background:var(--brand);color:#241a00}
    .pill.secondary{background:#536176}
    .pill.conf{background:var(--pill);color:#fff;pointer-events:none;cursor:default}
    /* Debug + footer */
    details.debug{margin-top:12px}
    pre{white-space:pre-wrap;background:#0b1220;border:1px solid #293347;padding:10px;border-radius:10px;color:#cbd5e1;font-size:12px;overflow:auto;max-height:340px}
    .bar{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(15,23,42,.05),rgba(15,23,42,.65)),var(--bg);padding:12px 16px;border-top:1px solid #263043}
    .bar .inner{max-width:960px;margin:0 auto;display:flex;gap:10px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="hero">
        <div class="logo">R</div>
        <h1>Alan Ranger Assistant</h1>
        <p>I’m Alan’s AI assistant, trained on content from this website to help with workshops, tuition, and photography questions. If I can’t help, please contact Alan directly.</p>
        <div class="top-actions">
          <a class="btn brand" href="https://www.alanranger.com/contact" target="_blank" rel="noopener">Contact form</a>
          <a class="btn" href="https://wa.me/447769049161" target="_blank" rel="noopener">WhatsApp</a>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Ask box (top) -->
    <div class="panel">
      <div class="query-row">
        <input class="query" id="q" placeholder="Ask a question… (Shift+Enter for newline)" />
        <button class="btn brand send" id="send">Send</button>
      </div>
      <div class="hint">Try: “when are the next bluebell workshops and what do they cost?”</div>
    </div>

    <!-- Responses land here -->
    <section id="responses"></section>

    <!-- Bottom ask bar -->
    <div class="bar">
      <div class="inner">
        <input class="query" id="qBottom" placeholder="Ask a question… (Shift+Enter for newline)" />
        <button class="btn brand send" id="sendBottom">Send</button>
      </div>
    </div>
  </main>

  <script>
    /* ---------- tiny helpers ---------- */
    const $ = s => document.querySelector(s);
    const responses = $('#responses');
    const qTop = $('#q'), qBot = $('#qBottom');
    const sendTop = $('#send'), sendBot = $('#sendBottom');
    const md = (txt) => marked.parse(txt || '').trim();
    const el = (t,c) => { const x=document.createElement(t); if(c) x.className=c; return x; };

    function buildConfidencePill(p){
      const pill = el('span','pill conf');
      const pct = Math.max(0, Math.min(100, Number(p)||0));
      pill.textContent = `Confidence: ${pct}%`;
      return pill;
    }
    function safeTopic(structured){
      const t = (structured?.topic||'').trim();
      if(!t) return 'Workshops';
      const first = t.split(',')[0].trim();
      return first ? `${first} Workshops` : 'Workshops';
    }

    /* ---------- renderers ---------- */
    function renderProductBlock(answer_markdown){
      if(!answer_markdown) return null;
      const panel = el('div','panel');
      const body = el('div','md');
      body.innerHTML = md(answer_markdown);
      panel.appendChild(body);
      return panel;
    }

    function renderEventsBlock(structured){
      const events = structured?.events || [];
      if(!events.length) return null;

      const panel = el('div','panel events');
      const h = el('h3','section-title');
      h.textContent = `Upcoming ${safeTopic(structured)}`;
      panel.appendChild(h);

      const ul = el('ul');
      events.forEach(e=>{
        const li = el('li');
        const when = e.when || '';
        const href = e.href || e.page_url || e.source_url;
        const loc = e.location ? ` — ${e.location}` : '';
        li.innerHTML = `${when} — ${href ? `<a href="${href}" target="_blank" rel="noopener">Link</a>` : 'Link'}${loc}`;
        ul.appendChild(li);
      });
      panel.appendChild(ul);
      return panel;
    }

    function renderArticlesBlock(structured){
      const articles = structured?.articles || [];
      if(!articles.length) return null;

      const panel = el('div','panel articles');
      const h = el('h3','section-title'); h.textContent = 'Related guides';
      panel.appendChild(h);

      const ul = el('ul');
      articles.slice(0,5).forEach(a=>{
        const title = a.title || a.raw?.name || 'Read more';
        const url = a.page_url || a.source_url;
        const li = el('li');
        li.innerHTML = `${title} — ${url ? `<a href="${url}" target="_blank" rel="noopener">Link</a>` : ''}`.trim();
        ul.appendChild(li);
      });
      panel.appendChild(ul);
      return panel;
    }

    function renderPills(structured, confidence_pct){
      const wrap = el('div','panel');
      const row = el('div','pills');

      // Single overall confidence pill (non-clickable)
      row.appendChild(buildConfidencePill(confidence_pct));

      // Then backend pills (Book Now, Event Listing first)
      const pills = structured?.pills || [];
      const seen = new Set();
      function add(label,url,brand){
        if(!label || !url) return;
        if(seen.has(url)) return;
        seen.add(url);
        const a = el('a', 'pill' + (brand ? ' brand' : ' secondary'));
        a.href = url; a.target = '_blank'; a.rel='noopener';
        a.textContent = label;
        row.appendChild(a);
      }
      pills.forEach(p => add(p.label, p.url, !!p.brand));

      wrap.appendChild(row);
      return wrap;
    }

    function renderDebugSnapshot(req, data){
      const details = el('details','debug'); const sum = el('summary'); sum.textContent = 'Show debug';
      const pre = el('pre');
      pre.textContent = JSON.stringify({
        request: req,
        response: {
          ok: data?.ok,
          confidence_pct: data?.confidence_pct,
          meta: data?.meta,
          intent: data?.structured?.intent,
          topic: data?.structured?.topic,
          counts: {
            events: data?.structured?.events?.length || 0,
            products: data?.structured?.products?.length || 0,
            articles: data?.structured?.articles?.length || 0
          }
        }
      }, null, 2);
      details.appendChild(sum); details.appendChild(pre);
      return details;
    }

    function fallbackPanel(){
      const p = el('div','panel');
      p.innerHTML = `<p class="hint">I couldn’t find a specific match. Please try rephrasing or use the Contact form / WhatsApp buttons above to reach Alan directly for an accurate response.</p>`;
      return p;
    }

    /* ---------- ask flow ---------- */
    function clearResponses(){ responses.innerHTML=''; }
    function echoQuery(q){
      const e = el('div','panel');
      e.innerHTML = `<div class="hint" style="opacity:.9">You asked: <strong>${q.replace(/</g,'&lt;')}</strong></div>`;
      responses.appendChild(e);
    }

    async function ask(query){
      clearResponses();
      echoQuery(query);

      const reqBody = { query, topK: 8 };
      try{
        const r = await fetch('/api/chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(reqBody)
        });
        const data = await r.json();

        if(!data?.ok){
          responses.appendChild(fallbackPanel());
          responses.appendChild(renderDebugSnapshot(reqBody, data));
          return;
        }

        // Product block from markdown (includes description, facts, sessions)
        const prod = renderProductBlock(data.answer_markdown);
        if(prod) responses.appendChild(prod);

        // Events
        const ev = renderEventsBlock(data.structured);
        if(ev) responses.appendChild(ev);

        // Articles (if any)
        const art = renderArticlesBlock(data.structured);
        if(art) responses.appendChild(art);

        // Unified pills row with ONE confidence pill
        responses.appendChild(renderPills(data.structured, data.confidence_pct));

        // Debug snapshot for this reply only
        responses.appendChild(renderDebugSnapshot(reqBody, data));

        // Fallback if nothing useful rendered
        if(!prod && !ev && !art){
          responses.appendChild(fallbackPanel());
        }

      }catch(err){
        responses.appendChild(fallbackPanel());
        responses.appendChild(renderDebugSnapshot(reqBody, { ok:false, error:String(err) }));
      }
    }

    /* ---------- wiring ---------- */
    function bindSend(btn,input){
      input.addEventListener('keydown',e=>{
        if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); btn.click(); }
      });
      btn.addEventListener('click', ()=>{
        const v = (input.value||'').trim();
        if(!v) return;
        ask(v);
        qTop.value = qBot.value = v;
      });
    }
    bindSend(sendTop,qTop);
    bindSend(sendBot,qBot);

    // Optional demo call:
    // ask('whens the next bluebell workshops and whats the cost');
  </script>
</body>
</html>
