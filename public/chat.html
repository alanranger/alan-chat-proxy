<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Alan Ranger Assistant</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0e1726; --panel:#121C2D; --text:#DDE7F6; --muted:#93A4C1; --bubble:#1B2A44;
  --brand:#E57200; --wa:#25D366; --ring:rgba(229,114,0,.35);
  --input-bg:#E9EEF5; --input-text:#0b0f16; --input-border:#CBD5E1; --input-ph:#6b7280;
  --chip-bg:#13203e; --chip-br:#1b2540; --link:#9cd3ff; --link-hover:#cfe7ff;
  --user-bg:#e6edf7; --user-text:#0b0f16;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;line-height:1.45}
.wrap{max-width:980px;margin:28px auto;padding:0 16px;position:relative}
.card{background:var(--panel);border-radius:14px;box-shadow:0 6px 22px rgba(0,0,0,.35);border-top:6px solid var(--brand);padding:28px;position:relative}
.version{position:absolute;top:6px;right:10px;background:#0b1422;border:1px solid #1b2540;border-radius:999px;padding:2px 8px;font-size:11px;color:#9eb2d3}
.header{display:flex;flex-direction:column;align-items:center;gap:14px;margin-bottom:12px}
.logo{display:block;height:72px;width:auto;object-fit:contain;object-position:center;filter:drop-shadow(0 2px 6px rgba(0,0,0,.45))}
.title{margin:0;font-size:34px;font-weight:300;letter-spacing:.2px}
.sub{margin:0;text-align:center;color:var(--muted);max-width:720px;font-size:16px}
.pills{display:flex;gap:10px;margin:12px 0 4px;flex-wrap:wrap}
.pill{appearance:none;border:0;border-radius:28px;padding:8px 12px;font-weight:600;font-size:14px;color:#0b0f16;cursor:pointer;line-height:1;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
.pill--brand{background:var(--brand)} .pill--wa{background:var(--wa)}

.chat{margin-top:12px;border-radius:14px;background:#0f1828;padding:18px}
.thread{display:flex;flex-direction:column;gap:12px}
.bubble{background:var(--bubble);padding:14px 16px;border-radius:12px;max-width:780px}
.bubble.user{align-self:flex-end;background:var(--user-bg);color:var(--user-text);border:1px solid #d3deee}
.answer h1,.answer h2,.answer h3{margin:.2em 0}
.answer p{margin:.5em 0}
.answer ul{margin:.4em 0 .6em 1.25em}
.answer li{margin:.15em 0}
.answer a{color:var(--link);text-decoration:underline}
.answer a:hover{color:var(--link-hover)}

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.chips a{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--chip-br);background:var(--chip-bg);color:#cfe3ff;text-decoration:none;font-weight:600}
.chips a.brand{background:var(--brand);color:#0b0f16;border-color:transparent}
.chips a:hover{opacity:.9}

/* Composer */
.composer{display:flex;gap:10px;margin-top:14px;padding:12px;background:var(--panel);border-radius:12px}
.composer input{flex:1;background:var(--input-bg);color:var(--input-text);border:1px solid #e0e6f0;border-radius:10px;padding:12px 14px;outline:0}
.composer input::placeholder{color:var(--input-ph)}
.composer input:focus{border-color:var(--ring);box-shadow:0 0 0 4px var(--ring)}
.send{background:var(--brand);color:#0b0f16;font-weight:700;border:0;border-radius:10px;padding:0 18px;cursor:pointer}

/* Debug */
details.debug{margin-top:14px;background:#0f1828;border:1px solid #15223a;border-radius:10px;padding:10px 12px}
details.debug summary{cursor:pointer;color:#9eb2d3;font-weight:600;outline:none}
.kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin-top:10px}
.kv label{color:#93A4C1}
pre.json{white-space:pre-wrap;word-break:break-word;margin:0;padding:8px;background:#0b1422;border:1px solid #15223a;border-radius:8px;color:#cfe3ff;font-size:12px;line-height:1.4}
#dbg-copy{margin:10px 0 6px;padding:6px 10px;border-radius:6px;border:1px solid #334;color:#cfe3ff;background:#13203e;cursor:pointer}

.typing{position:relative;display:inline-block}
.typing .dot{display:inline-block;width:6px;height:6px;margin:0 2px;border-radius:50%;background:#9eb2d3;opacity:.6;animation:bounce 1.2s infinite}
.typing .dot:nth-child(2){animation-delay:.15s}
.typing .dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-4px)}}

@media (max-width:540px){.title{font-size:26px}.logo{height:60px}.kv{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <!-- Version badge sits below the orange border -->
    <span class="version">v0.9.13</span>

    <div class="header">
      <img class="logo" src="./chat%20white.png" alt="AR logo">
      <h2 class="title">Alan Ranger Assistant</h2>
      <p class="sub">Iâ€™m Alanâ€™s AI assistant, trained on content from this website to help with workshops, tuition, and photography questions. I wonâ€™t always get everything right â€” if I canâ€™t help, please contact Alan directly:</p>
      <div class="pills">
        <a class="pill pill--brand" target="_blank" rel="noopener" href="https://www.alanranger.com/contact-us-alan-ranger-photography">Contact form</a>
        <a class="pill pill--wa" target="_blank" rel="noopener" href="https://wa.me/447817017994">WhatsApp</a>
      </div>
    </div>

    <div class="chat">
      <div id="thread" class="thread">
        <div class="bubble">Hi! I can help with workshops, tuition, and photography advice.</div>
      </div>

      <details id="debugPanel" class="debug">
        <summary>ðŸ”Ž Show debug</summary>
        <button id="dbg-copy">Copy all</button>
        <div class="kv"><label>Endpoint</label><div>/api/chat</div></div>
        <div class="kv"><label>Status</label><div id="dbg-status">â€“</div></div>
        <div class="kv"><label>Headers</label><pre id="dbg-headers" class="json">â€“</pre></div>
        <div class="kv"><label>Request</label><pre id="dbg-req" class="json">â€“</pre></div>
        <div class="kv"><label>Response</label><pre id="dbg-res" class="json">â€“</pre></div>
        <div class="kv"><label>Structured</label><pre id="dbg-struct" class="json">â€“</pre></div>
        <div class="kv"><label>Provenance</label><pre id="dbg-prov" class="json">â€“</pre></div>
      </details>

      <div class="composer">
        <input id="q" placeholder="Ask a questionâ€¦ (Shift+Enter for newline)" />
        <button id="send" class="send">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
const CHAT_ENDPOINT = '/api/chat';
const thread = document.getElementById('thread');
const input  = document.getElementById('q');
const sendBtn= document.getElementById('send');
const urlParams = new URLSearchParams(location.search);
if (urlParams.get('debug')==='1') requestAnimationFrame(()=>{ document.getElementById('debugPanel').open = true; });

/* Debug refs */
const dbgStatus = document.getElementById('dbg-status');
const dbgReq    = document.getElementById('dbg-req');
const dbgRes    = document.getElementById('dbg-res');
const dbgHeaders= document.getElementById('dbg-headers');
const dbgStruct = document.getElementById('dbg-struct');
const dbgProv   = document.getElementById('dbg-prov');
const dbgCopy   = document.getElementById('dbg-copy');
const safeJSONString=v=>{ try{return JSON.stringify(v,null,2);}catch{return String(v);} };
dbgCopy?.addEventListener('click', ()=>{
  const all = [
    'Status: '+dbgStatus.textContent,
    'Headers:\n'+dbgHeaders.textContent,
    'Request:\n'+dbgReq.textContent,
    'Response:\n'+dbgRes.textContent,
    'Structured:\n'+dbgStruct.textContent,
    'Provenance:\n'+dbgProv.textContent,
  ].join('\n\n');
  navigator.clipboard.writeText(all).then(()=>{ dbgCopy.textContent='Copied!'; setTimeout(()=>dbgCopy.textContent='Copy all',1500); });
});

/* UI helpers */
function addBubble(html, opts={}) {
  const div = document.createElement('div');
  div.className = 'bubble' + (opts.user ? ' user' : '');
  if (html instanceof Node) div.appendChild(html);
  else div.innerHTML = html;
  thread.appendChild(div);
  div.scrollIntoView({behavior:'smooth', block:'end'});
  return div;
}
function addTyping(){
  const el = addBubble(`<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`);
  return ()=> el && el.remove();
}
function toGBP(n){ if(n==null||isNaN(Number(n))) return null; return new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP',maximumFractionDigits:0}).format(Number(n)); }
function fmtDate(iso){ try{ return new Date(iso).toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short',year:'numeric'});}catch{ return iso; } }
function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

/* Markdown (fallback) */
function mdToHtml(md){
  if(!md) return {html:''};
  let s = md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  s = s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  const lines = s.split(/\r?\n/);
  let out='', inList=false;
  const flush=()=>{ if(inList){ out+='</ul>'; inList=false; } };
  for(const line of lines){
    const m=line.match(/^\s*-\s+(.*)$/);
    if(m){ if(!inList){ out+='<ul>'; inList=true; } out+=`<li>${m[1]}</li>`; }
    else { flush(); if(line.trim()) out+=`<p>${line}</p>`; }
  }
  flush();
  return {html:`<div class="answer">${out}</div>`};
}

/* ---------- Product merging & parsing ---------- */
function mergeProductsByPageUrl(products){
  const byUrl=new Map();
  (products||[]).forEach(p=>{
    const key=p.page_url||p.url||p.source_url; if(!key) return;
    if(!byUrl.has(key)) byUrl.set(key, JSON.parse(JSON.stringify(p)));
    else{
      const t=byUrl.get(key);
      if(t.price==null && p.price!=null) t.price=Number(p.price);
      if(!t.price_currency && p.price_currency) t.price_currency=p.price_currency;
      if((t.description||'').length < (p.description||'').length) t.description=p.description;
      t.raw=t.raw||{}; t.raw.offers=Object.assign({},t.raw.offers||{},p.raw?.offers||{});
    }
  });
  const arr=[...byUrl.values()];
  arr.sort((a,b)=>{
    const ap=(a.price!=null||(a.raw?.offers?.price!=null||a.raw?.offers?.lowPrice!=null||a.raw?.offers?.highPrice!=null))?1:0;
    const bp=(b.price!=null||(b.raw?.offers?.price!=null||b.raw?.offers?.lowPrice!=null||b.raw?.offers?.highPrice!=null))?1:0;
    if(ap!==bp) return bp-ap;
    return (b.description||'').length-(a.description||'').length;
  });
  return arr[0] || (products||[])[0] || null;
}

function firstMeaningfulLine(desc){
  if(!desc) return '';
  // prefer first non-empty line
  const line = desc.split(/\r?\n/).map(s=>s.trim()).find(Boolean) || '';
  if(line.length>280){
    // trim to first sentence-ish
    const m = line.match(/^(.{60,220}?)([.!?])\s|$/);
    return (m ? (m[1]+(m[2]||'')) : line).trim();
  }
  return line;
}

function extractKeyDetails(desc){
  const d = (desc||'');
  // Regexes that work mid-paragraph
  const grab = (label)=> {
    const m = d.match(new RegExp(label+':\\s*([^\\n]+)', 'i'));
    return m ? m[1].trim() : null;
  };
  const location = grab('Location');
  const participants = grab('Participants');
  const fitness = grab('Fitness');
  const availability = grab('Availability');

  // Sessions: gather lines with 4hrs/half-day and 1 day/full day anywhere
  const sessions = [];
  const add=(s)=>{ if(s && !sessions.includes(s)) sessions.push(s.trim()); };

  // split on newlines first
  d.split(/\r?\n/).forEach(line=>{
    if(/(^|\b)(4\s*hrs?|half-?day)/i.test(line)) add(line);
    if(/(^|\b)(1\s*day|full\s*day)/i.test(line)) add(line);
  });
  // also sweep whole blob for common patterns
  (d.match(/(?:4\s*hrs?.+?(?:Â£\d+)?|1\s*day.+?(?:Â£\d+)?)/gi)||[]).forEach(add);

  return { location, participants, fitness, availability, sessions };
}

function deriveOptionPrices(prod, sessions){
  const offers = (prod?.raw && (prod.raw.offers || prod.raw.Offers)) || {};
  const hasRange = (offers.lowPrice!=null || offers.highPrice!=null);
  const low  = offers.lowPrice!=null ? Number(offers.lowPrice) : null;
  const high = offers.highPrice!=null ? Number(offers.highPrice) : null;
  const single = prod?.price!=null ? Number(prod.price) : (offers.price!=null ? Number(offers.price) : null);

  return sessions.map(s=>{
    let price=null;
    if(hasRange){
      if(/(^|\b)(4\s*hrs?|half-?day)/i.test(s)) price=low;
      else if(/(1\s*day|full\s*day)/i.test(s)) price=high;
    }else if(single!=null){ price=single; }
    return { text:s, price };
  });
}

/* ---------- Chips ---------- */
function createChips(structured, citations){
  const events=structured?.events||[];
  const products=structured?.products||[];
  const firstEventUrl = events.find(e=>e?.page_url||e?.source_url)?.page_url || events.find(e=>e?.source_url)?.source_url || null;
  const productUrl    = products.find(p=>p?.url||p?.page_url)?.url || products.find(p=>p?.page_url)?.page_url || null;

  const uniq=(arr)=>Array.from(new Set(arr.filter(Boolean)));
  const allCites=uniq([...(citations||[]), firstEventUrl, productUrl]);
  const infoUrl=allCites.find(u=>u && u!==firstEventUrl && u!==productUrl) || null;

  const raw=[
    {label:'Book Now', href:productUrl, brand:true},
    {label:'Prices', href:productUrl? productUrl+'#prices' : infoUrl||firstEventUrl, brand:true},
    {label:'Upcoming dates', href:firstEventUrl||productUrl||infoUrl, brand:true},
    infoUrl? {label:'Info', href:infoUrl, brand:true} : null
  ].filter(Boolean);

  const out=[], seen=new Set();
  for(const c of raw){ if(!c.href) continue; if(seen.has(c.href)) continue; out.push(c); seen.add(c.href); }
  return out;
}

/* ---------- Rendering ---------- */
function renderProductTop(structured){
  const products=structured?.products||[];
  if(!products.length) return null;
  const prod = mergeProductsByPageUrl(products);
  if(!prod) return null;

  const container=document.createElement('div'); container.className='answer';

  // Heading with price(s)
  const h3=document.createElement('h3');
  const o = prod.raw?.offers || {};
  const parts=[];
  if(prod.price!=null) parts.push(toGBP(prod.price));
  if(o.lowPrice!=null || o.highPrice!=null){
    const low = toGBP(o.lowPrice); const high=toGBP(o.highPrice);
    parts.push(low && high ? `${low} â€¢ ${high}` : (low||high));
  }
  h3.textContent = `${prod.title||'Workshop'}${parts.length? ' â€” '+parts.join(' â€¢ ') : ''}`;
  container.appendChild(h3);

  // One-line summary (no long "Dates..." block)
  const summary = firstMeaningfulLine(prod.description||'');
  if(summary){
    const p=document.createElement('p'); p.textContent=summary; container.appendChild(p);
  }

  // Parse details from description robustly
  const det = extractKeyDetails(prod.description||'');

  if(det.location){ const p=document.createElement('p'); p.innerHTML=`<strong>Location:</strong> ${escapeHtml(det.location)}`; container.appendChild(p); }
  if(det.participants){ const p=document.createElement('p'); p.innerHTML=`<strong>Participants:</strong> ${escapeHtml(det.participants)}`; container.appendChild(p); }
  if(det.fitness){ const p=document.createElement('p'); p.innerHTML=`<strong>Fitness:</strong> ${escapeHtml(det.fitness)}`; container.appendChild(p); }
  if(det.availability){ const p=document.createElement('p'); p.innerHTML=`<strong>Availability:</strong> ${escapeHtml(det.availability)}`; container.appendChild(p); }

  // Session options with mapped prices
  const opts = deriveOptionPrices(prod, det.sessions||[]);
  if(opts.length){
    const ul=document.createElement('ul');
    opts.forEach(o=>{
      const li=document.createElement('li');
      li.innerHTML = `${escapeHtml(o.text)}${o.price!=null ? ' â€” <strong>'+toGBP(o.price)+'</strong>' : ''}`;
      ul.appendChild(li);
    });
    container.appendChild(ul);
  }

  return { node:container, productUrl: prod.page_url || prod.url || prod.source_url || null };
}

function renderEventsBlock(structured){
  const container=document.createElement('div'); container.className='answer';
  const now=new Date();
  const future=(structured?.events||[])
    .filter(e=>e?.date_start && !isNaN(Date.parse(e.date_start)) && new Date(e.date_start)>=now)
    .sort((a,b)=>new Date(a.date_start)-new Date(b.date_start))
    .slice(0,12);

  if(future.length){
    const heading = structured?.topic ? `Upcoming ${structured.topic} Workshops` : 'Upcoming Workshops';
    const h=document.createElement('h3'); h.textContent=heading; container.appendChild(h);
    const ul=document.createElement('ul');
    future.forEach(e=>{
      const li=document.createElement('li');
      const when=fmtDate(e.date_start);
      const href=e.page_url||e.source_url||'#';
      const a=document.createElement('a'); a.href=href; a.target='_blank'; a.rel='noopener'; a.textContent='Link';
      li.innerHTML=`${when} â€” `; li.appendChild(a);
      if(e.location) li.insertAdjacentText('beforeend',` â€” ${e.location}`);
      ul.appendChild(li);
    });
    container.appendChild(ul);
  }
  return {node:container};
}

function renderAnswer(payload){
  // render product first
  let renderedProduct=false;
  if(payload.structured){
    const top=renderProductTop(payload.structured);
    if(top){
      const b=addBubble(top.node);
      renderedProduct=true;
      const chips=createChips(payload.structured, payload.citations||[]);
      if(chips.length){
        const wrap=document.createElement('div'); wrap.className='chips';
        chips.forEach(c=>{
          const a=document.createElement('a'); a.href=c.href; a.target='_blank'; a.rel='noopener'; a.textContent=c.label;
          if(c.brand) a.classList.add('brand'); wrap.appendChild(a);
        });
        b.appendChild(wrap);
      }
    }
  }

  // only show markdown if NO product was rendered
  if(!renderedProduct){
    const md = payload.answer_markdown || payload.answer || '';
    if(md){ const {html}=mdToHtml(md); addBubble(html); }
  }

  // always show events (if present)
  if(payload.structured){
    const ev=renderEventsBlock(payload.structured);
    addBubble(ev.node);
  }

  // debug
  dbgStruct.textContent=safeJSONString(payload.structured||{});
}

/* Network */
async function sendQuery(query){
  const req={query, topK:8};
  dbgReq.textContent=safeJSONString(req);
  const closeTyping=addTyping();
  try{
    const res=await fetch(CHAT_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(req)});
    dbgStatus.textContent=res.status;
    const headers={}; res.headers.forEach((v,k)=>headers[k]=v); dbgHeaders.textContent=safeJSONString(headers);
    const data=await res.json(); dbgRes.textContent=safeJSONString(data); dbgProv.textContent=safeJSONString({citations:data.citations||[]});
    closeTyping();
    if(data) renderAnswer(data);
  }catch(err){
    closeTyping(); dbgStatus.textContent='error';
    addBubble(`<div class="answer"><p>Something went wrong: ${escapeHtml(String(err))}</p></div>`);
  }
}

/* Composer */
function submit(){
  const val=input.value.trim(); if(!val) return;
  addBubble(val,{user:true}); input.value=''; sendQuery(val);
}
sendBtn.addEventListener('click', submit);
input.addEventListener('keydown', e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); submit(); }});
</script>
</body>
</html>
