<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alan Ranger Assistant</title>
  <style>
    :root{
      --bg:#0f1420;
      --card:#1a2130;
      --card-2:#202a3d;
      --text:#e9eefb;
      --muted:#b7c2da;
      --brand:#ffae1a;
      --brand-2:#53d36b;
      --accent:#5aa2ff;
      --danger:#ff5577;
      --border:#293147;
      --pill:#2b3650;
      --pill-muted:#2a3349;
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      color:var(--text);
      background:radial-gradient(1200px 600px at 50% -200px,#141a29 0%,#0f1420 60%);
      letter-spacing:.2px;
    }
    a{color:#a9c7ff;text-decoration:none}
    a:hover{text-decoration:underline}
    .container{
      max-width:980px;
      margin:0 auto;
      padding:28px 18px 120px;
    }

    /* Header */
    .header{
      position:sticky;top:0;z-index:10;
      background:linear-gradient(180deg,rgba(15,20,32,.95),rgba(15,20,32,.70));
      backdrop-filter:saturate(120%) blur(8px);
      border-bottom:1px solid var(--border);
    }
    .header-inner{
      max-width:980px;margin:0 auto;padding:16px 18px 14px;
      display:flex;align-items:center;gap:16px;
    }
    .logo{
      width:42px;height:42px;border-radius:50%;
      display:grid;place-items:center;
      border:2px solid #b9c7ff;color:#b9c7ff;font-weight:700;
      box-shadow:0 0 0 3px rgba(90,162,255,.15);
    }
    .brand{
      display:flex;flex-direction:column;gap:2px;margin-right:auto
    }
    .brand h1{margin:0;font-size:22px;font-weight:700}
    .brand small{color:var(--muted);opacity:.9}

    /* Pills in header */
    .h-pills{display:flex;gap:10px}
    .btn-pill{
      padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.08);
      font-weight:600;cursor:pointer;display:inline-flex;gap:8px;align-items:center;
      background:var(--card-2);color:var(--text);box-shadow:var(--shadow);
    }
    .btn-pill.brand{background:var(--brand);color:#1f1400;border-color:#d69100}
    .btn-pill.green{background:var(--brand-2);color:#00220a;border-color:#2eb34e}
    .btn-pill:active{transform:translateY(1px)}

    /* Input ask box (hero) */
    .ask-wrap{margin:18px auto 8px;max-width:980px;padding:0 18px}
    .ask{
      background:var(--card);border:1px solid var(--border);border-radius:14px;
      padding:8px;display:flex;gap:10px;align-items:center;box-shadow:var(--shadow);
    }
    .ask input{
      flex:1;background:#111827;border:1px solid #2a344d;border-radius:10px;
      padding:12px 14px;color:var(--text);outline:none;
    }
    .ask button{
      background:var(--brand);color:#1f1400;border:1px solid #d69100;
      padding:10px 16px;border-radius:12px;font-weight:700;cursor:pointer;
    }
    .hint{font-size:12px;color:var(--muted);margin:6px 6px 0}

    /* Cards */
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .section{padding:18px}
    .section + .section{border-top:1px solid var(--border)}
    .title{
      font-weight:800;margin:0 0 10px;font-size:18px;
    }

    /* Product block (markdownish) */
    .product{
      margin-top:16px
    }
    .product h3{margin:0 0 8px;font-size:17px}
    .product p{margin:6px 0;color:#dfe6fb}
    .product ul{margin:8px 0 0 18px}
    .product li{margin:4px 0}

    /* Confidence pill in card header */
    .confidence{
      position:absolute;top:10px;right:12px;background:var(--accent);
      color:white;font-weight:800;border-radius:999px;padding:5px 10px;
      font-size:12px;box-shadow:0 6px 18px rgba(90,162,255,.28);user-select:none
    }
    .card-head{
      position:relative;padding:16px 18px 8px;border-bottom:1px solid var(--border);
    }
    .card-head h2{margin:0;font-size:20px}

    /* Event list */
    .events{padding:14px 18px}
    .events h3{margin:0 0 10px}
    .events ul{margin:0;padding-left:22px}
    .events li{margin:6px 0;color:#dfe6fb}
    .events small{color:#9fb2d9}
    .events a{font-weight:700}

    /* Articles list */
    .articles{padding:14px 18px}
    .articles h3{margin:0 0 10px}
    .articles ul{margin:0;padding-left:22px}
    .articles li{margin:6px 0}

    /* Pills row (below blocks) */
    .pills{
      display:flex;flex-wrap:wrap;gap:10px;padding:12px 18px 16px;border-top:1px solid var(--border)
    }
    .pill{
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);
      background:var(--pill);color:#dfe6fb;font-weight:700;display:inline-flex;gap:8px;align-items:center
    }
    .pill.brand{background:var(--brand);color:#1f1400;border-color:#d69100}
    .pill.secondary{background:var(--pill-muted)}
    .pill a{color:inherit;text-decoration:none}

    /* Debug toggle */
    .debug-wrap{margin:18px 0 0}
    details.debug{background:#0e1626;border:1px dashed #314066;border-radius:14px}
    details.debug>summary{
      list-style:none;padding:12px 14px;border-bottom:1px dashed #314066;cursor:pointer;
      color:#bcd0ff;font-weight:700
    }
    details.debug>summary::-webkit-details-marker{display:none}
    .debug-body{padding:14px}
    pre{white-space:pre-wrap;word-break:break-word;background:#0a1120;border-radius:10px;border:1px solid #1f2b46;padding:12px;color:#bcd0ff}

    /* Footer input bar */
    .footer{
      position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(15,20,32,.2),rgba(15,20,32,.9) 30%,rgba(15,20,32,1) 90%);
      padding:14px;border-top:1px solid var(--border)
    }
    .footer-inner{max-width:980px;margin:0 auto;display:flex;gap:10px}
    .footer input{
      flex:1;background:#111827;border:1px solid #2a344d;border-radius:12px;padding:12px 14px;color:var(--text);outline:none;
    }
    .footer button{
      background:var(--brand);color:#1f1400;border:1px solid #d69100;border-radius:12px;padding:10px 16px;font-weight:800;cursor:pointer
    }

    /* Utility rows */
    .row{display:flex;gap:12px;align-items:center}
    .row.right{justify-content:flex-end}
    .controls{margin:10px 0 18px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#152037;color:#cfe0ff;border:1px solid #2a3656;font-weight:700
    }
    .muted{color:var(--muted)}
    .sr{position:absolute;left:-10000px;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>
  <!-- Sticky header -->
  <div class="header">
    <div class="header-inner">
      <div class="logo">R</div>
      <div class="brand">
        <h1>Alan Ranger Assistant</h1>
        <small>I‚Äôm Alan‚Äôs AI assistant, trained on content from this website to help with workshops, tuition, and photography questions. If I can‚Äôt help, please contact Alan directly.</small>
      </div>
      <div class="h-pills">
        <a class="btn-pill brand" href="https://www.alanranger.com/contact" target="_blank" rel="noopener">Contact form</a>
        <a class="btn-pill green" href="https://wa.me/447971164748" target="_blank" rel="noopener">WhatsApp</a>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Prompt box near top -->
    <div class="ask-wrap">
      <div class="ask">
        <input id="qTop" placeholder='Ask a question‚Ä¶ (Shift+Enter for newline)' />
        <button id="sendTop">Send</button>
      </div>
      <div class="hint">Try: ‚Äúwhen are the next bluebell workshops and what do they cost?‚Äù</div>
    </div>

    <!-- Response card placeholder -->
    <div id="card" class="card" style="margin-top:18px; display:none;">
      <div class="card-head">
        <h2 id="cardTitle">Result</h2>
        <div id="confPill" class="confidence">Confidence: 0%</div>
      </div>

      <div id="productSec" class="section product" style="display:none;"></div>
      <div id="eventsSec" class="events" style="display:none;"></div>
      <div id="articlesSec" class="articles" style="display:none;"></div>

      <div id="pillsRow" class="pills" style="display:none;"></div>
    </div>

    <!-- Controls under card -->
    <div class="controls row right" id="controlsRow" style="display:none;">
      <button id="emailBtn" class="btn-pill">Email transcript</button>
      <button id="resetBtn" class="btn-pill">Reset chat</button>
    </div>

    <!-- Debug -->
    <div class="debug-wrap">
      <details id="debugDetails" class="debug">
        <summary>üîé Show debug</summary>
        <div class="debug-body">
          <div class="row" style="flex-wrap:wrap;gap:8px;margin-bottom:10px">
            <span id="dbgIntent" class="chip">Intent: <em class="muted" style="font-style:normal;margin-left:6px">‚Äì</em></span>
            <span id="dbgTopic" class="chip">Topic: <em class="muted" style="font-style:normal;margin-left:6px">‚Äì</em></span>
            <span id="dbgDuration" class="chip">Latency: <em class="muted" style="font-style:normal;margin-left:6px">‚Äì</em></span>
          </div>
          <pre id="debugPre">No response yet.</pre>
        </div>
      </details>
    </div>
  </div>

  <!-- Footer input -->
  <div class="footer">
    <div class="footer-inner">
      <input id="qBottom" placeholder="Ask a question‚Ä¶ (Shift+Enter for newline)" />
      <button id="sendBottom">Send</button>
    </div>
  </div>

  <script>
    // ------------------- tiny helpers -------------------
    const $ = (s)=>document.querySelector(s);
    const fmt = (n)=>String(n ?? "");
    const stopWords = new Set(["when","where","whats","what","cost","next","dates","date","workshop","workshops","upcoming","near","me","the","and","or","how","much","price","prices"]);
    function deriveEventsTitle(topic){
      const toks = (topic||"").split(/[, ]+/).map(s=>s.trim().toLowerCase()).filter(Boolean);
      const keep = toks.filter(t=>!stopWords.has(t));
      return `Upcoming ${keep.length? keep[0] + " " : ""}Workshops`;
    }
    function escapeHtml(s){
      return s.replace(/[&<>"]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m]));
    }
    // Minimal markdown: **bold**, "- " lists, newlines -> <br> (inside p), preserve paragraphs
    function mdToHtml(md){
      if(!md) return "";
      const lines = md.split(/\r?\n/);
      let out = [];
      let inList = false;
      const flushList = ()=>{ if(inList){ out.push("</ul>"); inList=false; } };
      for(const raw of lines){
        const line = raw.trimRight();
        if(/^-\s+/.test(line)){
          if(!inList){ out.push("<ul>"); inList=true; }
          const li = line.replace(/^-\s+/, "");
          out.push(`<li>${inline(li)}</li>`);
        }else if(line===""){
          flushList();
          out.push("<p></p>");
        }else{
          flushList();
          out.push(`<p>${inline(line)}</p>`);
        }
      }
      flushList();
      return out.join("\n");

      function inline(s){
        // bold
        s = s.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
        // em
        s = s.replace(/\*([^*]+)\*/g, "<em>$1</em>");
        // link [text](url)
        s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
        return s;
      }
    }

    function clearCard(){
      $("#productSec").style.display="none";
      $("#eventsSec").style.display="none";
      $("#articlesSec").style.display="none";
      $("#pillsRow").style.display="none";
      $("#productSec").innerHTML="";
      $("#eventsSec").innerHTML="";
      $("#articlesSec").innerHTML="";
      $("#pillsRow").innerHTML="";
    }

    function buildEventsHtml(list, title){
      const safe = (s)=>escapeHtml(s||"");
      let html = `<h3 class="title">${escapeHtml(title)}</h3>\n<ul>`;
      for(const e of (list||[])){
        const when = safe(e.when);
        const t = safe(e.title);
        const href = e.href ? `<a href="${e.href}" target="_blank" rel="noopener">Link</a>` : "";
        html += `<li><small>${when}</small> ‚Äî ${href}</li>`;
      }
      html += `</ul>`;
      return html;
    }

    function buildArticlesHtml(articles){
      if(!articles?.length) return "";
      let html = `<h3 class="title">Related guides</h3>\n<ul>`;
      for(const a of articles.slice(0,8)){
        const t = escapeHtml(a.title || a.raw?.name || "Read more");
        const u = a.page_url || a.source_url || a.url;
        html += `<li>${t} ‚Äî ${u ? `<a href="${u}" target="_blank" rel="noopener">Link</a>` : ""}</li>`;
      }
      html += `</ul>`;
      return html;
    }

    function renderPills(pills){
      const row = $("#pillsRow");
      if(!pills?.length){ row.style.display="none"; return; }
      for(const p of pills){
        const el = document.createElement(p.url ? "a" : "span");
        el.className = "pill " + (p.brand ? "brand" : "secondary");
        if(p.url){ el.href = p.url; el.target="_blank"; el.rel="noopener"; }
        el.textContent = p.label || "More";
        row.appendChild(el);
      }
      row.style.display="";
    }

    async function ask(query){
      clearCard();
      $("#card").style.display=""; // show shell early
      $("#cardTitle").textContent = "Answer";
      $("#confPill").textContent = "Confidence: ‚Äî";
      $("#controlsRow").style.display="";

      const started = performance.now();
      const res = await fetch("/api/chat", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ query, topK: 8 })
      });
      const payload = await res.json();
      const took = Math.round(performance.now() - started);

      // Debug (current response only)
      $("#dbgIntent").innerHTML = `Intent: <em class="muted" style="margin-left:6px;font-style:normal">${escapeHtml(payload?.structured?.intent || "‚Äì")}</em>`;
      $("#dbgTopic").innerHTML = `Topic: <em class="muted" style="margin-left:6px;font-style:normal">${escapeHtml(payload?.structured?.topic || "‚Äì")}</em>`;
      $("#dbgDuration").innerHTML = `Latency: <em class="muted" style="margin-left:6px;font-style:normal">${took}ms</em>`;
      $("#debugPre").textContent = JSON.stringify(payload, null, 2);

      if(!payload?.ok){
        $("#productSec").style.display="";
        $("#productSec").innerHTML = `<p style="color:#ffb4c4"><strong>Sorry</strong> ‚Äî something went wrong.</p><p class="muted">Please try again, or use the <strong>Contact form / WhatsApp</strong> buttons above to message Alan directly.</p>`;
        $("#confPill").textContent = "Confidence: 0%";
        return;
      }

      const confPct = payload.confidence_pct ?? Math.round((payload.confidence||0)*100);
      $("#confPill").textContent = `Confidence: ${Number.isFinite(confPct) ? confPct : 0}%`;

      const s = payload.structured || {};
      const intent = s.intent || "advice";

      // Title
      $("#cardTitle").textContent = intent === "events" ? "Workshops & availability" : "Guides & advice";

      // Product (markdown)
      if(payload.answer_markdown){
        $("#productSec").innerHTML = mdToHtml(payload.answer_markdown);
        $("#productSec").style.display="";
      }

      // Events
      if(Array.isArray(s.events) && s.events.length){
        const title = deriveEventsTitle(s.topic || "");
        $("#eventsSec").innerHTML = buildEventsHtml(s.events, title);
        $("#eventsSec").style.display="";
      }

      // Articles (if provided)
      if(Array.isArray(s.articles) && s.articles.length){
        $("#articlesSec").innerHTML = buildArticlesHtml(s.articles);
        $("#articlesSec").style.display="";
      }

      // Pills (CTA row)
      renderPills(s.pills);

      // keep debug closed by default
      $("#debugDetails").open = false;
    }

    // --------------- wire inputs / buttons ---------------
    function wireInput(inputEl, btnEl){
      btnEl.addEventListener("click", ()=>{
        const q = inputEl.value.trim();
        if(!q) return;
        ask(q);
        inputEl.value="";
      });
      inputEl.addEventListener("keydown",(e)=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          btnEl.click();
        }
      });
    }
    wireInput($("#qTop"), $("#sendTop"));
    wireInput($("#qBottom"), $("#sendBottom"));

    $("#resetBtn").addEventListener("click", ()=>{
      clearCard();
      $("#card").style.display="none";
      $("#controlsRow").style.display="none";
      $("#debugPre").textContent="No response yet.";
      $("#dbgIntent").innerHTML=`Intent: <em class="muted" style="margin-left:6px;font-style:normal">‚Äì</em>`;
      $("#dbgTopic").innerHTML=`Topic: <em class="muted" style="margin-left:6px;font-style:normal">‚Äì</em>`;
      $("#dbgDuration").innerHTML=`Latency: <em class="muted" style="margin-left:6px;font-style:normal">‚Äì</em>`;
    });

    $("#emailBtn").addEventListener("click", ()=>{
      try{
        const dump = $("#debugPre").textContent || "";
        const blob = new Blob([dump], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "alan-ranger-assistant-transcript.json";
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
      }catch(e){ alert("Could not create transcript file."); }
    });

    // Nice first focus
    $("#qTop").focus();
  </script>
</body>
</html>
