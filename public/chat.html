<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Alan Ranger Assistant</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0e1726; --panel:#121C2D; --text:#DDE7F6; --muted:#93A4C1; --bubble:#1B2A44;
  --brand:#E57200; --wa:#25D366; --ring:rgba(229,114,0,.35);
  --input-bg:#E9EEF5; --input-text:#0b0f16; --input-border:#CBD5E1; --input-ph:#6b7280;
  --chip-bg:#13203e; --chip-br:#1b2540; --link:#9cd3ff; --link-hover:#cfe7ff;
  --user-bg:#e6edf7; --user-text:#0b0f16;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;line-height:1.45}
.wrap{max-width:980px;margin:28px auto;padding:0 16px}
.card{background:var(--panel);border-radius:14px;box-shadow:0 6px 22px rgba(0,0,0,.35);border-top:6px solid var(--brand);padding:28px}
.header{display:flex;flex-direction:column;align-items:center;gap:14px;margin-bottom:12px}
.logo{display:block;height:72px;width:auto;object-fit:contain;object-position:center;filter:drop-shadow(0 2px 6px rgba(0,0,0,.45))}
.title{margin:0;font-size:34px;font-weight:300;letter-spacing:.2px}
.sub{margin:0;text-align:center;color:var(--muted);max-width:720px;font-size:16px}
.pills{display:flex;gap:10px;margin:12px 0 4px}
.pill{appearance:none;border:0;border-radius:28px;padding:8px 12px;font-weight:600;font-size:14px;color:#0b0f16;cursor:pointer;line-height:1;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
.pill--brand{background:var(--brand)} .pill--wa{background:var(--wa)}

.chat{margin-top:12px;border-radius:14px;background:#0f1828;padding:18px}
.thread{display:flex;flex-direction:column;gap:12px}
.bubble{background:var(--bubble);padding:14px 16px;border-radius:12px;max-width:780px}
.bubble.user{align-self:flex-end;background:var(--user-bg);color:var(--user-text);border:1px solid #d3deee}
.answer h1,.answer h2,.answer h3{margin:.2em 0}
.answer p{margin:.5em 0}
.answer ul{margin:.4em 0 .6em 1.25em}
.answer li{margin:.15em 0}
.answer a{color:var(--link);text-decoration:underline}
.answer a:hover{color:var(--link-hover)}

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.chips a{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--chip-br);background:var(--chip-bg);color:#cfe3ff;text-decoration:none}
.chips a.brand{background:var(--brand);color:#0b0f16;border-color:#c66000}
.chips a:hover{opacity:.9}

/* Composer */
.composer{display:flex;gap:10px;margin-top:14px;padding:12px;background:var(--panel);border-radius:12px}
.composer input{flex:1;background:var(--input-bg);color:var(--input-text);border:1px solid var(--input-border);border-radius:10px;padding:12px 14px;outline:0}
.composer input::placeholder{color:var(--input-ph)}
.composer input:focus{border-color:var(--ring);box-shadow:0 0 0 4px var(--ring)}
.send{background:var(--brand);color:#0b0f16;font-weight:700;border:0;border-radius:10px;padding:0 18px;cursor:pointer}

/* Debug */
details.debug{margin-top:14px;background:#0f1828;border:1px solid #15223a;border-radius:10px;padding:10px 12px}
details.debug summary{cursor:pointer;color:#9eb2d3;font-weight:600;outline:none}
.kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin-top:10px}
.kv label{color:#93A4C1}
pre.json{white-space:pre-wrap;word-break:break-word;margin:0;padding:8px;background:#0b1422;border:1px solid #15223a;border-radius:8px;color:#cfe3ff;font-size:12px;line-height:1.4}

/* Typing */
.typing{position:relative;display:inline-block}
.typing .dot{display:inline-block;width:6px;height:6px;margin:0 2px;border-radius:50%;background:#9eb2d3;opacity:.6;animation:bounce 1.2s infinite}
.typing .dot:nth-child(2){animation-delay:.15s}
.typing .dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-4px)}}

@media (max-width:540px){.title{font-size:26px}.logo{height:60px}.kv{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap"><div class="card">
  <div class="header">
    <img class="logo" src="./chat%20white.png" alt="AR logo">
    <h2 class="title">Alan Ranger Assistant</h2>
    <p class="sub">Iâ€™m Alanâ€™s AI assistant, trained on content from this website to help with workshops, tuition, and photography questions. I wonâ€™t always get everything right â€” if I canâ€™t help, please contact Alan directly:</p>
    <div class="pills">
      <a class="pill pill--brand" target="_blank" rel="noopener" href="https://www.alanranger.com/contact-us-alan-ranger-photography">Contact form</a>
      <a class="pill pill--wa" target="_blank" rel="noopener" href="https://wa.me/447817017994">WhatsApp</a>
    </div>
  </div>

  <div class="chat">
    <div id="thread" class="thread">
      <div class="bubble">Hi! I can help with workshops, tuition, and photography advice.</div>
    </div>

    <details id="debugPanel" class="debug">
      <summary>ðŸ”Ž Show debug</summary>
      <div class="kv"><label>Endpoint</label><div>/api/chat</div></div>
      <div class="kv"><label>Status</label><div id="dbg-status">â€“</div></div>
      <div class="kv"><label>Headers</label><pre id="dbg-headers" class="json">â€“</pre></div>
      <div class="kv"><label>Request</label><pre id="dbg-req" class="json">â€“</pre></div>
      <div class="kv"><label>Response</label><pre id="dbg-res" class="json">â€“</pre></div>
    </details>

    <div class="composer">
      <input id="q" placeholder="Ask a questionâ€¦ (Shift+Enter for newline)"/>
      <button id="send" class="send">Send</button>
    </div>
  </div>
</div></div>

<script>
/* ===== Config / helpers ===== */
const CHAT_ENDPOINT = '/api/chat';
const HARDCODED = ''; // optional override
const urlParams = new URLSearchParams(location.search);
if (urlParams.get('debug') === '1') requestAnimationFrame(()=>{ document.getElementById('debugPanel').open = true; });

function getToken(){
  const qp = (urlParams.get('token')||'').trim();
  if (HARDCODED) return HARDCODED;
  if (qp) return qp;
  try { return (localStorage.getItem('ingest_token')||'').trim(); } catch { return ''; }
}

const thread = document.getElementById('thread');
const input  = document.getElementById('q');
const sendBtn= document.getElementById('send');
const dbgStatus   = document.getElementById('dbg-status');
const dbgReq      = document.getElementById('dbg-req');
const dbgRes      = document.getElementById('dbg-res');
const dbgHeaders  = document.getElementById('dbg-headers');

function safeJSONString(v){ try { return JSON.stringify(v, null, 2); } catch { return String(v); } }
function maskToken(t){ if(!t) return ''; return t.length<=8 ? 'â€¢â€¢â€¢â€¢' : t.slice(0,4)+'â€¢â€¢â€¢'+t.slice(-4); }
function setDebug({status, req, res, headers}){
  if (status !== undefined) dbgStatus.textContent = String(status);
  if (req !== undefined) dbgReq.textContent = safeJSONString(req);
  if (res !== undefined) dbgRes.textContent = safeJSONString(res);
  if (headers !== undefined) {
    const h = {...headers}; if (h.Authorization) h.Authorization = 'Bearer ' + maskToken((h.Authorization.split(' ')[1]||'')); 
    dbgHeaders.textContent = safeJSONString(h);
  }
}
function addBubble(html, opts={}) {
  const div = document.createElement('div');
  div.className = 'bubble' + (opts.user ? ' user' : '');
  div.innerHTML = html;
  thread.appendChild(div);
  div.scrollIntoView({behavior:'smooth', block:'end'});
  return div;
}
function addTyping() {
  const el = addBubble(`<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`);
  return () => el && el.remove();
}

/* ===== Normalisers ===== */
const asArray = (v) => Array.isArray(v) ? v : (v ? [v] : []);
const normStr = (s) => (s==null) ? '' : String(s).trim();
const toGBP = (p, c) => {
  if (p == null || p === '') return null;
  let n = (typeof p === 'number') ? p : parseFloat(String(p).replace(/[^\d.]/g,''));
  if (!isFinite(n)) return null;
  const cc = (normStr(c) || 'GBP').toUpperCase();
  const sym = (cc === 'GBP' || cc === 'UKP' || cc === 'GBÂ£') ? 'Â£' : (cc + ' ');
  return sym + n.toFixed(0);
};
const parseDate = (s) => { if (!s) return null; const d = new Date(s); return isNaN(d.getTime()) ? null : d; };

/* ===== URL scoring ===== */
function bestUrlFrom(list, ...hints){
  const cand = asArray(list).filter(Boolean);
  if (!cand.length) return null;
  const scored = cand.map(u=>{
    const L = u.toLowerCase(); let score = 0;
    for (const h of hints){ if (!h) continue;
      const t = h.toLowerCase(); if (L.includes(t)) score += 2;
      for (const w of t.split(/[^\w]+/).filter(x=>x.length>3)){ if (L.includes(w)) score += 1; }
    }
    score += Math.min(3, (u.split('/').length - 3)); // deeper looks more specific
    return {u, score};
  }).sort((a,b)=>b.score-a.score);
  return scored[0]?.u || cand[0];
}

/* ===== Extract structured from payload ===== */
function extractStructured(payload){
  const cites = asArray(payload?.citations).filter(Boolean);
  const struct = payload?.structured || {};
  let events = asArray(struct.events).map(e=>({
    title: normStr(e.title),
    url: normStr(e.url || e.source_url),
    source_url: normStr(e.source_url || e.url),
    date_start: normStr(e.date_start),
    date_end: normStr(e.date_end),
    location: normStr(e.location),
    price: e.price ?? null,
    price_currency: normStr(e.price_currency),
  }));
  let productsRaw = asArray(struct.products);
  const products = productsRaw.map(p=>{
    const offers = asArray(p.offers || p.offer);
    return {
      title: normStr(p.title || p.name),
      url: normStr(p.url || p.source_url),
      source_url: normStr(p.source_url || p.url),
      price: p.price ?? null,
      price_currency: normStr(p.price_currency || p.currency),
      availability: normStr(p.availability),
      offers: offers.map(o=>({
        name: normStr(o.name || o.title || ''),
        price: o.price ?? null,
        price_currency: normStr(o.priceCurrency || o.price_currency),
        url: normStr(o.url || o.source_url || p.url || p.source_url),
        description: normStr(o.description || '')
      }))
    };
  });

  // populate missing event URLs from the best known page
  const hint = bestUrlFrom(
    [...events.map(e=>e.url), ...events.map(e=>e.source_url), ...products.map(p=>p.url || p.source_url), ...cites],
    'workshop', 'bluebell', 'photography'
  );
  events = events.map(e=> (e.url ? e : {...e, url: hint || e.source_url}) );

  return { events, products, citations: cites };
}

/* ===== Price detection (half/full/offers/generic) ===== */
function minePrices({events, products}){
  let half=null, full=null, generic=[], currency='GBP';
  for (const e of events){
    if (e.price != null){ const v = toGBP(e.price, e.price_currency); if (v && !generic.includes(v)) generic.push(v); if (e.price_currency) currency=e.price_currency; }
  }
  for (const p of products){
    if (p.price != null){ const v = toGBP(p.price, p.price_currency); if (v && !generic.includes(v)) generic.push(v); if (p.price_currency) currency=p.price_currency; }
    for (const o of asArray(p.offers)){
      const label = (o.name || '').toLowerCase();
      const v = toGBP(o.price, o.price_currency);
      if (!v) continue;
      if (/(^|\b)(half|4h|4-hour|4 hours|4hr|half day)(\b|$)/.test(label)) half = half || v;
      if (/(^|\b)(full|1 day|day|full day)(\b|$)/.test(label))       full = full || v;
      if (!half && /4:? ?(h|hr)/.test(label)) half = v;
      if (!full && /(full|1\s*day)/.test(label)) full = v;
      if (!half && !full && !generic.includes(v)) generic.push(v);
    }
  }
  generic = generic.filter(v => v !== half && v !== full);
  return { half, full, generic, currency };
}

/* ===== Time window extraction (from offer names/descriptions only) ===== */
function timesFromOffers(products){
  const re = /\b(?:[01]?\d|2[0-3]):?[0-5]\d\s?(?:am|pm)\b/gi; // 5:45 am, 10:30am etc
  const windows = new Set();
  for (const p of products){
    for (const o of asArray(p.offers)){
      const text = (o.name + ' ' + (o.description||'')).toLowerCase();
      const hits = (text.match(re)||[]).map(s=>s.replace(/\s+/g,' ').replace(/am|pm/g,m=>' '+m));
      if (hits.length >= 2){
        // pair adjacent hits as ranges
        for (let i=0;i<hits.length-1;i+=2){
          windows.add(`${hits[i]} â€“ ${hits[i+1]}`);
        }
      }
    }
  }
  return Array.from(windows);
}

/* ===== Context pills ===== */
function buildPills({events, products, citations}){
  const pills = [];
  const productUrls = products.map(p=>p.url || p.source_url).filter(Boolean);
  const eventUrls   = events.map(e=>e.url || e.source_url).filter(Boolean);
  const allUrls     = [...eventUrls, ...productUrls, ...citations].filter(Boolean);
  const push = (label, urls, brand=false) => {
    const u = bestUrlFrom(urls, 'workshop','prices','bluebell');
    if (u) pills.push({label, href:u, brand});
  };
  push('Prices',            [...productUrls, ...allUrls], true);
  push('Upcoming dates',    [...eventUrls,   ...allUrls], true);
  push('Workshops overview',[...allUrls],                  true);
  const bluebell = bestUrlFrom(allUrls, 'bluebell');
  if (bluebell) pills.push({label:'bluebell-woods-near-me', href:bluebell, brand:false});
  const uniq = new Map();
  for (const p of pills){ if (!uniq.has(p.href)) uniq.set(p.href, p); if (uniq.size>=6) break; }
  return Array.from(uniq.values());
}
function addChips(holder, chips){
  if (!chips.length) return;
  const wrap = document.createElement('div'); wrap.className='chips';
  for (const c of chips){
    const a=document.createElement('a'); a.href=c.href; a.target='_blank'; a.rel='noopener';
    a.className=c.brand?'brand':''; a.textContent=c.label; wrap.appendChild(a);
  }
  holder.appendChild(wrap);
}

/* ===== Structured render (no hard-coded times; no duplicates) ===== */
function renderStructured(payload, question){
  const holder = addBubble('<div class="answer"></div>');
  const wrap = holder.querySelector('.answer');

  const struct = extractStructured(payload);
  const { events, products, citations } = struct;

  // upcoming events
  const now = new Date(); now.setHours(0,0,0,0);
  const upcoming = events
    .map(e=>({ ...e, _start: parseDate(e.date_start) }))
    .filter(e=>e._start && e._start >= now)
    .sort((a,b)=>a._start - b._start);

  const primaryLink = bestUrlFrom(
    [...upcoming.map(e=>e.url), ...products.map(p=>p.url || p.source_url), ...citations],
    'bluebell','workshop','photography'
  );

  const prices = minePrices(struct);
  const slots  = timesFromOffers(products); // only if present in product offers

  let html = '';
  html += `<h3>Upcoming Bluebell Workshop Dates:</h3>`;
  if (upcoming.length){
    html += `<ul>`;
    for (const e of upcoming){
      const label = e._start.toLocaleDateString(undefined, { weekday:'short', day:'2-digit', month:'short', year:'numeric' });
      const url = e.url || e.source_url || primaryLink || '#';
      const link = url ? `<a href="${url}" target="_blank" rel="noopener">Link</a>` : '';
      html += `<li><strong>${label}</strong> ${link}</li>`;
    }
    html += `</ul>`;
  } else {
    html += `<p>No dated sessions found in the structured data for this page.</p>`;
  }

  const loc = upcoming.find(e=>e.location)?.location || events.find(e=>e.location)?.location || '';
  if (loc) html += `<p><strong>Location:</strong> ${loc}</p>`;

  if (prices.half || prices.full || prices.generic.length){
    html += `<p><strong>Price:</strong></p><ul>`;
    if (prices.half) html += `<li>4 hours: ${prices.half}</li>`;
    if (prices.full) html += `<li>Full day: ${prices.full}</li>`;
    for (const g of prices.generic) html += `<li>${g}</li>`;
    html += `</ul>`;
  } else {
    html += `<p><strong>Price:</strong> ETBD (not present in structured data returned with this answer).</p>`;
  }

  if (slots.length){
    html += `<h4>Workshop Schedule</h4><ul>`;
    for (const s of slots) html += `<li>${s}</li>`;
    html += `</ul>`;
  }

  if (primaryLink){
    html += `<p>For more information or to book, visit: <a href="${primaryLink}" target="_blank" rel="noopener">the workshop page</a>.</p>`;
  }

  wrap.innerHTML = html;
  addChips(holder, buildPills(struct));
}

/* ===== Fallback ===== */
function fallbackBlock(){
  return `
    <div class="answer">
      <p>I donâ€™t have a confident answer yet. Please visit Alanâ€™s site for details:</p>
      <div class="chips">
        <a class="brand" target="_blank" rel="noopener" href="https://www.alanranger.com/photography-workshops-near-me">Workshops overview</a>
        <a class="brand" target="_blank" rel="noopener" href="https://www.alanranger.com/photo-workshops-uk/bluebell-woodlands-photography-workshops">Bluebell workshop</a>
        <a class="brand" target="_blank" rel="noopener" href="https://www.alanranger.com/photography-workshops-near-me#prices">Prices</a>
      </div>
    </div>`;
}

/* ===== API & orchestrator ===== */
async function callChat(question, topK=8){
  const token = getToken();
  const headers = { 'Content-Type':'application/json' };
  if (token) headers['Authorization'] = 'Bearer ' + token;
  const body = { query: question, topK };
  setDebug({status:'â€¦', req: body, headers});
  const res = await fetch(CHAT_ENDPOINT, { method:'POST', headers, body: JSON.stringify(body) });
  const status = res.status;
  let json; try { json = await res.json(); } catch { json = { error:'non_json', status }; }
  setDebug({status, res: json});
  if(!res.ok) throw new Error('API error');
  return json;
}

function renderAnswer(payload, question){
  const hasStructured = (payload?.structured && (asArray(payload.structured.events).length || asArray(payload.structured.products).length));
  if (hasStructured || asArray(payload?.citations).length){ try { renderStructured(payload, question); return; } catch {} }
  addBubble(fallbackBlock());
}

/* ===== Send ===== */
async function handleSend(){
  const q = input.value.trim();
  if(!q) return;
  addBubble(q.replace(/</g,'&lt;'), {user:true});
  input.value = '';
  const stopTyping = addTyping();
  try{
    const data = await callChat(q, 8);
    stopTyping();
    renderAnswer(data, q);
  }catch{
    stopTyping();
    addBubble(fallbackBlock());
  }
}
sendBtn.addEventListener('click', handleSend);
input.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); }
});
</script>
</body>
</html>
