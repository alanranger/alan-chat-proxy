<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Alan Ranger Assistant</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0e1726; --panel:#121C2D; --text:#DDE7F6; --muted:#93A4C1; --bubble:#1B2A44;
  --brand:#E57200; --wa:#25D366; --ring:rgba(229,114,0,.35);
  --input-bg:#E9EEF5; --input-text:#0b0f16; --input-border:#CBD5E1; --input-ph:#6b7280;
  --chip-bg:#13203e; --chip-br:#1b2540; --link:#9cd3ff; --link-hover:#cfe7ff;
  --user-bg:#e6edf7; --user-text:#0b0f16;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;line-height:1.45}
.wrap{max-width:980px;margin:28px auto;padding:0 16px;position:relative}
.version{position:absolute;right:6px;top:-8px;font-size:12px;color:#9db2d6;background:#0b1422;border:1px solid #1e2d4a;border-radius:8px;padding:2px 6px;opacity:.75}
.card{background:var(--panel);border-radius:14px;box-shadow:0 6px 22px rgba(0,0,0,.35);border-top:6px solid var(--brand);padding:28px}
.header{display:flex;flex-direction:column;align-items:center;gap:14px;margin-bottom:12px}
.logo{display:block;height:72px;width:auto;object-fit:contain;object-position:center;filter:drop-shadow(0 2px 6px rgba(0,0,0,.45))}
.title{margin:0;font-size:34px;font-weight:300;letter-spacing:.2px}
.sub{margin:0;text-align:center;color:var(--muted);max-width:720px;font-size:16px}
.pills{display:flex;gap:10px;margin:12px 0 4px}
.pill{appearance:none;border:0;border-radius:28px;padding:8px 12px;font-weight:600;font-size:14px;color:#0b0f16;cursor:pointer;line-height:1;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
.pill--brand{background:var(--brand)} .pill--wa{background:var(--wa)}

.chat{margin-top:12px;border-radius:14px;background:#0f1828;padding:18px}
.thread{display:flex;flex-direction:column;gap:12px}
.bubble{background:var(--bubble);padding:14px 16px;border-radius:12px;max-width:780px}
.bubble.user{align-self:flex-end;background:var(--user-bg);color:var(--user-text);border:1px solid #d3deee}
.answer h1,.answer h2,.answer h3{margin:.2em 0}
.answer p{margin:.5em 0}
.answer ul{margin:.4em 0 .6em 1.25em}
.answer li{margin:.15em 0}
.answer a{color:var(--link);text-decoration:underline}
.answer a:hover{color:var(--link-hover)}

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.chips a{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--chip-br);background:var(--chip-bg);color:#cfe3ff;text-decoration:none}
.chips a.act{background:var(--brand);color:#0b0f16;border-color:transparent;font-weight:700}
.chips a:hover{opacity:.9}

/* Composer */
.composer{display:flex;gap:10px;margin-top:14px;padding:12px;background:var(--panel);border-radius:12px}
.composer input{flex:1;background:var(--input-bg);color:var(--input-text);border:1px solid var(--input-border);border-radius:10px;padding:12px 14px;outline:0}
.composer input::placeholder{color:var(--input-ph)}
.composer input:focus{border-color:var(--ring);box-shadow:0 0 0 4px var(--ring)}
.send{background:var(--brand);color:#0b0f16;font-weight:700;border:0;border-radius:10px;padding:0 18px;cursor:pointer}

/* Debug panel */
details.debug{margin-top:14px;background:#0f1828;border:1px solid #15223a;border-radius:10px;padding:10px 12px}
details.debug summary{cursor:pointer;color:#9eb2d3;font-weight:600;outline:none}
.kv{display:grid;grid-template-columns:160px 1fr;gap:8px;margin-top:10px}
.kv label{color:#93A4C1}
pre.json{white-space:pre-wrap;word-break:break-word;margin:0;padding:8px;background:#0b1422;border:1px solid #15223a;border-radius:8px;color:#cfe3ff;font-size:12px;line-height:1.4}

/* Typing dots */
.typing{position:relative;display:inline-block}
.typing .dot{display:inline-block;width:6px;height:6px;margin:0 2px;border-radius:50%;background:#9eb2d3;opacity:.6;animation:bounce 1.2s infinite}
.typing .dot:nth-child(2){animation-delay:.15s}
.typing .dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-4px)}}

@media (max-width:540px){.title{font-size:26px}.logo{height:60px}.kv{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <span class="version" id="ver">v0.9.6</span>
  <div class="card">
    <div class="header">
      <img class="logo" src="./chat%20white.png" alt="AR logo">
      <h2 class="title">Alan Ranger Assistant</h2>
      <p class="sub">Iâ€™m Alanâ€™s AI assistant, trained on content from this website to help with workshops, tuition, and photography questions. I wonâ€™t always get everything right â€” if I canâ€™t help, please contact Alan directly:</p>
      <div class="pills">
        <a class="pill pill--brand" target="_blank" rel="noopener" href="https://www.alanranger.com/contact-us-alan-ranger-photography">Contact form</a>
        <a class="pill pill--wa" target="_blank" rel="noopener" href="https://wa.me/447817017994">WhatsApp</a>
      </div>
    </div>

    <div class="chat">
      <div id="thread" class="thread">
        <div class="bubble">Hi! I can help with workshops, tuition, and photography advice.</div>
      </div>

      <details id="debugPanel" class="debug">
        <summary>ðŸ”Ž Show debug</summary>
        <div class="kv"><label>Endpoint</label><div>/api/chat</div></div>
        <div class="kv"><label>Status</label><div id="dbg-status">â€“</div></div>
        <div class="kv"><label>Headers</label><pre id="dbg-headers" class="json">â€“</pre></div>
        <div class="kv"><label>Request</label><pre id="dbg-req" class="json">â€“</pre></div>
        <div class="kv"><label>Response</label><pre id="dbg-res" class="json">â€“</pre></div>
        <div class="kv"><label>Provenance</label><pre id="dbg-prov" class="json">â€“</pre></div>
      </details>

      <div class="composer">
        <input id="q" placeholder="Ask a questionâ€¦ (Shift+Enter for newline)" />
        <button id="send" class="send">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Config / helpers ===== */
const VERSION = 'v0.9.6';
document.getElementById('ver').textContent = VERSION;

const CHAT_ENDPOINT = '/api/chat';
const HARDCODED = 'b6c3f0c9e6f44cce9e1a4f3f2d3a5c76'; // optional
const urlParams = new URLSearchParams(location.search);
if (urlParams.get('debug') === '1') requestAnimationFrame(()=>{ document.getElementById('debugPanel').open = true; });

function getToken(){
  const qp = (urlParams.get('token')||'').trim();
  if (HARDCODED) return HARDCODED;
  if (qp) return qp;
  try { return (localStorage.getItem('ingest_token')||'').trim(); } catch { return ''; }
}
const stopwords = new Set(['photography','photographic','workshop','workshops','photo','near','me','warwickshire','uk','lesson','tuition','course','courses','class','classes','overview','prices','price','dates','date','next','latest','session','sessions','day','full','half','hours','hour','am','pm','with','and','for','the','nearby','around']);

const thread = document.getElementById('thread');
const input  = document.getElementById('q');
const sendBtn= document.getElementById('send');
const dbgStatus   = document.getElementById('dbg-status');
const dbgReq      = document.getElementById('dbg-req');
const dbgRes      = document.getElementById('dbg-res');
const dbgHeaders  = document.getElementById('dbg-headers');
const dbgProv     = document.getElementById('dbg-prov');

function safeJSONString(v){ try { return JSON.stringify(v, null, 2); } catch { return String(v); } }
function maskToken(t){ if(!t) return ''; return t.length<=8 ? 'â€¢â€¢â€¢â€¢' : t.slice(0,4)+'â€¢â€¢â€¢'+t.slice(-4); }
function setDebug({status, req, res, headers, provenance}){
  if (status !== undefined) dbgStatus.textContent = String(status);
  if (req !== undefined) dbgReq.textContent = safeJSONString(req);
  if (res !== undefined) dbgRes.textContent = safeJSONString(res);
  if (headers !== undefined) {
    const h = {...headers}; if (h.Authorization) h.Authorization = 'Bearer ' + maskToken((h.Authorization.split(' ')[1]||'')); 
    dbgHeaders.textContent = safeJSONString(h);
  }
  if (provenance !== undefined) dbgProv.textContent = safeJSONString(provenance);
}

/* ===== UI helpers ===== */
function addBubble(html, opts={}) {
  const div = document.createElement('div');
  div.className = 'bubble' + (opts.user ? ' user' : '');
  div.innerHTML = html;
  thread.appendChild(div);
  div.scrollIntoView({behavior:'smooth', block:'end'});
  return div;
}
function addTyping() {
  const el = addBubble(`<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`);
  return () => el && el.remove();
}

/* ===== Markdown (simple) ===== */
function mdToHtml(md){
  if (!md) return { html:'', liIds:[], items:[] };
  let s = md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
  s = s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  s = s.replace(/(^|[^*])\*([^*\n]+)\*(?!\*)/g,'$1<em>$2</em>').replace(/(^|[^_])_([^_\n]+)_(?!_)/g,'$1<em>$2</em>');
  const lines = s.split(/\r?\n/);
  let out = '', inList = false, liIds = [], items=[], idx=0;
  const flush = ()=>{ if(inList){ out += '</ul>'; inList=false; } };
  for (const line of lines){
    const m = line.match(/^\s*-\s+(.*)$/);
    if (m){
      if(!inList){ out += '<ul>'; inList=true; }
      const text = m[1].trim();
      const id = `li_${++idx}`; liIds.push(id); items.push(text);
      out += `<li id="${id}">${text}</li>`;
    }else{
      flush();
      out += line.trim() ? `<p>${line}</p>` : '';
    }
  }
  flush();
  return { html:`<div class="answer">${out}</div>`, liIds, items };
}

/* ===== Topic inference (generic) ===== */
function tokensOf(s){
  return (s||'').toLowerCase().split(/[^a-z0-9]+/).filter(t=>t && t.length>=5 && !stopwords.has(t));
}
function slugTokens(url){
  try{
    const u = new URL(url);
    return u.pathname.split('/').filter(Boolean).flatMap(seg => seg.toLowerCase().split(/[^a-z0-9]+/)).filter(t=>t.length>=5 && !stopwords.has(t));
  }catch{ return []; }
}
function inferTopic(question, citations, struct, answer){
  const counts = new Map();
  const bump=(t)=> counts.set(t, (counts.get(t)||0)+1);

  tokensOf(question).forEach(bump);
  (citations||[]).forEach(u=> slugTokens(u).forEach(bump));
  (struct?.events||[]).forEach(e=> { tokensOf(e.title).forEach(bump); slugTokens(e.url||e.source_url).forEach(bump); });
  (struct?.products||[]).forEach(p=> { tokensOf(p.title).forEach(bump); slugTokens(p.url||p.source_url).forEach(bump); });
  tokensOf(answer).forEach(bump);

  let best=null, score=-1;
  counts.forEach((v,k)=>{ if (v>score){ score=v; best=k; } });
  const confidence = score>=2 ? 'high' : (score===1 ? 'low' : 'none');
  return { key: best, confidence, counts: Object.fromEntries([...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,8)) };
}

/* ===== Filtering (strict when topic is known) ===== */
function matchTopic(s, key){ if(!key) return true; return (s||'').toLowerCase().includes(key.toLowerCase()); }
function keepByTopic(item, key){
  const t = (item?.title||'') + ' ' + (item?.name||'');
  const u = item?.url || item?.source_url || '';
  return matchTopic(t, key) || matchTopic(u, key);
}

function filterStructured(struct, topic){
  if (!struct) return {events:[], products:[]};
  const eventsAll = struct.events||[];
  const productsAll = struct.products||[];

  const eventsKept   = topic.key ? eventsAll.filter(e=>keepByTopic(e, topic.key)) : eventsAll;
  const productsKept = topic.key ? productsAll.filter(p=>keepByTopic(p, topic.key)) : productsAll;

  return { events: eventsKept, products: productsKept, _rawCounts:{
    in_events:eventsAll.length, kept_events:eventsKept.length,
    in_products:productsAll.length, kept_products:productsKept.length
  }};
}
function filterCitations(cites, topic){
  const all = cites||[];
  if (!topic.key) return all;
  const kept = all.filter(u=>matchTopic(u, topic.key));
  return kept;
}

/* ===== Dates + prices formatting ===== */
const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
function formatDate(d){
  try{
    const dt = (d instanceof Date)? d : new Date(d);
    const day = dt.getUTCDate(); const mon = MONTHS[dt.getUTCMonth()]; const yr = dt.getUTCFullYear();
    return `${mon} ${String(day).padStart(2,'0')}, ${yr}`;
  }catch{ return d||''; }
}
function groupByDate(events){
  const map = new Map();
  for (const e of events){
    const iso = e.date_start || e.date || e.start || e.datetime || '';
    const dayKey = iso ? (new Date(iso)).toISOString().slice(0,10) : (e.title||'').trim();
    const arr = map.get(dayKey)||[];
    arr.push(e); map.set(dayKey, arr);
  }
  // sort by actual date if available; otherwise keep insertion
  const items = [...map.entries()].map(([k,arr])=>({key:k, date: new Date(arr[0].date_start||arr[0].date||arr[0].start||Date.now()), events:arr}));
  items.sort((a,b)=>a.date-b.date);
  return items;
}

function pickMoney(x){
  // schema-first: variants â†’ price_amount â†’ price â†’ amount
  const v = (x?.variants||[]).map(v=>v.price_amount ?? v.price ?? v.amount).filter(n=>Number.isFinite(+n));
  if (v.length) return Math.min(...v.map(Number));
  const top = [x?.price_amount, x?.price, x?.amount, x?.min_price].find(n=>Number.isFinite(+n));
  return top ?? null;
}
function currencyOf(x){
  return x?.price_currency || x?.currency || x?.curr || 'GBP';
}
function formatGBP(n){ try{ return new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP',maximumFractionDigits:0}).format(+n); }catch{ return `Â£${(+n).toFixed(0)}`; } }

function splitHalfFull(products){
  // Try to separate "4 hour / half day" vs "full day"
  const out = { half:null, full:null, any:null, halfLink:null, fullLink:null, anyLink:null };
  for (const p of products){
    const price = pickMoney(p);
    const link  = p.url || p.source_url || '';
    const title = (p.title||'').toLowerCase();
    if (price==null) continue;
    if (/half|4\s*hour|4hr|4\s*hrs/.test(title)){ if (out.half==null || price<out.half){ out.half = price; out.halfLink = link; } }
    else if (/full|day\b/.test(title)){ if (out.full==null || price<out.full){ out.full = price; out.fullLink = link; } }
    else { if (out.any==null || price<out.any){ out.any = price; out.anyLink = link; } }
  }
  return out;
}

/* ===== Link labelling ===== */
function niceLabel(u){
  try{
    const url = new URL(u);
    const parts = url.pathname.split('/').filter(Boolean).slice(-2).join(' / ') || url.hostname;
    return (parts.length>40 ? parts.slice(0,37)+'â€¦' : parts);
  }catch{ return 'Open'; }
}

/* ===== Build answer block ===== */
function buildAnswerHTML({question, answer, citations, structured}){
  const topic = inferTopic(question, citations, structured, answer);
  const filtered = filterStructured(structured, topic);
  const citesKept = filterCitations(citations, topic);

  // Build HTML
  let html = '';
  if (topic.key) html += `<p><strong>Topic detected:</strong> ${topic.key}</p>`;

  // Dates
  const ev = filtered.events||[];
  if (ev.length){
    html += `<h3>Upcoming ${topic.key ? (topic.key[0].toUpperCase()+topic.key.slice(1)+' ') : ''}Workshop Dates:</h3><ul>`;
    const groups = groupByDate(ev);
    for (const g of groups){
      // choose a representative link from the group
      const link = g.events.find(e=>e.url || e.source_url) || g.events[0];
      const href = link?.url || link?.source_url || '#';
      const dateText = formatDate(g.date);
      html += `<li><strong>${dateText}</strong> <a href="${href}" target="_blank" rel="noopener">Link</a></li>`;
    }
    html += `</ul>`;
  }

  // Price block
  const pr = filtered.products||[];
  if (pr.length){
    const {half, full, any, halfLink, fullLink, anyLink} = splitHalfFull(pr);
    const curr = currencyOf(pr[0]) || 'GBP';
    html += `<h3>Price:</h3><ul>`;
    if (half!=null){ html += `<li>4 hours: ${curr==='GBP'?formatGBP(half):half} <a href="${halfLink||'#'}" target="_blank" rel="noopener">Link</a></li>`; }
    if (full!=null){ html += `<li>Full day: ${curr==='GBP'?formatGBP(full):full} <a href="${fullLink||'#'}" target="_blank" rel="noopener">Link</a></li>`; }
    if (half==null && full==null && any!=null){ html += `<li>From: ${curr==='GBP'?formatGBP(any):any} <a href="${anyLink||'#'}" target="_blank" rel="noopener">Link</a></li>`; }
    if (half==null && full==null && any==null){ html += `<li>Not specified in the provided context.</li>`; }
    html += `</ul>`;
  }

  // If nothing structured, just render the LLM answer
  if (!ev.length && !pr.length){
    const md = mdToHtml(answer||'');
    html += md.html;
  }

  // Context pills (only from filtered assets)
  const chips = [];
  // Prefer event/product links
  const firstEvent  = (filtered.events||[]).find(e=>e.url||e.source_url);
  const firstProd   = (filtered.products||[]).find(p=>p.url||p.source_url);
  const firstCite   = (citesKept||[])[0];

  if (firstProd) chips.push({label:'Prices', href:firstProd.url || firstProd.source_url, act:true});
  if (firstEvent) chips.push({label:'Upcoming dates', href:firstEvent.url || firstEvent.source_url, act:true});
  if (firstCite) chips.push({label:'Workshops overview', href:firstCite, act:true});
  // Add remaining filtered citations (up to 6 total)
  (citesKept||[]).slice(0,6).forEach(u=>{
    if (!chips.some(c=>c.href===u)) chips.push({label:niceLabel(u), href:u});
  });

  const wrap = document.createElement('div');
  const holder = addBubble(html);
  if (chips.length){
    const bar = document.createElement('div');
    bar.className='chips';
    chips.slice(0,6).forEach(c=>{
      const a = document.createElement('a');
      a.textContent = c.label; a.href=c.href; a.target='_blank'; a.rel='noopener';
      if (c.act) a.classList.add('act');
      bar.appendChild(a);
    });
    holder.appendChild(bar);
  }

  // Provenance for debug
  setDebug({ provenance: {
    version: VERSION,
    topic,
    counts: filtered._rawCounts,
    citations_in: citations||[],
    citations_filtered: citesKept,
    events_kept: (filtered.events||[]).map(e=>({title:e.title, url:e.url||e.source_url, date_start:e.date_start||e.date||e.start||null})),
    products_kept: (filtered.products||[]).map(p=>({title:p.title, url:p.url||p.source_url, price: pickMoney(p), currency: currencyOf(p)}))
  }});
}

/* ===== API ===== */
async function callChat(question, topK=8){
  const token = getToken();
  const headers = { 'Content-Type':'application/json' };
  if (token) headers['Authorization'] = 'Bearer ' + token;
  const body = { query: question, topK };
  setDebug({status:'â€¦', req: body, headers});
  const res = await fetch(CHAT_ENDPOINT, { method:'POST', headers, body: JSON.stringify(body) });
  const status = res.status;
  let json; try { json = await res.json(); } catch { json = { error:'non_json', status }; }
  setDebug({status, res: json});
  if(!res.ok) throw new Error('API error');
  return json;
}

/* ===== Events ===== */
function fallbackBlock(){
  return `
    <div class="fallback">
      <p>I donâ€™t have a confident answer to that yet. Iâ€™m trained on Alanâ€™s site, so I may miss things.</p>
      <p>If youâ€™d like to follow up, please reach out:</p>
      <div class="pills">
        <a class="pill pill--brand" target="_blank" rel="noopener" href="https://www.alanranger.com/contact-us-alan-ranger-photography">Contact form</a>
        <a class="pill pill--wa" target="_blank" rel="noopener" href="https://wa.me/447817017994">WhatsApp</a>
      </div>
    </div>`;
}

async function handleSend(){
  const q = input.value.trim();
  if(!q) return;
  addBubble(q.replace(/</g,'&lt;'), {user:true});
  input.value = '';
  const stopTyping = addTyping();
  try{
    const data = await callChat(q, 8);
    stopTyping();
    buildAnswerHTML({
      question: q,
      answer: data.answer || data.reply || data.text || '',
      citations: data.citations || data.sources || [],
      structured: data.structured || {events:[],products:[]}
    });
  }catch{
    stopTyping();
    addBubble(fallbackBlock());
  }
}
sendBtn.addEventListener('click', handleSend);
input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); }});
</script>
</body>
</html>
