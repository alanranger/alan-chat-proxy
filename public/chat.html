<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Chat</title>
  <style>
    :root {
      --bg: #0f172a;         /* slate-900 */
      --panel: #111827;      /* gray-900 */
      --muted: #94a3b8;      /* slate-400 */
      --text: #e5e7eb;       /* gray-200 */
      --accent: #f59e0b;     /* amber-500 */
      --chip: #1f2937;       /* gray-800 */
      --chip-border: #334155;/* slate-700 */
      --border: #1f2937;     /* gray-800 */
      --success: #22c55e;
      --error: #ef4444;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap {
      max-width: 960px;
      margin: 0 auto;
      padding: 20px 16px 120px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .messages {
      display: grid;
      gap: 16px;
      max-height: 70vh;
      overflow: auto;
      padding-right: 8px;
    }
    .msg {
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid var(--border);
      background: #0b1220;
    }
    .msg.user { background: #0a0f1a; }
    .msg.assistant { background: #0b1220; }
    .msg h3, .msg h4 { margin: 0.2rem 0 0.6rem; }
    .msg p { margin: 0.4rem 0; }
    .chips {
      display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;
    }
    .chip {
      background: var(--chip);
      border: 1px solid var(--chip-border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 999px;
      text-decoration: none;
      transition: transform .05s ease;
    }
    .chip:hover { transform: translateY(-1px); }
    .footer {
      position: fixed; left: 0; right: 0; bottom: 0;
      background: linear-gradient(180deg, rgba(15,23,42,0), rgba(15,23,42,0.9) 24%, rgba(15,23,42,1) 70%);
      padding: 16px 12px 22px;
      border-top: 1px solid var(--border);
    }
    .footer-inner { max-width: 960px; margin: 0 auto; display: grid; gap: 8px; }
    .row {
      display: grid; grid-template-columns: 1fr auto; gap: 8px;
      background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 8px;
    }
    textarea {
      width: 100%; min-height: 48px; max-height: 140px; resize: vertical;
      background: transparent; border: 0; outline: none; color: var(--text);
      font: inherit; padding: 6px 10px;
    }
    button {
      appearance: none; border: 1px solid var(--chip-border); background: var(--chip);
      color: var(--text); border-radius: 12px; padding: 10px 14px; cursor: pointer;
    }
    button.primary { border-color: var(--accent); background: #1b2333; }
    .debug {
      margin-top: 14px; border: 1px dashed var(--chip-border); border-radius: 10px; overflow: hidden;
    }
    .debug summary {
      list-style: none; cursor: pointer; padding: 10px 12px; user-select: none;
      background: #0b1220; border-bottom: 1px dashed var(--chip-border);
    }
    .debug summary::-webkit-details-marker { display:none; }
    .debug-body { padding: 10px 12px; }
    .debug-actions { display:flex; gap:8px; margin-bottom:10px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; color: var(--muted); }
    .status { font-size: 12px; margin-left: 8px; }
    .hr { height: 1px; background: var(--border); margin: 12px 0; }
    .small { color: var(--muted); font-size: 12px; }
    .hidden { display:none; }
    a { color: #93c5fd; }
    .assistant .msg-markdown ul { padding-left: 1.25rem; }
    .assistant .msg-markdown h3 { margin-top: 0; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 14px">AI Chat</h1>
    <div class="panel">
      <div id="messages" class="messages"></div>

      <details class="debug" id="debug">
        <summary>▸ Show debug</summary>
        <div class="debug-body">
          <div class="debug-actions">
            <button id="copyDebug" class="primary">Copy all debug</button>
            <span id="copyStatus" class="status"></span>
          </div>
          <div class="hr"></div>
          <div class="mono" id="debugJson">(no debug yet)</div>
        </div>
      </details>
    </div>
  </div>

  <div class="footer">
    <div class="footer-inner">
      <div class="row">
        <textarea id="q" placeholder="Ask a question… (Shift+Enter for newline)"></textarea>
        <button id="send" class="primary">Send</button>
      </div>
      <div class="small">Tip: ask about workshops, tuition, kit, or locations. Example: “When are the next Bluebell dates?”</div>
    </div>
  </div>

  <script>
    const elMsgs = document.getElementById('messages');
    const elQ = document.getElementById('q');
    const elSend = document.getElementById('send');
    const elDebugJson = document.getElementById('debugJson');
    const elCopy = document.getElementById('copyDebug');
    const elCopyStatus = document.getElementById('copyStatus');

    const history = [];

    function pushMessage(role, html, chips=[]) {
      const outer = document.createElement('div');
      outer.className = `msg ${role}`;

      const inner = document.createElement('div');
      inner.className = 'msg-markdown';
      inner.innerHTML = html;
      outer.appendChild(inner);

      if (role === 'assistant' && chips && chips.length) {
        const bar = document.createElement('div');
        bar.className = 'chips';
        chips.forEach(c => {
          const a = document.createElement('a');
          a.className = 'chip';
          a.href = c.url;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.textContent = c.label;
          bar.appendChild(a);
        });
        outer.appendChild(bar);
      }

      elMsgs.appendChild(outer);
      elMsgs.scrollTop = elMsgs.scrollHeight;
    }

    function mdToHtml(md) {
      try { return marked.parse(md || ''); }
      catch { return (md || '').replace(/\\n/g, '<br>'); }
    }

    async function ask(query) {
      // show user message immediately
      pushMessage('user', mdToHtml(query));
      elQ.value = '';

      // call API
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ query })
      });

      const payload = await res.json().catch(() => ({}));
      // store debug (entire API payload)
      try {
        elDebugJson.textContent = JSON.stringify(payload, null, 2);
      } catch {
        elDebugJson.textContent = '(failed to stringify debug)';
      }

      if (!payload || payload.ok === false) {
        const msg = payload && payload.hint ? payload.hint : 'Sorry, something went wrong.';
        pushMessage('assistant', `<p style="color:var(--error)">${escapeHtml(msg)}</p>`);
        return;
      }

      // Only render answer_markdown — avoids duplicate lists
      const html = mdToHtml(payload.answer_markdown || '');
      const chips = Array.isArray(payload.structured?.chips) ? payload.structured.chips : [];
      pushMessage('assistant', html, chips);
    }

    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    // send handlers
    elSend.addEventListener('click', () => {
      const q = elQ.value.trim();
      if (!q) return;
      ask(q);
    });
    elQ.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const q = elQ.value.trim();
        if (!q) return;
        ask(q);
      }
    });

    // copy debug
    elCopy.addEventListener('click', async () => {
      const text = elDebugJson.textContent || '';
      try {
        await navigator.clipboard.writeText(text);
        elCopyStatus.textContent = 'Copied';
        elCopyStatus.style.color = 'var(--success)';
        setTimeout(() => { elCopyStatus.textContent = ''; }, 1500);
      } catch {
        elCopyStatus.textContent = 'Copy failed';
        elCopyStatus.style.color = 'var(--error)';
        setTimeout(() => { elCopyStatus.textContent = ''; }, 1500);
      }
    });

    // greet once
    pushMessage('assistant', mdToHtml("Hi! I can help with workshops, tuition, kit, and locations. Ask me something like **“give me the next bluebell workshop dates and prices.”**"));
  </script>
</body>
</html>
