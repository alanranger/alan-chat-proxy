<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Alan Ranger Assistant</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0e1726; --panel:#121C2D; --text:#DDE7F6; --muted:#93A4C1; --bubble:#1B2A44;
  --brand:#E57200; --wa:#25D366; --ring:rgba(229,114,0,.35);
  --input-bg:#E9EEF5; --input-text:#0b0f16; --input-border:#CBD5E1; --input-ph:#6b7280;
  --chip-bg:#13203e; --chip-br:#1b2540; --link:#9cd3ff; --link-hover:#cfe7ff;
  --user-bg:#e6edf7; --user-text:#0b0f16;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;line-height:1.45}
.wrap{max-width:980px;margin:28px auto;padding:0 16px;position:relative}
.version{position:absolute;top:-8px;right:0;background:#0b1422;border:1px solid #1b2540;border-radius:999px;padding:2px 8px;font-size:11px;color:#9eb2d3}
.card{background:var(--panel);border-radius:14px;box-shadow:0 6px 22px rgba(0,0,0,.35);border-top:6px solid var(--brand);padding:28px}
.header{display:flex;flex-direction:column;align-items:center;gap:14px;margin-bottom:12px}
.logo{display:block;height:72px;width:auto;object-fit:contain;object-position:center;filter:drop-shadow(0 2px 6px rgba(0,0,0,.45))}
.title{margin:0;font-size:34px;font-weight:300;letter-spacing:.2px}
.sub{margin:0;text-align:center;color:var(--muted);max-width:720px;font-size:16px}
.pills{display:flex;gap:10px;margin:12px 0 4px;flex-wrap:wrap}
.pill{appearance:none;border:0;border-radius:28px;padding:8px 12px;font-weight:600;font-size:14px;color:#0b0f16;cursor:pointer;line-height:1;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
.pill--brand{background:var(--brand)} .pill--wa{background:var(--wa)}

.chat{margin-top:12px;border-radius:14px;background:#0f1828;padding:18px}
.thread{display:flex;flex-direction:column;gap:12px}
.bubble{background:var(--bubble);padding:14px 16px;border-radius:12px;max-width:780px}
.bubble.user{align-self:flex-end;background:var(--user-bg);color:var(--user-text);border:1px solid #d3deee}
.answer h1,.answer h2,.answer h3{margin:.2em 0}
.answer p{margin:.5em 0}
.answer ul{margin:.4em 0 .6em 1.25em}
.answer li{margin:.15em 0}
.answer a{color:var(--link);text-decoration:underline}
.answer a:hover{color:var(--link-hover)}

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.chips a{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--chip-br);background:var(--chip-bg);color:#cfe3ff;text-decoration:none}
.chips a.brand{background:var(--brand);color:#0b0f16;border-color:transparent}
.chips a:hover{opacity:.9}

/* Composer */
.composer{display:flex;gap:10px;margin-top:14px;padding:12px;background:var(--panel);border-radius:12px}
.composer input{flex:1;background:var(--input-bg);color:var(--input-text);border:1px solid #CBD5E1;border-radius:10px;padding:12px 14px;outline:0}
.composer input::placeholder{color:#6b7280}
.composer input:focus{border-color:var(--ring);box-shadow:0 0 0 4px var(--ring)}
.send{background:var(--brand);color:#0b0f16;font-weight:700;border:0;border-radius:10px;padding:0 18px;cursor:pointer}

/* Debug panel */
details.debug{margin-top:14px;background:#0f1828;border:1px solid #15223a;border-radius:10px;padding:10px 12px}
details.debug summary{cursor:pointer;color:#9eb2d3;font-weight:600;outline:none}
.kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin-top:10px}
.kv label{color:#93A4C1}
pre.json{white-space:pre-wrap;word-break:break-word;margin:0;padding:8px;background:#0b1422;border:1px solid #15223a;border-radius:8px;color:#cfe3ff;font-size:12px;line-height:1.4}

/* Typing dots */
.typing{position:relative;display:inline-block}
.typing .dot{display:inline-block;width:6px;height:6px;margin:0 2px;border-radius:50%;background:#9eb2d3;opacity:.6;animation:bounce 1.2s infinite}
.typing .dot:nth-child(2){animation-delay:.15s}
.typing .dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-4px)}}

@media (max-width:540px){.title{font-size:26px}.logo{height:60px}.kv{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <span class="version">v0.9.11</span>
  <div class="card">
    <div class="header">
      <img class="logo" src="./chat%20white.png" alt="AR logo">
      <h2 class="title">Alan Ranger Assistant</h2>
      <p class="sub">Iâ€™m Alanâ€™s AI assistant, trained on content from this website to help with workshops, tuition, and photography questions. I wonâ€™t always get everything right â€” if I canâ€™t help, please contact Alan directly:</p>
      <div class="pills">
        <a class="pill pill--brand" target="_blank" rel="noopener" href="https://www.alanranger.com/contact-us-alan-ranger-photography">Contact form</a>
        <a class="pill pill--wa" target="_blank" rel="noopener" href="https://wa.me/447817017994">WhatsApp</a>
      </div>
    </div>

    <div class="chat">
      <div id="thread" class="thread">
        <div class="bubble">Hi! I can help with workshops, tuition, and photography advice.</div>
      </div>

      <details id="debugPanel" class="debug">
        <summary>ðŸ”Ž Show debug</summary>
        <button id="copyDebug" class="pill" style="margin-left:8px" onclick="copyAllDebug()">Copy all</button>

        <div class="kv"><label>Endpoint</label><div>/api/chat</div></div>
        <div class="kv"><label>Status</label><div id="dbg-status">â€“</div></div>
        <div class="kv"><label>Headers</label><pre id="dbg-headers" class="json">â€“</pre></div>
        <div class="kv"><label>Request</label><pre id="dbg-req" class="json">â€“</pre></div>
        <div class="kv"><label>Response</label><pre id="dbg-res" class="json">â€“</pre></div>
        <div class="kv"><label>Structured</label><pre id="dbg-struct" class="json">â€“</pre></div>
        <div class="kv"><label>Provenance</label><pre id="dbg-prov" class="json">â€“</pre></div>
      </details>

      <div class="composer">
        <input id="q" placeholder="Ask a questionâ€¦ (Shift+Enter for newline)" />
        <button id="send" class="send">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
const CHAT_ENDPOINT = '/api/chat';
const urlParams = new URLSearchParams(location.search);
if (urlParams.get('debug') === '1') requestAnimationFrame(()=>{ document.getElementById('debugPanel').open = true; });

const thread = document.getElementById('thread');
const input  = document.getElementById('q');
const sendBtn= document.getElementById('send');

const dbgStatus = document.getElementById('dbg-status');
const dbgReq    = document.getElementById('dbg-req');
const dbgRes    = document.getElementById('dbg-res');
const dbgHeaders= document.getElementById('dbg-headers');
const dbgStruct = document.getElementById('dbg-struct');
const dbgProv   = document.getElementById('dbg-prov');

function safeJSONString(v){ try{ return JSON.stringify(v,null,2); }catch{ return String(v); } }

function addBubble(html, opts={}) {
  const div = document.createElement('div');
  div.className = 'bubble' + (opts.user ? ' user' : '');
  div.innerHTML = html;
  thread.appendChild(div);
  div.scrollIntoView({behavior:'smooth', block:'end'});
  return div;
}
function addTyping() {
  const el = addBubble(`<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`);
  return ()=> el && el.remove();
}

/* -------- Minimal markdown to HTML: bullets, bold, links -------- */
function mdToHtml(md){
  if (!md) return { html:'', liIds:[], items:[] };
  // Escape HTML first
  let s = md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  // Bold
  s = s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  // Markdown links [text](url) -> <a href="url">text</a>
  s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');

  // Lists + paragraphs
  const lines = s.split(/\r?\n/);
  let out='', inList=false, liIds=[], items=[], idx=0;
  const flush = ()=>{ if(inList){ out+='</ul>'; inList=false; } };
  for (const line of lines){
    const m = line.match(/^\s*-\s+(.*)$/);
    if (m){
      if(!inList){ out+='<ul>'; inList=true; }
      const text = m[1].trim();
      const id = `li_${++idx}`; liIds.push(id); items.push(text);
      out += `<li id="${id}">${text}</li>`;
    } else {
      flush();
      out += line.trim()? `<p>${line}</p>` : '';
    }
  }
  flush();
  return { html:`<div class="answer">${out}</div>`, liIds, items };
}

function buildChips(question, citations){
  const chips = [];
  const blue = (citations||[]).find(u=> /bluebell/i.test(u)) || citations?.[0];

  if (blue) chips.push({label:'bluebell-woods-near-me', href: blue, brand:true});
  chips.push({label:'Prices', href: blue || 'https://www.alanranger.com/photography-workshops-near-me', brand:true});
  chips.push({label:'Upcoming dates', href: blue || 'https://www.alanranger.com/photography-workshops-near-me', brand:true});
  chips.push({label:'Workshops overview', href:'https://www.alanranger.com/photography-workshops-near-me', brand:false});

  (citations||[]).slice(0,2).forEach(u=>{
    try {
      const nice = u.replace(/^https?:\/\//,'').replace(/www\./,'').split('/').slice(1).join(' / ');
      chips.push({label: nice.length>32?nice.slice(0,29)+'â€¦':nice, href:u, brand:false});
    } catch {}
  });

  const seen = new Set(); const out=[];
  for (const c of chips){
    const key = `${c.label}|${c.href}`;
    if (!seen.has(key)){ out.push(c); seen.add(key); }
  }
  return out.slice(0,6);
}

function renderAnswer(payload, question){
  // IMPORTANT: use answer_markdown (field name from API)
  const { html } = mdToHtml(payload.answer_markdown || payload.answer || '');
  const holder = addBubble(html);

  // Chips
  const chips = buildChips(question, payload.citations || []);
  if (chips.length){
    const wrap = document.createElement('div');
    wrap.className = 'chips';
    chips.forEach(c=>{
      const a = document.createElement('a');
      a.href = c.href; a.target='_blank'; a.rel='noopener';
      a.textContent = c.label;
      if (c.brand) a.classList.add('brand');
      wrap.appendChild(a);
    });
    holder.appendChild(wrap);
  }

  // Debug
  dbgStruct.textContent = safeJSONString(payload.structured || {});
  const prov = [];
  prov.push('Citations:');
  (payload.citations||[]).forEach(u=> prov.push(`â€¢ ${u}`));
  dbgProv.textContent = prov.join('\n') || 'â€“';
}

async function callChat(question) {
  const headers = {'Content-Type':'application/json'};
  const body = { query: question, topK: 8 };
  dbgReq.textContent = safeJSONString(body);
  dbgHeaders.textContent = safeJSONString(headers);
  dbgStatus.textContent = 'â€¦';
  const r = await fetch(CHAT_ENDPOINT, { method:'POST', headers, body: JSON.stringify(body) });
  const json = await r.json().catch(()=>({}));
  dbgStatus.textContent = String(r.status);
  dbgRes.textContent = safeJSONString(json);
  return { ok:r.ok, json };
}

async function handleSend(){
  const q = input.value.trim();
  if (!q) return;
  addBubble(q.replace(/</g,'&lt;'), {user:true});
  input.value = '';
  const stop = addTyping();
  try {
    const { ok, json } = await callChat(q);
    stop();
    if (ok && json?.ok) renderAnswer(json, q);
    else addBubble(`<div class="answer"><p>Sorry â€” I couldnâ€™t fetch that right now.</p></div>`);
  } catch {
    stop();
    addBubble(`<div class="answer"><p>Sorry â€” I hit a snag. Please try again.</p></div>`);
  }
}

sendBtn.addEventListener('click', handleSend);
input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); }});

/* -------- Debug: Copy-all helper -------- */
function copyAllDebug(){
  const get = id => (document.getElementById(id)?.textContent || '').trim();
  const dump = [
    `Endpoint: /api/chat`,
    `Status: ${get('dbg-status')}`,
    `Headers:\n${get('dbg-headers')}`,
    `Request:\n${get('dbg-req')}`,
    `Response:\n${get('dbg-res')}`,
    `Structured:\n${get('dbg-struct') || 'â€“'}`,
    `Provenance (text):\n${get('dbg-prov') || 'â€“'}`
  ].join("\n\n");
  navigator.clipboard.writeText(dump).then(()=>{
    const b = document.getElementById('copyDebug');
    if (!b) return;
    const old = b.textContent; b.textContent = "Copied!";
    setTimeout(()=> b.textContent = old, 1000);
  });
}
</script>
</body>
</html>
