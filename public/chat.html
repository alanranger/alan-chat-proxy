<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Alan Ranger Assistant</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0e1726; --panel:#121C2D; --text:#DDE7F6; --muted:#93A4C1; --bubble:#1B2A44;
  --brand:#E57200; --wa:#25D366; --ring:rgba(229,114,0,.35);
  --input-bg:#E9EEF5; --input-text:#0b0f16; --input-border:#CBD5E1; --input-ph:#6b7280;
  --chip-bg:#13203e; --chip-br:#1b2540; --link:#9cd3ff; --link-hover:#cfe7ff;
  --user-bg:#e6edf7; --user-text:#0b0f16;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;line-height:1.45}
.wrap{max-width:980px;margin:28px auto;padding:0 16px;position:relative}
.badge-wrap{position:relative;height:0}
.version{position:absolute;top:8px;right:0;background:#0b1422;border:1px solid #1b2540;border-radius:999px;padding:2px 8px;font-size:11px;color:#9eb2d3}
.card{background:var(--panel);border-radius:14px;box-shadow:0 6px 22px rgba(0,0,0,.35);border-top:6px solid var(--brand);padding:28px}
.header{display:flex;flex-direction:column;align-items:center;gap:14px;margin-bottom:12px}
.logo{display:block;height:72px;width:auto;object-fit:contain;object-position:center;filter:drop-shadow(0 2px 6px rgba(0,0,0,.45))}
.title{margin:0;font-size:34px;font-weight:300;letter-spacing:.2px}
.sub{margin:0;text-align:center;color:var(--muted);max-width:720px;font-size:16px}
.pills{display:flex;gap:10px;margin:12px 0 4px;flex-wrap:wrap}
.pill{appearance:none;border:0;border-radius:28px;padding:8px 12px;font-weight:600;font-size:14px;color:#0b0f16;cursor:pointer;line-height:1;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
.pill--brand{background:var(--brand)} .pill--wa{background:var(--wa)}

.chat{margin-top:12px;border-radius:14px;background:#0f1828;padding:18px}
.thread{display:flex;flex-direction:column;gap:12px}
.bubble{background:var(--bubble);padding:14px 16px;border-radius:12px;max-width:780px}
.bubble.user{align-self:flex-end;background:var(--user-bg);color:var(--user-text);border:1px solid #d3deee}
.answer h1,.answer h2,.answer h3{margin:.2em 0}
.answer p{margin:.5em 0}
.answer ul{margin:.4em 0 .6em 1.25em}
.answer li{margin:.15em 0}
.answer a{color:var(--link);text-decoration:underline}
.answer a:hover{color:var(--link-hover)}

/* Global pill row at end */
.actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
.actions .pill{background:var(--brand);color:#0b0f16;border:none}

/* Composer */
.composer{display:flex;gap:10px;margin-top:14px;padding:12px;background:var(--panel);border-radius:12px}
.composer input{flex:1;background:var(--input-bg);color:var(--input-text);border:1px solid #CBD5E1;border-radius:10px;padding:12px 14px;outline:0}
.composer input::placeholder{color:#6b7280}
.composer input:focus{border-color:var(--ring);box-shadow:0 0 0 4px var(--ring)}
.send{background:var(--brand);color:#0b0f16;font-weight:700;border:0;border-radius:10px;padding:0 18px;cursor:pointer}

/* Debug panel */
details.debug{margin-top:14px;background:#0f1828;border:1px solid #15223a;border-radius:10px;padding:10px 12px}
details.debug summary{cursor:pointer;color:#9eb2d3;font-weight:600;outline:none}
.kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin-top:10px}
.kv label{color:#93A4C1}
pre.json{white-space:pre-wrap;word-break:break-word;margin:0;padding:8px;background:#0b1422;border:1px solid #15223a;border-radius:8px;color:#cfe3ff;font-size:12px;line-height:1.4}

/* Typing dots */
.typing{position:relative;display:inline-block}
.typing .dot{display:inline-block;width:6px;height:6px;margin:0 2px;border-radius:50%;background:#9eb2d3;opacity:.6;animation:bounce 1.2s infinite}
.typing .dot:nth-child(2){animation-delay:.15s}
.typing .dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-4px)}}

@media (max-width:540px){.title{font-size:26px}.logo{height:60px}.kv{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <!-- Keeps the badge under the orange rule -->
  <div class="badge-wrap"><span class="version">v0.9.17</span></div>

  <div class="card">
    <div class="header">
      <img class="logo" src="./chat%20white.png" alt="AR logo">
      <h2 class="title">Alan Ranger Assistant</h2>
      <p class="sub">I’m Alan’s AI assistant, trained on content from this website to help with workshops, tuition, and photography questions. I won’t always get everything right — if I can’t help, please contact Alan directly:</p>
      <div class="pills">
        <a class="pill pill--brand" target="_blank" rel="noopener" href="https://www.alanranger.com/contact-us-alan-ranger-photography">Contact form</a>
        <a class="pill pill--wa" target="_blank" rel="noopener" href="https://wa.me/447817017994">WhatsApp</a>
      </div>
    </div>

    <div class="chat">
      <div id="thread" class="thread">
        <div class="bubble">Hi! I can help with workshops, tuition, and photography advice.</div>
      </div>

      <details id="debugPanel" class="debug">
        <summary>🔎 Show debug</summary>
        <button id="dbg-copy" style="margin:8px 0 12px;padding:6px 10px;border-radius:6px;border:1px solid #334;color:#cfe3ff;background:#13203e;cursor:pointer">Copy all</button>
        <div class="kv"><label>Endpoint</label><div>/api/chat</div></div>
        <div class="kv"><label>Status</label><div id="dbg-status">–</div></div>
        <div class="kv"><label>Headers</label><pre id="dbg-headers" class="json">–</pre></div>
        <div class="kv"><label>Request</label><pre id="dbg-req" class="json">–</pre></div>
        <div class="kv"><label>Response</label><pre id="dbg-res" class="json">–</pre></div>
        <div class="kv"><label>Structured</label><pre id="dbg-struct" class="json">–</pre></div>
        <div class="kv"><label>Provenance</label><pre id="dbg-prov" class="json">–</pre></div>
        <div class="kv"><label>Note</label><pre id="dbg-note" class="json">–</pre></div>
      </details>

      <div class="composer">
        <input id="q" placeholder="Ask a question… (Shift+Enter for newline)" />
        <button id="send" class="send">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
const CHAT_ENDPOINT = '/api/chat';
const urlParams = new URLSearchParams(location.search);
if (urlParams.get('debug') === '1') requestAnimationFrame(()=>{ document.getElementById('debugPanel').open = true; });

const thread = document.getElementById('thread');
const input  = document.getElementById('q');
const sendBtn= document.getElementById('send');

const dbgStatus = document.getElementById('dbg-status');
const dbgReq    = document.getElementById('dbg-req');
const dbgRes    = document.getElementById('dbg-res');
const dbgHeaders= document.getElementById('dbg-headers');
const dbgStruct = document.getElementById('dbg-struct');
const dbgProv   = document.getElementById('dbg-prov');
const dbgCopy   = document.getElementById('dbg-copy');
const dbgNote   = document.getElementById('dbg-note');

function safeJSONString(v){ try{ return JSON.stringify(v,null,2); }catch{ return String(v); } }

dbgCopy?.addEventListener('click', ()=>{
  const all = [
    'Status: '+dbgStatus.textContent,
    'Headers:\n'+dbgHeaders.textContent,
    'Request:\n'+dbgReq.textContent,
    'Response:\n'+dbgRes.textContent,
    'Structured:\n'+dbgStruct.textContent,
    'Provenance:\n'+dbgProv.textContent,
    'Note:\n'+dbgNote.textContent
  ].join('\n\n');
  navigator.clipboard.writeText(all).then(()=>{ dbgCopy.textContent='Copied!'; setTimeout(()=>dbgCopy.textContent='Copy all',1500); });
});

/* ---------- UI helpers ---------- */
function addBubble(html, opts={}) {
  const div = document.createElement('div');
  div.className = 'bubble' + (opts.user ? ' user' : '');
  div.innerHTML = html;
  thread.appendChild(div);
  div.scrollIntoView({behavior:'smooth', block:'end'});
  return div;
}
function addTyping() {
  const el = addBubble(`<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`);
  return ()=> el && el.remove();
}
function mdToHtml(md){
  if (!md) return { html:'', liIds:[], items:[] };
  let s = md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  s = s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  const lines = s.split(/\r?\n/);
  let out='', inList=false;
  const flush = ()=>{ if(inList){ out+='</ul>'; inList=false; } };
  for (const line of lines){
    const m = line.match(/^\s*-\s+(.*)$/);
    if (m){ if(!inList){ out+='<ul>'; inList=true; } out += `<li>${m[1].trim()}</li>`; }
    else { flush(); out += line.trim()? `<p>${line}</p>` : ''; }
  }
  flush();
  return { html:`<div class="answer">${out}</div>` };
}
function fmtDate(iso){
  try{ return new Date(iso).toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short',year:'numeric'});}catch{ return iso; }
}

/* ---------------- Utilities ---------------- */
function normaliseAvailability(val){
  if(!val) return null;
  const s = String(val).trim();
  if (/out\s*of\s*stock/i.test(s)) return 'Out of Stock';
  if (/in\s*stock/i.test(s)) return 'In Stock';
  if (/schema\.org\/OutOfStock/i.test(s)) return 'Out of Stock';
  if (/schema\.org\/InStock/i.test(s)) return 'In Stock';
  return s;
}
function tryUrl(u){ try{ return new URL(u); } catch { return null; } }
function uniqueByHref(arr){
  const seen=new Set(); return arr.filter(x=>{ if(!x.href) return false; const k=x.href; if(seen.has(k)) return false; seen.add(k); return true; });
}

/* ---------------- Product merging & parsing (robust) ---------------- */
function mergeProducts(list){
  if(!Array.isArray(list) || !list.length) return [];
  const map = new Map();
  for(const p of list){
    const key = (p.url || p.page_url || p.source_url || p.title || '').toLowerCase();
    if(!map.has(key)) { map.set(key, JSON.parse(JSON.stringify(p))); continue; }
    const m = map.get(key);
    for(const k of ['price','price_currency','availability','provider','description','title','url','page_url','source_url'])
      if((m[k]==null || m[k]==='') && p[k]!=null) m[k]=p[k];
    const mAgg = m?.raw?.offers?.lowPrice!=null || m?.raw?.offers?.highPrice!=null;
    const pAgg = p?.raw?.offers?.lowPrice!=null || p?.raw?.offers?.highPrice!=null;
    if(pAgg && !mAgg){ m.raw = m.raw || {}; m.raw.offers = p.raw.offers; }
    if(p?.raw?.offers?.price!=null && (!m?.raw?.offers?.price)){
      m.raw = m.raw || {}; m.raw.offers = Object.assign({}, m.raw.offers, {price:p.raw.offers.price, priceCurrency:p.raw.offers.priceCurrency});
    }
    if(!m.availability){
      m.availability = p.availability || p?.raw?.offers?.availability || null;
    }
  }
  return [...map.values()];
}

/* Clean description, remove date-like lines and keep array of lines */
function cleanDescToLines(desc){
  const lines = String(desc||'').split(/\r?\n/);
  const out = [];
  for (let l of lines){
    if(/^dates\s*\(/i.test(l)) continue;
    if(/^\s*(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\b/i.test(l)) continue;
    if(/\b\d{2}-[A-Za-z]{3}-\d{2}\b/.test(l)) continue;
    out.push(l);
  }
  return out;
}

/* Grab label value; if empty inline, look ahead to next non-empty line */
function grabLabel(lines, label){
  const labRe = new RegExp(`^\\s*${label}\\s*:?\\s*(.*)$`,'i');
  const isOtherLabel = (s)=>/^\s*(Location|Participants|Fitness|Availability)\s*:?\s*$/i.test(s);
  const isOptionHead = (s)=>/^\s*(?:4\s*hrs?|4\s*hours?|half\s*day|1\s*day|full\s*day|day)\b/i.test(s);
  for (let i=0;i<lines.length;i++){
    const m = lines[i].match(labRe);
    if (m){
      let v = (m[1]||'').trim();
      if (v && v !== ':') return v.replace(/^\s*:\s*/,'').trim();
      for (let j=i+1;j<lines.length;j++){
        const next = (lines[j]||'').trim();
        if (!next) continue;
        if (isOtherLabel(next) || isOptionHead(next)) break;
        return next.replace(/^\s*:\s*/,'').trim();
      }
      return null;
    }
  }
  return null;
}

function extractFacts(prod){
  const lines = cleanDescToLines(prod?.description||'');
  const location     = grabLabel(lines,'Location');
  const participants = grabLabel(lines,'Participants');
  const fitness      = grabLabel(lines,'Fitness');
  let availability   = grabLabel(lines,'Availability');

  if(!availability){
    availability = normaliseAvailability(prod?.availability || prod?.raw?.offers?.availability || null);
  } else {
    availability = normaliseAvailability(availability);
  }

  const optionLines = lines.filter(l =>
    /^\s*(?:4\s*hrs?|4\s*hours?|half\s*day|1\s*day|full\s*day|day)\b/i.test(l) ||
    /^\s*OR\s*1\s*day\b/i.test(l)
  ).slice(0,6);

  const labelOrOption = (s)=>/^\s*(Location|Participants|Fitness|Availability)\s*:?/i.test(s) ||
                          /^\s*(?:4\s*hrs?|4\s*hours?|half\s*day|1\s*day|full\s*day|day)\b/i.test(s);
  const narrative = lines.filter(l=>l && !labelOrOption(l)).join(' ').replace(/\s+/g,' ').trim();
  let meta = '';
  if(narrative){
    const m = narrative.match(/^(.{40,220}?[\.\!\?])\s+/) || narrative.match(/^.{40,220}/);
    meta = m ? m[0].trim() : narrative.slice(0,200);
  }

  return { location, participants, fitness, availability, optionLines, meta };
}

function currency(amount, ccy){
  if(amount==null || amount==='') return null;
  const n = Number(amount); if(!isFinite(n)) return null;
  try{ return new Intl.NumberFormat(undefined,{style:'currency',currency:ccy||'GBP',maximumFractionDigits:0}).format(n); }
  catch{ return `£${String(amount).replace(/\.00$/,'')}`; }
}
function deriveOptions(prod, facts){
  const ccy = prod.price_currency || prod?.raw?.offers?.priceCurrency || 'GBP';
  const base = prod.price ?? prod?.raw?.offers?.price;
  const low  = prod?.raw?.offers?.lowPrice;
  const high = prod?.raw?.offers?.highPrice;

  const text = (facts.optionLines||[]).join('\n').toLowerCase();
  const has4h  = /(?:^|\n)\s*(?:4\s*hrs?|4\s*hours?|half\s*day)\b/.test(text);
  const has1d  = /(?:^|\n)\s*(?:1\s*day|full\s*day|day)\b/.test(text);

  const opts = [];

  if(low!=null && high!=null && has4h && has1d){
    opts.push({label:'4 hours', price:currency(low,ccy)});
    opts.push({label:'1 day',   price:currency(high,ccy)});
  } else {
    if(base!=null) opts.push({label:'Standard', price:currency(base,ccy)});
    if(low!=null || high!=null){
      const range = [low,high].filter(v=>v!=null).map(v=>currency(v,ccy)).join(' – ');
      if(range) opts.push({label:'Pricing', price:range});
    }
  }

  const timePat = /(\d{1,2}:\d{2}\s*(?:am|pm))\s*[–-]\s*(\d{1,2}:\d{2}\s*(?:am|pm))(?:\s*or\s*(\d{1,2}:\d{2}\s*(?:am|pm))\s*[–-]\s*(\d{1,2}:\d{2}\s*(?:am|pm)))?/i;
  for(const ln of facts.optionLines||[]){
    const label = ln.replace(/\s*—.*$/,'').replace(/^OR\s*/i,'').trim();
    const tm = ln.match(timePat);
    const window = tm ? `${tm[1]} – ${tm[2]}${tm[3]?` or ${tm[3]} – ${tm[4]}`:''}` : null;
    if(label && !opts.some(o=>o.label.toLowerCase()===label.toLowerCase())){
      opts.push({label, time:window});
    } else if(window){
      const o = opts.find(o=>o.label.toLowerCase()===label.toLowerCase());
      if(o && !o.time) o.time = window;
    }
  }
  return opts;
}

/* --------- Pill URL derivation (no hard-coding to bluebells) --------- */
function findWorkshopsIndexUrl(productUrl, eventUrl){
  const u = tryUrl(productUrl) || tryUrl(eventUrl);
  if(!u) return null;
  const segs = u.pathname.split('/').filter(Boolean);
  // find the first segment that mentions "workshop"
  const idx = segs.findIndex(s => /workshop/i.test(s));
  if (idx >= 0){
    const rootPath = '/' + segs.slice(0, idx+1).join('/') + '/';
    return u.origin + rootPath;
  }
  // otherwise use the parent directory of the product/event page
  const base = u.pathname.endsWith('/') ? u.pathname.slice(0,-1) : u.pathname;
  const parent = base.substring(0, base.lastIndexOf('/')+1);
  return u.origin + (parent || '/');
}

function findPhotosUrl(payload, topic, productUrl, eventUrl){
  const base = tryUrl(productUrl) || tryUrl(eventUrl);
  if(!base) return null;
  const origin = base.origin;

  // 1) Try citations that look like galleries on same origin
  const cits = Array.isArray(payload?.citations) ? payload.citations : [];
  const gallery = cits.find(href => {
    try{
      const cu = new URL(href);
      return cu.origin === origin && /gallery|fine-?art|portfolio/i.test(cu.pathname);
    }catch{ return false; }
  });
  if (gallery) return gallery;

  // 2) Fallback to site search for topic
  const q = encodeURIComponent((topic||'').toString().trim() || 'photography');
  return `${origin}/search?query=${q}`;
}

/* Chips from payload (render once, at the end) */
function buildActionPills(payload, structured, prod){
  const chips=[];

  const productUrl = prod?.url || prod?.page_url || prod?.source_url || structured?.products?.[0]?.url || null;
  const eventUrl   = (structured?.events?.[0]?.page_url || structured?.events?.[0]?.source_url) || null;

  // Book Now (product)
  if(productUrl) chips.push({label:'Book Now', href:productUrl});

  // Event Listing (first event page)
  if(eventUrl) chips.push({label:'Event Listing', href:eventUrl});

  // More Workshops (derive workshops index/root)
  const more = findWorkshopsIndexUrl(productUrl, eventUrl);
  if(more) chips.push({label:'More Workshops', href:more});

  // Photos (try gallery or search on-site for topic)
  const photos = findPhotosUrl(payload, structured?.topic, productUrl, eventUrl);
  if(photos) chips.push({label:'Photos', href:photos});

  // Ensure no duplicate hrefs
  return uniqueByHref(chips);
}

/* ---------------- Renderers ---------------- */
function renderProductCard(prod){
  const facts = extractFacts(prod);
  const options = deriveOptions(prod, facts);

  const rows = [];
  if(facts.location)     rows.push(`<p><strong>Location:</strong> ${facts.location}</p>`);
  if(facts.participants) rows.push(`<p><strong>Participants:</strong> ${facts.participants}</p>`);
  if(facts.fitness)      rows.push(`<p><strong>Fitness:</strong> ${facts.fitness}</p>`);
  if(facts.availability) rows.push(`<p><strong>Availability:</strong> ${facts.availability}</p>`);

  const li = options.map(o=>{
    const bits = [o.label, o.time ? `— ${o.time}` : null, o.price ? `— ${o.price}` : null].filter(Boolean).join(' ');
    return `<li>${bits}</li>`;
  }).join('');

  const meta = facts.meta ? `<p>${facts.meta}</p>` : '';

  return `
    <div class="answer">
      <h3>${prod.title || 'Workshop'}</h3>
      ${meta}
      ${rows.join('')}
      ${li? `<ul>${li}</ul>`:''}
    </div>
  `;
}

function renderEventsBlock(structured){
  const now=new Date();
  const future=(structured?.events||[])
    .filter(e=>e?.date_start && !isNaN(Date.parse(e.date_start)) && new Date(e.date_start)>=now)
    .sort((a,b)=>new Date(a.date_start)-new Date(b.date_start))
    .slice(0,12);

  if(!future.length) return '';

  const topic = (structured?.topic||'').toString().trim();
  const title = topic ? `Upcoming ${topic} Workshops` : 'Upcoming Workshops';

  const lis = future.map(e=>{
    const when=fmtDate(e.date_start);
    const href=e.page_url||e.source_url||'#';
    const loc=e.location||'';
    return `<li>${when} — <a href="${href}" target="_blank" rel="noopener">Link</a> — ${loc}</li>`;
  }).join('');

  return `<div class="answer"><h3>${title}</h3><ul>${lis}</ul></div>`;
}

/* Full render */
function renderAnswer(payload){
  const s = payload.structured||{};
  const merged = mergeProducts(s.products||[]);
  const note = {
    resolver: 'default',
    merged_products: merged.length,
    events_found: (s.events||[]).length,
    pills_rendered: 0
  };

  if(merged.length || (s.events||[]).length){
    let prod = merged.find(p=>p?.price!=null) ||
               merged.find(p=>p?.raw?.offers?.lowPrice!=null || p?.raw?.offers?.highPrice!=null) ||
               merged[0];

    if(prod){
      addBubble(renderProductCard(prod));
    }
    const evHTML = renderEventsBlock(s);
    if(evHTML) addBubble(evHTML);

    // single pill row at the end
    const pills = buildActionPills(payload, s, prod);
    if(pills.length){
      const wrap = document.createElement('div');
      wrap.className='actions';
      pills.forEach(p=>{
        const a=document.createElement('a'); a.className='pill'; a.textContent=p.label;
        a.href=p.href; a.target='_blank'; a.rel='noopener';
        wrap.appendChild(a);
      });
      thread.appendChild(wrap);
      note.pills_rendered = pills.length;
    }
  } else {
    const md = payload.answer_markdown || payload.answer || '';
    if(md){ const {html}=mdToHtml(md); addBubble(html); }
  }

  // Debug dumps
  dbgStruct.textContent = safeJSONString(payload.structured||{});
  dbgNote.textContent   = safeJSONString(note);
}

/* ---------------- Networking ---------------- */
async function sendQuery(query){
  const req = { query, topK: 8 };
  dbgReq.textContent = safeJSONString(req);
  const closeTyping = addTyping();
  try{
    const res = await fetch(CHAT_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(req)
    });
    dbgStatus.textContent = res.status;
    const headers = {}; res.headers.forEach((v,k)=>headers[k]=v);
    dbgHeaders.textContent = safeJSONString(headers);

    const data = await res.json();
    dbgRes.textContent = safeJSONString(data);
    dbgProv.textContent = safeJSONString({ citations: data.citations || [] });

    closeTyping();
    if (data && (data.answer_markdown || data.answer || (data.structured && (data.structured.products?.length || data.structured.events?.length)))) {
      renderAnswer(data);
    } else {
      addBubble(`<div class="answer"><p>I don’t have a specific answer for that yet. Try asking about workshops, tuition, kit, or locations — for example, <em>“When are the next Bluebell dates?”</em></p></div>`);
    }
  } catch (err){
    closeTyping();
    dbgStatus.textContent = 'error';
    addBubble(`<div class="answer"><p>Something went wrong: ${String(err)}</p></div>`);
  }
}

/* ---------------- Wire up composer ---------------- */
function submit(){
  const val = input.value.trim();
  if(!val) return;
  addBubble(val, {user:true});
  input.value='';
  sendQuery(val);
}
sendBtn.addEventListener('click', submit);
input.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); submit(); }
});

/* Optional sanity query during dev
// sendQuery("give me the next bluebell workshop dates and prices");
*/
</script>
</body>
</html>
