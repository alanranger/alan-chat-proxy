<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Chat Testbench — v0.5.2</title>
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--muted:#9fb3d9;--border:#1b2540;--text:#dbe4ff;--ok:#22c55e;--bad:#ef4444;--brand:#2563eb;}
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;padding:24px}
    a{color:#93c5fd;text-decoration:none} a:hover{text-decoration:underline}
    h1{margin:0 0 10px}
    .ver{background:#13203e;color:#c7d7ff;border:1px solid #26406f;padding:4px 8px;border-radius:999px;font:12px/1 ui-monospace,Menlo,Consolas,monospace}
    .container{max-width:1200px;margin:0 auto}
    .card{background:#0f172a;border:1px solid #1b2540;border-radius:10px;padding:16px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .w-1{flex:1 1 200px} .w-2{flex:2 1 320px} .w-3{flex:3 1 500px}
    input,textarea,select{width:100%;background:#0b1426;border:1px solid #1b2540;color:#dbe4ff;padding:10px 12px;border-radius:8px}
    textarea{min-height:120px}
    button{background:#2563eb;color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .btn-ghost{background:#13203e;border:1px solid #1b2540}
    .btn-red{background:#7f1d1d}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1b2540;text-align:left;vertical-align:top}
    th{color:#c7d7ff}
    .muted{color:#9fb3d9}
    .progress{height:8px;background:#0b1426;border:1px solid #1b2540;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:#2563eb}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:50}
    .modal.open{display:flex}
    .modal .content{max-width:900px;width:92vw;max-height:80vh;overflow:auto;background:#0f172a;border:1px solid #1b2540;border-radius:12px;padding:16px}
    .content h3{margin:0 0 8px}
    pre{white-space:pre-wrap;word-break:break-word;background:#0b1426;border:1px solid #1b2540;padding:10px;border-radius:8px}
    .ok{color:#22c55e} .bad{color:#ef4444}
  </style>
</head>
<body>
<div class="container">
  <div class="row" style="align-items:center">
    <h1>Chat Testbench</h1><span class="ver mono" id="ver">v0.5.2</span>
  </div>

  <div class="card">
    <div class="row">
      <div class="w-2">
        <div><small class="muted">CSV (columns: <b>query,expected</b>)</small></div>
        <input id="csv" type="file" accept=".csv"/>
        <div class="muted" id="parsed">Parsed rows: 0</div>
      </div>
      <div class="w-1">
        <div><small class="muted">topK</small></div>
        <input id="topk" value="8"/>
      </div>
      <div class="w-1">
        <div><small class="muted">Concurrency</small></div>
        <input id="conc" value="3"/>
      </div>
      <div class="w-1">
        <button id="runAll">Run All</button>
      </div>
      <div class="w-1">
        <button class="btn-ghost" id="clear">Clear</button>
      </div>
      <div class="w-1">
        <button class="btn-ghost" id="copy">Copy Results</button>
      </div>
    </div>
    <details style="margin-top:10px">
      <summary class="muted">Paste mode (one query per line; optionally “ | expected” after it)</summary>
      <textarea id="paste" placeholder="When is the next Devon workshop? | events&#10;What tripod do you recommend? | advice"></textarea>
    </details>
  </div>

  <div class="card">
    <div class="progress"><div class="bar" id="bar"></div></div>
    <table style="margin-top:12px">
      <thead>
        <tr>
          <th style="width:48px">#</th>
          <th>Query</th>
          <th style="width:100px">Expected</th>
          <th style="width:110px">Detected</th>
          <th style="width:80px">Events</th>
          <th style="width:80px">Articles</th>
          <th style="width:60px">Pills</th>
          <th style="width:90px">Result</th>
          <th style="width:110px">Actions</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<!-- Inspect modal -->
<div class="modal" id="modal">
  <div class="content">
    <div class="row" style="justify-content:space-between;margin-bottom:10px">
      <h3>Inspect</h3>
      <button class="btn-ghost" id="close">Close</button>
    </div>
    <pre id="inspect" class="mono"></pre>
  </div>
</div>

<script>
const VERSION='v0.5.2';
document.getElementById('ver').textContent=VERSION;

const $=(id)=>document.getElementById(id);
const rowsEl=$('rows');
const barEl=$('bar');
const mod=$('modal');
const inspectEl=$('inspect');

let data=[];      // [{query, expected}]
let results=[];   // for Copy Results

function parseCSV(text){
  // extremely forgiving parser for 2 columns
  const lines=text.split(/\r?\n/).filter(Boolean);
  if(!lines.length) return [];
  const header=lines[0].split(',').map(s=>s.trim().toLowerCase());
  const qi=header.indexOf('query');
  const ei=header.indexOf('expected');
  if(qi===-1){ alert('No rows loaded. Make sure your CSV has a header "query,expected" or use Paste mode.'); return []; }
  const out=[];
  for(let i=1;i<lines.length;i++){
    const parts=lines[i].split(',');
    const query=(parts[qi]||'').trim();
    const expected=(ei===-1?'':(parts[ei]||'').trim());
    if(query) out.push({query,expected});
  }
  return out;
}

$('csv').addEventListener('change', async (e)=>{
  results=[]; rowsEl.innerHTML=''; barEl.style.width='0%';
  const file=e.target.files && e.target.files[0];
  if(!file){ $('parsed').textContent='Parsed rows: 0'; data=[]; return; }
  const txt=await file.text();
  data=parseCSV(txt);
  $('parsed').textContent=`Parsed rows: ${data.length}`;
  renderRowsSkeleton();
});

$('clear').onclick=()=>{
  $('csv').value=''; $('paste').value='';
  rowsEl.innerHTML=''; data=[]; results=[]; $('parsed').textContent='Parsed rows: 0';
  barEl.style.width='0%';
};

$('copy').onclick=()=>{
  if(!results.length){ alert('No results yet. Run the test first.'); return; }
  const payload=results.map(r=>({
    idx: r.idx,
    query: r.query,
    expected: r.expected,
    detected: r.detected,
    counts: r.counts,
    pass: r.pass
  }));
  navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
  alert('Copied results JSON to clipboard.');
};

$('runAll').onclick=async()=>{
  results=[]; rowsEl.innerHTML=''; barEl.style.width='0%';

  let list=[...data];
  if(!list.length){
    // try paste mode
    const pasted=$('paste').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(!pasted.length){ alert('No rows. Load a CSV or use Paste mode.'); return; }
    list=pasted.map((line,i)=>{
      const m=line.split('|'); return { query:(m[0]||'').trim(), expected:(m[1]||'').trim() };
    });
    $('parsed').textContent=`Parsed rows: ${list.length} (paste mode)`;
  }

  renderRowsSkeleton(list);

  const topk=Number($('topk').value||8);
  const conc=Math.max(1, Number($('conc').value||3));
  let done=0, idx=0;

  async function next(){
    if(idx>=list.length) return;
    const i=idx++; const row=list[i];
    const tr=rowsEl.querySelector(`tr[data-i="${i}"]`);
    const res=await callChat(row.query, topk).catch(e=>({error:String(e)}));
    const structured=res && res.structured || {};
    const detected= (res && (res.meta?.intent || structured.intent)) || '';
    const counts = {
      events: (structured.events||[]).length || 0,
      articles: (structured.articles||[]).length || 0,
      pills: (structured.pills||[]).length || 0
    };
    const pass = compareIntent(row.expected, detected);

    tr.querySelector('.det').textContent = detected || '—';
    tr.querySelector('.ct-events').textContent = counts.events;
    tr.querySelector('.ct-articles').textContent = counts.articles;
    tr.querySelector('.ct-pills').textContent = counts.pills;
    tr.querySelector('.res').innerHTML = pass ? '<span class="ok">PASS</span>' : '<span class="bad">FAIL</span>';

    const inspect = { idx:i+1, request:{ query:row.query, topK:topk }, response:res, derived:{ detected, counts, pass } };
    tr.querySelector('.inspect').onclick=()=>openInspect(inspect);

    results.push({ idx:i+1, query:row.query, expected:row.expected, detected, counts, pass, inspect });

    done++; barEl.style.width = `${Math.round((done/list.length)*100)}%`;
    await next();
  }
  const runners=Array.from({length:conc},()=>next());
  await Promise.all(runners);
};

function equivIntent(s){
  s=(s||'').toString().trim().toLowerCase();
  if(!s) return '';
  if(s==='event') s='events';
  return s;
}
function compareIntent(expected, detected){
  const a=equivIntent(expected);
  const b=equivIntent(detected);
  if(!a) return true; // nothing to compare, treat as pass
  return a===b;
}

function renderRowsSkeleton(src=data){
  rowsEl.innerHTML='';
  src.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.dataset.i=i;
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${escapeHtml(r.query)}</td>
      <td>${escapeHtml(r.expected||'')}</td>
      <td class="det muted">…</td>
      <td class="ct-events">0</td>
      <td class="ct-articles">0</td>
      <td class="ct-pills">0</td>
      <td class="res muted">…</td>
      <td><button class="btn-ghost inspect" disabled>Inspect</button></td>
    `;
    rowsEl.appendChild(tr);
  });
}

function escapeHtml(s){return String(s).replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));}

function openInspect(obj){
  inspectEl.textContent = JSON.stringify(obj, null, 2);
  mod.classList.add('open');
}
$('close').onclick=()=>mod.classList.remove('open');
mod.addEventListener('click', (e)=>{ if(e.target===mod) mod.classList.remove('open'); });

async function callChat(query, topK){
  const res = await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query, topK})});
  return res.json();
}
</script>
</body>
</html>
