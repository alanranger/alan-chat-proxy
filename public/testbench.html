<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Chat Testbench — v0.4.1</title>
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--muted:#9fb3ff;--line:#1b2540;--pill:#13203e;--ok:#22c55e;--bad:#ef4444;--fg:#dbe4ff;--brand:#3b82f6;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 12px} .ver{background:var(--pill);padding:2px 8px;border-radius:999px;border:1px solid #26406f}
    .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;margin-bottom:14px}
    .row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
    .w-1{flex:1} .w-2{flex:2} .w-3{flex:3}
    input,textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--line);background:#0b1426;color:var(--fg)}
    button{padding:10px 14px;border:none;border-radius:8px;background:var(--brand);color:#fff;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);vertical-align:top;text-align:left}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#0b1426}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    details summary{cursor:pointer}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <div style="display:flex;align-items:baseline;gap:10px;justify-content:space-between">
    <h1>Chat Testbench</h1>
    <span class="ver mono">v0.4.1</span>
  </div>

  <div class="card">
    <div class="row">
      <div class="w-2">
        <div><small>CSV (columns: <span class="mono">query, expected</span>)</small></div>
        <input id="csv" type="file" accept=".csv"/>
        <div class="muted" style="margin-top:6px"><small>Parsed rows: <span id="rowCount">0</span></small></div>
      </div>
      <div class="w-1">
        <div><small>topK</small></div>
        <input id="topk" value="8"/>
      </div>
      <div class="w-1" style="display:flex;gap:8px">
        <button id="run">Run All</button>
        <button id="clear" type="button" style="background:#475569">Clear</button>
      </div>
    </div>
    <details style="margin-top:10px">
      <summary>Paste mode (one query per line; optionally “ | expected” after it)</summary>
      <textarea id="paste" rows="6" placeholder="what tripod do you recommend? | advice&#10;whens the next bluebell workshops and whats the cost | events"></textarea>
      <div style="margin-top:8px"><button id="loadPaste" type="button">Load pasted queries</button></div>
    </details>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th style="width:60px">#</th>
          <th>Query</th>
          <th>Expected</th>
          <th>Detected</th>
          <th>Events</th>
          <th>Articles</th>
          <th>Pills</th>
          <th>Result</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
let tests = [];

function autodetectDelimiter(firstLine){
  const counts = [[',',(firstLine.match(/,/g)||[]).length],[';',(firstLine.match(/;/g)||[]).length],['\t',(firstLine.match(/\t/g)||[]).length]];
  counts.sort((a,b)=>b[1]-a[1]);
  return counts[0][1] ? counts[0][0] : ',';
}
function parseCSV(text){
  // strip BOM
  if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
  const first = (text.split(/\r?\n/)[0]||'');
  const delim = autodetectDelimiter(first);
  const rows=[]; let row=[], val='', inQ=false;
  function pushVal(){ row.push(val); val=''; }
  function pushRow(){ rows.push(row); row=[]; }
  for (let i=0;i<text.length;i++){
    const ch=text[i];
    if (inQ){
      if (ch === '"'){ if (text[i+1] === '"'){ val+='"'; i++; } else { inQ = false; } }
      else val += ch;
    } else {
      if (ch === '"'){ inQ = true; }
      else if (ch === delim){ pushVal(); }
      else if (ch === '\n'){ pushVal(); pushRow(); }
      else if (ch !== '\r'){ val += ch; }
    }
  }
  if (val.length || row.length){ pushVal(); pushRow(); }
  if (!rows.length) return [];
  const header = rows[0].map(h => (h||'').trim().toLowerCase());
  const qi = header.indexOf('query');
  const ei = header.indexOf('expected');
  if (qi === -1){ return []; }
  const out = rows.slice(1).map(r => {
    const q = (r[qi]||'').trim();
    const e = (ei>-1 ? (r[ei]||'').trim() : '');
    return q ? { query:q, expected:e||'' } : null;
  }).filter(Boolean);
  return out;
}
function loadTable(){
  const tbody = $('rows'); tbody.innerHTML='';
  tests.forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="mono">${i+1}</td>
      <td>${escapeHtml(t.query)}</td>
      <td class="mono">${escapeHtml(t.expected||'')}</td>
      <td class="mono" id="det-${i}">–</td>
      <td class="mono" id="ev-${i}">0</td>
      <td class="mono" id="ar-${i}">0</td>
      <td class="mono" id="pi-${i}">0</td>
      <td id="rs-${i}">–</td>
      <td><button data-i="${i}" class="inspect">Inspect</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button.inspect').forEach(btn=>{
    btn.onclick = ()=> showInspect(parseInt(btn.dataset.i,10));
  });
}
function escapeHtml(s){return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}

async function callChat(query, topK){
  const res = await fetch('/api/chat',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ query, topK: Number(topK||8) })
  });
  const txt = await res.text();
  let j=null; try{ j=JSON.parse(txt);}catch{ j={ ok:false, error:'bad_json', raw:txt }; }
  if (!res.ok) j = { ok:false, error:`${res.status} ${res.statusText}`, ...(j||{}) };
  return j;
}
function setCell(id, html){ const el=$(id); if (el) el.innerHTML = html; }
function mark(i, pass, reason){
  setCell(`rs-${i}`, pass ? `<span class="ok">PASS</span>` : `<span class="bad">FAIL</span> <span class="muted mono">${escapeHtml(reason||'')}</span>`);
}

const DETAILS = new Map();
function showInspect(i){
  const row = document.querySelectorAll('#rows tr')[i];
  const after = row.nextSibling;
  // remove existing detail rows
  document.querySelectorAll('tr.details').forEach(n=>n.remove());
  const data = DETAILS.get(i);
  const tr = document.createElement('tr'); tr.className='details';
  const pretty = escapeHtml(JSON.stringify(data||{}, null, 2));
  tr.innerHTML = `<td colspan="9"><details open>
      <summary>Response & debug for row ${i+1}</summary>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
        <div class="card"><div class="muted"><small>answer_markdown</small></div><pre class="mono" style="white-space:pre-wrap">${escapeHtml((data&&data.answer_markdown)||'')}</pre></div>
        <div class="card"><div class="muted"><small>citations</small></div><div>${((data&&data.citations)||[]).map(u=>`<span class="pill mono">${escapeHtml(u)}</span>`).join(' ')||'<span class="muted">none</span>'}</div></div>
        <div class="card" style="grid-column:1/-1"><div class="muted"><small>structured</small></div><pre class="mono" style="white-space:pre-wrap">${pretty}</pre></div>
      </div>
    </details></td>`;
  row.parentNode.insertBefore(tr, after);
}

$('csv').addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  if (!f){ tests=[]; $('rowCount').textContent='0'; loadTable(); return; }
  const text = await f.text();
  tests = parseCSV(text);
  $('rowCount').textContent = String(tests.length);
  loadTable();
});

$('loadPaste').onclick = ()=>{
  const lines = $('paste').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  tests = lines.map(line=>{
    const parts = line.split('|');
    return { query: parts[0].trim(), expected: (parts[1]||'').trim() };
  }).filter(t=>t.query);
  $('rowCount').textContent = String(tests.length);
  loadTable();
};

$('clear').onclick = ()=>{
  $('csv').value=''; $('paste').value=''; tests=[]; $('rowCount').textContent='0'; loadTable();
};

$('run').onclick = async ()=>{
  if (!tests.length){ alert('No rows loaded. Make sure your CSV has a header "query,expected" or use Paste mode.'); return; }
  const topK = $('topk').value || 8;
  for (let i=0;i<tests.length;i++){
    const q = tests[i];
    setCell(`det-${i}`, '…'); setCell(`ev-${i}`, '0'); setCell(`ar-${i}`, '0'); setCell(`pi-${i}`, '0'); setCell(`rs-${i}`, '…');
    try{
      const r = await callChat(q.query, topK);
      DETAILS.set(i, r && r.structured ? r : {answer_markdown:r.answer_markdown,citations:r.citations,structured:r.structured,meta:r.meta});
      const intent = (r.meta && r.meta.intent) || (r.structured && r.structured.intent) || '—';
      const events = (r.structured && r.structured.events && r.structured.events.length) || 0;
      const articles = (r.structured && r.structured.articles && r.structured.articles.length) || 0;
      const pills = (r.structured && r.structured.pills && r.structured.pills.length) || 0;
      setCell(`det-${i}`, escapeHtml(intent));
      setCell(`ev-${i}`, String(events));
      setCell(`ar-${i}`, String(articles));
      setCell(`pi-${i}`, String(pills));
      const exp = (q.expected||'').trim().toLowerCase();
      if (!exp){ mark(i,true,''); }
      else {
        const ok = intent.toLowerCase() === exp;
        mark(i, ok, ok ? '' : `expected ${exp} got ${intent}`);
      }
    }catch(err){
      mark(i,false, String(err && err.message || err));
    }
  }
};
</script>
</body>
</html>
