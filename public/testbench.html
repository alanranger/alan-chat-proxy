<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Bench Test (single-file)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- Supabase client -->
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<style>
  :root {
    --bg:#0f1216; --panel:#151a21; --muted:#9aa4b2; --text:#e8edf3; --hl:#2dd4bf; --accent:#6ee7b7;
    --chip:#1e2630; --chipText:#cfe5ff; --border:#1f2732; --btn:#1a212c; --btnAccent:#2b3544; --red:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial}
  .wrap{display:grid;grid-template-columns:340px 1fr;gap:12px;padding:12px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:10px}
  .card h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);font-weight:600}
  .card .content{padding:10px 12px}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  label{display:block;margin:8px 0 4px;color:var(--muted);font-size:12px}
  input[type="text"],textarea{width:100%;background:#0e141b;border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:8px}
  textarea{min-height:160px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  button{background:var(--btn);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer}
  button.primary{background:#1b2a3a;border-color:#234;box-shadow:inset 0 0 0 1px #2c3b4e}
  button.run{background:#123222;border-color:#165;box-shadow:inset 0 0 0 1px #1a6}
  button.danger{background:#34191c;border-color:#5b1f27}
  button:disabled{opacity:.55;cursor:not-allowed}
  .switch{display:flex;gap:6px;align-items:center;font-size:12px;color:var(--muted)}
  .switch input{accent-color:#22c55e}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{background:var(--chip);color:var(--chipText);padding:6px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;white-space:nowrap}
  .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .pillTitle{color:var(--muted);font-size:12px;margin-bottom:8px}
  .items{display:flex;flex-wrap:wrap;gap:8px;max-height:240px;overflow:auto}
  .item{background:#0f1520;border:1px solid var(--border);padding:6px 8px;border-radius:8px}
  pre{margin:0;background:#0c1117;border:1px solid var(--border);padding:10px;border-radius:8px;max-height:260px;overflow:auto}
  .hint{color:var(--muted);font-size:12px}
  .kpi{display:flex;gap:8px;align-items:center}
  .badge{display:inline-flex;align-items:center;gap:6px;background:#0d1824;border:1px solid var(--border);padding:6px 8px;border-radius:999px;font-size:12px}
  .badge b{color:#bfe8ff}
  .badge .dot{width:8px;height:8px;border-radius:999px;background:var(--hl)}
  .tag{font-size:12px;color:var(--muted)}
  .log{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .tip{border-bottom:1px dashed #789; cursor:help}
</style>
</head>
<body>
<div class="wrap">
  <!-- LEFT: controls -->
  <div class="card">
    <h3>Step 0 · Connect to Supabase</h3>
    <div class="content">
      <label>Supabase URL</label>
      <input id="sb_url" type="text" />
      <label>Supabase ANON key</label>
      <input id="sb_key" type="text" class="mono" />
      <div class="row">
        <div style="flex:1">
          <label style="margin-top:8px">Events view</label>
          <input id="events_view" type="text" value="ai_events"/>
        </div>
        <div style="flex:1">
          <label style="margin-top:8px">Products view</label>
          <input id="products_view" type="text" value="ai_products"/>
        </div>
      </div>
      <div class="row">
        <button id="btnSave" class="primary">Save</button>
        <button id="btnFetch" class="">Fetch live data</button>
        <button id="btnDefaults" class="">Reset defaults</button>
        <span id="connState" class="hint">Not connected</span>
      </div>

      <hr style="border:none;border-top:1px solid var(--border);margin:10px 0">

      <h4 style="margin:0 0 6px">Step 1 (optional) · Landing Pages CSV (fallback)</h4>
      <div class="row">
        <input id="landingCsv" type="file" accept=".csv" />
        <button id="btnUploadLanding">Upload</button>
        <span id="landingState" class="hint">Not loaded</span>
      </div>

      <h4 style="margin:10px 0 6px">Step 2 · Questions CSV</h4>
      <div class="row">
        <input id="qCsv" type="file" accept=".csv" />
        <button id="btnUploadQ">Upload</button>
        <button id="btnRunSuite">Run CSV Test Suite</button>
        <span id="qsState" class="hint">0/0</span>
      </div>

      <h4 style="margin:12px 0 6px">Step 3 · Try a single query</h4>
      <input id="qInput" type="text" placeholder="e.g. when is the next devon workshop?" />
      <div class="row">
        <button id="btnRun" class="run">Run</button>
        <button id="btnCopyJson">Copy JSON</button>
      </div>

      <div class="switch"><input id="useLanding" type="checkbox" checked>Use Landing CSV fallback when direct matches are weak</div>
      <div class="switch"><input id="enableGeneric" type="checkbox">Enable generic search pills (placeholder)</div>

      <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div>
          <div class="tag">Intent</div>
          <div id="intentOut">—</div>
        </div>
        <div>
          <div class="tag">Reason</div>
          <div id="reasonOut" class="mono">—</div>
        </div>
        <div>
          <div class="tag">Landing CSV</div>
          <div id="landingCount" class="mono">0 rows</div>
        </div>
        <div>
          <div class="tag">Events</div>
          <div id="eventsCount" class="mono">not loaded</div>
        </div>
        <div>
          <div class="tag">Products</div>
          <div id="productsCount" class="mono">not loaded</div>
        </div>
        <div>
          <div class="tag">Questions CSV</div>
          <div id="qsCount" class="mono">0 rows</div>
        </div>
        <div class="kpi" style="grid-column:1 / span 2;justify-content:space-between">
          <div class="badge" title="Confidence is a normalized blend of match score (BM25-ish), recency and intent certainty. It’s a hint, not a guarantee."><span class="dot"></span><span>Confidence</span> <b id="confPct">—%</b> <span class="tip">what’s this?</span></div>
          <div class="row">
            <button id="btnCopyLog">Copy Log</button>
            <button id="btnDownloadLog">Download Log</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT: results -->
  <div class="card">
    <h3>Results</h3>
    <div class="content">
      <div class="grid">
        <div>
          <div class="pillTitle">Events</div>
          <div id="eventsBox" class="items"></div>
        </div>
        <div>
          <div class="pillTitle">Articles</div>
          <div id="articlesBox" class="items"></div>
        </div>
        <div>
          <div class="pillTitle">Pills</div>
          <div id="pillsBox" class="items"></div>
        </div>
      </div>

      <h4 style="margin:14px 0 6px">JSON</h4>
      <pre id="jsonBox">{}</pre>

      <h4 style="margin:14px 0 6px">Execution Log</h4>
      <pre id="logBox" class="log"></pre>
    </div>
  </div>
</div>

<script>
/* ------------------ hard-coded defaults (you asked for no typing) ------------------ */
const DEFAULTS = {
  url: "https://igzvwbvgvmzvvzoclufx.supabase.co",
  anon: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnenZ3YnZndm16dnZ6b2NsdWZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2Nzc5MjgsImV4cCI6MjA3MzI1MzkyOH0.A9TCmnXKJhDRYBkrO0mAMPiUQeV9enweeyRWKWQ1SZY",
  eventsView: "ai_events",
  productsView: "ai_products"
};

/* ------------------ state ------------------ */
let supa = null;
let state = {
  events: [],
  products: [],
  landing: [], // [{url,title,meta_title}]
  questions: [], // [{idx, query, expected}]
  results: null,
  log: []
};

function log(line){ state.log.push(`${new Date().toISOString().slice(11,19)}  ${line}`); renderLog(); }
function renderLog(){ document.getElementById('logBox').textContent = state.log.join('\n'); }

/* ------------------ tiny CSV helpers ------------------ */
function parseCsv(text){
  const rows = text.trim().split(/\r?\n/);
  const headers = rows.shift().split(',').map(h=>h.trim());
  return rows.map(r=>{
    const cells = r.split(',').map(c=>c.trim());
    const obj = {};
    headers.forEach((h,i)=>obj[h]=cells[i]??'');
    return obj;
  });
}

/* ------------------ UI helpers ------------------ */
const $ = id => document.getElementById(id);
function chip(s){ const el = document.createElement('div'); el.className='chip'; el.textContent=s; return el; }
function linkItem(title, url){ const d=document.createElement('div'); d.className='item'; const a=document.createElement('a'); a.textContent=title; a.href=url; a.target='_blank'; a.rel='noopener'; a.style.color='#a4d8ff'; a.style.textDecoration='none'; d.appendChild(a); return d; }

/* ------------------ confidence score (simple but useful) ------------------ */
function scoreConfidence({intentScore, topScore, hadLive}){
  // intentScore 0..1 (keyword hit); topScore 0..1 (BM25-ish); hadLive bool (events/products)
  let s = 0.55*topScore + 0.35*intentScore + 0.10*(hadLive?1:0);
  s = Math.max(0, Math.min(1, s));
  return Math.round(s*100);
}

/* ------------------ light-weight matcher ------------------ */
function tokenize(t){ return (t||'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(Boolean); }
function bm25ishScore(queryTokens, text){
  const t = tokenize(text); if(!t.length) return 0;
  const set=new Set(t); let hit=0;
  for(const q of queryTokens){ if(set.has(q)) hit++; }
  return hit / Math.max(3, queryTokens.length); // crude normalization
}
function detectIntent(q){
  const s=q.toLowerCase();
  const wantsEvent = /(next|when|date|where|workshop|devon|norfolk|bluebell|autumn)/.test(s);
  const wantsAdvice = /(price|cost|how much|include|equipment|camera|tripod|certificate|laptop|astrophotography|residential|b&b|b and b)/.test(s);
  // Rule: if it looks like a date/place ask → events; else advice.
  if(wantsEvent && !wantsAdvice) return {intent:'events', reason:'events=✓, advice=0'};
  if(wantsAdvice && !wantsEvent) return {intent:'advice', reason:'advice=✓, events=0'};
  // Mixed → prefer events if any date/place tokens
  return {intent: wantsEvent ? 'events' : 'advice', reason:`events=${wantsEvent?1:0}, advice=${wantsAdvice?1:0}`};
}

/* ------------------ run a single query ------------------ */
async function runOne(query){
  const {intent, reason} = detectIntent(query);
  $('intentOut').textContent = intent;
  $('reasonOut').textContent = reason;

  const qTok = tokenize(query);
  const used = { intent, product: null, events: [], articles: [], pills: [], citations: [] };
  let counts = { events: 0, articles: 0, pills: 0 };

  // EVENTS (live data)
  if(intent==='events' && state.events.length){
    const scored = state.events.map(e => {
      const txt = `${e.title||''} ${e.location||''}`;
      return { e, s: bm25ishScore(qTok, txt) + ( /devon|norfolk|bluebell|autumn|peak|batsford|cotswold|coast/.test(txt.toLowerCase()) ? 0.15 : 0) };
    }).filter(x => x.s>0.05).sort((a,b)=>b.s-a.s).slice(0,6);
    used.events = scored.map(x => ({
      date: eSafe(x.e.starts_on),
      when: x.e.when || null,
      title: x.e.title, location: x.e.location || '',
      url: x.e.url
    }));
    counts.events = used.events.length;
  }

  // ADVICE (policy bits)
  if(intent==='advice'){
    // Residential policy (your correction)
    if(/residential/.test(query.toLowerCase())){
      used.articles.push({
        title: "Residential workshops include B&B and inter-location travel.",
        url: "https://www.alanranger.com/photographic-workshops-near-me"
      });
    }
  }

  // LANDING PAGES FALLBACK (articles)
  if($('useLanding').checked && state.landing.length && (counts.events===0 || intent==='advice')){
    const scoredL = state.landing.map(a => ({ a, s: bm25ishScore(qTok, `${a.title||''} ${a.meta_title||''}`)}))
      .filter(x=>x.s>0.08).sort((a,b)=>b.s-a.s).slice(0,8);
    used.articles.push(...scoredL.map(x => ({title: x.a.title || x.a.meta_title || x.a.url, url: x.a.url})));
  }

  // Pills (simple brand search or catch-all)
  used.pills.push({ label: 'Event Listing', url: 'https://www.alanranger.com/search?query=workshops', brand: true });
  counts.pills = used.pills.length;
  counts.articles = used.articles.length;

  // Confidence
  const topScore = Math.max(0.01, used.events.length ? 0.6 : (used.articles.length?0.35:0.1));
  const intentScore = intent==='events' ? 0.9 : 0.8;
  const conf = scoreConfidence({intentScore, topScore, hadLive: state.events.length>0});
  $('confPct').textContent = conf + '%';

  const result = {
    idx: 1, query, expected: intent, detected: intent, counts, pass: true,
    used, confidence: conf
  };
  state.results = result;
  renderResult();
  log(`Run: "${query}" → intent=${intent}, events=${counts.events}, articles=${counts.articles}, conf=${conf}%`);
}

function eSafe(v){ try{ return v ? String(v) : null }catch{ return null } }

/* ------------------ render ------------------ */
function renderResult(){
  const r = state.results || {};
  $('jsonBox').textContent = JSON.stringify(r, null, 2);

  const evBox = $('eventsBox'); evBox.innerHTML='';
  (r.used?.events || []).forEach(e => evBox.appendChild(linkItem(e.title, e.url)));

  const artBox = $('articlesBox'); artBox.innerHTML='';
  (r.used?.articles || []).forEach(a => artBox.appendChild(linkItem(a.title, a.url)));

  const pillsBox = $('pillsBox'); pillsBox.innerHTML='';
  (r.used?.pills || []).forEach(p => pillsBox.appendChild(linkItem(p.label, p.url)));
}

/* ------------------ Supabase wiring ------------------ */
async function connectSupabase(){
  const url = $('sb_url').value.trim();
  const key = $('sb_key').value.trim();
  if(!url || !key){ $('connState').textContent = 'Missing URL or key'; return; }
  supa = supabase.createClient(url, key);
  $('connState').textContent = 'Saved (not yet fetched)';
  log('Saved Supabase credentials.');
}
async function fetchLive(){
  if(!supa){ await connectSupabase(); }
  const evView = $('events_view').value.trim();
  const prView = $('products_view').value.trim();

  $('btnFetch').disabled = true;
  try{
    // events
    let { data: ev, error: e1 } = await supa.from(evView).select('*').limit(2000);
    if(e1) throw e1;
    state.events = (ev||[]).map(x => ({
      title: x.title ?? x.event_title ?? '',
      url: x.url ?? '',
      when: x.when ?? x.human_when ?? null,
      starts_on: x.starts_on ?? null,
      location: x.location ?? ''
    }));
    $('eventsCount').textContent = state.events.length + ' rows';

    // products
    let { data: pr, error: e2 } = await supa.from(prView).select('*').limit(2000);
    if(e2) throw e2;
    state.products = pr || [];
    $('productsCount').textContent = state.products.length + ' rows';

    $('connState').textContent = 'Connected';
    log(`Fetched live data: events=${state.events.length}, products=${state.products.length}`);
  }catch(err){
    $('connState').textContent = 'Fetch failed';
    log('ERROR fetching live data: ' + (err.message||err));
  }finally{
    $('btnFetch').disabled = false;
  }
}

/* ------------------ CSV handlers ------------------ */
$('btnUploadLanding').onclick = async () => {
  const f = $('landingCsv').files?.[0]; if(!f){ return; }
  const text = await f.text();
  const rows = parseCsv(text);
  // columns accepted: url and one of url_meta_title | meta_title | title
  state.landing = rows.map(r => ({ url: r.url||r.URL||'', meta_title: r.url_meta_title||r.meta_title||'', title: r.title||'' }))
                      .filter(r => r.url);
  $('landingState').textContent = 'Loaded ' + state.landing.length + ' rows';
  $('landingCount').textContent = state.landing.length + ' rows';
  log(`Landing CSV loaded (${state.landing.length} rows).`);
};
$('btnUploadQ').onclick = async () => {
  const f = $('qCsv').files?.[0]; if(!f){ return; }
  const text = await f.text();
  const rows = parseCsv(text).map((r,i)=>({ idx: Number(r.idx||i+1), query: r.query||r.question||'', expected:(r.expected||'').toLowerCase() }));
  state.questions = rows.filter(r=>r.query);
  $('qsState').textContent = `${state.questions.length}/${state.questions.length}`;
  $('qsCount').textContent = state.questions.length + ' rows';
  log(`Questions CSV loaded (${state.questions.length} rows).`);
};
$('btnRunSuite').onclick = async () => {
  if(!state.questions.length){ log('No Questions CSV loaded.'); return; }
  const results = [];
  let passed = 0;
  for(const q of state.questions){
    await runOne(q.query);
    const r = structuredClone(state.results);
    r.idx = q.idx; r.expected = q.expected;
    r.pass = (r.detected === (q.expected||r.detected));
    if(r.pass) passed++;
    results.push(r);
  }
  const rate = Math.round(100*passed/Math.max(1,results.length));
  log(`CSV suite complete. passed=${passed}/${results.length} (${rate}%)`);
  $('jsonBox').textContent = JSON.stringify({ total: results.length, passed, rate: `${rate}%`, results }, null, 2);
};

/* ------------------ wire up buttons ------------------ */
$('btnRun').onclick = () => runOne($('qInput').value.trim());
$('btnCopyJson').onclick = () => { navigator.clipboard.writeText($('jsonBox').textContent||'{}'); };
$('btnCopyLog').onclick = () => { navigator.clipboard.writeText(state.log.join('\n')); };
$('btnDownloadLog').onclick = () => {
  const blob = new Blob([state.log.join('\n')], {type:'text/plain'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='benchtest-log.txt'; a.click();
};
$('btnSave').onclick = connectSupabase;
$('btnFetch').onclick = fetchLive;
$('btnDefaults').onclick = () => {
  $('sb_url').value = DEFAULTS.url;
  $('sb_key').value = DEFAULTS.anon;
  $('events_view').value = DEFAULTS.eventsView;
  $('products_view').value = DEFAULTS.productsView;
  $('connState').textContent = 'Defaults applied';
};

/* ------------------ boot ------------------ */
(function init(){
  // prefill and auto-connect+fetch
  $('sb_url').value = DEFAULTS.url;
  $('sb_key').value = DEFAULTS.anon;
  $('events_view').value = DEFAULTS.eventsView;
  $('products_view').value = DEFAULTS.productsView;
  connectSupabase().then(fetchLive);
  log('Boot OK. Prefilled Supabase creds and requested live fetch.');
})();
</script>
</body>
</html>
