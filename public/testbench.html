<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bench Test — single-file</title>
<style>
  :root{
    --bg:#0f1320; --panel:#141a2a; --muted:#8892b0; --text:#e6e8f0; --accent:#30d158;
    --warn:#ff9f0a; --bad:#ff453a; --pill:#1f2842; --link:#82aaff; --btn:#2b3553;
    --btn2:#213056; --good:#34c759;
    font-synthesis-weight:none;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--link);text-decoration:none}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;height:100vh;padding:14px}
  .col{display:flex;flex-direction:column;gap:12px;min-height:0}
  .card{background:var(--panel);border:1px solid #1d2440;border-radius:10px;padding:12px}
  .card h3{margin:0 0 8px;font-size:12px;color:var(--muted);font-weight:600;letter-spacing:.3px;text-transform:uppercase}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="text"], input[type="password"], textarea{width:100%;background:#0d1220;border:1px solid #1f2746;color:var(--text);border-radius:8px;padding:10px 10px;font-size:13px}
  input[type="file"]{color:var(--muted)}
  .btn{background:var(--btn);color:#e7ecff;border:1px solid #36406a;border-radius:8px;padding:8px 10px;font-weight:600;cursor:pointer}
  .btn:hover{filter:brightness(1.06)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn-run{background:#1e3a2f;border-color:#2c6e49}
  .btn-run:hover{filter:brightness(1.1)}
  .btn-green{background:#0f3b28;border-color:#1a7f47}
  .btn-blue{background:#162a59;border-color:#234aa2}
  .btn-ghost{background:transparent;border-color:#2b3863}
  .tiny{font-size:12px;color:var(--muted)}
  .pill{display:inline-flex;align-items:center;background:var(--pill);border:1px solid #28335d;color:#cfd7ff;border-radius:999px;padding:4px 10px;margin:0 6px 6px 0;font-size:12px;white-space:nowrap}
  .pill[data-type="warn"]{background:#3a2a12;border-color:#6e4b1a;color:#ffd8a8}
  .pill[data-type="ok"]{background:#14351f;border-color:#245734;color:#b7ffd1}
  .list{display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto}
  .list a{display:block;background:#0e1323;border:1px solid #212b55;border-radius:8px;padding:10px}
  .list a:hover{background:#131a31}
  .meta{color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .big{min-height:220px;max-height:320px;overflow:auto;background:#0b1020;border:1px solid #1a2244;border-radius:10px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-size:12px;color:#e6f0ff}
  .log{max-height:150px;overflow:auto;background:#0b1020;border:1px solid #1a2244;border-radius:10px;padding:10px;font-family:ui-monospace,monospace;font-size:12px;color:#cfe3ff}
  .kv{display:grid;grid-template-columns:115px 1fr;gap:4px 8px}
  .badge{display:inline-flex;align-items:center;gap:6px;background:#0c1a3b;border:1px solid #233a77;border-radius:999px;padding:6px 10px}
  .badge b{font-size:16px}
  .tooltip{position:relative}
  .tooltip:hover .tip{opacity:1;transform:translateY(-2px);pointer-events:auto}
  .tip{position:absolute;left:0;top:110%;min-width:280px;z-index:10;opacity:0;pointer-events:none;background:#0b0f1d;border:1px solid #27325b;color:#dbe3ff;border-radius:8px;padding:10px;font-size:12px;transition:.15s}
  .sep{height:8px}
  .hr{height:1px;background:#1e2748;margin:6px 0}
  .switch{display:flex;align-items:center;gap:8px}
  .switch input{accent-color:#2f7ef7}
  .sticky-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .tag{display:inline-block;background:#0c1733;border:1px solid #223562;color:#a9c1ff;border-radius:6px;padding:2px 6px;margin-left:6px;font-size:11px}
  .rightCol{display:flex;flex-direction:column;gap:12px;min-height:0}
  .row-cols{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .muted{color:var(--muted)}
  .ok{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
</style>
</head>
<body>
<div class="wrap">
  <!-- LEFT -->
  <div class="col">
    <div class="card">
      <div class="sticky-head">
        <h3>Bench Test <span class="tag">single-file</span></h3>
        <div class="badge tooltip">
          <span>Confidence:</span>
          <b id="confVal">—%</b>
          <div class="tip">
            Composite score (max 100):<br/>
            • Intent (20)<br/>
            • Query coverage (20)<br/>
            • Required results present (30)<br/>
            • Event freshness (20, events only)<br/>
            • Price detected (10, events only)<br/>
            Empty required sections cap confidence at <b>30%</b>.
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <h3>Step 0: Live data (Supabase)</h3>
      <div class="row">
        <input id="sbUrl" type="text" placeholder="Supabase URL (e.g. https://xyz.supabase.co)" />
      </div>
      <div class="row">
        <input id="sbKey" type="password" placeholder="Supabase anon key" />
      </div>
      <div class="row">
        <input id="sbEvents" type="text" placeholder="Events table/view (default: ai_events)" />
      </div>
      <div class="row">
        <button class="btn btn-blue" id="btnSaveSb">Save</button>
        <button class="btn btn-green" id="btnFetchEvents">Fetch live events</button>
        <span id="sbStatus" class="tiny"></span>
      </div>

      <div class="hr"></div>

      <h3>Step 1 (optional): Upload <em>Landing Pages</em> CSV</h3>
      <div class="tiny">Use when direct matches are weak. Required columns:
        <code>url</code> and at least one of <code>title</code> | <code>meta_title</code> | <code>h1_title</code>. Extra columns are ignored.</div>
      <div class="row">
        <input id="fileLanding" type="file" accept=".csv" />
        <button class="btn" id="btnLanding">Upload</button>
      </div>
      <div class="tiny" id="landingInfo">Landing CSV: <span class="muted">not loaded</span></div>

      <div class="hr"></div>

      <h3>Step 2: Upload <em>Questions</em> CSV (≈15 rows)</h3>
      <div class="tiny">Columns used: <code>idx</code>, <code>query</code>, <code>expected</code>. Extra columns ignored.</div>
      <div class="row">
        <input id="fileQs" type="file" accept=".csv" />
        <button class="btn" id="btnQs">Upload</button>
        <button class="btn" id="btnRunSuite">Run CSV Test Suite</button>
      </div>
      <div class="tiny" id="qsInfo">Questions CSV: <span class="muted">not loaded</span></div>

      <div class="hr"></div>

      <h3>Step 3: (optional) Upload Events snapshot (CSV or JSON)</h3>
      <div class="tiny">Use only if live pull is unavailable. CSV columns accepted:
        <code>title</code>, <code>date</code> or <code>when</code>, <code>location</code>, <code>url</code>, optional <code>price_min</code>, <code>price_max</code>, <code>tags</code>.
      </div>
      <div class="row">
        <input id="fileEvents" type="file" accept=".csv,.json" />
        <button class="btn" id="btnUploadEvents">Upload Events</button>
        <span class="tiny" id="eventsInfo">Events: <span class="muted">not loaded</span></span>
      </div>

      <div class="hr"></div>

      <h3>Step 4: Try a single query</h3>
      <div class="row">
        <input id="queryInput" type="text" placeholder="Ask e.g. 'when is the next devon workshop?'" />
        <button class="btn btn-run" id="btnRun">Run</button>
        <button class="btn btn-ghost" id="btnCopyJson">Copy JSON</button>
      </div>

      <div class="hr"></div>

      <div class="switch"><input id="chkLandingFallback" type="checkbox" checked> <label for="chkLandingFallback">Use Landing CSV fallback when direct matches are weak</label></div>
      <div class="switch"><input id="chkGeneric" type="checkbox"> <label for="chkGeneric">Enable generic search pills (placeholder)</label></div>

      <div class="hr"></div>

      <div class="kv">
        <div class="muted">Intent</div><div id="intentVal">—</div>
        <div class="muted">Reason</div><div id="reasonVal" class="tiny">—</div>
        <div class="muted">Landing CSV</div><div id="landingRows" class="tiny">not loaded</div>
        <div class="muted">Events</div><div id="eventsRows" class="tiny">not loaded</div>
        <div class="muted">Questions CSV</div><div id="qsRows" class="tiny">not loaded</div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn" id="btnCopyLog">Copy Log</button>
        <button class="btn" id="btnDownloadLog">Download Log</button>
        <button class="btn" id="btnCopyFails">Copy Failures (CSV)</button>
        <button class="btn" id="btnCopyAll">Copy All Results (JSON)</button>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="rightCol">
    <div class="row-cols">
      <div class="card">
        <div class="sticky-head"><h3>Events</h3></div>
        <div id="eventsList" class="list"></div>
      </div>
      <div class="card">
        <div class="sticky-head"><h3>Articles</h3></div>
        <div id="articlesList" class="list"></div>
      </div>
      <div class="card">
        <div class="sticky-head"><h3>Pills</h3></div>
        <div id="pillsList" class="row"></div>
      </div>
    </div>

    <div class="card">
      <div class="sticky-head"><h3>JSON</h3><span class="tiny muted">Hover the tags above for breakdown</span></div>
      <pre id="jsonOut" class="big">{}</pre>
    </div>

    <div class="card">
      <div class="sticky-head"><h3>Execution Log</h3><span class="tiny muted">Click to expand / collapse</span></div>
      <pre id="logOut" class="log"></pre>
    </div>
  </div>
</div>

<script>
/* ---------- tiny utils ---------- */
const $ = sel => document.querySelector(sel);
const logLines = [];
const now = () => new Date().toISOString().replace('T',' ').replace('Z','');
function log(msg){ const line = `[${now()}] ${msg}`; logLines.push(line); $("#logOut").textContent = logLines.join('\n'); }
function copy(text){ navigator.clipboard.writeText(text||'').then(()=>{},()=>{}); }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function load(k,def=null){ try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; }catch{ return def; } }
function fmtPct(n){ return Math.round(n) + '%'; }
function daysUntil(dateStr){
  const d = (dateStr instanceof Date)? dateStr : new Date(dateStr);
  if(isNaN(+d)) return null;
  const today = new Date(); today.setHours(0,0,0,0);
  const diff = (d - today)/(1000*60*60*24);
  return Math.round(diff);
}
function sanitizeURL(u){ try{ return new URL(u).href; } catch{ return null; } }

/* ---------- CSV parser (simple, handles quotes) ---------- */
function parseCSV(text){
  const rows = []; let i=0, field='', row=[], inQ=false;
  function endField(){ row.push(field); field=''; }
  function endRow(){ rows.push(row); row=[]; }
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c==='"' && text[i+1]==='"'){ field+='"'; i+=2; continue; }
      if(c==='"'){ inQ=false; i++; continue; }
      field+=c; i++; continue;
    }else{
      if(c==='"'){ inQ=true; i++; continue; }
      if(c===','){ endField(); i++; continue; }
      if(c==='\r'){ i++; continue; }
      if(c==='\n'){ endField(); endRow(); i++; continue; }
      field+=c; i++; continue;
    }
  }
  if(field.length>0 || row.length>0){ endField(); endRow(); }
  if(rows.length===0) return [];
  const hdr = rows[0].map(h=>h.trim());
  return rows.slice(1).filter(r=>r.length>1 || (r.length===1 && r[0])).map(r=>{
    const o={}; hdr.forEach((h,idx)=> o[h]= (r[idx]??'').trim()); return o;
  });
}

/* ---------- state ---------- */
let landing = [];       // [{url,title,meta_title,h1_title}]
let questions = [];     // [{idx,query,expected}]
let events = [];        // normalized events
let suiteResults = [];  // last CSV suite
let lastSingle = null;

const SB = {
  url: load('sb.url',''),
  key: load('sb.key',''),
  events: load('sb.events','ai_events')
};

/* ---------- UI init ---------- */
function hydrateSb(){
  $('#sbUrl').value = SB.url || '';
  $('#sbKey').value = SB.key || '';
  $('#sbEvents').value = SB.events || 'ai_events';
}
hydrateSb();
$('#btnSaveSb').onclick = ()=>{
  SB.url = $('#sbUrl').value.trim();
  SB.key = $('#sbKey').value.trim();
  SB.events = $('#sbEvents').value.trim() || 'ai_events';
  save('sb.url', SB.url); save('sb.key', SB.key); save('sb.events', SB.events);
  log('Saved Supabase settings.');
  $('#sbStatus').textContent = 'saved';
  setTimeout(()=>$('#sbStatus').textContent='',1500);
};

/* ---------- Supabase fetch ---------- */
async function fetchSupabaseEvents(){
  if(!SB.url || !SB.key){ log('Supabase settings missing — cannot fetch.'); $('#sbStatus').textContent='missing settings'; return; }
  try{
    const url = `${SB.url.replace(/\/$/,'')}/rest/v1/${encodeURIComponent(SB.events)}?select=*`;
    log('Fetching live events from Supabase…');
    const res = await fetch(url, {headers:{apikey:SB.key, Authorization:`Bearer ${SB.key}`}});
    if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
    const data = await res.json();
    log(`Fetched ${data.length} raw rows.`);
    events = normalizeEvents(data);
    $('#eventsRows').textContent = `${events.length} loaded`;
    $('#sbStatus').textContent = `loaded ${events.length}`;
    log(`Normalized to ${events.length} events.`);
  }catch(e){
    log(`Supabase fetch failed: ${e.message}`);
    $('#sbStatus').textContent = 'fetch failed';
  }
}
$('#btnFetchEvents').onclick = fetchSupabaseEvents;

/* ---------- normalize event rows ---------- */
function normalizeEvents(arr){
  const out = [];
  for(const r of arr){
    const title = r.title || r.event_title || r.name || r.PageTitle || r.meta_title || '';
    const when  = r.when || r.date_text || r.DateText || '';
    const date  = r.date || r.start_date || r.start || r.EventDate || r.event_date || '';
    const dt = date? new Date(date) : (when? new Date(when) : null);
    const location = r.location || r.area || r.region || r.Location || '';
    const url = r.url || r.link || r.href || (r.slug? (r.base_url? (r.base_url + r.slug) : r.slug) : '');
    const price_min = r.price_min ?? r.min_price ?? r.priceMin ?? r.price ?? null;
    const price_max = r.price_max ?? r.max_price ?? r.priceMax ?? null;
    const tags = (r.tags || r.category || r.Categories || '').toString();
    const o = {title, when: when || (dt? dt.toDateString():''), date: (dt? dt.toISOString():''), location, url, price_min, price_max, tags};
    // basic filter: must have title and url (most of your rows do)
    if(o.title && o.url) out.push(o);
  }
  // prefer future first
  out.sort((a,b)=>{
    const da = +new Date(a.date||a.when||0), db = +new Date(b.date||b.when||0);
    return da - db;
  });
  return out;
}

/* ---------- uploads ---------- */
$('#btnLanding').onclick = async ()=>{
  const f = $('#fileLanding').files[0];
  if(!f) return;
  const txt = await f.text();
  landing = parseCSV(txt).map(r=>({
    url:(r.url||'').trim(),
    title:(r.title||r.h1_title||'').trim(),
    meta_title:(r.meta_title||'').trim()
  })).filter(r=>r.url);
  $('#landingInfo').innerHTML = `Landing CSV: <b>${landing.length} rows</b>`;
  $('#landingRows').textContent = `loaded ${landing.length}`;
  save('bench.landing', landing);
  log(`Landing pages loaded (${landing.length}).`);
};
$('#btnQs').onclick = async ()=>{
  const f = $('#fileQs').files[0];
  if(!f) return;
  const txt = await f.text();
  const rows = parseCSV(txt);
  questions = rows.map(r=>({idx:+(r.idx||rows.indexOf(r)+1), query:(r.query||'').trim(), expected:(r.expected||'').trim()}))
                  .filter(r=>r.query);
  $('#qsInfo').innerHTML = `Questions CSV: <b>${questions.length} rows</b>`;
  $('#qsRows').textContent = `loaded ${questions.length}`;
  log(`Questions loaded (${questions.length}).`);
};
$('#btnUploadEvents').onclick = async ()=>{
  const f = $('#fileEvents').files[0];
  if(!f) return;
  const txt = await f.text();
  let rows=[];
  if(f.name.endsWith('.json')){ rows = JSON.parse(txt); }
  else { rows = parseCSV(txt); }
  events = normalizeEvents(rows);
  $('#eventsInfo').innerHTML = `Events: <b>${events.length} rows</b> (snapshot)`;
  $('#eventsRows').textContent = `loaded ${events.length}`;
  log(`Events snapshot loaded (${events.length}).`);
};

/* ---------- intent & matching ---------- */
const KW = {
  events: ['when','next','where','date','workshop','workshops','event','events','cost','price','bluebell','bluebells','devon','batsford','arboretum','autumn','lake district','fairy glen','hartland'],
  advice: ['how','what','which','do i','can i','is it','is the','need','recommend','free','certificate','laptop','camera','tripod','astrophotography','astro']
};
const SYN = {
  bluebell:['bluebell','bluebells'],
  devon:['devon','hartland','hartland quay','north devon'],
  autumn:['autumn','batsford','arboretum','fall'],
  astro:['astro','astrophotography','night','milky way']
};

function tokenize(s){ return (s||'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(Boolean); }
function hasAny(tokens, list){ const set = new Set(tokens); return list.some(w=>set.has(w)); }

function detectIntent(q){
  const t = tokenize(q);
  const hasEvents = KW.events.some(k=>t.includes(k) || q.toLowerCase().includes(k));
  const askAdvice = KW.advice.some(k=>q.toLowerCase().includes(k));
  if(hasEvents && !askAdvice) return {intent:'events', reason:'events>advice'};
  if(askAdvice && !hasEvents) return {intent:'advice', reason:'advice>events'};
  // tie-breakers: keyword priority
  return {intent: hasEvents ? 'events' : 'advice', reason: hasEvents? 'events>=advice':'advice>=events'};
}

/* product page guess from landing CSV */
function guessProductPage(q){
  if(!landing.length) return null;
  const L = landing;
  const low = q.toLowerCase();
  const hits = L.map(p=>{
    const hay = [p.title,p.meta_title,p.url].join(' ').toLowerCase();
    let score = 0;
    for(const w of tokenize(q)){ if(hay.includes(w)) score+=2; }
    if(/bluebell/.test(hay) && /bluebell/.test(low)) score+=6;
    if(/batsford|arboretum/.test(hay) && /autumn|batsford|arboretum/.test(low)) score+=4;
    if(/hartland|devon/.test(hay) && /devon|hartland/.test(low)) score+=4;
    if(/workshop/.test(hay)) score+=2;
    return {...p,score};
  }).sort((a,b)=>b.score-a.score);
  return hits[0]?.score>3 ? hits[0] : null;
}

/* filter events by query intent */
function matchEvents(q){
  const low = q.toLowerCase();
  const tok = tokenize(q);
  const incl = [];
  function hit(ev){
    const hay = [ev.title,ev.location,ev.tags].join(' ').toLowerCase();
    let s=0;
    for(const w of tok){ if(hay.includes(w)) s+=1; }
    if(/bluebell/.test(low)) if(/bluebell/.test(hay)) s+=3;
    if(/devon|hartland/.test(low)) if(/devon|hartland/.test(hay)) s+=3;
    if(/autumn|batsford|arboretum/.test(low)) if(/autumn|batsford|arboretum/.test(hay)) s+=2;
    if(/astro/.test(low) || /night/.test(low)) if(/astro|night|milky/.test(hay)) s+=3;
    return s;
  }
  for(const ev of events){
    const score = hit(ev);
    if(score>0) incl.push({...ev,_score:score});
  }
  incl.sort((a,b)=> b._score - a._score);
  // prefer future dates
  const futureFirst = incl.sort((a,b)=>{
    const da = daysUntil(a.date||a.when) ?? 9999;
    const db = daysUntil(b.date||b.when) ?? 9999;
    return da - db;
  });
  return futureFirst;
}

/* ---------- confidence ---------- */
function confidenceScore({intent, expected, eventsArr, articlesArr, matchedTokens}){
  // components
  let score = 0;
  const intentOk = (expected? intent===expected : true);
  score += intentOk ? 20 : 5;

  const cov = Math.min(1, (matchedTokens||0)/6); // crude cap
  score += cov*20;

  const requiredOk = (intent==='events' ? (eventsArr.length>0) : (articlesArr.length>0));
  score += requiredOk ? 30 : 0;
  if(!requiredOk) score = Math.min(score, 30);

  if(intent==='events'){
    let fresh=0;
    if(eventsArr.length){
      const d = daysUntil(eventsArr[0].date||eventsArr[0].when);
      if(d==null) fresh = .3;
      else if(d<=30) fresh=1;
      else if(d<=120) fresh=.75;
      else if(d<=240) fresh=.5;
      else fresh=.25;
    }
    score += fresh*20;

    const hasPrice = eventsArr.some(e=>e.price_min || e.price_max || /\£\s?\d+/.test(e.title));
    score += hasPrice ? 10 : 0;
  }
  return Math.round(score);
}

/* ---------- policy & answer helpers ---------- */
function residentialPolicyAnswer(){
  // This is the corrected statement you asked for.
  return "Yes — residential workshops include B&B and local travel between locations. See the residential workshop page/FAQ for details.";
}

/* ---------- run single query ---------- */
function clearPanels(){
  $('#eventsList').innerHTML = '';
  $('#articlesList').innerHTML = '';
  $('#pillsList').innerHTML = '';
  $('#jsonOut').textContent = '{}';
}
function addEventCard(ev){
  const a = document.createElement('a');
  a.href = sanitizeURL(ev.url)||'#'; a.target='_blank'; a.rel='noopener';
  a.innerHTML = `<div><b>${ev.title}</b></div><div class="meta">${ev.when || ev.date} — ${ev.location||''}${ev.price_min||ev.price_max?` — £${ev.price_min||''}${ev.price_max?`–£${ev.price_max}`:''}`:''}</div>`;
  $('#eventsList').appendChild(a);
}
function addArticleCard(obj){
  const a = document.createElement('a');
  a.href = sanitizeURL(obj.url)||'#'; a.target='_blank'; a.rel='noopener';
  a.innerHTML = `<div><b>${obj.title||obj.meta_title||obj.url}</b></div><div class="meta">${obj.url}</div>`;
  $('#articlesList').appendChild(a);
}
function addPill(label, url=null, type=null){
  const s = document.createElement(url?'a':'span');
  if(url){ s.href=url; s.target='_blank'; s.rel='noopener'; }
  s.className='pill';
  if(type) s.dataset.type=type;
  s.textContent = label;
  $('#pillsList').appendChild(s);
}

function landingSearch(q, limit=6){
  if(!landing.length) return [];
  const low = q.toLowerCase();
  const scored = landing.map(p=>{
    const hay = [p.title,p.meta_title,p.url].join(' ').toLowerCase();
    let score = 0;
    for(const w of tokenize(q)){ if(hay.includes(w)) score+=1; }
    if(/blog|guide|tips/.test(hay)) score+=1;
    if(/workshop|course/.test(hay)) score+=1;
    return {...p,score};
  }).filter(x=>x.score>0).sort((a,b)=>b.score-a.score);
  return scored.slice(0,limit).map(({url,title,meta_title})=>({url,title:title||meta_title||url}));
}

function derivePills(intent, used, q){
  const pills = [];
  if(intent==='events'){
    if(used.events.length){
      const first = used.events[0];
      pills.push({label:'Book Now', url:first.url, brand:true});
    }
    pills.push({label:'Event Listing', url:'https://www.alanranger.com/search?query=workshops', brand:true});
    pills.push({label:'More Events', url:'https://www.alanranger.com/search?query=workshops', brand:true});
    pills.push({label:'Photos', url:'https://www.alanranger.com/gallery-image-portfolios', brand:false});
  }else{
    const art = used.articles[0];
    if(art) pills.push({label:'Read Guide', url:art.url, brand:true});
    pills.push({label:'More Articles', url:`https://www.alanranger.com/search?query=${encodeURIComponent(q)}`, brand:true});
    pills.push({label:'Events', url:'https://www.alanranger.com/search?query=workshops', brand:false});
    pills.push({label:'Photos', url:'https://www.alanranger.com/gallery-image-portfolios', brand:false});
  }
  return pills;
}

function runSingleQuery(q, expected=null){
  clearPanels();
  if(!q) return;
  const det = detectIntent(q);
  $('#intentVal').textContent = det.intent;
  $('#reasonVal').textContent = det.reason;

  let productPage = guessProductPage(q);
  let matched = matchEvents(q);

  // Residential policy correction
  let specialAnswer = null;
  if(/residential/i.test(q) && /(b&b|bb|b and b|bed|breakfast|include)/i.test(q)){
    specialAnswer = residentialPolicyAnswer();
  }

  // fallback to landing if events thin or empty (and option enabled)
  if($('#chkLandingFallback').checked && det.intent==='events' && matched.length===0){
    log('No events matched — using Landing CSV fallback.');
  }

  // build articles (landing matches used as "articles" here)
  let articles = landingSearch(q);
  // If product page recognized, pin it first as the "product block"
  if(productPage){
    articles = [{title: productPage.title||productPage.meta_title||'Product', url: productPage.url}, ...articles.filter(a=>a.url!==productPage.url)];
  }

  // If advice and we had the residential policy: ensure an article-like source appears (product page or fallback)
  if(det.intent==='advice' && specialAnswer){
    if(!articles.length && productPage){ articles = [{title: productPage.title||'Residential Workshops', url: productPage.url}]; }
  }

  // present UI
  const used = { intent: det.intent, product: productPage, events: matched.slice(0,12), articles: articles.slice(0,10) };
  used.citations = [...used.events.map(e=>e.url), ...used.articles.map(a=>a.url)].slice(0,12);

  // events list
  for(const e of used.events){ addEventCard(e); }
  // articles list
  for(const a of used.articles){ addArticleCard(a); }
  // pills
  for(const p of derivePills(det.intent, used, q)){ addPill(p.label, p.url); }

  const matchedTokens = tokenize(q).filter(t=> (used.events[0]?.title?.toLowerCase()||'').includes(t) || (used.articles[0]?.title?.toLowerCase()||'').includes(t)).length;
  const conf = confidenceScore({intent:det.intent, expected, eventsArr:used.events, articlesArr:used.articles, matchedTokens});
  $('#confVal').textContent = fmtPct(conf);

  // JSON object (close to your format)
  const out = {
    idx: 1, query: q, expected: expected||det.intent, detected: det.intent,
    counts: { events: used.events.length, articles: used.articles.length, pills: 4 },
    pass: expected? (
      expected==='events' ? used.events.length>0 : used.articles.length>0
    ) : true,
    used,
    confidence: conf
  };
  if(specialAnswer){
    out.used.answer = specialAnswer;
  }
  $('#jsonOut').textContent = JSON.stringify(out, null, 2);
  lastSingle = out;
  return out;
}

/* ---------- run CSV suite ---------- */
$('#btnRunSuite').onclick = async ()=>{
  if(!questions.length){ alert('Load Questions CSV first.'); return; }
  log(`Running CSV suite (${questions.length} rows)…`);
  suiteResults = [];
  let pass=0;
  for(const row of questions){
    const r = runSingleQuery(row.query, row.expected);
    r.idx = row.idx;
    suiteResults.push(r);
    if(r.pass) pass++;
  }
  const pct = Math.round(pass*100/questions.length);
  log(`Suite complete. Passed ${pass}/${questions.length} (${pct}%).`);
};

$('#btnRun').onclick = ()=> runSingleQuery($('#queryInput').value.trim());

/* ---------- copy helpers ---------- */
$('#btnCopyJson').onclick = ()=> copy($('#jsonOut').textContent);
$('#btnCopyLog').onclick = ()=> copy(logLines.join('\n'));
$('#btnDownloadLog').onclick = ()=>{
  const blob = new Blob([logLines.join('\n')], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `bench-log-${Date.now()}.txt`;
  a.click();
};
$('#btnCopyAll').onclick = ()=> copy(JSON.stringify(suiteResults.length? suiteResults : (lastSingle? [lastSingle] : []), null, 2));
$('#btnCopyFails').onclick = ()=>{
  const rows = (suiteResults.length? suiteResults : []).filter(r=>!r.pass);
  const csv = ['idx,query,expected,detected,events,articles,confidence'].concat(
    rows.map(r=>[r.idx, JSON.stringify(r.query), r.expected, r.detected, r.counts.events, r.counts.articles, r.confidence].join(','))
  ).join('\n');
  copy(csv);
};

/* ---------- initial tips ---------- */
log('Ready. Load Events (live via Supabase or snapshot), Landing CSV (optional), Questions CSV, then Run query or CSV Suite.');

/* ---------- restore persisted landing (if any) ---------- */
const persistedLanding = load('bench.landing', null);
if(persistedLanding && Array.isArray(persistedLanding)){
  landing = persistedLanding;
  $('#landingInfo').innerHTML = `Landing CSV: <b>${landing.length} rows</b> (restored)`;
  $('#landingRows').textContent = `loaded ${landing.length}`;
}
</script>
</body>
</html>
