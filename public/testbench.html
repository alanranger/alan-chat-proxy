<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bench Test – Events / Products / Articles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Supabase & PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg:#0e1117;--panel:#161b22;--muted:#9aa4b3;--text:#e6edf3;--accent:#3b82f6;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;
      --border:#222834;--chip:#1f2633;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif}
    .page{display:grid;grid-template-columns:300px 1fr;gap:14px;padding:14px;min-height:100vh}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px}
    .left{display:flex;flex-direction:column;gap:14px}
    .section{padding:12px}
    .section h3{margin:0 0 10px 0;font-weight:600;font-size:14px;color:#cbd5e1}
    .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    input[type=text], select{width:100%;background:#0b0f15;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 10px}
    button{background:#1f2937;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 10px;cursor:pointer}
    button.primary{background:var(--accent);border-color:transparent}
    button.small{padding:6px 8px;font-size:12px}
    button:disabled{opacity:.5;cursor:not-allowed}
    .kpi{display:flex;gap:10px;margin-top:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0b0f15;color:#cbd5e1}
    .badge.ok{border-color:#1f5130;background:#0b1f14;color:#86efac}
    .badge.warn{border-color:#4a3a14;background:#1a1307;color:#fde68a}
    .badge.err{border-color:#5a1a1a;background:#1a0b0b;color:#fecaca}
    .right{display:grid;grid-template-rows:auto 1fr;gap:14px}
    .grids{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .table{width:100%;border-collapse:collapse;font-size:13px}
    .table th,.table td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;vertical-align:top}
    .table th{color:#cbd5e1;background:#111622;position:sticky;top:0}
    .gridTitle{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border)}
    .gridTitle h4{margin:0;font-weight:600}
    .pillbar{display:flex;flex-wrap:wrap;gap:6px;padding:8px}
    .pill{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px;color:var(--muted)}
    .log{height:220px;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap;background:#0b0f15;border-top:1px solid var(--border);border-radius:0 0 10px 10px;padding:10px}
    .hint{font-size:12px;color:var(--muted)}
    a.link{color:#a5b4fc;text-decoration:none}
  </style>
</head>
<body>
<div class="page">
  <!-- LEFT PANEL -->
  <div class="left">
    <div class="card section">
      <h3>Step 0 · Connect to Supabase</h3>
      <div class="row"><input id="sbUrl" type="text" placeholder="Supabase URL"></div>
      <div class="row"><input id="sbAnon" type="text" placeholder="Supabase ANON key"></div>
      <div class="row">
        <select id="eventsView"><option value="ai_events">ai_events</option></select>
        <select id="productsView"><option value="ai_products">ai_products</option></select>
      </div>
      <div class="row">
        <select id="articlesView"><option value="ai_articles">ai_articles</option></select>
      </div>
      <div class="row">
        <button id="saveCfg" class="small">Save</button>
        <button id="resetCfg" class="small">Reset defaults</button>
      </div>
      <div class="row">
        <button id="btnConnect" class="primary">Connect</button>
        <button id="btnFetch">Fetch live data</button>
      </div>
      <div class="kpi"><span id="connStatus" class="badge">Disconnected.</span></div>
      <div class="row" style="margin-top:6px;">
        <label class="hint"><input id="useLandingFallback" type="checkbox" /> Use Landing CSV fallback</label>
        <label class="hint" style="margin-left:10px;"><input id="enableGenericPills" type="checkbox" checked /> Enable generic pills</label>
      </div>
    </div>

    <div class="card section">
      <h3>Step 1 (optional) · Landing Pages CSV (fallback)</h3>
      <div class="hint">Required columns: <code>url</code> and one of <code>meta_title</code> or <code>title</code>.</div>
      <div class="row"><input id="landingCsv" type="file" accept=".csv" /><button id="clearLanding" class="small">Clear</button></div>
      <div id="landingInfo" class="hint">No file loaded.</div>
    </div>

    <div class="card section">
      <h3>Step 2 · Questions CSV</h3>
      <div class="hint">Columns: <code>idx, query, expected</code>. Extra columns ignored.</div>
      <div class="row"><input id="questionsCsv" type="file" accept=".csv" /><button id="clearQuestions" class="small">Clear</button></div>
      <div class="row">
        <button id="runSuite" class="primary">Run whole suite</button>
        <button id="downloadSuiteJson" class="small">Download suite JSON</button>
      </div>
      <div id="questionsInfo" class="hint">No file loaded.</div>
    </div>

    <div class="card section">
      <h3>Step 3 · Try a single query</h3>
      <div class="row"><input id="singleQuery" type="text" placeholder="e.g. when is the next devon workshop?" /></div>
      <div class="row">
        <button id="btnRun" class="primary">Run</button>
        <button id="btnCopyJson" class="small">Copy JSON</button>
        <button id="btnDownloadJson" class="small">Download JSON</button>
      </div>
      <div class="kpi">
        <span id="intentBadge" class="badge">intent: —</span>
        <span id="countsBadge" class="badge">events=0, products=0, articles=0, pills=0</span>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right">
    <div class="grids">
      <div class="card">
        <div class="gridTitle"><h4>Results · Events</h4><span id="eventsKpi" class="badge">–</span></div>
        <div style="max-height:260px;overflow:auto;">
          <table class="table" id="eventsTable">
            <thead><tr><th style="width:34%">title</th><th>url</th><th style="width:16%">when</th><th style="width:18%">location</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="gridTitle"><h4>Results · Products</h4><span id="productsKpi" class="badge">–</span></div>
        <div style="max-height:260px;overflow:auto;">
          <table class="table" id="productsTable">
            <thead><tr><th style="width:45%">title</th><th>url</th><th style="width:12%">price</th><th style="width:16%">tags</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="grids">
      <div class="card">
        <div class="gridTitle"><h4>Results · Articles</h4><span id="articlesKpi" class="badge">–</span></div>
        <div style="max-height:220px;overflow:auto;">
          <table class="table" id="articlesTable">
            <thead><tr><th style="width:55%">title</th><th>url</th><th>snippet</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="gridTitle">
          <h4>Pills generated</h4>
          <div><span id="pillCounts" class="badge">Events 0</span><span id="pillCounts2" class="badge" style="margin-left:6px;">Products 0</span><span id="pillCounts3" class="badge" style="margin-left:6px;">Articles 0</span></div>
        </div>
        <div class="pillbar" id="pillBar"></div>
      </div>
    </div>

    <div class="card" id="suiteCard">
      <div class="gridTitle">
        <h4>Suite Results</h4>
        <span id="suiteSummary" class="badge">—</span>
      </div>
      <div style="max-height:240px;overflow:auto;">
        <table class="table" id="suiteTable">
          <thead>
            <tr>
              <th style="width:60px;">idx</th>
              <th>query</th>
              <th style="width:120px;">expected</th>
              <th style="width:120px;">predicted</th>
              <th style="width:80px;">ok</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="gridTitle"><h4>Execution Log</h4></div>
      <div id="log" class="log"></div>
    </div>
  </div>
</div>

<script>
/* =========================
   HARD-CODED DEFAULTS
========================= */
const DEFAULTS = {
  SUPABASE_URL: 'https://igzvwbvgvmzvvzoclufx.supabase.co',
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnenZ3YnZndm16dnZ6b2NsdWZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2Nzc5MjgsImV4cCI6MjA3MzI1MzkyOH0.A9TCmnXKJhDRYBkrO0mAMPiUQeV9enweeyRWKWQ1SZY',
  VIEW_EVENTS:   'ai_events',
  VIEW_PRODUCTS: 'ai_products',
  VIEW_ARTICLES: 'ai_articles',
  PREVIEW_ROWS: 20
};

let supa = null;
let env = {...DEFAULTS};
let live = { events: [], products: [], articles: [] };
let landing = [];     // CSV fallback pages
let questions = [];   // suite rows
let lastRun = null;
let suiteResults = [];

/* =========================
   UTILITIES
========================= */
const $ = s => document.querySelector(s);
function log(msg){ const t=new Date().toLocaleTimeString(); const el=$("#log"); el.textContent += (el.textContent?'\n':'') + `${t}  ${msg}`; el.scrollTop = el.scrollHeight; }
function esc(s){ return (s??'').toString().replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }
function link(u){ return u?`<a href="${u}" target="_blank" class="link">${esc(u)}</a>`:''; }
function money(v){ if(v==null||v==='') return ''; const n=Number(v); if(!isFinite(n)) return String(v); return '£'+n.toLocaleString('en-GB',{maximumFractionDigits:0}); }
const sleep = ms => new Promise(r=>setTimeout(r,ms));

function setBadge(sel,text,kind){ const el = $(sel); el.textContent = text; el.className = `badge${kind?(' '+kind):''}`; }
function downloadBlob(text,name,type='application/json'){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type})); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

function tokens(q){ return (q||'').toLowerCase().replace(/[^a-z0-9\s-]/g,' ').split(/\s+/).filter(Boolean); }
function buildOrIlike(keys, cols){
  const safe = (keys||[]).map(k=>k.replace(/[%_,]/g,'')).filter(k=>k.length>=3).slice(0,6);
  if(!safe.length) return null;
  const parts=[]; for(const k of safe){ for(const c of cols){ parts.push(`${c}.ilike.%${k}%`); } }
  return parts.join(',');
}
function uniqBy(arr,key){ const m=new Map(); for(const it of arr){ m.set(key(it),it); } return [...m.values()]; }

/* =========================
   RENDER HELPERS
========================= */
function renderTable(tbodySel, rows, cols){
  const tbody = document.querySelector(tbodySel+' tbody');
  tbody.innerHTML = '';
  (rows||[]).forEach(r=>{
    const tr = document.createElement('tr');
    cols.forEach(c=>{
      const td=document.createElement('td');
      const v=r[c];
      if(c==='url') td.innerHTML = link(v);
      else if(c==='price') td.textContent = money(v);
      else td.textContent = v==null?'':v;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

/* =========================
   PILLS
========================= */
function generatePills(query){
  const pills=[];
  const add=(label,url,brand=true,type=null)=>{ pills.push({label,url,brand,type}); };
  // Brand/navigation (from site structure)
  add('Blog / Articles','https://www.alanranger.com/blog-on-photography',true,'article');
  add('Gift Vouchers','https://www.alanranger.com/photography-gift-vouchers',true,'product');
  add('Payment Plan','https://www.alanranger.com/photography-payment-plan',true,'product');
  add('Event Listing','https://www.alanranger.com/search?query=workshops',true,'event');
  add('Course Finder','https://www.alanranger.com/course-finder-photography-classes-near-me',true,'event');
  add('Home','https://www.alanranger.com',true);
  // Query echo site-search
  const q=query.trim(); if(q){ add(`Search site: “${q.slice(0,28)}”`,'https://www.alanranger.com/search?query='+encodeURIComponent(q),false); }
  // Top matches as quick pills
  (lastRun?.events||[]).slice(0,3).forEach(e=> add(e.title,e.url,false,'event'));
  (lastRun?.products||[]).slice(0,2).forEach(p=> add(p.title,p.url,false,'product'));
  (lastRun?.articles||[]).slice(0,2).forEach(a=> add(a.title,a.url,false,'article'));
  return pills;
}
function renderPills(pills){
  const bar=$("#pillBar"); bar.innerHTML='';
  pills.forEach(p=>{ const a=document.createElement('a'); a.href=p.url; a.target='_blank'; a.className='pill'; a.textContent=p.label; bar.appendChild(a); });
  const c={events:pills.filter(x=>x.type==='event').length,products:pills.filter(x=>x.type==='product').length,articles:pills.filter(x=>x.type==='article').length};
  $("#pillCounts").textContent=`Events ${c.events}`; $("#pillCounts2").textContent=`Products ${c.products}`; $("#pillCounts3").textContent=`Articles ${c.articles}`;
}

/* =========================
   INTENT (simple & stable)
========================= */
function detectIntent(q){
  const t=tokens(q);
  const has=s=>t.includes(s);
  const any=a=>a.some(has);
  if(any(['workshop','workshops','course','courses','class','classes','event','events','date','when','where','next'])) return 'events';
  if(any(['price','cost','£','gbp'])) return 'products';
  if(any(['blog','article','guide','tips','how'])) return 'articles';
  return 'events';
}

/* =========================
   SUPABASE
========================= */
function hydrateConfig(){
  $('#sbUrl').value = env.SUPABASE_URL;
  $('#sbAnon').value = env.SUPABASE_ANON_KEY;
  $('#eventsView').value = env.VIEW_EVENTS;
  $('#productsView').value = env.VIEW_PRODUCTS;
  $('#articlesView').value = env.VIEW_ARTICLES;
}
function readConfig(){
  env.SUPABASE_URL = $('#sbUrl').value.trim() || DEFAULTS.SUPABASE_URL;
  env.SUPABASE_ANON_KEY = $('#sbAnon').value.trim() || DEFAULTS.SUPABASE_ANON_KEY;
  env.VIEW_EVENTS   = $('#eventsView').value || DEFAULTS.VIEW_EVENTS;
  env.VIEW_PRODUCTS = $('#productsView').value || DEFAULTS.VIEW_PRODUCTS;
  env.VIEW_ARTICLES = $('#articlesView').value || DEFAULTS.VIEW_ARTICLES;
}
function saveLocal(){ localStorage.setItem('bench.env', JSON.stringify(env)); }
function loadLocal(){ try{ env = JSON.parse(localStorage.getItem('bench.env')) || {...DEFAULTS}; } catch{ env = {...DEFAULTS}; } }

async function connect(){
  readConfig();
  supa = window.supabase.createClient(env.SUPABASE_URL, env.SUPABASE_ANON_KEY, {auth:{persistSession:false}});
  setBadge('#connStatus','Connecting…');
  log('Connecting to Supabase…');

  const [E,P,A] = await Promise.all([
    supa.from(env.VIEW_EVENTS).select('title',{count:'estimated',head:true}),
    supa.from(env.VIEW_PRODUCTS).select('title',{count:'estimated',head:true}),
    supa.from(env.VIEW_ARTICLES).select('title',{count:'estimated',head:true})
  ]);

  if(E.error||P.error||A.error){
    setBadge('#connStatus','Error','err');
    if(E.error) log('events: '+E.error.message);
    if(P.error) log('products: '+P.error.message);
    if(A.error) log('articles: '+A.error.message);
    return;
  }
  setBadge('#connStatus','Connected.','ok');
  log(`Views reachable · ${env.VIEW_EVENTS}: ${E.count||'?'} · ${env.VIEW_PRODUCTS}: ${P.count||'?'} · ${env.VIEW_ARTICLES}: ${A.count||'?'}`);
}

async function fetchLive(){
  if(!supa) await connect();
  setBadge('#eventsKpi','Loading…'); setBadge('#productsKpi','Loading…'); setBadge('#articlesKpi','Loading…');
  const [ev, pr, ar] = await Promise.all([
    supa.from(env.VIEW_EVENTS).select('title,url,when,location,start_date,date_start,date_end').order('start_date',{ascending:true}).limit(2000),
    supa.from(env.VIEW_PRODUCTS).select('title,url,price,tags').limit(2000),
    supa.from(env.VIEW_ARTICLES).select('title,url,snippet,kind').order('last_seen',{ascending:false}).limit(2000)
  ]);
  if(ev.error) log('events error: '+ev.error.message);
  if(pr.error) log('products error: '+pr.error.message);
  if(ar.error) log('articles error: '+ar.error.message);

  live.events = ev.data||[];
  live.products = pr.data||[];
  live.articles = (ar.data||[]).filter(x => (x.kind||'article').toLowerCase()==='article');

  setBadge('#eventsKpi',`Loaded ${live.events.length}`,'ok');
  setBadge('#productsKpi',`Loaded ${live.products.length}`,'ok');
  setBadge('#articlesKpi',`Loaded ${live.articles.length}`,'ok');

  // preview
  renderTable('#eventsTable', live.events.slice(0, DEFAULTS.PREVIEW_ROWS), ['title','url','when','location']);
  renderTable('#productsTable', live.products.slice(0, DEFAULTS.PREVIEW_ROWS), ['title','url','price','tags']);
  renderTable('#articlesTable', live.articles.slice(0, DEFAULTS.PREVIEW_ROWS), ['title','url','snippet']);

  log(`Loaded events=${live.events.length}, products=${live.products.length}, articles=${live.articles.length}.`);
}

/* Prefer RPCs; fallback to views with OR ILIKE */
async function rpcOrView(kind, keys){
  const k = keys.filter(t=>t.length>=3);
  try{
    if(kind==='events'){
      const { data, error } = await supa.rpc('search_events',{ text: k });
      if(!error && data) return data;
    }else if(kind==='products'){
      const { data, error } = await supa.rpc('search_products',{ text: k });
      if(!error && data) return data;
    }else if(kind==='articles'){
      const { data, error } = await supa.rpc('search_articles',{ text: k });
      if(!error && data) return data;
    }
  }catch(_){/* ignore; fall back */}
  const or = kind==='articles'
    ? buildOrIlike(k, ['title','snippet'])
    : buildOrIlike(k, ['title']);
  if(!or) return [];
  if(kind==='events'){
    const {data} = await supa.from(env.VIEW_EVENTS).select('title,url,when,location,start_date,date_start,date_end').or(or).limit(200);
    return data||[];
  }
  if(kind==='products'){
    const {data} = await supa.from(env.VIEW_PRODUCTS).select('title,url,price,tags').or(or).limit(200);
    return data||[];
  }
  if(kind==='articles'){
    const {data} = await supa.from(env.VIEW_ARTICLES).select('title,url,snippet,kind').or(or).limit(200);
    return (data||[]).filter(x => (x.kind||'article').toLowerCase()==='article');
  }
  return [];
}

/* =========================
   RUNNERS
========================= */
async function runSingle(query){
  if(!supa) await connect();
  const intent = detectIntent(query);
  $('#intentBadge').textContent = `intent: ${intent}`;

  const keys = tokens(query);
  let events=[], products=[], articles=[];

  // Events first
  events = await rpcOrView('events', keys);
  // keep upcoming first where dates exist
  const now = Date.now();
  events = events.sort((a,b)=>{
    const ta = Date.parse(a.date_start||a.start_date||'') || Infinity;
    const tb = Date.parse(b.date_start||b.start_date||'') || Infinity;
    return ta - tb;
  });

  // Products for price
  products = await rpcOrView('products', keys);

  // Articles
  articles = await rpcOrView('articles', keys);
  if(!articles.length && $('#useLandingFallback').checked && landing.length){
    const contentish = landing.filter(x => /blog|tips|guide|article|tutorial/i.test(`${x.title||x.meta_title||""}`));
    articles = contentish.slice(0,2).map(x => ({title:x.title||x.meta_title||'(landing)', url:x.url, snippet:'(from Landing CSV)', kind:'landing'}));
  }

  lastRun = {
    q: query,
    intent,
    counts:{ events:events.length, products:products.length, articles:articles.length },
    events, products, articles
  };

  // Render
  renderTable('#eventsTable', events.slice(0, DEFAULTS.PREVIEW_ROWS), ['title','url','when','location']);
  renderTable('#productsTable', products.slice(0, DEFAULTS.PREVIEW_ROWS), ['title','url','price','tags']);
  renderTable('#articlesTable', articles.slice(0, DEFAULTS.PREVIEW_ROWS), ['title','url','snippet']);

  const pills = $('#enableGenericPills').checked ? generatePills(query) : [];
  lastRun.pills = pills;
  renderPills(pills);

  $('#countsBadge').textContent = `events=${events.length}, products=${products.length}, articles=${articles.length}, pills=${pills.length}`;
  log(`Run: ${JSON.stringify({q:query,intent})}`);
}

async function runSuite(){
  if(!questions.length){ log('No questions CSV loaded.'); return; }
  suiteResults = []; $('#suiteTable tbody').innerHTML = '';
  let pass=0;
  for(const row of questions){
    const idx = String(row.idx ?? suiteResults.length+1);
    const q = (row.query||'').toString();
    const expected = (row.expected||'').toString().toLowerCase();

    await runSingle(q);
    const predicted = (lastRun.intent||'').toLowerCase();
    const ok = expected ? (predicted === expected) : true;
    if(ok) pass++;

    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${esc(idx)}</td><td>${esc(q)}</td><td>${esc(expected)}</td><td>${esc(predicted)}</td><td>${ok?'✅':'❌'}</td>`;
    $('#suiteTable tbody').appendChild(tr);

    suiteResults.push({
      idx,q,expected,predicted,ok,
      used:{
        top_events:(lastRun.events||[]).slice(0,5),
        top_products:(lastRun.products||[]).slice(0,5),
        top_articles:(lastRun.articles||[]).slice(0,5),
        pills:lastRun.pills||[]
      }
    });
    await sleep(30);
  }
  const pct=Math.round(pass/suiteResults.length*100);
  setBadge('#suiteSummary',`Suite: ${pass}/${suiteResults.length} matched (${pct}%)`, pass===suiteResults.length?'ok':(pct>=70?'warn':'err'));
  log(`Suite done: ${pass}/${suiteResults.length} matched expected intent.`);
}

/* =========================
   CSV LOADERS
========================= */
function parseCSV(file){
  return new Promise((resolve,reject)=>{
    Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>resolve(r.data),error:reject});
  });
}

/* =========================
   WIRING
========================= */
function wire(){
  loadLocal(); hydrateConfig();
  $('#saveCfg').onclick = ()=>{ readConfig(); saveLocal(); log('Saved configuration.'); };
  $('#resetCfg').onclick = ()=>{ env={...DEFAULTS}; saveLocal(); hydrateConfig(); log('Defaults restored.'); };
  $('#btnConnect').onclick = connect;
  $('#btnFetch').onclick = fetchLive;

  $('#landingCsv').onchange = async e=>{
    const f=e.target.files?.[0]; if(!f){ landing=[]; $('#landingInfo').textContent='No file loaded.'; return; }
    landing = await parseCSV(f);
    $('#landingInfo').textContent = `Loaded ${landing.length} landing pages.`;
    log(`Landing CSV loaded (${landing.length} rows).`);
  };
  $('#clearLanding').onclick = ()=>{ landing=[]; $('#landingCsv').value=''; $('#landingInfo').textContent='Cleared.'; };

  $('#questionsCsv').onchange = async e=>{
    const f=e.target.files?.[0]; if(!f){ questions=[]; $('#questionsInfo').textContent='No file loaded.'; return; }
    questions = await parseCSV(f);
    $('#questionsInfo').textContent = `Loaded ${questions.length} questions.`;
    log(`Questions CSV loaded (${questions.length} rows).`);
  };
  $('#clearQuestions').onclick = ()=>{ questions=[]; $('#questionsCsv').value=''; $('#questionsInfo').textContent='Cleared.'; };

  $('#btnRun').onclick = ()=> runSingle($('#singleQuery').value||'');
  $('#btnCopyJson').onclick = ()=>{ if(!lastRun) return; navigator.clipboard.writeText(JSON.stringify(lastRun,null,2)); log('Copied JSON of last run.'); };
  $('#btnDownloadJson').onclick = ()=>{ if(!lastRun) return; downloadBlob(JSON.stringify(lastRun,null,2),'bench-last-run.json'); };
  $('#runSuite').onclick = runSuite;
  $('#downloadSuiteJson').onclick = ()=>{ if(!suiteResults.length) return; downloadBlob(JSON.stringify({meta:{at:new Date().toISOString()},results:suiteResults},null,2),'bench-suite.json'); };

  // auto-connect & fetch on load
  connect().then(fetchLive);
}

window.addEventListener('DOMContentLoaded', wire);
</script>
</body>
</html>
