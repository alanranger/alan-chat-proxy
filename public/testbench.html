<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bench Test — single file</title>
<style>
  :root{
    --bg:#0f1420;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--warn:#f59e0b;--bad:#ef4444;--chip:#1f2937;--line:#1f2937
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
  .col{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:12px}
  h2{margin:0 0 6px;font-size:13px;color:#cbd5e1;font-weight:700;text-transform:uppercase;letter-spacing:.06em}
  label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
  input[type=text]{width:100%;background:#0b1020;border:1px solid #273144;color:var(--text);padding:8px;border-radius:8px}
  .row{display:flex;gap:8px;align-items:center}
  button{background:#1f2937;border:1px solid #2b364a;color:#d1d5db;padding:8px 10px;border-radius:8px;cursor:pointer}
  button.primary{background:#2563eb;border-color:#1d4ed8}
  button.good{background:#065f46;border-color:#047857}
  button.warn{background:#78350f;border-color:#9a3412}
  button.bad{background:#7f1d1d;border-color:#991b1b}
  button:disabled{opacity:.55;cursor:not-allowed}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #273144;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:12px}
  .scroller{height:200px;overflow:auto;border:1px solid var(--line);border-radius:8px;background:#0b1020;padding:8px}
  pre{white-space:pre-wrap;word-break:break-word;font-size:12px}
  .list{height:160px;overflow:auto;border:1px solid var(--line);border-radius:8px;background:#0b1020;padding:6px}
  .chip{display:inline-block;background:var(--chip);border:1px solid #273144;border-radius:999px;padding:4px 8px;margin:3px 6px 0 0;font-size:12px}
  .stat{font-size:12px;color:var(--muted)}
  .stat b{color:#e2e8f0}
  .hr{height:1px;background:var(--line);margin:10px 0}
  .conf{font-weight:700}
  .right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
  .k{color:#93c5fd} .v{color:#bbf7d0}
</style>
</head>
<body>
<div class="wrap">
  <!-- LEFT: Controls -->
  <div class="col">
    <h2>Step 0 · Connect to Supabase</h2>
    <label>Supabase URL</label>
    <input id="sbUrl" type="text" />
    <label>Supabase ANON key</label>
    <input id="sbKey" type="text" />
    <div class="row" style="margin-top:8px">
      <div style="flex:1">
        <label>Events view</label>
        <input id="eventsView" type="text" />
      </div>
      <div style="flex:1">
        <label>Products view</label>
        <input id="productsView" type="text" />
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnFetch" class="primary">Fetch live data</button>
      <span class="stat" id="liveStat">…</span>
    </div>

    <div class="hr"></div>
    <h2>Step 1 (optional) · Landing Pages CSV (fallback)</h2>
    <label>Upload CSV (columns: <code class="k">url</code> + one of <code class="k">url_meta_title</code> | <code class="k">meta_title</code> | <code class="k">title</code>)</label>
    <div class="row">
      <input type="file" id="landingCsv" accept=".csv" />
      <button id="btnLoadLanding">Upload</button>
    </div>
    <div class="stat" id="landingStat">not loaded</div>

    <div class="hr"></div>
    <h2>Step 2 · Questions CSV</h2>
    <label>Upload CSV (columns: <code class="k">idx</code>, <code class="k">query</code>, <code class="k">expected</code>)</label>
    <div class="row">
      <input type="file" id="questionsCsv" accept=".csv" />
      <button id="btnLoadQuestions">Upload</button>
      <button id="btnRunSuite">Run CSV Test Suite</button>
    </div>
    <div class="stat" id="questionsStat">not loaded</div>

    <div class="hr"></div>
    <h2>Step 3 · Try a single query</h2>
    <input id="singleQuery" type="text" placeholder="e.g. ‘when is the next devon workshop?’" />
    <div class="row" style="margin-top:8px">
      <button id="btnRun" class="good">Run</button>
      <button id="btnCopyLast">Copy Last Result</button>
    </div>

    <div class="hr"></div>
    <h2>Diagnostics & Export</h2>
    <div class="row">
      <button id="btnCopyBundle" class="warn">Copy Full Diagnostic Bundle</button>
      <button id="btnDownloadBundle" class="warn">Download Bundle</button>
    </div>
    <div class="row" style="margin-top:6px">
      <label><input type="checkbox" id="flagFallback" checked /> Use Landing CSV fallback when direct matches are weak</label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="flagGeneric" /> Enable generic search pills (placeholder)</label>
    </div>

    <div class="hr"></div>
    <div class="grid3">
      <div class="stat">Intent<br><b id="intentStat">—</b></div>
      <div class="stat">Reason<br><b id="reasonStat">—</b></div>
      <div class="stat">Confidence<br><b class="conf" id="confStat">0%</b></div>
    </div>
    <div class="hr"></div>
    <div class="grid3">
      <div class="stat">Landing CSV<br><b id="landingCount">0 rows</b></div>
      <div class="stat">Events<br><b id="eventsCount">0 rows</b></div>
      <div class="stat">Products<br><b id="productsCount">0 rows</b></div>
    </div>
    <div class="grid3" style="margin-top:8px">
      <div class="stat">Questions CSV<br><b id="questionsCount">0 rows</b></div>
      <div class="stat">Suite Progress<br><b id="suiteProgress">0 / 0</b></div>
      <div class="stat">Pass Rate<br><b id="suiteRate">—</b></div>
    </div>
  </div>

  <!-- RIGHT: Results -->
  <div class="col">
    <div class="right">
      <span class="stat">Hover the tags for a breakdown</span>
    </div>
    <div class="grid3" style="margin-top:6px">
      <div>
        <h2>Events <span class="stat" id="eventsShown"></span></h2>
        <div id="eventsList" class="list"></div>
      </div>
      <div>
        <h2>Articles</h2>
        <div id="articlesList" class="list"></div>
      </div>
      <div>
        <h2>Pills</h2>
        <div id="pillsList" class="list"></div>
      </div>
    </div>

    <div class="hr"></div>
    <h2>JSON</h2>
    <div class="scroller"><pre id="jsonOut">[]</pre></div>

    <div class="hr"></div>
    <h2>Execution Log</h2>
    <div class="scroller" style="height:220px"><pre id="execLog"></pre></div>
  </div>
</div>

<script>
/* ------------------- Config (prefilled) ------------------- */
const PREFILL = {
  supabaseUrl: "https://igzvwbvgvmzvvzoclufx.supabase.co",
  anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnenZ3YnZndm16dnZ6b2NsdWZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2Nzc5MjgsImV4cCI6MjA3MzI1MzkyOH0.A9TCmnXKJhDRYBkrO0mAMPiUQeV9enweeyRWKWQ1SZY",
  eventsView: "ai_events",
  productsView: "ai_products"
};
const APP_VERSION = "benchtest/1.7";

/* ------------------- State ------------------- */
const ST = {
  supabaseUrl: "", anonKey: "", eventsView:"", productsView:"",
  events: [], products: [], landingRows: [], questions: [],
  lastResult: null, suiteResults: [], exec: [],
  flags: { fallback:true, generic:false }
};

/* ------------------- Utils ------------------- */
const $ = sel => document.querySelector(sel);
function mask(s){ if(!s) return ""; if(s.length<=12) return s[0]+"…"+s.slice(-1); return s.slice(0,6)+"…"+s.slice(-6); }
function log(line){ const ts=new Date().toTimeString().slice(0,8); ST.exec.push(ts+"  "+line); $("#execLog").textContent = ST.exec.slice(-500).join("\n"); }
function setCounts(){
  $("#eventsCount").textContent   = ST.events.length+" rows";
  $("#productsCount").textContent = ST.products.length+" rows";
  $("#landingCount").textContent  = ST.landingRows.length+" rows";
  $("#questionsCount").textContent= ST.questions.length+" rows";
}
function copy(text){
  navigator.clipboard.writeText(text).then(()=>log("Copied JSON."),()=>alert("Clipboard copy failed"));
}
function download(filename, text){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text],{type:"application/json"}));
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}
function csvToRows(text){
  const lines = text.replace(/\r/g,"").split("\n").filter(Boolean);
  const hdr = lines.shift().split(",").map(s=>s.trim());
  return lines.map(line=>{
    const vals = []; let cur=""; let q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c=='"'){ if(q && line[i+1]=='"'){cur+='"';i++;} else q=!q; }
      else if(c==',' && !q){ vals.push(cur); cur=""; }
      else cur+=c;
    }
    vals.push(cur);
    const row={}; hdr.forEach((h,idx)=>row[h]=vals[idx]??"");
    return row;
  });
}

/* ------------------- Supabase fetch (REST) ------------------- */
async function sbFetch(view){
  const url = `${ST.supabaseUrl}/rest/v1/${encodeURIComponent(view)}?select=*`;
  const res = await fetch(url,{headers:{
    apikey: ST.anonKey,
    Authorization: "Bearer "+ST.anonKey
  }});
  if(!res.ok) throw new Error(`Fetch ${view} failed: ${res.status}`);
  return await res.json();
}

/* ------------------- Renderers ------------------- */
function renderLists(){
  const ev = ST.events.slice(0,30).map(e=>`<div class="chip" title="${e.url||""}">${e.title||"(no title)"}</div>`).join("");
  const ar = (ST.lastResult?.articles||[]).slice(0,30).map(a=>`<div class="chip" title="${a.url}">${a.title}</div>`).join("");
  const pl = (ST.lastResult?.pills||[]).slice(0,30).map(p=>`<div class="chip" title="${p.url}">${p.label}${p.brand?" ⭐":""}</div>`).join("");
  $("#eventsList").innerHTML = ev || `<div class="stat">no events</div>`;
  $("#articlesList").innerHTML = ar || `<div class="stat">no articles</div>`;
  $("#pillsList").innerHTML = pl || `<div class="stat">—</div>`;
  $("#eventsShown").textContent = ST.events.length ? `${Math.min(30,ST.events.length)} shown` : "";
}
function renderLastResult(){
  if(!ST.lastResult){ $("#jsonOut").textContent="[]"; return;}
  $("#jsonOut").textContent = JSON.stringify(ST.lastResult,null,2);
  $("#intentStat").textContent = ST.lastResult.detected || "—";
  $("#reasonStat").textContent = ST.lastResult.reason || "—";
  $("#confStat").textContent = (ST.lastResult.confidence ?? 0)+"%";
  renderLists();
}

/* ------------------- Dumb intent + selection (bench only) ------------------- */
/* This is intentionally simple – we just want predictable diagnostics */
function detectIntent(q){
  const s=(q||"").toLowerCase();
  if(!s.trim()) return {intent:"advice", reason:"empty query → advice", conf:43};
  if(s.includes("next")||s.includes("when")||s.includes("date")||s.includes("where")) return {intent:"events",reason:"temporal/where words",conf:88};
  if(s.includes("price")||s.includes("cost")) return {intent:"advice",reason:"pricing intent",conf:76};
  return {intent:"advice",reason:"default",conf:60};
}
function chooseFromData(intent,q){
  const out = {events:[], articles:[], pills:[]};
  if(intent==="events"){
    // dumb match using words in title
    const words = (q||"").toLowerCase().split(/\W+/).filter(Boolean);
    const hits = ST.events.filter(e=>{
      const t=(e.title||"").toLowerCase();
      return words.some(w=>t.includes(w));
    }).slice(0,3);
    out.events = hits.map(e=>({title:e.title, url:e.url, when:e.when??null, location:e.location??""}));
    if(out.events.length===0 && ST.flags.fallback){
      out.pills.push({label:"Event Listing", url:"https://www.alanranger.com/search?query=workshops", brand:true});
    }
  }else{
    // advice → no events; provide a brand pill
    out.pills.push({label:"Event Listing", url:"https://www.alanranger.com/search?query=workshops", brand:true});
    // lightweight "articles" demo: pick first 6 product titles as stand-ins
    out.articles = ST.products.slice(0,6).map(p=>({title:p.title||"(untitled)", url:p.url||"#"}));
  }
  return out;
}

/* ------------------- Single run ------------------- */
function runSingle(query){
  const {intent,reason,conf} = detectIntent(query);
  const pick = chooseFromData(intent, query);

  const result = {
    idx: 1,
    query,
    expected: intent,      // bench only
    detected: intent,
    reason,
    counts: {
      events: pick.events.length,
      articles: pick.articles.length,
      pills: pick.pills.length
    },
    pass: true,
    used: {
      intent,
      product: null,
      events: pick.events,
      articles: pick.articles,
      pills: pick.pills,
      citations: (pick.articles||[]).map(a=>a.url)
    },
    confidence: conf
  };
  ST.lastResult = result;
  renderLastResult();
  $("#intentStat").textContent=intent;
  $("#reasonStat").textContent=reason;
  $("#confStat").textContent=conf+"%";
}

/* ------------------- CSV test suite ------------------- */
async function runSuite(){
  if(!ST.questions.length){ alert("Load Questions CSV first"); return;}
  const out = []; let passed=0;
  for(const row of ST.questions){
    const q = row.query||"";
    const expected = (row.expected||"").trim().toLowerCase();
    const det = detectIntent(q);
    const pick = chooseFromData(det.intent,q);
    const res = {
      idx: +row.idx || out.length+1,
      query: q,
      expected,
      detected: det.intent,
      counts: { events: pick.events.length, articles: pick.articles.length, pills: pick.pills.length },
      pass: expected ? expected===det.intent : true,
      used: {
        intent: det.intent,
        product: null,
        events: pick.events,
        articles: pick.articles,
        pills: pick.pills,
        citations: (pick.articles||[]).map(a=>a.url)
      },
      confidence: det.conf
    };
    if(res.pass) passed++;
    out.push(res);
  }
  ST.suiteResults = out;
  $("#suiteProgress").textContent = `${out.length} / ${ST.questions.length}`;
  $("#suiteRate").textContent = `${Math.round((passed/out.length||0)*100)}%`;
  $("#jsonOut").textContent = JSON.stringify(out,null,2);
  log(`Suite finished. Passed ${passed}/${out.length}.`);
}

/* ------------------- Bundle export ------------------- */
function buildBundle(){
  const bundle = {
    meta: {
      version: APP_VERSION,
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent
    },
    environment: {
      supabase_url: ST.supabaseUrl,
      supabase_anon_key_redacted: mask(ST.anonKey),
      events_view: ST.eventsView,
      products_view: ST.productsView,
      flags: ST.flags
    },
    datasets: {
      live: {
        events_count: ST.events.length,
        products_count: ST.products.length,
        events_sample: ST.events.slice(0,10),
        products_sample: ST.products.slice(0,10)
      },
      landing_csv: {
        rows_total: ST.landingRows.length,
        sample: ST.landingRows.slice(0,10)
      },
      questions_csv: {
        rows_total: ST.questions.length,
        rows: ST.questions   // these are small; include all for clarity
      }
    },
    last_single_run: ST.lastResult,
    last_suite_run: {
      total: ST.suiteResults.length,
      results: ST.suiteResults
    },
    execution_log: ST.exec.slice(-500),
    errors: window.__benchErrors||[]
  };
  return bundle;
}

/* ------------------- Wire UI ------------------- */
window.addEventListener("error", e=>{
  window.__benchErrors = window.__benchErrors||[];
  window.__benchErrors.push({message:e.message, source:e.filename, line:e.lineno, col:e.colno});
});

function prefill(){
  $("#sbUrl").value = PREFILL.supabaseUrl;
  $("#sbKey").value = PREFILL.anonKey;
  $("#eventsView").value = PREFILL.eventsView;
  $("#productsView").value = PREFILL.productsView;

  ST.supabaseUrl = PREFILL.supabaseUrl;
  ST.anonKey = PREFILL.anonKey;
  ST.eventsView = PREFILL.eventsView;
  ST.productsView = PREFILL.productsView;

  log("Boot OK. Prefilled Supabase creds and requested live fetch.");
  $("#btnFetch").click();
}

$("#btnFetch").onclick = async ()=>{
  try{
    ST.supabaseUrl = $("#sbUrl").value.trim();
    ST.anonKey = $("#sbKey").value.trim();
    ST.eventsView = $("#eventsView").value.trim();
    ST.productsView = $("#productsView").value.trim();
    log("Saved Supabase credentials.");

    const [events, products] = await Promise.all([
      sbFetch(ST.eventsView),
      sbFetch(ST.productsView)
    ]);
    ST.events = events || [];
    ST.products = products || [];
    setCounts();
    $("#liveStat").textContent = `Connected`;
    log(`Fetched live data: events=${ST.events.length}, products=${ST.products.length}`);
    renderLists();
  }catch(err){
    $("#liveStat").textContent = `Error`;
    log("Fetch error: "+err.message);
    alert(err.message);
  }
};

$("#btnLoadLanding").onclick = async ()=>{
  const file = $("#landingCsv").files[0]; if(!file) return;
  const text = await file.text();
  ST.landingRows = csvToRows(text);
  setCounts();
  $("#landingStat").textContent = `loaded ${ST.landingRows.length} rows`;
  log(`Landing CSV loaded (${ST.landingRows.length} rows).`);
};

$("#btnLoadQuestions").onclick = async ()=>{
  const file = $("#questionsCsv").files[0]; if(!file) return;
  const text = await file.text();
  ST.questions = csvToRows(text);
  setCounts();
  $("#questionsStat").textContent = `loaded ${ST.questions.length} rows`;
  log(`Questions CSV loaded (${ST.questions.length} rows).`);
};

$("#btnRun").onclick = ()=>{
  const q = $("#singleQuery").value;
  runSingle(q);
  log(`Run: ${JSON.stringify(q)} → intent=${ST.lastResult.detected}, events=${ST.lastResult.counts.events}, articles=${ST.lastResult.counts.articles}, conf=${ST.lastResult.confidence}%`);
};

$("#btnRunSuite").onclick = runSuite;

$("#btnCopyLast").onclick = ()=>{
  copy(JSON.stringify(ST.lastResult??{},null,2));
};

$("#btnCopyBundle").onclick = ()=>{
  copy(JSON.stringify(buildBundle(),null,2));
};

$("#btnDownloadBundle").onclick = ()=>{
  const name = `benchtest-bundle-${new Date().toISOString().replace(/[:.]/g,'')}.json`;
  download(name, JSON.stringify(buildBundle(),null,2));
};

$("#flagFallback").onchange = e=>{ ST.flags.fallback = e.target.checked; };
$("#flagGeneric").onchange  = e=>{ ST.flags.generic  = e.target.checked; };

prefill(); // auto-start
</script>
</body>
</html>
