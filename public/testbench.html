<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bench Test — single-file (bench-only)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f131a; --panel:#141a22; --muted:#2b3442; --text:#e6ecf5; --sub:#a8b3c7;
      --brand:#f5a524; --accent:#69db7c; --amber:#ffb703; --danger:#ff6b6b; --chip:#1f2834;
      --blue:#74c0fc; --border:#1e2632;
      --radius:14px;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text); font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap{display:grid; grid-template-columns:320px 1fr; gap:18px; padding:18px; max-width:1400px; margin:0 auto;}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px;}
    h1{font-size:18px; margin:0 0 8px; display:flex; align-items:center; gap:10px}
    .tag{background:var(--chip); color:var(--sub); border:1px solid var(--border); padding:2px 8px; border-radius:999px; font-size:12px}
    .section-title{font-weight:600; color:#eaf2ff; margin:12px 0 8px}
    .help{color:var(--sub); font-size:12px; margin-top:4px}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    input[type="file"]{color:var(--sub)}
    input[type="text"], textarea{
      width:100%; background:#0c0f14; color:var(--text); border:1px solid var(--muted);
      border-radius:10px; padding:10px 12px; outline:none;
    }
    textarea{min-height:140px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; resize:vertical}
    .btn{
      border:1px solid var(--muted); background:#0c1016; color:var(--text);
      padding:8px 12px; border-radius:10px; cursor:pointer; transition:all .15s ease; font-weight:600;
    }
    .btn:hover{transform:translateY(-1px); border-color:#3a465a}
    .btn:disabled{opacity:.45; cursor:not-allowed}
    .btn-green{background:#112418; border-color:#21422a}
    .btn-green:hover{background:#14301f}
    .btn-amber{background:#3a2c12; border-color:#6a4b18}
    .btn-amber:hover{background:#453313}
    .btn-ghost{background:#0c1016}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; background:var(--chip); border:1px solid var(--border); border-radius:999px; font-size:12px; color:#b7c4d6; margin-right:6px; margin-bottom:6px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .grid-3{display:grid; grid-template-columns:1.2fr 1fr 1fr; gap:12px}
    .list{display:flex; flex-direction:column; gap:8px}
    .event{border:1px solid var(--muted); border-radius:12px; padding:10px 12px; background:#0b0f15}
    .event .title{font-weight:700}
    .event .meta{color:var(--sub); font-size:12px}
    .article a{color:var(--blue); text-decoration:none}
    .article{padding:8px 10px; border:1px dashed var(--muted); border-radius:10px}
    .product{border:1px solid #2a374a; background:#0a1119; border-radius:14px; padding:12px}
    .product h3{margin:0 0 6px}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#122337; color:#9ed0ff; font-size:12px; border:1px solid #234664}
    .conf{display:inline-flex; align-items:center; gap:8px}
    .conf .num{font-weight:800; font-size:18px}
    .muted{color:var(--sub)}
    details{border:1px dashed var(--muted); border-radius:10px; padding:10px 12px}
    details > summary{cursor:pointer; color:#cdd7e5; font-weight:600}
    pre{white-space:pre-wrap; word-break:break-word; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#0c0f14; padding:10px 12px; border-radius:10px; border:1px solid var(--muted); max-height:340px; overflow:auto}
    small{color:var(--sub)}
    .right h2{margin:0 0 8px; font-size:16px}
    .status{display:grid; gap:8px; grid-template-columns:1fr 1fr}
    .status .box{background:#0c0f14; border:1px solid var(--muted); padding:8px 10px; border-radius:10px; min-height:44px}
    .status .k{color:#86a2c8; font-size:12px}
    .status .v{font-weight:700}
    .hr{height:1px; background:var(--border); margin:12px 0}
    .sticky{position:sticky; top:18px}
    .warn{color:#ffe066}
    .err{color:#ffa8a8}
    .ok{color:#8ce99a}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT -->
    <div class="card sticky">
      <h1>Bench Test <span class="tag">single-file · bench-only</span></h1>

      <div class="section-title">Step 1 (optional): Upload <em>Landing Pages CSV</em></div>
      <div class="help">Use when direct matches are weak. <br/>CSV columns accepted: <code>url</code> and one of <code>title</code> | <code>meta_title</code>. Extra columns ignored.</div>
      <div class="row" style="margin-top:6px;">
        <input id="landingFile" type="file" accept=".csv" />
        <button class="btn btn-ghost" id="btnLoadLanding">Upload Landing CSV</button>
      </div>

      <div class="section-title">Step 2: Upload your <em>Events snapshot</em> (CSV or JSON)</div>
      <div class="help">Required for Events & Product block. CSV columns accepted: <code>date|when</code>, <code>title</code>, <code>location</code>, <code>url</code>, optional <code>price</code>, <code>tags</code>, <code>includes</code>.</div>
      <div class="row" style="margin-top:6px;">
        <input id="eventsFile" type="file" accept=".csv,.json" />
        <button class="btn btn-ghost" id="btnLoadEvents">Upload Events</button>
      </div>

      <div class="section-title">Step 3: Upload your <em>Questions CSV</em> (~15 rows)</div>
      <div class="help">Columns used: <code>idx</code>, <code>query</code>, <code>expected</code>. Extra columns ignored.</div>
      <div class="row" style="margin-top:6px;">
        <input id="qFile" type="file" accept=".csv" />
        <button class="btn btn-ghost" id="btnLoadQ">Upload Questions CSV</button>
        <button class="btn btn-amber" id="btnRunSuite" title="Runs the uploaded Questions CSV and writes to the Execution Log.">Run CSV Test Suite</button>
      </div>

      <div class="section-title">Step 4: Try a single query</div>
      <input id="query" type="text" placeholder="Ask e.g. ‘when is the next devon workshop?’" />
      <div class="row" style="margin-top:8px;">
        <button class="btn btn-green" id="btnRun">Run</button>
        <button class="btn" id="btnCopyJSON">Copy JSON</button>
      </div>

      <div class="hr"></div>

      <div class="row">
        <label class="row"><input id="chkUseLanding" type="checkbox" checked/> <span class="help">Use Landing CSV fallback when direct matches are weak</span></label>
      </div>
      <div class="row">
        <label class="row"><input id="chkGenericPills" type="checkbox" /> <span class="help">Enable generic search pills (for future integration)</span></label>
      </div>

      <div class="hr"></div>

      <div class="status">
        <div class="box"><div class="k">Intent</div><div class="v" id="stIntent">—</div></div>
        <div class="box"><div class="k">Reason</div><div class="v" id="stReason">—</div></div>
        <div class="box"><div class="k">Landing CSV</div><div class="v" id="stLanding">not loaded</div></div>
        <div class="box"><div class="k">Events</div><div class="v" id="stEvents">not loaded</div></div>
        <div class="box"><div class="k">Questions CSV</div><div class="v" id="stQ">not loaded</div></div>
        <div class="box"><div class="k">CSV Progress</div><div class="v" id="stProg">0 / 0</div></div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn" id="btnCopyLog">Copy Log</button>
        <button class="btn" id="btnDownloadLog">Download Log</button>
        <button class="btn" id="btnCopyFailures">Copy Failures (CSV)</button>
        <button class="btn" id="btnCopyAllJSON">Copy All Results (JSON)</button>
      </div>

      <div class="help" style="margin-top:8px">Single query results appear on the right (Product / Events / Articles / Pills). CSV suite results go to the JSON + Execution Log.</div>
    </div>

    <!-- RIGHT -->
    <div class="right card">
      <div class="row" style="justify-content:space-between; align-items:flex-start">
        <div class="conf" title="Overall confidence in the assembled answer. Hover chips below for breakdown.">
          <span class="muted">Confidence:</span>
          <span class="num" id="confNum">—%</span>
        </div>
        <div id="confBreak"></div>
      </div>

      <div id="productBlock" class="product" style="display:none; margin-top:10px">
        <h3 id="prodTitle">Product</h3>
        <div class="row" style="gap:12px; flex-wrap:wrap">
          <span class="badge" id="prodPrice">Price: —</span>
          <span class="badge" id="prodNext">Next date: —</span>
          <span class="badge" id="prodLoc">Location: —</span>
          <span class="badge" id="prodIncludes">Includes: —</span>
        </div>
        <div class="help" id="prodSource" style="margin-top:6px"></div>
      </div>

      <div class="grid-3" style="margin-top:12px">
        <div>
          <h2>Events</h2>
          <div class="list" id="eventsList"></div>
        </div>
        <div>
          <h2>Articles</h2>
          <div class="list" id="articlesList"></div>
        </div>
        <div>
          <h2>Pills</h2>
          <div id="pillsList"></div>
        </div>
      </div>

      <div style="margin-top:12px">
        <h2>JSON</h2>
        <textarea id="jsonOut" readonly>[]</textarea>
      </div>

      <div style="margin-top:12px">
        <h2>Execution Log</h2>
        <details open>
          <summary>Click to expand / collapse</summary>
          <pre id="log"></pre>
        </details>
      </div>
    </div>
  </div>

  <script>
/* ---------------------- tiny utils ---------------------- */
const $ = (id)=>document.getElementById(id);
const logEl = $("log");
const writeLog = (msg)=>{ const ts=new Date().toISOString().replace('T',' ').replace('Z',''); logEl.textContent += `[${ts}] ${msg}\n`; logEl.scrollTop = logEl.scrollHeight; };
const copyText = async (s)=>{ await navigator.clipboard.writeText(s); };
const download = (name, text)=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text], {type:'text/plain'})); a.download=name; a.click(); URL.revokeObjectURL(a.href); };

function parseCSV(text){
  // small, robust-enough CSV parser (supports quoted fields, commas, CRLF)
  const rows = [];
  let row = [], i=0, cur='', inQ=false;
  while(i<text.length){
    const ch = text[i];
    if(inQ){
      if(ch === '"'){
        if(text[i+1] === '"'){ cur+='"'; i+=2; continue; }
        inQ = false; i++; continue;
      } else { cur += ch; i++; continue; }
    }else{
      if(ch === '"'){ inQ = true; i++; continue; }
      if(ch === ',' ){ row.push(cur); cur=''; i++; continue; }
      if(ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=''; i++; continue; }
      if(ch === '\r'){ i++; continue; }
      cur+=ch; i++; continue;
    }
  }
  row.push(cur); rows.push(row);
  // header map
  const header = rows.shift().map(h=>h.trim().toLowerCase());
  return rows.filter(r=>r.length>1 || (r.length===1 && r[0].trim()!=='')).map(r=>{
    const obj={};
    header.forEach((h,idx)=> obj[h] = (r[idx]??'').trim());
    return obj;
  });
}

function tokenize(s){
  return (s||'').toLowerCase()
   .replace(/[^a-z0-9\s\-&\/]/g,' ')
   .split(/\s+/)
   .filter(Boolean);
}
function scoreTokens(queryTokens, text){
  const tt = tokenize(text);
  let hits=0;
  for(const t of queryTokens) if(tt.includes(t)) hits++;
  return hits / Math.max(1, queryTokens.length);
}
function normTitle(t){
  if(!t) return '';
  return t.replace(/\s+\|\s*[\s\S]*$/,'').replace(/\s+-\s*[\d/|-]+$/,'').trim();
}
function isResidentialEvent(ev){
  const tags = (ev.tags||'').toLowerCase();
  const inc = (ev.includes||'').toLowerCase();
  return tags.includes('residential') || inc.includes('b&b') || inc.includes('bed') || inc.includes('accommodation');
}

/* ---------------------- app state ---------------------- */
let landingPages = []; // [{url,title}]
let events = []; // [{date,when,title,location,url,price,tags,includes}]
let questions = []; // [{idx,query,expected}]
let lastSuiteResults = [];
let useLanding = true;
let enableGenericPills = false;

/* ---------------------- loaders ---------------------- */
$("btnLoadLanding").onclick = async ()=>{
  const f = $("landingFile").files[0];
  if(!f){ alert("Choose a Landing CSV"); return; }
  const text = await f.text();
  landingPages = parseCSV(text).map(r => ({
    url: r.url || '',
    title: r.title || r.meta_title || ''
  })).filter(r=>r.url);
  $("stLanding").textContent = `loaded ${landingPages.length} rows`;
  writeLog(`Loaded Landing CSV (${landingPages.length} rows)`);
  $("confBreak").innerHTML = `<span class="pill" title="Landing CSV loaded and will be used as fallback when direct matches are weak.">Landing CSV loaded</span>`;
};

$("btnLoadEvents").onclick = async ()=>{
  const f = $("eventsFile").files[0];
  if(!f){ alert("Choose an Events CSV/JSON"); return; }
  const text = await f.text();
  let rows = [];
  if(f.name.toLowerCase().endsWith(".json")){
    try { rows = JSON.parse(text); }
    catch{ alert("Invalid JSON"); return; }
  } else {
    rows = parseCSV(text);
  }
  // normalize
  events = rows.map(r=>{
    const date = r.when || r.date || '';
    return {
      when: date,
      date,
      title: r.title||'',
      location: r.location||'',
      url: r.url||'',
      price: r.price||'',
      tags: r.tags||'',
      includes: r.includes||''
    };
  }).filter(e=>e.title && e.url);
  $("stEvents").textContent = `loaded ${events.length} rows`;
  writeLog(`Loaded Events (${events.length} rows)`);
};

$("btnLoadQ").onclick = async ()=>{
  const f = $("qFile").files[0];
  if(!f){ alert("Choose a Questions CSV"); return; }
  const text = await f.text();
  const rows = parseCSV(text);
  questions = rows.map(r=>({ idx: r.idx || r.id || '', query: r.query || '', expected: (r.expected||'').toLowerCase() })).filter(r=>r.query);
  $("stQ").textContent = `loaded ${questions.length} rows`;
  $("stProg").textContent = `0 / ${questions.length}`;
  writeLog(`Loaded Questions CSV (${questions.length} rows)`);
};

$("chkUseLanding").onchange = (e)=>{ useLanding = e.target.checked; };
$("chkGenericPills").onchange = (e)=>{ enableGenericPills = e.target.checked; };

/* ---------------------- intent + reasoning ---------------------- */
function detectIntent(q){
  const t = tokenize(q);
  const hasWhen = t.includes('when')||t.includes('date')||t.includes('next')||t.includes('where')||t.includes('cost')||t.includes('price');
  const hasWorkshop = t.includes('workshop')||t.includes('workshops')||t.includes('event')||t.includes('events');
  const adviceLike = ['how','what','which','why','tips','do','need','recommend','should','can','is','are','certificate','free','laptop'].some(w=>t.includes(w));
  // rule: if asking explicit when/where/price with workshop/event → events
  if(hasWorkshop && (hasWhen || t.includes('next') || t.includes('where') || t.includes('cost') || t.includes('bluebell') || t.includes('devon'))) {
    return { intent:'events', reason:'events: date/where/price keywords with workshop terms' };
  }
  // advice if clearly explanatory
  if(adviceLike && !hasWhen) return { intent:'advice', reason:'advice: explanatory/requirement phrasing' };

  // fallback: token balance
  return (hasWorkshop) ? { intent:'events', reason:'events: workshop terms present'} : { intent:'advice', reason:'advice: general question' };
}

/* ---------------------- scoring + assembly ---------------------- */
function assembleAnswer(q){
  const {intent, reason} = detectIntent(q);
  $("stIntent").textContent = intent;
  $("stReason").textContent = reason;

  const qTokens = tokenize(q);

  let matchedEvents = [];
  let usedFallback = false;
  let product = null;
  let pills = [];
  let articles = [];

  // Match events
  if(events.length){
    const withScore = events.map(ev=>{
      const s = (
        scoreTokens(qTokens, ev.title + ' ' + ev.location) * 0.7 +
        scoreTokens(qTokens, ev.tags + ' ' + ev.includes) * 0.3
      );
      return {...ev, _score:s};
    }).sort((a,b)=>b._score-a._score);

    matchedEvents = withScore.filter(e=>e._score>0).slice(0,12);
    // if nothing decent, but user wants events → try fallback via landing pages keywords
    if(intent==='events' && matchedEvents.length===0 && useLanding && landingPages.length){
      usedFallback = true;
      // convert landing articles to pseudo-events link list (article block will also show them)
      articles = landingMatch(qTokens).slice(0,6);
    }
  }

  // Product stitching: choose top event cluster by normalized title
  if(matchedEvents.length){
    const top = matchedEvents[0];
    const clusterKey = normTitle(top.title).toLowerCase();
    const cluster = matchedEvents.filter(e=>normTitle(e.title).toLowerCase()===clusterKey);
    const price = cluster.find(e=>e.price)?.price || top.price || '';
    const nextDate = cluster[0]?.when || top.when || '';
    const loc = cluster[0]?.location || top.location || '';
    // Residential claims are source-driven only
    const includesEvidence = gatherResidentialEvidence(cluster, landingPages);
    product = {
      title: clusterKey || top.title,
      price: price || '—',
      next: nextDate || '—',
      location: loc || '—',
      includes: includesEvidence.text,
      includeSources: includesEvidence.sources,
      url: top.url
    };
  }

  // Articles (landing pages) as fallback / supporting material
  if(!articles.length && landingPages.length){
    articles = landingMatch(qTokens).slice(0,6);
  }

  // Pills (CTAs)
  pills = buildPills(intent, matchedEvents, qTokens, product);

  // Confidence
  const conf = computeConfidence({intent, matchedEvents, articles, usedFallback});

  return {
    intent, reason,
    events: matchedEvents,
    product, pills, articles,
    confidence: conf.value,
    confidenceParts: conf.parts,
    fallbackUsed: usedFallback
  };
}

function landingMatch(qTokens){
  const scored = landingPages.map(p=>{
    const s = scoreTokens(qTokens, p.title + ' ' + p.url);
    return {...p, _score:s};
  }).sort((a,b)=>b._score-a._score);
  return scored.filter(p=>p._score>0).map(p=>({title:p.title||p.url, url:p.url, _score:p._score}));
}

function gatherResidentialEvidence(evCluster, pages){
  const sources = [];
  let includes = '';
  for(const ev of evCluster){
    const inc = (ev.includes||'').toLowerCase();
    if(inc.includes('b&b')||inc.includes('bed')||inc.includes('accommodation')||inc.includes('travel')){
      includes = 'B&B + local travel (from Events data)';
      sources.push(ev.url);
      break;
    }
  }
  if(!includes && pages && pages.length){
    // look for landing titles mentioning residential, b&b, accommodation, travel
    const hit = pages.find(p=>{
      const t=(p.title||'').toLowerCase();
      return t.includes('residential')||t.includes('b&b')||t.includes('accommodation');
    });
    if(hit){ includes='B&B included (from Landing pages)'; sources.push(hit.url); }
  }
  if(!includes) includes = 'Not found in sources';
  return {text:includes, sources};
}

function buildPills(intent, events, qTokens, product){
  const pills = [];
  if(intent==='events' && events.length){
    pills.push({label:'Book Now', url: events[0].url, brand:true});
  }
  // Always provide a listing/search link (static suggestion)
  pills.push({label:'Event Listing', url:'https://www.alanranger.com/search?query=workshops', brand:true});
  if(enableGenericPills){
    pills.push({label:'More Events', url:'https://www.alanranger.com/search?query=workshops', brand:true});
    pills.push({label:'Photos', url:'https://www.alanranger.com/gallery-image-portfolios', brand:false});
  }
  return pills;
}

function computeConfidence({intent, matchedEvents, articles, usedFallback}){
  const parts = [];
  // Intent certainty
  const intentScore = (intent==='events'||intent==='advice') ? 0.8 : 0.5;
  parts.push({label:'Intent', val:intentScore, tip:'Heuristic classification based on keywords and phrasing.'});

  // Content support
  const eventScore = matchedEvents.length ? Math.min(1, matchedEvents[0]._score + (matchedEvents[1]?matchedEvents[1]._score*0.5:0)) : 0;
  parts.push({label:'Events match', val:eventScore, tip: matchedEvents.length ? `Top event score=${matchedEvents[0]._score.toFixed(2)}` : 'No event match' });

  // Articles support
  const articleScore = articles.length ? Math.min(0.6, articles[0]._score || 0.3) : 0;
  parts.push({label:'Articles support', val:articleScore, tip: articles.length ? `Top article score=${(articles[0]._score||0).toFixed(2)}` : 'No landing article support' });

  // Fallback penalty
  const penalty = usedFallback ? 0.15 : 0;
  parts.push({label:'Fallback penalty', val:-penalty, tip: usedFallback ? 'Landing fallback used because direct event match was weak' : 'No penalty' });

  const raw = intentScore + eventScore + articleScore - penalty;
  const clamped = Math.max(0, Math.min(1, raw));
  return { value: Math.round(clamped*100), parts };
}

/* ---------------------- UI binding ---------------------- */
function renderAnswer(ans){
  $("confNum").textContent = `${ans.confidence}%`;
  $("confBreak").innerHTML = ans.confidenceParts.map(p=>{
    const val = (p.val>=0?'+':'') + (Math.round(p.val*100)/100);
    return `<span class="pill" title="${p.tip}">${p.label}: ${val}</span>`;
  }).join(' ');

  // Product block
  if(ans.product){
    $("productBlock").style.display = '';
    $("prodTitle").textContent = ans.product.title || 'Product';
    $("prodPrice").textContent = `Price: ${ans.product.price||'—'}`;
    $("prodNext").textContent = `Next date: ${ans.product.next||'—'}`;
    $("prodLoc").textContent = `Location: ${ans.product.location||'—'}`;
    $("prodIncludes").textContent = `Includes: ${ans.product.includes}`;
    const src = ans.product.includeSources && ans.product.includeSources.length
      ? `Sources: ` + ans.product.includeSources.map(u=>`<a href="${u}" target="_blank">${u}</a>`).join(' · ')
      : `Sources: none`;
    $("prodSource").innerHTML = src + `<br><small class="muted">Note: Residential inclusion claims are shown only when found in uploaded sources.</small>`;
  } else {
    $("productBlock").style.display = 'none';
  }

  // Events
  const evEl = $("eventsList");
  evEl.innerHTML = '';
  if(ans.events.length){
    ans.events.forEach(ev=>{
      const div = document.createElement('div');
      div.className = 'event';
      div.innerHTML = `
        <div class="title">${ev.title}</div>
        <div class="meta">${ev.when || ev.date || ''} — ${ev.location || ''}</div>
        <div class="meta"><a href="${ev.url}" target="_blank">${ev.url}</a></div>
      `;
      evEl.appendChild(div);
    });
  } else {
    evEl.innerHTML = `<div class="muted">No matching events (check Events snapshot or try different query).</div>`;
  }

  // Articles
  const artEl = $("articlesList");
  artEl.innerHTML = '';
  if(ans.articles.length){
    ans.articles.forEach(a=>{
      const div = document.createElement('div');
      div.className = 'article';
      div.innerHTML = `<a href="${a.url}" target="_blank">${a.title || a.url}</a>`;
      artEl.appendChild(div);
    });
  } else {
    artEl.innerHTML = `<div class="muted">No related landing articles.</div>`;
  }

  // Pills
  const pillEl = $("pillsList");
  pillEl.innerHTML = '';
  if(ans.pills.length){
    ans.pills.forEach(p=>{
      const a = document.createElement('a');
      a.className = 'pill';
      a.href = p.url; a.target = "_blank";
      a.textContent = p.label;
      pillEl.appendChild(a);
    });
  } else {
    pillEl.innerHTML = `<div class="muted">No pills.</div>`;
  }

  // JSON
  const json = {
    intent: ans.intent,
    reason: ans.reason,
    confidence: ans.confidence,
    product: ans.product,
    events: ans.events.map(({_score, ...e})=>e),
    articles: ans.articles,
    pills: ans.pills,
    fallbackUsed: ans.fallbackUsed
  };
  $("jsonOut").value = JSON.stringify(json, null, 2);
}

$("btnRun").onclick = ()=>{
  const q = $("query").value.trim();
  if(!q){ alert("Type a question to run."); return; }
  const ans = assembleAnswer(q);
  renderAnswer(ans);
  writeLog(`Single query run → intent=${ans.intent}, confidence=${ans.confidence}%, events=${ans.events.length}, articles=${ans.articles.length}, fallback=${ans.fallbackUsed}`);
};

$("btnCopyJSON").onclick = ()=> copyText($("jsonOut").value);

/* ---------------------- CSV test suite ---------------------- */
$("btnRunSuite").onclick = ()=>{
  if(!questions.length){ alert("Upload Questions CSV first."); return; }
  lastSuiteResults = [];
  let pass=0;
  $("stProg").textContent = `0 / ${questions.length}`;

  questions.forEach((row, idx)=>{
    const ans = assembleAnswer(row.query);
    const detected = ans.intent;
    const ok = detected === (row.expected||'').toLowerCase();
    if(ok) pass++;

    lastSuiteResults.push({
      idx: row.idx || (idx+1),
      query: row.query,
      expected: row.expected,
      detected,
      counts:{
        events: ans.events.length,
        articles: ans.articles.length,
        pills: ans.pills.length
      },
      pass: ok,
      used:{
        intent: ans.intent,
        product: ans.product ? {title: ans.product.title, url: ans.product.url} : null,
        events: ans.events.map(e=>({date:e.when||e.date, when:e.when||e.date, title:e.title, location:e.location, url:e.url})),
        articles: ans.articles.map(a=>({title:a.title, url:a.url})),
        pills: ans.pills,
        citations: [
          ...(ans.product?.includeSources||[]),
          ...ans.events.slice(0,12).map(e=>e.url),
          ...ans.articles.slice(0,8).map(a=>a.url)
        ].filter(Boolean)
      },
      confidence: ans.confidence
    });
    $("stProg").textContent = `${idx+1} / ${questions.length}`;
  });

  const total = lastSuiteResults.length;
  const passed = lastSuiteResults.filter(r=>r.pass).length;
  const rate = total ? Math.round((passed/total)*100) : 0;

  writeLog(`CSV suite finished: ${passed}/${total} passed (${rate}%).`);
  $("jsonOut").value = JSON.stringify({
    total, passed, rate: rate+"%", results: lastSuiteResults
  }, null, 2);

  // Clear right panels (suite results live in JSON/Log by design)
  $("eventsList").innerHTML = `<div class="muted">CSV suite run complete — see JSON & Execution Log.</div>`;
  $("articlesList").innerHTML = `<div class="muted">CSV suite run complete — see JSON & Execution Log.</div>`;
  $("pillsList").innerHTML = `<div class="muted">CSV suite run complete — see JSON & Execution Log.</div>`;
  $("productBlock").style.display = 'none';
};

/* --------- log & export helpers ---------- */
$("btnCopyLog").onclick = ()=> copyText(logEl.textContent);
$("btnDownloadLog").onclick = ()=> download('bench-execution-log.txt', logEl.textContent);
$("btnCopyFailures").onclick = ()=>{
  if(!lastSuiteResults.length){ alert("Run CSV Test Suite first."); return; }
  const fails = lastSuiteResults.filter(r=>!r.pass);
  const header = "idx,query,expected,detected,confidence,events,articles,pills";
  const rows = fails.map(r=>[
    r.idx, `"${r.query.replace(/"/g,'""')}"`, r.expected, r.detected, r.confidence,
    r.counts.events, r.counts.articles, r.counts.pills
  ].join(','));
  copyText([header,...rows].join('\n'));
};
$("btnCopyAllJSON").onclick = ()=>{
  if(!lastSuiteResults.length){ alert("Run CSV Test Suite first."); return; }
  copyText(JSON.stringify(lastSuiteResults, null, 2));
};

/* ---------------------- Boot note ---------------------- */
writeLog("Ready. Load Events (CSV/JSON), Landing CSV (optional), Questions CSV, then Run query or CSV Suite.");
  </script>
</body>
</html>
