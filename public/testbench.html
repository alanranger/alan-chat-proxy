<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bench Test — single-file (bench-only)</title>
<style>
  :root{
    --bg:#0f1320; --panel:#171b2b; --ink:#e6ebff; --muted:#9aa3c7; --muted2:#6f78a6;
    --accent:#7bd88f; --accent-2:#ffd166; --danger:#ff6b6b; --chip:#22263a; --chip-border:#2c3250;
    --brand:#ffb703; --link:#85b7ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";}
  a{color:var(--link);text-decoration:none}
  .wrap{display:grid;grid-template-columns:340px 1fr;gap:16px;padding:16px;max-width:1400px;margin:0 auto}
  .card{background:var(--panel);border:1px solid #202541;border-radius:12px;padding:12px}
  h1{font-size:16px;margin:0 0 10px;display:flex;align-items:center;gap:10px}
  h2{font-size:13px;margin:0 0 8px;color:var(--muted)}
  .step{margin-bottom:14px}
  .help{font-size:12px;color:var(--muted);margin:6px 0 8px}
  input[type="file"]{width:100%}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:1px solid #2b3150;background:#1e2440;color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .btn--primary{background:linear-gradient(180deg,#1fbf74,#109d5c);border-color:#0d8a50}
  .btn--ghost{background:#181d33}
  .btn--danger{background:#40202a;border-color:#7a2a3a}
  .btn--brand{background:#3e2e00;border-color:#725300;color:#ffd166}
  .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--chip-border);padding:4px 8px;border-radius:999px;color:#c9cff2;font-size:12px;margin:0 6px 6px 0}
  .pill b{color:#fff}
  .pill--ok{border-color:#215a3a;background:#0f2a1c}
  .pill--warn{border-color:#5a4b21;background:#2a240f}
  .pill--brand{border-color:#6c5200;background:#2b2100;color:#ffd166}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .section{background:#12162a;border:1px solid #202541;border-radius:10px;min-height:80px}
  .section h3{margin:8px 10px;color:var(--muted)}
  .list{padding:2px 10px 10px}
  .item{padding:8px 0;border-top:1px solid #232a46}
  .item:first-child{border-top:none}
  .meta{color:var(--muted2);font-size:12px}
  .json{white-space:pre-wrap;background:#0b0e1b;border-top:1px solid #232a46;border-radius:0 0 10px 10px;padding:10px;color:#9fe3ff;overflow:auto;max-height:260px}
  .status{font-size:12px;color:var(--muted);display:grid;grid-template-columns: 1fr 60px;gap:8px;border-top:1px dashed #252a44;padding-top:10px;margin-top:10px}
  .bar{height:8px;border-radius:6px;background:#1a203a;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#7bd88f,#58d0ff);width:0%}
  .kv{display:flex;justify-content:space-between;border-top:1px solid #22284a;padding:6px 0}
  .toggle{display:flex;align-items:center;gap:8px;margin:6px 0}
  .muted{color:var(--muted)}
  .confidence{display:flex;align-items:center;gap:8px}
  .confidence .score{font-weight:700}
  .badge{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid #2b3150;background:#1a1f38;color:#c9cff2}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: controls -->
    <div class="card">
      <h1>Bench Test <span class="badge">single-file · bench-only</span></h1>

      <div class="step">
        <h2>Step 1 (optional): Upload <em>Landing Pages CSV</em></h2>
        <div class="help">Use when direct matches are weak. Columns accepted: <span class="mono">url</span> and one of <span class="mono">url_meta_title</span> | <span class="mono">meta_title</span> | <span class="mono">title</span>. Extra columns are ignored.</div>
        <div class="row">
          <input type="file" id="landingFile" accept=".csv" />
          <button id="btnLoadLanding" class="btn">Upload Landing CSV</button>
        </div>
      </div>

      <div class="step">
        <h2>Step 2: Upload your <em>Questions CSV</em> (≈15 rows)</h2>
        <div class="help">Columns used: <span class="mono">idx, query, expected</span>. Everything else is ignored.</div>
        <div class="row">
          <input type="file" id="questionsFile" accept=".csv" />
          <button id="btnLoadQuestions" class="btn">Upload Questions CSV</button>
          <button id="btnRunSuite" class="btn btn--brand" title="Run the uploaded CSV test suite">Run CSV Test Suite</button>
        </div>
      </div>

      <div class="step">
        <h2>Step 3: Try a single query</h2>
        <div class="row">
          <input id="q" type="text" placeholder="Ask e.g. ‘when is the next devon workshop?’" style="flex:1;padding:10px;border-radius:10px;border:1px solid #2b3150;background:#0d1122;color:#e6ebff" />
          <button id="btnRun" class="btn btn--primary">Run</button>
          <button id="btnCopyJson" class="btn btn--ghost" title="Copy last JSON">Copy JSON</button>
        </div>
      </div>

      <div class="step">
        <div class="toggle">
          <input type="checkbox" id="useLandingFallback" checked />
          <label for="useLandingFallback">Use Landing CSV fallback when direct matches are weak</label>
        </div>
        <div class="toggle">
          <input type="checkbox" id="enableGeneric" />
          <label for="enableGeneric">Enable generic search pills (for future integration)</label>
        </div>
      </div>

      <div class="status">
        <div>Intent</div><div id="statIntent" class="mono muted">—</div>
        <div>Reason</div><div id="statReason" class="mono muted">—</div>
        <div>Landing CSV</div><div id="statLanding" class="mono muted">not loaded</div>
        <div>Questions CSV</div><div id="statQuestions" class="mono muted">not loaded</div>
        <div>CSV Progress</div>
        <div>
          <div class="bar" title="CSV run progress"><span id="csvBar"></span></div>
          <div id="csvCounts" class="mono muted" style="margin-top:4px;text-align:right">0 / 0</div>
        </div>
      </div>
    </div>

    <!-- RIGHT: results -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="confidence" title="Confidence = normalized score from intent signals (keywords, phrasing, location tokens). Hover any pill below for details.">
          <span class="muted">Confidence:</span>
          <span id="confScore" class="score">—%</span>
        </div>
        <div id="metaPills" class="row"></div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div class="section" id="eventsBox">
          <h3>Events</h3>
          <div class="list" id="events"></div>
        </div>
        <div class="section" id="articlesBox">
          <h3>Articles</h3>
          <div class="list" id="articles"></div>
        </div>
      </div>

      <div class="section" style="margin-top:12px">
        <h3>Pills</h3>
        <div class="list" id="pills"></div>
      </div>

      <div class="section" style="margin-top:12px">
        <h3>JSON</h3>
        <div id="json" class="json">[]</div>
      </div>
    </div>
  </div>

<script>
/* ----------------------------- tiny utilities ---------------------------- */
const $ = (q) => document.querySelector(q);
const el = (tag, cls, txt) => { const n = document.createElement(tag); if(cls) n.className = cls; if(txt!=null) n.textContent = txt; return n; };
function toast(msg){ console.log(msg); }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function tokenize(s){ return (s||"").toLowerCase().replace(/[^a-z0-9\s\-]/g," ").split(/\s+/).filter(Boolean); }

/* Robust CSV (handles quotes/commas/newlines) */
function parseCSV(text){
  const rows = [];
  let i=0, field="", row=[], inQ=false;
  while(i<text.length){
    const c = text[i];
    if(inQ){
      if(c === '"'){
        if(text[i+1] === '"'){ field+='"'; i+=2; continue; }
        inQ = false; i++; continue;
      } else { field += c; i++; continue; }
    } else {
      if(c === '"'){ inQ = true; i++; continue; }
      if(c === ','){ row.push(field); field=""; i++; continue; }
      if(c === '\n'){ row.push(field); rows.push(row); row=[]; field=""; i++; continue; }
      if(c === '\r'){ i++; continue; }
      field += c; i++; continue;
    }
  }
  row.push(field); rows.push(row);
  // header map
  const header = rows.shift().map(h=>h.trim());
  return rows.filter(r => r.some(x=>String(x).trim()!=="")).map(r=>{
    const o={}; header.forEach((h,idx)=> o[h.toLowerCase()] = r[idx]??""); return o;
  });
}

/* ------------------------------- state ---------------------------------- */
const state = {
  landing: [],   // {url,title}
  questions: [], // {idx,query,expected}
  last: null,
  config: { useLandingFallback: true, enableGeneric: false }
};

function setBar(done,total){ $('#csvBar').style.width = (total? (done/total*100):0)+'%'; $('#csvCounts').textContent = `${done} / ${total}`; }

/* ------------------------- domain specific bits ------------------------- */
/* Very lightweight intent classifier + signal breakdown (bench-only)      */
function analyzeQuery(q){
  const tokens = tokenize(q);

  // signals
  const sig = { events:0, advice:0, notes:[] };

  // heuristics – transparent and editable
  const eventWords = ['workshop','date','when','where','next','devon','lake','district','peak','bluebell','batsford','cost','price','book','event'];
  const adviceWords = ['how','what','why','need','recommend','certificate','laptop','camera','tripod','do i need','can i','is it','include','b&b','bnb','residential','online'];

  tokens.forEach(t=>{
    if(eventWords.includes(t)){ sig.events+=2; sig.notes.push(`event:+2 “${t}”`); }
    if(adviceWords.includes(t)){ sig.advice+=2; sig.notes.push(`advice:+2 “${t}”`); }
  });

  // phrase boosts
  const phraseBoosts = [
    [/when.*(next|date)/i, 'event:+3 phrase “when…next/date”', {e:3}],
    [/(how|do i).*need/i, 'advice:+3 phrase “do I … need”', {a:3}],
    [/residential|b&b|bnb/i, 'advice-first route for residential/B&B', {a:3}],
  ];
  phraseBoosts.forEach(([re,label,delta])=>{
    if(re.test(q)){ if(delta.e) sig.events+=delta.e; if(delta.a) sig.advice+=delta.a; sig.notes.push(label); }
  });

  // choose intent
  const intent = (sig.events >= sig.advice) ? 'events' : 'advice';

  // confidence (0–100)
  const raw = Math.max(sig.events, sig.advice);
  const denom = sig.events + sig.advice || 1;
  let conf = clamp(Math.round((raw/denom)*80 + Math.min(20, raw*4)), 5, 99); // bounded & slightly optimistic for clear signals

  // construct minimal result scaffold
  const out = {
    intent,
    reason: `${intent === 'events' ? 'events' : 'advice'}=${sig[intent]}, ${intent==='events'?'advice':'events'}=${sig[intent==='events'?'advice':'events']}`,
    confidence: conf,
    used: { intent, product:null, events:[], articles:[], pills:[], citations:[] },
    counts: { events:0, articles:0, pills:0 },
    pass: null // only set during CSV suite
  };

  // simple pills to show what kicked in
  metaPill(`Advice ranking w/ phrase boost`, 'ok', sig.advice>0 || sig.events>0);
  if(state.config.enableGeneric) metaPill(`Generic search pills: enabled`, '', true);
  if(state.landing.length) metaPill(`Landing CSV loaded`, '', true);

  // fallback: surface landing pages by token overlap
  const landingMatches = (function(){
    if(!state.landing.length) return [];
    const qset = new Set(tokens);
    const scored = state.landing.map(lp=>{
      const titleTokens = tokenize(lp.title||"");
      const overlap = titleTokens.filter(t=>qset.has(t)).length;
      const score = overlap + (lp.title||"").toLowerCase().includes('workshop') ? 1 : 0;
      return {...lp, score};
    }).filter(x=>x.score>0).sort((a,b)=>b.score-a.score).slice(0,6);
    return scored;
  })();

  // populate sections (bench-only demo content)
  if(intent==='events'){
    // if we didn't find any explicit items, optionally fall back to landing pages
    if(state.config.useLandingFallback && landingMatches.length){
      out.used.articles = landingMatches.map(x=>({title:x.title,url:x.url}));
      metaPill('Landing fallback used', 'warn', true);
    }
    // Note: No scraping here — this is a bench harness.
  } else {
    // advice intent: show any landing pages that look like guides
    if(state.config.useLandingFallback && landingMatches.length){
      out.used.articles = landingMatches.map(x=>({title:x.title,url:x.url}));
      metaPill('Landing fallback used', 'warn', true);
    }
  }

  out.counts.articles = out.used.articles.length;
  state.last = out;
  return out;
}

/* ------------------------------ UI wiring ------------------------------- */
const pillsHost = $('#metaPills');
function clearPills(){ pillsHost.innerHTML = ''; }
function metaPill(text, tone, show=true){
  if(!show) return;
  const p = el('span','pill'+(tone?` pill--${tone}`:''));
  p.textContent = text; pillsHost.appendChild(p);
}

function render(out){
  // header bits
  $('#confScore').textContent = out ? `${out.confidence}%` : '—%';
  clearPills(); // they will be re-added during analyze()

  // sections
  const ev = $('#events'); ev.innerHTML = '';
  const ar = $('#articles'); ar.innerHTML = '';
  const pl = $('#pills'); pl.innerHTML = '';

  // events list
  (out.used.events||[]).forEach(e=>{
    const d = el('div','item');
    const a = el('a',null,e.title); a.href = e.url; a.target="_blank";
    const m = el('div','meta',`${e.when||e.date||''} — ${e.location||''}`);
    d.appendChild(a); d.appendChild(m); ev.appendChild(d);
  });

  // articles list
  (out.used.articles||[]).forEach(aItem=>{
    const d = el('div','item');
    const a = el('a',null,aItem.title||aItem.url); a.href = aItem.url; a.target="_blank";
    d.appendChild(a); ar.appendChild(d);
  });

  // pills (example wiring if you decide to add generic pills later)
  (out.used.pills||[]).forEach(p=>{
    const pEl = el('span','pill'+(p.brand?' pill--brand':''), p.label);
    pl.appendChild(pEl);
  });

  // stats
  $('#statIntent').textContent = out.intent||'—';
  $('#statReason').textContent = out.reason||'—';

  // json
  $('#json').textContent = JSON.stringify(out, null, 2);
}

/* --------------------------- file handlers ------------------------------ */
async function readFileAsText(file){
  if(!file) throw new Error('No file selected');
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = () => rej(fr.error||new Error('Read failed'));
    fr.readAsText(file);
  });
}

async function loadLandingCSV(){
  try{
    const f = $('#landingFile').files[0];
    const txt = await readFileAsText(f);
    const rows = parseCSV(txt);
    const titleKeys = ['url_meta_title','meta_title','title'];
    state.landing = rows.map(r=>{
      const tKey = titleKeys.find(k => r[k]!=null && String(r[k]).trim()!=='') || titleKeys[0];
      return {url: r['url']||r['URL']||'', title: r[tKey]||''};
    }).filter(x=>x.url);
    $('#statLanding').textContent = `loaded ${state.landing.length} rows`;
    metaPill('Landing CSV loaded','ok',true);
    toast(`Loaded ${state.landing.length} landing rows`);
  }catch(err){
    alert('Landing CSV: '+err.message);
  }
}

async function loadQuestionsCSV(){
  try{
    const f = $('#questionsFile').files[0];
    const txt = await readFileAsText(f);
    const rows = parseCSV(txt);
    state.questions = rows.map(r=>({
      idx: r['idx'] || r['id'] || '',
      query: r['query'] || '',
      expected: (r['expected']||'').toLowerCase().trim() // 'events' | 'advice'
    })).filter(x=>x.query);
    $('#statQuestions').textContent = `loaded ${state.questions.length} rows`;
    setBar(0, state.questions.length);
    toast(`Loaded ${state.questions.length} questions`);
  }catch(err){
    alert('Questions CSV: '+err.message);
  }
}

async function runCsvSuite(){
  if(!state.questions.length){
    alert('Please upload a Questions CSV first.');
    return;
  }
  const results = [];
  let passCount = 0;
  setBar(0, state.questions.length);
  for(let i=0;i<state.questions.length;i++){
    const q = state.questions[i];
    clearPills();
    const out = analyzeQuery(q.query);
    out.pass = (out.intent === q.expected);
    out.idx = q.idx || (i+1);
    results.push({
      idx: out.idx,
      query: q.query,
      expected: q.expected,
      detected: out.intent,
      counts: out.counts,
      pass: out.pass,
      used: out.used
    });
    if(out.pass) passCount++;
    setBar(i+1, state.questions.length);
    // render the latest one so you see live behaviour
    render(out);
    await new Promise(r=>setTimeout(r, 10)); // tiny yield for UI
  }
  // show brief summary in JSON panel for quick copy
  const summary = {
    total: state.questions.length,
    passed: passCount,
    rate: Math.round(passCount/state.questions.length*100)+'%',
    results
  };
  $('#json').textContent = JSON.stringify(summary, null, 2);
}

/* ------------------------------ events ---------------------------------- */
$('#btnLoadLanding').addEventListener('click', loadLandingCSV);
$('#btnLoadQuestions').addEventListener('click', loadQuestionsCSV);
$('#btnRunSuite').addEventListener('click', runCsvSuite);

$('#btnRun').addEventListener('click', ()=>{
  const q = $('#q').value.trim();
  if(!q){ alert('Enter a query first.'); return; }
  clearPills();
  const out = analyzeQuery(q);
  render(out);
});

$('#btnCopyJson').addEventListener('click', ()=>{
  const txt = $('#json').textContent;
  navigator.clipboard.writeText(txt).then(()=>{
    toast('JSON copied');
  });
});

$('#useLandingFallback').addEventListener('change', (e)=>{
  state.config.useLandingFallback = e.target.checked;
});
$('#enableGeneric').addEventListener('change', (e)=>{
  state.config.enableGeneric = e.target.checked;
});

/* -------------------------- initial scaffolding ------------------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  $('#confScore').textContent = '—%';
  $('#json').textContent = '[]';
});
</script>
</body>
</html>
