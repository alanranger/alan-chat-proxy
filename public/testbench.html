<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BenchTest — Events · Products · Articles</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0f1115; --panel:#161a22; --muted:#9aa4b2; --text:#e6edf3; --accent:#60a5fa; --ok:#4ade80; --warn:#fbbf24; --err:#f87171; --chip:#1f2633; }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; }
    h2{ margin:0 0 .5rem 0; font-size:15px; color:#cbd5e1; }
    small{ color:var(--muted) }
    .wrap{ display:grid; grid-template-columns: 260px 1fr; gap:14px; padding:14px; }
    .panel{ background:var(--panel); border:1px solid #202635; border-radius:8px; padding:10px; }
    .left .panel{ margin-bottom:14px; }
    label{ display:block; font-size:12px; color:#9fb0c5; margin:6px 0 4px }
    input[type="text"], input[type="url"], input[type="password"], textarea, select{
      width:100%; background:#0d121a; color:var(--text); border:1px solid #1e2532; border-radius:6px; padding:8px 10px; outline:none;
    }
    button{ background:#20283a; color:#dbe7ff; border:1px solid #2a3550; border-radius:6px; padding:8px 10px; cursor:pointer }
    button:hover{ background:#27324a }
    .row{ display:flex; gap:8px; }
    .row > *{ flex:1 }
    .btns{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:var(--chip); color:#d7e3ff; font-size:12px; border:1px solid #263048; }
    .cols{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    .grid{ width:100%; border-collapse: collapse; font-size:13px }
    .grid th, .grid td{ padding:6px 8px; border-bottom:1px solid #21283a; vertical-align:top }
    .grid th{ text-align:left; color:#b7c4d6; background:#131824; position:sticky; top:0; }
    .scroll{ max-height:420px; overflow:auto; border:1px solid #202635; border-radius:8px }
    .muted{ color:var(--muted) }
    .ok{ color:var(--ok) } .warn{ color:var(--warn) } .err{ color:var(--err) }
    .kvs{ display:flex; gap:8px; flex-wrap:wrap; }
    .kv{ background:#0e141d; border:1px solid #1e2635; padding:6px 8px; border-radius:6px; font-size:12px }
    .chips{ display:flex; gap:6px; flex-wrap:wrap; margin:6px 0 0 }
    .log{ background:#091019; color:#c9d7ee; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; white-space:pre; padding:10px; border:1px solid #21283a; border-radius:8px; height:120px; overflow:auto }
    .stats{ display:flex; gap:10px; margin-top:6px }
    .stat{ background:#0e141d; border:1px solid #222a3a; border-radius:6px; padding:6px 8px; font-size:12px; color:#c3d3ee }
    .badge{ font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid #2a3550; background:#1c2433; color:#d8e7ff }
    .right-hdr{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px }
    .hint{ font-size:12px; color:#9fb0c5 }
    .switch{ display:flex; gap:8px; align-items:center; margin-top:6px }
    input[type="checkbox"]{ accent-color:#6ea8ff }
    .sticky-actions{ display:flex; gap:6px; align-items:center; flex-wrap:wrap }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT -->
    <div class="left">
      <div class="panel">
        <h2>Step 0 · Connect to Supabase</h2>
        <label>Supabase URL</label>
        <input id="sbUrl" type="url" placeholder="https://xxxxxxxx.supabase.co" />
        <div class="row">
          <div>
            <label>Supabase <span class="badge">anon</span> key</label>
            <input id="sbKey" type="password" placeholder="Paste anon key" />
          </div>
          <div>
            <label>Events view</label>
            <select id="evView">
              <option value="ai_events">ai_events</option>
            </select>
          </div>
          <div>
            <label>Products view</label>
            <select id="prView">
              <option value="ai_products">ai_products</option>
            </select>
          </div>
        </div>
        <div class="btns">
          <button id="saveCfg">Save</button>
          <button id="resetCfg">Reset defaults</button>
          <button id="connect">Connect</button>
          <button id="fetchLive">Fetch live data</button>
          <span id="connState" class="hint">Not connected.</span>
        </div>
        <div class="switch">
          <label><input id="flagFallback" type="checkbox" checked/> Use Landing CSV fallback</label>
          <label><input id="flagGeneric" type="checkbox" checked/> Enable generic pills</label>
        </div>
      </div>

      <div class="panel">
        <h2>Step 1 (optional) · Landing Pages CSV <small class="muted">(fallback)</small></h2>
        <div class="hint">Required columns: <b>url</b> and one of <b>meta_title</b> or <b>title</b>.</div>
        <div class="btns">
          <input id="csvLanding" type="file" accept=".csv" />
          <button id="clearLanding">Clear</button>
        </div>
        <div id="landingInfo" class="hint">No landing CSV loaded.</div>
      </div>

      <div class="panel">
        <h2>Step 2 · Questions CSV</h2>
        <div class="hint">Columns: <b>idx</b>, <b>query</b>, <b>expected</b>. Extra columns ignored.</div>
        <div class="btns">
          <input id="csvQs" type="file" accept=".csv" />
          <button id="clearQs">Clear</button>
        </div>
        <div class="btns">
          <button id="runSuite">Run whole suite</button>
          <button id="downloadSuiteJSON">Download suite JSON</button>
        </div>
        <div id="qsInfo" class="hint">No questions CSV loaded.</div>
      </div>

      <div class="panel">
        <h2>Step 3 · Try a single query</h2>
        <input id="query" type="text" placeholder="e.g. when is the next devon workshop?" />
        <div class="btns sticky-actions">
          <button id="runSingle">Run</button>
          <button id="copyJSON">Copy JSON</button>
          <button id="downloadJSON">Download JSON</button>
          <span class="kvs">
            <span class="kv">Intent: <b id="intent">advice</b></span>
            <span class="kv">Counts: <span id="counts">events=0, articles=0</span></span>
          </span>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="panel">
      <div class="right-hdr">
        <h2>Results · Events</h2>
        <small class="muted">Shows matched or latest events</small>
      </div>
      <div class="scroll">
        <table class="grid" id="eventsTbl">
          <thead><tr><th>title</th><th>url</th><th>when</th><th>location</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="right-hdr" style="margin-top:10px">
        <h2>Results · Products</h2>
        <small class="muted">Price & tags as scraped</small>
      </div>
      <div class="scroll">
        <table class="grid" id="productsTbl">
          <thead><tr><th>title</th><th>url</th><th>price</th><th>tags</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="right-hdr" style="margin-top:10px">
        <h2>Results · Articles</h2>
        <small class="muted">From Landing CSV (blog pages)</small>
      </div>
      <div class="scroll">
        <table class="grid" id="articlesTbl">
          <thead><tr><th>title</th><th>url</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="right-hdr" style="margin-top:10px">
        <h2>Pills generated</h2>
        <small class="muted">Brand + Generic</small>
      </div>
      <div id="pills" class="chips"></div>

      <div class="right-hdr" style="margin-top:10px">
        <h2>Execution Log</h2>
        <div class="stats">
          <div class="stat">Events: <b id="evCount">0</b></div>
          <div class="stat">Products: <b id="prCount">0</b></div>
          <div class="stat">Articles: <b id="arCount">0</b></div>
        </div>
      </div>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  /***** DEFAULTS —> paste your hard-wired credentials here *****/
  const DEFAULTS = {
    URL: 'https://igzvwbvgvmzvvzoclufx.supabase.co',     // ✅ your Supabase URL
    KEY: '',                                            // ⛳ paste your anon key here (left empty because I don’t know it)
    EV_VIEW: 'ai_events',
    PR_VIEW: 'ai_products'
  };
  /*************************************************************/

  // State
  let supabase = null;
  let env = { url: DEFAULTS.URL, key: DEFAULTS.KEY, evView: DEFAULTS.EV_VIEW, prView: DEFAULTS.PR_VIEW };
  const Landing = { rows: [] };     // [{url,title/meta_title}]
  const Questions = { rows: [] };   // [{idx, query, expected}]
  let liveEvents = [];              // from Supabase
  let liveProducts = [];            // from Supabase

  // DOM
  const els = {
    sbUrl: byId('sbUrl'), sbKey: byId('sbKey'), evView: byId('evView'), prView: byId('prView'),
    saveCfg: byId('saveCfg'), resetCfg: byId('resetCfg'), connect: byId('connect'), fetchLive: byId('fetchLive'),
    connState: byId('connState'), flagFallback: byId('flagFallback'), flagGeneric: byId('flagGeneric'),

    csvLanding: byId('csvLanding'), clearLanding: byId('clearLanding'), landingInfo: byId('landingInfo'),
    csvQs: byId('csvQs'), clearQs: byId('clearQs'), qsInfo: byId('qsInfo'), runSuite: byId('runSuite'),
    downloadSuiteJSON: byId('downloadSuiteJSON'),

    query: byId('query'), runSingle: byId('runSingle'), copyJSON: byId('copyJSON'), downloadJSON: byId('downloadJSON'),
    intent: byId('intent'), counts: byId('counts'),

    eventsTbl: byId('eventsTbl').querySelector('tbody'),
    productsTbl: byId('productsTbl').querySelector('tbody'),
    articlesTbl: byId('articlesTbl').querySelector('tbody'),
    pills: byId('pills'),
    evCount: byId('evCount'), prCount: byId('prCount'), arCount: byId('arCount'),
    log: byId('log')
  };

  // Init
  boot();

  function boot(){
    log('Bench ready.');
    // hydrate from localStorage if saved before
    const saved = JSON.parse(localStorage.getItem('bench_cfg')||'{}');
    env = {
      url: saved.url || DEFAULTS.URL,
      key: saved.key || DEFAULTS.KEY,
      evView: saved.evView || DEFAULTS.EV_VIEW,
      prView: saved.prView || DEFAULTS.PR_VIEW
    };
    els.sbUrl.value = env.url;
    els.sbKey.value = env.key;
    els.evView.value = env.evView;
    els.prView.value = env.prView;

    // wire buttons
    els.saveCfg.onclick = () => {
      env.url = els.sbUrl.value.trim();
      env.key = els.sbKey.value.trim();
      env.evView = els.evView.value.trim();
      env.prView = els.prView.value.trim();
      localStorage.setItem('bench_cfg', JSON.stringify(env));
      log('Saved configuration.');
    };
    els.resetCfg.onclick = () => {
      localStorage.removeItem('bench_cfg');
      els.sbUrl.value = DEFAULTS.URL;
      els.sbKey.value = DEFAULTS.KEY;
      els.evView.value = DEFAULTS.EV_VIEW;
      els.prView.value = DEFAULTS.PR_VIEW;
      log('Reset to defaults (remember to save).');
    };
    els.connect.onclick = connect;
    els.fetchLive.onclick = fetchLive;

    els.csvLanding.onchange = handleLandingCSV;
    els.clearLanding.onclick = () => { Landing.rows = []; updateLandingInfo(); log('Landing CSV cleared.'); };

    els.csvQs.onchange = handleQsCSV;
    els.clearQs.onclick = () => { Questions.rows = []; updateQsInfo(); log('Questions CSV cleared.'); };
    els.runSuite.onclick = runSuite;
    els.downloadSuiteJSON.onclick = () => downloadBlob(JSON.stringify({questions:Questions.rows},null,2), 'bench-questions.json');

    els.runSingle.onclick = runSingle;
    els.copyJSON.onclick = () => copyText(JSON.stringify(buildSnapshot(), null, 2));
    els.downloadJSON.onclick = () => downloadBlob(JSON.stringify(buildSnapshot(), null, 2), 'bench-snapshot.json');

    // auto-connect if creds present
    if(env.url && env.key){
      connect();
    }else{
      log('Missing anon key.');
    }
  }

  async function connect(){
    try{
      els.connState.textContent = 'Connecting to Supabase…';
      log('Connecting to Supabase…');

      env.url = els.sbUrl.value.trim();
      env.key = els.sbKey.value.trim();
      env.evView = els.evView.value.trim();
      env.prView = els.prView.value.trim();

      if(!env.url || !env.key){ log('❗ Provide URL and anon key.', 'err'); els.connState.textContent = 'Missing URL or key.'; return; }

      supabase = window.supabase.createClient(env.url, env.key);
      // probe views
      const [a,b] = await Promise.all([
        supabase.from(env.evView).select('title').limit(1),
        supabase.from(env.prView).select('title').limit(1)
      ]);
      if(a.error) throw a.error;
      if(b.error) throw b.error;

      els.connState.textContent = 'Connected.';
      log('Connected to Supabase.');
      // give counts quickly
      const [ec, pc] = await Promise.all([
        supabase.from(env.evView).select('*', { count:'exact', head:true }),
        supabase.from(env.prView).select('*', { count:'exact', head:true })
      ]);
      const evC = ec.count ?? '?';
      const prC = pc.count ?? '?';
      log(`Views reachable · ${env.evView}: ${evC} · ${env.prView}: ${prC}`);
    }catch(err){
      errlog(err);
      els.connState.textContent = 'Connection failed.';
    }
  }

  async function fetchLive(){
    if(!supabase){ log('Connect first.', 'warn'); return; }
    try{
      log('Fetching live data…');
      const [ev, pr] = await Promise.all([
        supabase.from(env.evView).select('title,url,"when",location,start_date,date_start,date_end').limit(1000),
        supabase.from(env.prView).select('title,url,price,tags').limit(1000)
      ]);
      if(ev.error) throw ev.error;
      if(pr.error) throw pr.error;

      liveEvents = ev.data || [];
      liveProducts = pr.data || [];
      window.__lastEvRows = liveEvents;
      window.__lastPrRows = liveProducts;

      fillEvents(liveEvents.slice(0, 100));
      fillProducts(liveProducts.slice(0, 100));
      updateCounts();

      log(`Loaded events=${liveEvents.length}, products=${liveProducts.length}.`);
    }catch(err){
      errlog(err);
    }
  }

  // === CSV handlers ===
  async function handleLandingCSV(e){
    const file = e.target.files?.[0];
    if(!file){ return; }
    const text = await file.text();
    Landing.rows = parseCSV(text).map(r => ({
      url: r.url || '',
      title: r.meta_title || r.title || ''
    })).filter(r => r.url && r.title);
    updateLandingInfo();
    log(`Landing CSV loaded (${Landing.rows.length} rows).`);
  }
  async function handleQsCSV(e){
    const file = e.target.files?.[0];
    if(!file){ return; }
    const text = await file.text();
    const rows = parseCSV(text);
    Questions.rows = rows.map((r,i) => ({
      idx: r.idx ?? (i+1),
      query: r.query ?? r.q ?? '',
      expected: (r.expected || '').toLowerCase().trim()
    })).filter(r => r.query);
    updateQsInfo();
    log(`Questions CSV loaded (${Questions.rows.length} rows).`);
  }
  function updateLandingInfo(){
    if(!Landing.rows.length){ els.landingInfo.textContent = 'No landing CSV loaded.'; return; }
    els.landingInfo.innerHTML = `Loaded <b>${Landing.rows.length}</b> landing pages.`;
  }
  function updateQsInfo(){
    if(!Questions.rows.length){ els.qsInfo.textContent = 'No questions CSV loaded.'; return; }
    els.qsInfo.innerHTML = `Loaded <b>${Questions.rows.length}</b> questions.`;
  }

  // === Single run ===
  async function runSingle(){
    const q = (els.query.value || '').trim();
    const result = await routeAndAnswer(q);
    window.__lastSingleRun = result;

    // paint
    fillEvents(result.events);
    fillProducts(result.products);
    fillArticles(result.articles);
    drawPills(result.pills);
    els.intent.textContent = result.intent;
    els.counts.textContent = `events=${result.events.length}, articles=${result.articles.length}`;
    updateCounts();

    log(`Run: ${JSON.stringify({ q, intent: result.intent })}`);
  }

  // === Suite ===
  async function runSuite(){
    if(!Questions.rows.length){ log('Load questions CSV first.', 'warn'); return; }
    const suite = [];
    for(const row of Questions.rows){
      const res = await routeAndAnswer(row.query);
      const ok = !row.expected ? true : (res.intent === row.expected);
      suite.push({
        idx: row.idx, q: row.query, expected: row.expected,
        detected: res.intent, ok,
        counts: { events: res.events.length, products: res.products.length, articles: res.articles.length }
      });
    }
    window.__suiteRun = suite;
    const pass = suite.filter(s => s.ok).length;
    log(`Suite done: ${pass}/${suite.length} matched expected intent.`);
  }

  // === Router / Answerer (simple, transparent) ===
  async function routeAndAnswer(q){
    // classify
    const ql = (q||'').toLowerCase();
    let intent = 'advice';
    if(/\b(workshop|course|class|event|tuition|mentoring)\b/.test(ql) || /\bwhen|date|where|next\b/.test(ql)){
      intent = 'events';
    }
    if(/\b(blog|article|what is|how to|metering|exposure|sharp|tripod|long exposure|aperture|iso|shutter)\b/.test(ql)){
      // articles can override events if purely informational
      intent = (/\bworkshop|course|class\b/.test(ql)) ? 'events' : 'articles';
    }

    // pick from live
    let events = [];
    if(liveEvents.length){
      if(ql.includes('next')){
        // prefer soonest by date_start/date_end/start_date
        events = sortByDateAsc(liveEvents).slice(0, 5);
      }else if(q){
        const words = ql.split(/\s+/).filter(w=>w.length>2);
        events = liveEvents.filter(e => {
          const t = (e.title||'').toLowerCase();
          return words.some(w => t.includes(w));
        }).slice(0, 10);
        if(!events.length) events = sortByDateAsc(liveEvents).slice(0, 5);
      }else{
        events = sortByDateAsc(liveEvents).slice(0, 10);
      }
    }

    let products = [];
    if(liveProducts.length){
      if(/\bprice|cost|fee|£|gbp\b/.test(ql) || intent==='events'){
        products = liveProducts
          .filter(p => p.price != null)
          .sort((a,b)=> Number(b.price||0) - Number(a.price||0))
          .slice(0, 10);
      }else{
        products = liveProducts.slice(0, 5);
      }
    }

    // articles from landing CSV
    let articles = [];
    if(Landing.rows.length){
      const bloggy = Landing.rows.filter(r => /\/blog|\/article|\/what|\/how|\/tips/.test(r.url.toLowerCase()));
      if(q){
        const words = ql.split(/\s+/).filter(w=>w.length>2);
        articles = bloggy.filter(a => {
          const t = (a.title||'').toLowerCase();
          return words.some(w => t.includes(w));
        }).slice(0, 10);
      }else{
        articles = bloggy.slice(0, 10);
      }
    }

    // pills
    const pills = buildPills({ intent, q, events, products, articles });

    // if fallback enabled and no live events, use landing dataset to make “Event Listing” pill
    if(els.flagFallback.checked && !events.length && Landing.rows.length){
      const listing = Landing.rows.find(r => /search|workshop|course|classes/i.test(r.title+r.url));
      if(listing){
        pills.unshift({ label: 'Event Listing', url: listing.url, brand: true });
      }
    }

    return { intent, q, events, products, articles, pills, confidence: scoreConfidence({intent, q, events, products, articles}) };
  }

  // === Helpers ===
  function sortByDateAsc(list){
    const d = v => (v?.date_start || v?.start_date || v?.date_end) ? new Date(v.date_start || v.start_date || v.date_end).getTime() : Number.POSITIVE_INFINITY;
    return [...list].sort((a,b)=> d(a)-d(b));
  }
  function scoreConfidence({intent, q, events, products, articles}){
    let s=60;
    if(intent==='events' && events.length) s+=20;
    if(intent==='articles' && articles.length) s+=20;
    if(q && q.length>25) s+=5;
    return Math.max(0, Math.min(100, s));
  }

  function buildPills({ intent, q, events, products, articles }){
    const out = [];
    // brand anchors from landing
    const brand = [
      {label:'Gift Vouchers', regex:/gift/i},
      {label:'Newsletter', regex:/newsletter|signup/i},
      {label:'Private Lessons', regex:/private/i},
      {label:'Payment Plan', regex:/payment|pick n mix/i},
      {label:'Contact', regex:/contact/i},
    ];
    if(Landing.rows.length){
      for(const b of brand){
        const hit = Landing.rows.find(r => b.regex.test((r.title||'')+(r.url||'')));
        if(hit) out.push({ label:b.label, url:hit.url, brand:true });
      }
    }
    // generic helpful pills
    if(els.flagGeneric.checked){
      if(intent==='events') out.push({label:'All Workshops', url: guessListingURL(), brand:false});
      if(intent==='articles' && articles.length) out.push({label:'More articles', url: articles[0].url, brand:false});
    }
    return uniqBy(out.filter(Boolean), p => p.label + p.url);
  }
  function guessListingURL(){
    const cand = Landing.rows.find(r => /workshop|course|classes|photography/i.test(r.title+r.url));
    return cand ? cand.url : (liveEvents[0]?.url || '#');
  }

  // === Painting ===
  function fillEvents(rows){
    const tb = els.eventsTbl; tb.innerHTML = '';
    for(const r of rows){
      const tr = document.createElement('tr');
      td(tr, r.title); td(tr, link(r.url)); td(tr, r.when || ''); td(tr, r.location || '');
      tb.appendChild(tr);
    }
  }
  function fillProducts(rows){
    const tb = els.productsTbl; tb.innerHTML = '';
    for(const r of rows){
      const tr = document.createElement('tr');
      td(tr, r.title); td(tr, link(r.url)); td(tr, money(r.price)); td(tr, r.tags || '');
      tb.appendChild(tr);
    }
  }
  function fillArticles(rows){
    const tb = els.articlesTbl; tb.innerHTML = '';
    for(const r of rows){
      const tr = document.createElement('tr');
      td(tr, r.title); td(tr, link(r.url));
      tb.appendChild(tr);
    }
  }
  function drawPills(list){
    els.pills.innerHTML = '';
    for(const p of list){
      const a = document.createElement('a');
      a.href = p.url || '#'; a.target = '_blank'; a.rel='noopener';
      a.className = 'pill'; a.textContent = p.label + (p.brand ? ' ★' : '');
      els.pills.appendChild(a);
    }
  }
  function updateCounts(){
    els.evCount.textContent = liveEvents.length;
    els.prCount.textContent = liveProducts.length;
    // Articles count reflects current rendered rows
    els.arCount.textContent = els.articlesTbl.querySelectorAll('tr').length;
  }

  // === Snapshot / export ===
  function buildSnapshot(){
    const redact = k => (k && k.length>12) ? `${k.slice(0,4)}…${k.slice(-4)}` : (k||null);
    return {
      meta: { version:'benchtest/2.0', timestamp:new Date().toISOString(), userAgent:navigator.userAgent },
      environment: {
        supabase_url: env.url, supabase_anon_key_redacted: redact(env.key),
        events_view: env.evView, products_view: env.prView,
        flags: { fallback: els.flagFallback.checked, generic: els.flagGeneric.checked }
      },
      datasets: {
        live: {
          events_count: liveEvents.length, products_count: liveProducts.length,
          events_sample: liveEvents.slice(0,10), products_sample: liveProducts.slice(0,10)
        },
        landing_csv: {
          rows_total: Landing.rows.length, sample: Landing.rows.slice(0,10)
        },
        questions_csv: {
          rows_total: Questions.rows.length, rows: Questions.rows
        }
      },
      last_single_run: window.__lastSingleRun || null,
      last_suite_run: window.__suiteRun || [],
      execution_log: (els.log.textContent || '').trim().split('\n'),
      errors: window.__errors || []
    };
  }

  // === Utilities ===
  function parseCSV(text){
    // small tolerant parser (no external deps)
    const lines = text.replace(/\r/g,'').split('\n').filter(Boolean);
    if(!lines.length) return [];
    const headers = splitCSVLine(lines[0]).map(h => h.trim());
    const rows = [];
    for(let i=1;i<lines.length;i++){
      const cols = splitCSVLine(lines[i]);
      const obj = {};
      headers.forEach((h,idx)=> obj[h] = cols[idx] ?? '');
      rows.push(obj);
    }
    return rows;
  }
  function splitCSVLine(line){
    const out=[]; let cur=''; let inQ=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c==='\"'){ if(inQ && line[i+1]==='\"'){ cur+='\"'; i++; } else { inQ=!inQ; } }
      else if(c===',' && !inQ){ out.push(cur); cur=''; }
      else cur+=c;
    }
    out.push(cur); return out;
  }

  function uniqBy(arr, keyFn){ const m=new Map(); for(const x of arr){ m.set(keyFn(x), x); } return [...m.values()]; }
  function link(u){ if(!u) return ''; return `<a href="${escapeHtml(u)}" target="_blank" rel="noopener">${escapeHtml(u)}</a>`; }
  function money(v){ if(v==null) return 'NULL'; try{ const n=Number(v); if(!isFinite(n)) return String(v); return new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(n); }catch{ return String(v) } }
  function td(tr, html){ const e=document.createElement('td'); e.innerHTML=html==null?'':html; tr.appendChild(e); }
  function byId(id){ return document.getElementById(id); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function downloadBlob(text, name){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'application/json'})); a.download=name; document.body.appendChild(a); a.click(); a.remove(); }
  async function copyText(t){ try{ await navigator.clipboard.writeText(t); log('Copied JSON snapshot to clipboard.'); } catch(e){ errlog(e); } }
  function log(msg, lvl){ const ts = new Date().toTimeString().slice(0,8); els.log.textContent += `${ts}  ${msg}\n`; els.log.scrollTop = els.log.scrollHeight; }
  function errlog(err){ (window.__errors ||= []).push(String(err?.message||err)); log(`ERROR: ${err?.message||err}`, 'err'); }
  </script>
</body>
</html>
