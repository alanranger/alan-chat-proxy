<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bench Tester — Events • Products • Articles • Pills</title>
<!-- Tailwind (CDN) just for layout/spacing; remove if you prefer plain CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Supabase JS v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- PapaParse for CSV -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root { --panel:#0f172a; --ink:#e2e8f0; --muted:#94a3b8; --accent:#22d3ee; --ok:#22c55e; --bad:#ef4444; }
  body { background:#0b1020; color:var(--ink); }
  .panel { background:var(--panel); border:1px solid #1f2a44; border-radius:10px; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .table { width:100%; border-collapse:collapse; }
  .table th, .table td { padding:.5rem .6rem; border-bottom:1px solid #1f2a44; vertical-align:top; }
  .table th { color:var(--muted); font-weight:600; text-transform:uppercase; font-size:.72rem; letter-spacing:.02em; }
  .pill { display:inline-flex; align-items:center; gap:.4rem; border:1px solid #1f2a44; padding:.15rem .5rem; border-radius:999px; margin:.15rem .3rem .15rem 0; font-size:.8rem }
  .pill.brand { border-color:#334155; background:#0b1328; }
  .pill.generic { border-color:#2a3a55; background:#0b1828; }
  .btn { background:#13213d; border:1px solid #1f2a44; padding:.45rem .6rem; border-radius:8px; font-weight:600; }
  .btn:hover { background:#17284c }
  .btn:disabled { opacity:.5; cursor:not-allowed }
  .badge { font-size:.72rem; padding:.1rem .45rem; border:1px solid #1f2a44; border-radius:6px; }
  .ok { color:var(--ok) }
  .bad { color:var(--bad) }
  .log { white-space:pre-wrap; font-size:.82rem; line-height:1.35; }
  .small { font-size:.82rem; color:var(--muted); }
  details > summary { cursor:pointer }
</style>
</head>
<body class="p-4 md:p-6">
  <div class="grid grid-cols-12 gap-4">
    <!-- Left controls -->
    <div class="col-span-12 md:col-span-3 space-y-4">
      <div class="panel p-4">
        <div class="font-semibold mb-2">Step 0 · Connect to Supabase</div>
        <label class="block text-sm mb-1">Supabase URL</label>
        <input id="sb_url" class="w-full p-2 rounded bg-slate-800 border border-slate-700 mono" />
        <label class="block text-sm mt-3 mb-1">Supabase ANON key</label>
        <input id="sb_key" class="w-full p-2 rounded bg-slate-800 border border-slate-700 mono" />
        <div class="grid grid-cols-2 gap-2 mt-3">
          <div>
            <label class="block text-xs mb-1 small">Events view</label>
            <input id="view_events" class="w-full p-2 rounded bg-slate-800 border border-slate-700 mono" />
          </div>
          <div>
            <label class="block text-xs mb-1 small">Products view</label>
            <input id="view_products" class="w-full p-2 rounded bg-slate-800 border border-slate-700 mono" />
          </div>
        </div>
        <div class="mt-2">
          <label class="block text-xs mb-1 small">Articles view</label>
          <input id="view_articles" class="w-full p-2 rounded bg-slate-800 border border-slate-700 mono" />
        </div>
        <div class="flex items-center gap-2 mt-3">
          <button id="btnSave" class="btn">Save</button>
          <button id="btnReset" class="btn">Reset defaults</button>
          <span id="connStatus" class="small ml-auto">—</span>
        </div>
        <div class="flex items-center gap-2 mt-2">
          <button id="btnConnect" class="btn">Connect</button>
          <button id="btnFetchLive" class="btn">Fetch live data</button>
        </div>
        <div class="mt-3 space-y-1">
          <label class="inline-flex items-center gap-2 small">
            <input id="flagFallback" type="checkbox" class="accent-cyan-400">
            Use Landing CSV fallback
          </label>
          <br>
          <label class="inline-flex items-center gap-2 small">
            <input id="flagGeneric" type="checkbox" class="accent-cyan-400" checked>
            Enable generic pills
          </label>
        </div>
      </div>

      <div class="panel p-4">
        <div class="font-semibold mb-2">Step 1 (optional) · Landing Pages CSV (fallback)</div>
        <div class="small mb-2">Required columns: <span class="mono">url</span> and one of <span class="mono">meta_title</span> or <span class="mono">title</span>.</div>
        <input id="fileLanding" type="file" accept=".csv" class="w-full">
        <div class="flex items-center gap-2 mt-2">
          <button id="btnClearLanding" class="btn">Clear</button>
          <span id="landingMeta" class="small ml-auto">—</span>
        </div>
      </div>

      <div class="panel p-4">
        <div class="font-semibold mb-2">Step 2 · Questions CSV</div>
        <div class="small mb-2">Columns: <span class="mono">idx, query, expected</span>. Extra columns ignored.</div>
        <input id="fileQuestions" type="file" accept=".csv" class="w-full">
        <div class="flex items-center gap-2 mt-2">
          <button id="btnClearQuestions" class="btn">Clear</button>
          <span id="questionsMeta" class="small ml-auto">—</span>
        </div>
        <div class="flex items-center gap-2 mt-3">
          <button id="btnRunSuite" class="btn">Run whole suite</button>
          <button id="btnDownloadSuite" class="btn">Download suite JSON</button>
        </div>
      </div>

      <div class="panel p-4">
        <div class="font-semibold mb-2">Step 3 · Try a single query</div>
        <input id="singleQuery" placeholder="e.g. when is the next devon workshop?" class="w-full p-2 rounded bg-slate-800 border border-slate-700">
        <div class="flex items-center gap-2 mt-2">
          <button id="btnRun" class="btn">Run</button>
          <button id="btnCopyJSON" class="btn">Copy JSON</button>
          <button id="btnDownloadJSON" class="btn">Download JSON</button>
        </div>
        <div class="grid grid-cols-3 gap-2 mt-3 small">
          <div>Intent: <span id="badgeIntent" class="badge">—</span></div>
          <div>Counts: <span id="badgeCounts" class="badge">events=0, products=0, articles=0, pills=0</span></div>
          <div class="text-right"><span id="brandGeneric" class="small"></span></div>
        </div>
      </div>
    </div>

    <!-- Right: results + log + suite -->
    <div class="col-span-12 md:col-span-9 space-y-4">
      <div class="grid grid-cols-2 gap-4">
        <div class="panel p-3">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Results · Events</div>
            <div id="eventsCounter" class="small"></div>
          </div>
          <div class="overflow-auto max-h-72">
            <table class="table">
              <thead><tr><th>title</th><th>url</th><th>when</th><th>location</th></tr></thead>
              <tbody id="tblEvents"></tbody>
            </table>
          </div>
        </div>
        <div class="panel p-3">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Results · Products</div>
            <div id="productsCounter" class="small"></div>
          </div>
          <div class="overflow-auto max-h-72">
            <table class="table">
              <thead><tr><th>title</th><th>url</th><th>price</th><th>tags</th></tr></thead>
              <tbody id="tblProducts"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="panel p-3">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Results · Articles</div>
            <div id="articlesCounter" class="small"></div>
          </div>
          <div class="overflow-auto max-h-56">
            <table class="table">
              <thead><tr><th>title</th><th>url</th><th>snippet</th></tr></thead>
              <tbody id="tblArticles"></tbody>
            </table>
          </div>
        </div>
        <div class="panel p-3">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Pills generated</div>
            <div class="small">Brand + Generic</div>
          </div>
          <div id="pillsArea" class="mt-1"></div>
          <div class="mt-2 grid grid-cols-3 gap-2">
            <div class="badge">Events: <span id="cntEvents">0</span></div>
            <div class="badge">Products: <span id="cntProducts">0</span></div>
            <div class="badge">Articles: <span id="cntArticles">0</span></div>
          </div>
        </div>
      </div>

      <div class="panel p-3">
        <div class="font-semibold mb-1">Execution Log</div>
        <div id="log" class="log mono"></div>
      </div>

      <div class="panel p-3">
        <div class="flex items-center justify-between">
          <div class="font-semibold">Suite Results</div>
          <div id="suiteHeader" class="small">—</div>
        </div>
        <div class="overflow-auto max-h-[420px]">
          <table class="table">
            <thead>
              <tr>
                <th>idx</th><th>query</th><th>expected</th><th>predicted</th><th>ok</th><th>details</th>
              </tr>
            </thead>
            <tbody id="tblSuite"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------------------------------------------------------------------- */
/*  CONFIG (hard-wired defaults; still editable in the UI)                */
/* ---------------------------------------------------------------------- */
const DEFAULTS = {
  SUPABASE_URL: "https://igzvwbvgvmzvvzoclufx.supabase.co",
  SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnenZ3YnZndm16dnZ6b2NsdWZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2Nzc5MjgsImV4cCI6MjA3MzI1MzkyOH0.A9TCmnXKJhDRYBkrO0mAMPiUQeV9enweeyRWKWQ1SZY",
  VIEW_EVENTS:   "ai_events",
  VIEW_PRODUCTS: "ai_products",
  VIEW_ARTICLES: "ai_articles"
};

let supa = null;
let env = { ...DEFAULTS };
let live = { events: [], products: [], articles: [] };
let landing = [];     // CSV fallback pages
let questions = [];   // suite rows
let lastRun = null;
let suiteResults = [];

/* ---------------------------------------------------------------------- */
/*  Utility helpers                                                       */
/* ---------------------------------------------------------------------- */
const $ = sel => document.querySelector(sel);
const el = (tag, cls, html) => {
  const x = document.createElement(tag);
  if (cls) x.className = cls;
  if (html !== undefined) x.innerHTML = html;
  return x;
};
const sleep = ms => new Promise(r => setTimeout(r, ms));

function log(msg) {
  const t = new Date().toTimeString().slice(0,8);
  const line = `${t}  ${msg}`;
  $("#log").textContent += ( ($("#log").textContent ? "\n" : "") + line );
}

function saveToLocal() {
  localStorage.setItem("bench.env", JSON.stringify(env));
  log("Saved configuration.");
}

function loadFromLocal() {
  const raw = localStorage.getItem("bench.env");
  if (!raw) return (env = { ...DEFAULTS });
  try { env = JSON.parse(raw); } catch { env = { ...DEFAULTS }; }
}

function hydrateInputs() {
  $("#sb_url").value = env.SUPABASE_URL;
  $("#sb_key").value = env.SUPABASE_ANON_KEY;
  $("#view_events").value = env.VIEW_EVENTS;
  $("#view_products").value = env.VIEW_PRODUCTS;
  $("#view_articles").value = env.VIEW_ARTICLES;
}

function readInputs() {
  env.SUPABASE_URL = $("#sb_url").value.trim();
  env.SUPABASE_ANON_KEY = $("#sb_key").value.trim();
  env.VIEW_EVENTS = $("#view_events").value.trim();
  env.VIEW_PRODUCTS = $("#view_products").value.trim();
  env.VIEW_ARTICLES = $("#view_articles").value.trim();
}

/* CSV parsing (Papaparse) */
function parseCSV(file) {
  return new Promise((resolve, reject) => {
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: results => resolve(results.data),
      error: err => reject(err)
    });
  });
}

/* Basic tokenizer for simple matching */
function tokens(q) {
  return (q || "")
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, " ")
    .split(/\s+/)
    .filter(Boolean);
}

/* crude intent heuristic (deterministic for bench) */
function detectIntent(q) {
  const t = tokens(q);
  const has = s => t.includes(s);
  const any = arr => arr.some(has);

  if (any(["workshop","workshops","course","courses","class","classes","event","events","date","when","where","cost","price","next"]))
    return "events";

  // “articles” when specifically asking “what is …” or “how …”
  if (has("what") || has("how") || has("guide") || has("tips")) return "advice";
  return "advice";
}

/* Build OR filter for supabase (title/snippet contains any key) */
function buildOrIlike(keys, cols = ["title","snippet"]) {
  const safe = keys
    .map(k => k.replace(/[%_,]/g, ""))
    .filter(k => k.length >= 3)
    .slice(0, 6);
  if (!safe.length) return null;
  const parts = [];
  for (const k of safe) {
    for (const c of cols) parts.push(`${c}.ilike.%${k}%`);
  }
  return parts.join(",");
}

/* Render helpers */
function setCounts(e=0,p=0,a=0) {
  $("#cntEvents").textContent = e;
  $("#cntProducts").textContent = p;
  $("#cntArticles").textContent = a;
  $("#badgeCounts").textContent = `events=${e}, products=${p}, articles=${a}, pills=${(lastRun?.pills||[]).length||0}`;
}

function clrTable(tbodySel){ $(tbodySel).innerHTML = ""; }
function pushRow(tbodySel, cells) {
  const tr = el("tr");
  for (const c of cells) tr.append(el("td","", c ?? ""));
  $(tbodySel).append(tr);
}
function renderTopN() {
  clrTable("#tblEvents"); clrTable("#tblProducts"); clrTable("#tblArticles");
  const e = (lastRun?.events||[]).slice(0,20);
  const p = (lastRun?.products||[]).slice(0,20);
  const a = (lastRun?.articles||[]).slice(0,20);
  for (const r of e) pushRow("#tblEvents",[esc(r.title), link(r.url), esc(r.when||""), esc(r.location||"")]);
  for (const r of p) pushRow("#tblProducts",[esc(r.title), link(r.url), money(r.price), esc(r.tags||"")]);
  for (const r of a) pushRow("#tblArticles",[esc(r.title), link(r.url), esc(r.snippet||"")]);
  $("#eventsCounter").textContent   = `showing ${e.length} (of ${lastRun?.events?.length||0})`;
  $("#productsCounter").textContent = `showing ${p.length} (of ${lastRun?.products?.length||0})`;
  $("#articlesCounter").textContent = `showing ${a.length} (of ${lastRun?.articles?.length||0})`;
}
const esc = s => (s ?? "").toString().replace(/[<>&]/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[m]));
const link = u => u ? `<a href="${u}" target="_blank" class="text-cyan-300 underline break-all">${esc(u)}</a>` : "";
const money = v => (v==null||v==="") ? "" : `£${Number(v).toLocaleString("en-GB",{maximumFractionDigits:0})}`;

/* pills from landing CSV and some generic fallbacks */
function generatePills(query) {
  const out = [];
  const t = tokens(query);
  const add = (label,url,brand=true) => out.push({label,url,brand});

  // Brand pills from landing CSV by keyword
  const tryAdd = (kw, label) => {
    const hit = landing.find(x => (x.title||x.meta_title||"").toLowerCase().includes(kw));
    if (hit) add(label || (hit.title||hit.meta_title||"").slice(0,60), hit.url, true);
  };
  tryAdd("blog","Blog");
  tryAdd("newsletter","Newsletter");
  tryAdd("gift","Gift Vouchers");
  tryAdd("payment","Payment Plan");

  // Events generic landing search
  if ($("#flagGeneric").checked) {
    if (t.includes("workshop") || t.includes("workshops") || t.includes("course")) {
      add("Event Listing", "https://www.alanranger.com/search?query=workshops", true);
      add("Course Finder", "https://www.alanranger.com/course-finder-photography-classes-near-me", true);
    }
    // Generic pills that always help navigation
    add("Home", "https://www.alanranger.com", true);
  }

  // Query→site search pill (generic)
  if ($("#flagGeneric").checked && query.trim()) {
    const q = encodeURIComponent(query.trim());
    add(`Search site: “${query.slice(0,24)}”`, `https://www.alanranger.com/search?query=${q}`, false);
  }
  return out;
}

/* ---------------------------------------------------------------------- */
/*  Supabase                                                              */
/* ---------------------------------------------------------------------- */
async function connect() {
  readInputs();
  supa = window.supabase.createClient(env.SUPABASE_URL, env.SUPABASE_ANON_KEY);
  $("#connStatus").textContent = "Connecting…";
  log("Connecting to Supabase…");

  // quick smoke: count rows in each view
  const [e,p,a] = await Promise.all([
    supa.from(env.VIEW_EVENTS).select("title",{count:"estimated",head:true}),
    supa.from(env.VIEW_PRODUCTS).select("title",{count:"estimated",head:true}),
    supa.from(env.VIEW_ARTICLES).select("title",{count:"estimated",head:true})
  ]);

  if (e.error || p.error || a.error) {
    $("#connStatus").textContent = "Error";
    log("ERROR connecting (check grants / view names).");
    if (e.error) log("events: " + e.error.message);
    if (p.error) log("products: " + p.error.message);
    if (a.error) log("articles: " + a.error.message);
    return;
  }
  $("#connStatus").textContent = "Connected.";
  log(`Connected to Supabase. Views reachable · ${env.VIEW_EVENTS}: ${e.count||"?"} · ${env.VIEW_PRODUCTS}: ${p.count||"?"} · ${env.VIEW_ARTICLES}: ${a.count||"?"}`);
}

async function fetchLive() {
  if (!supa) await connect();
  $("#connStatus").textContent = "Fetching…";
  log("Fetching live data…");

  const [E,P,A] = await Promise.all([
    supa.from(env.VIEW_EVENTS).select("title,url,when,location,start_date,date_start,date_end").order("start_date",{ascending:true}).limit(2000),
    supa.from(env.VIEW_PRODUCTS).select("title,url,price,tags").limit(2000),
    supa.from(env.VIEW_ARTICLES).select("title,url,snippet,kind").order("last_seen",{ascending:false}).limit(2000)
  ]);

  if (E.error) log("events error: " + E.error.message);
  if (P.error) log("products error: " + P.error.message);
  if (A.error) log("articles error: " + A.error.message);

  live.events = E.data||[];
  live.products = P.data||[];
  live.articles = A.data||[];

  log(`Loaded events=${live.events.length}, products=${live.products.length}, articles=${live.articles.length}.`);
  $("#connStatus").textContent = "Connected.";
}

/* ---------------------------------------------------------------------- */
/*  Runner                                                                */
/* ---------------------------------------------------------------------- */
async function runSingle(query) {
  if (!supa) await connect();
  const intent = detectIntent(query);
  $("#badgeIntent").textContent = intent;

  // EVENTS retrieval: simple ilike across title + location
  let events = [];
  if (intent === "events") {
    const keys = tokens(query).filter(t => t.length>=3);
    const or = buildOrIlike(keys, ["title"]);
    if (or) {
      const q = supa.from(env.VIEW_EVENTS).select("title,url,when,location,start_date,date_start,date_end").or(or).limit(200);
      const { data, error } = await q;
      if (!error) events = data || [];
    }
    // If nothing (or fallback ticked), show "latest/upcoming" slice as context
    if (!events.length || $("#flagFallback").checked) {
      const tail = live.events.slice(0,50);
      if (tail.length) events = uniqBy([ ...events, ...tail ], r => r.url);
    }
  }

  // PRODUCTS retrieval: search title
  let products = [];
  {
    const keys = tokens(query).filter(t => t.length>=3);
    const or = buildOrIlike(keys, ["title"]);
    if (or) {
      const { data, error } = await supa.from(env.VIEW_PRODUCTS).select("title,url,price,tags").or(or).limit(200);
      if (!error) products = data || [];
    }
  }

  // ARTICLES retrieval: title/snippet
  let articles = [];
  {
    const keys = tokens(query).filter(t => t.length>=3);
    const or = buildOrIlike(keys, ["title","snippet"]);
    if (or) {
      const { data, error } = await supa.from(env.VIEW_ARTICLES).select("title,url,snippet,kind").or(or).limit(200);
      if (!error) articles = data || [];
    }
    if (!articles.length && $("#flagFallback").checked && landing.length) {
      // show two strongest content-y landing pages as a weak fallback
      const contentish = landing.filter(x => /blog|tips|guide|article|tutorial/i.test(`${x.title||x.meta_title||""}`));
      articles = contentish.slice(0,2).map(x => ({title:x.title||x.meta_title||"(landing)", url:x.url, snippet:"(from Landing CSV)", kind:"landing"}));
    }
  }

  // Pills
  const pills = generatePills(query);

  lastRun = {
    q: query,
    intent,
    counts: { events: events.length, products: products.length, articles: articles.length, pills: pills.length },
    events, products, articles, pills
  };

  $("#brandGeneric").textContent = `Events ${events.length} • Products ${products.length} • Articles ${articles.length}`;
  setCounts(events.length, products.length, articles.length);
  renderTopN();
  renderPills(pills);
}

function renderPills(pills) {
  const box = $("#pillsArea");
  box.innerHTML = "";
  for (const p of pills) {
    const a = el("a","pill " + (p.brand?"brand":"generic"), (p.brand? "🏷️":"🔎") + " " + esc(p.label));
    a.href = p.url; a.target="_blank";
    box.append(a);
  }
}

/* ---------------------------------------------------------------------- */
/*  Suite                                                                 */
/* ---------------------------------------------------------------------- */
async function runSuite() {
  if (!questions.length) { log("No questions CSV loaded."); return; }
  suiteResults = [];
  $("#tblSuite").innerHTML = "";
  let okCount = 0;

  for (const row of questions) {
    const idx = String(row.idx ?? "").trim() || String(suiteResults.length+1);
    const q = (row.query||"").toString();
    const expected = (row.expected||"").toString().toLowerCase();

    await runSingle(q);
    const predicted = lastRun.intent;
    const ok = expected ? (predicted === expected) : true;
    if (ok) okCount++;

    const det = el("details");
    const sum = el("summary","", "Show matches");
    det.append(sum);

    // compact preview of top matches
    const preview = el("div","small mt-1");
    const e0 = (lastRun.events||[]).slice(0,3).map(r=>`• ${esc(r.title)}`).join("<br>");
    const p0 = (lastRun.products||[]).slice(0,2).map(r=>`• ${esc(r.title)}`).join("<br>");
    const a0 = (lastRun.articles||[]).slice(0,2).map(r=>`• ${esc(r.title)}`).join("<br>");
    preview.innerHTML =
      `<div class="mt-1"><b>Events</b><br>${e0 || "(none)"}</div>` +
      `<div class="mt-2"><b>Products</b><br>${p0 || "(none)"}</div>` +
      `<div class="mt-2"><b>Articles</b><br>${a0 || "(none)"}</div>` +
      `<div class="mt-2"><b>Pills</b><br>${(lastRun.pills||[]).map(p=>esc(p.label)).join(", ") || "(none)"}</div>`;
    det.append(preview);

    const tr = el("tr");
    tr.append(el("td","small mono", esc(idx)));
    tr.append(el("td","", esc(q)));
    tr.append(el("td","small", esc(expected||"")));
    tr.append(el("td","small", esc(predicted)));
    tr.append(el("td", ok ? "ok" : "bad", ok ? "✓" : "✗"));
    const td = el("td"); td.append(det); tr.append(td);
    $("#tblSuite").append(tr);

    suiteResults.push({ idx, q, expected, predicted, ok,
      used: {
        top_events: (lastRun.events||[]).slice(0,5),
        top_products: (lastRun.products||[]).slice(0,5),
        top_articles: (lastRun.articles||[]).slice(0,5),
        pills: lastRun.pills
      }
    });
    await sleep(30); // keep UI responsive
  }

  $("#suiteHeader").textContent = `Suite: ${okCount}/${suiteResults.length} matched expected intent.`;
  log(`Suite done: ${okCount}/${suiteResults.length} matched expected intent.`);
}

/* ---------------------------------------------------------------------- */
/*  Rendering helpers (misc)                                              */
/* ---------------------------------------------------------------------- */
function uniqBy(arr, keyFn){
  const m = new Map();
  for (const v of arr) m.set(keyFn(v), v);
  return [...m.values()];
}

/* ---------------------------------------------------------------------- */
/*  UI wiring                                                             */
/* ---------------------------------------------------------------------- */
function wire() {
  // Defaults on first load
  loadFromLocal();
  hydrateInputs();
  $("#connStatus").textContent = "—";
  log("Bench ready.");

  $("#btnSave").onclick = () => { readInputs(); saveToLocal(); };
  $("#btnReset").onclick = () => { env = { ...DEFAULTS }; hydrateInputs(); saveToLocal(); };
  $("#btnConnect").onclick = connect;
  $("#btnFetchLive").onclick = fetchLive;

  $("#btnClearLanding").onclick = () => { landing = []; $("#landingMeta").textContent = "Cleared"; };
  $("#btnClearQuestions").onclick = () => { questions = []; $("#questionsMeta").textContent = "Cleared"; };

  $("#fileLanding").onchange = async e => {
    const f = e.target.files?.[0]; if (!f) return;
    landing = await parseCSV(f);
    $("#landingMeta").textContent = `Loaded ${landing.length} landing pages.`;
    log(`Landing CSV loaded (${landing.length} rows).`);
  };

  $("#fileQuestions").onchange = async e => {
    const f = e.target.files?.[0]; if (!f) return;
    questions = await parseCSV(f);
    $("#questionsMeta").textContent = `Loaded ${questions.length} questions.`;
    log(`Questions CSV loaded (${questions.length} rows).`);
  };

  $("#btnRun").onclick = async () => {
    const q = $("#singleQuery").value || "";
    log(`Run: ${JSON.stringify({q, intent: detectIntent(q)})}`);
    await runSingle(q);
  };

  $("#btnCopyJSON").onclick = () => {
    if (!lastRun) return;
    const payload = JSON.stringify(lastRun, null, 2);
    navigator.clipboard.writeText(payload);
    log("Copied JSON of last run.");
  };

  $("#btnDownloadJSON").onclick = () => {
    if (!lastRun) return;
    downloadBlob(JSON.stringify(lastRun, null, 2), "bench-last-run.json", "application/json");
  };

  $("#btnRunSuite").onclick = runSuite;
  $("#btnDownloadSuite").onclick = () => {
    if (!suiteResults.length) return;
    downloadBlob(JSON.stringify({ meta:{ at:new Date().toISOString() }, results:suiteResults }, null, 2),
      "bench-suite.json", "application/json");
  };

  // Auto-connect & fetch once
  connect().then(fetchLive);
}

function downloadBlob(text, name, type) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text], {type}));
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
}

window.addEventListener("DOMContentLoaded", wire);
</script>
</body>
</html>
