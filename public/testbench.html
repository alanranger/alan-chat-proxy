<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bench Test (single-file, auto-filled Step 0)</title>
<style>
  :root { --bg:#0f1220; --panel:#151935; --text:#e7e9ff; --muted:#9aa1c6; --ok:#29d; --warn:#f7b500; --bad:#f64; --chip:#242a52; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{display:grid;grid-template-columns:340px 1fr;gap:16px;padding:16px}
  .card{background:var(--panel);border-radius:12px;padding:14px;box-shadow:0 0 0 1px rgba(255,255,255,.04) inset}
  h2{margin:.25rem 0 .75rem 0;font-size:15px;letter-spacing:.02em;color:#cfd3ff}
  label{display:block;margin:.5rem 0 .25rem;color:var(--muted);font-size:12px}
  input[type=text],textarea{width:100%;background:#0e1130;color:var(--text);border:1px solid #272c57;border-radius:9px;padding:9px 10px}
  textarea{min-height:102px;resize:vertical}
  .row{display:flex;gap:8px;align-items:center}
  .btn{background:#24306b;border:1px solid #2c3a84;color:#e7e9ff;border-radius:9px;padding:8px 10px;cursor:pointer}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .btn.primary{background:#2b6be2;border-color:#2b6be2}
  .btn.ghost{background:transparent;border-color:#39438a}
  .pill{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid #2b3369;color:#cfd3ff;
        border-radius:20px;padding:4px 8px;font-size:12px;margin-right:6px;margin-bottom:6px}
  .split{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .log{white-space:pre-wrap;background:#0b0e25;border:1px solid #22285b;border-radius:10px;padding:10px;min-height:96px;color:#cbd2ff}
  .stat{display:grid;grid-template-columns:140px 1fr;gap:8px;color:#c9cdf7}
  .tag{font-size:12px;color:#9aa1c6}
  .count{font-variant-numeric:tabular-nums}
  .title{font-weight:600}
  .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
  .hint{color:#a6acd8;font-size:12px}
  .success{color:#7cffcc} .warn{color:#ffd27a} .error{color:#ff9a9a}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: Controls -->
    <section class="card">
      <h2>Step 0 · Connect to Supabase</h2>
      <label>Supabase URL</label>
      <input id="sb-url" type="text" autocomplete="off" />
      <label>Supabase ANON key</label>
      <textarea id="sb-key" class="mono"></textarea>
      <div class="row" style="margin-top:.5rem">
        <div style="flex:1">
          <label>Events view</label>
          <input id="sb-events" type="text" />
        </div>
        <div style="flex:1">
          <label>Products view</label>
          <input id="sb-products" type="text" />
        </div>
      </div>
      <div class="row" style="margin-top:.6rem">
        <button id="save" class="btn">Save</button>
        <button id="fetch" class="btn primary">Fetch live data</button>
        <button id="resetDefaults" class="btn ghost">Reset defaults</button>
      </div>

      <div style="height:10px"></div>
      <div class="stat">
        <div class="tag">Status</div><div id="status" class="mono warn">Not connected</div>
        <div class="tag">Events rows</div><div id="evCount" class="count mono">—</div>
        <div class="tag">Products rows</div><div id="prCount" class="count mono">—</div>
      </div>

      <div style="height:16px"></div>
      <h2>Step 1 (optional) · Landing Pages CSV</h2>
      <div class="row">
        <input id="landingCsv" type="file" accept=".csv" />
        <button id="loadLanding" class="btn">Upload</button>
      </div>
      <div class="hint">Used only as a fallback when direct matches are weak. Columns accepted: <span class="mono">url</span> and one of <span class="mono">url_meta_title | meta_title | title</span>.</div>

      <div style="height:16px"></div>
      <h2>Step 2 · Questions CSV</h2>
      <div class="row">
        <input id="qCsv" type="file" accept=".csv" />
        <button id="runSuite" class="btn">Run CSV Test Suite</button>
      </div>
      <div class="hint">Columns: <span class="mono">idx, query, expected</span>. Extra columns ignored.</div>

      <div style="height:16px"></div>
      <h2>Step 3 · Try a single query</h2>
      <div class="row">
        <input id="query" type="text" placeholder="e.g. ‘when is the next devon workshop?’" />
        <button id="run" class="btn primary">Run</button>
      </div>

      <div style="height:16px"></div>
      <div class="row">
        <button id="copyJson" class="btn">Copy JSON</button>
        <button id="copyLog" class="btn">Copy Log</button>
        <button id="downloadLog" class="btn">Download Log</button>
      </div>

      <div style="height:12px"></div>
      <div class="stat">
        <div class="tag">Intent</div><div id="intent" class="mono">—</div>
        <div class="tag">Reason</div><div id="reason" class="mono">—</div>
        <div class="tag">Confidence</div><div id="conf" class="mono">—%</div>
        <div class="tag">Landing CSV</div><div id="landingRows" class="mono">0 rows</div>
        <div class="tag">Questions CSV</div><div id="qRows" class="mono">0 rows</div>
      </div>
    </section>

    <!-- RIGHT: Results -->
    <section class="card">
      <div class="split">
        <div>
          <h2>Events</h2>
          <div id="events"></div>
        </div>
        <div>
          <h2>Articles</h2>
          <div id="articles"></div>
        </div>
        <div>
          <h2>Pills</h2>
          <div id="pills"></div>
        </div>
      </div>

      <div style="height:12px"></div>
      <h2>JSON</h2>
      <pre id="json" class="log mono">{}</pre>

      <div style="height:12px"></div>
      <h2>Execution Log</h2>
      <pre id="log" class="log mono"></pre>
    </section>
  </div>

<script>
/* ------------------------- CONFIG DEFAULTS ------------------------- */
/* These are the values you asked to be auto-filled. They’re also stored
   to localStorage after first load so you don’t need to touch them again. */
const DEFAULTS = {
  url: "https://igzvwbvgvmzvvzoclufx.supabase.co",
  anon: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnenZ3YnZndm16dnZ6b2NsdWZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2Nzc5MjgsImV4cCI6MjA3MzI1MzkyOH0.A9TCmnXKJhDRYBkrO0mAMPiUQeV9enweeyRWKWQ1SZY",
  eventsView: "ai_events",
  productsView: "ai_products"
};
/* ------------------------------------------------------------------ */

const els = {
  url: document.getElementById('sb-url'),
  key: document.getElementById('sb-key'),
  evView: document.getElementById('sb-events'),
  prView: document.getElementById('sb-products'),
  save: document.getElementById('save'),
  fetch: document.getElementById('fetch'),
  reset: document.getElementById('resetDefaults'),
  status: document.getElementById('status'),
  evCount: document.getElementById('evCount'),
  prCount: document.getElementById('prCount'),
  log: document.getElementById('log'),
  events: document.getElementById('events'),
  articles: document.getElementById('articles'),
  pills: document.getElementById('pills'),
  json: document.getElementById('json'),
  intent: document.getElementById('intent'),
  reason: document.getElementById('reason'),
  conf: document.getElementById('conf'),
  landingCsv: document.getElementById('landingCsv'),
  loadLanding: document.getElementById('loadLanding'),
  qCsv: document.getElementById('qCsv'),
  runSuite: document.getElementById('runSuite'),
  q: document.getElementById('query'),
  run: document.getElementById('run'),
  copyJson: document.getElementById('copyJson'),
  copyLog: document.getElementById('copyLog'),
  downloadLog: document.getElementById('downloadLog'),
  landingRows: document.getElementById('landingRows'),
  qRows: document.getElementById('qRows'),
};

let supa = null;
let cache = { events: [], products: [], landing: [] };

function log(s){ els.log.textContent += s + "\n"; els.log.scrollTop = els.log.scrollHeight; }

function saveSettings(){
  const s = {
    url: els.url.value.trim(),
    anon: els.key.value.trim(),
    eventsView: els.evView.value.trim(),
    productsView: els.prView.value.trim(),
  };
  localStorage.setItem('bench_settings', JSON.stringify(s));
  log("Saved settings.");
}

function loadSettings(){
  const saved = localStorage.getItem('bench_settings');
  const s = saved ? JSON.parse(saved) : DEFAULTS;
  els.url.value = s.url || DEFAULTS.url;
  els.key.value = s.anon || DEFAULTS.anon;
  els.evView.value = s.eventsView || DEFAULTS.eventsView;
  els.prView.value = s.productsView || DEFAULTS.productsView;
}

function resetDefaults(){
  localStorage.removeItem('bench_settings');
  loadSettings();
  log("Defaults restored.");
}

async function connect(){
  try{
    supa = window.supabase.createClient(els.url.value.trim(), els.key.value.trim(), { auth: { persistSession: false }});
    els.status.textContent = "Connecting…";
    log(`[${new Date().toISOString()}] Connecting to Supabase…`);
    // quick metadata ping by counting
    const { data: eCount, error: eErr } = await supa.from(els.evView.value.trim()).select('*', { count:'estimated', head:true });
    const { data: pCount, error: pErr } = await supa.from(els.prView.value.trim()).select('*', { count:'estimated', head:true });
    if(eErr || pErr){ throw eErr || pErr; }
    els.status.textContent = "Connected";
    els.status.classList.remove('warn','error'); els.status.classList.add('success');
    els.evCount.textContent = (eCount ?? '—');
    els.prCount.textContent = (pCount ?? '—');
    log("Connected. Ready.");
    return true;
  }catch(err){
    els.status.textContent = "Connection failed";
    els.status.classList.remove('warn','success'); els.status.classList.add('error');
    log("ERROR connecting: " + (err?.message || err));
    return false;
  }
}

async function fetchLive(){
  if(!supa){ const ok = await connect(); if(!ok) return; }
  els.events.innerHTML = els.articles.innerHTML = els.pills.innerHTML = "";
  els.json.textContent = "{}";
  try{
    log("Fetching sample events/products…");
    const { data: evs, error: e1 } = await supa.from(els.evView.value.trim()).select('*').limit(50);
    if(e1) throw e1;
    const { data: prs, error: e2 } = await supa.from(els.prView.value.trim()).select('*').limit(25);
    if(e2) throw e2;
    cache.events = evs || []; cache.products = prs || [];
    renderPreview();
    log(`Fetched ${cache.events.length} events, ${cache.products.length} products (preview).`);
  }catch(err){
    log("ERROR fetching live data: " + (err?.message || err));
  }
}

function renderPreview(){
  const eBox = document.createElement('div');
  cache.events.forEach((e,i)=>{
    const d = document.createElement('div');
    d.className = 'pill'; d.title = (e.when||'') + (e.location?(' · '+e.location):'');
    d.innerHTML = `<span class="title">${escapeHtml(e.title||'Untitled')}</span>`;
    eBox.appendChild(d);
  });
  els.events.innerHTML = ""; els.events.appendChild(eBox);

  const pBox = document.createElement('div');
  cache.products.forEach((p)=>{
    const d = document.createElement('div');
    d.className = 'pill'; d.title = p.tags || '';
    const price = (p.price!=null && p.price!=='') ? ` · £${p.price}` : '';
    d.innerHTML = `<span class="title">${escapeHtml(p.title||'Untitled')}</span><span class="tag">${price}</span>`;
    pBox.appendChild(d);
  });
  els.articles.innerHTML = ""; els.articles.appendChild(pBox);

  els.pills.innerHTML = `<span class="pill">Use Landing CSV fallback: <span class="tag">${cache.landing?.length||0} rows</span></span>`;
}

function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

/* ---------- Single query demo (very light ranking just for visibility) --------- */
function classifyIntent(q){
  const s = q.toLowerCase();
  const eventHints = ["when", "workshop", "date", "where", "devon","bluebell","batsford","peak district","book"];
  const adviceHints = ["how", "what", "why", "camera", "tripod", "settings", "long exposure","lightroom","certificate","free"];
  let eScore = 0, aScore = 0;
  eventHints.forEach(k=>{ if(s.includes(k)) eScore+=1; });
  adviceHints.forEach(k=>{ if(s.includes(k)) aScore+=1; });
  return eScore>=aScore ? {intent:"events", reason:`events=${eScore}, advice=${aScore}`} : {intent:"advice", reason:`advice=${aScore}, events=${eScore}`};
}

function scoreEvent(q, e){
  const t = (e.title||"") + " " + (e.location||"") + " " + (e.when||"");
  const s = q.toLowerCase(); const T=t.toLowerCase();
  let score = 0;
  s.split(/\s+/).forEach(w=>{ if(w.length>2 && T.includes(w)) score+=1; });
  if(T.includes(s)) score+=3; // phrase boost
  if((e.title||"").toLowerCase().includes("bluebell") && s.includes("bluebell")) score+=2;
  return score;
}

function runSingleQuery(){
  const q = els.q.value.trim();
  if(!q){ return; }
  const {intent, reason} = classifyIntent(q);
  els.intent.textContent = intent; els.reason.textContent = reason;

  if(intent==="events"){
    const ranked = [...cache.events].map(e=>({e,score:scoreEvent(q,e)})).sort((a,b)=>b.score-a.score).slice(0,12);
    const ev = ranked.filter(r=>r.score>0).map(r=>({
      date: r.e.when || null,
      when: r.e.when || null,
      title: r.e.title || "",
      location: r.e.location || "",
      url: r.e.url || r.e.permalink || ""
    }));
    const out = {
      idx: 1, query: q, expected: "events", detected: "events",
      counts: {events: ev.length, articles: 0, pills: cache.landing?.length?1:0},
      pass: true,
      used: { intent:"events", product:null, events: ev, articles: [], pills: cache.landing?.length? [{label:"Event Listing", url:"https://www.alanranger.com/search?query=workshops", brand:true}] : [] }
    };
    els.json.textContent = JSON.stringify([out], null, 2);
    els.conf.textContent = Math.min(100, 50 + (ev.length*5)).toFixed(0) + "%";
  }else{
    // advice placeholder: push some “articles” from products preview as a stand-in
    const arts = cache.products.slice(0,6).map(p=>({ title: p.title, url: p.url || p.permalink }));
    const out = {
      idx: 1, query: q, expected: "advice", detected: "advice",
      counts: {events: 0, articles: arts.length, pills: cache.landing?.length?1:0},
      pass: true,
      used: { intent:"advice", product:null, events: [], articles: arts, pills: cache.landing?.length? [{label:"Event Listing", url:"https://www.alanranger.com/search?query=workshops", brand:true}] : [] }
    };
    els.json.textContent = JSON.stringify([out], null, 2);
    els.conf.textContent = "85%";
  }
  log("Single query executed.");
}

/* --------------- CSV helpers (simple, tolerant) ------------------- */
function parseCsv(text){
  const rows = []; let header = null;
  text.split(/\r?\n/).forEach(line=>{
    if(!line.trim()) return;
    const cols = line.split(",").map(c=>c.trim().replace(/^"|"$/g,""));
    if(!header){ header = cols; }
    else{
      const obj = {}; header.forEach((h,i)=>obj[h]=cols[i]);
      rows.push(obj);
    }
  });
  return rows;
}

els.loadLanding.onclick = async ()=>{
  const f = els.landingCsv.files?.[0]; if(!f) return;
  const text = await f.text(); const rows = parseCsv(text);
  cache.landing = rows; els.landingRows.textContent = `${rows.length} rows`;
  log(`Landing CSV loaded (${rows.length} rows).`);
};
els.runSuite.onclick = async ()=>{
  const f = els.qCsv.files?.[0]; if(!f) return;
  const text = await f.text(); const rows = parseCsv(text);
  els.qRows.textContent = `${rows.length} rows`;
  log(`Questions CSV loaded (${rows.length} rows). Running simple pass…`);
  // very light demo: run first 5
  const results = [];
  for(let i=0;i<Math.min(5,rows.length);i++){
    els.q.value = rows[i].query || rows[i].q || '';
    runSingleQuery();
    results.push(JSON.parse(els.json.textContent)[0]);
  }
  els.json.textContent = JSON.stringify(results, null, 2);
  log("CSV mini-suite finished (first 5 rows).");
};

/* -------------------- Wiring & onload -------------------- */
els.save.onclick = ()=>{ saveSettings(); };
els.fetch.onclick = ()=>{ saveSettings(); connect().then(fetchLive); };
els.reset.onclick = ()=>{ resetDefaults(); };
els.run.onclick = ()=>{ runSingleQuery(); };
els.copyJson.onclick = ()=>{ navigator.clipboard.writeText(els.json.textContent || "{}"); log("JSON copied."); };
els.copyLog.onclick = ()=>{ navigator.clipboard.writeText(els.log.textContent || ""); };
els.downloadLog.onclick = ()=>{
  const blob = new Blob([els.log.textContent||""], {type:"text/plain"});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'bench-log.txt'; a.click();
  URL.revokeObjectURL(a.href);
};

(function bootstrap(){
  loadSettings();            // 1) load saved or defaults
  saveSettings();            // 2) persist once (if defaults)
  connect().then(fetchLive); // 3) auto-connect & fetch on load
  log(`[${new Date().toISOString()}] Ready. Auto-filled & connected. Upload Landing CSV (optional), Questions CSV, then Run query or CSV mini-suite.`);
})();
</script>
</body>
</html>
