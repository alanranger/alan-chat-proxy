<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BenchTest ‚Äì Events ‚Ä¢ Products ‚Ä¢ Articles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f13;
      --panel:#121820;
      --muted:#8aa0b2;
      --accent:#4cc3ff;
      --ok:#4ade80;
      --warn:#f59e0b;
      --card:#0f141b;
      --pill:#ff8a00;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      color:#e6eef6;
      background:linear-gradient(180deg, #0a0e13 0%, #0d131a 100%);
    }
    header{
      padding:18px 22px;
      display:flex;
      gap:14px;
      align-items:center;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(10,14,19,.6);
      position:sticky; top:0; backdrop-filter:saturate(130%) blur(8px);
      z-index:10;
    }
    header h1{font-size:16px;margin:0 8px 0 0;color:#cfe6fb;font-weight:650;letter-spacing:.3px}
    .hint{color:var(--muted);font-size:12px}
    .row{display:flex; gap:16px; align-items:stretch}
    .grow{flex:1}
    input[type="text"]{
      width:100%; padding:12px 14px; border-radius:12px; outline:none; border:1px solid rgba(255,255,255,.09);
      background:#0e141b; color:#e9f2fb; font-size:14px;
    }
    button{
      border:0; padding:12px 14px; border-radius:12px; color:#081018; background:var(--accent); font-weight:700; cursor:pointer;
      transition:all .12s ease; box-shadow:0 6px 18px rgba(76,195,255,.25);
    }
    button.secondary{background:#1f2a36;color:#cfe6fb;border:1px solid rgba(255,255,255,.08); box-shadow:none}
    button:hover{transform:translateY(-1px)}
    main{max-width:1300px;margin:24px auto;padding:0 20px}
    .grid{display:grid; grid-template-columns:2fr 2fr 2fr 2fr; gap:16px}
    .col-span-2{grid-column:span 2}
    .panel{
      background:var(--panel);
      border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius);
      overflow:hidden;
    }
    .panel h2{
      margin:0; padding:12px 14px; font-size:13px; letter-spacing:.35px; text-transform:uppercase;
      color:#c5d8ea; border-bottom:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg, #15202b 0%, #101722 100%);
    }
    .panel .content{padding:14px}
    .cards{display:grid; grid-template-columns:1fr; gap:10px}
    .card{
      padding:12px; border-radius:12px; background:var(--card); border:1px solid rgba(255,255,255,.06);
      display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center;
    }
    .title{font-weight:650}
    .sub{color:var(--muted); font-size:12px}
    .price{font-weight:800}
    .ok{color:var(--ok)}
    .muted{color:var(--muted)}
    a{color:#cfe6fb; text-decoration:none}
    a:hover{text-decoration:underline}
    .kvs{display:flex; flex-wrap:wrap; gap:6px}
    .pill{
      padding:8px 10px; border-radius:999px; background:var(--pill); color:#1a0e00; font-weight:700; font-size:12px;
      box-shadow:0 8px 22px rgba(255,138,0,.25);
    }
    .brand{background:linear-gradient(180deg,#ffc46b,#ff8a00)}
    pre{
      margin:0; padding:12px; border-radius:12px; background:#0a0f15; color:#ddecff; border:1px solid rgba(255,255,255,.06);
      white-space:pre-wrap; max-height:560px; overflow:auto; font-size:12px; line-height:1.35;
    }
    footer{max-width:1300px;margin:8px auto 26px;padding:0 20px;color:var(--muted);font-size:12px}
    .tag{padding:2px 8px;border:1px solid rgba(255,255,255,.12);border-radius:8px;font-size:11px;color:#9ad0ff}
    .stack{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  </style>
</head>
<body>
  <header>
    <h1>BenchTest</h1>
    <div class="row grow">
      <input id="q" type="text" placeholder="Ask something‚Ä¶  (e.g. ‚Äúwhens the next bluebell workshops and whats the cost‚Äù)">
      <button id="run">Run</button>
      <button id="load" class="secondary">Run bench-suite.json</button>
      <input id="file" type="file" accept="application/json" hidden />
    </div>
    <div class="hint">RPC-first ‚Ä¢ falls back to views</div>
  </header>

  <main class="grid">
    <section class="panel col-span-2">
      <h2>Events (dates &amp; when)</h2>
      <div class="content">
        <div id="events" class="cards"></div>
      </div>
    </section>

    <section class="panel col-span-2">
      <h2>Products (price lives here)</h2>
      <div class="content">
        <div id="products" class="cards"></div>
      </div>
    </section>

    <section class="panel col-span-2">
      <h2>Articles</h2>
      <div class="content">
        <div id="articles" class="cards"></div>
      </div>
    </section>

    <section class="panel col-span-2">
      <h2>Orange pills</h2>
      <div class="content">
        <div id="pills" class="kvs"></div>
      </div>
    </section>

    <section class="panel col-span-4">
      <h2>Result JSON</h2>
      <div class="content">
        <div class="stack" style="margin-bottom:8px">
          <span class="tag" id="latency">‚Äì ms</span>
          <span class="tag" id="mode">fallback?</span>
        </div>
        <pre id="json"></pre>
      </div>
    </section>
  </main>

  <footer>
    <div class="mono">
      Configure <strong>SUPABASE_URL</strong> and <strong>SUPABASE_ANON_KEY</strong> below.  
      Uses views: <em>ai_events, ai_products, ai_articles</em>.  
      Optional RPCs (preferred): <em>search_events(text[]), search_products(text[]), search_articles(text[])</em>.
    </div>
  </footer>

  <!-- Supabase client -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ---------- CONFIG ----------
    // üîß Replace these with your project values
    const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR-ANON-KEY";

    // Limits to mirror your bench
    const LIMITS = { events: 16, products: 104, articles: 95, pills: 8 };

    // ---------- INIT ----------
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- UTIL ----------
    const $ = (sel) => document.querySelector(sel);
    const nowIso = () => new Date().toISOString();
    const todayDate = () => new Date().toISOString().slice(0, 10); // YYYY-MM-DD
    const clean = (s='') => (s || '').toString().trim();
    const uniq = (arr, keyFn) => {
      const seen = new Set();
      return arr.filter(x => {
        const k = keyFn ? keyFn(x) : JSON.stringify(x);
        if (seen.has(k)) return false;
        seen.add(k);
        return true;
      });
    };
    const scoreContains = (text, kws) => {
      const t = (text || '').toLowerCase();
      return kws.reduce((acc, kw) => acc + (t.includes(kw) ? 1 : 0), 0);
    };

    function kwTokens(q){
      const raw = clean(q).toLowerCase();
      // split on non-letters, keep useful tokens only
      let kws = raw.split(/[^a-z0-9]+/g).filter(w => w.length >= 3);
      // tiny heuristic: de-plural ‚Äúbluebells‚Äù -> ‚Äúbluebell‚Äù
      kws.forEach(k => { if(k.endsWith('s')) kws.push(k.slice(0,-1)); });
      // keep unique
      kws = Array.from(new Set(kws));
      return kws.length ? kws : ['workshop']; // fallback token
    }

    // Builds an OR expression for PostgREST .or(...) like:
    // 'title.ilike.%kw1%,url.ilike.%kw1%,title.ilike.%kw2%,url.ilike.%kw2%'
    const orExpr = (cols, kws) =>
      kws.map(kw => cols.map(c => `${c}.ilike.*${encodeURIComponent(kw)}*`).join(',')).join(',');

    // ---------- RPC HELPERS ----------
    async function tryRpc(name, args){
      try {
        const t0 = performance.now();
        const { data, error } = await sb.rpc(name, args);
        const dt = Math.round(performance.now() - t0);
        if(error) return { ok:false, data:null, ms:dt, err:error.message };
        return { ok:true, data, ms:dt };
      } catch(e){
        return { ok:false, data:null, ms:0, err:e.message };
      }
    }

    // ---------- FALLBACK QUERIES ----------
    async function fbEvents(kws){
      const t0 = performance.now();
      // Filter by title hit first (ai_events columns from your view)
      const { data, error } = await sb
        .from('ai_events')
        .select('title,url,when,location,start_date,date_start,date_end')
        .or(orExpr(['title'], kws))
        .order('date_start', { ascending:true, nullsFirst:false })
        .order('start_date', { ascending:true, nullsFirst:false })
        .limit(Math.max(LIMITS.events, 60));
      const ms = Math.round(performance.now() - t0);
      if(error) return { ok:false, data:[], ms, err:error.message };

      // Keep upcoming only using client-side coalesce
      const now = new Date();
      const rows = (data||[]).filter(r => {
        const ts = r.date_start ? new Date(r.date_start) :
                   r.start_date ? new Date(r.start_date) : null;
        return ts && ts >= now;
      });

      // Score by keyword relevance; then by soonest
      rows.forEach(r => r._score = scoreContains(`${r.title} ${r.url} ${r.location}`, kws));
      rows.sort((a,b) => (b._score - a._score) || (new Date(a.date_start||a.start_date) - new Date(b.date_start||b.start_date)));
      return { ok:true, data: rows.slice(0, LIMITS.events), ms };
    }

    async function fbProducts(kws){
      const t0 = performance.now();
      const { data, error } = await sb
        .from('ai_products')
        .select('title,url,price,tags')
        .or(orExpr(['title','url'], kws))
        .limit(Math.max(LIMITS.products, 200));
      const ms = Math.round(performance.now() - t0);
      if(error) return { ok:false, data:[], ms, err:error.message };

      const listPatterns = [
        '/photography-workshops-near-me',
        '/one-day-landscape-photography-workshops',
        '/landscape-photography-workshops'
      ];

      const rows = (data||[]).map(r => {
        const base = scoreContains(`${r.title} ${r.url}`, kws);
        const isList = listPatterns.some(p => r.url.includes(p));
        const priceBoost = (r.price ?? null) !== null ? 1 : 0; // prefer price
        r._score = base + priceBoost - (isList ? 2 : 0);
        return r;
      });

      // Sort: higher score, then by having price, then price ascending
      rows.sort((a,b) => (b._score - a._score)
        || ((a.price==null)-(b.price==null))
        || ((a.price ?? Infinity) - (b.price ?? Infinity)));

      return { ok:true, data: rows.slice(0, LIMITS.products), ms };
    }

    async function fbArticles(kws){
      const t0 = performance.now();
      const { data, error } = await sb
        .from('ai_articles')
        .select('title,url,snippet,kind')
        .or(orExpr(['title','snippet'], kws))
        .limit(Math.max(LIMITS.articles, 200));
      const ms = Math.round(performance.now() - t0);
      if(error) return { ok:false, data:[], ms, err:error.message };

      (data||[]).forEach(r => r._score = scoreContains(`${r.title} ${r.snippet}`, kws));
      data.sort((a,b) => (b._score - a._score) || (clean(a.title).localeCompare(clean(b.title))));
      return { ok:true, data: data.slice(0, LIMITS.articles), ms };
    }

    // ---------- SEARCH PIPE ----------
    async function fetchEvents(kws){
      const rpc = await tryRpc('search_events', { kws });
      if(rpc.ok && Array.isArray(rpc.data)) { lastModes.events = `rpc (${rpc.ms}ms)`; return rpc.data.slice(0, LIMITS.events); }
      const fb = await fbEvents(kws); lastModes.events = `view (${fb.ms}ms)`;
      return fb.data;
    }
    async function fetchProducts(kws){
      const rpc = await tryRpc('search_products', { kws });
      if(rpc.ok && Array.isArray(rpc.data)) { lastModes.products = `rpc (${rpc.ms}ms)`; return rpc.data.slice(0, LIMITS.products); }
      const fb = await fbProducts(kws); lastModes.products = `view (${fb.ms}ms)`;
      return fb.data;
    }
    async function fetchArticles(kws){
      // You already created public.search_articles(kws text[])
      const rpc = await tryRpc('search_articles', { kws });
      if(rpc.ok && Array.isArray(rpc.data)) { lastModes.articles = `rpc (${rpc.ms}ms)`; return rpc.data.slice(0, LIMITS.articles); }
      const fb = await fbArticles(kws); lastModes.articles = `view (${fb.ms}ms)`;
      return fb.data;
    }

    function buildPills(q){
      const pills = [
        { label:'Blog',          url:'https://www.alanranger.com/blog-on-photography', brand:true },
        { label:'Newsletter',    url:'https://www.alanranger.com/newsletter-signup-form', brand:true },
        { label:'Gift Vouchers', url:'https://www.alanranger.com/photography-gift-vouchers', brand:true },
        { label:'Payment Plan',  url:'https://www.alanranger.com/photography-payment-plan', brand:true },
        { label:'Event Listing', url:'https://www.alanranger.com/search?query=workshops', brand:true },
        { label:'Course Finder', url:'https://www.alanranger.com/course-finder-photography-classes-near-me', brand:true },
        { label:'Home',          url:'https://www.alanranger.com', brand:true },
      ];
      const sq = encodeURIComponent(clean(q));
      pills.push({ label:`Search site: ‚Äú${clean(q)}‚Äù`, url:`https://www.alanranger.com/search?query=${sq}`, brand:false });
      return pills.slice(0, LIMITS.pills);
    }

    function toWhen(e){
      // ai_events exposes a pretty string `when`; if not, format from date_(start|end)
      if(clean(e.when)) return e.when;
      const a = e.date_start ? new Date(e.date_start) : (e.start_date ? new Date(e.start_date) : null);
      if(!a) return '';
      return a.toUTCString().slice(0,11); // e.g. "Sat, 24 Aug"
    }

    // ---------- RENDER ----------
    function renderList(rootSel, rows, kind){
      const root = $(rootSel);
      root.innerHTML = '';
      if(!rows || !rows.length){ root.innerHTML = `<div class="muted">No ${kind} found.</div>`; return; }

      const frag = document.createDocumentFragment();
      rows.forEach(r => {
        const card = document.createElement('div');
        card.className = 'card';
        const left = document.createElement('div');

        const title = document.createElement('div');
        title.className = 'title';
        title.innerHTML = `<a href="${r.url}" target="_blank" rel="noopener">${clean(r.title) || clean(r.url)}</a>`;

        const sub = document.createElement('div');
        sub.className = 'sub';
        if(kind==='events'){
          sub.textContent = `${toWhen(r)}${clean(r.location) ? ' ‚Ä¢ ' + r.location : ''}`;
        } else if(kind==='products'){
          sub.textContent = clean(r.tags || '');
        } else if(kind==='articles'){
          sub.textContent = clean(r.snippet || '').slice(0, 180);
        }

        left.appendChild(title);
        left.appendChild(sub);
        card.appendChild(left);

        const right = document.createElement('div');
        if(kind==='products'){
          const price = r.price==null ? '‚Äî' : (Number(r.price).toFixed(0));
          right.innerHTML = `<span class="price">${price === '‚Äî' ? '<span class="muted">¬£‚Äî</span>' : '¬£'+price}</span>`;
        } else if(kind==='events'){
          // events intentionally have no price ‚Äì price lives in products
          right.innerHTML = `<span class="muted">when</span>`;
        } else {
          right.innerHTML = `<span class="muted">${clean(r.kind||'article')}</span>`;
        }
        card.appendChild(right);

        frag.appendChild(card);
      });
      root.appendChild(frag);
    }

    function renderPills(pills){
      const root = $('#pills');
      root.innerHTML = '';
      for(const p of pills){
        const a = document.createElement('a');
        a.className = `pill ${p.brand?'brand':''}`;
        a.href = p.url; a.target = '_blank'; a.rel='noopener';
        a.textContent = p.label;
        root.appendChild(a);
      }
    }

    function renderJSON(obj){
      $('#json').textContent = JSON.stringify(obj, null, 2);
    }

    const lastModes = { events:'', products:'', articles:'' };

    async function runOnce(q){
      const t0 = performance.now();
      const kws = kwTokens(q);

      const [events, products, articles] = await Promise.all([
        fetchEvents(kws),
        fetchProducts(kws),
        fetchArticles(kws),
      ]);

      const pills = buildPills(q);

      // Compose bench-style JSON
      const result = {
        q: q,
        intent: 'events', // default bucket for these queries
        counts: {
          events: events.length,
          products: products.length,
          articles: articles.length,
          pills: pills.length
        },
        events: events.map(e => ({
          title: e.title, url: e.url, when: toWhen(e), location: e.location || null,
          start_date: e.start_date ?? null, date_start: e.date_start ?? null, date_end: e.date_end ?? null
        })),
        products: products.map(p => ({
          title: p.title, url: p.url, price: p.price ?? null, tags: p.tags ?? null
        })),
        articles: articles.map(a => ({
          title: a.title, url: a.url, snippet: a.snippet ?? '', kind: a.kind ?? 'article'
        })),
        pills: pills.map(pl => ({ label: pl.label, url: pl.url, brand: !!pl.brand }))
      };

      // Render UI
      renderList('#events', events, 'events');
      renderList('#products', products, 'products');
      renderList('#articles', articles, 'articles');
      renderPills(pills);
      renderJSON(result);

      // Meta
      const ms = Math.round(performance.now() - t0);
      $('#latency').textContent = `${ms} ms`;
      $('#mode').textContent = `events=${lastModes.events} ‚Ä¢ products=${lastModes.products} ‚Ä¢ articles=${lastModes.articles}`;
    }

    // ---------- BENCH SUITE ----------
    async function runSuite(file){
      const text = await file.text();
      const suite = JSON.parse(text);
      const items = Array.isArray(suite) ? suite : (suite.tests || []);
      if(!items || !items.length){ alert('No tests found in JSON. Expect array of {q: "..."}'); return; }
      for(const t of items){
        await runOnce(t.q || '');
      }
    }

    // ---------- WIRE ----------
    $('#run').addEventListener('click', () => runOnce($('#q').value));
    $('#q').addEventListener('keydown', (e) => { if(e.key==='Enter') runOnce($('#q').value); });
    $('#load').addEventListener('click', () => $('#file').click());
    $('#file').addEventListener('change', e => {
      const f = e.target.files?.[0]; if(f) runSuite(f);
    });

    // Example placeholder to nudge the first run
    $('#q').value = 'whens the next bluebell workshops and whats the cost';
  </script>
</body>
</html>
