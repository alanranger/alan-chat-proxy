<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Bench Test — Single File</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{--bg:#0b0e12;--fg:#e9eef5;--muted:#a7b3c4;--card:#121722;--accent:#8dd0ff;--good:#4cd964;--warn:#ffcc00;--bad:#ff4d4f;--brand:#ff7a00}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{padding:16px 20px;border-bottom:1px solid #1c2230;display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    header h1{font-size:18px;margin:0}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#182033;border:1px solid #243149;font-size:12px;color:var(--muted)}
    .conf{cursor:help}
    main{padding:16px;display:grid;grid-template-columns:360px 1fr;gap:16px}
    .card{background:var(--card);border:1px solid #1c2230;border-radius:12px;padding:14px}
    .card h2{margin:0 0 8px;font-size:14px;color:#d9e2ef;letter-spacing:.25px}
    .input-row{display:flex;gap:8px}
    input[type="text"]{width:100%;background:#0f1420;color:var(--fg);border:1px solid #223049;border-radius:10px;padding:10px 12px;font-size:14px}
    button{background:#1b66ff;border:0;color:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    button.secondary{background:#27344a}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{border:1px solid #1e2637;border-radius:10px;padding:10px;background:#0f1420}
    .item .title{font-weight:600;color:#dfe9f7}
    .item .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap}
    .tag{font-size:10px;border:1px solid #2f3b54;background:#141b29;border-radius:6px;padding:2px 6px;color:#9fb3d1}
    .ok{color:var(--good)} .mid{color:var(--warn)} .low{color:var(--bad)}
    .tooltip {position:relative;display:inline-block}
    .tooltip .tiptext{visibility:hidden;opacity:0;transition:opacity .15s;width:280px;background:#0f1420;color:#e9eef5;text-align:left;border-radius:8px;padding:10px;border:1px solid #25324b;position:absolute;z-index:1;top:120%;left:0;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .tooltip:hover .tiptext{visibility:visible;opacity:1}
    .btnline{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    a.btn{color:#fff;text-decoration:none;background:#1b66ff;border-radius:8px;padding:6px 10px;font-weight:600}
    a.btn.brand{background:var(--brand)}
    .kvs{display:grid;grid-template-columns:160px 1fr;gap:6px;font-size:12px;color:#c7d4e8}
    .kvs b{color:#eef5ff}
    progress{width:100%;height:10px}
  </style>
</head>
<body>
<header>
  <h1>Bench Test</h1>
  <span class="pill">Single-file · bench-only</span>
  <span class="pill">Landing CSV fallback</span>
  <span class="pill">Generic search pills: <b style="color:#ff7a00;margin-left:4px;">disabled</b></span>
  <span id="conf-pill" class="pill conf tooltip">Confidence: —%
    <span id="conf-tip" class="tiptext">Score breakdown will appear here.</span>
  </span>
</header>

<main>
  <section class="card">
    <h2>Query</h2>
    <div class="input-row">
      <input id="q" type="text" placeholder="Ask e.g. 'when is the next devon workshop'"/>
      <button id="run">Run</button>
    </div>

    <div class="btnline">
      <button class="secondary" id="runBuiltIn">Run Built-in Suite</button>
      <button class="secondary" id="copyJson">Copy JSON</button>
      <button class="secondary" id="btnLoadLanding">Upload Landing CSV</button>
      <button class="secondary" id="btnLoadQuestions">Upload Questions CSV</button>
      <button class="secondary" id="runCSV">Run CSV Test Suite</button>
    </div>

    <input id="landingFile" type="file" accept=".csv" style="display:none"/>
    <input id="questionsFile" type="file" accept=".csv" style="display:none"/>

    <div style="margin-top:12px">
      <h2 style="margin:0 0 6px">Status</h2>
      <div class="kvs">
        <div>Intent</div><div id="intent"></div>
        <div>Reason</div><div id="intentWhy" class="mono"></div>
        <div>Landing CSV</div><div id="csvStatus">not loaded</div>
        <div>Questions CSV</div><div id="qsStatus">not loaded</div>
        <div>CSV Progress</div><div><progress id="qsProg" max="100" value="0"></progress> <span id="qsProgTxt"></span></div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Results</h2>
    <div class="row">
      <span class="tag">No generic /search?query pills used</span>
      <span class="tag">Product↔event stitching</span>
      <span class="tag">Advice ranking w/ phrase boost</span>
    </div>
    <div style="margin-top:10px" class="grid">
      <div>
        <h2 style="margin:0 0 6px">Events</h2>
        <div id="events" class="list"></div>
      </div>
      <div>
        <h2 style="margin:0 0 6px">Articles</h2>
        <div id="articles" class="list"></div>
      </div>
    </div>

    <div style="margin-top:10px">
      <h2 style="margin:0 0 6px">Pills</h2>
      <div id="pills" class="row"></div>
    </div>

    <div style="margin-top:10px">
      <h2 style="margin:0 0 6px">JSON</h2>
      <pre id="json" class="mono" style="max-height:420px;overflow:auto;"></pre>
    </div>
  </section>
</main>

<script>
/* ==========================
   Config (bench only)
   ========================== */
const EVENT_LISTING_URL = "https://www.alanranger.com/photographic-workshops-near-me";
const PHOTOS_URL = "https://www.alanranger.com/gallery-image-portfolios";

/* ==========================
   CSV Helpers
   ========================== */
function parseCSV(text){
  const lines = text.split(/\r?\n/);
  if(!lines.length) return [];
  // join lines that include quoted commas
  const rows=[]; let acc=""; let inQ=false;
  for(const ln of lines){
    let l=ln;
    for(let i=0;i<l.length;i++){
      if(l[i]==='"'){ if(l[i+1]==='"'){i++;} else inQ=!inQ; }
    }
    acc += (acc? "\n":"") + l;
    if(!inQ){ rows.push(acc); acc=""; }
  }
  const header = splitCSVLine(rows.shift()||"").map(s=>s.trim());
  return rows.filter(Boolean).map(r=>{
    const cols = splitCSVLine(r);
    const obj={};
    header.forEach((h,i)=>obj[h]= (cols[i]??"").replace(/^"|"$/g,""));
    return obj;
  });
}
function splitCSVLine(line){
  const out=[]; let cur=""; let q=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='"'){ if(q && line[i+1]==='"'){cur+='"';i++;} else {q=!q;} }
    else if(c===',' && !q){ out.push(cur);cur=""; }
    else cur+=c;
  }
  out.push(cur);
  return out;
}

/* ==========================
   Tiny utils
   ========================== */
const toLower = s => (s||"").toLowerCase();
const normWS = s => (s||"").replace(/\s+/g," ").trim();
const uniq = a => Array.from(new Set(a));
function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));}

/* ==========================
   Intent classifier
   ========================== */
function classifyIntent(q){
  const s = toLower(q);
  const evWords = ["when","date","next","where","cost","price","workshop","event","available","booking","book","devon","lake district","yorkshire","dartmoor","kenilworth","warwickshire","peak district","bluebell"];
  const adWords = ["how","what is","recommend","do i need","certificate","free","b&b","accommodation","residential","age","laptop","tripod","long exposure","astrophotography course","advice","camera do i need"];
  let ev=0, ad=0;
  evWords.forEach(w=>{ if(s.includes(w)) ev+=(w.length>6?2:1); });
  adWords.forEach(w=>{ if(s.includes(w)) ad+=(w.length>6?2:1); });
  if(/\b(when|what|where)\b.*\b(workshop|event)\b/.test(s)) ev+=2;
  if(/\b(what is|how to|how do i|recommend)\b/.test(s)) ad+=2;
  if(/\b(b&b|bed.*breakfast|accommodation|residential)\b/.test(s)) ad+=3;
  const intent = ev>=ad ? "events" : "advice";
  const margin = Math.abs(ev-ad);
  const confidence = Math.min(95, 50 + margin*10);
  return { intent, confidence, reason:`events=${ev}, advice=${ad}` };
}

/* ==========================
   Scoring helpers
   ========================== */
function tokenSet(s){ return uniq(normWS(s||"").toLowerCase().replace(/[^\w\s]+/g," ").split(/\s+/).filter(Boolean)); }
function escapeReg(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');}
function scoreDoc(query, fields){
  const q = normWS(query).toLowerCase();
  const qTokens = tokenSet(q);
  const text = (fields||[]).map(normWS).join(" ").toLowerCase();
  let score=0;
  if(q.length>3 && text.includes(q)) score+=12;
  qTokens.forEach(t=>{
    const tf = (text.match(new RegExp("\\b"+escapeReg(t)+"\\b","g"))||[]).length;
    if(!tf) return;
    const idf = 1 + Math.log(1 + 20/(1+(text.split(t).length-1)));
    score += tf*idf;
  });
  if(/\blong exposure\b/.test(q) && /long\s*exposure/.test(text)) score += 8;
  if(/\bbluebell/.test(q) && /bluebell/.test(text)) score += 10;
  if(/\bresidential|b&b|bed.*breakfast/.test(q) && /(residential|accommodation|b&b)/.test(text)) score += 6;
  return score;
}

/* ==========================
   Product↔Event stitching
   ========================== */
function baseKeyFromUrl(u){
  try{
    const last = new URL(u).pathname.split("/").filter(Boolean).pop() || "";
    return last.replace(/-\d{1,2}-\d{1,2}$/,"").replace(/-\d{2,4}$/,"").replace(/-\w{3,5}\d+$/,"");
  }catch(e){ return u; }
}
function groupEventsByProduct(events){
  const map=new Map();
  (events||[]).forEach(ev=>{
    const key=baseKeyFromUrl(ev.url);
    const g=map.get(key)||{productUrl:ev.url,title:ev.title,events:[]};
    g.events.push(ev); map.set(key,g);
  });
  return [...map.values()];
}

/* ==========================
   Landing & Questions CSV (uploaded)
   ========================== */
let LANDINGS=[]; // {url, meta_title, intents[]}
let QUESTIONS=[]; // [{query, expected?}]
function loadLandingFromFile(file){
  const reader=new FileReader();
  reader.onload=()=>{
    const rows=parseCSV(reader.result||"");
    LANDINGS = rows.map(r=>({
      url: r.url||"",
      meta_title: r.meta_title||r.title||"",
      intents: (r.intents||"").split("|").map(s=>s.trim()).filter(Boolean)
    })).filter(r=>r.url && r.meta_title);
    document.getElementById("csvStatus").textContent = `loaded ${LANDINGS.length} rows`;
  };
  reader.readAsText(file);
}
function loadQuestionsFromFile(file){
  const reader=new FileReader();
  reader.onload=()=>{
    const rows=parseCSV(reader.result||"");
    QUESTIONS = rows.map(r=>{
      const q = r.query || r.question || r.prompt || r.text || "";
      const expected = r.expected || r.expected_intent || r.intent || "";
      return { query: normWS(q), expected: normWS(expected) };
    }).filter(r=>r.query);
    document.getElementById("qsStatus").textContent = `loaded ${QUESTIONS.length} rows`;
  };
  reader.readAsText(file);
}
function bestLandingFor(query,intent){
  if(!LANDINGS.length) return null;
  const scored = LANDINGS.map(row=>{
    const s = scoreDoc(query,[row.meta_title,row.url]) + (row.intents.includes(intent)?2:0);
    return {row, s};
  }).sort((a,b)=>b.s-a.s);
  return scored[0]?.row || null;
}

/* ==========================
   Collectors adapter (uses your bench fetchers if present)
   ========================== */
async function collectCandidates(query){
  if (window.benchCollectors && typeof window.benchCollectors==="function"){
    try { return await window.benchCollectors(query); } catch(e){}
  }
  return { events: [], articles: [] };
}

/* ==========================
   Ranking & confidence
   ========================== */
function rankEvents(query, events){
  const now=Date.now();
  return (events||[]).map(e=>{
    let s=scoreDoc(query,[e.title,e.location,e.url]);
    if(/\b(next|when|soon|nearest)\b/i.test(query) && e.date){
      const t = Date.parse(e.date) || Date.parse(e.when) || 0;
      if(t>now) s += 10 * (1/Math.max(1,(t-now)/(1000*60*60*24*30)));
    }
    const q=query.toLowerCase();
    if(e.location && q.includes(e.location.toLowerCase())) s += 6;
    if(q.includes("devon") && /devon/i.test(e.location + " " + e.title + " " + e.url)) s += 8;
    if(q.includes("bluebell") && /bluebell/i.test(e.title + " " + e.url)) s += 10;
    return {e,s};
  }).sort((a,b)=>b.s-a.s).map(x=>x.e);
}
function rankArticles(query, arts){
  return (arts||[]).map(a=>({a,s:scoreDoc(query,[a.title,a.url])}))
                    .sort((a,b)=>b.s-a.s).map(x=>x.a);
}
function confidenceScore(query,intent,evs,arts){
  const cls=classifyIntent(query);
  let score=Math.min(95,cls.confidence);
  function gap(list, scorer){
    if(list.length<2) return 15;
    const s0=scorer(list[0]); const s1=scorer(list[1]); const g=Math.max(0,s0-s1);
    return Math.min(25,g);
  }
  if(intent==="events"){ score+=gap(evs, e=>scoreDoc(query,[e.title,e.location,e.url])); }
  else { score+=gap(arts, a=>scoreDoc(query,[a.title,a.url])); }
  const phrase=normWS(query).toLowerCase();
  const text=(intent==="events"?evs:arts).slice(0,1).map(x=>intent==="events"?(x.title+" "+x.url):(x.title+" "+x.url)).join(" ").toLowerCase();
  if(phrase && text.includes(phrase)) score+=8;
  score=Math.max(0,Math.min(99,Math.round(score)));
  const band=score>=80?"high":score>=60?"medium":"low";
  return {score,band,why:`intent=${cls.confidence}`};
}

/* ==========================
   Pills
   ========================== */
function buildPills(intent, rankedEvents, rankedArticles, query){
  const pills=[];
  if(rankedEvents.length){
    const groups=groupEventsByProduct(rankedEvents);
    const g = groups.find(G=>G.events.some(ev=>ev.url===rankedEvents[0].url)) || groups[0];
    pills.push({label:"Book Now", url:g?.productUrl||rankedEvents[0].url, brand:true});
  }
  pills.push({label:"Event Listing", url:EVENT_LISTING_URL, brand:true});
  const landing=bestLandingFor(query,intent);
  if(landing) pills.push({label:"More Articles", url:landing.url, brand:true});
  pills.push({label:"Photos", url:PHOTOS_URL, brand:false});
  return pills.filter(p=>!/\/search\?query=/.test(p.url));
}

/* ==========================
   Run one query
   ========================== */
async function runOne(query){
  const cls=classifyIntent(query);
  document.getElementById("intent").textContent=cls.intent;
  document.getElementById("intentWhy").textContent=cls.reason;

  const raw=await collectCandidates(query);
  const events = cls.intent==="events" ? rankEvents(query, raw.events||[]) : (raw.events||[]);
  const articles = rankArticles(query, raw.articles||[]);

  const conf=confidenceScore(query,cls.intent,events,articles);
  const confPill=document.getElementById("conf-pill");
  confPill.textContent=`Confidence: ${conf.score}%`;
  confPill.classList.remove("ok","mid","low");
  confPill.classList.add(conf.band==="high"?"ok":conf.band==="medium"?"mid":"low");
  document.getElementById("conf-tip").innerHTML =
    `<b>How this is calculated</b><br/>• Intent certainty: ${classifyIntent(query).confidence}%<br/>• Rank gap & phrase evidence<br/><i>Band:</i> ${conf.band}`;

  const pills = buildPills(cls.intent, events, articles, query);
  const citations = uniq([ ...events.slice(0,12).map(e=>e.url), ...articles.slice(0,10).map(a=>a.url) ]);

  const out={
    idx:1, query, expected:cls.intent, detected:cls.intent,
    counts:{events:events.length,articles:articles.length,pills:pills.length},
    pass:true,
    used:{
      intent:cls.intent,
      product:null,
      events:events.slice(0,12).map(e=>({date:e.date||e.when||null,when:e.when||e.date||null,title:e.title,location:e.location||"",url:e.url})),
      articles:articles.slice(0,10).map(a=>({title:a.title,url:a.url})),
      pills, citations
    },
    confidence:conf.score
  };

  renderList("events", out.used.events, "event");
  renderList("articles", out.used.articles, "article");
  renderPills("pills", pills);
  document.getElementById("json").textContent = JSON.stringify(out,null,2);
  window.__BENCH_LAST__ = out;
  return out;
}

function renderList(id, arr, kind){
  const el=document.getElementById(id); el.innerHTML="";
  arr.forEach(o=>{
    const div=document.createElement("div"); div.className="item";
    div.innerHTML=`<div class="title">${escapeHtml(o.title||"(untitled)")}</div>
      <div class="sub">${kind==="event"? escapeHtml([o.when,o.location].filter(Boolean).join(" — ")):""}</div>
      <div class="sub"><a href="${o.url}" target="_blank">${o.url}</a></div>`;
    el.appendChild(div);
  });
}
function renderPills(id,pills){
  const el=document.getElementById(id); el.innerHTML="";
  pills.forEach(p=>{
    const a=document.createElement("a");
    a.className="btn"+(p.brand?" brand":""); a.href=p.url; a.target="_blank"; a.textContent=p.label;
    el.appendChild(a);
  });
}

/* ==========================
   Built-in tests
   ========================== */
const BUILTIN = [
  "whens the next bluebell workshops and whats the cost",
  "when is the next devon workshop",
  "what is your next workshop date and where is it",
  "when are your next Autumn workshops and where are they?",
  "How much is a residential photography course and does it include B&B",
  "What tripod do you recommend",
  "Do you I get a certificate with the photography course",
  "What sort of camera do I need for your camera course",
  "Do I need a laptop for the lightroom course",
  "Do you do astrophotography workshops",
  "How do I get personalised feedback on my images",
  "Is the online photography course really free",
  "Can my 14yr old attend your workshop",
  "What is long exposure and how can I find out more about it",
  "My pictures never seem sharp.  Can you advise on what I am doing wrong"
];

/* ==========================
   UI wiring
   ========================== */
document.getElementById("run").addEventListener("click", ()=> runOne(document.getElementById("q").value||""));

document.getElementById("runBuiltIn").addEventListener("click", async ()=>{
  const outs=[]; for(const q of BUILTIN){ outs.push(await runOne(q)); }
  document.getElementById("json").textContent = JSON.stringify(outs,null,2);
});

document.getElementById("copyJson").addEventListener("click", ()=>{
  const txt=document.getElementById("json").textContent;
  navigator.clipboard.writeText(txt);
});

document.getElementById("btnLoadLanding").addEventListener("click", ()=> document.getElementById("landingFile").click());
document.getElementById("landingFile").addEventListener("change", (e)=>{
  const f=e.target.files?.[0]; if(f) loadLandingFromFile(f);
});

document.getElementById("btnLoadQuestions").addEventListener("click", ()=> document.getElementById("questionsFile").click());
document.getElementById("questionsFile").addEventListener("change", (e)=>{
  const f=e.target.files?.[0]; if(f) loadQuestionsFromFile(f);
});

document.getElementById("runCSV").addEventListener("click", async ()=>{
  const qs=QUESTIONS.slice(); if(!qs.length){ alert("Load a Questions CSV first."); return; }
  const prog=document.getElementById("qsProg"); const txt=document.getElementById("qsProgTxt");
  const outs=[]; let pass=0;
  prog.value=0; prog.max=qs.length; txt.textContent=`0 / ${qs.length}`;
  for(let i=0;i<qs.length;i++){
    const q=qs[i].query; const expected=qs[i].expected;
    const res=await runOne(q);
    if(expected){
      const want=expected.toLowerCase();
      const got=res.detected.toLowerCase();
      res.pass = (want===got);
      res.expected = expected;
      if(res.pass) pass++;
    }
    outs.push(res);
    prog.value=i+1; txt.textContent=`${i+1} / ${qs.length}  ${expected?`(pass ${pass})`:""}`;
  }
  document.getElementById("json").textContent = JSON.stringify(outs,null,2);
});
</script>
</body>
</html>
