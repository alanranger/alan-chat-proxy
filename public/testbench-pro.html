<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Testbench Pro – Chat.js vs RPC + CSV Runner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0b1220; --panel:#0f172a; --line:#1b2540; --text:#dbe4ff; --muted:#9fb3ff; --orange:#E57200; --good:#34d399; --bad:#f87171; --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; --sans: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial }
    *{box-sizing:border-box} body{background:var(--bg);color:var(--text);font:14px/1.5 var(--sans);margin:0;padding:24px}
    .row{display:flex;gap:16px;flex-wrap:wrap}.col{flex:1;min-width:320px}.card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:16px}
    input,button,select,textarea{background:#0b1220;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px}
    a{color:#ffd18a;text-decoration:underline} a:hover{color:#ffb24d}
    table{width:100%;border-collapse:collapse;font-size:13px} th,td{border-top:1px solid var(--line);padding:6px 8px;vertical-align:top} th{color:var(--muted)}
    .badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#0b1220;border:1px solid var(--line);font-size:12px}
    .good{border-color:#1e3a2a;color:#86efac}.bad{border-color:#3a1e1e;color:#fecaca}
    .table-wrap{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:8px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);margin-right:8px;font-weight:600}
    .pill.good{background:#122417;color:#86efac;border-color:#1e3a2a}
    .pill.warn{background:#241f12;color:#fde68a;border-color:#3a2f1e}
    .pill.bad{background:#3a1e1e;color:#fecaca;border-color:#4c1f1f}
    .layout{display:grid;grid-template-columns:320px 1fr;gap:16px}
    .list{max-height:520px;overflow:auto;border:1px solid var(--line);border-radius:8px}
    .list-item{padding:8px;border-top:1px solid var(--line);cursor:pointer}
    .list-item:hover{background:#0b1220}
    .answer{background:#0b1220;border:1px solid var(--line);border-radius:8px;padding:12px;white-space:pre-wrap}
    .kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
  </style>
</head>
<body>
  <header class="row">
    <div class="col"><h1>Testbench Pro</h1><div class="badge">Chat vs RPC + CSV Assertions</div></div>
  </header>

  <!-- Dashboard KPIs -->
  <section class="row" id="kpiRow">
    <div class="col card">
      <h3>Overview</h3>
      <div class="kpis" id="kpiWrap">
        <span class="pill" id="kpiTotal">Total: 0</span>
        <span class="pill" id="kpiAvg">Avg Confidence: 0.00</span>
        <span class="pill" id="kpiIntentAdvice">Advice: 0</span>
        <span class="pill" id="kpiIntentEvents">Events: 0</span>
        <span class="pill" id="kpiIntentProducts">Products: 0</span>
        <span class="pill" id="kpiLanding">Landing: 0</span>
        <span class="pill" id="kpiServices">Services: 0</span>
        <span class="pill" id="kpiEvents">Events: 0</span>
        <span class="pill" id="kpiProducts">Products: 0</span>
        <span class="pill" id="kpiArticles">Articles: 0</span>
      </div>
    </div>
  </section>

  <section class="row">
    <div class="col card">
      <h3>Query</h3>
      <input id="q" class="w100" placeholder="Ask a question..." />
      <div style="margin-top:8px">
        <button id="btnRunBoth">Run Both</button>
        <span id="statusChat" class="badge">Chat: —</span>
        <span id="statusRpc" class="badge">RPC: —</span>
      </div>
    </div>
    <div class="col card">
      <h3>CSV Runner</h3>
      <label>API URL <input id="api" style="width:360px" value="https://alan-chat-proxy.vercel.app/api/chat"/></label>
      <input type="file" id="csv" accept=".csv" />
      <button id="btnRunCsv">Run CSV</button>
      <div class="kpis" id="csvKpis"></div>
      <div class="table-wrap" style="margin-top:8px">
        <table id="tblCsv"><thead><tr><th>#</th><th>Query</th><th>Intent</th><th>Conf</th><th>L/S/E/P</th><th>URLs</th><th>Checks</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="layout">
      <div>
        <h3>Questions</h3>
        <div class="list" id="questionList"><div class="list-item">Upload CSV to populate</div></div>
      </div>
      <div>
        <h3>Answer Preview</h3>
        <div class="kpis" id="answerKpis"></div>
        <div class="answer" id="answerText">Run a query to see the chat-style answer here.</div>
        <h4 style="margin-top:12px">Chat.js Events</h4>
        <div class="table-wrap"><table id="chatEvents"><thead><tr><th>Title</th><th>When</th><th>Location</th></tr></thead><tbody></tbody></table></div>
        <details style="margin-top:12px"><summary>RPC Events (debug)</summary>
          <pre id="rpcBox" style="white-space:pre-wrap;font-family:var(--mono);min-height:60px"></pre>
          <div class="table-wrap"><table id="rpcEvents"><thead><tr><th>Title</th><th>When</th><th>Location</th></tr></thead><tbody></tbody></table></div>
        </details>
        <h3 style="margin-top:16px">Results Table</h3>
        <div class="table-wrap">
          <table id="tblResults">
            <thead>
              <tr><th>#</th><th>Query</th><th>Initial response</th><th>Intent</th><th>Kind</th><th>URL</th><th>Confidence</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <script>
    const $ = s => document.querySelector(s);
    function kws(q){ const stop=['the','a','an','and','or','in','on','at','to','for','of','with','by','is','are','was','were','be','been','being','have','has','had','do','does','did','will','would','could','should','may','might','must','can','when','where','what','how','why','who','which']; return (q||'').toLowerCase().replace(/[^\w\s]/g,' ').split(/\s+/).filter(w=>w.length>2 && !stop.includes(w)).slice(0,5);} 
    function urlsOf(s){ const o=[]; const add=a=> (a||[]).forEach(e=>o.push(e.page_url||e.url||e.href||'')); add(s?.landing); add(s?.services); add(s?.products); add(s?.events); add(s?.articles); return o.filter(Boolean);} 
    function checksFor(q, data){ const u=urlsOf(data.structured||{}); const s=(q||'').toLowerCase(); const out=[]; const chk=(req)=> req.some(x=>u.some(y=>y.includes(x)) || String(data.answer_markdown||'').includes(x)); if(s.includes('free')&&s.includes('online')&&s.includes('course')){ if(!chk(['free-online-photography-course'])) out.push('missing free-course'); if((data.structured?.events||[]).length) out.push('events>0'); } if(/(terms|refund|cancellation|policy)/.test(s)){ if(!chk(['terms-and-conditions'])) out.push('missing terms'); if((data.structured?.events||[]).length) out.push('events>0'); if((data.structured?.products||[]).length) out.push('products>0'); } if(/(who is alan ranger|about alan)/.test(s)){ if(!chk(['about-alan-ranger'])) out.push('missing about'); } return out; }

    async function callChat(query){ const api=$('#api').value.trim(); const r=await fetch(api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query,pageContext:null})}); return await r.json(); }
    async function callRpc(query){ const url='https://igzvwbvgvmzvvzoclufx.supabase.co'; const key='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnenZ3YnZndm16dnZ6b2NsdWZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2Nzc5MjgsImV4cCI6MjA3MzI1MzkyOH0.A9TCmnXKJhDRYBkrO0mAMPiUQeV9enweeyRWKWQ1SZY'; const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2'); const supa=createClient(url,key); const keys=kws(query); const [ev]= await Promise.all([supa.rpc('search_events',{keys})]); return { events:ev.data||[] } }

    function renderEvents(tb, arr){ const b=$(tb+' tbody'); b.innerHTML=''; (arr||[]).forEach(e=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><a href="${e.page_url||e.url||''}" target="_blank">${(e.title||'')}</a></td><td>${e.date_start||e.when||''}</td><td>${e.location||''}</td>`; b.appendChild(tr); }); }

    function confidencePill(conf){ let cls='warn', txt=(conf??0).toFixed(2); if(conf>=0.8) cls='good'; else if(conf<0.6) cls='bad'; return `<span class='pill ${cls}'>Confidence ${txt}</span>`; }
    function countsPill(label, n){ return `<span class='pill'>${label}: ${n}</span>`; }
    function updateAnswerKpis(data){ const s=data.structured||{}; const pills=[]; pills.push(`<span class='pill'>Intent ${s.intent||'-'}</span>`); pills.push(confidencePill(data.confidence??0)); pills.push(countsPill('landing', (s.landing||[]).length)); pills.push(countsPill('services', (s.services||[]).length)); pills.push(countsPill('events', (s.events||[]).length)); pills.push(countsPill('products', (s.products||[]).length)); pills.push(countsPill('articles', (s.articles||[]).length)); $('#answerKpis').innerHTML=pills.join(' '); }

    function dominantKind(structured){ if((structured?.landing||[]).length) return 'landing'; if((structured?.services||[]).length) return 'service'; if((structured?.events||[]).length) return 'event'; if((structured?.products||[]).length) return 'product'; if((structured?.articles||[]).length) return 'article'; return '-'; }
    function firstUrl(structured){ const list = urlsOf(structured||{}); return list[0]||''; }
    function addResultRow(idx, query, data){ const tb=document.querySelector('#tblResults tbody'); const tr=document.createElement('tr'); const s=data.structured||{}; const url=firstUrl(s); const kind=dominantKind(s); const ans=(data.answer_markdown||'').slice(0,200); tr.innerHTML=`<td>${idx}</td><td>${escapeHtml(query)}</td><td>${escapeHtml(ans)}</td><td>${s.intent||'-'}</td><td>${kind}</td><td>${url? `<a href='${url}' target='_blank'>${escapeHtml(url)}</a>`:''}</td><td>${confidencePill(data.confidence??0)}</td>`; tb.appendChild(tr); }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    $('#btnRunBoth').addEventListener('click', async ()=>{ const q=$('#q').value.trim(); if(!q) return; $('#statusChat').textContent='Chat: …'; $('#statusRpc').textContent='RPC: …'; const [chat,rpc]= await Promise.allSettled([callChat(q), callRpc(q)]); if(chat.status==='fulfilled'){ $('#statusChat').textContent='Chat: OK'; updateAnswerKpis(chat.value); $('#answerText').textContent = chat.value.answer_markdown || '(no answer)'; renderEvents('#chatEvents', chat.value.structured?.events||[]); addResultRow(document.querySelectorAll('#tblResults tbody tr').length+1, q, chat.value);} else { $('#statusChat').textContent='Chat: FAIL'; $('#answerText').textContent=chat.reason?.message||'error'; } if(rpc.status==='fulfilled'){ $('#statusRpc').textContent='RPC: OK'; $('#rpcBox').textContent=JSON.stringify({events:rpc.value.events.length},null,2); renderEvents('#rpcEvents', rpc.value.events||[]);} else { $('#statusRpc').textContent='RPC: FAIL'; $('#rpcBox').textContent=rpc.reason?.message||'error'; } });

    $('#btnRunCsv').addEventListener('click', async ()=>{ const f=$('#csv').files[0]; if(!f){ alert('Select CSV'); return; } const text=await f.text(); const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean); const tb=$('#tblCsv tbody'); tb.innerHTML=''; $('#questionList').innerHTML=''; document.querySelector('#tblResults tbody').innerHTML=''; let i=0; let total=0, count=0, intents={}; let sumLanding=0,sumServices=0,sumEvents=0,sumProducts=0,sumArticles=0; for(const line of lines){ i++; const q=line.split(',')[0].replace(/^\"|\"$/g,''); const li=document.createElement('div'); li.className='list-item'; li.textContent=`${i}. ${q}`; li.addEventListener('click',()=>{ $('#q').value=q; document.getElementById('btnRunBoth').click(); }); document.getElementById('questionList').appendChild(li); try{ const data=await callChat(q); const urls=urlsOf(data.structured||{}); const checks=checksFor(q,data); const s=data.structured||{}; sumLanding += (s.landing||[]).length; sumServices += (s.services||[]).length; sumEvents += (s.events||[]).length; sumProducts += (s.products||[]).length; sumArticles += (s.articles||[]).length; const tr=document.createElement('tr'); tr.innerHTML=`<td>${i}</td><td>${q}</td><td>${s.intent||'-'}</td><td>${data.confidence??'-'}</td><td>${(s.landing||[]).length}/${(s.services||[]).length}/${(s.events||[]).length}/${(s.products||[]).length}</td><td style=\"max-width:340px;word-break:break-all\">${urls.slice(0,4).map(u=>`<div>${u}</div>`).join('')}</td><td>${checks.length? `<span class='bad'>${checks.join('; ')}</span>`: `<span class='good'>ok</span>`}</td>`; tb.appendChild(tr); addResultRow(i, q, data); if(typeof data.confidence==='number'){ total+=data.confidence; count++; } const it=s.intent||'-'; intents[it]=(intents[it]||0)+1; } catch(e){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i}</td><td>${q}</td><td colspan=\"5\" class='bad'>${e.message}</td>`; tb.appendChild(tr);} } const avg = count? (total/count).toFixed(2):'-'; const kpiEl=document.getElementById('csvKpis'); kpiEl.innerHTML=`<span class='pill'>Total ${i}</span><span class='pill'>Avg confidence ${avg}</span>` + Object.entries(intents).map(([k,v])=>`<span class='pill'>${k}: ${v}</span>`).join(' '); // Top dashboard
      document.getElementById('kpiTotal').textContent = `Total: ${i}`;
      document.getElementById('kpiAvg').innerHTML = `Avg Confidence: <b>${avg}</b>`;
      document.getElementById('kpiIntentAdvice').textContent = `Advice: ${intents['advice']||0}`;
      document.getElementById('kpiIntentEvents').textContent = `Events: ${intents['events']||0}`;
      document.getElementById('kpiIntentProducts').textContent = `Products: ${intents['products']||0}`;
      document.getElementById('kpiLanding').textContent = `Landing: ${sumLanding}`;
      document.getElementById('kpiServices').textContent = `Services: ${sumServices}`;
      document.getElementById('kpiEvents').textContent = `Events: ${sumEvents}`;
      document.getElementById('kpiProducts').textContent = `Products: ${sumProducts}`;
      document.getElementById('kpiArticles').textContent = `Articles: ${sumArticles}`;
    });
  </script>
</body>
</html>


