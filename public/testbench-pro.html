<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Testbench Pro – Chat.js vs RPC + CSV Runner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0b1220; --panel:#0f172a; --line:#1b2540; --text:#dbe4ff; --muted:#9fb3ff; --orange:#E57200; --good:#34d399; --bad:#f87171; --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; --sans: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial }
    *{box-sizing:border-box} body{background:var(--bg);color:var(--text);font:14px/1.5 var(--sans);margin:0;padding:24px}
    .row{display:flex;gap:16px;flex-wrap:wrap}.col{flex:1;min-width:320px}.card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:16px}
    input,button,select,textarea{background:#0b1220;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px}
    table{width:100%;border-collapse:collapse;font-size:13px} th,td{border-top:1px solid var(--line);padding:6px 8px;vertical-align:top} th{color:var(--muted)}
    .badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#0b1220;border:1px solid var(--line);font-size:12px}
    .good{border-color:#1e3a2a;color:#86efac}.bad{border-color:#3a1e1e;color:#fecaca}
    .table-wrap{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:8px}
  </style>
</head>
<body>
  <header class="row">
    <div class="col"><h1>Testbench Pro</h1><div class="badge">Chat vs RPC + CSV Assertions</div></div>
  </header>

  <section class="row">
    <div class="col card">
      <h3>Query</h3>
      <input id="q" class="w100" placeholder="Ask a question..." />
      <div style="margin-top:8px">
        <button id="btnRunBoth">Run Both</button>
        <span id="statusChat" class="badge">Chat: —</span>
        <span id="statusRpc" class="badge">RPC: —</span>
      </div>
    </div>
    <div class="col card">
      <h3>CSV Runner</h3>
      <label>API URL <input id="api" style="width:360px" value="https://alan-chat-proxy.vercel.app/api/chat"/></label>
      <input type="file" id="csv" accept=".csv" />
      <button id="btnRunCsv">Run CSV</button>
      <div class="table-wrap" style="margin-top:8px">
        <table id="tblCsv"><thead><tr><th>#</th><th>Query</th><th>Intent</th><th>Conf</th><th>L/S/E/P</th><th>URLs</th><th>Checks</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <section class="row">
    <div class="col card">
      <h3>Chat.js</h3>
      <pre id="chatBox" style="white-space:pre-wrap;font-family:var(--mono);min-height:120px"></pre>
      <div class="table-wrap"><table id="chatEvents"><thead><tr><th>Title</th><th>When</th><th>Location</th></tr></thead><tbody></tbody></table></div>
    </div>
    <div class="col card">
      <h3>RPC</h3>
      <pre id="rpcBox" style="white-space:pre-wrap;font-family:var(--mono);min-height:120px"></pre>
      <div class="table-wrap"><table id="rpcEvents"><thead><tr><th>Title</th><th>When</th><th>Location</th></tr></thead><tbody></tbody></table></div>
    </div>
  </section>

  <script>
    const $ = s => document.querySelector(s);
    function kws(q){ const stop=['the','a','an','and','or','in','on','at','to','for','of','with','by','is','are','was','were','be','been','being','have','has','had','do','does','did','will','would','could','should','may','might','must','can','when','where','what','how','why','who','which']; return (q||'').toLowerCase().replace(/[^\w\s]/g,' ').split(/\s+/).filter(w=>w.length>2 && !stop.includes(w)).slice(0,5);} 
    function urlsOf(s){ const o=[]; const add=a=> (a||[]).forEach(e=>o.push(e.page_url||e.url||e.href||'')); add(s?.landing); add(s?.services); add(s?.products); add(s?.events); add(s?.articles); return o.filter(Boolean);} 
    function checksFor(q, data){ const u=urlsOf(data.structured||{}); const s=(q||'').toLowerCase(); const out=[]; const chk=(req)=> req.some(x=>u.some(y=>y.includes(x)) || String(data.answer_markdown||'').includes(x)); if(s.includes('free')&&s.includes('online')&&s.includes('course')){ if(!chk(['free-online-photography-course'])) out.push('missing free-course'); if((data.structured?.events||[]).length) out.push('events>0'); } if(/(terms|refund|cancellation|policy)/.test(s)){ if(!chk(['terms-and-conditions'])) out.push('missing terms'); if((data.structured?.events||[]).length) out.push('events>0'); if((data.structured?.products||[]).length) out.push('products>0'); } if(/(who is alan ranger|about alan)/.test(s)){ if(!chk(['about-alan-ranger'])) out.push('missing about'); } return out; }

    async function callChat(query){ const api=$('#api').value.trim(); const r=await fetch(api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query,pageContext:null})}); return await r.json(); }
    async function callRpc(query){ const url='https://igzvwbvgvmzvvzoclufx.supabase.co'; const key='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnenZ3YnZndm16dnZ6b2NsdWZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2Nzc5MjgsImV4cCI6MjA3MzI1MzkyOH0.A9TCmnXKJhDRYBkrO0mAMPiUQeV9enweeyRWKWQ1SZY'; const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2'); const supa=createClient(url,key); const keys=kws(query); const [ev]= await Promise.all([supa.rpc('search_events',{keys})]); return { events:ev.data||[] } }

    function renderEvents(tb, arr){ const b=$(tb+' tbody'); b.innerHTML=''; (arr||[]).forEach(e=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><a href="${e.page_url||e.url||''}" target="_blank">${(e.title||'')}</a></td><td>${e.date_start||''}</td><td>${e.location||''}</td>`; b.appendChild(tr); }); }

    $('#btnRunBoth').addEventListener('click', async ()=>{ const q=$('#q').value.trim(); if(!q) return; $('#statusChat').textContent='Chat: …'; $('#statusRpc').textContent='RPC: …'; const [chat,rpc]= await Promise.allSettled([callChat(q), callRpc(q)]); if(chat.status==='fulfilled'){ $('#statusChat').textContent='Chat: OK'; $('#chatBox').textContent=JSON.stringify({intent:chat.value.structured?.intent, confidence:chat.value.confidence, urls:urlsOf(chat.value.structured||{})}, null, 2); renderEvents('#chatEvents', chat.value.structured?.events||[]);} else { $('#statusChat').textContent='Chat: FAIL'; $('#chatBox').textContent=chat.reason?.message||'error'; } if(rpc.status==='fulfilled'){ $('#statusRpc').textContent='RPC: OK'; $('#rpcBox').textContent=JSON.stringify({events:rpc.value.events.length},null,2); renderEvents('#rpcEvents', rpc.value.events||[]);} else { $('#statusRpc').textContent='RPC: FAIL'; $('#rpcBox').textContent=rpc.reason?.message||'error'; } });

    $('#btnRunCsv').addEventListener('click', async ()=>{ const f=$('#csv').files[0]; if(!f){ alert('Select CSV'); return; } const text=await f.text(); const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean); const tb=$('#tblCsv tbody'); tb.innerHTML=''; let i=0; for(const line of lines){ i++; const q=line.split(',')[0].replace(/^"|"$/g,''); try{ const data=await callChat(q); const urls=urlsOf(data.structured||{}); const checks=checksFor(q,data); const tr=document.createElement('tr'); tr.innerHTML=`<td>${i}</td><td>${q}</td><td>${data.structured?.intent||'-'}</td><td>${data.confidence??'-'}</td><td>${(data.structured?.landing||[]).length}/${(data.structured?.services||[]).length}/${(data.structured?.events||[]).length}/${(data.structured?.products||[]).length}</td><td style="max-width:340px;word-break:break-all">${urls.slice(0,6).map(u=>`<div>${u}</div>`).join('')}</td><td>${checks.length? `<span class='bad'>${checks.join('; ')}</span>`: `<span class='good'>ok</span>`}</td>`; tb.appendChild(tr);} catch(e){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i}</td><td>${q}</td><td colspan="5" class='bad'>${e.message}</td>`; tb.appendChild(tr);} } });
  </script>
</body>
</html>


