<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Regression Test Comparison Tool</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background-color: white;
      padding: 24px;
      max-width: 1400px;
      margin: 0 auto;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #333;
      padding-bottom: 10px;
      margin-top: 0;
    }
    h2 {
      color: #555;
      margin-top: 30px;
      border-bottom: 2px solid #ddd;
      padding-bottom: 5px;
    }
    .controls {
      background-color: #f9f9f9;
      padding: 15px;
      border-left: 4px solid #333;
      margin: 20px 0;
    }
    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }
    .field-group {
      display: flex;
      flex-direction: column;
      flex: 1 1 260px;
      min-width: 220px;
    }
    .field-group label {
      font-size: 13px;
      margin-bottom: 4px;
      color: #444;
      font-weight: 600;
    }
    .field-group input,
    .field-group select {
      padding: 6px 8px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background-color: #333;
      color: white;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .status {
      font-size: 13px;
      margin-top: 6px;
      color: #555;
    }
    .error {
      color: #dc3545;
      font-weight: 600;
    }
    .run-progress {
      margin-top: 6px;
      height: 6px;
      width: 220px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      display: none;
    }
    .run-progress-inner {
      height: 100%;
      width: 40%;
      background: linear-gradient(90deg, #f97316, #facc15);
      border-radius: 999px;
      animation: progressPulse 1.1s ease-in-out infinite;
    }
    @keyframes progressPulse {
      0% { transform: translateX(-60%); }
      50% { transform: translateX(40%); }
      100% { transform: translateX(140%); }
    }
    /* Manage tests table */
    .manage-tests {
      margin-top: 16px;
      font-size: 12px;
    }
    .manage-tests table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    .manage-tests th,
    .manage-tests td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
    }
    .manage-tests th {
      background-color: #f3f4f6;
      font-weight: 600;
    }
    .manage-tests tbody tr:nth-child(even) {
      background-color: #f9fafb;
    }
    .manage-tests-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-start;
      flex-wrap: wrap;
    }
    /* Summary modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: #fff;
      border-radius: 10px;
      padding: 18px 20px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 12px 30px rgba(15,23,42,0.35);
      font-size: 14px;
    }
    .modal h3 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }
    .modal small {
      color: #6b7280;
    }
    .modal-summary-table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 13px;
    }
    .modal-summary-table th,
    .modal-summary-table td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
    }
    .modal-summary-table th {
      background: #f3f4f6;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
    }
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background-color: white;
    }
    .summary-table th,
    .summary-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    .summary-table th {
      background-color: #333;
      color: white;
      font-weight: bold;
    }
    .summary-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 12px;
    }
    .comparison-table th {
      background-color: #333;
      color: white;
      padding: 12px 8px;
      text-align: left;
      font-weight: bold;
      border: 1px solid #555;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .comparison-table td {
      border: 1px solid #ddd;
      padding: 10px 8px;
      vertical-align: top;
    }
    .comparison-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .comparison-table tr:hover {
      background-color: #f0f0f0;
    }
    .question-num-col {
      font-weight: bold;
      width: 6%;
      text-align: center;
      color: #333;
    }
    .query-col {
      font-weight: bold;
      width: 17%;
    }
    .baseline-col,
    .current-col {
      width: 25%;
    }
    .status-col {
      width: 8%;
      text-align: center;
    }
    .notes-col {
      width: 25%;
    }
    .status-better {
      color: #28a745;
      font-weight: bold;
    }
    .status-worse {
      color: #dc3545;
      font-weight: bold;
    }
    .status-mixed {
      color: #ffc107;
      font-weight: bold;
    }
    .status-same {
      color: #6c757d;
      font-weight: bold;
    }
    .content-line {
      margin: 4px 0;
      line-height: 1.4;
    }
    .content-type {
      font-weight: 600;
    }
    @media print {
      body {
        background-color: white;
        margin: 0;
      }
      .container {
        box-shadow: none;
        padding: 20px;
      }
      .comparison-table {
        font-size: 10px;
      }
      .controls {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Regression Test Comparison Tool</h1>

    <div class="controls">
      <div class="controls-row">
        <div class="field-group">
          <label for="supabaseUrl">Supabase URL</label>
          <input id="supabaseUrl" type="text" value="https://igzvwbvgvmzvvzoclufx.supabase.co" />
        </div>
        <div class="field-group">
          <label for="supabaseKey">Supabase anon key</label>
          <textarea id="supabaseKey" rows="3" style="resize:vertical;">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnenZ3YnZndm16dnZ6b2NsdWZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2Nzc5MjgsImV4cCI6MjA3MzI1MzkyOH0.A9TCmnXKJhDRYBkrO0mAMPiUQeV9enweeyRWKWQ1SZY</textarea>
        </div>
        <div class="field-group">
          <label for="adminToken">Admin API token (Authorization bearer)</label>
          <input id="adminToken" type="password" placeholder="Paste INGEST_TOKEN / automation bypass" />
        </div>
        <div class="field-group" style="align-self:flex-end; flex:0 0 auto;">
          <button id="connectBtn">Connect &amp; Load Tests</button>
        </div>
      </div>
      <div class="status" id="connectionStatus"></div>

      <hr style="margin: 16px 0;" />

      <div class="controls-row">
        <div class="field-group">
          <label for="baselineSelect">Baseline test (job, phase, date/time)</label>
          <select id="baselineSelect" disabled>
            <option value="">Connect first to load tests‚Ä¶</option>
          </select>
          <button id="setMasterBaselineBtn" type="button" style="margin-top:6px;font-size:12px;padding:6px 10px;">
            üîí Set selected baseline as Master Baseline
          </button>
        </div>
        <div class="field-group">
          <label for="currentSelect">Comparison test (job, phase, date/time)</label>
          <select id="currentSelect" disabled>
            <option value="">Connect first to load tests‚Ä¶</option>
          </select>
        </div>
        <div class="field-group">
          <label for="sortBy">Table sort order</label>
          <select id="sortBy">
            <option value="none">Question order (Q1‚ÄìQ40)</option>
            <option value="category">Category (A‚ÄìZ)</option>
            <option value="status">Status (Worse ‚Üí Better)</option>
            <option value="category_status">Category, then Status</option>
          </select>
        </div>
        <div class="field-group" style="align-self:flex-end; flex:0 0 auto;">
          <button id="compareBtn" disabled>Compare Selected Tests</button>
        </div>
      </div>

      <hr style="margin: 16px 0;" />

      <div class="controls-row">
        <div class="field-group">
          <label for="runJobId">Run new 40Q regression test ‚Äì Job ID</label>
          <input id="runJobId" type="number" placeholder="e.g. 31 or 999" />
        </div>
        <div class="field-group">
          <label for="runTestPhase">Test phase</label>
          <select id="runTestPhase">
            <option value="before">before</option>
            <option value="after" selected>after</option>
          </select>
        </div>
        <div class="field-group">
          <label for="runJobName">Job name (optional override)</label>
          <input id="runJobName" type="text" placeholder="Defaults to 'Job &lt;id&gt;'" />
        </div>
        <div class="field-group" style="align-self:flex-end; flex:0 0 auto;">
          <button id="run40qBtn">Run 40Q Regression Test (via /api/admin)</button>
        </div>
      </div>
      <div class="status" id="comparisonStatus"></div>
      <div class="status" id="runStatus"></div>
      <div class="run-progress" id="runProgress">
        <div class="run-progress-inner"></div>
      </div>
    </div>

    <details class="manage-tests">
      <summary style="cursor:pointer;font-weight:600;">Manage regression tests (delete old runs)</summary>
      <div class="manage-tests" id="manageTestsContainer">
        <div style="margin-top:6px;font-size:12px;color:#4b5563;">
          Below are recent regression tests (from <code>regression_test_results</code> / <code>regression_test_runs</code>). 
          Tick rows and click "Delete selected tests" to remove them from the database.
        </div>
        <div class="manage-tests-actions">
          <button id="refreshTestsBtn" type="button">Refresh list</button>
          <button id="deleteTestsBtn" type="button" style="background:#b91c1c;">Delete selected tests</button>
          <span id="manageTestsStatus" class="status"></span>
        </div>
        <div style="max-height:260px;overflow:auto;margin-top:8px;">
          <table id="testsTable">
            <thead>
              <tr>
                <th style="width:32px;"><input type="checkbox" id="selectAllTests"></th>
                <th>ID</th>
                <th>Job</th>
                <th>Phase</th>
                <th>Run ID</th>
                <th>Date/Time (UK)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </details>

    <div class="modal-backdrop" id="summaryModalBackdrop">
      <div class="modal">
        <h3>Comparison summary</h3>
        <div id="summaryModalMeta"><small></small></div>
        <table class="modal-summary-table">
          <thead>
            <tr>
              <th>Status</th>
              <th>Count</th>
              <th>Percentage</th>
            </tr>
          </thead>
          <tbody id="summaryModalBody"></tbody>
        </table>
        <div class="modal-footer">
          <button id="closeSummaryModalBtn" type="button">Close</button>
        </div>
      </div>
    </div>

    <details id="debugPanel" open>
      <summary style="cursor:pointer; font-weight:600; margin-top:10px;">Debug log</summary>
      <div style="margin:10px 0;">
        <button id="copyDebugBtn">Copy debug log</button>
      </div>
      <pre id="debugLog" style="background:#111; color:#eee; padding:10px; max-height:260px; overflow:auto; font-size:11px; border-radius:4px;"></pre>
    </details>

    <div id="resultsContainer">
      <!-- Summary and table will be injected here -->
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // Canonical 68Q questions (temporary: will refine to 64Q and move to universal source after testing)
    const QUERIES = [
      "whens the next bluebell workshops and whats the cost",
      "when is the next devon workshop",
      "what is your next workshop date and where is it",
      "when are your next Autumn workshops and where are they?",
      "How long are your workshops?",
      "How much is a residential photography course and does it include B&B",
      "What is the difference between prime and zoom lenses?",
      "What memory card should I buy?",
      "Do you offer gift vouchers?",
      "What is HDR photography?",
      "What tripod do you recommend",
      "What is long exposure and how can I find out more about it",
      "How do I improve my composition and storytelling in photos?",
      "\"What is the exposure triangle (aperture, shutter, ISO)?\"",
      "How do I improve my photography skills?",
      "What is your cancellation or refund policy for courses/workshops?",
      "Do you do astrophotography workshops",
      "Can my 14yr old attend your workshop",
      "My pictures never seem sharp.  Can you advise on what I am doing wrong",
      "What types of photography services do you offer?",
      "What sort of camera do I need for your camera course",
      "What gear or equipment do I need to bring to a workshop?",
      "Do you I get a certificate with the photography course",
      "Do I need a laptop for the lightroom course",
      "Is the online photography course really free",
      "What courses do you offer for complete beginners?",
      "How many weeks is the beginners' photography course?",
      "How do I get personalised feedback on my images",
      "How can I contact you or book a discovery call?",
      "Where is your gallery and can I submit my images for feedback?",
      "\"What is depth of field, and how do I control it?\"",
      "What is white balance and how do I use it?",
      "Who is Alan Ranger and what is his photographic background?",
      "Where is Alan Ranger based?",
      "Can I hire you as a professional photographer in Coventry?",
      "peter orton",
      "who is alan ranger",
      "How do I subscribe to the free online photography course?",
      "How do I use flash photography?",
      "How do I edit RAW files?",
      "how do I focus in landscape photography",
      "how do I improve my photography",
      "how do I photograph autumn colours",
      "how do I photograph bluebells",
      "how do I photograph flowers",
      "how do I photograph people",
      "how do I photograph seascapes",
      "how do I photograph sunsets",
      "how do I photograph waterfalls",
      "how do I photograph wildlife",
      "how do I take better landscape photos",
      "how do I use a tripod",
      "what camera should I buy",
      "what is a histogram",
      "what is aperture",
      "what is composition in photography",
      "what is depth of field",
      "what is golden hour",
      "what is ISO",
      "what is long exposure photography",
      "what is macro photography",
      "what is portrait photography",
      "what is shutter speed",
      "what is the best camera for beginners",
      "what is the best lens for landscape photography",
      "what is the best time of day for landscape photography",
      "what is the rule of thirds",
      "what settings should I use for landscape photography"
    ];

    // Category tags aligned with canonical 68Q list (order matches QUERIES)
    const QUERY_CATEGORIES = [
      "Event Queries",
      "Event Queries",
      "Event Queries",
      "Event Queries",
      "Event Queries",
      "Course/Workshop Logistics",
      "Equipment Recommendations",
      "Equipment Recommendations",
      "Business Information",
      "Technical Photography Concepts",
      "Equipment Recommendations",
      "Technical Photography Concepts",
      "Technical Advice",
      "Technical Photography Concepts",
      "Technical Advice",
      "Business Information",
      "General Queries",
      "General Queries",
      "General Queries",
      "General Queries",
      "Equipment Recommendations",
      "Equipment Recommendations",
      "Course/Workshop Logistics",
      "Course/Workshop Logistics",
      "Course/Workshop Logistics",
      "Course/Workshop Logistics",
      "Course/Workshop Logistics",
      "Business Information",
      "Business Information",
      "Business Information",
      "Technical Photography Concepts",
      "Technical Photography Concepts",
      "Person Queries",
      "Person Queries",
      "Person Queries",
      "Person Queries",
      "Person Queries",
      "Technical Advice",
      "Technical Advice",
      "Technical Advice",
      "Technical Advice",
      "Technical Advice",
      "Technical Advice",
      "Technical Advice",
      "Technical Advice",
      "Technical Advice",
      "Technical Advice",
      "Technical Advice",
      "Technical Advice",
      "Technical Advice",
      "Technical Advice",
      "Equipment Recommendations",
      "Technical Photography Concepts",
      "Technical Photography Concepts",
      "Technical Photography Concepts",
      "Technical Photography Concepts",
      "Technical Photography Concepts",
      "Technical Photography Concepts",
      "Technical Photography Concepts",
      "Technical Photography Concepts",
      "Technical Photography Concepts",
      "Technical Photography Concepts",
      "Equipment Recommendations",
      "Equipment Recommendations",
      "Technical Photography Concepts",
      "Technical Photography Concepts",
      "Technical Advice"
    ];

    // Sorting state for comparison table
    let currentSortKey = 'none'; // 'none' | 'category' | 'status' | 'category_status'

    // Remember last comparison so we can re-render when sort changes
    let lastComparison = null; // { baselineId, baselineCreatedAt, baselineJobId, currentId, currentCreatedAt, currentJobId, baselineResults, currentResults }

    let supabaseClient = null;
    let testIndex = {};
    let testsMeta = []; // flat list for manage/delete UI
    let masterBaselineId = null; // ID of the actual master baseline from DB
    const debugLines = [];

    function logDebug(message, extra) {
      const ts = new Date().toISOString();
      let line = `[${ts}] ${message}`;
      if (extra !== undefined) {
        try {
          line += ' ' + JSON.stringify(extra);
        } catch {
          line += ' ' + String(extra);
        }
      }
      debugLines.push(line);
      const el = document.getElementById('debugLog');
      if (el) {
        el.textContent = debugLines.join('\n');
        el.scrollTop = el.scrollHeight;
      }
    }

    function prefillSupabaseCreds() {
      try {
        const urlInput = document.getElementById('supabaseUrl');
        const keyInput = document.getElementById('supabaseKey');
        const adminInput = document.getElementById('adminToken');

        // 0) Hard-coded defaults (same pattern as testbench.html)
        if (!urlInput.value) {
          urlInput.value = 'https://igzvwbvgvmzvvzoclufx.supabase.co';
        }
        if (!keyInput.value) {
          keyInput.value = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnenZ3YnZndm16dnZ6b2NsdWZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2Nzc5MjgsImV4cCI6MjA3MzI1MzkyOH0.A9TCmnXKJhDRYBkrO0mAMPiUQeV9enweeyRWKWQ1SZY';
        }

        if (window.__SUPABASE_URL && !urlInput.value) {
          urlInput.value = window.__SUPABASE_URL;
        }
        if (window.__SUPABASE_ANON_KEY && !keyInput.value) {
          keyInput.value = window.__SUPABASE_ANON_KEY;
        }
        if (!urlInput.value) {
          const storedUrl = window.localStorage.getItem('regression_supabase_url');
          if (storedUrl) urlInput.value = storedUrl;
        }
        if (!keyInput.value) {
          const storedKey = window.localStorage.getItem('regression_supabase_anon_key');
          if (storedKey) keyInput.value = storedKey;
        }
        if (adminInput && !adminInput.value) {
          // Prefer explicit global if you define: window.__ADMIN_TOKEN = '...'
          if (window.__ADMIN_TOKEN) {
            adminInput.value = window.__ADMIN_TOKEN;
          }
          const storedAdmin = window.localStorage.getItem('regression_admin_token');
          if (storedAdmin) adminInput.value = storedAdmin;
        }
      } catch (e) {
        console.warn('Prefill of Supabase creds failed or not available:', e);
        logDebug('PrefillSupabaseCreds failed', String(e));
      }
    }

    function setConnectionStatus(message, isError = false) {
      const el = document.getElementById('connectionStatus');
      el.textContent = message || '';
      el.className = 'status' + (isError ? ' error' : '');
      logDebug(`ConnectionStatus: ${message}`, { isError });
    }

    function setComparisonStatus(message, isError = false) {
      const el = document.getElementById('comparisonStatus');
      el.textContent = message || '';
      el.className = 'status' + (isError ? ' error' : '');
      logDebug(`ComparisonStatus: ${message}`, { isError });
    }

    function setRunStatus(message, isError = false) {
      const el = document.getElementById('runStatus');
      el.textContent = message || '';
      el.className = 'status' + (isError ? ' error' : '');
      logDebug(`RunStatus: ${message}`, { isError });
    }

    // Helper: simple follow-up detection (mirrors chat.html behaviour)
    function isSimpleFollowUpQueryForUi(query) {
      if (!query) return false;
      const q = String(query);
      const isFollowUpPattern = /^(how many|when|where|how much|how long|can i|do you|is there)/i.test(q);
      const hasEventKeywords =
        q.includes('book') ||
        q.includes('buy') ||
        q.includes('price') ||
        q.includes('cost') ||
        q.includes('workshop') ||
        q.includes('course') ||
        q.includes('event') ||
        q.includes('class');
      return isFollowUpPattern && !hasEventKeywords;
    }

    // Helper: normalize structured objects to what UI actually shows
    function normalizeStructuredForUi(structured, query) {
      if (!structured) return structured;
      const copy = {
        ...structured,
        articles: structured.articles || [],
        services: structured.services || [],
        events: structured.events || [],
        products: structured.products || []
      };
      // Note: We removed the follow-up filter to match chat.html behavior
      // Services/events are now always shown when backend returns them
      return copy;
    }

    function extractContentCounts(structured, query) {
      const s = normalizeStructuredForUi(structured, query);
      return {
        articles: (s && s.articles && s.articles.length) || 0,
        services: (s && s.services && s.services.length) || 0,
        events: (s && s.events && s.events.length) || 0,
        products: (s && s.products && s.products.length) || 0
      };
    }

    function getTopItems(structured, type, limit = 3) {
      const items = (structured && structured[type]) || [];
      return items.slice(0, limit).map(item => {
        const id =
          item.id ||
          (item.raw && item.raw.id) ||
          item.event_id ||
          item.product_id ||
          'N/A';
        const title =
          item.title ||
          (item.raw && (item.raw.name || item.raw.title)) ||
          item.event_title ||
          item.product_title ||
          'N/A';
        return { id, title: String(title) };
      });
    }

    function determineStatus(baseline, current) {
      const baselineTotal =
        baseline.articles + baseline.services + baseline.events + baseline.products;
      const currentTotal =
        current.articles + current.services + current.events + current.products;

      if (baselineTotal === 0 && currentTotal === 0) return 'same';
      if (baselineTotal === 0 && currentTotal > 0) return 'better';
      if (baselineTotal > 0 && currentTotal === 0) return 'worse';

      const articlesMatch = baseline.articles === current.articles;
      const servicesMatch = baseline.services === current.services;
      const eventsMatch = baseline.events === current.events;
      const productsMatch = baseline.products === current.products;

      const topBase = baseline.topArticles && baseline.topArticles[0];
      const topCurr = current.topArticles && current.topArticles[0];
      const topArticleChanged =
        !!topBase &&
        !!topCurr &&
        String(topBase.id || '') !== String(topCurr.id || '');

      if (currentTotal > baselineTotal * 1.2 && articlesMatch && servicesMatch) {
        return 'better';
      }
      if (currentTotal < baselineTotal * 0.8) {
        return 'worse';
      }
      if (topArticleChanged && Math.abs(currentTotal - baselineTotal) <= 2) {
        return 'mixed';
      }
      if (articlesMatch && servicesMatch && eventsMatch && productsMatch) {
        return 'same';
      }
      return 'mixed';
    }

    function generateNotes(row) {
      const notes = [];
      if (row.baseline.counts.articles !== row.current.counts.articles) {
        notes.push(`Articles: ${row.baseline.counts.articles} ‚Üí ${row.current.counts.articles}`);
      }
      if (row.baseline.counts.services !== row.current.counts.services) {
        notes.push(`Services: ${row.baseline.counts.services} ‚Üí ${row.current.counts.services}`);
      }
      if (row.baseline.counts.events !== row.current.counts.events) {
        notes.push(`Events: ${row.baseline.counts.events} ‚Üí ${row.current.counts.events}`);
      }
      if (row.baseline.counts.products !== row.current.counts.products) {
        notes.push(`Products: ${row.baseline.counts.products} ‚Üí ${row.current.counts.products}`);
      }
      if (
        row.baseline.topArticles[0] &&
        row.current.topArticles[0] &&
        String(row.baseline.topArticles[0].id) !== String(row.current.topArticles[0].id)
      ) {
        notes.push('Top article changed');
      }
      return notes.length > 0 ? notes.join('; ') : 'No significant changes';
    }

    function formatDateTime(isoString) {
      if (!isoString) return '';
      try {
        const d = new Date(isoString);
        // Show as UK local (GMT/BST) to match how you read cron times
        return d.toLocaleString('en-GB', {
          timeZone: 'Europe/London',
          hour12: false
        }) + ' GMT';
      } catch {
        return isoString;
      }
    }

    async function connectAndLoadTests() {
      const url = document.getElementById('supabaseUrl').value.trim();
      const key = document.getElementById('supabaseKey').value.trim();
      if (!url || !key) {
        setConnectionStatus('Supabase URL and anon key are required.', true);
        return;
      }
      logDebug('Connecting to Supabase', { url });
      setConnectionStatus('Connecting to Supabase and loading tests‚Ä¶');
      document.getElementById('connectBtn').disabled = true;
      try {
        supabaseClient = window.supabase.createClient(url, key);
        logDebug('Supabase client created');

        const { data, error } = await supabaseClient
          .from('regression_test_runs')
          .select('id, job_id, job_name, created_at, baseline_test_id, after_test_id')
          .order('created_at', { ascending: false })
          .limit(500);
        if (error) {
          console.error(error);
          logDebug('Error loading regression_test_runs', error);
          throw error;
        }

        testIndex = {};
        (data || []).forEach(run => {
          const baseId = run.baseline_test_id;
          const afterId = run.after_test_id;
          const job = run.job_id;
          const jname = run.job_name || '';
          const when = formatDateTime(run.created_at);
          if (baseId) {
            if (!testIndex[baseId]) testIndex[baseId] = [];
            testIndex[baseId].push({
              phase: 'baseline',
              job,
              jobName: jname,
              createdAt: when,
              runId: run.id
            });
          }
          if (afterId) {
            if (!testIndex[afterId]) testIndex[afterId] = [];
            testIndex[afterId].push({
              phase: 'after',
              job,
              jobName: jname,
              createdAt: when,
              runId: run.id
            });
          }
        });

        // First, find the actual master baseline
        const { data: masterBaseline, error: masterError } = await supabaseClient
          .from('regression_test_results')
          .select('id')
          .eq('is_fixed_baseline', true)
          .order('test_timestamp', { ascending: false })
          .limit(1)
          .single();
        
        if (!masterError && masterBaseline) {
          masterBaselineId = masterBaseline.id;
          logDebug('Found master baseline', { id: masterBaselineId });
        } else {
          masterBaselineId = null;
          logDebug('No master baseline found', masterError);
        }

        const { data: resultsList, error: resultsError } = await supabaseClient
          .from('regression_test_results')
          .select('id, created_at')
          .order('created_at', { ascending: false })
          .limit(1000);
        if (!resultsError) {
          testsMeta = [];
          (resultsList || []).forEach(r => {
            const id = r.id;
            const when = formatDateTime(r.created_at);
            testsMeta.push({
              id,
              createdAt: when,
              // phase/job info will be enriched from testIndex below
              job: null,
              phase: null,
              runId: null
            });
            if (!testIndex[id]) {
              testIndex[id] = [
                { phase: null, job: null, jobName: '', createdAt: when, runId: null }
              ];
            } else if (!testIndex[id][0].createdAt && when) {
              testIndex[id][0].createdAt = when;
            }
          });
        } else {
          console.error(resultsError);
          logDebug('Error loading regression_test_results', resultsError);
        }

        populateSelects();
        renderTestsTable();
        setConnectionStatus(
          'Connected. Select baseline and comparison tests, then click "Compare Selected Tests".'
        );
      } catch (e) {
        console.error(e);
        setConnectionStatus('Failed to connect or load tests. Check console for details.', true);
        logDebug('connectAndLoadTests failed', e);
      } finally {
        document.getElementById('connectBtn').disabled = false;
      }
    }

    function populateSelects() {
      const baselineSelect = document.getElementById('baselineSelect');
      const currentSelect = document.getElementById('currentSelect');
      baselineSelect.innerHTML = '';
      currentSelect.innerHTML = '';

      const allIds = Object.keys(testIndex)
        .map(id => parseInt(id, 10))
        .filter(id => !Number.isNaN(id))
        .sort((a, b) => a - b);
      if (allIds.length === 0) {
        baselineSelect.innerHTML = '<option value="">No tests found</option>';
        currentSelect.innerHTML = '<option value="">No tests found</option>';
        baselineSelect.disabled = true;
        currentSelect.disabled = true;
        document.getElementById('compareBtn').disabled = true;
        return;
      }

      const makeLabel = (testId, meta) => {
        const m = meta[0];
        const jobPart = m.job != null ? `job ${m.job}` : 'job ?';
        const namePart = m.jobName ? ` ‚Äì ${m.jobName}` : '';
        const phasePart = m.phase ? ` ‚Äì phase: ${m.phase}` : '';
        const whenPart = m.createdAt ? ` ‚Äì ${m.createdAt}` : '';
        const isMasterBaseline = masterBaselineId !== null && testId === masterBaselineId;
        const baselineTag = isMasterBaseline ? ' [MASTER BASELINE]' : '';
        return `Test ${testId}${baselineTag} (${jobPart}${namePart}${phasePart}${whenPart})`;
      };

      const addOption = (select, value, label) => {
        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = label;
        select.appendChild(opt);
      };

      addOption(baselineSelect, '', 'Select baseline test‚Ä¶');
      addOption(currentSelect, '', 'Select comparison test‚Ä¶');

      allIds.forEach(id => {
        const label = makeLabel(id, testIndex[id]);
        addOption(baselineSelect, String(id), label);
        addOption(currentSelect, String(id), label);
      });

      baselineSelect.disabled = false;
      currentSelect.disabled = false;
      document.getElementById('compareBtn').disabled = false;
    }

    function renderTestsTable() {
      try {
        const tbody = document.querySelector('#testsTable tbody');
        if (!tbody) return;
        tbody.innerHTML = '';

        // Build an enriched list from testIndex and testsMeta
        const rows = [];
        Object.keys(testIndex).forEach(idStr => {
          const id = parseInt(idStr, 10);
          if (Number.isNaN(id)) return;
          const metaArr = testIndex[id] || [];
          const primary = metaArr[0] || {};
          rows.push({
            id,
            job: primary.job,
            phase: primary.phase || '',
            runId: primary.runId,
            createdAt: primary.createdAt || ''
          });
        });

        // If we have testsMeta with better timestamps, merge them
        testsMeta.forEach(tm => {
          const existing = rows.find(r => r.id === tm.id);
          if (!existing) {
            rows.push({
              id: tm.id,
              job: tm.job,
              phase: tm.phase,
              runId: tm.runId,
              createdAt: tm.createdAt
            });
          } else if (!existing.createdAt && tm.createdAt) {
            existing.createdAt = tm.createdAt;
          }
        });

        rows.sort((a, b) => a.id - b.id); // ascending by id

        rows.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="checkbox" class="test-select" data-id="${r.id}"></td>
            <td>${r.id}</td>
            <td>${r.job != null ? r.job : ''}</td>
            <td>${r.phase || ''}</td>
            <td>${r.runId != null ? r.runId : ''}</td>
            <td>${r.createdAt || ''}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error(e);
        logDebug('renderTestsTable failed', e);
      }
    }

    async function compareSelected() {
      if (!supabaseClient) {
        setComparisonStatus('Connect to Supabase first.', true);
        return;
      }
      const baselineId = document.getElementById('baselineSelect').value;
      const currentId = document.getElementById('currentSelect').value;
      if (!baselineId || !currentId) {
        setComparisonStatus('Select both baseline and comparison tests.', true);
        return;
      }
      await compareByIds(baselineId, currentId);
    }

    async function compareByIds(baselineId, currentId) {
      if (!supabaseClient) {
        setComparisonStatus('Connect to Supabase first.', true);
        return;
      }
      setComparisonStatus(
        `Loading results for baseline ${baselineId} and current ${currentId}‚Ä¶`
      );
      logDebug('Comparing tests', { baselineId, currentId });
      document.getElementById('compareBtn').disabled = true;

      try {
        const [baselineRes, currentRes] = await Promise.all([
          supabaseClient
            .from('regression_test_results')
            .select('results, created_at, job_id')
            .eq('id', baselineId)
            .single(),
          supabaseClient
            .from('regression_test_results')
            .select('results, created_at, job_id')
            .eq('id', currentId)
            .single()
        ]);
        if (baselineRes.error) throw baselineRes.error;
        if (currentRes.error) throw currentRes.error;

        const baselineResults = (baselineRes.data && baselineRes.data.results) || [];
        const currentResults = (currentRes.data && currentRes.data.results) || [];
        const baselineCreatedAt = formatDateTime(baselineRes.data.created_at);
        const currentCreatedAt = formatDateTime(currentRes.data.created_at);
        const baselineJobId = baselineRes.data && baselineRes.data.job_id;
        const currentJobId = currentRes.data && currentRes.data.job_id;

        const { html, summary } = buildComparisonHtml(
          parseInt(baselineId, 10),
          baselineCreatedAt,
          baselineJobId,
          parseInt(currentId, 10),
          currentCreatedAt,
          currentJobId,
          baselineResults,
          currentResults
        );
        document.getElementById('resultsContainer').innerHTML = html;
        setComparisonStatus(
          `Done. Better: ${summary.better}, Worse: ${summary.worse}, Mixed: ${summary.mixed}, Same: ${summary.same}.`
        );
        showSummaryModal(summary, baselineId, baselineCreatedAt, currentId, currentCreatedAt);

        // Remember last comparison so we can resort without re-querying
        lastComparison = {
          baselineId: parseInt(baselineId, 10),
          baselineCreatedAt,
          baselineJobId,
          currentId: parseInt(currentId, 10),
          currentCreatedAt,
          currentJobId,
          baselineResults,
          currentResults
        };
        attachTableSortClickHandlers();
      } catch (e) {
        console.error(e);
        setComparisonStatus('Error loading or comparing tests. Check console for details.', true);
        logDebug('compareSelected failed', e);
      } finally {
        document.getElementById('compareBtn').disabled = false;
      }
    }

    function buildComparisonHtml(
      baselineId,
      baselineCreatedAt,
      baselineJobId,
      currentId,
      currentCreatedAt,
      currentJobId,
      baselineResults,
      currentResults
    ) {
      const baselineMap = new Map();
      baselineResults.forEach(r => {
        if (r && r.query) baselineMap.set(String(r.query).toLowerCase(), r);
      });
      const currentMap = new Map();
      currentResults.forEach(r => {
        if (r && r.query) currentMap.set(String(r.query).toLowerCase(), r);
      });

      const rows = [];
      let better = 0,
        worse = 0,
        mixed = 0,
        same = 0;
      const categorySummary = {};

      QUERIES.forEach((query, idx) => {
        const qNum = idx + 1;
        const category = QUERY_CATEGORIES[idx] || 'Uncategorised';
        const key = query.toLowerCase();
        const baseEntry = baselineMap.get(key) || null;
        const currEntry = currentMap.get(key) || null;
        if (!baseEntry && !currEntry) return;

        const baseCounts = extractContentCounts(
          baseEntry && baseEntry.response && baseEntry.response.structured,
          query
        );
        const currCounts = extractContentCounts(
          currEntry && currEntry.response && currEntry.response.structured,
          query
        );
        const baseTopArticles = getTopItems(
          baseEntry && baseEntry.response && baseEntry.response.structured,
          'articles',
          1
        );
        const baseTopServices = getTopItems(
          baseEntry && baseEntry.response && baseEntry.response.structured,
          'services',
          1
        );
        const baseTopEvents = getTopItems(
          baseEntry && baseEntry.response && baseEntry.response.structured,
          'events',
          1
        );
        const currTopArticles = getTopItems(
          currEntry && currEntry.response && currEntry.response.structured,
          'articles',
          1
        );
        const currTopServices = getTopItems(
          currEntry && currEntry.response && currEntry.response.structured,
          'services',
          1
        );
        const currTopEvents = getTopItems(
          currEntry && currEntry.response && currEntry.response.structured,
          'events',
          1
        );

        const status = determineStatus(
          { ...baseCounts, topArticles: baseTopArticles },
          { ...currCounts, topArticles: currTopArticles }
        );
        if (status === 'better') better++;
        else if (status === 'worse') worse++;
        else if (status === 'mixed') mixed++;
        else same++;
        if (!categorySummary[category]) {
          categorySummary[category] = { better: 0, worse: 0, mixed: 0, same: 0 };
        }
        categorySummary[category][status] = (categorySummary[category][status] || 0) + 1;

        rows.push({
          qNum,
          query,
          category,
          baseline: {
            counts: baseCounts,
            topArticles: baseTopArticles,
            topServices: baseTopServices,
            topEvents: baseTopEvents
          },
          current: {
            counts: currCounts,
            topArticles: currTopArticles,
            topServices: currTopServices,
            topEvents: currTopEvents
          },
          status
        });
      });

      // Apply current sort to rows
      const statusOrder = { worse: 0, mixed: 1, better: 2, same: 3 };
      if (currentSortKey === 'category') {
        rows.sort((a, b) => {
          const c = a.category.localeCompare(b.category);
          return c !== 0 ? c : a.qNum - b.qNum;
        });
      } else if (currentSortKey === 'status') {
        rows.sort((a, b) => {
          const sa = statusOrder[a.status] ?? 99;
          const sb = statusOrder[b.status] ?? 99;
          return sa !== sb ? sa - sb : a.qNum - b.qNum;
        });
      } else if (currentSortKey === 'category_status') {
        rows.sort((a, b) => {
          const c = a.category.localeCompare(b.category);
          if (c !== 0) return c;
          const sa = statusOrder[a.status] ?? 99;
          const sb = statusOrder[b.status] ?? 99;
          return sa !== sb ? sa - sb : a.qNum - b.qNum;
        });
      }

      const summary = { better, worse, mixed, same, byCategory: categorySummary };

      const rowsHtml = rows
        .map(row => {
          const statusClass = 'status-' + row.status;
          const statusIcon =
            row.status === 'better'
              ? '‚úÖ'
              : row.status === 'worse'
              ? '‚ùå'
              : row.status === 'mixed'
              ? '‚ö†Ô∏è'
              : '‚ûñ';
          const statusLabel = row.status.charAt(0).toUpperCase() + row.status.slice(1);

          const baselineText = [
            row.baseline.counts.articles > 0
              ? `<div class="content-line"><span class="content-type">Articles:</span> ${
                  row.baseline.counts.articles
                }${
                  row.baseline.topArticles[0]
                    ? ` ("${row.baseline.topArticles[0].title.substring(0, 60)}${
                        row.baseline.topArticles[0].title.length > 60 ? '...' : ''
                      }" ID:${row.baseline.topArticles[0].id})`
                    : ''
                }</div>`
              : '',
            row.baseline.counts.services > 0
              ? `<div class="content-line"><span class="content-type">Services:</span> ${
                  row.baseline.counts.services
                }${
                  row.baseline.topServices[0]
                    ? ` ("${row.baseline.topServices[0].title.substring(0, 60)}${
                        row.baseline.topServices[0].title.length > 60 ? '...' : ''
                      }" ID:${row.baseline.topServices[0].id})`
                    : ''
                }</div>`
              : '',
            row.baseline.counts.events > 0
              ? `<div class="content-line"><span class="content-type">Events:</span> ${
                  row.baseline.counts.events
                }${
                  row.baseline.topEvents[0]
                    ? ` ("${row.baseline.topEvents[0].title.substring(0, 60)}${
                        row.baseline.topEvents[0].title.length > 60 ? '...' : ''
                      }")`
                    : ''
                }</div>`
              : ''
          ]
            .filter(Boolean)
            .join('') || '<div class="content-line"><em>(No content)</em></div>';

          const currentText = [
            row.current.counts.articles > 0
              ? `<div class="content-line"><span class="content-type">Articles:</span> ${
                  row.current.counts.articles
                }${
                  row.current.topArticles[0]
                    ? ` ("${row.current.topArticles[0].title.substring(0, 60)}${
                        row.current.topArticles[0].title.length > 60 ? '...' : ''
                      }" ID:${row.current.topArticles[0].id})`
                    : ''
                }</div>`
              : '',
            row.current.counts.services > 0
              ? `<div class="content-line"><span class="content-type">Services:</span> ${
                  row.current.counts.services
                }${
                  row.current.topServices[0]
                    ? ` ("${row.current.topServices[0].title.substring(0, 60)}${
                        row.current.topServices[0].title.length > 60 ? '...' : ''
                      }" ID:${row.current.topServices[0].id})`
                    : ''
                }</div>`
              : '',
            row.current.counts.events > 0
              ? `<div class="content-line"><span class="content-type">Events:</span> ${
                  row.current.counts.events
                }${
                  row.current.topEvents[0]
                    ? ` ("${row.current.topEvents[0].title.substring(0, 60)}${
                        row.current.topEvents[0].title.length > 60 ? '...' : ''
                      }")`
                    : ''
                }</div>`
              : ''
          ]
            .filter(Boolean)
            .join('') || '<div class="content-line"><em>(No content)</em></div>';

          const notes = generateNotes(row);

          return `
          <tr>
            <td class="question-num-col"><strong>Q${row.qNum}</strong></td>
            <td class="query-col">${row.query}</td>
            <td>${row.category}</td>
            <td>${baselineText}</td>
            <td>${currentText}</td>
            <td class="status-col ${statusClass}">${statusIcon} <strong>${statusLabel}</strong></td>
            <td class="notes-col">${notes}</td>
          </tr>`;
        })
        .join('\n');

      const html = `
      <h2>Summary Counts</h2>
      <table class="summary-table">
        <thead>
          <tr>
            <th>Status</th>
            <th>Count</th>
            <th>Percentage</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>‚úÖ <strong>Better</strong></td>
            <td>${better}</td>
            <td>${((better / QUERIES.length) * 100).toFixed(1)}%</td>
          </tr>
          <tr>
            <td>‚ùå <strong>Worse</strong></td>
            <td>${worse}</td>
            <td>${((worse / QUERIES.length) * 100).toFixed(1)}%</td>
          </tr>
          <tr>
            <td>‚ö†Ô∏è <strong>Mixed</strong></td>
            <td>${mixed}</td>
            <td>${((mixed / QUERIES.length) * 100).toFixed(1)}%</td>
          </tr>
          <tr>
            <td>‚ûñ <strong>Same</strong></td>
            <td>${same}</td>
            <td>${((same / QUERIES.length) * 100).toFixed(1)}%</td>
          </tr>
        </tbody>
      </table>

      <h2>Detailed Comparison Table</h2>
      <p><strong>Baseline Test:</strong> #${baselineId} (job ${baselineJobId ?? '?'}; ${baselineCreatedAt})<br>
      <strong>Current Test:</strong> #${currentId} (job ${currentJobId ?? '?'}; ${currentCreatedAt})<br>
      <strong>Total Queries:</strong> ${QUERIES.length}</p>

      <table class="comparison-table">
        <thead>
          <tr>
            <th class="question-num-col">Question</th>
            <th class="query-col">Query</th>
            <th id="sortCategoryHeader" style="cursor:pointer;">Category ‚áÖ</th>
            <th class="baseline-col">Baseline #${baselineId} (type: count, top item)</th>
            <th class="current-col">Current #${currentId} (type: count, top item)</th>
            <th class="status-col" id="sortStatusHeader" style="cursor:pointer;">Status ‚áÖ</th>
            <th class="notes-col">Notes</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}
        </tbody>
      </table>
      `;
      return { html, summary };
    }

    function showSummaryModal(summary, baselineId, baselineCreatedAt, currentId, currentCreatedAt) {
      try {
        const backdrop = document.getElementById('summaryModalBackdrop');
        const body = document.getElementById('summaryModalBody');
        const metaEl = document.getElementById('summaryModalMeta');
        if (!backdrop || !body || !metaEl) return;

        metaEl.innerHTML = `<small>Baseline: #${baselineId} (${baselineCreatedAt})<br>Current: #${currentId} (${currentCreatedAt})</small>`;

        const total = QUERIES.length || 40;
        const row = (label, icon, key) => `
          <tr>
            <td>${icon} <strong>${label}</strong></td>
            <td>${summary[key]}</td>
            <td>${((summary[key] / total) * 100).toFixed(1)}%</td>
          </tr>`;

        let html =
          row('Better', '‚úÖ', 'better') +
          row('Worse', '‚ùå', 'worse') +
          row('Mixed', '‚ö†Ô∏è', 'mixed') +
          row('Same', '‚ûñ', 'same');

        // Per-category breakdown
        if (summary.byCategory) {
          html += `
            <tr><td colspan="3"><strong>Per-category breakdown</strong></td></tr>
            <tr>
              <th>Category</th>
              <th colspan="2">Better / Worse / Mixed / Same</th>
            </tr>`;
          Object.keys(summary.byCategory)
            .sort()
            .forEach(cat => {
              const c = summary.byCategory[cat];
              html += `
                <tr>
                  <td>${cat}</td>
                  <td>‚úÖ ${c.better || 0} &nbsp; ‚ùå ${c.worse || 0} &nbsp; ‚ö†Ô∏è ${c.mixed || 0} &nbsp; ‚ûñ ${c.same || 0}</td>
                </tr>`;
            });
        }

        body.innerHTML = html;

        backdrop.style.display = 'flex';
      } catch (e) {
        console.error(e);
        logDebug('showSummaryModal failed', e);
      }
    }

    // Re-render the last comparison using the current sort key
    function rerenderLastComparison() {
      if (!lastComparison) return;
      const {
        baselineId,
        baselineCreatedAt,
        baselineJobId,
        currentId,
        currentCreatedAt,
        currentJobId,
        baselineResults,
        currentResults
      } = lastComparison;
      const { html, summary } = buildComparisonHtml(
        baselineId,
        baselineCreatedAt,
        baselineJobId,
        currentId,
        currentCreatedAt,
        currentJobId,
        baselineResults,
        currentResults
      );
      document.getElementById('resultsContainer').innerHTML = html;
      setComparisonStatus(
        `Done. Better: ${summary.better}, Worse: ${summary.worse}, Mixed: ${summary.mixed}, Same: ${summary.same}.`
      );
      attachTableSortClickHandlers();
    }

    function attachTableSortClickHandlers() {
      const catHeader = document.getElementById('sortCategoryHeader');
      const statusHeader = document.getElementById('sortStatusHeader');
      const updateHeaderIndicators = () => {
        if (catHeader) {
          catHeader.textContent = currentSortKey === 'category' ? 'Category ‚ñ≤' : 'Category ‚áÖ';
        }
        if (statusHeader) {
          statusHeader.textContent = currentSortKey === 'status' ? 'Status ‚ñ≤' : 'Status ‚áÖ';
        }
      };
      updateHeaderIndicators();
      if (catHeader) {
        catHeader.onclick = () => {
          currentSortKey = currentSortKey === 'category' ? 'none' : 'category';
          rerenderLastComparison();
        };
      }
      if (statusHeader) {
        statusHeader.onclick = () => {
          currentSortKey = currentSortKey === 'status' ? 'none' : 'status';
          rerenderLastComparison();
        };
      }
    }

    async function run40qFromUi() {
      setRunStatus('');
      try {
        const jobIdRaw = document.getElementById('runJobId').value.trim();
        const jobId = jobIdRaw ? parseInt(jobIdRaw, 10) : 999;
        if (!jobId || Number.isNaN(jobId)) {
          setRunStatus('Enter a valid job id (e.g. 31 or 999).', true);
          return;
        }
        const testPhase = document.getElementById('runTestPhase').value || 'after';
        const jobNameInput = document.getElementById('runJobName').value.trim();
        const jobName = jobNameInput || `Job ${jobId} (UI 40Q run)`;
        const adminToken = document.getElementById('adminToken').value.trim();
        if (!adminToken) {
          setRunStatus('Admin API token (Authorization bearer) is required to call /api/admin.', true);
          return;
        }
        // Remember admin token locally for convenience (browser storage only)
        try {
          window.localStorage.setItem('regression_admin_token', adminToken);
        } catch (e) {
          console.warn('Unable to store admin token in localStorage', e);
        }

        setRunStatus(`Starting 40Q regression test for job ${jobId} (${testPhase})‚Ä¶`);
        const progressEl = document.getElementById('runProgress');
        if (progressEl) progressEl.style.display = 'block';
        const res = await fetch('/api/admin?action=run_regression_test', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ job_id: jobId, job_name: jobName, test_phase: testPhase })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          const errMsg = data && data.error ? data.error : 'Failed to run regression test';
          logDebug('run40qFromUi error response', { status: res.status, data });
          throw new Error(errMsg);
        }

        setRunStatus(
          `40Q test started. New test_result_id: ${data.test_result_id}. Successful: ${data.successful_tests}, Failed: ${data.failed_tests}, Avg confidence: ${data.avg_confidence?.toFixed?.(
            2
          ) || data.avg_confidence}.`
        );

        // Automatically compare master baseline vs new test and show summary modal
        try {
          const baselineSelect = document.getElementById('baselineSelect');
          const currentSelect = document.getElementById('currentSelect');
          let baselineId = null;

          // Prefer official fixed baseline from /api/admin
          const fixedRes = await fetch('/api/admin?action=get_fixed_baseline', {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${adminToken}`
            }
          });
          if (fixedRes.ok) {
            const fixedData = await fixedRes.json();
            if (fixedData && fixedData.ok && fixedData.fixed_baseline && fixedData.fixed_baseline.id) {
              baselineId = String(fixedData.fixed_baseline.id);
            }
          }

          // Fallback: look for option tagged as [MASTER BASELINE]
          if (!baselineId && baselineSelect && baselineSelect.options) {
            const opts = baselineSelect.options;
            for (let i = 0; i < opts.length; i++) {
              const label = String(opts[i].textContent || '');
              if (label.includes('[MASTER BASELINE]')) {
                baselineId = opts[i].value;
                break;
              }
            }
          }

          if (baselineId && typeof compareByIds === 'function') {
            // Also update selects for UI consistency (even if the option doesn't exist yet)
            if (baselineSelect) baselineSelect.value = baselineId;
            if (currentSelect) currentSelect.value = String(data.test_result_id);
            await compareByIds(baselineId, String(data.test_result_id));
          } else {
            logDebug('Auto-compare skipped (no baseline or selects)', { baselineId });
          }
        } catch (autoErr) {
          console.error('Auto-compare after 40Q run failed', autoErr);
          logDebug('autoCompareAfterRun failed', String(autoErr));
        }
      } catch (e) {
        console.error(e);
        setRunStatus('Error running 40Q regression test. Check console/logs.', true);
        logDebug('run40qFromUi failed', e);
      } finally {
        const progressEl = document.getElementById('runProgress');
        if (progressEl) progressEl.style.display = 'none';
      }
    }

    async function setMasterBaselineFromUi() {
      try {
        const baselineIdStr = document.getElementById('baselineSelect').value;
        const adminToken = document.getElementById('adminToken').value.trim();
        if (!baselineIdStr) {
          alert('Select a baseline test first.');
          return;
        }
        if (!adminToken) {
          alert('Admin API token is required to set the master baseline.');
          return;
        }
        const baselineId = parseInt(baselineIdStr, 10);
        if (!baselineId || Number.isNaN(baselineId)) {
          alert('Invalid baseline test id.');
          return;
        }

        // Find job_id (any test can be set as baseline, regardless of phase)
        let jobId = null;
        const metaArr = testIndex[baselineId] || [];
        if (metaArr[0] && metaArr[0].job != null) {
          jobId = metaArr[0].job;
        }

        if (!supabaseClient) {
          alert('Connect to Supabase first so we can verify the baseline.');
          return;
        }

        const { data: baselineRow, error } = await supabaseClient
          .from('regression_test_results')
          .select('id, job_id, test_phase')
          .eq('id', baselineId)
          .single();

        if (error || !baselineRow) {
          console.error(error);
          logDebug('setMasterBaselineFromUi: failed to load regression_test_results row', error || baselineRow);
          alert('Unable to load baseline details from database.');
          return;
        }

        jobId = jobId != null ? jobId : baselineRow.job_id;
        if (!jobId) {
          alert('Test has no job_id; cannot set as master baseline.');
          return;
        }

        const phase = baselineRow.test_phase || 'unknown';
        if (!confirm(`Set test #${baselineId} (job ${jobId}, phase "${phase}") as the MASTER baseline for all jobs?\n\nThis will:\n- Unset any existing master baseline\n- Mark this test as is_fixed_baseline = true\n- Cron dashboard and regression wrappers will use this new baseline id for comparisons.`)) {
          return;
        }

        logDebug('Setting master baseline via /api/admin', { baselineId, jobId });

        const res = await fetch('/api/admin?action=set_fixed_baseline', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ test_result_id: baselineId, job_id: jobId })
        });
        const data = await res.json();

        if (!res.ok || !data.ok) {
          console.error('Error from set_fixed_baseline', data);
          logDebug('setMasterBaselineFromUi error response', { status: res.status, data });
          alert(`Failed to set master baseline: ${data.error || 'unknown error'}`);
          return;
        }

        logDebug('Master baseline updated', data);
        alert('Master baseline updated successfully. Cron dashboard will now use this baseline id.');
      } catch (e) {
        console.error(e);
        logDebug('setMasterBaselineFromUi failed', e);
        alert('Error setting master baseline. See debug log for details.');
      }
    }

    function copyDebugLog() {
      try {
        const text = debugLines.join('\n');
        if (!text) {
          alert('Debug log is empty.');
          return;
        }
        navigator.clipboard.writeText(text).then(
          () => {
            logDebug('Debug log copied to clipboard');
          },
          err => {
            console.error(err);
            logDebug('Failed to copy debug log', err);
          }
        );
      } catch (e) {
        console.error(e);
        logDebug('copyDebugLog failed', e);
      }
    }

    document.getElementById('connectBtn').addEventListener('click', connectAndLoadTests);
    document.getElementById('compareBtn').addEventListener('click', compareSelected);
    document.getElementById('run40qBtn').addEventListener('click', run40qFromUi);
    document.getElementById('copyDebugBtn').addEventListener('click', copyDebugLog);
    document.getElementById('refreshTestsBtn').addEventListener('click', connectAndLoadTests);
    document.getElementById('deleteTestsBtn').addEventListener('click', async () => {
      if (!supabaseClient) {
        setConnectionStatus('Connect to Supabase first.', true);
        return;
      }
      try {
        const statusEl = document.getElementById('manageTestsStatus');
        const checkboxes = Array.from(document.querySelectorAll('.test-select'));
        const selectedIds = checkboxes
          .filter(cb => cb.checked)
          .map(cb => parseInt(cb.getAttribute('data-id'), 10))
          .filter(id => !Number.isNaN(id));
        if (!selectedIds.length) {
          if (statusEl) statusEl.textContent = 'No tests selected.';
          return;
        }
        if (!confirm(`Delete ${selectedIds.length} test(s) from regression_test_results and unlink from runs?`)) {
          return;
        }
        if (statusEl) statusEl.textContent = 'Deleting selected tests‚Ä¶';
        logDebug('Deleting tests', { ids: selectedIds });

        const { error: delResultsError } = await supabaseClient
          .from('regression_test_results')
          .delete()
          .in('id', selectedIds);
        if (delResultsError) {
          console.error(delResultsError);
          logDebug('Error deleting regression_test_results', delResultsError);
          if (statusEl) statusEl.textContent = 'Error deleting tests (results). Check logs.';
          return;
        }

        // Null out references in regression_test_runs so history remains but without these tests
        const { error: updateRunsError } = await supabaseClient
          .from('regression_test_runs')
          .update({ baseline_test_id: null })
          .in('baseline_test_id', selectedIds);
        if (updateRunsError) {
          console.error(updateRunsError);
          logDebug('Error nulling baseline_test_id in regression_test_runs', updateRunsError);
        }
        const { error: updateRunsError2 } = await supabaseClient
          .from('regression_test_runs')
          .update({ after_test_id: null })
          .in('after_test_id', selectedIds);
        if (updateRunsError2) {
          console.error(updateRunsError2);
          logDebug('Error nulling after_test_id in regression_test_runs', updateRunsError2);
        }

        if (statusEl) statusEl.textContent = 'Deleted selected tests.';
        // Refresh lists
        await connectAndLoadTests();
      } catch (e) {
        console.error(e);
        logDebug('Delete tests handler failed', e);
      }
    });
    document.getElementById('closeSummaryModalBtn').addEventListener('click', () => {
      const backdrop = document.getElementById('summaryModalBackdrop');
      if (backdrop) backdrop.style.display = 'none';
    });
    document.getElementById('selectAllTests').addEventListener('change', (e) => {
      const checked = e.target.checked;
      document.querySelectorAll('.test-select').forEach(cb => {
        cb.checked = checked;
      });
    });
    document.getElementById('setMasterBaselineBtn').addEventListener('click', setMasterBaselineFromUi);
    const sortByEl = document.getElementById('sortBy');
    if (sortByEl) {
      sortByEl.addEventListener('change', (e) => {
        currentSortKey = e.target.value || 'none';
        rerenderLastComparison();
      });
    }
    window.addEventListener('DOMContentLoaded', prefillSupabaseCreds);
  </script>
</body>
</html>


