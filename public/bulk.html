<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload URL List to Train AI Bot</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0d1117;
      color: #e6edf3;
      margin: 0;
      padding: 20px;
    }
    h1 { font-size: 1.5rem; margin-bottom: 1rem; }
    button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-green { background: #2ea043; color: #fff; }
    .btn-red { background: #da3633; color: #fff; }
    .btn-blue { background: #388bfd; color: #fff; }
    .counter { font-weight: 600; margin-left: 4px; }
    .ok { color: #2ea043; }
    .fail { color: #da3633; }
    .stopped { color: #8b949e; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 8px; border-bottom: 1px solid #30363d; }
    th { text-align: left; color: #8b949e; }
    .debug {
      background: #161b22;
      padding: 8px;
      margin-top: 12px;
      font-family: monospace;
      white-space: pre-wrap;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>Upload URL List to Train AI Bot</h1>

  <div>
    <label>INGEST TOKEN (BEARER)</label><br/>
    <input id="bearer" type="text" placeholder="Bearer token" style="width: 40%">
    <input id="csvFile" type="file" accept=".csv"/>
    <br/><small>Saved locally (browser only). Sent as Authorization: Bearer …</small>
  </div>
  <br/>

  <div>
    <label>Test a Single URL</label><br/>
    <input id="singleUrl" type="text" placeholder="https://example.com/page" style="width:60%">
    <button class="btn-blue" onclick="testSingle()">Test Single URL</button>
  </div>
  <br/>

  <div>
    <label>Paste URLs (one per line) — OPTIONAL</label><br/>
    <textarea id="urlList" rows="4" style="width:60%" placeholder="https://example.com/page-1&#10;https://example.com/page-2"></textarea>
    <br/><br/>
    <button id="crawlBtn" class="btn-green" onclick="crawl()">Crawl & Ingest</button>
    <button class="btn-red" onclick="stop()">Stop</button>
    <span class="counter ok">Success: <span id="success">0</span></span>
    <span class="counter fail">Failed: <span id="failed">0</span></span>
    <span class="counter stopped">Stopped: <span id="stopped">0</span></span>
    <span class="counter">Loaded <span id="loaded">0</span> rows</span>
  </div>

  <div class="debug" id="debug"></div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>URL</th>
        <th>Result (includes DB verify)</th>
      </tr>
    </thead>
    <tbody id="results"></tbody>
  </table>

  <h3>AI Search Tester</h3>
  <input id="searchQuery" type="text" placeholder="e.g. photography workshops in Coventry" style="width:60%">
  <input id="topk" type="number" value="8" style="width:60px">
  <button class="btn-blue" onclick="search()">Run Search</button>
  <pre class="debug" id="searchRaw" style="display:none"></pre>
  <div id="searchResults"></div>

  <h3>AI Bot (RAG)</h3>
  <input id="askQuery" type="text" placeholder="Ask about workshops, tips, ..." style="width:60%">
  <input id="askTopk" type="number" value="8" style="width:60px">
  <button class="btn-blue" onclick="ask()">Ask</button>
  <div id="askResult" class="debug"></div>

  <script>
    const debug = msg => {
      const el = document.getElementById('debug');
      el.textContent += msg + "\\n";
      el.scrollTop = el.scrollHeight;
    };

    async function testSingle() {
      const url = document.getElementById('singleUrl').value;
      debug(`[Single test] ${url}`);
      const r = await fetch('/api/ingest-embed-replace', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json',
                   Authorization: 'Bearer ' + document.getElementById('bearer').value },
        body: JSON.stringify({ url })
      });
      const j = await r.json();
      debug(JSON.stringify(j,null,2));
    }

    async function crawl() {
      const urls = document.getElementById('urlList').value.trim().split(/\\n+/);
      const results = document.getElementById('results');
      results.innerHTML = '';
      let idx = 1;
      for (let url of urls) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx++}</td><td>${url}</td><td>Processing…</td>`;
        results.appendChild(tr);
        try {
          const r = await fetch('/api/ingest-embed-replace', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json',
                       Authorization: 'Bearer ' + document.getElementById('bearer').value },
            body: JSON.stringify({ url })
          });
          const j = await r.json();
          if (j?.ok) {
            // Verify against DB
            const vr = await fetch('/api/db-verify?url=' + encodeURIComponent(url));
            const vj = await vr.json();
            if (vj?.ok) {
              tr.cells[2].innerHTML = `OK id=${j.id} len=${j.len} chunks=${j.chunks} | DB: chunks=${vj.chunks} len=${vj.len}`;
              tr.cells[2].classList.add('ok');
            } else {
              tr.cells[2].innerHTML = `OK id=${j.id} len=${j.len} chunks=${j.chunks} | DB verify failed`;
              tr.cells[2].classList.add('fail');
            }
            document.getElementById('success').textContent++;
          } else {
            tr.cells[2].textContent = 'FAILED';
            tr.cells[2].classList.add('fail');
            document.getElementById('failed').textContent++;
          }
        } catch (e) {
          tr.cells[2].textContent = 'ERROR';
          tr.cells[2].classList.add('fail');
        }
      }
    }

    async function search() {
      const q = document.getElementById('searchQuery').value;
      const k = document.getElementById('topk').value;
      const r = await fetch('/api/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: q, topk: parseInt(k) })
      });
      const j = await r.json();
      document.getElementById('searchRaw').style.display = 'block';
      document.getElementById('searchRaw').textContent = JSON.stringify(j,null,2);
    }

    async function ask() {
      const q = document.getElementById('askQuery').value;
      const k = document.getElementById('askTopk').value;
      const r = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: q, topk: parseInt(k) })
      });
      const j = await r.json();
      document.getElementById('askResult').textContent = JSON.stringify(j,null,2);
    }

    function stop() { debug('Stopped by user.'); }
  </script>
</body>
</html>
