<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Upload URL List to Train AI Bot — bulk (v0.3.3)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;         /* slate-900 */
      --panel: #111827;      /* gray-900 */
      --muted: #94a3b8;      /* slate-400 */
      --txt: #e5e7eb;        /* gray-200 */
      --ok: #22c55e;         /* green-500 */
      --warn: #f97316;       /* orange-500 */
      --err: #ef4444;        /* red-500 */
      --accent: #3b82f6;     /* blue-500 */
      --border: #1f2937;     /* gray-800 */
    }
    html, body {
      margin: 0; padding: 0; background: var(--bg); color: var(--txt);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap { max-width: 1100px; margin: 20px auto 80px; padding: 0 14px; }
    h1 { font-size: 20px; margin: 0 0 14px; display:flex; align-items:center; gap:10px; }
    .version { font-size: 12px; padding:2px 6px; border-radius: 6px; background: #0b1220; color: var(--muted); border: 1px solid var(--border); }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
    .card { background: var(--panel); border:1px solid var(--border); border-radius: 12px; padding: 16px; }
    .row { display:flex; gap: 10px; align-items:center; }
    label { color: var(--muted); font-size: 12px; }
    input[type=text], input[type=number] {
      width: 100%; background: #0b1220; border:1px solid var(--border); color: var(--txt);
      padding: 10px 12px; border-radius: 10px; outline: none;
    }
    input[type=file] {
      width: 100%; color: var(--txt);
    }
    textarea {
      width: 100%; min-height: 140px; background: #0b1220; border:1px solid var(--border); color: var(--txt);
      padding: 10px 12px; border-radius: 10px; outline: none; resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    button {
      background: var(--accent); color: white; border: none; border-radius: 10px; padding: 10px 14px; cursor: pointer;
      font-weight: 600;
    }
    button.secondary { background: #374151; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#0b1220; border:1px solid var(--border); color: var(--muted); font-size: 12px; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { border-bottom:1px solid var(--border); padding: 10px; text-align: left; vertical-align: top; }
    .table th { color: var(--muted); font-weight: 600; }
    .ok { color: var(--ok); font-weight: 700; }
    .err { color: var(--err); font-weight: 700; }
    details { border:1px solid var(--border); border-radius: 12px; background: var(--panel); }
    summary { padding: 12px 14px; cursor: pointer; color: var(--muted); user-select: none; }
    .console { padding: 12px 14px; border-top:1px solid var(--border); max-height: 260px; overflow:auto; }
    .log { font-family: ui-monospace, Menlo, Consolas, monospace; white-space: pre-wrap; margin: 0 0 8px; }
    .log.err { color: var(--err); }
    .statbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    a { color: #93c5fd; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .muted { color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Upload URL List to Train AI Bot <span class="version">v0.3.3</span></h1>

    <!-- Controls -->
    <div class="grid">
      <div class="card">
        <div class="row" style="gap:12px; align-items:flex-end;">
          <div style="flex:1;">
            <label>INGEST TOKEN (BEARER)</label>
            <input id="token" type="text" placeholder="Bearer token…" />
            <div class="muted" id="tokenSaved" style="margin-top:4px;"></div>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="saveToken" class="secondary">Save</button>
          </div>
        </div>

        <div class="row" style="margin-top:12px; gap:12px;">
          <div style="flex:1;">
            <label>CSV FILE</label>
            <input id="csv" type="file" accept=".csv" />
            <div class="muted">Must include a <strong>url</strong> column (optional <code>title</code>).</div>
          </div>
          <div style="width: 220px;">
            <label>CONCURRENCY</label>
            <input id="concurrency" type="number" min="1" max="10" value="3" />
          </div>
          <div style="width: 260px;">
            <label>DELAY BETWEEN REQUESTS (MS)</label>
            <input id="delay" type="number" min="0" step="50" value="400" />
          </div>
        </div>
      </div>

      <div class="card">
        <label>Test a Single URL</label>
        <div class="row" style="gap:12px;">
          <input id="singleUrl" type="text" placeholder="https://example.com/page" />
          <button id="btnSingle">Test Single URL</button>
        </div>
        <pre id="singleOut" class="log" style="margin-top:12px; background:#0b1220; border:1px solid var(--border); padding:12px; border-radius:10px;"></pre>
      </div>
    </div>

    <div class="card" style="margin-top:18px;">
      <label>Paste URLs (one per line) — OPTIONAL</label>
      <textarea id="urls" placeholder="https://example.com/page-1&#10;https://example.com/page-2"></textarea>
      <div class="row" style="gap:10px; margin-top:10px;">
        <button id="btnRun">Crawl &amp; Ingest</button>
        <button id="btnStop" class="secondary">Stop</button>
        <div class="statbar">
          <span class="pill">Loaded <span id="loaded">0</span> rows</span>
          <span class="pill">Success: <span id="okCount">0</span></span>
          <span class="pill">Failed: <span id="failCount">0</span></span>
          <span class="pill">Stopped: <span id="stopped">0</span></span>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:18px;">
      <table class="table" id="results">
        <thead>
          <tr>
            <th style="width:50px;">#</th>
            <th>URL</th>
            <th>Result <span class="muted">(includes DB verify)</span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <details style="margin-top:18px;" id="dbg">
      <summary>Debug console (failed only)</summary>
      <div class="console" id="console"></div>
    </details>
  </div>

  <script>
    // ---------------- State ----------------
    const els = {
      token: document.getElementById('token'),
      tokenSaved: document.getElementById('tokenSaved'),
      saveToken: document.getElementById('saveToken'),
      csv: document.getElementById('csv'),
      concurrency: document.getElementById('concurrency'),
      delay: document.getElementById('delay'),
      singleUrl: document.getElementById('singleUrl'),
      btnSingle: document.getElementById('btnSingle'),
      singleOut: document.getElementById('singleOut'),
      urls: document.getElementById('urls'),
      btnRun: document.getElementById('btnRun'),
      btnStop: document.getElementById('btnStop'),
      loaded: document.getElementById('loaded'),
      okCount: document.getElementById('okCount'),
      failCount: document.getElementById('failCount'),
      stopped: document.getElementById('stopped'),
      results: document.getElementById('results').querySelector('tbody'),
      console: document.getElementById('console'),
      dbg: document.getElementById('dbg')
    };

    const logs = []; // { level:'error', msg:string }
    function logError(msg) { logs.push({level:'error', msg}); renderConsole(); }
    function renderConsole() {
      // Only show failed/error logs
      const out = logs.filter(l => l.level === 'error').map(l => `<div class="log err">• ${escapeHtml(l.msg)}</div>`).join('');
      els.console.innerHTML = out || '<div class="muted">No errors.</div>';
    }
    function escapeHtml(s){return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;' }[c]));}

    // ---------------- Token ----------------
    const LS_TOKEN = 'ingest_token';
    (function initToken(){
      const t = localStorage.getItem(LS_TOKEN) || '';
      if (t) { els.token.value = t; els.tokenSaved.textContent = 'Saved locally; sent as Authorization: Bearer …'; }
    })();
    els.saveToken.addEventListener('click', ()=>{
      localStorage.setItem(LS_TOKEN, els.token.value.trim());
      els.tokenSaved.textContent = 'Saved locally; sent as Authorization: Bearer …';
    });

    // ---------------- Helpers ----------------
    function bearer() {
      const t = (els.token.value || '').trim();
      return t ? `Bearer ${t}` : '';
    }

    function delay(ms){ return new Promise(r => setTimeout(r, ms)); }

    // naive but safe-enough CSV parser (handles quoted commas)
    function parseCsv(text) {
      const rows = [];
      let i = 0, cur = '', row = [], inQ = false;
      const push = () => { row.push(cur); cur=''; };
      const endRow = () => { rows.push(row); row=[]; };
      while (i < text.length) {
        const ch = text[i++];
        if (inQ) {
          if (ch === '"') {
            if (text[i] === '"') { cur += '"'; i++; }
            else inQ = false;
          } else cur += ch;
        } else {
          if (ch === '"') inQ = true;
          else if (ch === ',') push();
          else if (ch === '\n') { push(); endRow(); }
          else if (ch === '\r') { /* ignore */ }
          else cur += ch;
        }
      }
      push(); endRow();
      return rows;
    }

    function extractUrlsFromCsv(text) {
      const rows = parseCsv(text).filter(r => r.length && r.some(x => String(x).trim() !== ''));
      if (!rows.length) return [];
      const header = rows[0].map(x => String(x).trim().toLowerCase());
      const uIdx = header.indexOf('url');
      if (uIdx === -1) return [];
      return rows.slice(1).map(r => (r[uIdx] || '').trim()).filter(Boolean);
    }

    function rowEl(i, url) {
      const tr = document.createElement('tr');
      const n = document.createElement('td'); n.textContent = String(i+1);
      const u = document.createElement('td');
      const a = document.createElement('a'); a.href=url; a.target='_blank'; a.textContent=url; u.appendChild(a);
      const r = document.createElement('td'); r.innerHTML = '<span class="muted">Queued…</span>';
      tr.appendChild(n); tr.appendChild(u); tr.appendChild(r);
      els.results.appendChild(tr);
      return { tr, rcell: r };
    }

    async function callIngest(url){
      // small client-side retry for transient upstream 503s
      const headers = { 'Content-Type':'application/json', 'Authorization': bearer() };
      const body = JSON.stringify({ url });
      const max = 2;
      for (let attempt=0; attempt<=max; attempt++){
        try{
          const res = await fetch('/api/ingest-embed-replace', { method:'POST', headers, body });
          const txt = await res.text();
          let j;
          try { j = JSON.parse(txt); } catch { j = { ok:false, error:'bad_json', detail:txt }; }
          if (!res.ok || j?.ok === false){
            const detail = (j?.detail || j?.error || res.statusText || 'unknown').toString();
            const transient = /openai_error:503|upstream connect error|connection termination|ECONNRESET|ETIMEDOUT/i.test(detail);
            if (transient && attempt < max) {
              await delay(600 * (attempt+1));
              continue;
            }
            throw new Error(detail);
          }
          return j;
        } catch (e) {
          if (attempt === max) throw e;
          await delay(600 * (attempt+1));
        }
      }
    }

    async function verifyUrl(url){
      try {
        const res = await fetch(`/api/tools?action=verify&url=${encodeURIComponent(url)}`, {
          headers: { 'Authorization': bearer() }
        });
        const j = await res.json().catch(()=>null);
        return j || {};
      } catch {
        return {};
      }
    }

    // ---------------- Single URL ----------------
    els.btnSingle.addEventListener('click', async ()=>{
      const url = els.singleUrl.value.trim();
      if (!url) return;
      els.singleOut.textContent = '…';
      try {
        const data = await callIngest(url);
        els.singleOut.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        const msg = `Single ingest failed for ${url}\n${e && e.message ? e.message : e}`;
        logError(msg);
        els.singleOut.textContent = JSON.stringify({ ok:false, error:String(e?.message||e) }, null, 2);
      }
    });

    // ---------------- Batch runner ----------------
    let stopFlag = false;
    els.btnStop.addEventListener('click', ()=>{ stopFlag = true; els.stopped.textContent = String( Number(els.stopped.textContent)+1 ); });

    async function* urlSource(){
      // from CSV
      const f = els.csv.files[0];
      if (f) {
        const text = await f.text();
        const urls = extractUrlsFromCsv(text);
        for (const u of urls) yield u;
      }
      // and pasted
      for (const u of (els.urls.value || '').split(/\r?\n/).map(s=>s.trim()).filter(Boolean)) {
        yield u;
      }
    }

    els.btnRun.addEventListener('click', async ()=>{
      stopFlag = false;
      els.results.innerHTML = '';
      els.okCount.textContent = '0';
      els.failCount.textContent = '0';

      const conc = Math.max(1, Math.min(10, Number(els.concurrency.value || 3)));
      const gap = Math.max(0, Number(els.delay.value || 0));

      // gather URLs
      const all = [];
      for await (const u of urlSource()) all.push(u);
      els.loaded.textContent = String(all.length);

      let idx = 0;
      const runNext = async () => {
        if (stopFlag) return;
        const i = idx++;
        if (i >= all.length) return;
        const url = all[i];
        const row = rowEl(i, url);

        try {
          await delay(gap * (i % conc)); // light staggering
          const ingest = await callIngest(url);
          // optional verify
          const v = await verifyUrl(url);
          const dbText = v && v.ok ? ` | DB: chunks=${v.chunks ?? '?'} len=${v.len ?? '?'}` : '';
          row.rcell.innerHTML = `<span class="ok">OK</span> id=${ingest.id ?? '—'} len=${ingest.len ?? '—'} chunks=${ingest.chunks ?? '—'}${dbText}`;
          els.okCount.textContent = String(Number(els.okCount.textContent)+1);
        } catch (e) {
          const msg = `FAILED ${url} — ${e && e.message ? e.message : e}`;
          row.rcell.innerHTML = `<span class="err">FAILED</span> ${escapeHtml(String(e?.message||e))}`;
          els.failCount.textContent = String(Number(els.failCount.textContent)+1);
          logError(msg);
        } finally {
          // schedule another
          await runNext();
        }
      };

      // start pool
      const starters = Array.from({length: conc}, () => runNext());
      await Promise.all(starters);
    });

    // start collapsed
    els.dbg.open = false;
  </script>
</body>
</html>
