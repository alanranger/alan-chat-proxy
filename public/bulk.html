<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload URL List to Train AI Bot</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#6b7280; --text:#e5e7eb; --accent:#60a5fa;
      --ok:#22c55e; --err:#ef4444; --warn:#f59e0b; --border:#1f2937;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1200px;margin:26px auto;padding:0 16px}
    h1{margin:0 0 18px;font-size:22px}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr 1fr}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="number"], input[type="file"], textarea, select {
      width:100%; background:#0b1220; color:var(--text); border:1px solid var(--border);
      border-radius:8px; padding:10px; outline:none;
    }
    textarea{min-height:120px; resize:vertical}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{
      appearance:none; border:0; padding:10px 14px; border-radius:8px; cursor:pointer;
      color:#fff; background:#1f2937;
    }
    .btn-primary{background:var(--accent)}
    .btn-ghost{background:#1f2937}
    .btn-danger{background:#b91c1c}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
    details{background:var(--panel);border:1px solid var(--border);border-radius:10px;margin-top:14px}
    summary{padding:10px 14px;cursor:pointer;color:var(--muted)}
    .console{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:#0b1220;border-top:1px solid var(--border);max-height:220px;overflow:auto;padding:10px;white-space:pre-wrap}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{border-top:1px solid var(--border);padding:8px 10px;vertical-align:top}
    th{position:sticky;top:0;background:#0b1220}
    .url-cell{word-break:break-all}
    .status-ok{color:var(--ok)} .status-fail{color:var(--err)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Upload URL List to Train AI Bot</h1>

    <div class="grid">
      <!-- Token -->
      <div class="card">
        <div class="label">Ingest Token (Bearer)</div>
        <input id="token" type="text" placeholder="paste your ingest token"
               value="b6c30c9e6f44cce9e1a4f3f2d3a5c676" />
        <div class="muted" style="margin-top:6px">Saved locally (browser only). Sent as
          <span class="pill" style="background:#0b1220">Authorization: Bearer …</span>
        </div>
      </div>

      <!-- CSV + paste -->
      <div class="card">
        <div class="label">CSV file (must include a <b>url</b> column) — or paste URLs below (one per line)</div>
        <div class="row">
          <input id="csv" type="file" accept=".csv,text/csv" />
          <button id="btnStart" class="btn-primary">Crawl &amp; Ingest</button>
          <button id="btnStop" class="btn-ghost">Stop</button>
        </div>
        <div class="label" style="margin-top:10px">Paste URLs (one per line)</div>
        <textarea id="paste" placeholder="https://example.com/page-1
https://example.com/page-2"></textarea>
      </div>

      <!-- Concurrency -->
      <div class="card">
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
          <div>
            <div class="label">Concurrency</div>
            <input id="concurrency" type="number" min="1" max="12" value="3" />
          </div>
          <div>
            <div class="label">Delay between requests (ms)</div>
            <input id="delay" type="number" min="0" step="50" value="400" />
          </div>
        </div>
        <div class="muted" style="margin-top:8px">Each row goes to
          <span class="pill" style="background:#0b1220">/api/ingest-embed-replace</span>
          (server fetches, chunks, embeds, replaces existing rows).
        </div>
      </div>
    </div>

    <details open>
      <summary>CSV format (click to expand)</summary>
      <div class="console" id="fmt">
        CSV must include a header named <b>url</b>, for example:

        url,title
        https://www.example.com/page-1,Optional title 1
        https://www.example.com/page-2,Optional title 2

        Tip: You can also skip the CSV and paste URLs (one per line) in the box above.
      </div>
    </details>

    <details open>
      <summary>Debug console (what the client sees)</summary>
      <div class="console" id="log"></div>
    </details>

    <div class="card" style="margin-top:14px">
      <div class="row" style="justify-content:space-between;margin-bottom:6px">
        <div><span id="rowCount">Loaded 0 rows.</span>
          <span class="ok" id="okCount">Success: 0</span>,
          <span class="err" id="failCount">Failed: 0</span>.
        </div>
      </div>

      <div style="overflow:auto;max-height:52vh">
        <table id="resultsTbl">
          <thead>
          <tr><th style="width:48px">#</th><th>URL</th><th style="width:28%">Result</th></tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(function(){
  // --- helpers ---------------------------------------------------------------
  const $ = sel => document.querySelector(sel);
  const logEl = $('#log');
  const resultsBody = $('#resultsBody');
  const rowCountEl = $('#rowCount'), okCountEl = $('#okCount'), failCountEl = $('#failCount');
  const storageKey = 'ingest_token_v1';

  // restore persisted token
  const saved = localStorage.getItem(storageKey);
  if (saved) $('#token').value = saved;
  $('#token').addEventListener('input', e => localStorage.setItem(storageKey, e.target.value.trim()));

  function log(msg){
    logEl.textContent += (typeof msg === 'string' ? msg : JSON.stringify(msg)) + '\n';
    logEl.scrollTop = logEl.scrollHeight;
  }

  function isHttpUrl(u){
    try {
      const url = new URL(u.trim());
      return url.protocol === 'http:' || url.protocol === 'https:';
    } catch { return false; }
  }

  function dedupe(arr){ return Array.from(new Set(arr)); }

  function updateCounts(total, ok, fail){
    rowCountEl.textContent = `Loaded ${total} rows.`;
    okCountEl.textContent   = `Success: ${ok}`;
    failCountEl.textContent = `Failed: ${fail}`;
  }

  function addRow(i, url, status, detail){
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent = String(i+1);
    const td2 = document.createElement('td'); td2.className = 'url-cell'; td2.textContent = url;
    const td3 = document.createElement('td');
    td3.innerHTML = status === 'OK'
      ? `<span class="status-ok">OK</span>`
      : `<span class="status-fail">FAILED</span> — <span class="muted">${detail || ''}</span>`;
    tr.append(td1,td2,td3);
    resultsBody.appendChild(tr);
  }

  // --- CSV parsing (PapaParse) + pasted URLs ---------------------------------
  async function getUrlsFromInputs(){
    const pasted = $('#paste').value.trim();
    const file = $('#csv').files[0];
    let urls = [];

    if (file){
      log(`Parsing CSV file: ${file.name}`);
      urls = await new Promise((resolve) => {
        Papa.parse(file, {
          header: true,
          skipEmptyLines: 'greedy',
          transformHeader: h => (h || '').trim().toLowerCase(),
          complete: (res) => {
            if (res.errors?.length){
              log(`PapaParse errors: ${res.errors.map(e=>e.message).join(' | ')}`);
            }
            // accept 'url' column OR treat first column as url
            const rows = res.data || [];
            const out = [];
            for (const r of rows){
              const keys = Object.keys(r);
              let u = (r.url ?? r['Url'] ?? r['URL']);
              if (!u && keys.length) u = r[keys[0]];
              if (u && isHttpUrl(u)) out.push(u.trim());
            }
            resolve(out);
          }
        });
      });
    }

    if (pasted){
      const lines = pasted.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      const good = lines.filter(isHttpUrl);
      if (good.length !== lines.length){
        log(`Some pasted lines were not valid URLs and were skipped.`);
      }
      urls = urls.concat(good);
    }

    urls = dedupe(urls);
    return urls;
  }

  // --- ingestion queue -------------------------------------------------------
  let stopFlag = false;

  async function postIngest(url, token){
    const res = await fetch('/api/ingest-embed-replace', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ url })
    });
    const text = await res.text();
    let json = {};
    try { json = JSON.parse(text); } catch { /* text fallback */ }

    if (!res.ok){
      const detail = json?.detail || text || `HTTP ${res.status}`;
      throw new Error(detail);
    }
    return json;
  }

  async function runIngest(urls, token, concurrency, delayMs){
    stopFlag = false;
    resultsBody.innerHTML = '';
    let ok=0, fail=0;

    updateCounts(urls.length, ok, fail);
    log(`Starting ingest: rows=${urls.length}, concurrency=${concurrency}, delay=${delayMs}ms`);

    let index = 0;
    const workers = Array.from({length: concurrency}, async (_,workerId) => {
      while (!stopFlag){
        const i = index++;
        if (i >= urls.length) break;
        const url = urls[i];

        try{
          const result = await postIngest(url, token);
          ok++; addRow(i,url,'OK'); updateCounts(urls.length, ok, fail);
          log(`✔️ [${i+1}/${urls.length}] OK ${url}`);
        }catch(err){
          fail++; addRow(i,url,'FAIL', String(err && err.message || err)); updateCounts(urls.length, ok, fail);
          log(`❌ [${i+1}/${urls.length}] ${url} — ${String(err && err.message || err)}`);
        }

        if (delayMs > 0) await new Promise(r=>setTimeout(r, delayMs));
      }
    });

    await Promise.all(workers);
    log(`Ingest complete. ✅ ${ok} ok, ❌ ${fail} failed.`);
  }

  // --- UI events -------------------------------------------------------------
  $('#btnStart').addEventListener('click', async () => {
    const token = $('#token').value.trim();
    if (!token){ alert('Please paste your ingest token'); return; }

    const urls = await getUrlsFromInputs();
    if (!urls.length){
      alert('No rows found (need at least one valid URL).\n\nTip: Choose a CSV that has a "url" header OR paste URLs (one per line).');
      return;
    }

    const conc = Math.max(1, Number($('#concurrency').value || 3));
    const delay = Math.max(0, Number($('#delay').value || 0));

    logEl.textContent = '';
    updateCounts(0,0,0);
    await runIngest(urls, token, conc, delay);
  });

  $('#btnStop').addEventListener('click', () => {
    stopFlag = true;
    log('⏹️ Stop requested. Current requests will finish, then the queue stops.');
  });
})();
</script>
</body>
</html>
