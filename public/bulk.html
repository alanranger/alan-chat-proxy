<!-- === AI Bot (RAG) === -->
<div class="card">
  <div class="row" style="align-items:center; gap:12px; margin-bottom:10px;">
    <div class="w-3">
      <div><small>Ask a question</small></div>
      <input id="chat_q" placeholder="Ask about workshops, tips, gear, tuition..." />
    </div>
    <div class="w-1">
      <div><small>topK (context docs)</small></div>
      <input id="chat_topk" value="8" />
    </div>
    <div>
      <button id="chat_ask">Ask</button>
    </div>
  </div>

  <div id="chat_answer" class="mono" style="white-space:pre-wrap;"></div>

  <div id="chat_citations" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px;"></div>

  <div id="chat_followups" style="margin-top:12px; display:flex; flex-wrap:wrap; gap:8px;"></div>

  <small style="display:block; margin-top:8px; opacity:.8;">Answers cite sources; only your indexed pages are used.</small>
</div>

<script>
// --- minimal markdown-ish renderer (bold, italics, bullets, inline code)
function renderMarkdown(md) {
  if (!md || typeof md !== 'string') return '';
  let s = md;
  s = s
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); // basic escape
  // bold **text**
  s = s.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  // italic *text*
  s = s.replace(/\*(.*?)\*/g, '<em>$1</em>');
  // inline code `x`
  s = s.replace(/`([^`]+?)`/g, '<code>$1</code>');
  // bullets: "- item"
  s = s.replace(/(^|\n)-\s+(.*)/g, '$1• $2');
  // numbered "1. item" keep as-is
  return s;
}

function chip(url) {
  const a = document.createElement('a');
  a.href = url; a.target = '_blank'; a.rel = 'noopener';
  a.textContent = url.replace(/^https?:\/\//,'').slice(0, 120);
  a.className = 'pill';
  return a;
}

function followBtn(label) {
  const b = document.createElement('button');
  b.textContent = label;
  b.onclick = () => {
    document.getElementById('chat_q').value = label;
    askChat();
  };
  return b;
}

async function askChat() {
  const q = document.getElementById('chat_q').value.trim();
  const topk = Math.max(1, Math.min(16, parseInt(document.getElementById('chat_topk').value || '8', 10)));
  const ansEl = document.getElementById('chat_answer');
  const citEl = document.getElementById('chat_citations');
  const fuEl = document.getElementById('chat_followups');

  if (!q) return;

  ansEl.innerHTML = '…';
  citEl.innerHTML = '';
  fuEl.innerHTML = '';

  try {
    const r = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ query: q, topK: topk })
    });
    const j = await r.json();
    if (!r.ok || !j?.ok) {
      ansEl.textContent = `Error: ${j?.detail || j?.error || 'unknown'}`;
      return;
    }

    ansEl.innerHTML = renderMarkdown(j.answer || '');

    // citations
    (j.citations || []).forEach(u => citEl.appendChild(chip(u)));

    // follow-ups
    (j.followUps || []).forEach(f => fuEl.appendChild(followBtn(f)));

  } catch (e) {
    ansEl.textContent = `Error: ${e.message || e}`;
  }
}

document.getElementById('chat_ask').onclick = askChat;
</script>
