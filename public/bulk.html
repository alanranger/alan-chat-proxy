<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Upload URL List to Train AI Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220;
      --panel:#121a2b;
      --muted:#a8b3cf;
      --text:#e6ecff;
      --ok:#29cc7a;
      --warn:#ffcc66;
      --fail:#ff6b6b;
      --brand:#4b8cff;
      --brand-2:#7aa2ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:24px;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:linear-gradient(160deg,#0a1135 0%,#0b0f1e 60%);
      color:var(--text);
    }
    h1{margin:0 0 18px; font-size:26px}
    .wrap{display:grid; gap:14px}
    .row{display:flex; gap:14px; flex-wrap:wrap}
    .card{
      background:var(--panel);
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px;
      padding:14px;
      box-shadow:0 1px 0 rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.02);
    }
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input[type="text"],input[type="number"],input[type="file"]{
      width:320px; padding:9px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
      background:#0e1626; color:var(--text); outline:none;
    }
    input[type="text"]:focus,input[type="number"]:focus{border-color:var(--brand)}
    .btn{
      appearance:none; border:none; padding:9px 14px; border-radius:10px; cursor:pointer;
      font-weight:600; letter-spacing:.2px; color:#fff;
      background:linear-gradient(180deg,var(--brand),var(--brand-2));
      box-shadow:0 6px 16px rgba(75,140,255,.35), inset 0 1px 0 rgba(255,255,255,.15);
    }
    .btn:hover{filter:brightness(1.08)}
    .btn-secondary{
      background:linear-gradient(180deg,#39445f,#232c44);
      box-shadow:0 6px 16px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.08);
      color:#dbe4ff;
    }
    .muted{color:var(--muted); font-size:12px}
    details{margin-top:6px}
    summary{cursor:pointer}
    table{width:100%; border-collapse:collapse; margin-top:14px}
    th,td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.06); font-size:13px}
    a{color:#94b8ff; text-decoration:none}
    a:hover{text-decoration:underline}
    .ok{color:var(--ok); font-weight:600}
    .fail{color:var(--fail); font-weight:600}
    .stat{margin:6px 0 0; font-size:13px}
    .grid-3{display:grid; grid-template-columns: repeat(3, minmax(260px, 1fr)); gap:14px}
    @media (max-width: 980px){ .grid-3{grid-template-columns:1fr} }
    pre#log {white-space:pre-wrap; font-size:12px; color:#cde1ff; margin:0; max-height:220px; overflow:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Upload URL List to Train AI Bot</h1>

    <div class="grid-3">
      <div class="card">
        <label>Ingest Token (Bearer)</label>
        <input id="token" type="text" placeholder="paste your ingest token…" />
        <div class="muted">Saved locally (browser only). Sent as <code>Authorization: Bearer …</code>.</div>
      </div>

      <div class="card">
        <label>CSV file</label>
        <input id="file" type="file" accept=".csv" />
        <div class="muted" style="margin-top:6px">CSV must include a <code>url</code> column (optional <code>title</code>).</div>
        <div style="margin-top:10px; display:flex; gap:8px">
          <button id="start" class="btn">Crawl &amp; Ingest</button>
          <button id="stop" class="btn btn-secondary">Stop</button>
        </div>
      </div>

      <div class="card">
        <div class="row" style="gap:12px">
          <div>
            <label>Concurrency</label>
            <input id="conc" type="number" min="1" max="10" value="3" />
          </div>
          <div>
            <label>Delay between requests (ms)</label>
            <input id="delay" type="number" min="0" step="50" value="400" />
          </div>
        </div>
        <div class="muted" style="margin-top:8px">
          Each row goes to <code>/api/ingest-embed-replace</code> (server fetches, chunks, embeds, replaces existing rows).
        </div>
      </div>
    </div>

    <details class="card">
      <summary><b>CSV format</b> (click to expand)</summary>
      <pre class="muted">url,title
https://example.com/page-1,Optional page title
https://example.com/page-2,</pre>
    </details>

    <details class="card" open>
      <summary><b>Debug console</b> (what the client sees)</summary>
      <pre id="log"></pre>
    </details>

    <div id="summary" class="stat muted"></div>

    <div class="card">
      <table id="results">
        <thead><tr><th style="width:40px">#</th><th>URL</th><th>Result</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
const DEFAULT_TOKEN = "b6c3f0c9e6f44cce9e1a4f3f2d3a5c76";
const API_PATH = "/api/ingest-embed-replace";

function log(msg){
  const el = document.getElementById('log');
  el.textContent += msg + "\\n";
  el.scrollTop = el.scrollHeight;
}

// Robust CSV parsing:
// - strips BOM / normalizes newlines
// - auto-detects delimiter (",", ";", "\\t", "|")
// - handles quoted fields with commas
// - accepts url/link/href/page/address
// - if no header, assumes first column is URLs
function parseCSV(text) {
  const rows = [];
  if (!text) return rows;

  // normalize
  let txt = text.replace(/^\\uFEFF/, ''); // BOM
  txt = txt.replace(/\\r\\n/g, '\\n').replace(/\\r/g, '\\n');

  const allLines = txt.split('\\n').map(l => l.trim());
  const nonEmpty = allLines.filter(l => l.length);
  if (!nonEmpty.length) return rows;

  // detect delimiter from the first non-empty line
  const firstLine = nonEmpty[0];
  const cand = [',',';','\\t','|'];
  let delim = ',';
  let bestCount = 0;
  for (const d of cand) {
    const c = splitCSV(firstLine, d).length;
    if (c > bestCount) { bestCount = c; delim = d; }
  }
  log(`CSV: detected delimiter "${delim === '\\t' ? 'TAB' : delim}"`);

  const headerCells = splitCSV(firstLine, delim).map(s => s.trim().toLowerCase());
  const urlNames = new Set(['url','link','href','page','address']);
  let urlIdx = headerCells.findIndex(h => urlNames.has(h));
  let titleIdx = headerCells.indexOf('title');

  let startIdx = 1;
  // If header has no url-like name but only one column, assume the file has *no header* and column 0 is URLs
  if (urlIdx < 0 && splitCSV(nonEmpty[1] || '', delim).length === 1) {
    log('CSV: no recognizable URL header; assuming first column is URL and no header row.');
    urlIdx = 0; titleIdx = -1; startIdx = 0;
  } else {
    log('CSV header: ' + JSON.stringify(headerCells));
  }

  for (let i = startIdx; i < nonEmpty.length; i++) {
    const cells = splitCSV(nonEmpty[i], delim).map(s => s.trim());
    const url = cells[urlIdx] || '';
    if (!url) continue;
    const title = titleIdx >= 0 ? (cells[titleIdx] || '') : '';
    rows.push({ url, title });
  }
  return rows;
}

// CSV line splitter with quotes handling
function splitCSV(line, delim) {
  const out = [];
  let cur = '';
  let inQuotes = false;
  for (let i=0; i<line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      // handle escaped quotes ""
      if (inQuotes && line[i+1] === '"') { cur += '"'; i++; continue; }
      inQuotes = !inQuotes;
    } else if (ch === delim && !inQuotes) {
      out.push(cur); cur = '';
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}

const els = {
  token:  document.getElementById('token'),
  file:   document.getElementById('file'),
  start:  document.getElementById('start'),
  stop:   document.getElementById('stop'),
  conc:   document.getElementById('conc'),
  delay:  document.getElementById('delay'),
  table:  document.querySelector('#results tbody'),
  summary:document.getElementById('summary'),
};

els.token.value = localStorage.getItem('ingest_token') || DEFAULT_TOKEN;

let stopFlag = false;
els.stop.onclick = () => { stopFlag = true; log('Stop requested by user.'); };

els.start.onclick = async () => {
  stopFlag = false;
  const token = els.token.value.trim();
  if (!token) { alert('Missing token'); return; }
  localStorage.setItem('ingest_token', token);

  const file = els.file.files?.[0];
  if (!file) { alert('Choose a CSV first'); return; }

  const conc = Math.max(1, Math.min(10, Number(els.conc.value || 3)));
  const delay = Math.max(0, Number(els.delay.value || 400));

  const text = await file.text();
  const rows = parseCSV(text);

  if (!rows.length) { alert('No rows found (need url column)'); return; }

  els.table.innerHTML = '';
  let ok = 0, fail = 0;

  const addRow = (i, url, html) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="muted">${i+1}</td><td><a href="${url}" target="_blank">${url}</a></td><td>${html}</td>`;
    els.table.appendChild(tr);
  };

  log(`Starting ingest: rows=${rows.length}, concurrency=${conc}, delay=${delay}ms`);
  els.summary.textContent = `Loaded ${rows.length} rows. Starting…`;

  let idx = 0;
  const workers = new Array(conc).fill(0).map(async (w) => {
    while (!stopFlag) {
      const my = idx++;
      if (my >= rows.length) break;
      const r = rows[my];

      let statusHtml = '';
      try {
        log(`[${my+1}] POST ${API_PATH} ${r.url}`);
        const resp = await fetch(API_PATH, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ url: r.url, title: r.title || '' })
        });

        const txt = await resp.text();
        log(`[${my+1}] status=${resp.status} body=${txt.slice(0,180).replace(/\\n/g,' ')}`);

        let data;
        try { data = JSON.parse(txt); } catch { data = { error:'non_json', preview: txt.slice(0,180) }; }

        if (resp.ok && data?.ok) {
          ok++;
          statusHtml = `<span class="ok">OK</span> — replaced & inserted ${data?.inserted ?? ''} (chunks: ${data?.info?.chunks ?? '?'})`;
        } else {
          fail++;
          statusHtml = `<span class="fail">FAILED ${resp.status}</span> — ${JSON.stringify(data).replaceAll('"','&quot;')}`;
        }
      } catch (e) {
        fail++;
        log(`[${my+1}] fetch error: ${String(e)}`);
        statusHtml = `<span class="fail">ERROR</span> — ${String(e).replaceAll('"','&quot;')}`;
      }

      addRow(my, r.url, statusHtml);
      els.summary.innerHTML = `Loaded ${rows.length} rows. <span class="ok">Success: ${ok}</span>. <span class="fail">Failed: ${fail}</span>.`;

      if (delay) await new Promise(r => setTimeout(r, delay));
    }
  });

  await Promise.all(workers);
  if (stopFlag) els.summary.innerHTML += ' (stopped)';
  log('Ingest complete.');
};
</script>
</body>
</html>
