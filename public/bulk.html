<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Upload URL List to Train AI Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:20px;color:#111}
    h1{font-size:28px;margin:0 0 16px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .box{padding:10px;border:1px solid #ddd;border-radius:8px}
    input[type="text"],input[type="number"]{padding:8px;border:1px solid #ccc;border-radius:6px;width:320px}
    input[type="file"]{padding:6px}
    button{padding:8px 12px;border:1px solid #999;border-radius:6px;background:#f6f6f6;cursor:pointer}
    button:hover{background:#eee}
    .small{color:#555;font-size:12px}
    .ok{color:#0a7f1a}
    .fail{color:#b00020}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;font-size:13px;vertical-align:top}
    details{margin-top:14px}
    .muted{color:#666}
    a{color:#0a5; text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <h1>Upload URL List to Train AI Bot</h1>

  <div class="row">
    <div class="box">
      <div><b>Ingest Token (Bearer)</b></div>
      <input id="token" type="text" placeholder="paste your ingest token here..." />
      <div class="small">Saved locally in your browser only. Sent as <code>Authorization: Bearer …</code> header.</div>
    </div>

    <div class="box">
      <div><b>CSV file</b></div>
      <input id="file" type="file" accept=".csv" />
      <div class="small">CSV must include a <code>url</code> column (optional <code>title</code>).</div>
      <div style="margin-top:8px;">
        <button id="start">Start Ingest</button>
        <button id="stop">Stop</button>
      </div>
    </div>

    <div class="box">
      <div><b>Concurrency</b></div>
      <input id="conc" type="number" min="1" max="10" value="3" />
      <div><b>Delay between requests (ms)</b></div>
      <input id="delay" type="number" min="0" step="50" value="400" />
      <div class="small muted" style="margin-top:6px;">
        Each row will be sent to <code>/api/ingest-embed-replace</code> (server fetches, chunks, replaces existing rows).
      </div>
    </div>
  </div>

  <details style="margin-top:12px;">
    <summary><b>CSV format</b> (click to expand)</summary>
    <pre>
url,title
https://example.com/page-1,Optional human title
https://example.com/page-2,
    </pre>
  </details>

  <div class="small muted" id="summary" style="margin-top:8px;"></div>

  <table id="results">
    <thead><tr><th>#</th><th>URL</th><th>Result</th></tr></thead>
    <tbody></tbody>
  </table>

<script>
/** ====== configurable defaults ====== **/
const DEFAULT_TOKEN = "b6c3f0c9e6f44cce9e1a4f3f2d3a5c76"; // prefill as requested
const API_PATH = "/api/ingest-embed-replace";

/** ====== tiny csv parser (url,title) ====== **/
function parseCSV(text) {
  const rows = [];
  const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  if (!lines.length) return rows;

  const header = lines[0].split(',').map(s => s.trim());
  const urlIdx   = header.findIndex(h => h.toLowerCase() === 'url');
  const titleIdx = header.findIndex(h => h.toLowerCase() === 'title');

  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(',').map(s => s.trim());
    const url = cols[urlIdx];
    if (!url) continue;
    const title = titleIdx >= 0 ? cols[titleIdx] : '';
    rows.push({ url, title });
  }
  return rows;
}

/** ====== UI wiring ====== **/
const els = {
  token:  document.getElementById('token'),
  file:   document.getElementById('file'),
  start:  document.getElementById('start'),
  stop:   document.getElementById('stop'),
  conc:   document.getElementById('conc'),
  delay:  document.getElementById('delay'),
  table:  document.getElementById('results').querySelector('tbody'),
  summary:document.getElementById('summary'),
};

const saved = localStorage.getItem('ingest_token');
els.token.value = saved || DEFAULT_TOKEN;

let stopFlag = false;
els.stop.onclick = () => { stopFlag = true; };

els.start.onclick = async () => {
  stopFlag = false;
  const token = (els.token.value || '').trim();
  if (!token) { alert('Missing token'); return; }
  localStorage.setItem('ingest_token', token);

  const file = els.file.files?.[0];
  if (!file) { alert('Choose a CSV first'); return; }

  const conc = Math.max(1, Math.min(10, Number(els.conc.value || 3)));
  const delay = Math.max(0, Number(els.delay.value || 400));

  const text = await file.text();
  const rows = parseCSV(text);
  if (!rows.length) { alert('No rows found (need url column)'); return; }

  els.table.innerHTML = '';
  let ok = 0, fail = 0;

  const addRow = (i, url, html) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="muted">${i+1}</td><td><a href="${url}" target="_blank">${url}</a></td><td>${html}</td>`;
    els.table.appendChild(tr);
  };

  els.summary.textContent = `Loaded ${rows.length} rows. Starting…`;

  let idx = 0;
  const workers = new Array(conc).fill(0).map(async () => {
    while (!stopFlag) {
      const my = idx++;
      if (my >= rows.length) break;
      const r = rows[my];

      // POST only { url, title } — server fetches & chunks & replaces
      let status = '';
      try {
        const resp = await fetch(API_PATH, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ url: r.url, title: r.title || '' })
        });

        const bodyText = await resp.text();
        let data;
        try { data = JSON.parse(bodyText); } catch {
          data = { error: 'non_json', preview: bodyText.slice(0, 180) };
        }

        if (resp.ok && data?.ok) {
          ok++;
          status = `<span class="ok">OK</span> — replaced & inserted`;
        } else {
          fail++;
          status = `<span class="fail">FAILED ${resp.status}</span> — ${JSON.stringify(data).replaceAll('"','&quot;')}`;
        }
      } catch (e) {
        fail++;
        status = `<span class="fail">ERROR</span> — ${String(e).replaceAll('"','&quot;')}`;
      }

      addRow(my, r.url, status);
      els.summary.innerHTML = `Loaded ${rows.length} rows. <span class="ok">Success: ${ok}</span>. <span class="fail">Failed: ${fail}</span>.`;

      if (delay) await new Promise(r => setTimeout(r, delay));
    }
  });

  await Promise.all(workers);
  if (stopFlag) els.summary.innerHTML += ' (stopped)';
};
</script>
</body>
</html>
