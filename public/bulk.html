<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Upload URL List to Train AI Bot</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#0f1623;--card:#131c2b;--muted:#96a0b5;--ok:#1db954;--err:#ff6b6b;--ink:#e8eefc}
  *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif}
  .wrap{max-width:1060px;margin:42px auto;padding:0 20px}
  h1{font-size:22px;margin:0 0 18px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .card{background:var(--card);border-radius:10px;padding:18px}
  .label{color:var(--muted);font-size:12px;margin-bottom:6px}
  input[type=text],input[type=number],textarea,select{width:100%;border:1px solid #22314c;background:#0b1320;color:var(--ink);border-radius:8px;padding:10px 12px}
  textarea{min-height:120px;resize:vertical}
  button{border:0;background:#2764ff;color:white;border-radius:8px;padding:10px 14px;cursor:pointer}
  button.secondary{background:#37455f}
  .grid{display:grid;grid-template-columns:60px 1fr 220px;gap:10px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;vertical-align:middle}
  .ok{background:#153a26;color:#7df2a0}.err{background:#3a1b1b;color:#ffb3b3}
  pre.log{white-space:pre-wrap;background:#0b1320;border:1px solid #1f2a42;border-radius:8px;padding:12px;max-height:240px;overflow:auto}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #1f2a42;padding:10px 8px;text-align:left}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Upload URL List to Train AI Bot</h1>

  <div class="row">
    <!-- Left column -->
    <div class="card">
      <div class="label">INGEST TOKEN (BEARER)</div>
      <input id="token" type="text" placeholder="Bearer token" value="">
      <div class="muted" style="margin-top:6px">Saved only in your browser. Sent as <code>Authorization: Bearer …</code></div>

      <div style="height:14px"></div>

      <div class="label">TEST A SINGLE URL</div>
      <div class="grid">
        <div></div>
        <input id="singleUrl" type="text" placeholder="https://example.com/page" />
        <div style="display:flex;gap:8px">
          <button id="btnTest">Test Single URL</button>
        </div>
      </div>

      <div style="height:14px"></div>

      <details>
        <summary class="label">CSV format</summary>
        <div class="muted" style="margin-top:8px">
          CSV must include a column named <code>url</code>. Optional column <code>title</code> will be ignored by the API.
        </div>
      </details>

      <div style="height:14px"></div>

      <div class="label">Debug console <span class="muted">(what the client sees)</span></div>
      <pre id="log" class="log"></pre>
    </div>

    <!-- Right column -->
    <div class="card">
      <div class="label">CSV file</div>
      <input id="csv" type="file" accept=".csv" />

      <div style="height:14px"></div>

      <div class="label">PASTE URLS (ONE PER LINE) — OPTIONAL</div>
      <textarea id="paste" placeholder="https://example.com/page-1&#10;https://example.com/page-2"></textarea>

      <div style="height:14px"></div>

      <div class="row" style="grid-template-columns:1fr 1fr">
        <div>
          <div class="label">CONCURRENCY</div>
          <input id="concurrency" type="number" min="1" max="10" value="3" />
        </div>
        <div>
          <div class="label">DELAY BETWEEN REQUESTS (MS)</div>
          <input id="delay" type="number" min="0" step="50" value="400" />
        </div>
      </div>

      <div style="height:14px"></div>

      <div style="display:flex;gap:10px">
        <button id="btnRun">Crawl &amp; Ingest</button>
        <button id="btnStop" class="secondary">Stop</button>
      </div>
    </div>
  </div>

  <div style="height:16px"></div>

  <div class="card">
    <div class="label">Results</div>
    <table id="table">
      <thead>
        <tr><th>#</th><th>URL</th><th>Result</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
(function() {
  const $ = (id) => document.getElementById(id);
  const log = (msg) => { const el = $("log"); el.textContent += msg + "\\n"; el.scrollTop = el.scrollHeight; };

  // Persist token locally
  (function restoreToken() {
    const v = localStorage.getItem("INGEST_TOKEN") || "";
    $("token").value = v;
  })();
  $("token").addEventListener("input", (e) => {
    localStorage.setItem("INGEST_TOKEN", e.target.value.trim());
  });

  function toLines(text) {
    return text.split(/\\r?\\n/).map(s => s.trim()).filter(Boolean);
  }

  async function callIngest(url, token) {
    const endpoint = "/api/ingest-embed-replace";
    const headers = {
      "content-type": "application/json",
      "authorization": "Bearer " + token
    };

    // We capture text always, then JSON.parse fallback.
    const res = await fetch(endpoint, {
      method: "POST",
      headers,
      body: JSON.stringify({ url })
    });

    const raw = await res.text();
    let data;
    try { data = JSON.parse(raw); } catch { data = { raw }; }

    if (!res.ok || data.error) {
      const status = res.status;
      const err = data.error || "server_error";
      const detail = data.detail || data.raw || "";
      throw { status, error: err, detail };
    }
    return data; // { ok:true, url, chunks, ...}
  }

  function addRow(i, url, html) {
    const tr = document.createElement("tr");
    tr.innerHTML = \`<td class="muted">\${i}</td><td>\${url}</td><td>\${html}</td>\`;
    $("table").querySelector("tbody").appendChild(tr);
  }

  async function testSingle() {
    const token = $("token").value.trim();
    const url = $("singleUrl").value.trim();
    $("table").querySelector("tbody").innerHTML = "";
    if (!token) { log("✗ Please enter an ingest token."); return; }
    if (!url) { log("✗ Please enter a URL."); return; }

    log(\`Single test → \${url}\`);
    try {
      const out = await callIngest(url, token);
      log("✓ " + url + " → ok: chunks=" + out.chunks);
      addRow(1, url, \`<span class="badge ok">OK</span> chunks: \${out.chunks}\`);
    } catch (e) {
      const pretty = JSON.stringify(e, null, 2);
      log("✗ " + url + " → " + pretty);
      addRow(1, url, \`<span class="badge err">FAILED</span> \${e.error || ""}: \${(e.detail || "").toString().slice(0,200)}\`);
    }
  }

  async function runBatch() {
    const token = $("token").value.trim();
    const conc = Math.max(1, Number($("concurrency").value || 3));
    const delay = Math.max(0, Number($("delay").value || 400));

    const urls = new Set();
    // add pasted list
    toLines($("paste").value).forEach(u => urls.add(u));

    // add from CSV (optional)
    const file = $("csv").files[0];
    if (file) {
      const text = await file.text();
      // very forgiving CSV: look for a column named url
      const lines = toLines(text);
      const header = lines.shift();
      const cols = header.split(",").map(s => s.trim().toLowerCase());
      const idx = cols.indexOf("url");
      if (idx >= 0) {
        for (const line of lines) {
          const parts = line.split(",");
          if (parts[idx]) urls.add(parts[idx].trim());
        }
      }
    }

    const list = [...urls];
    $("table").querySelector("tbody").innerHTML = "";
    if (!token) { log("✗ Please enter an ingest token."); return; }
    if (list.length === 0) { log("✗ No URLs provided."); return; }

    let i = 0;
    log(\`Starting ingest: rows=\${list.length}, concurrency=\${conc}, delay=\${delay}ms\`);
    async function worker(id) {
      while (i < list.length) {
        const j = i++;
        const url = list[j];
        try {
          const out = await callIngest(url, token);
          log("✓ " + url + " → chunks=" + out.chunks);
          addRow(j+1, url, \`<span class="badge ok">OK</span> chunks: \${out.chunks}\`);
        } catch (e) {
          const pretty = JSON.stringify(e, null, 2);
          log("✗ " + url + " → " + pretty);
          addRow(j+1, url, \`<span class="badge err">FAILED</span> \${e.error || ""}: \${(e.detail || "").toString().slice(0,200)}\`);
        }
        if (delay) await new Promise(r => setTimeout(r, delay));
      }
    }
    await Promise.all([...Array(conc)].map((_,k) => worker(k)));
    log("Ingest complete.");
  }

  $("btnTest").addEventListener("click", testSingle);
  $("btnRun").addEventListener("click", runBatch);
  $("btnStop").addEventListener("click", () => { log("Stop requested (not implemented)."); });
})();
</script>
</body>
</html>
