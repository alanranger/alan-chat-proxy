<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upload URL List to Train AI Bot</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      margin: 20px;
    }
    h1 { color: #38bdf8; }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #1e293b;
      border-radius: 8px;
    }
    label { display: block; margin-top: 10px; }
    input, textarea, button, select {
      margin-top: 5px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #334155;
      background: #0f172a;
      color: #e2e8f0;
      width: 100%;
    }
    button {
      cursor: pointer;
      background: #2563eb;
      color: white;
      font-weight: bold;
    }
    button:hover { background: #1d4ed8; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #334155;
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }
    th { background: #334155; }
    .ok { color: #22c55e; font-weight: bold; }
    .fail { color: #ef4444; font-weight: bold; }
    .console {
      background: #0f172a;
      color: #e2e8f0;
      font-family: monospace;
      padding: 10px;
      height: 200px;
      overflow-y: scroll;
      border: 1px solid #334155;
      margin-top: 10px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>Upload URL List to Train AI Bot</h1>

  <div class="section">
    <label>Ingest Token (Bearer)
      <input id="ingestToken" type="text" placeholder="Enter ingest token"/>
    </label>
    <label>CSV File
      <input id="csvFile" type="file" />
    </label>
    <label>Concurrency
      <input id="concurrency" type="number" value="3"/>
    </label>
    <label>Delay Between Requests (ms)
      <input id="delay" type="number" value="400"/>
    </label>
  </div>

  <div class="section">
    <label>Test a Single URL
      <input id="singleUrl" type="text" placeholder="https://example.com/page-1"/>
      <button onclick="testSingle()">Test Single URL</button>
    </label>
  </div>

  <div class="section">
    <label>Paste URLs (one per line) â€” OPTIONAL
      <textarea id="urlList" rows="4" placeholder="https://example.com/page-1&#10;https://example.com/page-2"></textarea>
    </label>
    <button onclick="startCrawl()">Crawl & Ingest</button>
    <button onclick="stopCrawl()">Stop</button>
    <div>
      Loaded <span id="loaded">0</span> rows | 
      Success: <span id="success">0</span> | 
      Failed: <span id="failed">0</span> | 
      Stopped: <span id="stopped">0</span>
    </div>
    <table id="resultsTable">
      <thead>
        <tr>
          <th>#</th><th>URL</th><th>Result (includes DB verify)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Debug Console (What the Client Sees)</h2>
    <div id="console" class="console"></div>
  </div>

  <div class="section">
    <h2>AI Search Tester</h2>
    <label>Query
      <input id="searchQuery" type="text" placeholder="Search query"/>
    </label>
    <label>topK
      <input id="searchTopK" type="number" value="8"/>
    </label>
    <button onclick="runSearch()">Run Search</button>
    <table id="searchResults">
      <thead>
        <tr><th>Score</th><th>URL</th><th>Snippet</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <h3>Search Raw Response</h3>
    <pre id="searchRaw" class="console"></pre>
  </div>

<script>
let stopFlag = false;

function log(msg) {
  const c = document.getElementById("console");
  c.textContent += msg + "\\n";
  c.scrollTop = c.scrollHeight;
}

// Cleaner snippet function
function cleanSnippet(s) {
  if (!s) return '';
  // Remove markdown-style links and image tags
  s = s.replace(/!\\[[^\\]]*\\]\\([^)]*\\)/g, ''); 
  s = s.replace(/\\[[^\\]]*\\]\\([^)]*\\)/g, ''); 
  // Strip out long URLs
  s = s.replace(/https?:\\/\\/\\S+/g, (m)=> m.length > 40 ? '' : m);
  // Collapse whitespace
  s = s.replace(/\\s+/g, ' ').trim();
  // Prefer ending at a sentence boundary
  const match = s.match(/^(.*?[\\.\\!\\?])\\s/);
  return match ? match[1] : s;
}

async function testSingle() {
  const url = document.getElementById("singleUrl").value;
  const token = document.getElementById("ingestToken").value;
  log("[Single test] " + url);

  const res = await fetch("/api/ingest-embed-replace", {
    method: "POST",
    headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
    body: JSON.stringify({ url })
  });
  const data = await res.json();
  log(JSON.stringify(data, null, 2));
}

async function runSearch() {
  const q = document.getElementById("searchQuery").value;
  const k = parseInt(document.getElementById("searchTopK").value, 10);
  const token = document.getElementById("ingestToken").value;

  const res = await fetch("/api/search", {
    method: "POST",
    headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
    body: JSON.stringify({ query: q, topK: k })
  });
  const data = await res.json();

  const tbody = document.getElementById("searchResults").querySelector("tbody");
  tbody.innerHTML = "";
  (data.matches || []).forEach(m => {
    const row = document.createElement("tr");
    row.innerHTML = \`
      <td>\${m.score.toFixed(3)}</td>
      <td><a href="\${m.url}" target="_blank" style="color:#fff">\${m.url}</a></td>
      <td>\${cleanSnippet(m.content)}</td>
    \`;
    tbody.appendChild(row);
  });
  document.getElementById("searchRaw").textContent = JSON.stringify(data, null, 2);
}
</script>
</body>
</html>
