<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Upload URL List to Train AI Bot</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root {
      --bg: #0f172a;       /* slate-900 */
      --panel: #111827;    /* gray-900 */
      --text: #e5e7eb;     /* gray-200 */
      --muted: #9ca3af;    /* gray-400 */
      --accent: #3b82f6;   /* blue-500 */
      --ok: #22c55e;       /* green-500 */
      --bad: #ef4444;      /* red-500 */
      --chip: #1f2937;     /* gray-800 */
      --chipText: #93c5fd; /* blue-300 */
    }
    html, body { background: var(--bg); color: var(--text); margin: 0; font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .wrap { max-width: 1300px; margin: 28px auto; padding: 0 16px; }
    h1 { margin: 0 0 18px; font-weight: 650; }
    .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    .card { background: var(--panel); border-radius: 8px; padding: 14px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .label { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input[type=text], input[type=number], textarea, .file {
      width: 100%; box-sizing: border-box; padding: 10px 12px; background: #0b1220; color: var(--text);
      border: 1px solid #1f2937; border-radius: 8px; outline: none;
    }
    textarea { height: 140px; resize: vertical; }
    .btn {
      background: var(--accent); color: white; border: 0; border-radius: 8px; padding: 10px 14px; cursor: pointer;
    }
    .btn:disabled { opacity: .6; cursor: default; }
    .btn.gray { background: #374151; }
    .chips { display: inline-flex; gap: 8px; align-items: center; }
    .chip { background: var(--chip); color: var(--chipText); border-radius: 999px; padding: 4px 10px; font-size: 12px; }
    .debug { white-space: pre-wrap; background: #0b1220; border: 1px solid #1f2937; padding: 12px; border-radius: 8px; min-height: 110px; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 10px 12px; border-bottom: 1px solid #1f2937; }
    .muted { color: var(--muted); }
    .ok { color: var(--ok); font-weight: 600; }
    .bad { color: var(--bad); font-weight: 600; }
    .small { font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Upload URL List to Train AI Bot</h1>

    <div class="grid">
      <!-- Ingest token -->
      <div class="card">
        <div class="label">Ingest Token (Bearer)</div>
        <input id="token" type="text" placeholder="b6c3f0c9e6f44cce9e1a4f3f2d3a5c76"/>
        <div class="small muted" style="margin-top:6px">Saved locally (browser only). Sent as <code>Authorization: Bearer …</code></div>
      </div>

      <!-- CSV file -->
      <div class="card">
        <div class="label">CSV file</div>
        <input id="csvFile" class="file" type="file" accept=".csv"/>
        <div class="small muted" style="margin-top:6px">CSV must include a <code>url</code> column (optional <code>title</code>).</div>
      </div>

      <!-- Settings -->
      <div class="card">
        <div class="row">
          <div>
            <div class="label">Concurrency</div>
            <input id="concurrency" type="number" min="1" value="3"/>
          </div>
          <div>
            <div class="label">Delay between requests (ms)</div>
            <input id="delay" type="number" min="0" value="400"/>
          </div>
        </div>
        <div class="small muted" style="margin-top:6px">
          Each request goes to <code>/api/ingest-embed-replace</code> (fetches, chunks, embeds, replaces existing rows).
        </div>
      </div>
    </div>

    <!-- Single URL tester -->
    <div class="card" style="margin-top:16px">
      <div class="row">
        <div>
          <div class="label">Test a Single URL</div>
          <input id="singleUrl" type="text" placeholder="https://example.com/page"/>
        </div>
        <div style="display:flex; align-items:end;">
          <button id="btnTest" class="btn" style="width:180px">Test Single URL</button>
        </div>
      </div>
      <div class="debug" id="debugSingle" style="margin-top:10px"></div>
    </div>

    <!-- Paste URLs + controls -->
    <div class="card" style="margin-top:16px">
      <div class="label">Paste URLs (one per line) — OPTIONAL</div>
      <textarea id="paste"></textarea>
      <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
        <button id="btnStart" class="btn">Crawl &amp; Ingest</button>
        <button id="btnStop" class="btn gray">Stop</button>
        <span class="chips">
          <span class="chip">Loaded <span id="statLoaded">0</span> rows</span>
          <span class="chip">Success: <span id="statOk">0</span></span>
          <span class="chip">Failed: <span id="statBad">0</span></span>
          <span class="chip">Stopped: <span id="statStop">0</span></span>
        </span>
      </div>
    </div>

    <!-- Debug console -->
    <div class="card" style="margin-top:16px">
      <div class="label">Debug console (what the client sees)</div>
      <div id="debug" class="debug"></div>
    </div>

    <!-- Results -->
    <div class="card" style="margin-top:16px">
      <table class="table" id="results">
        <thead>
          <tr>
            <th style="width:60px">#</th>
            <th>URL</th>
            <th style="width:360px">Result</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // --- helpers -------------------------------------------------------------
    const $ = (id) => document.getElementById(id);
    const escapeHtml = (s) => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    function logDbg(s) { const el = $("debug"); el.textContent += s + "\\n"; el.scrollTop = el.scrollHeight; }
    function logDbgSingle(s) { const el = $("debugSingle"); el.textContent += s + "\\n"; el.scrollTop = el.scrollHeight; }

    // Persist token locally
    const tokenKey = "ingest_token";
    $("token").value = localStorage.getItem(tokenKey) || "";
    $("token").addEventListener("input", () => {
      localStorage.setItem(tokenKey, $("token").value.trim());
    });

    function rowTpl(idx, url, resultHtml) {
      const tr = document.createElement("tr");
      tr.innerHTML = \`
        <td class="muted">\${idx}</td>
        <td class="small">\${escapeHtml(url)}</td>
        <td class="small">\${resultHtml}</td>\`;
      return tr;
    }
    function addRow(idx, url, html) {
      $("results").querySelector("tbody").appendChild(rowTpl(idx, url, html));
    }

    // --- API call -----------------------------------------------------------
    async function postIngest(url, token, signal) {
      const r = await fetch("/api/ingest-embed-replace", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ url }),
        signal
      });
      // Prefer JSON, but tolerate non-JSON server messages
      const ct = (r.headers.get("content-type") || "").toLowerCase();
      if (ct.includes("application/json")) {
        const j = await r.json();
        if (!r.ok) {
          throw Object.assign(new Error(j.error || "server_error"), { detail: j.detail, code: j.code, status: r.status });
        }
        return j;
      } else {
        const t = await r.text();
        throw Object.assign(new Error("non_json_response"), { detail: t.slice(0, 400), status: r.status });
      }
    }

    // --- Single test --------------------------------------------------------
    $("btnTest").addEventListener("click", async () => {
      const token = $("token").value.trim();
      const url = $("singleUrl").value.trim();
      $("debugSingle").textContent = "";

      if (!token) return logDbgSingle("✖ Provide an ingest token.");
      if (!url) return logDbgSingle("✖ Provide a URL.");

      logDbgSingle(\`Single test → \${url}\`);
      try {
        const r = await postIngest(url, token);
        logDbgSingle("✓ " + url + " → " + JSON.stringify(r, null, 2));
        // Also add to table
        addRow(1, url,
          \`<span class="ok">OK</span> id=\${escapeHtml(r.id)} len=\${escapeHtml(r.len)} chunks=\${escapeHtml(r.chunks ?? "?")}\`);
        // update stats
        $("statLoaded").textContent = "1";
        $("statOk").textContent = "1";
      } catch (err) {
        logDbgSingle("✖ " + url + " → " + (err.code || err.message) + (err.detail ? " :: " + err.detail : ""));
        addRow(1, url, \`<span class="bad">FAILED</span> \${escapeHtml(err.code || err.message)}\`);
        $("statLoaded").textContent = "1";
        $("statBad").textContent = "1";
      }
    });

    // --- CSV parsing (very simple) -----------------------------------------
    async function parseCsv(file) {
      if (!file) return [];
      const text = await file.text();
      const lines = text.split(/\\r?\\n/).filter(Boolean);
      if (!lines.length) return [];
      // detect header
      const header = lines[0].split(",").map(s => s.trim().toLowerCase());
      const hasHeader = header.includes("url");
      const rows = hasHeader ? lines.slice(1) : lines;
      return rows.map(line => {
        const cols = line.split(",").map(s => s.trim());
        return hasHeader
          ? { url: cols[header.indexOf("url")], title: header.includes("title") ? cols[header.indexOf("title")] : "" }
          : { url: cols[0], title: "" };
      }).filter(r => r.url);
    }

    // --- Crawl loop with concurrency ---------------------------------------
    let stopFlag = false;
    $("btnStop").addEventListener("click", () => { stopFlag = true; });

    $("btnStart").addEventListener("click", async () => {
      stopFlag = false;
      const token = $("token").value.trim();
      const conc = Math.max(1, parseInt($("concurrency").value || "1", 10));
      const delay = Math.max(0, parseInt($("delay").value || "0", 10));
      const listText = $("paste").value.trim();
      const file = $("csvFile").files[0];

      $("debug").textContent = "";

      if (!token) return logDbg("✖ Provide an ingest token.");

      // build URL list
      let items = [];
      const pasted = listText
        ? listText.split(/\\r?\\n/).map(s => s.trim()).filter(Boolean).map(u => ({ url: u, title: "" }))
        : [];
      const csvRows = await parseCsv(file);
      items = [...pasted, ...csvRows];

      if (!items.length) return logDbg("✖ Provide URLs in the textarea or a CSV file.");

      $("statLoaded").textContent = String(items.length);
      $("statOk").textContent = "0";
      $("statBad").textContent = "0";
      $("statStop").textContent = "0";

      let ok = 0, bad = 0, stopped = 0;
      let idx = 0;
      const tbody = $("results").querySelector("tbody");
      tbody.innerHTML = "";

      // queue
      const controller = new AbortController();
      const next = async () => {
        if (stopFlag) { stopped++; $("statStop").textContent = String(stopped); return; }
        const myIdx = ++idx;
        const item = items.shift();
        if (!item) return;

        const url = item.url;
        logDbg(\`→ \${url}\`);

        try {
          const res = await postIngest(url, token, controller.signal);
          ok++;
          $("statOk").textContent = String(ok);
          addRow(myIdx, url,
            \`<span class="ok">OK</span> id=\${escapeHtml(res.id)} len=\${escapeHtml(res.len)} chunks=\${escapeHtml(res.chunks ?? "?")}\`);
          logDbg(\`✓ \${url} → \${JSON.stringify(res)}\`);
        } catch (err) {
          bad++;
          $("statBad").textContent = String(bad);
          addRow(myIdx, url,
            \`<span class="bad">FAILED</span> \${escapeHtml(err.code || err.message)}\`);
          logDbg(\`✖ \${url} → \${(err.code || err.message)}\${err.detail ? " :: " + err.detail : ""}\`);
        }

        if (delay > 0) await new Promise(r => setTimeout(r, delay));
        return next();
      };

      // start N workers
      await Promise.all(Array.from({ length: Math.min(conc, items.length) }, () => next()));
      logDbg("Done.");
    });
  </script>
</body>
</html>
