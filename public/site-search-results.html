<!-- AR | Site Search Results | v1.1 | Uses /api/search/query (chat ranking/confidence) -->
<div id="ar-site-search">
  <div class="ar-ss-wrap">
    <div class="ar-ss-searchcard">
      <div class="ar-ss-row">
        <input id="ar-ss-q" class="ar-ss-input" type="text" inputmode="search" placeholder="Search workshops, guides, services, landing pages…" />
        <button id="ar-ss-btn" class="ar-ss-btn" type="button">Search</button>
      </div>

      <div class="ar-ss-meta">
        <div id="ar-ss-status" class="ar-ss-chip">
          <span class="ar-ss-dot"></span>
          <span id="ar-ss-status-text">Type a query and press Enter.</span>
        </div>
        <div id="ar-ss-confidence" class="ar-ss-chip ar-ss-chip-muted">Confidence: —</div>
      </div>
    </div>

    <div id="ar-ss-results" class="ar-ss-results"></div>
  </div>

  <style>
    :root{
      --ar-orange:#E57200;
      --ar-green:#10b981;
      --ar-blue:#2563eb;
      --ar-text:#0f172a;
      --ar-muted:#64748b;
      --ar-border:rgba(15,23,42,.10);
      --ar-bg:#ffffff;
      --ar-soft:#f8fafc;
      --ar-shadow:0 10px 30px rgba(2,6,23,.08);
      --ar-radius:16px;
    }

    #ar-site-search{
      color:var(--ar-text);
    }
    .ar-ss-wrap{
      max-width: 1020px;
      margin: 0 auto;
      padding: 26px 16px 50px;
    }

    .ar-ss-searchcard{
      background:var(--ar-bg);
      border:1px solid var(--ar-border);
      border-radius:var(--ar-radius);
      box-shadow:var(--ar-shadow);
      padding:18px;
      margin-bottom:18px;
    }
    .ar-ss-row{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .ar-ss-input{
      flex:1;
      min-width:0;
      padding:12px 14px;
      border:1px solid var(--ar-border);
      border-radius:12px;
      outline:none;
      font-size:15px;
      background:#fff;
    }
    .ar-ss-input:focus{
      border-color: rgba(229,114,0,.55);
      box-shadow:0 0 0 3px rgba(229,114,0,.12);
    }
    .ar-ss-btn{
      border:0;
      background:var(--ar-orange);
      color:#fff;
      padding:11px 16px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 6px 16px rgba(229,114,0,.20);
    }
    .ar-ss-btn:hover{ filter:brightness(0.98); }

    .ar-ss-meta{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .ar-ss-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--ar-border);
      background:var(--ar-soft);
      color:var(--ar-text);
      padding:7px 10px;
      border-radius:999px;
      font-size:13px;
    }
    .ar-ss-chip-muted{
      color:var(--ar-muted);
      background:#fff;
    }
    .ar-ss-dot{
      width:8px;height:8px;border-radius:999px;background:var(--ar-orange);
      display:inline-block;
    }

    .ar-ss-section{
      background:#fff;
      border:1px solid var(--ar-border);
      border-radius:var(--ar-radius);
      overflow:hidden;
      margin: 14px 0;
      box-shadow:0 10px 26px rgba(2,6,23,.06);
    }
    .ar-ss-section-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      background: #f9fafb;
      border-bottom:1px solid var(--ar-border);
    }
    .ar-ss-section-head h3{
      margin:0;
      font-size:14px;
      letter-spacing:.02em;
      text-transform:none;
    }
    .ar-ss-count{
      color:var(--ar-muted);
      font-size:12px;
      font-weight:600;
    }

    .ar-ss-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
      padding:12px;
    }
    @media (max-width: 820px){
      .ar-ss-grid{ grid-template-columns: 1fr; }
      .ar-ss-btn{ padding:11px 14px; }
    }

    .ar-card{
      display:flex;
      gap:12px;
      align-items:flex-start;
      border:1px solid var(--ar-border);
      border-radius:14px;
      background:#fff;
      padding:12px;
      min-height: 120px;
    }
    .ar-thumb{
      width:104px;
      height:104px;
      border-radius:12px;
      border:1px solid var(--ar-border);
      background:#eef2f7;
      overflow:hidden;
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#94a3b8;
      font-weight:800;
      letter-spacing:.02em;
    }
    .ar-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .ar-body{ min-width:0; flex:1; }
    .ar-title{
      margin:0;
      font-size:14px;
      line-height:1.25;
      font-weight:800;
    }
    .ar-sub{
      margin:4px 0 6px;
      color:var(--ar-muted);
      font-size:12px;
      line-height:1.35;
    }
    .ar-desc{
      margin:0 0 8px;
      color:rgba(15,23,42,.78);
      font-size:12.5px;
      line-height:1.4;
    }

    .ar-pills{
      display:flex;
      flex-wrap:wrap;
      gap:5px;
      margin: 8px 0 0;
    }
    .ar-pill{
      border:1px solid rgba(229,114,0,.35);
      background: rgba(229,114,0,.08);
      color: rgba(124,45,18,.95);
      padding:3px 7px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      white-space:nowrap;
      cursor:default;
      user-select:none;
    }
    .ar-pill.price{
      border-color: rgba(37,99,235,.35);
      background: var(--ar-blue);
      color: #fff;
      font-weight:800;
    }

    .ar-actions{
      display:flex;
      gap:8px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .ar-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      font-weight:800;
      text-decoration:none;
      border:1px solid var(--ar-border);
      background:#fff;
      color:var(--ar-text);
      cursor:pointer;
    }
    .ar-btn.more{
      background:var(--ar-orange);
      color:#fff;
      border-color:rgba(229,114,0,.35);
    }
    .ar-btn.book{
      background:var(--ar-green);
      color:#fff;
      border-color:rgba(16,185,129,.35);
    }
    .ar-btn:hover{ filter:brightness(.985); }

    .ar-empty{
      padding:12px;
      color:var(--ar-muted);
      font-size:13px;
    }
  </style>

  <script>
    (function(){
      const API_BASE = "https://alan-chat-proxy.vercel.app";
      const ENDPOINT = API_BASE + "/api/search/query";

      // Fallback images (use hosted images or logo)
      const FALLBACKS = {
        event: "https://www.alanranger.com/s/default-image.jpg", // Replace with actual fallback URL
        service: "https://www.alanranger.com/s/default-image.jpg",
        guide: "https://www.alanranger.com/s/default-image.jpg"
      };

      const $q = document.getElementById("ar-ss-q");
      const $btn = document.getElementById("ar-ss-btn");
      const $results = document.getElementById("ar-ss-results");
      const $statusText = document.getElementById("ar-ss-status-text");
      const $confidence = document.getElementById("ar-ss-confidence");

      // Debug counters (remove after verification)
      let debugStats = { noUrl: 0, broken: 0 };

      function qs(key){
        const p = new URLSearchParams(window.location.search);
        return p.get(key) || "";
      }

      function setStatus(msg){
        $statusText.textContent = msg;
      }

      function setConfidence(val){
        if (typeof val === "number" && isFinite(val)){
          const pct = Math.round(val * 100);
          $confidence.textContent = "Confidence: " + pct + "%";
        } else {
          $confidence.textContent = "Confidence: —";
        }
      }

      function esc(s){
        return String(s || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function fmtDateRange(e){
        const ds = e.date_start || e.date || "";
        const de = e.date_end || "";
        if (e.when) return e.when;
        if (ds && de && ds !== de) return ds + " – " + de;
        return ds || "";
      }

      function dedupe(arr, keyFn){
        const out = [];
        const seen = new Set();
        for (const x of (arr || [])){
          const k = keyFn(x);
          if (!k || seen.has(k)) continue;
          seen.add(k);
          out.push(x);
        }
        return out;
      }

      /**
       * 1) Robust image resolver with prioritized fallbacks
       */
      function resolveImageUrl(item, type){
        // Priority order
        if (item.image_url) return String(item.image_url).trim();
        if (item.image) return String(item.image).trim();
        if (item.raw && item.raw.image_url) return String(item.raw.image_url).trim();
        if (item.json_ld_data){
          const jld = item.json_ld_data;
          if (jld.image){
            if (typeof jld.image === 'string') return jld.image.trim();
            if (Array.isArray(jld.image) && jld.image.length > 0){
              const first = jld.image[0];
              return typeof first === 'string' ? first.trim() : (first.url || first).trim();
            }
            if (typeof jld.image === 'object' && jld.image.url){
              return String(jld.image.url).trim();
            }
          }
        }
        if (item.og_image) return String(item.og_image).trim();
        if (item.product_image_url) return String(item.product_image_url).trim();
        if (item.event_image_url) return String(item.event_image_url).trim();

        // Type-based fallback
        return FALLBACKS[type] || FALLBACKS.event;
      }

      /**
       * 2) Get card summary with fallback generation
       */
      function getCardSummary(item, type){
        // Preferred order
        if (item.description) return String(item.description).trim();
        if (item.excerpt) return String(item.excerpt).trim();
        if (item.summary) return String(item.summary).trim();
        if (item.raw && item.raw.description) return String(item.raw.description).trim();
        if (item.json_ld_data && item.json_ld_data.description){
          return String(item.json_ld_data.description).trim();
        }

        // Generated fallback
        const parts = [];
        if (type === "event"){
          const loc = item.location || item.event_location || item.location_name || "";
          const dr = fmtDateRange(item);
          const exp = item.experience_level || "";
          if (loc) parts.push(loc);
          if (dr) parts.push(dr);
          if (exp) parts.push(exp);
          if (parts.length > 0) return "Workshop in " + parts.join(" • ");
        } else if (type === "guide" || type === "service"){
          const tags = (item.tags || []).concat(item.categories || []);
          if (tags.length > 0){
            return "Guide covering " + tags.slice(0, 3).join(", ");
          }
        }

        return "";
      }

      /**
       * 3) Normalize pills: dedupe, lowercase, trim
       */
      function normalizePills(pills){
        const seen = new Set();
        const out = [];
        for (const p of pills){
          if (!p) continue;
          const s = String(p).trim();
          if (!s) continue;
          const key = s.toLowerCase();
          if (seen.has(key)) continue;
          seen.add(key);
          out.push(s); // Keep original casing
        }
        return out;
      }

      /**
       * 4) Render pills HTML (max 4, with +N if more)
       */
      function renderPills(pills, maxCount = 4){
        const normalized = normalizePills(pills);
        const toShow = normalized.slice(0, maxCount);
        const remaining = normalized.length - maxCount;

        let html = "";
        for (const p of toShow){
          const isPrice = /^£/.test(p);
          html += '<span class="ar-pill' + (isPrice ? ' price' : '') + '">' + esc(p) + '</span>';
        }
        if (remaining > 0){
          html += '<span class="ar-pill">+' + remaining + '</span>';
        }
        return html;
      }

      /**
       * Render thumbnail with fallback image handling
       */
      function renderThumb(imageUrl, fallbackUrl, type, title){
        const url = (imageUrl || "").trim();
        const fallback = fallbackUrl || FALLBACKS[type] || FALLBACKS.event;

        if (!url || url === fallback){
          // No URL or already fallback - render fallback directly
          return '<div class="ar-thumb"><img src="' + esc(fallback) + '" alt="' + esc(title) + '" onerror="this.onerror=null; this.src=\'' + esc(fallback) + '\';"></div>';
        }

        // Has URL - render with onerror fallback
        return '<div class="ar-thumb"><img src="' + esc(url) + '" alt="' + esc(title) + '" loading="lazy" onerror="this.onerror=null; this.src=\'' + esc(fallback) + '\';"></div>';
      }

      function renderCard(item, kind){
        const title = item.title || item.event_title || item.product_title || "Untitled";
        const href = item.href || item.page_url || item.event_url || "#";

        // Resolve image with fallback
        const imageUrl = resolveImageUrl(item, kind);
        const fallbackUrl = FALLBACKS[kind] || FALLBACKS.event;
        const thumb = renderThumb(imageUrl, fallbackUrl, kind, title);

        // Debug tracking
        if (!imageUrl || imageUrl === fallbackUrl){
          debugStats.noUrl++;
          console.log('[DEBUG] No image URL:', { type: kind, title: title });
        }

        // Subtitle
        const subBits = [];
        const dr = fmtDateRange(item);
        const loc = item.location || item.event_location || item.location_name || "";
        const price = item.price_gbp ? ("£" + item.price_gbp) : (item.price ? ("£" + item.price) : "");

        if (dr) subBits.push(dr);
        if (loc) subBits.push(loc);
        if (price && kind === "event") subBits.push(price);

        const subtitle = subBits.join(" · ");

        // Description with fallback
        const desc = getCardSummary(item, kind);

        // Pills (normalized, deduped, capped at 4)
        const pillCandidates = [];
        pillCandidates.push(kind === "event" ? "event" : (kind === "service" ? "service" : "guide"));
        if (loc && kind === "event") pillCandidates.push(loc);
        if (price && kind === "event") pillCandidates.push(price);
        if (item.participants) pillCandidates.push(item.participants + " people");
        if (item.fitness_level) pillCandidates.push(item.fitness_level);
        if (item.experience_level) pillCandidates.push(item.experience_level);
        if (kind === "service" || kind === "guide"){
          (item.tags || []).forEach(t => pillCandidates.push(t));
          (item.categories || []).forEach(c => pillCandidates.push(c));
        }

        const pillsHtml = renderPills(pillCandidates, 4);

        // Actions
        const actions = [];
        actions.push('<a class="ar-btn more" href="' + esc(href) + '">More info →</a>');

        // Book now only if product_url exists
        if (kind === "event" && item.product_url){
          actions.push('<a class="ar-btn book" href="' + esc(item.product_url) + '">Book now</a>');
        }

        return (
          '<div class="ar-card">' +
            thumb +
            '<div class="ar-body">' +
              '<div class="ar-title">' + esc(title) + '</div>' +
              (subtitle ? '<div class="ar-sub">' + esc(subtitle) + '</div>' : '') +
              (desc ? '<div class="ar-desc">' + esc(desc) + '</div>' : '') +
              (pillsHtml ? '<div class="ar-pills">' + pillsHtml + '</div>' : '') +
              (actions.length ? '<div class="ar-actions">' + actions.join("") + '</div>' : '') +
            '</div>' +
          '</div>'
        );
      }

      function renderSection(label, items, kind, keyFn){
        const arr = dedupe(items || [], keyFn);
        const count = arr.length;

        let html = '<div class="ar-ss-section">';
        html += '<div class="ar-ss-section-head"><h3>' + esc(label) + '</h3><div class="ar-ss-count">' + count + ' matches</div></div>';

        if (!count){
          html += '<div class="ar-empty">No matches.</div>';
          html += '</div>';
          return html;
        }

        html += '<div class="ar-ss-grid">';
        for (const item of arr){
          html += renderCard(item, kind);
        }
        html += '</div></div>';
        return html;
      }

      function renderAll(structured){
        // Reset debug stats
        debugStats = { noUrl: 0, broken: 0 };

        const events = structured && structured.events ? structured.events : [];
        const services = structured && structured.services ? structured.services : [];
        const articles = structured && structured.articles ? structured.articles : [];

        let html = "";
        html += renderSection(
          "Workshops",
          events,
          "event",
          (e) => ( (e.event_url || e.page_url || e.href || "") + "|" + (e.date_start || e.date || "") )
        );
        html += renderSection(
          "Services",
          services,
          "service",
          (s) => (s.page_url || s.href || "")
        );
        html += renderSection(
          "Guides",
          articles,
          "guide",
          (a) => (a.page_url || a.href || "")
        );

        $results.innerHTML = html;

        // Debug log (remove after verification)
        if (debugStats.noUrl > 0 || debugStats.broken > 0){
          console.log('[DEBUG] Image stats:', debugStats);
        }
      }

      async function runSearch(q){
        const query = (q || "").trim();
        if (!query){
          setStatus("Type a query and press Enter.");
          setConfidence(null);
          $results.innerHTML = "";
          return;
        }

        setStatus('Searching for "' + query + '"…');
        setConfidence(null);

        // Keep the URL shareable
        const url = new URL(window.location.href);
        url.searchParams.set("q", query);
        window.history.replaceState({}, "", url.toString());

        try{
          const r = await fetch(ENDPOINT + "?q=" + encodeURIComponent(query) + "&limit=24", {
            method: "GET",
            headers: { "Content-Type": "application/json" }
          });

          const data = await r.json();

          if (!data || data.ok !== true){
            setStatus("Search failed. Please try again.");
            setConfidence(null);
            $results.innerHTML = "";
            return;
          }

          setStatus('Results for "' + query + '"');
          setConfidence(data.confidence);

          renderAll(data.structured || {});
        }catch(err){
          setStatus("Search failed. Please try again.");
          setConfidence(null);
          $results.innerHTML = "";
        }
      }

      function onSubmit(){
        runSearch($q.value);
      }

      $btn.addEventListener("click", onSubmit);
      $q.addEventListener("keydown", function(e){
        if (e.key === "Enter") onSubmit();
      });

      // Boot from URL
      const q0 = qs("q");
      if (q0){
        $q.value = q0;
        runSearch(q0);
      }
    })();
  </script>
</div>
