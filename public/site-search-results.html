<!-- AR | Site Search Results | v1.1 | Uses /api/search/query (chat ranking/confidence) -->
<div id="ar-site-search">
  <div class="ar-ss-wrap">
    <div class="ar-ss-searchcard">
      <div class="ar-ss-row">
        <input id="ar-ss-q" class="ar-ss-input" type="text" inputmode="search" placeholder="Search workshops, guides, services, landing pages…" />
        <button id="ar-ss-btn" class="ar-ss-btn" type="button">Search</button>
      </div>

      <div class="ar-ss-meta">
        <div id="ar-ss-status" class="ar-ss-chip">
          <span class="ar-ss-dot"></span>
          <span id="ar-ss-status-text">Type a query and press Enter.</span>
        </div>
        <div id="ar-ss-confidence" class="ar-ss-chip ar-ss-chip-muted">Confidence: —</div>
      </div>
    </div>

    <div id="ar-ss-results" class="ar-ss-results"></div>
  </div>

  <style>
    :root{
      --ar-orange:#E57200;
      --ar-green:#10b981;
      --ar-blue:#2563eb;
      --ar-text:#0f172a;
      --ar-muted:#64748b;
      --ar-border:rgba(15,23,42,.10);
      --ar-bg:#ffffff;
      --ar-soft:#f8fafc;
      --ar-shadow:0 10px 30px rgba(2,6,23,.08);
      --ar-radius:16px;
    }

    #ar-site-search{
      color:var(--ar-text);
    }
    .ar-ss-wrap{
      max-width: 1020px;
      margin: 0 auto;
      padding: 26px 16px 50px;
    }

    .ar-ss-searchcard{
      background:var(--ar-bg);
      border:1px solid var(--ar-border);
      border-radius:var(--ar-radius);
      box-shadow:var(--ar-shadow);
      padding:18px;
      margin-bottom:18px;
    }
    .ar-ss-row{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .ar-ss-input{
      flex:1;
      min-width:0;
      padding:12px 14px;
      border:1px solid var(--ar-border);
      border-radius:12px;
      outline:none;
      font-size:15px;
      background:#fff;
    }
    .ar-ss-input:focus{
      border-color: rgba(229,114,0,.55);
      box-shadow:0 0 0 3px rgba(229,114,0,.12);
    }
    .ar-ss-btn{
      border:0;
      background:var(--ar-orange);
      color:#fff;
      padding:11px 16px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 6px 16px rgba(229,114,0,.20);
    }
    .ar-ss-btn:hover{ filter:brightness(0.98); }

    .ar-ss-meta{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .ar-ss-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--ar-border);
      background:var(--ar-soft);
      color:var(--ar-text);
      padding:7px 10px;
      border-radius:999px;
      font-size:13px;
    }
    .ar-ss-chip-muted{
      color:var(--ar-muted);
      background:#fff;
    }
    .ar-ss-dot{
      width:8px;height:8px;border-radius:999px;background:var(--ar-orange);
      display:inline-block;
    }

    .ar-ss-section{
      background:#fff;
      border:1px solid var(--ar-border);
      border-radius:var(--ar-radius);
      overflow:hidden;
      margin: 14px 0;
      box-shadow:0 10px 26px rgba(2,6,23,.06);
    }
    .ar-ss-section-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      background: #f9fafb;
      border-bottom:1px solid var(--ar-border);
    }
    .ar-ss-section-head h3{
      margin:0;
      font-size:14px;
      letter-spacing:.02em;
      text-transform:none;
    }
    .ar-ss-count{
      color:var(--ar-muted);
      font-size:12px;
      font-weight:600;
    }

    .ar-ss-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
      padding:12px;
    }
    @media (max-width: 820px){
      .ar-ss-grid{ grid-template-columns: 1fr; }
      .ar-ss-btn{ padding:11px 14px; }
    }

    .ar-card{
      display:flex;
      gap:12px;
      align-items:flex-start;
      border:1px solid var(--ar-border);
      border-radius:14px;
      background:#fff;
      padding:12px;
      min-height: 120px;
    }
    .ar-thumb{
      width:120px;
      aspect-ratio:4/3;
      border-radius:12px;
      border:1px solid var(--ar-border);
      background:#eef2f7;
      overflow:hidden;
      flex:0 0 120px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#94a3b8;
      font-weight:800;
      letter-spacing:.02em;
    }
    .ar-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .ar-body{ min-width:0; flex:1; }
    .ar-title{
      margin:0;
      font-size:14px;
      line-height:1.25;
      font-weight:800;
    }
    .ar-sub{
      margin:4px 0 6px;
      color:var(--ar-muted);
      font-size:12px;
      line-height:1.35;
    }
    .ar-desc{
      margin:0 0 8px;
      color:rgba(15,23,42,.78);
      font-size:12.5px;
      line-height:1.4;
      display:-webkit-box;
      -webkit-line-clamp:2;
      line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height:2.8em;
    }

    .ar-pills{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin: 8px 0 0;
    }
    .ar-pill{
      border:1px solid rgba(229,114,0,.35);
      background: rgba(229,114,0,.08);
      color: rgba(124,45,18,.95);
      padding:3px 6px;
      border-radius:6px;
      font-size:10px;
      font-weight:700;
      line-height:1.2;
      white-space:nowrap;
      cursor:default;
      -webkit-user-select:none;
      user-select:none;
    }
    .ar-pill.price{
      border-color: rgba(37,99,235,.35);
      background: var(--ar-blue);
      color: #fff;
      font-weight:800;
      pointer-events:none;
      cursor:default;
    }
    .ar-pill.price:hover{
      background: var(--ar-blue);
      filter:none;
      cursor:default;
    }

    .ar-actions{
      display:flex;
      gap:8px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .ar-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      font-weight:800;
      text-decoration:none;
      border:1px solid var(--ar-border);
      background:#fff;
      color:var(--ar-text);
      cursor:pointer;
    }
    .ar-btn.more{
      background:var(--ar-orange);
      color:#fff;
      border-color:rgba(229,114,0,.35);
    }
    .ar-btn.book{
      background:var(--ar-green);
      color:#fff;
      border-color:rgba(16,185,129,.35);
    }
    .ar-btn:hover{ filter:brightness(.985); }

    .ar-empty{
      padding:12px;
      color:var(--ar-muted);
      font-size:13px;
    }
  </style>

  <script>
    (function(){
      const API_BASE = "https://alan-chat-proxy.vercel.app";
      const ENDPOINT = API_BASE + "/api/search/query";

      // Fallback images (use hosted images or logo)
      const FALLBACKS = {
        event: "https://www.alanranger.com/s/default-image.jpg", // Replace with actual fallback URL
        service: "https://www.alanranger.com/s/default-image.jpg",
        guide: "https://www.alanranger.com/s/default-image.jpg"
      };

      const $q = document.getElementById("ar-ss-q");
      const $btn = document.getElementById("ar-ss-btn");
      const $results = document.getElementById("ar-ss-results");
      const $statusText = document.getElementById("ar-ss-status-text");
      const $confidence = document.getElementById("ar-ss-confidence");

      // Debug counters (remove after verification)
      let debugStats = { noUrl: 0, broken: 0 };

      function qs(key){
        const p = new URLSearchParams(window.location.search);
        return p.get(key) || "";
      }

      function setStatus(msg){
        $statusText.textContent = msg;
      }

      function setConfidence(val){
        if (typeof val === "number" && isFinite(val)){
          const pct = Math.round(val * 100);
          $confidence.textContent = "Confidence: " + pct + "%";
        } else {
          $confidence.textContent = "Confidence: —";
        }
      }

      function esc(s){
        return String(s || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function fmtDateRange(e){
        const ds = e.date_start || e.date || "";
        const de = e.date_end || "";
        if (e.when) return e.when;
        if (ds && de && ds !== de) return ds + " – " + de;
        return ds || "";
      }

      function dedupe(arr, keyFn){
        const out = [];
        const seen = new Set();
        for (const x of (arr || [])){
          const k = keyFn(x);
          if (!k || seen.has(k)) continue;
          seen.add(k);
          out.push(x);
        }
        return out;
      }

      /**
       * 1) Image resolver - uses server-normalized image_url
       * Server already normalizes all image fields to image_url, so we just use that
       * Returns empty string if no valid URL found (fallback handled in renderThumb)
       */
      function pickImage(item){
        // Server normalizes all image fields to image_url
        const url = item.image_url;
        
        if (!url || typeof url !== 'string') return "";
        
        const trimmed = url.trim();
        if (!trimmed || (!trimmed.startsWith('http://') && !trimmed.startsWith('https://'))) {
          return "";
        }
        
        // Convert HTTP to HTTPS (defensive, server should already do this)
        return trimmed.startsWith('http://') ? 'https://' + trimmed.substring(7) : trimmed;
      }

      function extractJsonLdImage(jsonLd){
        if (!jsonLd || !jsonLd.image) return null;
        const img = jsonLd.image;
        if (typeof img === 'string') return img.trim();
        if (Array.isArray(img) && img.length > 0){
          const first = img[0];
          return typeof first === 'string' ? first.trim() : String(first.url || first).trim();
        }
        if (typeof img === 'object' && img.url){
          return String(img.url).trim();
        }
        return null;
      }

      /**
       * 2) Description picker - uses server-normalized excerpt
       * Server normalizes all description fields to excerpt, so we use that with fallback
       * Always returns a string (never null/undefined) - generates fallback if needed
       */
      function pickDescription(item, type){
        // Server normalizes to excerpt, but keep fallbacks for backward compatibility
        if (item.excerpt && typeof item.excerpt === 'string') {
          const trimmed = item.excerpt.trim();
          if (trimmed) return trimmed;
        }
        
        // Fallback to other fields if excerpt not available
        if (item.meta_description && typeof item.meta_description === 'string') {
          const trimmed = item.meta_description.trim();
          if (trimmed) return trimmed;
        }
        if (item.description && typeof item.description === 'string') {
          const trimmed = item.description.trim();
          if (trimmed) return trimmed;
        }

        // Generate fallback (especially for events)
        return generateSummaryFallback(item, type);
      }

      function generateSummaryFallback(item, type){
        if (type === "event"){
          return generateEventSummary(item);
        }
        if (type === "guide" || type === "service"){
          return generateGuideSummary(item);
        }
        return "";
      }

      function generateEventSummary(item){
        const parts = [];
        const loc = item.location || item.event_location || item.location_name || "";
        const dr = fmtDateRange(item);
        const exp = item.experience_level || "";
        if (loc) parts.push(loc);
        if (dr) parts.push(dr);
        if (exp) parts.push(exp);
        return parts.length > 0 ? "Workshop in " + parts.join(" • ") : "";
      }

      function generateGuideSummary(item){
        const tags = (item.tags || []).concat(item.categories || []);
        return tags.length > 0 ? "Guide covering " + tags.slice(0, 3).join(", ") : "";
      }

      /**
       * 3) Normalize pills: dedupe, lowercase, trim
       */
      function normalizePills(pills){
        const seen = new Set();
        const out = [];
        for (const p of pills){
          if (!p) continue;
          const s = String(p).trim();
          if (!s) continue;
          const key = s.toLowerCase();
          if (seen.has(key)) continue;
          seen.add(key);
          out.push(s); // Keep original casing
        }
        return out;
      }

      /**
       * 4) Render pills HTML (max 4, with +N if more)
       * Price pill is always visible (pinned) even if it would be pushed out
       */
      function renderPills(pills, maxCount = 4){
        const normalized = normalizePills(pills);
        
        // Separate price pill from other pills
        const pricePills = [];
        const otherPills = [];
        for (const p of normalized) {
          if (/^£/.test(p)) {
            pricePills.push(p);
          } else {
            otherPills.push(p);
          }
        }

        // Show up to maxCount-1 other pills (reserve 1 slot for price if needed)
        const slotsForOthers = pricePills.length > 0 ? maxCount - 1 : maxCount;
        const toShow = otherPills.slice(0, slotsForOthers);
        const remaining = otherPills.length - slotsForOthers;

        let html = "";
        // Render other pills first
        for (const p of toShow){
          html += '<span class="ar-pill">' + esc(p) + '</span>';
        }
        // Always show price pill(s) if present
        for (const p of pricePills){
          html += '<span class="ar-pill price">' + esc(p) + '</span>';
        }
        // Show overflow if there are remaining other pills
        if (remaining > 0){
          html += '<span class="ar-pill">+' + remaining + '</span>';
        }
        return html;
      }

      /**
       * Render thumbnail with fallback image handling
       * Uses pickImage() to get URL, falls back to "AR" placeholder if empty
       * Includes onerror handler to swap to "AR" if image fails to load
       */
      function renderThumb(item, type, title){
        const imageUrl = pickImage(item);

        if (!imageUrl || imageUrl === ""){
          // No URL - render "AR" placeholder (not fallback image)
          return '<div class="ar-thumb">AR</div>';
        }

        // Has URL - render with onerror fallback (prevents infinite loop by setting onerror to null)
        // pickImage already converts HTTP to HTTPS, but double-check
        const safeUrl = imageUrl.startsWith('http://') ? 'https://' + imageUrl.substring(7) : imageUrl;
        return '<div class="ar-thumb"><img src="' + esc(safeUrl) + '" alt="' + esc(title) + '" loading="lazy" onerror="this.onerror=null; this.parentElement.textContent=\'AR\';"></div>';
      }

      function renderCard(item, kind){
        const title = item.title || item.event_title || item.product_title || "Untitled";
        const href = item.href || item.page_url || item.event_url || "#";

        // Resolve image using pickImage()
        const thumb = renderThumb(item, kind, title);

        // Debug tracking
        const imageUrl = pickImage(item);
        if (!imageUrl || imageUrl === ""){
          debugStats.noUrl++;
          console.log('[DEBUG] No image URL:', { type: kind, title: title });
        }

        // Subtitle
        const subtitle = buildSubtitle(item, kind);

        // Description with pickDescription() - always show for workshops
        const desc = pickDescription(item, kind);
        // For events, always render description (even if empty, fallback was generated)
        const showDesc = kind === "event" ? true : (desc && desc.length > 0);

        // Pills (normalized, deduped, capped at 4, price pinned)
        const pillCandidates = collectPillCandidates(item, kind);
        const pillsHtml = renderPills(pillCandidates, 4);

        // Actions
        const actions = buildActions(item, kind, href);

        return (
          '<div class="ar-card">' +
            thumb +
            '<div class="ar-body">' +
              '<div class="ar-title">' + esc(title) + '</div>' +
              (subtitle ? '<div class="ar-sub">' + esc(subtitle) + '</div>' : '') +
              (showDesc ? '<div class="ar-desc">' + esc(desc) + '</div>' : '') +
              (pillsHtml ? '<div class="ar-pills">' + pillsHtml + '</div>' : '') +
              (actions.length ? '<div class="ar-actions">' + actions.join("") + '</div>' : '') +
            '</div>' +
          '</div>'
        );
      }

      function buildSubtitle(item, kind){
        const subBits = [];
        const dr = fmtDateRange(item);
        const loc = item.location || item.event_location || item.location_name || "";
        const price = item.price_gbp ? ("£" + item.price_gbp) : (item.price ? ("£" + item.price) : "");

        if (dr) subBits.push(dr);
        if (loc) subBits.push(loc);
        if (price && kind === "event") subBits.push(price);

        return subBits.join(" · ");
      }

      function collectPillCandidates(item, kind){
        const candidates = [];
        const kindLabel = kind === "event" ? "event" : (kind === "service" ? "service" : "guide");
        candidates.push(kindLabel);

        if (kind === "event"){
          const loc = item.location || item.event_location || item.location_name || "";
          const price = item.price_gbp ? ("£" + item.price_gbp) : (item.price ? ("£" + item.price) : "");
          if (loc) candidates.push(loc);
          if (price) candidates.push(price);
          if (item.participants) candidates.push(item.participants + " people");
          if (item.fitness_level) candidates.push(item.fitness_level);
          if (item.experience_level) candidates.push(item.experience_level);
        } else {
          (item.tags || []).forEach(t => candidates.push(t));
          (item.categories || []).forEach(c => candidates.push(c));
        }

        return candidates;
      }

      function buildActions(item, kind, href){
        const actions = [];
        actions.push('<a class="ar-btn more" href="' + esc(href) + '">More info →</a>');

        // Book now only if product_url exists
        if (kind === "event" && item.product_url){
          actions.push('<a class="ar-btn book" href="' + esc(item.product_url) + '">Book now</a>');
        }

        return actions;
      }

      function renderSection(label, items, kind, keyFn){
        const arr = dedupe(items || [], keyFn);
        const count = arr.length;

        let html = '<div class="ar-ss-section">';
        html += '<div class="ar-ss-section-head"><h3>' + esc(label) + '</h3><div class="ar-ss-count">' + count + ' matches</div></div>';

        if (!count){
          html += '<div class="ar-empty">No matches.</div>';
          html += '</div>';
          return html;
        }

        html += '<div class="ar-ss-grid">';
        for (const item of arr){
          html += renderCard(item, kind);
        }
        html += '</div></div>';
        return html;
      }

      function renderAll(structured){
        // Reset debug stats
        debugStats = { noUrl: 0, broken: 0 };

        const events = structured && structured.events ? structured.events : [];
        const services = structured && structured.services ? structured.services : [];
        const articles = structured && structured.articles ? structured.articles : [];

        let html = "";
        html += renderSection(
          "Workshops",
          events,
          "event",
          (e) => ( (e.event_url || e.page_url || e.href || "") + "|" + (e.date_start || e.date || "") )
        );
        html += renderSection(
          "Services",
          services,
          "service",
          (s) => (s.page_url || s.href || "")
        );
        html += renderSection(
          "Guides",
          articles,
          "guide",
          (a) => (a.page_url || a.href || "")
        );

        $results.innerHTML = html;

        // Debug log (remove after verification)
        if (debugStats.noUrl > 0 || debugStats.broken > 0){
          console.log('[DEBUG] Image stats:', debugStats);
        }
      }

      async function runSearch(q){
        const query = (q || "").trim();
        if (!query){
          setStatus("Type a query and press Enter.");
          setConfidence(null);
          $results.innerHTML = "";
          return;
        }

        setStatus('Searching for "' + query + '"…');
        setConfidence(null);

        // Keep the URL shareable
        const url = new URL(window.location.href);
        url.searchParams.set("q", query);
        window.history.replaceState({}, "", url.toString());

        try{
          const r = await fetch(ENDPOINT + "?q=" + encodeURIComponent(query) + "&limit=24", {
            method: "GET",
            headers: { "Content-Type": "application/json" }
          });

          const data = await r.json();

          if (!data || data.ok !== true){
            setStatus("Search failed. Please try again.");
            setConfidence(null);
            $results.innerHTML = "";
            return;
          }

          setStatus('Results for "' + query + '"');
          setConfidence(data.confidence);

          renderAll(data.structured || {});
        }catch(err){
          setStatus("Search failed. Please try again.");
          setConfidence(null);
          $results.innerHTML = "";
        }
      }

      function onSubmit(){
        runSearch($q.value);
      }

      $btn.addEventListener("click", onSubmit);
      $q.addEventListener("keydown", function(e){
        if (e.key === "Enter") onSubmit();
      });

      // Boot from URL
      const q0 = qs("q");
      if (q0){
        $q.value = q0;
        runSearch(q0);
      }
    })();
  </script>
</div>
