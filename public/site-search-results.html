<!-- AR | Site Search Results | v1.0 | Uses /api/search/query (chat ranking/confidence) -->
<div id="ar-site-search">
  <div class="ar-ss-wrap">
    <div class="ar-ss-searchcard">
      <div class="ar-ss-row">
        <input id="ar-ss-q" class="ar-ss-input" type="text" inputmode="search" placeholder="Search workshops, guides, services, landing pages…" />
        <button id="ar-ss-btn" class="ar-ss-btn" type="button">Search</button>
      </div>

      <div class="ar-ss-meta">
        <div id="ar-ss-status" class="ar-ss-chip">
          <span class="ar-ss-dot"></span>
          <span id="ar-ss-status-text">Type a query and press Enter.</span>
        </div>
        <div id="ar-ss-confidence" class="ar-ss-chip ar-ss-chip-muted">Confidence: —</div>
      </div>
    </div>

    <div id="ar-ss-results" class="ar-ss-results"></div>
  </div>

  <style>
    :root{
      --ar-orange:#E57200;
      --ar-green:#10b981;
      --ar-blue:#2563eb;
      --ar-text:#0f172a;
      --ar-muted:#64748b;
      --ar-border:rgba(15,23,42,.10);
      --ar-bg:#ffffff;
      --ar-soft:#f8fafc;
      --ar-shadow:0 10px 30px rgba(2,6,23,.08);
      --ar-radius:16px;
    }

    #ar-site-search{
      color:var(--ar-text);
    }
    .ar-ss-wrap{
      max-width: 1020px;
      margin: 0 auto;
      padding: 26px 16px 50px;
    }

    .ar-ss-searchcard{
      background:var(--ar-bg);
      border:1px solid var(--ar-border);
      border-radius:var(--ar-radius);
      box-shadow:var(--ar-shadow);
      padding:18px;
      margin-bottom:18px;
    }
    .ar-ss-row{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .ar-ss-input{
      flex:1;
      min-width:0;
      padding:12px 14px;
      border:1px solid var(--ar-border);
      border-radius:12px;
      outline:none;
      font-size:15px;
      background:#fff;
    }
    .ar-ss-input:focus{
      border-color: rgba(229,114,0,.55);
      box-shadow:0 0 0 3px rgba(229,114,0,.12);
    }
    .ar-ss-btn{
      border:0;
      background:var(--ar-orange);
      color:#fff;
      padding:11px 16px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 6px 16px rgba(229,114,0,.20);
    }
    .ar-ss-btn:hover{ filter:brightness(0.98); }

    .ar-ss-meta{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .ar-ss-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--ar-border);
      background:var(--ar-soft);
      color:var(--ar-text);
      padding:7px 10px;
      border-radius:999px;
      font-size:13px;
    }
    .ar-ss-chip-muted{
      color:var(--ar-muted);
      background:#fff;
    }
    .ar-ss-dot{
      width:8px;height:8px;border-radius:999px;background:var(--ar-orange);
      display:inline-block;
    }

    .ar-ss-section{
      background:#fff;
      border:1px solid var(--ar-border);
      border-radius:var(--ar-radius);
      overflow:hidden;
      margin: 14px 0;
      box-shadow:0 10px 26px rgba(2,6,23,.06);
    }
    .ar-ss-section-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      background: #f9fafb;
      border-bottom:1px solid var(--ar-border);
    }
    .ar-ss-section-head h3{
      margin:0;
      font-size:14px;
      letter-spacing:.02em;
      text-transform:none;
    }
    .ar-ss-count{
      color:var(--ar-muted);
      font-size:12px;
      font-weight:600;
    }

    .ar-ss-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
      padding:12px;
    }
    @media (max-width: 820px){
      .ar-ss-grid{ grid-template-columns: 1fr; }
      .ar-ss-btn{ padding:11px 14px; }
    }

    .ar-card{
      display:flex;
      gap:12px;
      align-items:flex-start;
      border:1px solid var(--ar-border);
      border-radius:14px;
      background:#fff;
      padding:12px;
      min-height: 108px;
    }
    .ar-thumb{
      width:86px;
      height:86px;
      border-radius:12px;
      border:1px solid var(--ar-border);
      background:#eef2f7;
      overflow:hidden;
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#94a3b8;
      font-weight:800;
      letter-spacing:.02em;
    }
    .ar-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .ar-body{ min-width:0; flex:1; }
    .ar-title{
      margin:0;
      font-size:14px;
      line-height:1.25;
      font-weight:800;
    }
    .ar-sub{
      margin:4px 0 6px;
      color:var(--ar-muted);
      font-size:12px;
      line-height:1.35;
    }
    .ar-desc{
      margin:0 0 8px;
      color:rgba(15,23,42,.78);
      font-size:12.5px;
      line-height:1.4;
    }

    .ar-pills{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin: 8px 0 0;
    }
    .ar-pill{
      border:1px solid rgba(229,114,0,.35);
      background: rgba(229,114,0,.08);
      color: rgba(124,45,18,.95);
      padding:4px 8px;
      border-radius:999px;
      font-size:11.5px;
      font-weight:700;
      white-space:nowrap;
    }
    .ar-pill.price{
      border-color: rgba(37,99,235,.35);
      background: rgba(37,99,235,.10);
      color: #1d4ed8;
    }

    .ar-actions{
      display:flex;
      gap:8px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .ar-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      font-weight:800;
      text-decoration:none;
      border:1px solid var(--ar-border);
      background:#fff;
      color:var(--ar-text);
      cursor:pointer;
    }
    .ar-btn.more{
      background:var(--ar-orange);
      color:#fff;
      border-color:rgba(229,114,0,.35);
    }
    .ar-btn.book{
      background:var(--ar-green);
      color:#fff;
      border-color:rgba(16,185,129,.35);
    }
    .ar-btn:hover{ filter:brightness(.985); }

    .ar-empty{
      padding:12px;
      color:var(--ar-muted);
      font-size:13px;
    }
  </style>

  <script>
    (function(){
      const API_BASE = "https://alan-chat-proxy.vercel.app";
      const ENDPOINT = API_BASE + "/api/search/query";

      const $q = document.getElementById("ar-ss-q");
      const $btn = document.getElementById("ar-ss-btn");
      const $results = document.getElementById("ar-ss-results");
      const $statusText = document.getElementById("ar-ss-status-text");
      const $confidence = document.getElementById("ar-ss-confidence");

      function qs(key){
        const p = new URLSearchParams(window.location.search);
        return p.get(key) || "";
      }

      function setStatus(msg){
        $statusText.textContent = msg;
      }

      function setConfidence(val){
        if (typeof val === "number" && isFinite(val)){
          const pct = Math.round(val * 100);
          $confidence.textContent = "Confidence: " + pct + "%";
        } else {
          $confidence.textContent = "Confidence: —";
        }
      }

      function esc(s){
        return String(s || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function fmtDateRange(e){
        const ds = e.date_start || e.date || "";
        const de = e.date_end || "";
        // Keep it simple: rely on existing formatted strings if provided
        if (e.when) return e.when;
        if (ds && de && ds !== de) return ds + " – " + de;
        return ds || "";
      }

      function dedupe(arr, keyFn){
        const out = [];
        const seen = new Set();
        for (const x of (arr || [])){
          const k = keyFn(x);
          if (!k || seen.has(k)) continue;
          seen.add(k);
          out.push(x);
        }
        return out;
      }

      function pickImage(item){
        return item.image_url
          || (item.raw && item.raw.image_url)
          || item.image
          || null;
      }

      function pill(text, cls){
        if (!text) return "";
        return '<span class="ar-pill ' + (cls || "") + '">' + esc(text) + '</span>';
      }

      function renderCard(item, kind){
        const title = item.title || item.event_title || item.product_title || "Untitled";
        const href = item.href || item.page_url || item.event_url || "#";

        const imageUrl = pickImage(item);
        const thumb = imageUrl
          ? '<div class="ar-thumb"><img src="' + esc(imageUrl) + '" alt=""></div>'
          : '<div class="ar-thumb">AR</div>';

        const subBits = [];
        const dr = fmtDateRange(item);
        const loc = item.location || item.event_location || item.location_name || "";
        const price = item.price_gbp ? ("£" + item.price_gbp) : (item.price ? ("£" + item.price) : "");

        if (dr) subBits.push(dr);
        if (loc) subBits.push(loc);
        if (price && kind === "event") subBits.push(price);

        const subtitle = subBits.join(" · ");

        // Description fallback
        const desc = item.description || item.excerpt || item.summary || "";

        // Pills
        const pills = [];
        pills.push(pill(kind === "event" ? "event" : (kind === "service" ? "service" : "guide")));
        if (loc && kind === "event") pills.push(pill(loc));
        if (price && kind === "event") pills.push(pill(price, "price"));
        if (item.participants) pills.push(pill(item.participants + " people"));
        if (item.fitness_level) pills.push(pill(item.fitness_level));
        if (item.experience_level) pills.push(pill(item.experience_level));

        const pillsHtml = pills.filter(Boolean).join("");

        // Actions
        const actions = [];
        actions.push('<a class="ar-btn more" href="' + esc(href) + '">More info →</a>');

        // Book now only if we have product_url
        if (kind === "event" && item.product_url){
          actions.push('<a class="ar-btn book" href="' + esc(item.product_url) + '">Book now</a>');
        }

        return (
          '<div class="ar-card">' +
            thumb +
            '<div class="ar-body">' +
              '<div class="ar-title">' + esc(title) + '</div>' +
              (subtitle ? '<div class="ar-sub">' + esc(subtitle) + '</div>' : '') +
              (desc ? '<div class="ar-desc">' + esc(desc) + '</div>' : '') +
              (pillsHtml ? '<div class="ar-pills">' + pillsHtml + '</div>' : '') +
              (actions.length ? '<div class="ar-actions">' + actions.join("") + '</div>' : '') +
            '</div>' +
          '</div>'
        );
      }

      function renderSection(label, items, kind, keyFn){
        const arr = dedupe(items || [], keyFn);
        const count = arr.length;

        let html = '<div class="ar-ss-section">';
        html += '<div class="ar-ss-section-head"><h3>' + esc(label) + '</h3><div class="ar-ss-count">' + count + ' matches</div></div>';

        if (!count){
          html += '<div class="ar-empty">No matches.</div>';
          html += '</div>';
          return html;
        }

        html += '<div class="ar-ss-grid">';
        for (const item of arr){
          html += renderCard(item, kind);
        }
        html += '</div></div>';
        return html;
      }

      function renderAll(structured){
        const events = structured && structured.events ? structured.events : [];
        const services = structured && structured.services ? structured.services : [];
        const articles = structured && structured.articles ? structured.articles : [];

        let html = "";
        html += renderSection(
          "Workshops",
          events,
          "event",
          (e) => ( (e.event_url || e.page_url || e.href || "") + "|" + (e.date_start || e.date || "") )
        );
        html += renderSection(
          "Services",
          services,
          "service",
          (s) => (s.page_url || s.href || "")
        );
        html += renderSection(
          "Guides",
          articles,
          "guide",
          (a) => (a.page_url || a.href || "")
        );

        $results.innerHTML = html;
      }

      async function runSearch(q){
        const query = (q || "").trim();
        if (!query){
          setStatus("Type a query and press Enter.");
          setConfidence(null);
          $results.innerHTML = "";
          return;
        }

        setStatus('Searching for "' + query + '"…');
        setConfidence(null);

        // Keep the URL shareable
        const url = new URL(window.location.href);
        url.searchParams.set("q", query);
        window.history.replaceState({}, "", url.toString());

        try{
          const r = await fetch(ENDPOINT + "?q=" + encodeURIComponent(query) + "&limit=24", {
            method: "GET",
            headers: { "Content-Type": "application/json" }
          });

          const data = await r.json();

          if (!data || data.ok !== true){
            setStatus("Search failed. Please try again.");
            setConfidence(null);
            $results.innerHTML = "";
            return;
          }

          setStatus('Results for "' + query + '"');
          setConfidence(data.confidence);

          renderAll(data.structured || {});
        }catch(err){
          setStatus("Search failed. Please try again.");
          setConfidence(null);
          $results.innerHTML = "";
        }
      }

      function onSubmit(){
        runSearch($q.value);
      }

      $btn.addEventListener("click", onSubmit);
      $q.addEventListener("keydown", function(e){
        if (e.key === "Enter") onSubmit();
      });

      // Boot from URL
      const q0 = qs("q");
      if (q0){
        $q.value = q0;
        runSearch(q0);
      }
    })();
  </script>
</div>
