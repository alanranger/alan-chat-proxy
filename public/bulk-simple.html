<!DOCTYPE html>
<html>
<head>
  <title>Alan Ranger Photography - Data Pipeline</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 30px; }
    .card { background: #2a2a2a; padding: 20px; margin: 20px 0; border-radius: 8px; }
    .section { margin: 30px 0; }
    .file-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .file-item { background: #333; padding: 15px; border-radius: 5px; }
    .file-item h4 { margin: 0 0 10px 0; color: #4CAF50; }
    .file-item input[type="file"] { width: 100%; margin: 10px 0; }
    .file-item small { color: #ccc; display: block; margin: 5px 0; }
    .btn { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
    .btn:hover { background: #45a049; }
    .btn-danger { background: #f44336; }
    .btn-danger:hover { background: #da190b; }
    .btn-primary { background: #2196F3; }
    .btn-primary:hover { background: #1976D2; }
    .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
    .status.success { background: #4CAF50; color: white; }
    .status.error { background: #f44336; color: white; }
    .status.info { background: #2196F3; color: white; }
    .results { background: #000; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
    .progress { width: 100%; background: #333; border-radius: 5px; margin: 10px 0; }
    .progress-bar { height: 20px; background: #4CAF50; border-radius: 5px; transition: width 0.3s; }
    .hidden { display: none; }
    .token-section { background: #333; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .token-section input { width: 100%; padding: 8px; margin: 5px 0; background: #444; color: white; border: 1px solid #666; border-radius: 3px; }
    
    .stat-box {
      text-align: center;
      padding: 10px;
      background: #2a2a2a;
      border-radius: 5px;
      border: 1px solid #444;
    }
    
    .stat-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #fff;
    }
    
    .stat-value.success { color: #51cf66; }
    .stat-value.error { color: #ff6b6b; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¯ Alan Ranger Photography - Data Pipeline</h1>
      <p>Simple CSV Import & Web Scraping Tool</p>
      <small>v1.0.0 - Simplified Interface</small>
    </div>

    <!-- Token Section -->
    <div class="token-section">
      <h3>ğŸ” Authentication</h3>
      <div class="status success">âœ… Token: b6c3f0c9e6f44cce9e1a4f3f2d3a5c76 (Hardcoded)</div>
      <small>Token is automatically configured for this private interface</small>
    </div>

    <!-- CSV Files Section -->
    <div class="section">
      <h2>ğŸ“ Upload Your CSV Files</h2>
      <div class="file-grid">
        <div class="file-item">
          <h4>ğŸ“ Blog Articles</h4>
          <input type="file" id="blogCsv" accept=".csv" />
          <small>Blog posts with categories, tags, content</small>
        </div>
        <div class="file-item">
          <h4>ğŸ“ Course Events</h4>
          <input type="file" id="courseEventsCsv" accept=".csv" />
          <small>Scheduled course events with dates, times, locations</small>
        </div>
        <div class="file-item">
          <h4>ğŸï¸ Workshop Events</h4>
          <input type="file" id="workshopEventsCsv" accept=".csv" />
          <small>Scheduled workshop events with dates, times, locations</small>
        </div>
        <div class="file-item">
          <h4>ğŸ¯ Service Pages</h4>
          <input type="file" id="servicePagesCsv" accept=".csv" />
          <small>Service and course page content</small>
        </div>
        <div class="file-item">
          <h4>ğŸ§¾ Service Products (prices, availability)</h4>
          <input type="file" id="productsCsv" accept=".csv" />
          <small>Service product CSV (prices, availability)</small>
        </div>
        <div class="file-item">
          <h4>ğŸŒ Site URLs</h4>
          <input type="file" id="siteUrlsCsv" accept=".csv" />
          <small>List of URLs to scrape from your website</small>
        </div>
        <div class="file-item">
          <h4>ğŸ“„ Landing Pages</h4>
          <input type="file" id="landingPagesCsv" accept=".csv" />
          <small>Landing page content and metadata</small>
        </div>
        <div class="file-item">
          <h4>â“ Test Questions</h4>
          <input type="file" id="testQuestionsCsv" accept=".csv" />
          <small>Test questions for AI bot validation</small>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="section">
      <h2>ğŸš€ Actions (Execute in Order)</h2>
      <div class="card">
        <button class="btn btn-primary" onclick="importAllCSVs()" id="importAllBtn">
          1ï¸âƒ£ ğŸ“¥ Import All CSV Files
        </button>
        <button class="btn" onclick="scrapeWebsite()" id="scrapeBtn">
          2ï¸âƒ£ ğŸ•·ï¸ Scrape Website URLs
        </button>
        <button class="btn" onclick="stopScrape()" id="stopScrapeBtn" style="display:none">
          â¹ï¸ Stop Scrape
        </button>
        <button class="btn" onclick="runMapping()" id="mappingBtn">
          3ï¸âƒ£ ğŸ”— Run Event â†’ Product Mapping
        </button>
        <button class="btn btn-danger" onclick="clearResults()">
          ğŸ—‘ï¸ Clear Results
        </button>
      </div>
      <div style="margin-top: 10px; padding: 10px; background: #2a2a2a; border-radius: 5px;">
        <small>
          <strong>Workflow:</strong>
          <span id="stepImport" style="padding:2px 6px;border-radius:4px;background:#555;margin-right:6px;">1ï¸âƒ£ Import CSVs: idle</span>
          <span id="stepScrape" style="padding:2px 6px;border-radius:4px;background:#555;margin-right:6px;">2ï¸âƒ£ Scrape URLs: idle</span>
          <span id="stepMap" style="padding:2px 6px;border-radius:4px;background:#555;">3ï¸âƒ£ Create Mappings: idle</span>
        </small>
      </div>
    </div>

    <!-- Progress Section -->
    <div class="section" id="progressSection" class="hidden">
      <h3>ğŸ“Š Progress</h3>
      <div class="progress">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      </div>
      <div id="progressText">Ready to start...</div>
    </div>

    <!-- Debug & Control Section -->
    <div class="section">
      <h3>ğŸ”§ Debug & Control</h3>
      <div class="card">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
          <div class="stat-box">
            <div class="stat-label">Loaded Rows</div>
            <div class="stat-value" id="loadedRows">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Success</div>
            <div class="stat-value success" id="successCount">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Failed</div>
            <div class="stat-value error" id="failedCount">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Stopped</div>
            <div class="stat-value" id="stoppedCount">0</div>
          </div>
        </div>
        <div id="categoryStats" style="margin-top: 10px;">
          <!-- per-category stats will render here -->
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn" onclick="copyDebugLog()">ğŸ“‹ Copy Debug Log</button>
          <button class="btn" onclick="downloadDebugLog()">â¬‡ï¸ Download Debug Log</button>
          <button class="btn" onclick="clearResults()">ğŸ—‘ï¸ Clear Log</button>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="section">
      <h2>ğŸ“‹ Results & Debug</h2>
      <div style="margin-bottom: 10px;">
        <button class="btn" onclick="copyDebugLog()">ğŸ“‹ Copy Debug Log</button>
        <button class="btn" onclick="clearResults()">ğŸ—‘ï¸ Clear Log</button>
      </div>
      <div class="results" id="results">
        Ready to import your data. Select your CSV files and click "Import All CSV Files".
      </div>
    </div>

    <!-- Extract Structured JSON Section -->
    <div class="section">
      <h2>ğŸ” Extract Structured JSON (JSON-LD)</h2>
      <div class="card">
        <div style="margin-bottom: 15px;">
          <label>URL to extract from:</label>
          <input type="text" id="extractUrl" placeholder="https://www.alanranger.com/some-page" style="width: 100%; margin-bottom: 10px;" />
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
          <button class="btn" onclick="extractContent('events')">ğŸ“… Events/Courses</button>
          <button class="btn" onclick="extractContent('articles')">ğŸ“ Articles</button>
          <button class="btn" onclick="extractContent('products')">ğŸ›ï¸ Products</button>
          <button class="btn" onclick="extractContent('services')">ğŸ¯ Services</button>
          <button class="btn" onclick="extractContent('all')">ğŸ” All Content</button>
          <button class="btn" onclick="clearExtractResults()">ğŸ—‘ï¸ Clear</button>
        </div>
        <div id="extractResults" style="margin-top: 15px; padding: 10px; background: #1a1a1a; border-radius: 5px; min-height: 100px; font-family: monospace; white-space: pre-wrap;"></div>
      </div>
    </div>

    <!-- Quick Test Section -->
    <div class="section">
      <h2>ğŸ§ª Quick Test</h2>
      <div class="card">
        <input type="text" id="testUrl" placeholder="Enter URL to test" style="width: 70%; padding: 8px; margin: 5px; background: #444; color: white; border: 1px solid #666; border-radius: 3px;" />
        <button class="btn" onclick="testSingleUrl()">Test URL</button>
        <br>
        <input type="text" id="testQuery" placeholder="Ask a question" style="width: 70%; padding: 8px; margin: 5px; background: #444; color: white; border: 1px solid #666; border-radius: 3px;" />
        <button class="btn" onclick="testQuery()">Ask AI</button>
      </div>
    </div>
  </div>

  <script>
    // Token management - hardcoded for private use
    function getToken() {
      return 'b6c3f0c9e6f44cce9e1a4f3f2d3a5c76';
    }

    // Results management
    function addResult(message, type = 'info') {
      const results = document.getElementById('results');
      const timestamp = new Date().toLocaleTimeString();
      const statusClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
      results.innerHTML += `<div class="status ${statusClass}">[${timestamp}] ${message}</div>`;
      results.scrollTop = results.scrollHeight;
    }

    function clearResults() {
      document.getElementById('results').innerHTML = 'Results cleared. Ready for new operations.';
    }

    // Copy debug log to clipboard
    function copyDebugLog() {
      const results = document.getElementById('results');
      const logText = results.textContent || results.innerText;
      
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(logText).then(() => {
          addResult('âœ… Debug log copied to clipboard!', 'success');
        }).catch(err => {
          addResult('âŒ Failed to copy to clipboard: ' + err.message, 'error');
          fallbackCopyTextToClipboard(logText);
        });
      } else {
        fallbackCopyTextToClipboard(logText);
      }
    }

    // Fallback copy method for older browsers
    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.top = "0";
      textArea.style.left = "0";
      textArea.style.position = "fixed";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          addResult('âœ… Debug log copied to clipboard!', 'success');
        } else {
          addResult('âŒ Failed to copy to clipboard', 'error');
        }
      } catch (err) {
        addResult('âŒ Failed to copy to clipboard: ' + err.message, 'error');
      }
      
      document.body.removeChild(textArea);
    }

    // Progress management
    function updateProgress(percent, text) {
      document.getElementById('progressBar').style.width = percent + '%';
      document.getElementById('progressText').textContent = text;
      document.getElementById('progressSection').classList.remove('hidden');
    }

    // API calls
    async function apiCall(endpoint, data = null) {
      const token = getToken();
      if (!token) {
        addResult('âŒ No token found. Please save your token first.', 'error');
        return null;
      }

      try {
        const response = await fetch(endpoint, {
          method: data ? 'POST' : 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: data ? JSON.stringify(data) : undefined
        });
        const text = await response.text();
        try { return JSON.parse(text); } catch { return { ok: response.ok, status: response.status, text }; }
      } catch (error) {
        addResult(`âŒ API Error: ${error.message}`, 'error');
        return null;
      }
    }

    // CSV Import functions
    async function importCSV(file, contentType) {
      if (!file) {
        addResult(`âŒ No ${contentType} file selected`, 'error');
        return false;
      }

      addResult(`ğŸ“¥ Importing ${contentType} data...`);
      const csvText = await file.text();
      
      // Log CSV preview for debugging
      const lines = csvText.split('\n');
      addResult(`ğŸ“Š CSV Preview: ${lines.length} lines, first line: ${lines[0]?.substring(0, 100)}...`);
      
      // Handle special cases that don't use the multi-import endpoint
      if (contentType === 'site_urls' || contentType === 'landing_pages' || contentType === 'test_questions') {
        addResult(`â„¹ï¸ ${contentType} files are for reference only - not imported to database`, 'info');
        return true; // Count as successful since these are reference files
      }
      
      const result = await apiCall('/api/csv-multi-import', { csvData: csvText, contentType });
      
      if (result && result.ok) {
        addResult(`âœ… ${contentType} import successful: ${result.imported} records`, 'success');
        return true;
      } else {
        addResult(`âŒ ${contentType} import failed: ${result?.error || result?.detail || 'Unknown error'}`, 'error');
        if (result?.detail) {
          addResult(`ğŸ” Error details: ${JSON.stringify(result.detail)}`, 'error');
        }
        return false;
      }
    }

    // Main import function
    async function importAllCSVs() {
      const token = getToken();
      addResult('ğŸ” Using hardcoded token for authentication');
      document.getElementById('stepImport').style.background = '#3a3';
      document.getElementById('stepImport').textContent = '1ï¸âƒ£ Import CSVs: running';

      updateProgress(0, 'Starting CSV imports...');
      addResult('ğŸš€ Starting CSV import process...');

      const files = [
        { file: document.getElementById('blogCsv').files[0], type: 'blog', name: 'Blog Articles' },
        { file: document.getElementById('courseEventsCsv').files[0], type: 'event', name: 'Course Events' },
        { file: document.getElementById('workshopEventsCsv').files[0], type: 'workshop', name: 'Workshop Events' },
        { file: document.getElementById('servicePagesCsv').files[0], type: 'service', name: 'Service Pages' },
        { file: document.getElementById('productsCsv').files[0], type: 'product', name: 'Physical Products' },
        { file: document.getElementById('siteUrlsCsv').files[0], type: 'site_urls', name: 'Site URLs' },
        { file: document.getElementById('landingPagesCsv').files[0], type: 'landing_pages', name: 'Landing Pages' },
        { file: document.getElementById('testQuestionsCsv').files[0], type: 'test_questions', name: 'Test Questions' }
      ];

      let successCount = 0;
      let totalCount = files.filter(f => f.file).length;

      if (totalCount === 0) {
        addResult('âŒ No CSV files selected', 'error');
        return;
      }

      for (let i = 0; i < files.length; i++) {
        const { file, type, name } = files[i];
        if (file) {
          updateProgress((i / totalCount) * 100, `Importing ${name}...`);
          const success = await importCSV(file, type);
          if (success) successCount++;
        }
      }

      updateProgress(100, `Import complete: ${successCount}/${totalCount} successful`);
      addResult(`ğŸ‰ CSV import process complete! ${successCount}/${totalCount} files imported successfully.`, 'success');
      document.getElementById('stepImport').style.background = successCount===totalCount ? '#2a6' : '#a62';
      document.getElementById('stepImport').textContent = `1ï¸âƒ£ Import CSVs: ${successCount}/${totalCount}`;
    }

    // Website scraping
    async function scrapeWebsite() {
      const siteUrlsFile = document.getElementById('siteUrlsCsv').files[0];
      if (!siteUrlsFile) {
        addResult('âŒ Please select a Site URLs CSV file first', 'error');
        return;
      }

      // enable stop button
      let stopRequested = false;
      window.__stopScrape = () => { stopRequested = true; addResult('â¹ï¸ Stop requested. Finishing current URL...', 'info'); };
      document.getElementById('stopScrapeBtn').style.display = 'inline-block';

      addResult('ğŸ•·ï¸ Starting website scraping...');
      document.getElementById('stepScrape').style.background = '#3a3';
      document.getElementById('stepScrape').textContent = '2ï¸âƒ£ Scrape URLs: running';
      const csvText = await siteUrlsFile.text();
      const lines = csvText.split('\n').filter(line => line.trim());
      const urls = lines.slice(1).map(line => line.split(',')[0]).filter(url => url && url.startsWith('http'));

      addResult(`ğŸ“Š Found ${urls.length} URLs to scrape`);

      // stats counters
      stats.loadedRows = urls.length;
      stats.successCount = 0;
      stats.failedCount = 0;
      stats.stoppedCount = 0;
      updateStats();

      // per-category stats
      const cat = () => ({ success: 0, failed: 0, skipped: 0 });
      let catStats = {
        events: cat(),
        workshops: cat(),
        blogs: cat(),
        services: cat(),
        products: cat(),
        other: cat()
      };

      function categorize(url, result) {
        const u = (url||'').toLowerCase();
        if (u.includes('/blog-on-photography')) return 'blogs';
        if (u.includes('/beginners-photography-lessons')) return 'events';
        if (u.includes('/photographic-workshops-near-me') || u.includes('/photo-workshops-uk')) return 'workshops';
        if (u.includes('/photography-services-near-me')) return 'services';
        if (u.includes('/photography-shop') || u.includes('/photography-presents')) return 'products';
        return 'other';
      }

      function renderCategoryStats() {
        const el = document.getElementById('categoryStats');
        const rows = Object.entries(catStats).map(([k,v]) => `<tr><td style="padding:4px 8px;">${k}</td><td style="color:#51cf66">${v.success}</td><td style="color:#ff6b6b">${v.failed}</td><td style="color:#74c0fc">${v.skipped}</td></tr>`).join('');
        el.innerHTML = `<table style="width:100%;border-collapse:collapse;margin-top:6px;background:#1b1b1b;border:1px solid #333"><thead><tr><th style="text-align:left;padding:4px 8px;">Category</th><th style="text-align:left;padding:4px 8px;">Success</th><th style="text-align:left;padding:4px 8px;">Failed</th><th style="text-align:left;padding:4px 8px;">Skipped</th></tr></thead><tbody>${rows}</tbody></table>`;
      }

      for (let i = 0; i < urls.length; i++) {
        updateProgress((i / urls.length) * 100, `Scraping ${urls[i]}...`);
        const result = await apiCall('/api/ingest-embed-replace', { url: urls[i] });
        const category = categorize(urls[i], result);
        if (result && (result.ok === true || (result.ok === undefined && result.status >= 200 && result.status < 300))) {
          addResult(`âœ… Scraped: ${urls[i]}`, 'success');
          stats.successCount++;
          catStats[category].success++;
        } else {
          const src = lines[i+1] || '';
          const reason = result && (result.error || result.detail || result.text) ? `${result.error || ''} ${result.detail || ''} ${result.text || ''}`.trim() : 'unknown';
          const reasonLc = reason.toLowerCase();
          if (reasonLc.includes('uniq_events_with_date') || reasonLc.includes('duplicate key value')) {
            addResult(`âœ… Skipped duplicate: ${urls[i]}  (source: site_urls.csv line ${i+2}) â€” ${reason}`, 'success');
            stats.successCount++;
            catStats[category].skipped++;
          } else {
            addResult(`âŒ Failed: ${urls[i]}  (source: site_urls.csv line ${i+2}) â€” ${reason}`, 'error');
            stats.failedCount++;
            catStats[category].failed++;
          }
        }
        updateStats();
        renderCategoryStats();

        if (stopRequested) {
          stats.stoppedCount = urls.length - (i + 1);
          updateStats();
          break;
        }
      }

      updateProgress(100, 'Website scraping complete');
      addResult('ğŸ‰ Website scraping complete!', 'success');
      document.getElementById('stepScrape').style.background = stats.failedCount === 0 ? '#2a6' : '#a62';
      document.getElementById('stepScrape').textContent = `2ï¸âƒ£ Scrape URLs: ${stats.successCount} ok, ${stats.failedCount} failed, ${stats.stoppedCount} stopped`;
      document.getElementById('stopScrapeBtn').style.display = 'none';
    }

    function stopScrape() {
      if (typeof window.__stopScrape === 'function') window.__stopScrape();
    }

    // Event-Product mapping
    async function runMapping() {
      addResult('ğŸ”— Running event â†’ product mapping...');
      document.getElementById('stepMap').style.background = '#3a3';
      document.getElementById('stepMap').textContent = '3ï¸âƒ£ Create Mappings: running';
      const token = getToken();
      try {
        const resp = await fetch('/rest/v1/rpc/refresh_event_product_autolinks', { headers: { 'Authorization': `Bearer ${token}` } });
        const raw = await resp.text();
        let parsed;
        try { parsed = JSON.parse(raw); } catch { parsed = { text: raw }; }
        if (resp.ok) {
          addResult('âœ… Event â†’ Product mapping complete!', 'success');
          document.getElementById('stepMap').style.background = '#2a6';
          document.getElementById('stepMap').textContent = '3ï¸âƒ£ Create Mappings: complete';
        } else {
          addResult(`âŒ Mapping failed: ${raw.substring(0,180)}`, 'error');
          document.getElementById('stepMap').style.background = '#a62';
          document.getElementById('stepMap').textContent = '3ï¸âƒ£ Create Mappings: failed';
        }
      } catch (e) {
        addResult(`âŒ Mapping error: ${e.message}`, 'error');
        document.getElementById('stepMap').style.background = '#a62';
        document.getElementById('stepMap').textContent = '3ï¸âƒ£ Create Mappings: failed';
      }
    }

    // Test functions
    async function testSingleUrl() {
      const url = document.getElementById('testUrl').value;
      if (!url) {
        addResult('âŒ Please enter a URL to test', 'error');
        return;
      }

      addResult(`ğŸ§ª Testing URL: ${url}`);
      const result = await apiCall('/api/ingest-embed-replace', { url });
      if (result && result.ok) {
        addResult(`âœ… URL test successful: ${url}`, 'success');
      } else {
        addResult(`âŒ URL test failed: ${url}`, 'error');
      }
    }

    async function testQuery() {
      const query = document.getElementById('testQuery').value;
      if (!query) {
        addResult('âŒ Please enter a question to test', 'error');
        return;
      }

      addResult(`ğŸ¤– Testing AI query: "${query}"`);
      const result = await apiCall('/api/chat', { query });
      if (result && result.answer) {
        addResult(`âœ… AI Response: ${result.answer}`, 'success');
      } else {
        addResult(`âŒ AI query failed`, 'error');
      }
    }

    // Extract structured JSON functions
    async function extractContent(contentType) {
      const url = document.getElementById('extractUrl').value;
      if (!url) {
        document.getElementById('extractResults').textContent = 'Please enter a URL first';
        return;
      }
      
      document.getElementById('extractResults').textContent = `Extracting ${contentType} from ${url}...`;
      
      try {
        const response = await fetch('/api/ingest-embed-replace', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getToken()}`
          },
          body: JSON.stringify({ url })
        });
        
        const result = await response.json();
        document.getElementById('extractResults').textContent = JSON.stringify(result, null, 2);
      } catch (error) {
        document.getElementById('extractResults').textContent = `Error: ${error.message}`;
      }
    }
    
    function clearExtractResults() {
      document.getElementById('extractResults').textContent = '';
    }

    // Download debug log
    function downloadDebugLog() {
      const results = document.getElementById('results');
      const logText = results.textContent || results.innerText || '';
      const blob = new Blob([logText], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `debug-log-${new Date().toISOString().replace(/[:.]/g,'-')}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      addResult('â¬‡ï¸ Debug log downloaded.', 'success');
    }
    
    // Statistics tracking
    let stats = {
      loadedRows: 0,
      successCount: 0,
      failedCount: 0,
      stoppedCount: 0
    };
    
    function updateStats() {
      document.getElementById('loadedRows').textContent = stats.loadedRows;
      document.getElementById('successCount').textContent = stats.successCount;
      document.getElementById('failedCount').textContent = stats.failedCount;
      document.getElementById('stoppedCount').textContent = stats.stoppedCount;
    }
    
    function resetStats() {
      stats = { loadedRows: 0, successCount: 0, failedCount: 0, stoppedCount: 0 };
      updateStats();
    }

    // Load hardcoded token on page load
    window.onload = function() {
      addResult('âœ… Hardcoded token ready for use');
      updateStats();
    };
  </script>
</body>
</html>
