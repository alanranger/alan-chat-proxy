<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cron Job Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1800px;
      margin: 0 auto;
    }

    .job-section {
      margin-bottom: 30px;
    }

    .job-section-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 8px 8px 0 0;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 0;
    }

    .job-section-header.analytics {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .job-section-header.refresh {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .job-section-content {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 0 0 8px 8px;
      border: 2px solid #e0e0e0;
    }

    h1 {
      margin-bottom: 30px;
      color: #2c3e50;
    }

    .auth-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .auth-section input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 300px;
      margin-right: 10px;
    }

    .auth-section button {
      padding: 10px 20px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .auth-section button:hover {
      background: #2980b9;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn-secondary:hover {
      background: #7f8c8d;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-active {
      background: #2ecc71;
      color: white;
    }

    .status-inactive {
      background: #95a5a6;
      color: white;
    }

    .status-success {
      background: #2ecc71;
      color: white;
    }

    .status-failed {
      background: #e74c3c;
      color: white;
    }

    .jobs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .job-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .job-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .job-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .job-title {
      font-size: 18px;
      font-weight: bold;
      color: #2c3e50;
    }

    .job-id {
      color: #7f8c8d;
      font-size: 12px;
    }

    .job-description {
      color: #000000;
      font-size: 16px;
      margin-bottom: 15px;
      line-height: 1.6;
      font-weight: 400;
    }

    .frequency-pill {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .job-schedule {
      background: #ecf0f1;
      padding: 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 13px;
      margin-bottom: 15px;
    }

    .job-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .stat-item {
      text-align: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: #7f8c8d;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #2c3e50;
    }

    .success-rate {
      font-size: 14px;
      color: #2ecc71;
    }

    .failure-rate {
      font-size: 14px;
      color: #e74c3c;
    }

    .job-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 30px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: bold;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #7f8c8d;
    }

    .close-btn:hover {
      color: #2c3e50;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
    }

    .form-group small {
      color: #7f8c8d;
      font-size: 12px;
    }

    .logs-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .logs-table th,
    .logs-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .logs-table th {
      background: #f8f9fa;
      font-weight: bold;
    }

    .logs-table tr:hover {
      background: #f8f9fa;
    }

    .command-preview {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      overflow-x: auto;
      margin-top: 10px;
      max-height: 200px;
      overflow-y: auto;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .success {
      background: #efe;
      color: #3c3;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .cron-presets {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .preset-btn {
      padding: 6px 12px;
      background: #ecf0f1;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .preset-btn:hover {
      background: #bdc3c7;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Cron Job Dashboard</h1>

    <div class="auth-section" id="authSection">
      <h3>Authentication</h3>
      <input type="password" id="authToken" placeholder="Enter admin token" />
      <button onclick="setAuthToken()">Authenticate</button>
    </div>

    <div id="dashboard" style="display: none;">
      <div class="controls">
        <button class="btn btn-primary" onclick="loadJobs()">Refresh Jobs</button>
        <button class="btn btn-secondary" onclick="clearAuth()">Logout</button>
      </div>

      <div id="message"></div>
      <div id="jobsContainer" class="loading">Loading cron jobs...</div>
    </div>
  </div>

  <!-- Schedule Modal -->
  <div class="modal" id="scheduleModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Update Schedule</div>
        <button class="close-btn" onclick="closeScheduleModal()">&times;</button>
      </div>
      <div id="scheduleModalContent"></div>
    </div>
  </div>

  <!-- Logs Modal -->
  <div class="modal" id="logsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Job Logs</div>
        <button class="close-btn" onclick="closeLogsModal()">&times;</button>
      </div>
      <div id="logsModalContent"></div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    
    // Default admin token (INGEST_TOKEN)
    const DEFAULT_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnenZ3YnZndm16dnZ6b2NsdWZ4Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzY3NzkyOCwiZXhwIjoyMDczMjUzOTI4fQ.W9tkTSYu6Wml0mUr-gJD6hcLMZDcbaYYaOsyDXuwd8M';
    
    let authToken = localStorage.getItem('cron_dashboard_token') || DEFAULT_TOKEN;

    // Job descriptions
    const jobDescriptions = {
      13: 'Aggregates daily analytics from chat bot usage logs (user sessions, questions asked, answers given, confidence scores, and response times) for a specific date 7 days ago. Stores the results in chat_analytics_daily for historical reporting.',
      19: 'Analyzes all chat questions from the last 7 days, groups identical questions, counts how many times each was asked, calculates average confidence scores, and tracks which questions have low confidence. Updates the chat_question_frequency table to identify frequently asked questions and which ones need better answers. Powers the Questions tab in analytics.html.',
      20: 'Aggregates today\'s analytics from chat bot usage logs (sessions, questions, interactions, averages) and updates session records with total questions and interactions per session. Powers the Overview tab in analytics.html.',
      21: 'Refreshes the unified products materialized view which consolidates product data from multiple sources (page_entities, product_display_price, CSV metadata) into a single deduplicated view. Resolves product types (workshop vs course), extracts location hints, availability status, and pricing. Then updates display prices for all products by processing them in batches. The refreshed view feeds into v_products_unified_open ‚Üí v_events_for_chat, which provides product pricing for events displayed in the chat bot. Ensures event pricing shown in chat responses is current.',
      22: 'Analyzes chat interactions from the last 30 days to find questions with low confidence scores (< 0.6). Groups identical questions, calculates frequency and average confidence, identifies which questions need better answers, and generates prioritized improvement recommendations (missing content, content gaps, intent confusion, high-impact fixes). Excludes questions already processed. Stores results in content_improvement_tracking table. Powers the Insights tab in analytics.html where you can review recommendations and mark questions as improved or ignored.',
      26: 'Reads all URLs from the site URLs CSV file, makes HEAD requests to check each URL\'s Last-Modified header, compares with database records to detect content changes, and re-ingests only changed URLs (full content extraction, embeddings, page_entities, page_chunks). Processes URLs in batches of 20. Batch 0 handles the first third of URLs plus the camera course URL. Keeps the database in sync with website changes without requiring full re-ingestion.',
      27: 'Reads all URLs from the site URLs CSV file, makes HEAD requests to check each URL\'s Last-Modified header, compares with database records to detect content changes, and re-ingests only changed URLs (full content extraction, embeddings, page_entities, page_chunks). Processes URLs in batches of 20. Batch 1 handles the second third of URLs. Keeps the database in sync with website changes without requiring full re-ingestion.',
      28: 'Reads all URLs from the site URLs CSV file, makes HEAD requests to check each URL\'s Last-Modified header, compares with database records to detect content changes, and re-ingests only changed URLs (full content extraction, embeddings, page_entities, page_chunks). Processes URLs in batches of 20. Batch 2 handles the final third of URLs. Keeps the database in sync with website changes without requiring full re-ingestion.'
    };

    // Define linked jobs (jobs that run together and are related)
    // Jobs 13, 19, 20, and 22 are all linked together (analytics jobs)
    // Jobs 26, 27, and 28 are all linked together (refresh batches)
    const linkedJobs = {
      13: [19, 20, 22],  // Job 13 is linked to Jobs 19, 20, and 22
      19: [13, 20, 22],  // Job 19 is linked to Jobs 13, 20, and 22
      20: [13, 19, 22],  // Job 20 is linked to Jobs 13, 19, and 22
      22: [13, 19, 20],  // Job 22 is linked to Jobs 13, 19, and 20
      26: [27, 28],  // Job 26 is linked to Jobs 27 and 28
      27: [26, 28],  // Job 27 is linked to Jobs 26 and 28
      28: [26, 27]   // Job 28 is linked to Jobs 26 and 27
    };

    // Custom display names for jobs
    const jobDisplayNames = {
      26: 'Website Pages Refresh Batch 0',
      27: 'Website Pages Refresh Batch 1',
      28: 'Website Pages Refresh Batch 2'
    };

    function setAuthToken() {
      const tokenInput = document.getElementById('authToken');
      const token = tokenInput ? tokenInput.value : DEFAULT_TOKEN;
      if (token) {
        authToken = token;
        localStorage.setItem('cron_dashboard_token', token);
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        loadJobs();
      }
    }

    function clearAuth() {
      authToken = '';
      localStorage.removeItem('cron_dashboard_token');
      document.getElementById('authSection').style.display = 'block';
      const tokenInput = document.getElementById('authToken');
      if (tokenInput) {
        tokenInput.value = DEFAULT_TOKEN;
      }
      document.getElementById('dashboard').style.display = 'none';
    }

    // Auto-authenticate on page load if token is available
    window.addEventListener('DOMContentLoaded', function() {
      const tokenInput = document.getElementById('authToken');
      if (tokenInput) {
        tokenInput.value = DEFAULT_TOKEN;
      }
      
      if (authToken) {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        loadJobs();
      }
    });

    async function loadJobs() {
      const container = document.getElementById('jobsContainer');
      container.innerHTML = '<div class="loading">Loading cron jobs...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/admin?action=cron_jobs`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.status === 401) {
          clearAuth();
          showMessage('Authentication failed. Please login again.', 'error');
          return;
        }

        const data = await response.json();
        if (!data.ok) {
          throw new Error(data.error || 'Failed to load jobs');
        }

        renderJobs(data.jobs || []);
      } catch (error) {
        container.innerHTML = `<div class="error">Error loading jobs: ${error.message}</div>`;
      }
    }

    function renderJobs(jobs) {
      const container = document.getElementById('jobsContainer');
      
      if (jobs.length === 0) {
        container.innerHTML = '<div class="loading">No cron jobs found.</div>';
        return;
      }

      // Build a set of all linked job IDs
      const linkedJobSet = new Set();
      Object.keys(linkedJobs).forEach(jobId => {
        linkedJobSet.add(parseInt(jobId));
        const links = Array.isArray(linkedJobs[jobId]) ? linkedJobs[jobId] : [linkedJobs[jobId]];
        links.forEach(linkId => linkedJobSet.add(linkId));
      });

      // Define job groups
      const analyticsJobs = [13, 19, 20, 22];
      const refreshBatches = [26, 27, 28];
      
      // Separate jobs into groups
      const analyticsGroup = jobs.filter(j => analyticsJobs.includes(j.jobid)).sort((a, b) => a.jobid - b.jobid);
      const refreshGroup = jobs.filter(j => refreshBatches.includes(j.jobid)).sort((a, b) => a.jobid - b.jobid);
      const otherJobs = jobs.filter(j => !analyticsJobs.includes(j.jobid) && !refreshBatches.includes(j.jobid)).sort((a, b) => a.jobid - b.jobid);

      let html = '';

      // Render Analytics Jobs Section
      if (analyticsGroup.length > 0) {
        html += '<div class="job-section">';
        html += '<div class="job-section-header analytics">üìä Chat Quality Analytics Jobs</div>';
        html += '<div class="job-section-content">';
        html += '<div class="jobs-grid" style="grid-template-columns: repeat(4, 1fr);">';
        
        analyticsGroup.forEach((job) => {
          html += renderJobCard(job, true, 'analytics');
        });
        
        html += '</div></div></div>';
      }

      // Render Refresh Batches Section
      if (refreshGroup.length > 0) {
        html += '<div class="job-section">';
        html += '<div class="job-section-header refresh">üîÑ Website Pages Refresh Batches</div>';
        html += '<div class="job-section-content">';
        html += '<div class="jobs-grid" style="grid-template-columns: repeat(4, 1fr);">';
        
        refreshGroup.forEach((job) => {
          html += renderJobCard(job, true, 'refresh');
        });
        
        html += '</div></div></div>';
      }

      // Render Other Jobs
      if (otherJobs.length > 0) {
        html += '<div class="jobs-grid">';
        otherJobs.forEach(job => {
          html += renderJobCard(job, false, '');
        });
        html += '</div>';
      }

      container.innerHTML = html;
    }

    // Parse cron schedule to human-readable frequency
    function parseCronFrequency(cron) {
      const parts = cron.trim().split(/\s+/);
      if (parts.length !== 5) return cron;
      
      const [minute, hour, dayOfMonth, month, dayOfWeek] = parts;
      
      // Every minute
      if (minute === '*' && hour === '*' && dayOfMonth === '*' && month === '*' && dayOfWeek === '*') {
        return 'Every minute';
      }
      
      // Every hour at specific minute (e.g., "0 * * * *")
      if (minute !== '*' && hour === '*' && dayOfMonth === '*' && month === '*' && dayOfWeek === '*') {
        if (minute === '0') {
          return 'Every hour';
        }
        return `Every hour (at :${minute.padStart(2, '0')})`;
      }
      
      // Every N hours (e.g., "0 */4 * * *" or "1 */4 * * *")
      if (hour.startsWith('*/') && dayOfMonth === '*' && month === '*' && dayOfWeek === '*') {
        const hours = hour.substring(2);
        const minText = minute !== '0' ? ` at :${minute.padStart(2, '0')}` : '';
        return `Every ${hours} hour${hours !== '1' ? 's' : ''}${minText}`;
      }
      
      // Daily at specific time (e.g., "0 2 * * *")
      if (minute !== '*' && hour !== '*' && dayOfMonth === '*' && month === '*' && dayOfWeek === '*') {
        const h = parseInt(hour);
        const m = minute.padStart(2, '0');
        const ampm = h >= 12 ? 'PM' : 'AM';
        const h12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
        return `Daily at ${h12}:${m} ${ampm}`;
      }
      
      // Weekly (specific day of week, e.g., "0 2 * * 1")
      if (dayOfWeek !== '*' && dayOfWeek !== '0' && dayOfWeek !== '7' && dayOfMonth === '*' && month === '*') {
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const day = parseInt(dayOfWeek);
        const dayName = days[day] || dayOfWeek;
        if (hour !== '*' && minute !== '*') {
          const h = parseInt(hour);
          const m = minute.padStart(2, '0');
          const ampm = h >= 12 ? 'PM' : 'AM';
          const h12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
          return `Every ${dayName} at ${h12}:${m} ${ampm}`;
        }
        return `Every ${dayName}`;
      }
      
      // Monthly
      if (dayOfMonth !== '*' && dayOfMonth !== '0' && month === '*' && dayOfWeek === '*') {
        if (hour !== '*' && minute !== '*') {
          const h = parseInt(hour);
          const m = minute.padStart(2, '0');
          const ampm = h >= 12 ? 'PM' : 'AM';
          const h12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
          return `Monthly on day ${dayOfMonth} at ${h12}:${m} ${ampm}`;
        }
        return `Monthly on day ${dayOfMonth}`;
      }
      
      // Fallback: return the cron expression
      return cron;
    }

    function renderJobCard(job, isLinked, groupType) {
      const successRate = job.total_runs > 0 
        ? ((job.success_count / job.total_runs) * 100).toFixed(1)
        : 0;
      const failureRate = job.total_runs > 0
        ? ((job.failed_count / job.total_runs) * 100).toFixed(1)
        : 0;
      const lastRun = job.last_run 
        ? new Date(job.last_run).toLocaleString()
        : 'Never';
      const description = jobDescriptions[job.jobid] || 'No description available.';
      const linkedJobIds = linkedJobs[job.jobid];
      const isLinkedJob = linkedJobIds !== undefined;
      const linkedIdsArray = Array.isArray(linkedJobIds) ? linkedJobIds : [linkedJobIds];
      const linkedIdsText = linkedIdsArray.join(', ');
      const displayName = jobDisplayNames[job.jobid] || job.jobname || `Job ${job.jobid}`;
      const frequency = parseCronFrequency(job.schedule);
      
      const borderColor = groupType === 'analytics' ? '#f5576c' : groupType === 'refresh' ? '#00f2fe' : '#3498db';
      
      return `
        <div class="job-card" ${isLinkedJob ? `style="border: 2px solid ${borderColor};"` : ''}>
          <div class="job-header">
            <div>
              <div class="job-title">${displayName}</div>
              <div class="job-id">ID: ${job.jobid}${isLinkedJob ? ` <span style="color: ${borderColor};">‚Üî Linked to Jobs ${linkedIdsText}</span>` : ''}</div>
            </div>
            <span class="status-badge ${job.active ? 'status-active' : 'status-inactive'}">
              ${job.active ? 'Active' : 'Inactive'}
            </span>
          </div>
          <div class="frequency-pill">‚è∞ ${frequency}</div>
          <div class="job-description">${description}</div>
          <div class="job-schedule">Schedule: ${job.schedule}</div>
          <div class="job-stats">
            <div class="stat-item">
              <div class="stat-label">Last Run</div>
              <div class="stat-value" style="font-size: 12px;">${lastRun}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Total Runs</div>
              <div class="stat-value">${job.total_runs || 0}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Success Rate</div>
              <div class="stat-value success-rate">${successRate}%</div>
              <div style="font-size: 11px; color: #7f8c8d;">${job.success_count || 0} succeeded</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Failure Rate</div>
              <div class="stat-value failure-rate">${failureRate}%</div>
              <div style="font-size: 11px; color: #7f8c8d;">${job.failed_count || 0} failed</div>
            </div>
          </div>
          <div class="job-actions">
            <button class="btn btn-primary btn-small" onclick="viewLogs(${job.jobid})">View Logs</button>
            <button class="btn btn-secondary btn-small" onclick="editSchedule(${job.jobid}, '${job.schedule}', '${displayName}')">Edit Schedule</button>
          </div>
        </div>
      `;
    }

    function showMessage(message, type = 'success') {
      const messageDiv = document.getElementById('message');
      messageDiv.className = type;
      messageDiv.textContent = message;
      messageDiv.style.display = 'block';
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 5000);
    }

    async function viewLogs(jobid) {
      const modal = document.getElementById('logsModal');
      const content = document.getElementById('logsModalContent');
      content.innerHTML = '<div class="loading">Loading logs...</div>';
      modal.classList.add('active');

      try {
        const response = await fetch(`${API_BASE}/api/admin?action=cron_logs&jobid=${jobid}&limit=100`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        const data = await response.json();
        if (!data.ok) {
          throw new Error(data.error || 'Failed to load logs');
        }

        const logs = data.logs || [];
        if (logs.length === 0) {
          content.innerHTML = '<div class="loading">No logs found for this job.</div>';
          return;
        }

        content.innerHTML = `
          <table class="logs-table">
            <thead>
              <tr>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Duration</th>
                <th>Status</th>
                <th>Message</th>
              </tr>
            </thead>
            <tbody>
              ${logs.map(log => {
                const startTime = new Date(log.start_time).toLocaleString();
                const endTime = log.end_time ? new Date(log.end_time).toLocaleString() : 'N/A';
                const duration = log.end_time 
                  ? ((new Date(log.end_time) - new Date(log.start_time)) / 1000).toFixed(2) + 's'
                  : 'N/A';
                const statusClass = log.status === 'succeeded' ? 'status-success' : 'status-failed';
                const message = log.return_message || 'No message';
                
                return `
                  <tr>
                    <td>${startTime}</td>
                    <td>${endTime}</td>
                    <td>${duration}</td>
                    <td><span class="status-badge ${statusClass}">${log.status}</span></td>
                    <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${message}">${message}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        content.innerHTML = `<div class="error">Error loading logs: ${error.message}</div>`;
      }
    }

    function closeLogsModal() {
      document.getElementById('logsModal').classList.remove('active');
    }

    function editSchedule(jobid, currentSchedule, jobname) {
      const modal = document.getElementById('scheduleModal');
      const content = document.getElementById('scheduleModalContent');
      
      const cronPresets = [
        { label: 'Every minute', value: '* * * * *' },
        { label: 'Every 5 minutes', value: '*/5 * * * *' },
        { label: 'Every 15 minutes', value: '*/15 * * * *' },
        { label: 'Every 30 minutes', value: '*/30 * * * *' },
        { label: 'Every hour', value: '0 * * * *' },
        { label: 'Every 4 hours', value: '0 */4 * * *' },
        { label: 'Every 8 hours', value: '0 */8 * * *' },
        { label: 'Every 12 hours', value: '0 */12 * * *' },
        { label: 'Daily at midnight', value: '0 0 * * *' },
        { label: 'Daily at 6 AM', value: '0 6 * * *' },
        { label: 'Weekly (Monday 2 AM)', value: '0 2 * * 1' }
      ];

      content.innerHTML = `
        <h3>${jobname || `Job ${jobid}`}</h3>
        <div class="form-group">
          <label>Current Schedule</label>
          <input type="text" value="${currentSchedule}" readonly style="background: #f5f5f5;" />
        </div>
        <div class="form-group">
          <label>New Schedule (Cron Format)</label>
          <input type="text" id="newSchedule" value="${currentSchedule}" placeholder="* * * * *" />
          <small>Format: minute hour day month weekday (e.g., "0 */8 * * *" for every 8 hours)</small>
          <div class="cron-presets">
            ${cronPresets.map(preset => 
              `<button class="preset-btn" onclick="document.getElementById('newSchedule').value='${preset.value}'">${preset.label}</button>`
            ).join('')}
          </div>
        </div>
        <div class="job-actions">
          <button class="btn btn-primary" onclick="updateSchedule(${jobid})">Update Schedule</button>
          <button class="btn btn-secondary" onclick="closeScheduleModal()">Cancel</button>
        </div>
      `;
      
      modal.classList.add('active');
    }

    function closeScheduleModal() {
      document.getElementById('scheduleModal').classList.remove('active');
    }

    async function updateSchedule(jobid) {
      const newSchedule = document.getElementById('newSchedule').value.trim();
      
      if (!newSchedule) {
        showMessage('Please enter a schedule', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/admin?action=update_cron_schedule`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ jobid, schedule: newSchedule })
        });

        const data = await response.json();
        if (!data.ok) {
          throw new Error(data.error || 'Failed to update schedule');
        }

        showMessage('Schedule updated successfully!', 'success');
        closeScheduleModal();
        loadJobs();
      } catch (error) {
        showMessage(`Error updating schedule: ${error.message}`, 'error');
      }
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      const scheduleModal = document.getElementById('scheduleModal');
      const logsModal = document.getElementById('logsModal');
      if (event.target === scheduleModal) {
        closeScheduleModal();
      }
      if (event.target === logsModal) {
        closeLogsModal();
      }
    }
  </script>
</body>
</html>

