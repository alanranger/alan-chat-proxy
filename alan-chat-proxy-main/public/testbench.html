<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bench Test – Events / Products / Articles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <style>
    :root{
      --bg:#0e1117;--panel:#161b22;--muted:#9aa4b3;--text:#e6edf3;--accent:#3b82f6;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;
      --border:#222834;--chip:#1f2633;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif}
    .page{display:grid;grid-template-columns:300px 1fr;gap:14px;padding:14px;height:100%}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px}
    .left{display:flex;flex-direction:column;gap:14px;height:calc(100vh - 28px)}
    .section{padding:12px}
    .section h3{margin:0 0 10px 0;font-weight:600;font-size:14px;color:#cbd5e1}
    .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    input[type=text]{width:100%;background:#0b0f15;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 10px}
    select{width:100%;background:#0b0f15;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 10px}
    button{background:#1f2937;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 10px;cursor:pointer}
    button.primary{background:var(--accent);border-color:transparent}
    button.small{padding:6px 8px;font-size:12px}
    button:disabled{opacity:.5;cursor:not-allowed}
    .kpi{display:flex;gap:10px;margin-top:8px}
    .pill{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px;color:var(--muted)}
    .right{display:grid;grid-template-rows:auto 1fr}
    .grids{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}
    .table{width:100%;border-collapse:collapse;font-size:13px}
    .table th,.table td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;vertical-align:top}
    .table th{color:#cbd5e1;background:#111622;position:sticky;top:0}
    .muted{color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0b0f15;color:#cbd5e1}
    .badge.ok{border-color:#1f5130;background:#0b1f14;color:#86efac}
    .badge.warn{border-color:#4a3a14;background:#1a1307;color:#fde68a}
    .badge.err{border-color:#5a1a1a;background:#1a0b0b;color:#fecaca}
    .log{height:220px;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap;background:#0b0f15;border-top:1px solid var(--border);border-radius:0 0 10px 10px;padding:10px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 0 0}
    .gridTitle{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border)}
    .gridTitle h4{margin:0;font-weight:600}
    .hint{font-size:12px;color:var(--muted)}
    .pillbar{display:flex;flex-wrap:wrap;gap:6px;padding:8px}
    .counts{display:flex;gap:8px}
    .counts .badge{background:#101522}
    a.link{color:#a5b4fc;text-decoration:none}
    .sticky-tools{position:sticky;top:0;background:var(--panel);padding-bottom:8px;z-index:1}
  </style>
</head>
<body>
<div class="page">
  <!-- LEFT PANEL -->
  <div class="left">
    <div class="card section">
      <h3>Step 0 · Connect to Supabase</h3>
      <div class="row"><input id="sbUrl" type="text" placeholder="Supabase URL"></div>
      <div class="row"><input id="sbAnon" type="text" placeholder="Supabase ANON key"></div>
      <div class="row">
        <select id="eventsView"><option value="ai_events">ai_events</option></select>
        <select id="productsView"><option value="ai_products">ai_products</option></select>
      </div>
      <div class="row">
        <button id="saveCfg" class="small">Save</button>
        <button id="resetCfg" class="small">Reset defaults</button>
      </div>
      <div class="row">
        <button id="btnConnect" class="primary">Connect</button>
        <button id="btnFetch">Fetch live data</button>
      </div>
      <div class="kpi"><span id="connStatus" class="badge">Disconnected.</span></div>
      <div class="row" style="margin-top:6px;">
        <label class="hint"><input id="useLandingFallback" type="checkbox" /> Use Landing CSV fallback</label>
        <label class="hint" style="margin-left:10px;"><input id="enableGenericPills" type="checkbox" checked /> Enable generic pills</label>
      </div>
    </div>

    <div class="card section">
      <h3>Step 1 (optional) · Landing Pages CSV (fallback)</h3>
      <div class="hint">Required columns: <code>url</code> and one of <code>meta_title</code> or <code>title</code>.</div>
      <div class="row"><input id="landingCsv" type="file" accept=".csv" /><button id="clearLanding" class="small">Clear</button></div>
      <div id="landingInfo" class="hint">No file loaded.</div>
    </div>

    <div class="card section">
      <h3>Step 2 · Questions CSV</h3>
      <div class="hint">Columns: <code>idx, query, expected</code>. Extra columns ignored.</div>
      <div class="row"><input id="questionsCsv" type="file" accept=".csv" /><button id="clearQuestions" class="small">Clear</button></div>
      <div class="row sticky-tools">
        <button id="runSuite" class="primary">Run whole suite</button>
        <button id="downloadSuiteJson" class="small">Download suite JSON</button>
      </div>
      <div id="questionsInfo" class="hint">No file loaded.</div>
    </div>

    <div class="card section">
      <h3>Step 3 · Try a single query</h3>
      <div class="row"><input id="singleQuery" type="text" placeholder="e.g. when is the next devon workshop?" /></div>
      <div class="row">
        <button id="btnRun" class="primary">Run</button>
        <button id="btnCopyJson" class="small">Copy JSON</button>
        <button id="btnDownloadJson" class="small">Download JSON</button>
      </div>
      <div class="kpi">
        <div class="counts">
          <span id="intentBadge" class="badge">intent: —</span>
          <span id="countsBadge" class="badge">events=0, products=0, articles=0, pills=0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right">
    <div class="grids">
      <div class="card">
        <div class="gridTitle"><h4>Results · Events</h4><span id="eventsKpi" class="badge">–</span></div>
        <div style="max-height:260px;overflow:auto;">
          <table class="table" id="eventsTable">
            <thead><tr><th style="width:34%">title</th><th>url</th><th style="width:16%">when</th><th style="width:18%">location</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="gridTitle"><h4>Results · Products</h4><span id="productsKpi" class="badge">–</span></div>
        <div style="max-height:260px;overflow:auto;">
          <table class="table" id="productsTable">
            <thead><tr><th style="width:45%">title</th><th>url</th><th style="width:12%">price</th><th style="width:16%">tags</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="gridTitle"><h4>Results · Articles</h4><span id="articlesKpi" class="badge">–</span></div>
        <div style="max-height:220px;overflow:auto;">
          <table class="table" id="articlesTable">
            <thead><tr><th style="width:55%">title</th><th>url</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="gridTitle">
          <h4>Pills generated</h4>
          <div><span id="pillCounts" class="badge">Events 0</span><span id="pillCounts2" class="badge">Products 0</span><span id="pillCounts3" class="badge">Articles 0</span></div>
        </div>
        <div class="pillbar" id="pillBar"></div>
      </div>
    </div>

    <!-- Suite results -->
    <div class="card" id="suiteCard">
      <div class="gridTitle">
        <h4>Suite Results</h4>
        <span id="suiteSummary" class="badge">—</span>
      </div>
      <div style="max-height:240px;overflow:auto;">
        <table class="table" id="suiteTable">
          <thead>
            <tr>
              <th style="width:60px;">idx</th>
              <th>query</th>
              <th style="width:120px;">expected</th>
              <th style="width:120px;">predicted</th>
              <th style="width:80px;">ok</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- LOG -->
    <div class="card">
      <div class="gridTitle"><h4>Execution Log</h4></div>
      <div id="log" class="log"></div>
    </div>
  </div>
</div>

<script>
/* ============================
   HARD-CODED DEFAULTS
   ============================ */
const DEFAULTS = {
  SUPABASE_URL: 'https://igzvwbvgvmzvvzoclufx.supabase.co',
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnenZ3YnZndm16dnZ6b2NsdWZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2Nzc5MjgsImV4cCI6MjA3MzI1MzkyOH0.A9TCmnXKJhDRYBkrO0mAMPiUQeV9enweeyRWKWQ1SZY',
  EVENTS_VIEW: 'ai_events',
  PRODUCTS_VIEW: 'ai_products',
  PREVIEW_ROWS: 10
};

let state = {
  sbClient: null,
  connected: false,
  events: [],
  products: [],
  articles: [],
  pills: [],
  lastRun: null,
  suite: [],
  suiteResults: []
};

/* ===============
   UTILITIES
   =============== */
const $ = sel => document.querySelector(sel);
const log = (msg) => {
  const ts = new Date().toLocaleTimeString();
  $('#log').textContent += `${ts}  ${msg}\n`;
  $('#log').scrollTop = $('#log').scrollHeight;
};
const saveCfg = (cfg) => localStorage.setItem('bench_cfg', JSON.stringify(cfg));
const loadCfg = () => { try { return JSON.parse(localStorage.getItem('bench_cfg')||'{}'); } catch { return {}; } };
const setBadge = (el, text, kind='')=>{
  const node = typeof el==='string' ? $(el) : el;
  node.className = `badge${kind? ' '+kind: ''}`;
  node.textContent = text;
};
const download = (filename, data) => {
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
};
const copyText = async (text) => { try { await navigator.clipboard.writeText(text); } catch(e){} };

/* ===============
   CSV PARSERS
   =============== */
function parseCsv(text){
  const rows = [];
  const lines = text.replace(/\r/g,'').split('\n').filter(Boolean);
  const headers = splitCsvLine(lines.shift());
  for (const line of lines){
    const vals = splitCsvLine(line);
    const obj = {};
    headers.forEach((h,i)=> obj[h.trim()] = (vals[i] ?? '').trim());
    rows.push(obj);
  }
  return rows;
}
function splitCsvLine(line){
  const out=[]; let cur=''; let q=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='"' && line[i+1]==='"'){ cur+='"'; i++; continue;}
    if(c=== '"'){ q=!q; continue;}
    if(c===',' && !q){ out.push(cur); cur=''; continue;}
    cur+=c;
  }
  out.push(cur);
  return out;
}

/* ===========================
   SUPABASE CONNECT / FETCH
   =========================== */
function currentCfg(){
  const cached = loadCfg();
  return {
    url: $('#sbUrl').value || cached.url || DEFAULTS.SUPABASE_URL,
    anon: $('#sbAnon').value || cached.anon || DEFAULTS.SUPABASE_ANON_KEY,
    eventsView: $('#eventsView').value || cached.eventsView || DEFAULTS.EVENTS_VIEW,
    productsView: $('#productsView').value || cached.productsView || DEFAULTS.PRODUCTS_VIEW
  };
}
function applyDefaultsToUI(){
  const cfg = loadCfg();
  $('#sbUrl').value = cfg.url || DEFAULTS.SUPABASE_URL;
  $('#sbAnon').value = cfg.anon || DEFAULTS.SUPABASE_ANON_KEY;
  $('#eventsView').value = cfg.eventsView || DEFAULTS.EVENTS_VIEW;
  $('#productsView').value = cfg.productsView || DEFAULTS.PRODUCTS_VIEW;
  setBadge('#connStatus', 'Disconnected.');
}
applyDefaultsToUI();

function connect(){
  const cfg = currentCfg();
  if(!cfg.url || !cfg.anon){ setBadge('#connStatus','Missing URL or anon key','warn'); log('Missing URL or anon key.'); return; }
  state.sbClient = supabase.createClient(cfg.url, cfg.anon, {auth:{persistSession:false}});
  state.connected = true;
  setBadge('#connStatus','Connected.','ok');
  log('Connected to Supabase.');
  sanityCounts();
}
async function sanityCounts(){
  const {eventsView, productsView} = currentCfg();
  try{
    const [{count: ecount}, {count: pcount}] = await Promise.all([
      state.sbClient.from(eventsView).select('*',{count:'exact', head:true}),
      state.sbClient.from(productsView).select('*',{count:'exact', head:true}),
    ]);
    log(`Views reachable · ${eventsView}: ${ecount ?? 'n/a'} · ${productsView}: ${pcount ?? 'n/a'}`);
  }catch(e){ log(`Error checking counts: ${e.message}`); }
}
async function fetchLive(){
  if(!state.connected){ connect(); }
  const {eventsView, productsView} = currentCfg();
  setBadge('#eventsKpi','Loading…'); setBadge('#productsKpi','Loading…');
  try{
    const [ev, pr] = await Promise.all([
      state.sbClient.from(eventsView).select('title,url,"when",location,start_date,date_start,date_end').limit(500),
      state.sbClient.from(productsView).select('title,url,price,tags').limit(500),
    ]);
    if(ev.error) throw ev.error;
    if(pr.error) throw pr.error;
    state.events = ev.data || [];
    state.products = pr.data || [];
    setBadge('#eventsKpi', `Loaded ${state.events.length}`,'ok');
    setBadge('#productsKpi', `Loaded ${state.products.length}`,'ok');
    renderTable('#eventsTable', state.events.slice(0, DEFAULTS.PREVIEW_ROWS), ['title','url','when','location']);
    renderTable('#productsTable', state.products.slice(0, DEFAULTS.PREVIEW_ROWS), ['title','url','price','tags']);
    log(`Loaded events=${state.events.length}, products=${state.products.length}.`);
    deriveArticles();
  }catch(e){
    setBadge('#eventsKpi','Error','err'); setBadge('#productsKpi','Error','err');
    log(`Fetch error: ${e.message}`);
  }
}

/* ===========================
   RENDER HELPERS
   =========================== */
function renderTable(sel, rows, cols){
  const tbody = document.querySelector(sel+' tbody');
  tbody.innerHTML = '';
  if(!rows || rows.length===0){ return; }
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    cols.forEach(c=>{
      const td = document.createElement('td');
      let v = r[c];
      if(c==='url' && v){
        const a = document.createElement('a'); a.href = v; a.className='link'; a.target='_blank'; a.textContent = v;
        td.appendChild(a);
      }else{ td.textContent = (v==null?'':v); }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

/* ===========================
   LANDING CSV → ARTICLES
   =========================== */
let landingRows = [];
function deriveArticles(){
  const rows = landingRows || [];
  const picked = rows.filter(r => {
    const u = (r.url||'').toLowerCase();
    return u.includes('/blog') || u.includes('/news') || u.includes('/tips');
  }).map(r => ({ title: r.meta_title || r.title || '', url: r.url }));
  state.articles = picked.slice(0, 500);
  setBadge('#articlesKpi', `From Landing CSV: ${state.articles.length}`);
  renderTable('#articlesTable', state.articles.slice(0, DEFAULTS.PREVIEW_ROWS), ['title','url']);
}

/* ===========================
   INTENT + MATCHING
   =========================== */
function detectIntent(q){
  const s = (q||'').toLowerCase();
  const eventTerms = ['workshop','course','class','event','tuition','training','mentoring','walk','trip','photography','astrophotography'];
  const productTerms = ['price','cost','£','gbp','book','buy','voucher','subscription'];
  const adviceTerms = ['what','how','tips','recommend','do i need','should i','can i'];
  let scoreE = eventTerms.some(t=>s.includes(t)) ? 1 : 0;
  let scoreP = productTerms.some(t=>s.includes(t)) ? 1 : 0;
  let scoreA = adviceTerms.some(t=>s.includes(t)) ? 1 : 0;
  const scoreBlog = (s.includes('blog') || s.includes('article') || s.includes('guide')) ? 1 : 0;

  let intent = 'advice';
  if(scoreBlog && !scoreE && !scoreP) intent = 'articles';
  else if(scoreE && !scoreP) intent = 'events';
  else if(scoreP && !scoreE) intent = 'products';
  else if(scoreE && scoreP) intent = 'events';

  let conf = 60;
  if(intent==='events') conf = 85;
  if(intent==='products') conf = 80;
  if(intent==='articles') conf = 75;
  if(s.trim()==='') conf = 90;
  return { intent, confidence: conf };
}
function matchEvents(q){
  const s = (q||'').toLowerCase();
  return state.events.filter(e=>{
    const hay = [e.title, e.location, e.when].join(' ').toLowerCase();
    return s.split(/\s+/).every(tok => hay.includes(tok));
  }).slice(0, 20);
}
function matchProducts(q){
  const s = (q||'').toLowerCase();
  return state.products.filter(p=>{
    const hay = [p.title, p.tags, p.price, p.url].join(' ').toLowerCase();
    return s.split(/\s+/).every(tok => hay.includes(tok));
  }).slice(0, 20);
}
function matchArticles(q){
  const s = (q||'').toLowerCase();
  return state.articles.filter(a=>{
    const hay = [a.title, a.url].join(' ').toLowerCase();
    return s.split(/\s+/).every(tok => hay.includes(tok));
  }).slice(0, 10);
}

/* ===========================
   PILLS
   =========================== */
function buildPills(q){
  const pills = [];
  if($('#enableGenericPills').checked){
    pills.push({label:'Event Listing', url:'https://www.alanranger.com/search?query=workshops', brand:true});
    pills.push({label:'Blog / Articles', url:'https://www.alanranger.com/blog-on-photography', brand:true});
    pills.push({label:'Gift Vouchers', url:'https://www.alanranger.com/photography-gift-vouchers', brand:true});
    pills.push({label:'Contact', url:'https://www.alanranger.com/contact', brand:true});
  }
  for(const e of (state.events||[]).slice(0,3)){ if(e?.url && e?.title){ pills.push({label: trim(e.title, 42), url:e.url, type:'event'}); } }
  for(const p of (state.products||[]).slice(0,2)){ if(p?.url && p?.title){ pills.push({label: trim(p.title, 42), url:p.url, type:'product'}); } }
  for(const a of (state.articles||[]).slice(0,2)){ if(a?.url && a?.title){ pills.push({label: trim(a.title, 42), url:a.url, type:'article'}); } }
  return pills;
}
function trim(s, n){ s=s||''; return s.length>n ? s.slice(0,n-1)+'…' : s; }
function renderPills(list){
  const bar = $('#pillBar'); bar.innerHTML='';
  list.forEach(p=>{ const a = document.createElement('a'); a.href = p.url; a.target='_blank'; a.className='badge'; a.textContent = p.label; bar.appendChild(a); });
  const counts = {
    events: list.filter(x=>x.type==='event').length,
    products: list.filter(x=>x.type==='product').length,
    articles: list.filter(x=>x.type==='article').length,
  };
  $('#pillCounts').textContent = `Events ${counts.events}`;
  $('#pillCounts2').textContent = `Products ${counts.products}`;
  $('#pillCounts3').textContent = `Articles ${counts.articles}`;
}

/* ===========================
   RUNNERS
   =========================== */
function singleRun(q){
  const {intent, confidence} = detectIntent(q);
  let events=[], products=[], articles=[];
  if(intent==='events'){ events = matchEvents(q); }
  if(intent==='products'){ products = matchProducts(q); }
  if(intent==='articles'){ articles = matchArticles(q); }

  state.lastRun = {
    q, intent, confidence, counts:{ events: events.length, products: products.length, articles: articles.length },
    used:{ events: events.slice(0,5), products: products.slice(0,5), articles: articles.slice(0,5), pills: buildPills(q) }
  };

  renderTable('#eventsTable', events.slice(0, DEFAULTS.PREVIEW_ROWS), ['title','url','when','location']);
  renderTable('#productsTable', products.slice(0, DEFAULTS.PREVIEW_ROWS), ['title','url','price','tags']);
  renderTable('#articlesTable', articles.slice(0, DEFAULTS.PREVIEW_ROWS), ['title','url']);
  renderPills(state.lastRun.used.pills);

  setBadge('#intentBadge', `intent: ${intent} (${confidence}%)`);
  setBadge('#countsBadge', `events=${events.length}, products=${products.length}, articles=${articles.length}, pills=${state.lastRun.used.pills.length}`);
  log(`Run: ${JSON.stringify({q,intent})}`);
}

function suiteRun(){
  if(state.suite.length===0){ log('No questions CSV loaded.'); return; }
  let pass=0; const results=[];
  for(const row of state.suite){
    const q = row.query || row.Q || row.question || '';
    const expected = (row.expected||'').toLowerCase().trim();
    const {intent} = detectIntent(q);
    const ok = expected ? (expected===intent) : true;
    if(ok) pass++;
    results.push({idx: row.idx || '', q, expected, predicted:intent, ok});
  }
  state.suiteResults = results;
  const pct = Math.round((pass / state.suite.length) * 100);
  setBadge('#suiteSummary', `Suite: ${pass}/${state.suite.length} matched (${pct}%)`, pass===state.suite.length ? 'ok' : (pct>=70 ? 'warn' : 'err'));
  renderSuiteTable();
  log(`Suite done: ${pass}/${state.suite.length} matched expected intent.`);
}
function renderSuiteTable(){
  const tb = $('#suiteTable tbody'); tb.innerHTML='';
  for(const r of state.suiteResults){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.idx||''}</td>
      <td>${escapeHtml(r.q||'')}</td>
      <td>${r.expected||''}</td>
      <td>${r.predicted||''}</td>
      <td>${r.ok ? '✅' : '❌'}</td>
    `;
    tb.appendChild(tr);
  }
}
function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* ===========================
   UI WIRING
   =========================== */
$('#saveCfg').onclick = ()=>{ const cfg = currentCfg(); saveCfg(cfg); log('Saved configuration.'); };
$('#resetCfg').onclick = ()=>{
  saveCfg({url:DEFAULTS.SUPABASE_URL, anon:DEFAULTS.SUPABASE_ANON_KEY, eventsView:DEFAULTS.EVENTS_VIEW, productsView:DEFAULTS.PRODUCTS_VIEW});
  applyDefaultsToUI(); log('Defaults restored.');
};
$('#btnConnect').onclick = ()=> connect();
$('#btnFetch').onclick = ()=> fetchLive();

$('#btnRun').onclick = ()=>{ const q = $('#singleQuery').value || ''; singleRun(q); };
$('#btnCopyJson').onclick = ()=>{
  const out = {
    meta:{version:'benchtest/2.0', timestamp:new Date().toISOString()},
    environment:{
      supabase_url: currentCfg().url,
      events_view: currentCfg().eventsView,
      products_view: currentCfg().productsView,
      flags:{fallback: $('#useLandingFallback').checked, generic: $('#enableGenericPills').checked}
    },
    datasets:{
      live:{ events_count: state.events.length, products_count: state.products.length, events_sample: state.events.slice(0,3), products_sample: state.products.slice(0,3) },
      landing_csv:{ rows_total: landingRows.length, sample: landingRows.slice(0,5) },
      questions_csv:{ rows_total: state.suite.length, rows: state.suite.slice(0,5) }
    },
    last_single_run: state.lastRun||null,
    last_suite_run: { total: state.suiteResults.length, results: state.suiteResults.slice(0,50) }
  };
  copyText(JSON.stringify(out,null,2));
};
$('#btnDownloadJson').onclick = ()=>{
  const payload = { meta:{version:'benchtest/2.0', timestamp:new Date().toISOString()}, datasets:{ events: state.events, products: state.products, articles: state.articles }, last_run: state.lastRun, suite: state.suiteResults };
  download('bench-results.json', JSON.stringify(payload,null,2));
};

/* Landing CSV */
$('#landingCsv').onchange = async (e)=>{
  const f = e.target.files?.[0];
  if(!f){ landingRows=[]; $('#landingInfo').textContent='No file loaded.'; return; }
  const text = await f.text(); landingRows = parseCsv(text);
  $('#landingInfo').textContent = `Loaded ${landingRows.length} landing pages.`; log(`Landing CSV loaded (${landingRows.length} rows).`);
  deriveArticles();
};
$('#clearLanding').onclick = ()=>{ $('#landingCsv').value=''; landingRows=[]; $('#landingInfo').textContent='Cleared.'; deriveArticles(); };

/* Questions CSV */
$('#questionsCsv').onchange = async (e)=>{
  const f = e.target.files?.[0];
  if(!f){ state.suite=[]; $('#questionsInfo').textContent='No file loaded.'; return; }
  const text = await f.text(); state.suite = parseCsv(text);
  $('#questionsInfo').textContent = `Loaded ${state.suite.length} questions.`; log(`Questions CSV loaded (${state.suite.length} rows).`);
};
$('#clearQuestions').onclick = ()=>{ $('#questionsCsv').value=''; state.suite=[]; $('#questionsInfo').textContent='Cleared.'; };
$('#runSuite').onclick = ()=> suiteRun();
$('#downloadSuiteJson').onclick = ()=> download('bench-questions.json', JSON.stringify(state.suite,null,2));

/* Boot */
log('Bench ready.');
applyDefaultsToUI();
/* Auto-connect & fetch on load using hard-coded keys */
connect();
fetchLive();
</script>
</body>
</html>
