<!DOCTYPE html>
<html>
<head>
    <title>End-to-End Chat Logging Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1f2937; color: white; }
        .test-section { background: #374151; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        .log { background: #111827; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #3b82f6; background: rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body>
    <h1>üîç End-to-End Chat Logging Test</h1>
    
    <div class="test-section">
        <h2>Test Configuration</h2>
        <p><strong>API Base:</strong> https://alan-chat-proxy.vercel.app</p>
        <p><strong>Test Session ID:</strong> <span id="sessionId">Generating...</span></p>
        <p><strong>Test Question:</strong> "what is ISO in photography?"</p>
    </div>

    <div class="test-section">
        <h2>Test Steps</h2>
        <button onclick="runFullTest()">üöÄ Run Complete End-to-End Test</button>
        <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="testLog" class="log">Ready to run test...</div>
    </div>

    <script>
        const API_BASE = 'https://alan-chat-proxy.vercel.app';
        const AUTH_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnenZ3YnZndm16dnZ6b2NsdWZ4Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzY3NzkyOCwiZXhwIjoyMDczMjUzOTI4fQ.W9tkTSYu6Wml0mUr-gJD6hcLMZDcbaYYaOsyDXuwd8M';
        
        let testSessionId = 'e2e_test_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        document.getElementById('sessionId').textContent = testSessionId;
        
        let logDiv = document.getElementById('testLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            logDiv.innerHTML = 'Logs cleared. Ready to run test...';
        }

        async function runFullTest() {
            clearLogs();
            log('üöÄ Starting End-to-End Chat Logging Test', 'info');
            log(`üìã Test Session ID: ${testSessionId}`, 'info');
            
            try {
                // Step 1: Test Session Start
                await testSessionStart();
                
                // Step 2: Test Chat API Call
                await testChatAPI();
                
                // Step 3: Test Question Logging
                await testQuestionLogging();
                
                // Step 4: Test Answer Logging
                await testAnswerLogging();
                
                // Step 5: Test Session End
                await testSessionEnd();
                
                // Step 6: Verify Data in Database
                await verifyDatabaseData();
                
                log('‚úÖ End-to-End Test Completed!', 'success');
                
            } catch (error) {
                log(`‚ùå Test Failed: ${error.message}`, 'error');
            }
        }

        async function testSessionStart() {
            log('üìù Step 1: Testing Session Start Logging...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/chat-log`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        action: 'session_start',
                        data: { 
                            sessionId: testSessionId,
                            userAgent: navigator.userAgent,
                            deviceType: 'desktop'
                        }
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Session Start: ${response.status} - ${JSON.stringify(result)}`, 'success');
                } else {
                    log(`‚ùå Session Start Failed: ${response.status} - ${JSON.stringify(result)}`, 'error');
                    throw new Error(`Session start failed: ${response.status}`);
                }
                
            } catch (error) {
                log(`‚ùå Session Start Error: ${error.message}`, 'error');
                throw error;
            }
        }

        async function testChatAPI() {
            log('üìù Step 2: Testing Chat API Call...', 'info');
            
            try {
                const startTime = Date.now();
                const response = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: 'what is ISO in photography?',
                        topK: 8,
                        previousQuery: null,
                        sessionId: testSessionId
                    })
                });
                
                const responseTime = Date.now() - startTime;
                const result = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Chat API: ${response.status} - Response time: ${responseTime}ms`, 'success');
                    log(`üìä Chat Response: Intent=${result.intent}, Confidence=${result.confidence}`, 'info');
                    log(`üìù Answer Length: ${result.answer ? result.answer.length : 0} characters`, 'info');
                    
                    // Store the response for later use
                    window.testChatResponse = result;
                    window.testResponseTime = responseTime;
                    
                } else {
                    log(`‚ùå Chat API Failed: ${response.status} - ${JSON.stringify(result)}`, 'error');
                    throw new Error(`Chat API failed: ${response.status}`);
                }
                
            } catch (error) {
                log(`‚ùå Chat API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        async function testQuestionLogging() {
            log('üìù Step 3: Testing Question Logging...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/chat-log`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        action: 'question',
                        data: {
                            sessionId: testSessionId,
                            question: 'what is ISO in photography?'
                        }
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Question Logging: ${response.status} - ${JSON.stringify(result)}`, 'success');
                } else {
                    log(`‚ùå Question Logging Failed: ${response.status} - ${JSON.stringify(result)}`, 'error');
                    throw new Error(`Question logging failed: ${response.status}`);
                }
                
            } catch (error) {
                log(`‚ùå Question Logging Error: ${error.message}`, 'error');
                throw error;
            }
        }

        async function testAnswerLogging() {
            log('üìù Step 4: Testing Answer Logging...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/chat-log`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        action: 'question',
                        data: {
                            sessionId: testSessionId,
                            question: 'what is ISO in photography?',
                            answer: window.testChatResponse?.answer || 'Test answer',
                            intent: window.testChatResponse?.intent || 'advice',
                            confidence: window.testChatResponse?.confidence || 0.5,
                            responseTimeMs: window.testResponseTime || 1000,
                            sourcesUsed: window.testChatResponse?.citations || []
                        }
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Answer Logging: ${response.status} - ${JSON.stringify(result)}`, 'success');
                } else {
                    log(`‚ùå Answer Logging Failed: ${response.status} - ${JSON.stringify(result)}`, 'error');
                    throw new Error(`Answer logging failed: ${response.status}`);
                }
                
            } catch (error) {
                log(`‚ùå Answer Logging Error: ${error.message}`, 'error');
                throw error;
            }
        }

        async function testSessionEnd() {
            log('üìù Step 5: Testing Session End Logging...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/chat-log`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        action: 'session_end',
                        data: { sessionId: testSessionId }
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Session End: ${response.status} - ${JSON.stringify(result)}`, 'success');
                } else {
                    log(`‚ùå Session End Failed: ${response.status} - ${JSON.stringify(result)}`, 'error');
                    throw new Error(`Session end failed: ${response.status}`);
                }
                
            } catch (error) {
                log(`‚ùå Session End Error: ${error.message}`, 'error');
                throw error;
            }
        }

        async function verifyDatabaseData() {
            log('üìù Step 6: Verifying Data in Database...', 'info');
            
            try {
                // Wait a moment for the data to be processed
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Check if session exists
                const sessionResponse = await fetch(`${API_BASE}/api/analytics?action=sessions`, {
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    }
                });
                
                if (sessionResponse.ok) {
                    const sessionData = await sessionResponse.json();
                    const ourSession = sessionData.sessions.data.find(s => s.session_id === testSessionId);
                    
                    if (ourSession) {
                        log(`‚úÖ Session Found in Database: ${ourSession.session_id}`, 'success');
                        log(`üìä Session Details: Started=${ourSession.started_at}, Questions=${ourSession.total_questions}`, 'info');
                    } else {
                        log(`‚ö†Ô∏è Session NOT Found in Database`, 'warning');
                    }
                } else {
                    log(`‚ùå Failed to check sessions: ${sessionResponse.status}`, 'error');
                }
                
                // Check if interactions exist
                const interactionResponse = await fetch(`${API_BASE}/api/analytics?action=session_detail&sessionId=${testSessionId}`, {
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    }
                });
                
                if (interactionResponse.ok) {
                    const interactionData = await interactionResponse.json();
                    const interactions = interactionData.session.interactions;
                    
                    if (interactions && interactions.length > 0) {
                        log(`‚úÖ Interactions Found: ${interactions.length} interactions`, 'success');
                        interactions.forEach((interaction, index) => {
                            log(`üìù Interaction ${index + 1}: Q="${interaction.question}", A="${interaction.answer ? interaction.answer.substring(0, 50) + '...' : 'No answer'}"`, 'info');
                        });
                    } else {
                        log(`‚ö†Ô∏è No Interactions Found in Database`, 'warning');
                    }
                } else {
                    log(`‚ùå Failed to check interactions: ${interactionResponse.status}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Database Verification Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
